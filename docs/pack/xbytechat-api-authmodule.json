{
  "name": "xbytechat-api/AuthModule",
  "generatedAt": "2025-12-10 08:27:07 +00:00",
  "files": [
    {
      "path": "xbytechat-api/AuthModule/Controllers/AuthController.cs",
      "sha256": "6453dee724eb4ecf1de4f6f500be89ecbc72fdc75e92ffe5a0f134da8acfb27b",
      "language": "csharp",
      "size": 14863,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing System.Security.Claims;\nusing xbytechat.api.AuthModule.DTOs;\nusing xbytechat.api.AuthModule.Services;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing System.IdentityModel.Tokens.Jwt;\nusing System.Security.Claims;\nusing xbytechat.api.Features.AccessControl.Services;\n\nnamespace xbytechat.api.AuthModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class AuthController : ControllerBase\n    {\n        private readonly IAuthService _authService;\n        private readonly IAccessControlService _accessControlService;\n\n        public AuthController(IAuthService authService, IAccessControlService accessControlService)\n        {\n            _authService = authService;\n            _accessControlService = accessControlService;\n        }\n\n        // ‚úÖ Login ‚Üí return { token } (NO cookies)\n        [AllowAnonymous]\n        [HttpPost(\"login\")]\n        public async Task<IActionResult> Login([FromBody] UserLoginDto dto)\n        {\n            var result = await _authService.LoginAsync(dto);\n            if (!result.Success || string.IsNullOrWhiteSpace(result.Token))\n                return Unauthorized(new { success = false, message = result.Message });\n\n            return Ok(new { token = result.Token });\n        }\n\n        // (Optional) Refresh token endpoint if you still issue refresh tokens.\n        // Returns tokens in body (NO cookies).\n        [AllowAnonymous]\n        [HttpPost(\"refresh-token\")]\n        public async Task<IActionResult> RefreshToken([FromBody] RefreshTokenRequest request)\n        {\n            var result = await _authService.RefreshTokenAsync(request.RefreshToken);\n            if (!result.Success) return Unauthorized(new { success = false, message = result.Message });\n\n            dynamic data = result.Data!;\n            return Ok(new\n            {\n                accessToken = data.accessToken,\n                refreshToken = data.refreshToken\n            });\n        }\n        // ‚úÖ Signup\n        [HttpPost(\"business-user-signup\")]\n        public async Task<IActionResult> Signup([FromBody] SignupBusinessDto dto)\n        {\n            if (!ModelState.IsValid)\n            {\n                var errors = ModelState.Values\n                    .SelectMany(v => v.Errors)\n                    .Select(e => e.ErrorMessage)\n                    .ToList();\n\n                return BadRequest(new\n                {\n                    success = false,\n                    message = \"‚ùå Validation failed.\",\n                    errors\n                });\n            }\n\n            var result = await _authService.SignupAsync(dto);\n            return result.Success ? Ok(result) : BadRequest(result);\n        }\n\n        // ‚úÖ Logout (stateless JWT): nothing server-side to do\n        [Authorize]\n        [HttpPost(\"logout\")]\n        public IActionResult Logout() => Ok(new { success = true, message = \"Logged out\" });\n\n        // ‚úÖ (Optional) lightweight session echo from claims (works with Bearer)\n        [Authorize]\n        [HttpGet(\"session\")]\n        public IActionResult GetSession()\n        {\n            var user = HttpContext.User;\n            if (user?.Identity is not { IsAuthenticated: true }) return BadRequest(\"Invalid session\");\n\n            var email = user.FindFirst(ClaimTypes.Email)?.Value ?? \"unknown\";\n            var role = user.FindFirst(ClaimTypes.Role)?.Value\n                       ?? user.FindFirst(\"role\")?.Value\n                       ?? \"unknown\";\n            var plan = user.FindFirst(\"plan\")?.Value ?? \"basic\";\n            var biz = user.FindFirst(\"businessId\")?.Value;\n\n            return Ok(new { isAuthenticated = true, role, email, plan, businessId = biz });\n        }\n\n     \n\n        [Authorize]\n        [HttpGet(\"me\")]\n        public IActionResult Me()\n        {\n            var user = HttpContext.User;\n\n            var userId =\n                user.FindFirst(JwtRegisteredClaimNames.Sub)?.Value ??\n                user.FindFirst(ClaimTypes.NameIdentifier)?.Value ??\n                user.FindFirst(\"uid\")?.Value;\n\n            if (string.IsNullOrWhiteSpace(userId))\n            {\n                return Unauthorized(new { ok = false, message = \"Missing user id in token.\" });\n            }\n\n            var email =\n                user.FindFirst(ClaimTypes.Email)?.Value ??\n                user.FindFirst(JwtRegisteredClaimNames.Email)?.Value ??\n                user.FindFirst(\"email\")?.Value;\n\n            var role =\n                user.FindFirst(ClaimTypes.Role)?.Value ??\n                user.FindFirst(\"role\")?.Value ?? \"business\";\n\n            var businessId =\n                user.FindFirst(\"businessId\")?.Value ??\n                user.FindFirst(\"BusinessId\")?.Value ??\n                user.FindFirst(\"business_id\")?.Value;\n\n            return Ok(new\n            {\n                ok = true,\n                user = new\n                {\n                    id = userId,\n                    email,\n                    role\n                },\n                businessId,\n                hasAllAccess = role.Equals(\"admin\", StringComparison.OrdinalIgnoreCase)\n                            || role.Equals(\"superadmin\", StringComparison.OrdinalIgnoreCase)\n                            || role.Equals(\"partner\", StringComparison.OrdinalIgnoreCase)\n                            || role.Equals(\"reseller\", StringComparison.OrdinalIgnoreCase)\n            });\n        }\n\n        // -----------------------------------------------------------\n        // ‚úÖ Main auth context: /api/auth/context\n        //    This is what your AuthProvider/refreshAuthContext wants.\n        // -----------------------------------------------------------\n        //[Authorize]\n        //[HttpGet(\"context\")]\n        //public async Task<IActionResult> GetContext()\n        //{\n        //    var principal = HttpContext.User;\n\n        //    // --- User id (mandatory) ---\n        //    var userIdStr =\n        //        principal.FindFirst(JwtRegisteredClaimNames.Sub)?.Value ??\n        //        principal.FindFirst(ClaimTypes.NameIdentifier)?.Value ??\n        //        principal.FindFirst(\"uid\")?.Value;\n\n        //    if (!Guid.TryParse(userIdStr, out var userId))\n        //    {\n        //        return Unauthorized(new\n        //        {\n        //            ok = false,\n        //            isAuthenticated = false,\n        //            message = \"Invalid or missing user id claim.\"\n        //        });\n        //    }\n\n        //    // --- Email ---\n        //    var email =\n        //        principal.FindFirst(ClaimTypes.Email)?.Value ??\n        //        principal.FindFirst(JwtRegisteredClaimNames.Email)?.Value ??\n        //        principal.FindFirst(\"email\")?.Value;\n\n        //    // --- Role ---\n        //    var role =\n        //        principal.FindFirst(ClaimTypes.Role)?.Value ??\n        //        principal.FindFirst(\"role\")?.Value ??\n        //        \"business\";\n\n        //    // --- BusinessId (GUID, optional for some roles) ---\n        //    var businessIdClaim =\n        //        principal.FindFirst(\"businessId\")?.Value ??\n        //        principal.FindFirst(\"BusinessId\")?.Value ??\n        //        principal.FindFirst(\"business_id\")?.Value;\n\n        //    Guid? businessId = null;\n        //    if (Guid.TryParse(businessIdClaim, out var bizGuid))\n        //    {\n        //        businessId = bizGuid;\n        //    }\n\n        //    // --- PlanId (optional) ---\n        //    var planIdClaim =\n        //        principal.FindFirst(\"plan_id\")?.Value ??\n        //        principal.FindFirst(\"planId\")?.Value;\n\n        //    Guid? planId = null;\n        //    if (Guid.TryParse(planIdClaim, out var planGuid))\n        //    {\n        //        planId = planGuid;\n        //    }\n\n        //    // --- Status (active / pending / suspended / etc.) ---\n        //    var status =\n        //        principal.FindFirst(\"status\")?.Value ??\n        //        principal.FindFirst(\"biz_status\")?.Value ??\n        //        principal.FindFirst(\"businessStatus\")?.Value ??\n        //        principal.FindFirst(\"bizStatus\")?.Value ??\n        //        \"active\";\n\n        //    // --- All-access roles (admin, superadmin, partner, reseller, etc.) ---\n        //    var hasAllAccess =\n        //        role.Equals(\"admin\", StringComparison.OrdinalIgnoreCase) ||\n        //        role.Equals(\"superadmin\", StringComparison.OrdinalIgnoreCase) ||\n        //        role.Equals(\"partner\", StringComparison.OrdinalIgnoreCase) ||\n        //        role.Equals(\"reseller\", StringComparison.OrdinalIgnoreCase);\n\n        //    // --- Permissions from AccessControl service ---\n        //    var permissions = await _accessControlService.GetPermissionsAsync(userId);\n\n        //    // For now, expose the same codes as \"features\" so the SPA can bootstrap.\n        //    // Entitlements API remains the long-term source of truth.\n        //    var features = permissions;\n\n        //    // --- Build the shape expected by AuthProvider.refreshAuthContext ---\n        //    return Ok(new\n        //    {\n        //        ok = true,\n        //        isAuthenticated = true,\n\n        //        // Used by AuthProvider + ProtectedRoute\n        //        user = new\n        //        {\n        //            id = userId,\n        //            email,\n        //            role\n        //        },\n\n        //        business = businessId.HasValue\n        //            ? new\n        //            {\n        //                id = businessId.Value,\n        //                businessId = businessId.Value,\n        //                planId = planId,\n        //                status\n        //            }\n        //            : null,\n\n        //        businessId = businessId,\n        //        role,\n        //        status,\n        //        hasAllAccess,\n        //        permissions,\n        //        features,\n        //        planId\n        //    });\n        //}\n        [Authorize]\n        [HttpGet(\"context\")]\n        public async Task<IActionResult> GetContext()\n        {\n            var principal = HttpContext.User;\n\n            // --- User id (mandatory) ---\n            var userIdStr =\n                principal.FindFirst(JwtRegisteredClaimNames.Sub)?.Value ??\n                principal.FindFirst(ClaimTypes.NameIdentifier)?.Value ??\n                principal.FindFirst(\"uid\")?.Value ??\n                principal.FindFirst(\"id\")?.Value;\n\n            if (!Guid.TryParse(userIdStr, out var userId))\n            {\n                return Unauthorized(new\n                {\n                    ok = false,\n                    isAuthenticated = false,\n                    message = \"Invalid or missing user id claim.\"\n                });\n            }\n\n            // --- Email ---\n            var email =\n                principal.FindFirst(ClaimTypes.Email)?.Value ??\n                principal.FindFirst(JwtRegisteredClaimNames.Email)?.Value ??\n                principal.FindFirst(\"email\")?.Value;\n\n            // --- User display name ---\n            var userName =\n                principal.FindFirst(\"name\")?.Value ??\n                principal.FindFirst(ClaimTypes.Name)?.Value ??\n                principal.FindFirst(\"fullName\")?.Value ??\n                principal.FindFirst(\"fullname\")?.Value;\n\n            // --- Role ---\n            var role =\n                principal.FindFirst(ClaimTypes.Role)?.Value ??\n                principal.FindFirst(\"role\")?.Value ??\n                \"business\";\n\n            // --- BusinessId (GUID, optional for some roles) ---\n            var businessIdClaim =\n                principal.FindFirst(\"businessId\")?.Value ??\n                principal.FindFirst(\"BusinessId\")?.Value ??\n                principal.FindFirst(\"business_id\")?.Value;\n\n            Guid? businessId = null;\n            if (Guid.TryParse(businessIdClaim, out var bizGuid))\n            {\n                businessId = bizGuid;\n            }\n\n            // --- PlanId (optional) ---\n            var planIdClaim =\n                principal.FindFirst(\"plan_id\")?.Value ??\n                principal.FindFirst(\"planId\")?.Value;\n\n            Guid? planId = null;\n            if (Guid.TryParse(planIdClaim, out var planGuid))\n            {\n                planId = planGuid;\n            }\n\n            // --- Status (active / pending / suspended / etc.) ---\n            var status =\n                principal.FindFirst(\"status\")?.Value ??\n                principal.FindFirst(\"biz_status\")?.Value ??\n                principal.FindFirst(\"businessStatus\")?.Value ??\n                principal.FindFirst(\"bizStatus\")?.Value ??\n                \"active\";\n\n            // --- Business name / company name (for Topbar display) ---\n            var companyName =\n                principal.FindFirst(\"businessName\")?.Value ??\n                principal.FindFirst(\"companyName\")?.Value ??\n                principal.FindFirst(\"bizName\")?.Value;\n\n            // --- All-access roles (admin, superadmin, partner, reseller, etc.) ---\n            var hasAllAccess =\n                role.Equals(\"admin\", StringComparison.OrdinalIgnoreCase) ||\n                role.Equals(\"superadmin\", StringComparison.OrdinalIgnoreCase) ||\n                role.Equals(\"partner\", StringComparison.OrdinalIgnoreCase) ||\n                role.Equals(\"reseller\", StringComparison.OrdinalIgnoreCase);\n\n            // --- Permissions from AccessControl service ---\n            var permissions = await _accessControlService.GetPermissionsAsync(userId);\n\n            // For now, expose the same codes as \"features\" so the SPA can bootstrap.\n            // Entitlements API remains the long-term source of truth.\n            var features = permissions;\n\n            // --- Build the shape expected by AuthProvider.refreshAuthContext ---\n            return Ok(new\n            {\n                ok = true,\n                isAuthenticated = true,\n\n                // Used by AuthProvider + ProtectedRoute\n                user = new\n                {\n                    id = userId,\n                    email,\n                    role,\n                    name = userName,\n                    fullName = userName,\n                    displayName = userName\n                },\n\n                business = businessId.HasValue\n                    ? new\n                    {\n                        id = businessId.Value,\n                        businessId = businessId.Value,\n                        businessName = companyName,\n                        companyName = companyName,\n                        planId,\n                        status\n                    }\n                    : null,\n\n                businessId,\n                role,\n                status,\n                hasAllAccess,\n                permissions,\n                features,\n                planId\n            });\n        }\n\n    }\n}\n\n\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Controllers/MeController.cs",
      "sha256": "4a1a9ee43f2516879df38fdf87dff87e50f0d932946385c3df1acda490085168",
      "language": "csharp",
      "size": 3184,
      "content": "#nullable enable\nusing System.Security.Claims;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\n\nnamespace xbytechat.api.AuthModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/me\")]\n    public sealed class MeController : ControllerBase\n    {\n        [HttpGet]\n        [Authorize]\n        public IActionResult Get()\n        {\n            string? userId =\n                User.FindFirst(\"uid\")?.Value ??\n                User.FindFirst(ClaimTypes.NameIdentifier)?.Value ??\n                User.FindFirst(\"sub\")?.Value;\n\n            string role =\n                User.FindFirst(\"role\")?.Value ??\n                User.FindFirst(ClaimTypes.Role)?.Value ??\n                \"business\";\n\n            string? businessId =\n                User.FindFirst(\"bid\")?.Value ??\n                User.FindFirst(\"BusinessId\")?.Value ??\n                User.FindFirst(\"business_id\")?.Value;\n\n            if (string.IsNullOrWhiteSpace(userId))\n            {\n                return Unauthorized(new { ok = false, message = \"Missing uid/sub claim.\" });\n            }\n\n            // Only enforce BusinessId for non-admins\n            if (!string.Equals(role, \"admin\", StringComparison.OrdinalIgnoreCase) &&\n                string.IsNullOrWhiteSpace(businessId))\n            {\n                return Unauthorized(new { ok = false, message = \"Missing BusinessId claim.\" });\n            }\n\n            var name = User.Identity?.Name ?? \"User\";\n            var permissions = new[] { \"*\" }; // replace later\n\n            return Ok(new\n            {\n                ok = true,\n                user = new { id = userId, name, role },\n                businessId,          // can be null for admin\n                hasAllAccess = string.Equals(role, \"admin\", StringComparison.OrdinalIgnoreCase)\n            });\n        }\n    }\n}\n\n\n//#nullable enable\n//using Microsoft.AspNetCore.Authorization;\n//using Microsoft.AspNetCore.Mvc;\n//using Microsoft.EntityFrameworkCore;\n//using xbytechat.api.Shared;\n\n\n\n//namespace xbytechat.api.AuthModule.Controllers\n//{\n\n//    [ApiController]\n//    [Route(\"api/me\")]\n//    public sealed class MeController : ControllerBase\n//    {\n//        [HttpGet]\n//        [Authorize] // requires valid JWT\n//        public IActionResult Get()\n//        {\n//            try\n//            {\n//                var userId = User.GetUserId();        // throws if missing/invalid\n//                var businessId = User.GetBusinessId(); // throws if missing/invalid\n\n//                // Optional: expose a friendly name if you put it in the token\n//                var name = User.Identity?.Name ?? \"User\";\n\n//                // TODO: replace with your real permission source later\n//                var permissions = new[] { \"*\" };\n\n//                return Ok(new\n//                {\n//                    ok = true,\n//                    user = new { id = userId, name },\n//                    businessId,\n//                    permissions\n//                });\n//            }\n//            catch (UnauthorizedAccessException ex)\n//            {\n//                return Unauthorized(new { ok = false, message = ex.Message });\n//            }\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Controllers/TestJwtController.cs",
      "sha256": "c407c3fdf8977cffcb0cd6131f617087ede160fd75646be61000b68f7a455a22",
      "language": "csharp",
      "size": 2087,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.AuthModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/auth/test\")]\n    public class TestJwtController : ControllerBase\n    {\n        [Authorize]\n        [HttpGet(\"get-logged-in\")]\n        public IActionResult GetLoggedInUserInfo()\n        {\n            var userId = UserContextHelper.GetUserId(User);\n            var businessId = UserContextHelper.GetBusinessId(User);\n            var role = UserContextHelper.GetRole(User);\n            var plan = UserContextHelper.GetPlan(User);\n            var companyName = UserContextHelper.GetCompanyName(User);\n\n            return Ok(new\n            {\n                success = true,\n                message = \"üîê JWT is valid. Here's your decoded info:\",\n                data = new\n                {\n                    userId,\n                    businessId,\n                    role,\n                    plan,\n                    companyName\n                }\n            });\n        }\n\n        [HttpGet(\"get-current-user\")]\n        public IActionResult GetCurrentUser()\n        {\n            if (User?.Identity?.IsAuthenticated != true)\n            {\n                return Unauthorized(new { success = false, message = \"‚ùå Not authenticated\" });\n            }\n\n            var userId = User.FindFirst(\"sub\")?.Value;\n            var email = User.FindFirst(\"email\")?.Value;\n            var role = User.FindFirst(\"role\")?.Value;\n            var businessId = User.FindFirst(\"businessId\")?.Value;\n            var plan = User.FindFirst(\"plan\")?.Value;\n            var permissions = User.FindFirst(\"permissions\")?.Value;\n\n            return Ok(new\n            {\n                success = true,\n                message = \"‚úÖ Token is valid\",\n                user = new\n                {\n                    userId,\n                    email,\n                    role,\n                    businessId,\n                    plan,\n                    permissions\n                }\n            });\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/AuthModule/DTOs/RefreshTokenRequest.cs",
      "sha256": "5f68342bebd5c2664561285523bcabe509a7ffe5fe9c995eeeaf821aba238e2d",
      "language": "csharp",
      "size": 142,
      "content": "namespace xbytechat.api.AuthModule.DTOs\n{\n    public class RefreshTokenRequest\n    {\n        public string RefreshToken { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/DTOs/ResendConfirmationDto.cs",
      "sha256": "c390da7f0aa2324928025edc1a4ce1c65e079357cb2219fade8cdc4153734982",
      "language": "csharp",
      "size": 226,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.AuthModule.DTOs\n{\n    public class ResendConfirmationDto\n    {\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/AuthModule/DTOs/ResetPasswordDto.cs",
      "sha256": "33b22ea5acec9376aef19d7c09ff580b689f7a6bc04ea1d6f214dd9b203de0c4",
      "language": "csharp",
      "size": 374,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.AuthModule.DTOs\n{\n    public class ResetPasswordDto\n    {\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; }\n\n        [Required]\n        [MinLength(6, ErrorMessage = \"Password must be at least 6 characters long.\")]\n        public string NewPassword { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/DTOs/UserDto.cs",
      "sha256": "47384e5d11fcdfb564f639c3937db6f3aa97f5963366ecb7af4dc37e6a311ff1",
      "language": "csharp",
      "size": 587,
      "content": "namespace xbytechat.api.AuthModule.DTOs\n{\n    public class UserDto\n    {\n        public Guid Id { get; set; }\n        public string Name { get; set; }\n        public string Email { get; set; }\n        public string Role { get; set; }\n        public string Status { get; set; }\n        public DateTime CreatedAt { get; set; }\n\n        // ‚úÖ Extra fields\n        public Guid BusinessId { get; set; }\n        public string CompanyName { get; set; }\n        public string Plan { get; set; }\n        public string AccessToken { get; set; }\n\n        public Guid? PlanId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/DTOs/UserLoginDto.cs",
      "sha256": "d0b1140af88b221c2cb7dbd58223d5803643620b16d27f016aba26ed9b816482",
      "language": "csharp",
      "size": 281,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.AuthModule.DTOs\n{\n    public class UserLoginDto\n    {\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; }\n\n        [Required]\n        public string Password { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Models/User.cs",
      "sha256": "25f82a426c60ebda55385071a527cb10389e2f164415031be0a718cc4dc8f768",
      "language": "csharp",
      "size": 1761,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models; // üÜï Required for navigation\n\nnamespace xbytechat.api.AuthModule.Models\n{\n    public class User\n    {\n        public Guid Id { get; set; }\n\n        // üîó FK to Business\n        public Guid? BusinessId { get; set; }\n        public Business Business { get; set; }\n\n        // üë§ User Info\n        [Required]\n        public string Name { get; set; }\n\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; }\n\n        [Required]\n        public string PasswordHash { get; set; }\n\n        // üõ°Ô∏è Role System\n        // üõ°Ô∏è Role System (FK + Navigation)\n        public Guid? RoleId { get; set; }\n        public Role Role { get; set; }// admin / business / agent / staff\n\n        // ‚úÖ Status Management\n        public string Status { get; set; } = \"Pending\"; // Active / Hold / Rejected / Pending\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        // üóëÔ∏è Soft Delete Role \n        public bool IsDeleted { get; set; } = false;\n        public DateTime? DeletedAt { get; set; }\n\n        public List<CampaignSendLog> SendLogs { get; set; }\n        public ICollection<MessageStatusLog> MessageStatusLogs { get; set; }\n\n        // üÜï Permission Navigation\n        public ICollection<UserPermission> UserPermissions { get; set; } // üí° Enables .WithMany(u => u.UserPermissions)\n        public string? RefreshToken { get; set; }\n        public DateTime? RefreshTokenExpiry { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Models/WhatsAppTemplate.cs",
      "sha256": "f6d549b8bc59ee42cba54fb40b14be15a99861230b581b6224dd95b14f29fd22",
      "language": "csharp",
      "size": 5144,
      "content": "using System.ComponentModel.DataAnnotations;\n\nusing Microsoft.EntityFrameworkCore;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.AuthModule.Models\n{\n    // All enum usages removed. We store canonical strings instead.\n\n    //[Index(nameof(BusinessId), nameof(Provider))]\n    //[Index(nameof(BusinessId), nameof(Name))]\n    //[Index(nameof(BusinessId), nameof(Name), nameof(LanguageCode), nameof(Provider), IsUnique = true)]\n    public sealed class WhatsAppTemplate\n    {\n        public Guid Id { get; set; }\n        public Guid BusinessId { get; set; }\n\n        // Provider is stored as UPPERCASE per your decision: e.g., \"META_CLOUD\", \"PINNACLE\", \"OTHER\"\n        [MaxLength(40)]\n        public string Provider { get; set; } = \"META_CLOUD\";\n\n        public string? TemplateId { get; set; }\n\n        [MaxLength(160)]\n        public string Name { get; set; } = string.Empty;\n\n        [MaxLength(16)]\n        public string LanguageCode { get; set; } = \"en_US\";\n\n        // Former TemplateStatus enum ‚Üí string (canonical UPPERCASE: APPROVED/REJECTED/PENDING/PAUSED/UNKNOWN)\n        [MaxLength(24)]\n        public string Status { get; set; } = \"APPROVED\";\n\n        public string? Category { get; set; }\n        public string? SubCategory { get; set; }\n\n        // Full provider JSON\n        public string RawJson { get; set; } = \"{}\";\n\n        // Former ParameterFormat enum ‚Üí string (canonical UPPERCASE: POSITIONAL/NAMED/UNKNOWN)\n        [MaxLength(24)]\n        public string ParameterFormat { get; set; } = \"UNKNOWN\";\n\n        // Former HeaderKind enum ‚Üí string (canonical lowercase: none/text/image/video/document/location)\n        [MaxLength(16)]\n        public string HeaderKind { get; set; } = \"none\";\n\n        public string? HeaderText { get; set; }\n        public string? Body { get; set; }\n        public string? BodyPreview { get; set; }\n\n        public bool RequiresMediaHeader { get; set; }\n\n        // Counts (kept as ints)\n        public int BodyVarCount { get; set; }\n        public int HeaderTextVarCount { get; set; }\n        public int TotalTextParamCount { get; set; }\n\n        // JSON blobs\n        public string? UrlButtons { get; set; }      // jsonb\n        public int QuickReplyCount { get; set; }\n        public bool HasPhoneButton { get; set; }\n        public string? NamedParamKeys { get; set; }  // jsonb\n        public string? PlaceholderMap { get; set; }  // jsonb\n\n        public bool IsActive { get; set; } = true;\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime LastSyncedAt { get; set; } = DateTime.UtcNow;\n\n        // Concurrency\n        public byte[]? RowVersion { get; set; }\n    }\n}\n\n\n//using Microsoft.EntityFrameworkCore;\n//using System.ComponentModel.DataAnnotations;\n\n//namespace xbytechat.api.AuthModule.Models\n//{\n//    [Index(nameof(BusinessId), nameof(Provider))]\n//    [Index(nameof(BusinessId), nameof(Name))]\n//    [Index(nameof(BusinessId), nameof(Name), nameof(Language), nameof(Provider), IsUnique = true)]\n//    // xbytechat_api/WhatsAppSettings/Models/WhatsAppTemplate.cs\n//    public sealed class WhatsAppTemplate\n//    {\n//        public Guid Id { get; set; }\n//        public Guid BusinessId { get; set; }\n//        public string Provider { get; set; } = \"META_CLOUD\";\n//        public string? ExternalId { get; set; }\n//        public string Name { get; set; } = \"\";\n//        public string? Language { get; set; }\n//        public string Status { get; set; } = \"APPROVED\";\n//        public string? Category { get; set; }\n\n//        // Already present in your code:\n//        public string? HeaderKind { get; set; }           // \"text\", \"image\", \"video\", \"document\", \"none\"\n//        public string? Body { get; set; }                 // we keep this as the COMBINED PREVIEW (headerText + bodyText)\n//        public int PlaceholderCount { get; set; }\n//        public string? ButtonsJson { get; set; }\n//        public string? RawJson { get; set; }\n\n//        // ‚úÖ NEW: cached, de-normalized fields for debug + send-time mapping\n//        public string? ParameterFormat { get; set; }      // \"POSITIONAL\" | \"NAMED\" | \"MIXED\" | \"UNKNOWN\"\n//        public string? HeaderText { get; set; }           // only for text headers; null for media headers\n//        public string? BodyText { get; set; }             // body block text as-is (no header included)\n\n//        // token metadata (JSON for flexibility)\n//        public string? HeaderParamIndicesJson { get; set; }   // e.g. \"[1,2]\"\n//        public string? BodyParamIndicesJson { get; set; }     // e.g. \"[1,3]\"\n//        public string? ButtonParamTemplatesJson { get; set; } // e.g. \"[{ order:1, type:'URL', text:'..', paramTemplate:'..', paramIndices:[1]}]\"\n//        public string? PlaceholderOccurrencesJson { get; set; } // full `Placeholders` array from helper (optional)\n\n//        public bool IsActive { get; set; } = true;\n//        public DateTime CreatedAt { get; set; }\n//        public DateTime UpdatedAt { get; set; }\n//        public DateTime LastSyncedAt { get; set; }\n//    }\n\n//}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Roles/UserRoles.cs",
      "sha256": "5a91bb09b9b5fc0f5fe14cf1b9727c0c8a8de225c71455452a14d491125209c5",
      "language": "csharp",
      "size": 507,
      "content": "namespace xbytechat.api.AuthModule.Roles\n{\n    public static class UserRoles\n    {\n        public const string Admin = \"admin\";         // xByte Admin\n        public const string Business = \"business\";   // Tenant Admin\n        public const string Staff = \"staff\";         // CRM Staff (future)\n        public const string Agent = \"agent\";         // WhatsApp/chat agent\n        public const string CRM = \"crm\";             // CRM-only user (future)\n        public const string Partner = \"partner\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Services/AuthService.cs",
      "sha256": "379e7afa5ee08acb8f22afa45cddb3307f1da5fb9e98559056e7c8fa59a69f57",
      "language": "csharp",
      "size": 28698,
      "content": "using System.Security.Cryptography;\nusing System.Text;\nusing xbytechat.api.AuthModule.DTOs;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Repositories.Interfaces;\nusing xbytechat.api.Features.AccessControl.Services;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.AspNetCore.Http;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.BusinessModule.Services;\n\nusing System.Security.Claims;\nusing System.IdentityModel.Tokens.Jwt;\nusing Microsoft.Extensions.Logging;\n\nnamespace xbytechat.api.AuthModule.Services\n{\n    public class AuthService : IAuthService\n    {\n        private readonly IGenericRepository<User> _userRepo;\n        private readonly IBusinessService _businessService;\n        private readonly IJwtTokenService _jwtTokenService;\n        private readonly IAccessControlService _accessControlService;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n        private readonly ILogger<AuthService> _logger;\n        private readonly AppDbContext _dbContext;\n        public AuthService(\n            IGenericRepository<User> userRepo,\n            IBusinessService businessService,\n            IJwtTokenService jwtTokenService,\n            IAccessControlService accessControlService,\n            IHttpContextAccessor httpContextAccessor,\n            ILogger<AuthService> logger,\n            AppDbContext dbContext)\n        {\n            _userRepo = userRepo;\n            _businessService = businessService;\n            _jwtTokenService = jwtTokenService;\n            _accessControlService = accessControlService;\n            _httpContextAccessor = httpContextAccessor;\n            _logger = logger;\n            _dbContext = dbContext;\n        }\n\n        //        public async Task<ResponseResult> LoginAsync(UserLoginDto dto)\n        //        {\n        //            _logger.LogInformation(\"üîë Login attempt for email: {Email}\", dto.Email);\n        //            var hashedPassword = HashPassword(dto.Password);\n\n        //            var user = await _userRepo\n        //                .AsQueryable()\n        //                .Where(u => u.Email == dto.Email && u.PasswordHash == hashedPassword && !u.IsDeleted)\n        //                .Include(u => u.Role)\n        //                .FirstOrDefaultAsync();\n\n        //            if (user == null)\n        //            {\n        //                _logger.LogWarning(\"‚ùå Login failed: Invalid email or password for {Email}\", dto.Email);\n        //                return ResponseResult.ErrorInfo(\"‚ùå Invalid email or password\");\n        //            }\n\n        //            var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n        //            var isAdminType = roleName is \"admin\" or \"superadmin\" or \"partner\" or \"reseller\";\n\n        //            if (user.BusinessId == null && !isAdminType)\n        //            {\n        //                _logger.LogWarning(\"‚ùå Login denied for {Email}: No BusinessId and not admin\", dto.Email);\n        //                return ResponseResult.ErrorInfo(\"‚ùå Your account approval is pending. Please contact your administrator or support.\");\n        //            }\n\n        //            Business? business = null;\n        //            Guid? planId = null;\n        //            string companyName = string.Empty;\n        //            string businessId = user.BusinessId?.ToString() ?? string.Empty;\n\n        //            if (user.BusinessId != null)\n        //            {\n        //                business = await _businessService.Query()\n        //                    .Include(b => b.Plan)\n        //                    .FirstOrDefaultAsync(b => b.Id == user.BusinessId.Value);\n\n        //                if (business == null)\n        //                    return ResponseResult.ErrorInfo(\"‚ùå Associated business not found.\");\n\n        //                if (business.Status == Business.StatusType.Pending)\n        //                    return ResponseResult.ErrorInfo(\"‚è≥ Your business is under review. Please wait for approval.\");\n\n        //                //if (!business.PlanId.HasValue)\n        //                //    return ResponseResult.ErrorInfo(\"‚ùå No plan assigned to this business.\");\n\n        //                planId = business.PlanId;\n        //                companyName = business.CompanyName ?? string.Empty;\n\n        //                _logger.LogInformation(\"Business {BusinessId} login. Status: {Status}, PlanId: {PlanId}\", business.Id, business.Status, planId\n        //);\n        //            }\n\n        //            if (isAdminType)\n        //            {\n        //                // Admins don‚Äôt get plan restrictions\n        //                companyName = \"xByte Admin\";\n        //                businessId = string.Empty;\n        //                planId = null;\n        //            }\n\n        //            // üî• Compute EFFECTIVE permissions (plan ‚à© role) and derive features\n        //            var (permCodes, featureKeys) = isAdminType\n        //                ? (await GetAllActivePermissions(), new List<string> { \"Dashboard\", \"Messaging\", \"CRM\", \"Campaigns\", \"Catalog\", \"AdminPanel\" })\n        //                : await GetEffectivePermissionsAndFeaturesAsync(user.Id);\n\n        //            // üé´ Generate JWT (now includes permissions, features, plan_id)\n        //            var token = _jwtTokenService.GenerateToken(\n        //                userId: user.Id.ToString(),\n        //                role: roleName,\n        //                userName: user.Name ?? string.Empty,\n        //                email: user.Email ?? string.Empty,\n        //                status: user.Status ?? \"unknown\",\n        //                businessId: businessId,\n        //                companyName: companyName,\n        //                permissions: permCodes ?? new List<string>(),\n        //                planId: planId?.ToString() ?? string.Empty,\n        //                features: featureKeys,\n        //                hasAllAccess: isAdminType\n        //            );\n        //            try\n        //            {\n        //                var jwt = new JwtSecurityTokenHandler().ReadJwtToken(token);\n        //                var pid = jwt.Claims.FirstOrDefault(c => c.Type == \"plan_id\")?.Value;\n        //                _logger.LogInformation(\"üîé JWT includes plan_id: {PlanId}\", pid ?? \"<null>\");\n        //            }\n        //            catch { /* ignore */ }\n        //            var userDto = new UserDto\n        //            {\n        //                Id = user.Id,\n        //                Name = user.Name,\n        //                Email = user.Email,\n        //                Role = roleName,\n        //                Status = user.Status,\n        //                CreatedAt = user.CreatedAt,\n        //                BusinessId = string.IsNullOrEmpty(businessId) ? Guid.Empty : Guid.Parse(businessId),\n        //                CompanyName = companyName,\n        //                PlanId = planId,\n        //                AccessToken = null\n        //            };\n\n        //            _logger.LogInformation(\n        //                \"‚úÖ Login successful for {Email}, Role: {Role}, PlanId: {PlanId}\",\n        //                dto.Email, roleName, planId\n        //            );\n\n        //            return new ResponseResult\n        //            {\n        //                Success = true,\n        //                Message = \"‚úÖ Login successful\",\n        //                Data = userDto,\n        //                Token = token\n        //            };\n        //        }\n\n        public async Task<ResponseResult> LoginAsync(UserLoginDto dto)\n        {\n            _logger.LogInformation(\"üîë Login attempt for email: {Email}\", dto.Email);\n            var hashedPassword = HashPassword(dto.Password);\n\n            var user = await _userRepo\n                .AsQueryable()\n                .Where(u => u.Email == dto.Email && u.PasswordHash == hashedPassword && !u.IsDeleted)\n                .Include(u => u.Role)\n                .FirstOrDefaultAsync();\n\n            if (user == null)\n            {\n                _logger.LogWarning(\"‚ùå Login failed: Invalid email or password for {Email}\", dto.Email);\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid email or password\");\n            }\n\n            var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n            var isAdminType = roleName is \"admin\" or \"superadmin\" or \"partner\" or \"reseller\";\n\n            if (user.BusinessId == null && !isAdminType)\n            {\n                _logger.LogWarning(\"‚ùå Login denied for {Email}: No BusinessId and not admin\", dto.Email);\n                return ResponseResult.ErrorInfo(\"‚ùå Your account approval is pending. Please contact your administrator or support.\");\n            }\n\n            Business? business = null;\n\n            // This is the REAL plan id from DB (can be internal)\n            Guid? planId = null;\n\n            // This is what we expose to the FRONTEND (hide internal plans)\n            Guid? exposedPlanId = null;\n\n            string companyName = string.Empty;\n            string businessId = user.BusinessId?.ToString() ?? string.Empty;\n\n            if (user.BusinessId != null)\n            {\n                business = await _businessService.Query()\n                    .Include(b => b.Plan) // ensure Plan loaded so we can check IsInternal\n                    .FirstOrDefaultAsync(b => b.Id == user.BusinessId.Value);\n\n                if (business == null)\n                    return ResponseResult.ErrorInfo(\"‚ùå Associated business not found.\");\n\n                if (business.Status == Business.StatusType.Pending)\n                    return ResponseResult.ErrorInfo(\"‚è≥ Your business is under review. Please wait for approval.\");\n\n                planId = business.PlanId;\n                companyName = business.CompanyName ?? string.Empty;\n\n                // üß† Decide whether to expose plan to frontend\n                var isInternalPlan = business.Plan?.IsInternal == true;\n                exposedPlanId = isInternalPlan ? null : planId;\n\n                _logger.LogInformation(\n                    \"Business {BusinessId} login. Status: {Status}, DbPlanId: {DbPlanId}, ExposedPlanId: {ExposedPlanId}, IsInternal: {IsInternal}\",\n                    business.Id, business.Status, planId, exposedPlanId, isInternalPlan\n                );\n            }\n\n            if (isAdminType)\n            {\n                // Admins don‚Äôt get plan restrictions and shouldn't show a plan in UI\n                companyName = \"xByte Admin\";\n                businessId = string.Empty;\n                planId = null;\n                exposedPlanId = null;\n            }\n\n            // üî• Compute EFFECTIVE permissions (plan ‚à© role) and derive features\n            var (permCodes, featureKeys) = isAdminType\n                ? (await GetAllActivePermissions(), new List<string> { \"Dashboard\", \"Messaging\", \"CRM\", \"Campaigns\", \"Catalog\", \"AdminPanel\" })\n                : await GetEffectivePermissionsAndFeaturesAsync(user.Id);\n\n            // üé´ Generate JWT ‚Üí use EXPOSED plan id (hide internal/system plans)\n            var token = _jwtTokenService.GenerateToken(\n                userId: user.Id.ToString(),\n                role: roleName,\n                userName: user.Name ?? string.Empty,\n                email: user.Email ?? string.Empty,\n                status: user.Status ?? \"unknown\",\n                businessId: businessId,\n                companyName: companyName,\n                permissions: permCodes ?? new List<string>(),\n                planId: exposedPlanId?.ToString() ?? string.Empty,\n                features: featureKeys,\n                hasAllAccess: isAdminType\n            );\n\n            try\n            {\n                var jwt = new JwtSecurityTokenHandler().ReadJwtToken(token);\n                var pid = jwt.Claims.FirstOrDefault(c => c.Type == \"plan_id\")?.Value;\n                _logger.LogInformation(\"üîé JWT includes plan_id (exposed): {PlanId}\", pid ?? \"<null>\");\n            }\n            catch\n            {\n                // ignore\n            }\n\n            var userDto = new UserDto\n            {\n                Id = user.Id,\n                Name = user.Name,\n                Email = user.Email,\n                Role = roleName,\n                Status = user.Status,\n                CreatedAt = user.CreatedAt,\n                BusinessId = string.IsNullOrEmpty(businessId) ? Guid.Empty : Guid.Parse(businessId),\n                CompanyName = companyName,\n\n                // üëá important: return ONLY the exposed plan id to the frontend\n                PlanId = exposedPlanId,\n\n                AccessToken = null\n            };\n\n            _logger.LogInformation(\n                \"‚úÖ Login successful for {Email}, Role: {Role}, DbPlanId: {DbPlanId}, ExposedPlanId: {ExposedPlanId}\",\n                dto.Email, roleName, planId, exposedPlanId\n            );\n\n            return new ResponseResult\n            {\n                Success = true,\n                Message = \"‚úÖ Login successful\",\n                Data = userDto,\n                Token = token\n            };\n        }\n\n        public async Task<ResponseResult> SignupAsync(SignupBusinessDto dto)\n        {\n            _logger.LogInformation(\"üü¢ Signup attempt: {Email}\", dto.Email);\n            var result = await _businessService.SignupBusinessAsync(dto);\n\n            if (!result.Success)\n            {\n                _logger.LogWarning(\"‚ùå Signup failed for {Email}: {Msg}\", dto.Email, result.Message);\n                return ResponseResult.ErrorInfo(result.Message);\n            }\n\n            var business = await _businessService.GetBusinessByEmailAsync(dto.Email);\n\n            if (business == null)\n            {\n                _logger.LogError(\"‚ùå Signup succeeded but business retrieval failed for {Email}\", dto.Email);\n                return ResponseResult.ErrorInfo(\"‚ùå Signup succeeded but business retrieval failed.\");\n            }\n\n            // No extra UpdateBusinessAsync call here.\n            // CreatedByPartnerId is set inside SignupBusinessAsync.\n\n            _logger.LogInformation(\"‚úÖ Signup successful for {Email} (BusinessId: {BusinessId})\", dto.Email, business.Id);\n            return ResponseResult.SuccessInfo(\"‚úÖ Signup successful. Pending approval.\", new { BusinessId = business.Id });\n        }\n\n\n        // üîÑ Refresh JWT Token (and Rotate)\n        //public async Task<ResponseResult> RefreshTokenAsync(string refreshToken)\n        //{\n        //    _logger.LogInformation(\"üîÑ RefreshToken attempt\");\n\n        //    var user = await _userRepo\n        //        .AsQueryable()\n        //        .Include(u => u.Role)\n        //        .Include(u => u.Business)\n        //            .ThenInclude(b => b.BusinessPlanInfo)\n        //        .FirstOrDefaultAsync(u => u.RefreshToken == refreshToken && u.RefreshTokenExpiry > DateTime.UtcNow);\n\n        //    if (user == null)\n        //    {\n        //        _logger.LogWarning(\"‚ùå Invalid or expired refresh token.\");\n        //        return ResponseResult.ErrorInfo(\"‚ùå Invalid or expired refresh token.\");\n        //    }\n\n        //    var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n        //    var isAdminType = roleName is \"admin\" or \"superadmin\" or \"partner\" or \"reseller\";\n\n        //    string planId = user.Business?.PlanId?.ToString() ?? string.Empty;\n        //    string companyName = isAdminType ? \"xByte Admin\" : (user.Business?.CompanyName ?? string.Empty);\n        //    string businessId = isAdminType ? string.Empty : (user.BusinessId?.ToString() ?? string.Empty);\n\n        //    var (permCodes, featureKeys) = isAdminType\n        //        ? (await GetAllActivePermissions(), new List<string> { \"Dashboard\", \"Messaging\", \"CRM\", \"Campaigns\", \"Catalog\", \"AdminPanel\" })\n        //        : await GetEffectivePermissionsAndFeaturesAsync(user.Id);\n\n        //    var claims = new List<Claim>\n        //{\n        //    new Claim(JwtRegisteredClaimNames.Sub, user.Id.ToString()),\n        //    new Claim(\"id\", user.Id.ToString()),\n        //    new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),\n        //    new Claim(\"email\", user.Email ?? \"\"),\n        //    new Claim(\"name\", user.Name ?? \"\"),\n        //    new Claim(\"status\", user.Status ?? \"unknown\"),\n        //    new Claim(\"businessId\", businessId),\n        //    new Claim(\"companyName\", companyName),\n        //    new Claim(\"permissions\", string.Join(\",\", permCodes ?? new List<string>())),\n        //    new Claim(\"features\", string.Join(\",\", featureKeys ?? new List<string>())),\n        //    new Claim(\"hasAllAccess\", isAdminType ? \"true\" : \"false\"),\n        //    new Claim(\"role\", roleName),\n        //    new Claim(ClaimTypes.Role, roleName),\n        //    new Claim(\"plan_id\", planId ?? string.Empty)\n        //};\n\n        //    var token = _jwtTokenService.GenerateToken(claims);\n\n        //    // üîÅ Rotate refresh token\n        //    var newRefreshToken = Guid.NewGuid().ToString(\"N\");\n        //    user.RefreshToken = newRefreshToken;\n        //    user.RefreshTokenExpiry = DateTime.UtcNow.AddDays(30);\n        //    _userRepo.Update(user);\n\n        //    _logger.LogInformation(\"üîÑ Token refreshed for user {UserId}, role {Role}\", user.Id, roleName);\n\n        //    return ResponseResult.SuccessInfo(\"üîÑ Token refreshed\", new\n        //    {\n        //        accessToken = token,\n        //        refreshToken = newRefreshToken\n        //    });\n        //}\n        public async Task<ResponseResult> RefreshTokenAsync(string refreshToken)\n        {\n            _logger.LogInformation(\"üîÑ RefreshToken attempt\");\n\n            var user = await _userRepo\n                .AsQueryable()\n                .Include(u => u.Role)\n                .Include(u => u.Business)\n                    .ThenInclude(b => b.BusinessPlanInfo)\n                .Include(u => u.Business)\n                    .ThenInclude(b => b.Plan) // üëà ensure Plan is loaded\n                .FirstOrDefaultAsync(u =>\n                    u.RefreshToken == refreshToken &&\n                    u.RefreshTokenExpiry > DateTime.UtcNow\n                );\n\n            if (user == null)\n            {\n                _logger.LogWarning(\"‚ùå Invalid or expired refresh token.\");\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid or expired refresh token.\");\n            }\n\n            var roleName = user.Role?.Name?.Trim().ToLower() ?? \"unknown\";\n            var isAdminType = roleName is \"admin\" or \"superadmin\" or \"partner\" or \"reseller\";\n\n            string companyName;\n            string businessId;\n\n            // REAL plan from DB\n            Guid? dbPlanId = user.Business?.PlanId;\n\n            // What we expose to frontend (null for internal plans)\n            string? exposedPlanIdForClaim = null;\n\n            if (isAdminType)\n            {\n                companyName = \"xByte Admin\";\n                businessId = string.Empty;\n                dbPlanId = null;\n                exposedPlanIdForClaim = null;\n            }\n            else\n            {\n                companyName = user.Business?.CompanyName ?? string.Empty;\n                businessId = user.BusinessId?.ToString() ?? string.Empty;\n\n                if (dbPlanId.HasValue)\n                {\n                    var isInternalPlan = user.Business?.Plan?.IsInternal == true;\n                    if (!isInternalPlan)\n                    {\n                        exposedPlanIdForClaim = dbPlanId.Value.ToString();\n                    }\n\n                    _logger.LogInformation(\n                        \"üîÑ RefreshToken: Business {BusinessId}, DbPlanId: {DbPlanId}, ExposedPlanId: {ExposedPlanId}, IsInternal: {IsInternal}\",\n                        businessId, dbPlanId, exposedPlanIdForClaim, isInternalPlan\n                    );\n                }\n            }\n\n            var (permCodes, featureKeys) = isAdminType\n                ? (await GetAllActivePermissions(), new List<string> { \"Dashboard\", \"Messaging\", \"CRM\", \"Campaigns\", \"Catalog\", \"AdminPanel\" })\n                : await GetEffectivePermissionsAndFeaturesAsync(user.Id);\n\n            var claims = new List<Claim>\n    {\n        new Claim(JwtRegisteredClaimNames.Sub, user.Id.ToString()),\n        new Claim(\"id\", user.Id.ToString()),\n        new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),\n        new Claim(\"email\", user.Email ?? \"\"),\n        new Claim(\"name\", user.Name ?? \"\"),\n        new Claim(\"status\", user.Status ?? \"unknown\"),\n        new Claim(\"businessId\", businessId),\n        new Claim(\"companyName\", companyName),\n        new Claim(\"permissions\", string.Join(\",\", permCodes ?? new List<string>())),\n        new Claim(\"features\", string.Join(\",\", featureKeys ?? new List<string>())),\n        new Claim(\"hasAllAccess\", isAdminType ? \"true\" : \"false\"),\n        new Claim(\"role\", roleName),\n        new Claim(ClaimTypes.Role, roleName)\n    };\n\n            // üëâ Only add plan_id claim if we want the frontend to see it\n            if (!string.IsNullOrWhiteSpace(exposedPlanIdForClaim))\n            {\n                claims.Add(new Claim(\"plan_id\", exposedPlanIdForClaim));\n            }\n\n            var token = _jwtTokenService.GenerateToken(claims);\n\n            // üîÅ Rotate refresh token\n            var newRefreshToken = Guid.NewGuid().ToString(\"N\");\n            user.RefreshToken = newRefreshToken;\n            user.RefreshTokenExpiry = DateTime.UtcNow.AddDays(30);\n            _userRepo.Update(user);\n\n            _logger.LogInformation(\n                \"üîÑ Token refreshed for user {UserId}, role {Role}, DbPlanId: {DbPlanId}, ExposedPlanId: {ExposedPlanId}\",\n                user.Id, roleName, dbPlanId, exposedPlanIdForClaim\n            );\n\n            return ResponseResult.SuccessInfo(\"üîÑ Token refreshed\", new\n            {\n                accessToken = token,\n                refreshToken = newRefreshToken\n            });\n        }\n\n\n\n\n        public async Task<ResponseResult> ResendConfirmationAsync(ResendConfirmationDto dto)\n        {\n            _logger.LogInformation(\"üîÅ Resend confirmation attempt for {Email}\", dto.Email);\n            var business = await _businessService.GetBusinessByEmailAsync(dto.Email);\n            if (business == null)\n            {\n                _logger.LogWarning(\"‚ùå Resend confirmation failed: No business for {Email}\", dto.Email);\n                return ResponseResult.ErrorInfo(\"‚ùå No business registered with this email\");\n            }\n\n            _logger.LogInformation(\"‚úÖ Resend confirmation request processed for {Email}\", dto.Email);\n            return ResponseResult.SuccessInfo(\"üì® Confirmation request resent.\");\n        }\n\n        // üîí Reset password\n        public async Task<ResponseResult> ResetPasswordAsync(ResetPasswordDto dto)\n        {\n            _logger.LogInformation(\"üîí Reset password attempt for {Email}\", dto.Email);\n            var user = await _userRepo.FirstOrDefaultAsync(u => u.Email == dto.Email);\n            if (user == null)\n            {\n                _logger.LogWarning(\"‚ùå Reset password failed: No user for {Email}\", dto.Email);\n                return ResponseResult.ErrorInfo(\"‚ùå No user found with this email\");\n            }\n\n            user.PasswordHash = HashPassword(dto.NewPassword);\n            _userRepo.Update(user);\n\n            _logger.LogInformation(\"‚úÖ Password reset successfully for {Email}\", dto.Email);\n            return ResponseResult.SuccessInfo(\"‚úÖ Password reset successfully\");\n        }\n\n        // Utility: Hash password using SHA256\n        //private string HashPassword(string password)\n        //{\n        //    using var sha = SHA256.Create();\n        //    var bytes = Encoding.UTF8.GetBytes(password);\n        //    var hash = sha.ComputeHash(bytes);\n        //    return Convert.ToBase64String(hash);\n        //}\n        // INTERSECTION: Role ‚à© Plan for the user, then map groups -> feature keys\n        //private async Task<(List<string> Perms, List<string> Features)> GetEffectivePermissionsAndFeaturesAsync(Guid userId)\n        //{\n        //    var userAndPermissions = _dbContext.Users\n        //        .Where(u => u.Id == userId)\n        //        .Join(_dbContext.Businesses,\n        //            u => u.BusinessId,\n        //            b => b.Id,\n        //            (u, b) => new { u, b })\n        //        .Join(_dbContext.PlanPermissions.Where(pp => pp.IsActive),\n        //            ub => ub.b.PlanId,\n        //            pp => pp.PlanId,\n        //            (ub, pp) => new { ub.u, pp })\n        //        .Join(_dbContext.Permissions.Where(p => p.IsActive),\n        //            ubpp => ubpp.pp.PermissionId,\n        //            p => p.Id,\n        //            (ubpp, p) => new { ubpp.u, p }); // This gives you a sequence of {user, permission} pairs\n\n        //    // Replace the final problematic Join with this Where clause\n        //    var rows = await userAndPermissions\n        //        .Where(up => _dbContext.RolePermissions\n        //            .Where(rp => rp.IsActive && !rp.IsRevoked)\n        //            .Any(rp => rp.RoleId == up.u.RoleId && rp.PermissionId == up.p.Id))\n        //        .Select(up => up.p) // Select the final permission object\n        //        .Select(p => new { p.Code, p.Group })\n        //        .Distinct()\n        //        .ToListAsync();\n\n        //    var perms = rows.Select(r => r.Code).ToList();\n\n        //    var features = rows.Select(r => r.Group)\n        //        .Where(g => !string.IsNullOrWhiteSpace(g))\n        //        .Select(GroupToFeature)\n        //        .Where(f => f != null)\n        //        .Select(f => f!)\n        //        .Distinct(StringComparer.OrdinalIgnoreCase)\n        //        .ToList();\n\n        //    return (perms, features);\n        //}\n        //// If you ever need ‚Äúall perms‚Äù (e.g., for superadmins)\n        /// <summary>\n        /// \n        /// </summary>\n        /// <returns></returns>\n        /// \n        private async Task<(List<string> Perms, List<string> Features)> GetEffectivePermissionsAndFeaturesAsync(Guid userId)\n        {\n            var rows = await _dbContext.Users\n                .AsNoTracking()\n                .Where(u => u.Id == userId)\n                .Join(_dbContext.Businesses.AsNoTracking(),\n                      u => u.BusinessId,\n                      b => b.Id,\n                      (u, b) => new { u, b })\n                .Join(_dbContext.PlanPermissions.AsNoTracking().Where(pp => pp.IsActive),\n                      ub => ub.b.PlanId,\n                      pp => pp.PlanId,\n                      (ub, pp) => new { ub.u, pp })\n                .Join(_dbContext.Permissions.AsNoTracking().Where(p => p.IsActive),\n                      ubpp => ubpp.pp.PermissionId,\n                      p => p.Id,\n                      (ubpp, p) => new { ubpp.u, p })\n                // Intersect with RolePermissions via EXISTS\n                .Where(up => _dbContext.RolePermissions\n                    .AsNoTracking()\n                    .Where(rp => rp.IsActive && !rp.IsRevoked)\n                    .Any(rp => rp.RoleId == up.u.RoleId && rp.PermissionId == up.p.Id))\n                .Select(up => new { up.p.Code, up.p.Group })\n                .Distinct()\n                .ToListAsync();\n\n            var perms = rows.Select(r => r.Code).ToList();\n\n            var features = rows.Select(r => r.Group)\n                .Where(g => !string.IsNullOrWhiteSpace(g))\n                .Select(GroupToFeature)\n                .Where(f => f != null)\n                .Select(f => f!)\n                .Distinct(StringComparer.OrdinalIgnoreCase)\n                .ToList();\n\n            return (perms, features);\n        }\n\n        private async Task<List<string>> GetAllActivePermissions() =>\n            await _dbContext.Permissions\n                .Where(p => p.IsActive)\n                .Select(p => p.Code)\n                .OrderBy(c => c)\n                .ToListAsync();\n\n        private static string? GroupToFeature(string? g) => g switch\n        {\n            \"Messaging\" => \"Messaging\",\n            \"Contacts\" => \"CRM\",\n            \"Campaign\" => \"Campaigns\",\n            \"Product\" => \"Catalog\",\n            \"Dashboard\" => \"Dashboard\",\n            \"Admin\" => \"AdminPanel\",\n            _ => null\n        };\n\n        private string HashPassword(string password)\n        {\n            using var sha = SHA256.Create();\n            var bytes = Encoding.UTF8.GetBytes(password);\n            var hash = sha.ComputeHash(bytes);\n            return Convert.ToBase64String(hash);\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Services/IAuthService.cs",
      "sha256": "0ba16acc52a94c3f3a942c3bf05a595aa307b6f399515662cd0c053dd69fb632",
      "language": "csharp",
      "size": 667,
      "content": "using System.Security.Claims;\nusing xbytechat.api.AuthModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.AuthModule.Services\n{\n    public interface IAuthService\n    {\n        Task<ResponseResult> LoginAsync(UserLoginDto dto);\n        Task<ResponseResult> SignupAsync(SignupBusinessDto dto);                  // ‚úÖ Add this\n        Task<ResponseResult> ResetPasswordAsync(ResetPasswordDto dto);           // ‚úÖ Add this\n        Task<ResponseResult> ResendConfirmationAsync(ResendConfirmationDto dto); // ‚úÖ Add this\n        Task<ResponseResult> RefreshTokenAsync(string refreshToken);\n    \n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Services/IJwtTokenService.cs",
      "sha256": "6d4a732e224fe37de1184e7c79c9a3413bab6ea6cda0d29a1c3fb5a70cf9b6e7",
      "language": "csharp",
      "size": 750,
      "content": "using Microsoft.IdentityModel.Tokens;\nusing System.Collections.Generic;\nusing System.Security.Claims;\n\nnamespace xbytechat.api.AuthModule.Services\n{\n    public interface IJwtTokenService\n    {\n        string GenerateToken(\n            string userId,\n            string role,\n            string userName,\n            string email,\n            string status,\n            string businessId,\n            string companyName,\n                       List<string> permissions,\n            string planId,\n              List<string>? features = null,\n            bool hasAllAccess = false\n        );\n        string GenerateToken(IEnumerable<Claim> claims);\n        TokenValidationParameters GetValidationParameters(); // ‚úÖ For Middleware validation\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/AuthModule/Services/JwtTokenService.cs",
      "sha256": "54b0235003a02ee3bff4006db2d37974e88962409ec7f015cbad4ad2a264491f",
      "language": "csharp",
      "size": 12625,
      "content": "using Microsoft.Extensions.Configuration;\nusing Microsoft.Extensions.Logging;\nusing Microsoft.IdentityModel.Tokens;\nusing System;\nusing System.Collections.Generic;\nusing System.IdentityModel.Tokens.Jwt;\nusing System.Linq;\nusing System.Security.Claims;\nusing System.Text;\n\nnamespace xbytechat.api.AuthModule.Services\n{\n    public class JwtTokenService : IJwtTokenService\n    {\n        private readonly IConfiguration _config;\n        private readonly ILogger<JwtTokenService> _logger;\n\n        public JwtTokenService(IConfiguration config, ILogger<JwtTokenService> logger)\n        {\n            _config = config;\n            _logger = logger;\n        }\n\n        public string GenerateToken(\n            string userId,\n            string role,\n            string userName,\n            string email,\n            string status,\n            string businessId,\n            string companyName,\n            List<string> permissions,\n            string planId,\n            List<string>? features = null,\n            bool hasAllAccess = false)\n        {\n            try\n            {\n                var permissionString = string.Join(\",\", permissions ?? new List<string>());\n                var featuresString = string.Join(\",\", features ?? new List<string>());\n\n                var claims = new List<Claim>\n{\n    new Claim(JwtRegisteredClaimNames.Sub, userId),\n    new Claim(\"id\", userId),\n    new Claim(ClaimTypes.NameIdentifier, userId),\n\n    new Claim(\"email\", email ?? \"\"),\n    new Claim(\"name\", userName ?? \"\"),\n    new Claim(\"status\", status ?? \"unknown\"),\n\n    // üîê Business id: add BOTH for compatibility\n    new Claim(\"BusinessId\", businessId ?? \"\"), // <-- used by our helpers/controllers\n    new Claim(\"businessId\", businessId ?? \"\"), // <-- keep for existing clients\n\n    new Claim(\"companyName\", companyName ?? \"\"),\n\n    // üîñ Role (API + UI)\n    new Claim(\"role\", role?.ToLowerInvariant() ?? \"unknown\"),\n    new Claim(ClaimTypes.Role, role?.ToLowerInvariant() ?? \"unknown\"),\n\n    // üß© Plan & access\n    new Claim(\"plan_id\", planId ?? string.Empty),\n    new Claim(\"permissions\", string.Join(\",\", permissions ?? new List<string>())),\n    new Claim(\"features\", string.Join(\",\", features ?? new List<string>())),\n    new Claim(\"hasAllAccess\", hasAllAccess ? \"true\" : \"false\"),\n};\n\n\n                return GenerateToken(claims);\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"‚ùå Error generating token for userId: {UserId}\", userId);\n                throw;\n            }\n        }\n\n        public string GenerateToken(IEnumerable<Claim> claims)\n        {\n            try\n            {\n                var jwtSettings = _config.GetSection(\"JwtSettings\");\n\n                var secret = jwtSettings[\"SecretKey\"];\n                if (string.IsNullOrEmpty(secret))\n                {\n                    _logger.LogWarning(\"‚ö†Ô∏è JWT SecretKey is missing from configuration.\");\n                    throw new Exception(\"JWT SecretKey is not configured.\");\n                }\n\n                var expiry = jwtSettings[\"ExpiryMinutes\"];\n                if (!int.TryParse(expiry, out var expiryMinutes))\n                {\n                    _logger.LogWarning(\"‚ö†Ô∏è JWT ExpiryMinutes is invalid or missing. Defaulting to 60 minutes.\");\n                    expiryMinutes = 60;\n                }\n\n                var secretKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secret));\n                var creds = new SigningCredentials(secretKey, SecurityAlgorithms.HmacSha256);\n\n                var expires = DateTime.UtcNow.AddMinutes(expiryMinutes);\n                var unixExp = new DateTimeOffset(expires).ToUnixTimeSeconds();\n\n                var finalClaims = claims.ToList();\n                finalClaims.Add(new Claim(JwtRegisteredClaimNames.Exp, unixExp.ToString()));\n\n                var token = new JwtSecurityToken(\n                    issuer: jwtSettings[\"Issuer\"],\n                    audience: jwtSettings[\"Audience\"],\n                    claims: finalClaims,\n                    expires: expires,\n                    signingCredentials: creds\n                );\n\n                _logger.LogInformation(\"‚úÖ Token generated for: {Email}\", finalClaims.FirstOrDefault(c => c.Type == \"email\")?.Value);\n\n                return new JwtSecurityTokenHandler().WriteToken(token);\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"‚ùå Error generating JWT from claims.\");\n                throw;\n            }\n        }\n\n        public TokenValidationParameters GetValidationParameters()\n        {\n            var jwtSettings = _config.GetSection(\"JwtSettings\");\n\n            return new TokenValidationParameters\n            {\n                ValidateIssuer = true,\n                ValidateAudience = true,\n                ValidateIssuerSigningKey = true,\n                ValidateLifetime = true,\n                RequireSignedTokens = true,\n                RequireExpirationTime = true,\n                ValidIssuer = jwtSettings[\"Issuer\"],\n                ValidAudience = jwtSettings[\"Audience\"],\n                IssuerSigningKey = new SymmetricSecurityKey(\n                    Encoding.UTF8.GetBytes(jwtSettings[\"SecretKey\"])\n                ),\n                ClockSkew = TimeSpan.Zero,\n                RoleClaimType = \"role\",\n                NameClaimType = \"name\"\n            };\n        }\n    }\n}\n\n\n//using Microsoft.Extensions.Configuration;\n//using Microsoft.Extensions.Logging;\n//using Microsoft.IdentityModel.Tokens;\n//using System;\n//using System.Collections.Generic;\n//using System.IdentityModel.Tokens.Jwt;\n//using System.Linq;\n//using System.Security.Claims;\n//using System.Text;\n\n//namespace xbytechat.api.AuthModule.Services\n//{\n//    public class JwtTokenService : IJwtTokenService\n//    {\n//        private readonly IConfiguration _config;\n//        private readonly ILogger<JwtTokenService> _logger;\n\n//        public JwtTokenService(IConfiguration config, ILogger<JwtTokenService> logger)\n//        {\n//            _config = config;\n//            _logger = logger;\n//        }\n\n//        //public string GenerateToken(\n//        //    string userId,\n//        //    string role,\n//        //    string userName,\n//        //    string email,\n//        //    string status,\n//        //    string businessId,\n//        //    string companyName,\n//        //    string plan,\n//        //    List<string> permissions)\n//        //{\n//        //    try\n//        //    {\n//        //        var permissionString = string.Join(\",\", permissions ?? new List<string>());\n\n//        //        var claims = new List<Claim>\n//        //        {\n//        //            new Claim(JwtRegisteredClaimNames.Sub, userId),\n//        //            new Claim(\"id\", userId),\n//        //            new Claim(ClaimTypes.NameIdentifier, userId),\n//        //            new Claim(\"email\", email ?? \"\"),\n//        //            new Claim(\"role\", role?.ToLowerInvariant() ?? \"unknown\"),    // lowercased!\n//        //            new Claim(\"name\", userName ?? \"\"),\n//        //            new Claim(\"status\", status ?? \"unknown\"),\n//        //            new Claim(\"businessId\", businessId ?? \"\"),                   // lowercased!\n//        //            new Claim(\"companyName\", companyName ?? \"\"),\n//        //            new Claim(\"plan\", plan?.ToLowerInvariant() ?? \"basic\"),      // lowercased!\n//        //            new Claim(\"permissions\", permissionString)\n//        //        };\n\n//        //        return GenerateToken(claims);\n//        //    }\n//        //    catch (Exception ex)\n//        //    {\n//        //        _logger.LogError(ex, \"‚ùå Error generating token for userId: {UserId}\", userId);\n//        //        throw;\n//        //    }\n//        //}\n//        public string GenerateToken(string userId, string role,string userName,\n//                                    string email,\n//                                    string status,\n//                                    string businessId,\n//                                    string companyName,\n//                                    //string plan,\n//                                    List<string> permissions,\n//                                    string planId)\n//        {\n//            try\n//            {\n//                var permissionString = string.Join(\",\", permissions ?? new List<string>());\n\n//                var claims = new List<Claim>\n//        {\n//            new Claim(JwtRegisteredClaimNames.Sub, userId),\n//            new Claim(\"id\", userId),\n//            new Claim(ClaimTypes.NameIdentifier, userId),\n//            new Claim(\"email\", email ?? \"\"),\n//            new Claim(\"name\", userName ?? \"\"),\n//            new Claim(\"status\", status ?? \"unknown\"),\n//            new Claim(\"businessId\", businessId ?? \"\"),\n//            new Claim(\"companyName\", companyName ?? \"\"),\n//           // new Claim(\"plan\", plan?.ToLowerInvariant() ?? \"basic\"),\n//            new Claim(\"permissions\", permissionString),\n\n//            // ‚úÖ Proper role mapping for both ASP.NET and frontend\n//            new Claim(\"role\", role?.ToLowerInvariant() ?? \"unknown\"),           // for React\n//            new Claim(ClaimTypes.Role, role?.ToLowerInvariant() ?? \"unknown\") ,  // for ASP.NET\n//            new Claim(\"plan_id\", planId ?? string.Empty)\n\n//        };\n\n//                return GenerateToken(claims);\n//            }\n//            catch (Exception ex)\n//            {\n//                _logger.LogError(ex, \"‚ùå Error generating token for userId: {UserId}\", userId);\n//                throw;\n//            }\n//        }\n\n//        public string GenerateToken(IEnumerable<Claim> claims)\n//        {\n//            try\n//            {\n//                var jwtSettings = _config.GetSection(\"JwtSettings\");\n\n//                var secret = jwtSettings[\"SecretKey\"];\n//                if (string.IsNullOrEmpty(secret))\n//                {\n//                    _logger.LogWarning(\"‚ö†Ô∏è JWT SecretKey is missing from configuration.\");\n//                    throw new Exception(\"JWT SecretKey is not configured.\");\n//                }\n\n//                var expiry = jwtSettings[\"ExpiryMinutes\"];\n//                if (!int.TryParse(expiry, out var expiryMinutes))\n//                {\n//                    _logger.LogWarning(\"‚ö†Ô∏è JWT ExpiryMinutes is invalid or missing. Defaulting to 60 minutes.\");\n//                    expiryMinutes = 60;\n//                }\n\n//                var secretKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secret));\n//                var creds = new SigningCredentials(secretKey, SecurityAlgorithms.HmacSha256);\n\n//                var expires = DateTime.UtcNow.AddMinutes(expiryMinutes);\n//                var unixExp = new DateTimeOffset(expires).ToUnixTimeSeconds();\n\n//                var finalClaims = claims.ToList();\n//                finalClaims.Add(new Claim(JwtRegisteredClaimNames.Exp, unixExp.ToString()));\n\n//                var token = new JwtSecurityToken(\n//                    issuer: jwtSettings[\"Issuer\"],\n//                    audience: jwtSettings[\"Audience\"],\n//                    claims: finalClaims,\n//                    expires: expires,\n//                    signingCredentials: creds\n//                );\n\n//                _logger.LogInformation(\"‚úÖ Token generated for: {Email}\", finalClaims.FirstOrDefault(c => c.Type == \"email\")?.Value);\n\n//                return new JwtSecurityTokenHandler().WriteToken(token);\n//            }\n//            catch (Exception ex)\n//            {\n//                _logger.LogError(ex, \"‚ùå Error generating JWT from claims.\");\n//                throw;\n//            }\n//        }\n\n//        public TokenValidationParameters GetValidationParameters()\n//        {\n//            var jwtSettings = _config.GetSection(\"JwtSettings\");\n\n//            return new TokenValidationParameters\n//            {\n//                ValidateIssuer = true,\n//                ValidateAudience = true,\n//                ValidateIssuerSigningKey = true,\n//                ValidateLifetime = true,\n//                RequireSignedTokens = true,\n//                RequireExpirationTime = true,\n//                ValidIssuer = jwtSettings[\"Issuer\"],\n//                ValidAudience = jwtSettings[\"Audience\"],\n//                IssuerSigningKey = new SymmetricSecurityKey(\n//                    Encoding.UTF8.GetBytes(jwtSettings[\"SecretKey\"])\n//                ),\n//                ClockSkew = TimeSpan.Zero,\n//                RoleClaimType = \"role\",   // standardized!\n//                NameClaimType = \"name\"\n//            };\n//        }\n//    }\n//}\n"
    }
  ]
}
