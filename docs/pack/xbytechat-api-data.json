{
  "name": "xbytechat-api/Data",
  "generatedAt": "2025-12-10 08:27:07 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Data/AppDbContext.cs",
      "sha256": "ec8e3aa26efdb1cf3d154b9cd229ac5d67f3c36bb286bb8fb3024cbdf7ba1f7b",
      "language": "csharp",
      "size": 58317,
      "content": "using Microsoft.EntityFrameworkCore;\nusing System.Globalization;\nusing xbytechat.api.Features.Catalog.Models;\nusing xbytechat.api.Models.BusinessModel;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.AccessControl.Seeder;\nusing xbytechat.api.Features.AuditTrail.Models;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing xbytechat.api.Features.CTAManagement.Models;\nusing xbytechat.api.Features.Tracking.Models;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Features.Webhooks.Models;\nusing xbytechat.api.Features.CTAFlowBuilder.Models;\nusing xbytechat.api.Features.Inbox.Models;\nusing xbytechat.api.Features.AutoReplyBuilder.Models;\nusing xbytechat.api.Features.AutoReplyBuilder.Flows.Models;\nusing xbytechat.api.Features.BusinessModule.Models;\n\nusing xbytechat.api.Features.PlanManagement.Models;\nusing xbytechat.api.Features.Automation.Models;\nusing xbytechat.api.Features.CampaignTracking.Worker;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\nusing Microsoft.AspNetCore.Http.HttpResults;\nusing xbytechat_api.Features.Billing.Models;\nusing xbytechat.api.Features.CustomeApi.Models;\nusing xbytechat.api.Features.CampaignTracking.EntityTypeConfigs;\nusing xbytechat.api.Features.TemplateModule.Models;\nusing xbytechat.api.Features.ESU.Shared;\nusing xbytechat.api.Features.ESU.Facebook.Models;\nusing xbytechat.api.Features.AccountInsights.Models;\nusing xbytechat.api.Features.Payment.Models;\nusing xbytechat.api.Features.Entitlements.Models;\nusing Microsoft.EntityFrameworkCore.Storage.ValueConversion;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.CRM.Timelines.Models;\n\n\nnamespace xbytechat.api\n{\n    public class AppDbContext : DbContext\n    {\n        public AppDbContext(DbContextOptions<AppDbContext> options)\n            : base(options) { }\n\n        public DbSet<Business> Businesses { get; set; }\n        public DbSet<User> Users { get; set; }\n        public DbSet<MessageLog> MessageLogs { get; set; }\n        public DbSet<Product> Products { get; set; }\n        public DbSet<CatalogClickLog> CatalogClickLogs { get; set; }\n        public DbSet<Contact> Contacts { get; set; }\n        public DbSet<Tag> Tags { get; set; }\n        public DbSet<Reminder> Reminders { get; set; }\n        public DbSet<Note> Notes { get; set; }\n        public DbSet<LeadTimeline> LeadTimelines { get; set; }\n        public DbSet<ContactTag> ContactTags { get; set; }\n        public DbSet<Campaign> Campaigns { get; set; }\n        public DbSet<CampaignRecipient> CampaignRecipients { get; set; }\n        public DbSet<CampaignSendLog> CampaignSendLogs { get; set; }\n        public DbSet<MessageStatusLog> MessageStatusLogs { get; set; }\n\n        // ðŸ§© Access Control\n        public DbSet<Role> Roles { get; set; }\n        public DbSet<Permission> Permissions { get; set; }\n        public DbSet<RolePermission> RolePermissions { get; set; }\n        public DbSet<UserPermission> UserPermissions { get; set; }\n        public DbSet<AuditLog> AuditLogs { get; set; }\n        public DbSet<WhatsAppSettingEntity> WhatsAppSettings { get; set; }\n        public DbSet<BusinessPlanInfo> BusinessPlanInfos { get; set; }\n        public DbSet<TrackingLog> TrackingLogs { get; set; }\n        public DbSet<CTADefinition> CTADefinitions { get; set; }\n        public DbSet<CampaignButton> CampaignButtons { get; set; }\n        public DbSet<FailedWebhookLog> FailedWebhookLogs { get; set; }\n        public DbSet<WebhookSettings> WebhookSettings { get; set; }\n        public DbSet<CTAFlowConfig> CTAFlowConfigs { get; set; }\n        public DbSet<CTAFlowStep> CTAFlowSteps { get; set; }\n        public DbSet<FlowButtonLink> FlowButtonLinks { get; set; }\n\n        public DbSet<CampaignFlowOverride> CampaignFlowOverrides { get; set; }\n        public DbSet<FlowExecutionLog> FlowExecutionLogs { get; set; }\n        public DbSet<ContactRead> ContactReads { get; set; }\n       \n        public DbSet<AutoReplyFlow> AutoReplyFlows { get; set; } = null!;\n        public DbSet<AutoReplyFlowNode> AutoReplyNodes { get; set; } = null!;\n        // Back-compat alias until older code is removed\n        public DbSet<AutoReplyFlowNode> AutoReplyFlowNodes { get; set; } = null!;\n        public DbSet<AutoReplyFlowEdge> AutoReplyFlowEdges { get; set; }\n        public DbSet<AutoReplyLog> AutoReplyLogs { get; set; }\n        public DbSet<ChatSessionState> ChatSessionStates { get; set; }\n        public DbSet<Plan> Plans { get; set; }\n        public DbSet<PlanPermission> PlanPermissions { get; set; }\n\n        public DbSet<PlanFeatureMatrix> PlanFeatureMatrix { get; set; }\n\n\n        public DbSet<AutomationFlow> AutomationFlows { get; set; }\n        public DbSet<WhatsAppTemplate> WhatsAppTemplates { get; set; }\n        public DbSet<CampaignClickLog> CampaignClickLogs => Set<CampaignClickLog>();\n        public DbSet<CampaignClickDailyAgg> CampaignClickDailyAgg => Set<CampaignClickDailyAgg>();\n        public DbSet<QuickReply> QuickReplies { get; set; } = null!;\n        public DbSet<WhatsAppPhoneNumber> WhatsAppPhoneNumbers { get; set; }\n        public DbSet<Audience> Audiences { get; set; }\n        public DbSet<AudienceMember> AudienceMembers { get; set; }\n        public DbSet<CsvBatch> CsvBatches { get; set; }\n        public DbSet<CsvRow> CsvRows { get; set; }\n        public DbSet<CampaignVariableMap> CampaignVariableMaps { get; set; }\n        public DbSet<ProviderBillingEvent> ProviderBillingEvents { get; set; } = default!;\n        public DbSet<OutboundCampaignJob> OutboundCampaignJobs { get; set; }\n        public DbSet<ApiKey> ApiKeys { get; set; } = null!;\n        public DbSet<CustomerWebhookConfig> CustomerWebhookConfigs { get; set; }\n        public DbSet<ContactJourneyState> ContactJourneyStates { get; set; }\n        public DbSet<OutboundMessageJob> OutboundMessageJobs { get; set; }\n\n        // Template Creation\n        public DbSet<TemplateDraft> TemplateDrafts { get; set; } = default!;\n        public DbSet<TemplateDraftVariant> TemplateDraftVariants { get; set; } = default!;\n        public DbSet<TemplateLibraryItem> TemplateLibraryItems { get; set; } = default!;\n        public DbSet<TemplateLibraryVariant> TemplateLibraryVariants { get; set; } = default!;\n\n        // ESU\n        public DbSet<IntegrationFlags> IntegrationFlags { get; set; } = null!;\n        public DbSet<EsuToken> EsuTokens { get; set; }\n\n        public DbSet<AccountInsightsAction> AccountInsightsActions { get; set; }\n\n\n\n        // Payment module\n        public DbSet<Subscription> Subscriptions { get; set; }\n        public DbSet<PaymentTransaction> PaymentTransactions { get; set; }\n        public DbSet<Invoice> Invoices { get; set; }\n        public DbSet<InvoiceLineItem> InvoiceLineItems { get; set; }\n        public DbSet<Coupon> Coupons { get; set; }\n\n        // Quota\n        public DbSet<PlanQuota> PlanQuotas => Set<PlanQuota>();\n        public DbSet<BusinessQuotaOverride> BusinessQuotaOverrides => Set<BusinessQuotaOverride>();\n        public DbSet<BusinessUsageCounter> BusinessUsageCounters => Set<BusinessUsageCounter>();\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\n        {\n            base.OnModelCreating(modelBuilder);\n\n            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DETERMINISTIC SEED TIMESTAMPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n            var seedCreatedAt = new DateTime(2025, 1, 1, 0, 0, 0, DateTimeKind.Utc);\n            var planCreatedAt = new DateTime(2025, 1, 1, 0, 0, 0, DateTimeKind.Utc);\n            var created = new DateTime(2025, 9, 13, 0, 0, 0, DateTimeKind.Utc);\n\n            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SEEDS (unchanged GUIDs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n            var superadminRoleId = Guid.Parse(\"00000000-0000-0000-0000-000000000001\");\n            var partnerRoleId = Guid.Parse(\"00000000-0000-0000-0000-000000000002\");\n            var resellerRoleId = Guid.Parse(\"00000000-0000-0000-0000-000000000003\");\n            var businessRoleId = Guid.Parse(\"00000000-0000-0000-0000-000000000004\");\n            var agentRoleId = Guid.Parse(\"00000000-0000-0000-0000-000000000005\");\n\n            modelBuilder.Entity<Role>().HasData(\n                new Role { Id = superadminRoleId, Name = \"admin\", Description = \"Super Admin\", CreatedAt = seedCreatedAt },\n                new Role { Id = partnerRoleId, Name = \"partner\", Description = \"Business Partner\", CreatedAt = seedCreatedAt },\n                new Role { Id = resellerRoleId, Name = \"reseller\", Description = \"Reseller Partner\", CreatedAt = seedCreatedAt },\n                new Role { Id = businessRoleId, Name = \"business\", Description = \"Business Owner\", CreatedAt = seedCreatedAt },\n                new Role { Id = agentRoleId, Name = \"staff\", Description = \"Staff\", CreatedAt = seedCreatedAt }\n            );\n\n            var superAdminUserId = Guid.Parse(\"62858aa2-3a54-4fd5-8696-c343d9af7634\");\n            modelBuilder.Entity<User>().HasData(new User\n            {\n                Id = superAdminUserId,\n                Name = \"Super Admin\",\n                Email = \"admin@xbytechat.com\",\n                RoleId = superadminRoleId,\n                Status = \"active\",\n                CreatedAt = seedCreatedAt,\n                DeletedAt = null,\n                IsDeleted = false,\n                BusinessId = null,\n                PasswordHash = \"JAvlGPq9JyTdtvBO6x2llnRI1+gxwIyPqCKAn3THIKk=\",\n                RefreshToken = null,\n                RefreshTokenExpiry = null\n            });\n\n            var basicPlanId = Guid.Parse(\"5f9f5de1-a0b2-48ba-b03d-77b27345613f\");\n            \n            modelBuilder.Entity<Plan>().HasData(new Plan\n            {\n                Id = basicPlanId,\n                Code = \"SYSTEM_DEFAULT\",\n                Name = \"System Default\",\n                Description = \"Default free plan\",\n                IsActive = true,\n                IsInternal = true,\n                CreatedAt = planCreatedAt\n            });\n\n            modelBuilder.Entity<Permission>().HasData(\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000000\"), Code = \"dashboard.view\", Name = \"dashboard.view\", Group = \"Dashboard\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000001\"), Code = \"campaign.view\", Name = \"campaign.view\", Group = \"Campaign\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000002\"), Code = \"campaign.create\", Name = \"campaign.create\", Group = \"Campaign\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000003\"), Code = \"campaign.delete\", Name = \"campaign.delete\", Group = \"Campaign\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000004\"), Code = \"product.view\", Name = \"product.view\", Group = \"Catalog\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000005\"), Code = \"product.create\", Name = \"product.create\", Group = \"Catalog\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000006\"), Code = \"product.delete\", Name = \"product.delete\", Group = \"Catalog\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000007\"), Code = \"contacts.view\", Name = \"contacts.view\", Group = \"CRM\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000008\"), Code = \"tags.edit\", Name = \"tags.edit\", Group = null, IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000009\"), Code = \"admin.business.approve\", Name = \"admin.business.approve\", Group = \"Admin\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000010\"), Code = \"admin.logs.view\", Name = \"admin.logs.view\", Group = null, IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000011\"), Code = \"admin.plans.view\", Name = \"admin.plans.view\", Group = \"Admin\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000012\"), Code = \"admin.plans.create\", Name = \"admin.plans.create\", Group = \"Admin\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000013\"), Code = \"admin.plans.update\", Name = \"admin.plans.update\", Group = \"Admin\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"30000000-0000-0000-0000-000000000014\"), Code = \"admin.plans.delete\", Name = \"admin.plans.delete\", Group = \"Admin\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"74c8034f-d9cb-4a17-8578-a9f765bd845c\"), Code = \"messaging.report.view\", Name = \"messaging.report.view\", Group = \"Messaging\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"c819f1bd-422d-4609-916c-cc185fe44ab0\"), Code = \"messaging.status.view\", Name = \"messaging.status.view\", Group = \"Messaging\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"eecd0fac-223c-4dba-9fa1-2a6e973d61d1\"), Code = \"messaging.inbox.view\", Name = \"messaging.inbox.view\", Group = \"Messaging\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"974af1f9-3caa-4857-a1a7-48462c389332\"), Code = \"messaging.send.text\", Name = \"messaging.send.text\", Group = \"Messaging\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"0485154c-dde5-4732-a7aa-a379c77a5b27\"), Code = \"messaging.send.template\", Name = \"messaging.send.template\", Group = \"Messaging\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"29461562-ef9c-48c0-a606-482ff57b8f95\"), Code = \"messaging.send\", Name = \"messaging.send\", Group = \"Messaging\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"bbc5202a-eac9-40bb-aa78-176c677dbf5b\"), Code = \"messaging.whatsappsettings.view\", Name = \"messaging.whatsappsettings.view\", Group = \"Messaging\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"205b87c7-b008-4e51-9fea-798c2dc4f9c2\"), Code = \"admin.whatsappsettings.view\", Name = \"admin.whatsappsettings.view\", Group = \"Admin\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"6e4d3a86-7cf9-4ac2-b8a7-ed10c9f0173d\"), Code = \"settings.whatsapp.view\", Name = \"Settings - WhatsApp View\", Group = \"Settings\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"ad36cdb7-5221-448b-a6a6-c35c9f88d021\"), Code = \"inbox.view\", Name = \"inbox.view\", Group = \"Inbox\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"74828fc0-e358-4cfc-b924-13719a0d9f50\"), Code = \"inbox.menu\", Name = \"inbox.menu\", Group = \"Inbox\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"98572fe7-d142-475a-b990-f248641809e2\"), Code = \"settings.profile.view\", Name = \"settings.profile.view\", Group = \"Settings\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"821480c6-1464-415e-bba8-066fcb4e7e63\"), Code = \"automation.menu\", Name = \"automation.menu\", Group = \"Automation\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"918a61d0-5ab6-46af-a3d3-41e37b7710f9\"), Code = \"automation.Create.Template.Flow\", Name = \"automation.Create.Template.Flow\", Group = \"Automation\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"9ae90cfe-3fea-4307-b024-3083c2728148\"), Code = \"automation.View.Template.Flow\", Name = \"automation.View.Template.Flow\", Group = \"Automation\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"93c5d5a7-f8dd-460a-8c7b-e3788440ba3a\"), Code = \"automation.Create.TemplatePlusFreetext.Flow\", Name = \"automation.Create.TemplatePlusFreetext.Flow\", Group = \"Automation\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"7d7cbceb-4ce7-4835-85cd-59562487298d\"), Code = \"automation.View.TemplatePlusFreetext.Flow\", Name = \"automation.View.TemplatePlusFreetext.Flow\", Group = \"Automation\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"636b17f2-1c54-4e26-a8cd-dbf561dcb522\"), Code = \"automation.View.Template.Flow_analytics\", Name = \"automation.View.Template.Flow_analytics\", Group = \"Automation\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"adfa8490-9705-4a36-a86e-d5bff7ddc220\"), Code = \"automation.View.TemplatePlusFreeText.Flow_analytics\", Name = \"automation.View.TemplatePlusFreeText.Flow_analytics\", Group = \"Automation\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"0dedac5b-81c8-44c3-8cfe-76c58e29c6db\"), Code = \"automation_trigger_test\", Name = \"automation_trigger_test\", Group = \"Automation\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"14ef7f9d-0975-4ab4-b6f1-7d1af8b594ca\"), Code = \"template.builder.view\", Name = \"View Template Builder\", Group = \"TemplateBuilder\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"03eabd97-b196-4603-bbdd-1b2cdd595ead\"), Code = \"template.builder.create.draft\", Name = \"Draft Creation\", Group = \"TemplateBuilder\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"d272be50-ff26-45cf-bd7a-e9db74813699\"), Code = \"template.builder.approved.templates.view\", Name = \"View Approved Template\", Group = \"TemplateBuilder\", IsActive = true, CreatedAt = created },\n                new Permission { Id = Guid.Parse(\"3602f49d-dc10-4faa-9a44-4185a669ea0a\"), Code = \"template.builder.library.browse\", Name = \"View Template Library\", Group = \"TemplateBuilder\", IsActive = true, CreatedAt = created }\n                );\n\n            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Relationships (clean and deduped) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n            // Access-control\n            modelBuilder.Entity<RolePermission>()\n                .HasOne(rp => rp.Role).WithMany(r => r.RolePermissions)\n                .HasForeignKey(rp => rp.RoleId).OnDelete(DeleteBehavior.Cascade);\n\n            modelBuilder.Entity<RolePermission>()\n                .HasOne(rp => rp.Permission).WithMany(p => p.RolePermissions)\n                .HasForeignKey(rp => rp.PermissionId).OnDelete(DeleteBehavior.Cascade);\n\n            modelBuilder.Entity<UserPermission>()\n                .HasOne(up => up.User).WithMany(u => u.UserPermissions)\n                .HasForeignKey(up => up.UserId).OnDelete(DeleteBehavior.Cascade);\n\n            modelBuilder.Entity<UserPermission>()\n                .HasOne(up => up.Permission).WithMany(p => p.UserPermissions)\n                .HasForeignKey(up => up.PermissionId).OnDelete(DeleteBehavior.Cascade);\n\n            // ðŸ”’ Join-table uniqueness (prevents duplicates)\n            modelBuilder.Entity<RolePermission>()\n                .HasIndex(x => new { x.RoleId, x.PermissionId })\n                .IsUnique()\n                .HasDatabaseName(\"UX_RolePermissions_Role_Permission\");\n\n            modelBuilder.Entity<PlanPermission>()\n                .HasIndex(x => new { x.PlanId, x.PermissionId })\n                .IsUnique()\n                .HasDatabaseName(\"UX_PlanPermissions_Plan_Permission\");\n\n            modelBuilder.Entity<PlanPermission>(e =>\n            {\n                // Fast lookups\n                e.HasIndex(x => x.PlanId);\n                e.HasIndex(x => x.PermissionId);\n\n                // One row per (Plan, Permission)\n                e.HasIndex(x => new { x.PlanId, x.PermissionId }).IsUnique();\n            });\n            // Campaign core\n            modelBuilder.Entity<Campaign>()\n                .HasOne(c => c.Business).WithMany(b => b.Campaigns)\n                .HasForeignKey(c => c.BusinessId).IsRequired();\n\n            modelBuilder.Entity<Campaign>()\n                .HasMany(c => c.MultiButtons).WithOne(b => b.Campaign)\n                .HasForeignKey(b => b.CampaignId).OnDelete(DeleteBehavior.Cascade);\n\n            modelBuilder.Entity<Campaign>(e =>\n            {\n                e.Property(x => x.TemplateSchemaSnapshot).HasColumnType(\"jsonb\");\n\n                // ðŸ” MATCHES PATCH: Campaign â†’ Audiences CASCADE\n                e.HasMany(c => c.Audiences).WithOne(a => a.Campaign)\n                 .HasForeignKey(a => a.CampaignId).OnDelete(DeleteBehavior.Cascade);\n\n                // already cascade\n                e.HasMany(c => c.SendLogs).WithOne(s => s.Campaign)\n                 .HasForeignKey(s => s.CampaignId).OnDelete(DeleteBehavior.Cascade);\n\n                // ðŸ” MATCHES PATCH: Campaign â†’ MessageLogs CASCADE\n                e.HasMany(c => c.MessageLogs).WithOne(m => m.SourceCampaign)\n                 .HasForeignKey(m => m.CampaignId).OnDelete(DeleteBehavior.Cascade);\n            });\n\n\n            // Audience / CSV\n            modelBuilder.Entity<CsvBatch>(e =>\n            {\n                e.ToTable(\"CsvBatches\");\n                e.HasKey(x => x.Id);\n                e.Property(x => x.HeadersJson).HasColumnType(\"jsonb\");\n                e.HasIndex(x => x.Checksum).HasDatabaseName(\"ix_csvbatch_checksum\");\n                e.HasIndex(x => new { x.BusinessId, x.CreatedAt }).HasDatabaseName(\"ix_csvbatch_biz_created\");\n                e.HasIndex(x => new { x.BusinessId, x.AudienceId });\n                e.HasOne<Audience>().WithMany()\n                 .HasForeignKey(x => x.AudienceId).OnDelete(DeleteBehavior.SetNull);\n            });\n\n            modelBuilder.Entity<CsvRow>(e =>\n            {\n                e.ToTable(\"CsvRows\");\n                e.HasKey(x => x.Id);\n                e.Property(x => x.RowJson).HasColumnType(\"jsonb\");\n                e.HasIndex(x => new { x.BatchId, x.RowIndex }).IsUnique().HasDatabaseName(\"ux_csvrow_batch_rowidx\");\n                e.HasIndex(x => x.PhoneE164).HasDatabaseName(\"ix_csvrow_phone\");\n                e.HasIndex(x => new { x.BusinessId, x.BatchId });\n                e.HasOne(x => x.Batch).WithMany().HasForeignKey(x => x.BatchId).OnDelete(DeleteBehavior.Cascade);\n            });\n\n            modelBuilder.Entity<Audience>(e =>\n            {\n                e.ToTable(\"Audiences\");\n                e.HasKey(x => x.Id);\n                e.HasIndex(x => new { x.BusinessId, x.IsDeleted }).HasDatabaseName(\"ix_audiences_biz_deleted\");\n                e.HasIndex(x => new { x.BusinessId, x.CampaignId });\n                e.HasIndex(x => new { x.BusinessId, x.CsvBatchId });\n                e.HasOne(x => x.CsvBatch).WithMany().HasForeignKey(x => x.CsvBatchId).OnDelete(DeleteBehavior.SetNull);\n            });\n\n            modelBuilder.Entity<AudienceMember>(e =>\n            {\n                e.ToTable(\"AudienceMembers\");\n                e.HasKey(x => x.Id);\n                e.Property(x => x.AttributesJson).HasColumnType(\"jsonb\");\n                e.HasIndex(x => new { x.AudienceId, x.PhoneE164 }).IsUnique().HasDatabaseName(\"ux_audmember_audience_phone\");\n                e.HasIndex(x => x.ContactId).HasDatabaseName(\"ix_audmember_contact\");\n                e.HasOne(x => x.Audience).WithMany(a => a.Members)\n                 .HasForeignKey(x => x.AudienceId).OnDelete(DeleteBehavior.Cascade);\n            });\n\n            // Recipients â€” OPTIONAL AudienceMember, OPTIONAL Contact\n            modelBuilder.Entity<CampaignRecipient>(e =>\n            {\n                e.ToTable(\"CampaignRecipients\");\n                e.HasKey(x => x.Id);\n\n                e.Property(x => x.ResolvedParametersJson).HasColumnType(\"jsonb\");\n                e.Property(x => x.ResolvedButtonUrlsJson).HasColumnType(\"jsonb\");\n                e.HasIndex(x => x.IdempotencyKey).HasDatabaseName(\"ix_campaignrecipients_idempotency\");\n                e.HasIndex(x => new { x.CampaignId, x.ContactId }).HasDatabaseName(\"ix_recipients_campaign_contact\");\n\n                e.HasOne(r => r.AudienceMember)\n                 .WithMany()\n                 .HasForeignKey(r => r.AudienceMemberId)\n                 .IsRequired(false)\n                 .OnDelete(DeleteBehavior.SetNull);\n\n                e.HasOne(r => r.Contact)\n                 .WithMany()\n                 .HasForeignKey(r => r.ContactId)\n                 .IsRequired(false)\n                 .OnDelete(DeleteBehavior.SetNull);\n\n                e.HasOne(r => r.Campaign)\n                 .WithMany(c => c.Recipients)\n                 .HasForeignKey(r => r.CampaignId)\n                 .OnDelete(DeleteBehavior.Cascade);\n\n                e.HasOne(r => r.Business)\n                 .WithMany()\n                 .HasForeignKey(r => r.BusinessId)\n                 .OnDelete(DeleteBehavior.Restrict);\n            });\n\n            // Send logs â€” OPTIONAL Contact, REQUIRED Campaign\n            modelBuilder.Entity<CampaignSendLog>(e =>\n            {\n                e.ToTable(\"CampaignSendLogs\");\n                e.HasKey(x => x.Id);\n\n                e.Property(x => x.BusinessId).IsRequired();\n                e.HasIndex(x => x.MessageId);\n                e.HasIndex(x => x.RunId);\n                e.HasIndex(x => new { x.BusinessId, x.MessageId }).HasDatabaseName(\"IX_CampaignSendLogs_Business_MessageId\");\n\n                e.HasOne(s => s.Recipient).WithMany(r => r.SendLogs)\n                 .HasForeignKey(s => s.RecipientId);\n\n                // âœ… allow null ContactId (fixes 23502 once column is nullable)\n                e.HasOne(s => s.Contact).WithMany()\n                 .HasForeignKey(s => s.ContactId)\n                 .IsRequired(false)\n                 .OnDelete(DeleteBehavior.SetNull);\n\n                e.HasOne(s => s.Campaign).WithMany(c => c.SendLogs)\n                 .HasForeignKey(s => s.CampaignId)\n                 .IsRequired()\n                 .OnDelete(DeleteBehavior.Cascade);\n\n                e.HasOne(s => s.MessageLog).WithMany()\n                 .HasForeignKey(s => s.MessageLogId)\n                 .OnDelete(DeleteBehavior.Restrict);\n            });\n\n            // Message logs â€” helpful indexes + computed column\n            modelBuilder.Entity<MessageLog>(b =>\n            {\n                b.HasIndex(x => x.MessageId);\n                b.HasIndex(x => x.RunId);\n                b.HasIndex(x => new { x.BusinessId, x.MessageId }).HasDatabaseName(\"IX_MessageLogs_Business_MessageId\");\n                b.HasIndex(x => new { x.BusinessId, x.RecipientNumber }).HasDatabaseName(\"IX_MessageLogs_Business_Recipient\");\n                b.Property<DateTime?>(\"MessageTime\").HasComputedColumnSql(\"COALESCE(\\\"SentAt\\\", \\\"CreatedAt\\\")\", stored: true);\n                b.HasIndex(\"BusinessId\", \"IsIncoming\", \"ContactId\", \"MessageTime\").HasDatabaseName(\"ix_msglogs_biz_in_contact_msgtime\");\n            });\n\n            // QuickReplies\n            modelBuilder.Entity<QuickReply>(e =>\n            {\n                e.HasIndex(x => new { x.BusinessId, x.Scope, x.IsActive });\n                e.HasIndex(x => new { x.BusinessId, x.OwnerUserId, x.IsActive });\n                e.HasIndex(x => x.UpdatedAt);\n                e.Property(x => x.Title).HasMaxLength(120).IsRequired();\n                e.Property(x => x.Language).HasMaxLength(8);\n                e.Property(q => q.UpdatedAt).HasDefaultValueSql(\"NOW()\");\n            });\n\n            // Contacts â€” uniqueness\n            modelBuilder.Entity<Contact>()\n                .HasIndex(c => new { c.BusinessId, c.PhoneNumber }).IsUnique();\n\n            modelBuilder.Entity<ContactRead>()\n                .HasIndex(cr => new { cr.ContactId, cr.UserId }).IsUnique();\n\n            modelBuilder.Entity<ContactRead>()\n                .HasIndex(cr => new { cr.BusinessId, cr.UserId, cr.ContactId })\n                .IsUnique().HasDatabaseName(\"ux_contactreads_biz_user_contact\");\n\n            // WhatsApp settings (principal with composite AK)\n            modelBuilder.Entity<WhatsAppSettingEntity>(b =>\n            {\n                b.ToTable(\"WhatsAppSettings\");\n                b.HasAlternateKey(s => new { s.BusinessId, s.Provider })\n                 .HasName(\"AK_WhatsAppSettings_BusinessId_Provider\");\n\n                b.HasIndex(x => new { x.Provider, x.WabaId }).HasDatabaseName(\"IX_WhatsAppSettings_Provider_WabaId\");\n                b.HasIndex(x => new { x.BusinessId, x.Provider, x.IsActive }).HasDatabaseName(\"IX_WhatsAppSettings_Business_Provider_IsActive\");\n                b.HasIndex(x => new { x.Provider, x.WebhookCallbackUrl }).HasDatabaseName(\"IX_WhatsAppSettings_Provider_CallbackUrl\");\n            });\n\n            modelBuilder.Entity<Business>()\n                .HasMany(b => b.WhatsAppSettings).WithOne()\n                .HasForeignKey(s => s.BusinessId).OnDelete(DeleteBehavior.Cascade);\n\n            modelBuilder.Entity<WhatsAppPhoneNumber>(e =>\n            {\n                e.ToTable(\"WhatsAppPhoneNumbers\");\n                e.HasKey(x => x.Id);\n                e.Property(x => x.Provider).IsRequired();\n                e.Property(x => x.PhoneNumberId).IsRequired();\n\n                e.HasOne<WhatsAppSettingEntity>()\n                 .WithMany(s => s.WhatsAppBusinessNumbers)\n                 .HasForeignKey(x => new { x.BusinessId, x.Provider })\n                 .HasPrincipalKey(s => new { s.BusinessId, s.Provider })\n                 .OnDelete(DeleteBehavior.Cascade);\n\n                // âœ… keep this UNIQUE index\n                e.HasIndex(x => new { x.BusinessId, x.Provider, x.PhoneNumberId })\n                 .IsUnique()\n                 .HasDatabaseName(\"UX_WhatsappPhoneNumbers_Bus_Prov_PhoneId\");\n            });\n\n            // CTA / Tracking misc\n            modelBuilder.Entity<CampaignClickLog>(e =>\n            {\n                e.HasIndex(x => new { x.CampaignId, x.ClickType, x.ClickedAt });\n                e.HasIndex(x => new { x.CampaignId, x.ButtonIndex });\n                e.HasIndex(x => new { x.CampaignId, x.ContactId });\n            });\n\n            modelBuilder.Entity<CampaignClickDailyAgg>(e =>\n            {\n                e.HasIndex(x => new { x.CampaignId, x.Day, x.ButtonIndex }).IsUnique();\n                e.Property(x => x.Day).HasColumnType(\"date\");\n            });\n\n            // Flow graph bits\n            modelBuilder.Entity<FlowButtonLink>().HasKey(b => b.Id);\n\n            // Auto-reply flows & nodes (CRUD storage for builder)\n            modelBuilder.Entity<AutoReplyFlow>(entity =>\n            {\n                entity.HasKey(f => f.Id);\n                entity.HasIndex(f => new { f.BusinessId, f.Name });\n\n                entity.HasMany<AutoReplyFlowNode>()\n                      .WithOne(n => n.Flow)\n                      .HasForeignKey(n => n.FlowId)\n                      .OnDelete(DeleteBehavior.Cascade);\n            });\n\n            modelBuilder.Entity<AutoReplyFlowNode>(entity =>\n            {\n                entity.HasKey(n => n.Id);\n                entity.HasIndex(n => new { n.FlowId, n.NodeName });\n\n                // keep coordinates as an owned type\n                entity.OwnsOne(n => n.Position);\n            });\n\n            // Features/Plans\n      \n            // Outbound worker\n            modelBuilder.Entity<OutboundCampaignJob>(e =>\n            {\n                e.ToTable(\"OutboundCampaignJobs\");\n                e.HasIndex(x => new { x.Status, x.NextAttemptAt });\n                e.HasIndex(x => x.CampaignId);\n                e.Property(x => x.Status).HasMaxLength(32);\n                e.Property(x => x.LastError).HasMaxLength(4000);\n            });\n\n            modelBuilder.Entity<Campaign>()\n                 .HasOne(c => c.CTAFlowConfig)      // âœ… use the nav that exists on Campaign\n                 .WithMany()\n                 .HasForeignKey(c => c.CTAFlowConfigId)\n                 .OnDelete(DeleteBehavior.Restrict);\n\n            modelBuilder.Entity<CTAFlowConfig>(e =>\n            {\n                e.HasMany(f => f.Steps)\n                 .WithOne(s => s.Flow)\n                 .HasForeignKey(s => s.CTAFlowConfigId)\n                 .OnDelete(DeleteBehavior.Cascade);\n            });\n\n            // keep only this one:\n            modelBuilder.Entity<CTAFlowConfig>()\n                .HasIndex(f => new { f.BusinessId, f.FlowName, f.IsActive })\n                .IsUnique();\n\n            modelBuilder.Entity<CTAFlowStep>(e =>\n            {\n                e.HasMany(s => s.ButtonLinks)\n                 .WithOne(b => b.Step)                 // only if FlowButtonLink has a 'Step' nav\n                 .HasForeignKey(b => b.CTAFlowStepId)  // âœ… use existing FK name\n                 .OnDelete(DeleteBehavior.Cascade);\n            });\n\n            // Flow execution logs â†’ delete with their Flow\n            //modelBuilder.Entity<FlowExecutionLog>(e =>\n            //{\n            //    e.ToTable(\"FlowExecutionLogs\");\n            //    e.HasKey(x => x.Id);\n            //    e.HasIndex(x => x.FlowId).HasDatabaseName(\"IX_FlowExecutionLogs_FlowId\");\n\n            //    // Critical: tie logs to Flow and cascade on delete\n            //    e.HasOne<CTAFlowConfig>()\n            //     .WithMany()                            // no collection needed\n            //     .HasForeignKey(x => x.FlowId)\n            //     .OnDelete(DeleteBehavior.Cascade);\n\n            //});\n            // Flow execution logs â†’ delete with their Flow\n            modelBuilder.Entity<FlowExecutionLog>(e =>\n            {\n                e.ToTable(\"FlowExecutionLogs\");\n                e.HasKey(x => x.Id);\n\n                // existing / kept index\n                e.HasIndex(x => x.FlowId)\n                 .HasDatabaseName(\"IX_FlowExecutionLogs_FlowId\");\n\n                // ðŸ” time-based analytics per business\n                e.HasIndex(x => new { x.BusinessId, x.ExecutedAt })\n                 .HasDatabaseName(\"ix_flowexec_biz_executedat\");\n\n                // ðŸ” campaign-origin segmentation\n                e.HasIndex(x => new { x.BusinessId, x.Origin, x.CampaignId })\n                 .HasDatabaseName(\"ix_flowexec_biz_origin_campaign\");\n\n                // ðŸ” autoreply-origin segmentation\n                e.HasIndex(x => new { x.BusinessId, x.Origin, x.AutoReplyFlowId })\n                 .HasDatabaseName(\"ix_flowexec_biz_origin_autoreply\");\n\n                // tie logs to Flow and cascade on delete\n                e.HasOne<CTAFlowConfig>()\n                 .WithMany()\n                 .HasForeignKey(x => x.FlowId)\n                 .OnDelete(DeleteBehavior.Cascade);\n            });\n\n            // ----- ProviderBillingEvents (core for billing dedupe + reads) -----\n            modelBuilder.Entity<ProviderBillingEvent>(e =>\n            {\n                // Hard dedupe (webhook replays, same message/event). Filter keeps NULLs out of the unique constraint.\n                e.HasIndex(x => new { x.BusinessId, x.Provider, x.ProviderMessageId, x.EventType })\n                 .HasDatabaseName(\"UX_ProviderBillingEvents_UniqueEvent\")\n                 .IsUnique()\n                 .HasFilter(\"\\\"ProviderMessageId\\\" IS NOT NULL\");\n\n                // Time-range scans by event type (used by snapshot)\n                e.HasIndex(x => new { x.BusinessId, x.EventType, x.OccurredAt })\n                 .HasDatabaseName(\"IX_Billing_BizEventTime\");\n\n                // Group/lookup by conversation window\n                e.HasIndex(x => new { x.BusinessId, x.ConversationId })\n                 .HasDatabaseName(\"IX_Billing_BizConversation\")\n                 .HasFilter(\"\\\"ConversationId\\\" IS NOT NULL\");\n\n                // Direct lookups by provider message id\n                e.HasIndex(x => new { x.BusinessId, x.ProviderMessageId })\n                 .HasDatabaseName(\"IX_Billing_BizProviderMessage\")\n                 .HasFilter(\"\\\"ProviderMessageId\\\" IS NOT NULL\");\n            });\n\n            // ----- MessageLogs (snapshot volume + joins from billing) -----\n            modelBuilder.Entity<MessageLog>(e =>\n            {\n                // Period queries\n                e.HasIndex(x => new { x.BusinessId, x.CreatedAt })\n                 .HasDatabaseName(\"IX_MessageLogs_BizCreatedAt\");\n\n                // Join from billing by provider message id\n                e.HasIndex(x => new { x.BusinessId, x.ProviderMessageId })\n                 .HasDatabaseName(\"IX_MessageLogs_BizProviderMessage\")\n                 .HasFilter(\"\\\"ProviderMessageId\\\" IS NOT NULL\");\n\n                // Conversation aggregation / backfills\n                e.HasIndex(x => new { x.BusinessId, x.ConversationId })\n                 .HasDatabaseName(\"IX_MessageLogs_BizConversation\")\n                 .HasFilter(\"\\\"ConversationId\\\" IS NOT NULL\");\n            });\n\n            // ----- CampaignSendLogs (status updater lookups) -----\n            modelBuilder.Entity<CampaignSendLog>(e =>\n            {\n                e.HasIndex(x => new { x.BusinessId, x.SendStatus, x.SentAt })\n                 .HasDatabaseName(\"IX_CampaignSendLogs_StatusTime\");\n            });\n\n            // ----- Optional: provider config lookups used during send/status -----\n\n            modelBuilder.Entity<xbytechat.api.Features.CustomeApi.Models.ApiKey>(e =>\n            {\n                e.HasKey(x => x.Id);\n                e.HasIndex(x => x.Prefix).IsUnique();\n                e.Property(x => x.SecretHash).IsRequired();\n                e.Property(x => x.Scopes).HasMaxLength(512);\n            });\n\n            //modelBuilder.Entity<MessageStatusLog>()\n            //    .HasOne<Campaign>()                       // (no nav on MessageStatusLog needed)\n            //    .WithMany(c => c.MessageStatusLogs)       // uses Campaign.MessageStatusLogs collection\n            //    .HasForeignKey(ms => ms.CampaignId)\n            //    .OnDelete(DeleteBehavior.Cascade);\n            modelBuilder.Entity<MessageStatusLog>(e =>\n            {\n                e.HasKey(x => x.Id);\n\n                e.HasOne(ms => ms.Campaign)          // âœ… use nav\n                 .WithMany(c => c.MessageStatusLogs) // or .WithMany() if Campaign doesn't expose the collection\n                 .HasForeignKey(ms => ms.CampaignId)\n                 .OnDelete(DeleteBehavior.Cascade);\n            });\n            // FK indexes used by hard delete / reads\n            modelBuilder.Entity<CampaignSendLog>()\n                .HasIndex(x => x.CampaignId)\n                .HasDatabaseName(\"IX_CampaignSendLogs_Campaign\");\n\n            modelBuilder.Entity<MessageLog>()\n                .HasIndex(x => x.CampaignId)\n                .HasDatabaseName(\"IX_MessageLogs_Campaign\");\n\n            modelBuilder.Entity<MessageLog>()\n                .HasIndex(x => x.ProviderMessageId)\n                .HasDatabaseName(\"IX_MessageLogs_ProviderMessageId\")\n                .HasFilter(\"\\\"ProviderMessageId\\\" IS NOT NULL\");\n\n            modelBuilder.Entity<TrackingLog>(e =>\n            {\n                e.HasKey(x => x.Id);\n\n                // indexes (keep)\n                e.HasIndex(x => x.CampaignId).HasDatabaseName(\"IX_TrackingLogs_Campaign\");\n                e.HasIndex(x => x.MessageLogId).HasDatabaseName(\"IX_TrackingLogs_MessageLog\");\n                e.HasIndex(x => x.CampaignSendLogId).HasDatabaseName(\"IX_TrackingLogs_SendLog\");\n\n                // âœ… use navs defined on the POCO\n                e.HasOne(t => t.Campaign)\n                 .WithMany()\n                 .HasForeignKey(t => t.CampaignId)\n                 .IsRequired(false)\n                 .OnDelete(DeleteBehavior.Restrict);\n\n                e.HasOne(t => t.MessageLog)\n                 .WithMany()\n                 .HasForeignKey(t => t.MessageLogId)\n                 .IsRequired(false)\n                 .OnDelete(DeleteBehavior.Restrict);\n\n                e.HasOne(t => t.CampaignSendLog)\n                 .WithMany()\n                 .HasForeignKey(t => t.CampaignSendLogId)\n                 .IsRequired(false)\n                 .OnDelete(DeleteBehavior.Restrict);\n            });\n\n            modelBuilder.Entity<OutboundMessageJob>(e =>\n            {\n                e.ToTable(\"OutboundMessageJobs\");\n\n                // Columns\n                e.Property(x => x.Status).HasMaxLength(24);\n                e.Property(x => x.LastError).HasMaxLength(4000);\n                e.Property(x => x.IdempotencyKey).HasMaxLength(1000)\n                .IsRequired(false);\n\n                // Helpful indexes\n                e.HasIndex(x => x.CampaignId);\n\n                e.HasIndex(x => new { x.BusinessId, x.IdempotencyKey })\n                 .IsUnique()\n                 .HasFilter(\"\\\"IdempotencyKey\\\" IS NOT NULL AND \\\"IdempotencyKey\\\" <> ''\")\n                 .HasDatabaseName(\"UX_Outbox_Biz_IdemKey\");\n\n                // ðŸ”¥ Hot-path for producer & reaper (keep this one; remove the 2-col variant)\n                e.HasIndex(x => new { x.Status, x.NextAttemptAt, x.CreatedAt })\n                 .HasDatabaseName(\"IX_Outbox_StatusDueCreated\");\n            });\n\n            modelBuilder.Entity<WhatsAppTemplate>(e =>\n            {\n                e.ToTable(\"WhatsAppTemplates\");\n\n                // â”€â”€ ðŸ” HARD DEDUPE: pick one of these keys (both are safe together) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n                // Prefer external TemplateId when present (provider's primary key)\n                e.HasIndex(x => new { x.BusinessId, x.Provider, x.TemplateId })\n                 .IsUnique()\n                 .HasFilter(@\"\"\"TemplateId\"\" IS NOT NULL\")\n                 .HasDatabaseName(\"UX_WAT_BizProvTemplateId\");\n\n                // Fallback uniqueness: Name + LanguageCode per provider per business\n                e.HasIndex(x => new { x.BusinessId, x.Provider, x.Name, x.LanguageCode })\n                 .IsUnique()\n                 .HasDatabaseName(\"UX_WAT_BizProvNameLang\");\n\n                // â”€â”€ ðŸ”Ž Your existing read-path indexes (kept) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n                // Core â€œlist for a businessâ€ scans (Used by List endpoint + internal dashboards)\n                // Filters: BusinessId, Provider?, IsActive; sort by UpdatedAt/LastSyncedAt\n                e.HasIndex(x => new { x.BusinessId, x.Provider, x.IsActive, x.UpdatedAt, x.LastSyncedAt })\n                 .HasDatabaseName(\"IX_WAT_Business_Provider_IsActive_Sort\")\n#if NET7_0_OR_GREATER\n                 .IsDescending(false, false, false, true, true) // DESC on UpdatedAt/LastSyncedAt where supported\n#endif\n                 ;\n\n                // When provider filter isnâ€™t present â€” still useful for a business-wide â€œactiveâ€ list\n                e.HasIndex(x => new { x.BusinessId, x.IsActive })\n                 .HasDatabaseName(\"IX_WAT_Business_IsActive\");\n\n                // Exact fetch by external TemplateId (preferred lookup when present)\n                e.HasIndex(x => new { x.BusinessId, x.Provider, x.TemplateId })\n                 .HasDatabaseName(\"IX_WAT_Business_Provider_TemplateId\")\n                 .HasFilter(@\"\"\"TemplateId\"\" IS NOT NULL\");\n\n                // Fallback fetch used by sync/GetOne: Name + LanguageCode for a given provider\n                e.HasIndex(x => new { x.BusinessId, x.Provider, x.Name, x.LanguageCode })\n                 .HasDatabaseName(\"IX_WAT_Business_Provider_Name_Lang\");\n\n                // List filters: Status + Language on active rows\n                e.HasIndex(x => new { x.BusinessId, x.Provider, x.Status, x.LanguageCode })\n                 .HasDatabaseName(\"IX_WAT_Business_Provider_Status_Lang_Active\")\n                 .HasFilter(@\"\"\"IsActive\"\" = TRUE\");\n\n                // TTL check in sync: ORDER BY LastSyncedAt DESC LIMIT 1 per business\n                e.HasIndex(x => new { x.BusinessId, x.LastSyncedAt })\n                 .HasDatabaseName(\"IX_WAT_Business_LastSyncedAt\")\n#if NET7_0_OR_GREATER\n                 .IsDescending(false, true) // DESC LastSyncedAt where supported\n#endif\n                 ;\n\n                // Helpful single-column lookups/sorts you do frequently\n                e.HasIndex(x => x.UpdatedAt).HasDatabaseName(\"IX_WAT_UpdatedAt\");\n                e.HasIndex(x => x.LastSyncedAt).HasDatabaseName(\"IX_WAT_LastSyncedAt\");\n\n                // NOTE: for q= search on Name/Body with Contains/ILIKE, add pg_trgm GIN via migration:\n                //   CREATE EXTENSION IF NOT EXISTS pg_trgm;\n                //   CREATE INDEX IX_WAT_trgm_lower_name ON \"WhatsAppTemplates\" USING GIN (lower(\"Name\") gin_trgm_ops);\n                //   CREATE INDEX IX_WAT_trgm_body        ON \"WhatsAppTemplates\" USING GIN (\"Body\" gin_trgm_ops);\n                // (done with migrationBuilder.Sql(...))\n            });\n            //TemplateDrafts\n            modelBuilder.Entity<TemplateDraft>(e =>\n            {\n                // ðŸ” One logical draft key per business\n                e.HasIndex(x => new { x.BusinessId, x.Key })\n                 .IsUnique()\n                 .HasDatabaseName(\"UX_TemplateDrafts_Biz_Key\");\n\n                // ðŸ”Ž Common scans\n                e.HasIndex(x => new { x.BusinessId, x.UpdatedAt })\n                 .HasDatabaseName(\"IX_TemplateDrafts_Biz_UpdatedAt\");\n\n                e.HasIndex(x => x.CreatedAt)\n                 .HasDatabaseName(\"IX_TemplateDrafts_CreatedAt\");\n            });\n            //TemplateDraftVariants\n\n            modelBuilder.Entity<TemplateDraftVariant>(e =>\n            {\n                // ðŸ” One language variant per draft\n                e.HasIndex(x => new { x.TemplateDraftId, x.Language })\n                 .IsUnique()\n                 .HasDatabaseName(\"UX_TDraftVariants_Draft_Language\");\n\n                // ðŸ”Ž Ready-for-submission filters\n                e.HasIndex(x => new { x.TemplateDraftId, x.IsReadyForSubmission })\n                 .HasDatabaseName(\"IX_TDraftVariants_Draft_Ready\");\n\n                // ðŸ”Ž Language lookups\n                e.HasIndex(x => x.Language)\n                 .HasDatabaseName(\"IX_TDraftVariants_Language\");\n            });\n\n            //TemplateLibraryItems\n            modelBuilder.Entity<TemplateLibraryItem>(e =>\n            {\n                // ðŸ” Unique per industry\n                e.HasIndex(x => new { x.Industry, x.Key })\n                 .IsUnique()\n                 .HasDatabaseName(\"UX_TLibrary_Industry_Key\");\n\n                // ðŸ”Ž Featured filters per industry\n                e.HasIndex(x => new { x.Industry, x.IsFeatured })\n                 .HasDatabaseName(\"IX_TLibrary_Industry_Featured\");\n\n                // ðŸ”Ž Browse by category\n                e.HasIndex(x => x.Category)\n                 .HasDatabaseName(\"IX_TLibrary_Category\");\n            });\n\n            //TemplateLibraryVariants\n            modelBuilder.Entity<TemplateLibraryVariant>(e =>\n            {\n                // ðŸ” One language per library item\n                e.HasIndex(x => new { x.LibraryItemId, x.Language })\n                 .IsUnique()\n                 .HasDatabaseName(\"UX_TLibraryVariants_Item_Lang\");\n\n                // ðŸ”Ž Language browsing\n                e.HasIndex(x => x.Language)\n                 .HasDatabaseName(\"IX_TLibraryVariants_Language\");\n            });\n            // ESU / Facebook: single-row flags per Business\n            modelBuilder.Entity<IntegrationFlags>(b =>\n            {\n                b.ToTable(\"IntegrationFlags\");\n                b.HasKey(x => x.BusinessId);\n\n                b.Property(x => x.BusinessId).ValueGeneratedNever();\n\n                b.Property(x => x.FacebookEsuCompleted)\n                 .IsRequired()\n                 .HasDefaultValue(false);\n\n\n\n                b.Property(x => x.CreatedAtUtc)\n                 .HasDefaultValueSql(\"timezone('utc', now())\")\n                 .ValueGeneratedOnAdd();\n\n                b.Property(x => x.UpdatedAtUtc)\n                 .HasDefaultValueSql(\"timezone('utc', now())\")\n                 .ValueGeneratedOnAdd();\n            });\n\n            modelBuilder.Entity<EsuToken>(b =>\n            {\n                b.ToTable(\"EsuTokens\");\n                b.HasIndex(x => new { x.BusinessId, x.Provider }).IsUnique();\n            });\n\n            modelBuilder.Entity<AccountInsightsAction>(cfg =>\n            {\n                cfg.ToTable(\"AccountInsightsActions\");\n\n                cfg.HasKey(x => x.Id);\n\n                cfg.Property(x => x.BusinessId)\n                    .IsRequired();\n\n                cfg.Property(x => x.ActionType)\n                    .HasMaxLength(64)\n                    .IsRequired();\n\n                cfg.Property(x => x.Label)\n                    .HasMaxLength(256);\n\n                cfg.Property(x => x.Actor)\n                    .HasMaxLength(256);\n\n                cfg.Property(x => x.MetaJson)\n                    .HasColumnType(\"text\");\n\n                cfg.Property(x => x.CreatedAtUtc)\n                    .IsRequired();\n\n                cfg.HasIndex(x => new { x.BusinessId, x.CreatedAtUtc });\n            });\n\n            // ----- Payment: Subscription -----\n            modelBuilder.Entity<Subscription>(b =>\n            {\n                b.ToTable(\"Subscriptions\");\n                b.HasKey(x => x.Id);\n\n                b.HasOne(x => x.Business)\n                    .WithMany() // later you can expose Business.Subscriptions if needed\n                    .HasForeignKey(x => x.BusinessId)\n                    .OnDelete(DeleteBehavior.Cascade);\n\n                b.HasOne(x => x.Plan)\n                    .WithMany()\n                    .HasForeignKey(x => x.PlanId)\n                    .OnDelete(DeleteBehavior.Restrict);\n\n                // Store enums as ints for simplicity\n                b.Property(x => x.Status)\n                    .HasConversion<int>()\n                    .IsRequired();\n\n                b.Property(x => x.BillingCycle)\n                    .HasConversion<int>()\n                    .IsRequired();\n\n                b.Property(x => x.CurrentPeriodStartUtc).IsRequired();\n                b.Property(x => x.CurrentPeriodEndUtc).IsRequired();\n\n                b.Property(x => x.GatewayCustomerId).HasMaxLength(200);\n                b.Property(x => x.GatewaySubscriptionId).HasMaxLength(200);\n            });\n\n            // ----- Payment: PaymentTransaction -----\n            modelBuilder.Entity<PaymentTransaction>(b =>\n            {\n                b.ToTable(\"PaymentTransactions\");\n                b.HasKey(x => x.Id);\n\n                b.HasOne(x => x.Business)\n                    .WithMany()\n                    .HasForeignKey(x => x.BusinessId)\n                    .OnDelete(DeleteBehavior.Cascade);\n\n                b.HasOne(x => x.Subscription)\n                    .WithMany(s => s.Payments)\n                    .HasForeignKey(x => x.SubscriptionId)\n                    .OnDelete(DeleteBehavior.SetNull);\n\n                b.HasOne(x => x.Invoice)\n                    .WithMany(i => i.Payments)\n                    .HasForeignKey(x => x.InvoiceId)\n                    .OnDelete(DeleteBehavior.SetNull);\n\n                b.Property(x => x.Status)\n                    .HasConversion<int>()\n                    .IsRequired();\n\n                b.Property(x => x.Amount)\n                    .HasColumnType(\"numeric(18,2)\")\n                    .IsRequired();\n\n                b.Property(x => x.Currency)\n                    .HasMaxLength(10)\n                    .IsRequired();\n\n                b.Property(x => x.Gateway)\n                    .HasMaxLength(50)\n                    .IsRequired();\n\n                b.Property(x => x.GatewayPaymentId).HasMaxLength(200);\n                b.Property(x => x.GatewayOrderId).HasMaxLength(200);\n                b.Property(x => x.GatewaySignature).HasMaxLength(500);\n\n                b.Property(x => x.CreatedAtUtc).IsRequired();\n            });\n            // ----- Payment: Invoice -----\n            modelBuilder.Entity<Invoice>(b =>\n            {\n                b.ToTable(\"Invoices\");\n                b.HasKey(x => x.Id);\n\n                b.HasOne(x => x.Business)\n                    .WithMany()\n                    .HasForeignKey(x => x.BusinessId)\n                    .OnDelete(DeleteBehavior.Cascade);\n\n                b.HasOne(x => x.Subscription)\n                    .WithMany(s => s.Invoices)\n                    .HasForeignKey(x => x.SubscriptionId)\n                    .OnDelete(DeleteBehavior.SetNull);\n\n                b.Property(x => x.InvoiceNumber)\n                    .HasMaxLength(100)\n                    .IsRequired();\n\n                b.HasIndex(x => x.InvoiceNumber)\n                    .IsUnique();\n\n                b.Property(x => x.Status)\n                    .HasConversion<int>()\n                    .IsRequired();\n\n                b.Property(x => x.SubtotalAmount)\n                    .HasColumnType(\"numeric(18,2)\")\n                    .IsRequired();\n\n                b.Property(x => x.TaxAmount)\n                    .HasColumnType(\"numeric(18,2)\")\n                    .IsRequired();\n\n                b.Property(x => x.DiscountAmount)\n                    .HasColumnType(\"numeric(18,2)\")\n                    .IsRequired();\n\n                b.Property(x => x.TotalAmount)\n                    .HasColumnType(\"numeric(18,2)\")\n                    .IsRequired();\n\n                b.Property(x => x.Currency)\n                    .HasMaxLength(10)\n                    .IsRequired();\n\n                b.Property(x => x.AppliedCouponCode)\n                    .HasMaxLength(100);\n\n                b.Property(x => x.TaxBreakdownJson)\n                    .HasColumnType(\"text\");\n\n                b.Property(x => x.IssuedAtUtc)\n                    .IsRequired();\n\n\n                b.HasOne(x => x.Plan)\n                   .WithMany()\n                   .HasForeignKey(x => x.PlanId)\n                   .OnDelete(DeleteBehavior.SetNull);\n\n                b.Property(x => x.BillingCycle)\n                    .HasConversion<int?>();\n\n                b.Property(x => x.InvoiceNumber)\n                    .HasMaxLength(100)\n                    .IsRequired();\n\n                b.HasIndex(x => x.InvoiceNumber).IsUnique();\n            });\n            // ----- Payment: InvoiceLineItem -----\n            modelBuilder.Entity<InvoiceLineItem>(b =>\n            {\n                b.ToTable(\"InvoiceLineItems\");\n                b.HasKey(x => x.Id);\n\n                b.HasOne(x => x.Invoice)\n                    .WithMany(i => i.LineItems)\n                    .HasForeignKey(x => x.InvoiceId)\n                    .OnDelete(DeleteBehavior.Cascade);\n\n                b.Property(x => x.Description)\n                    .HasMaxLength(500)\n                    .IsRequired();\n\n                b.Property(x => x.Quantity)\n                    .HasColumnType(\"numeric(18,2)\")\n                    .IsRequired();\n\n                b.Property(x => x.UnitPrice)\n                    .HasColumnType(\"numeric(18,2)\")\n                    .IsRequired();\n\n                b.Property(x => x.LineTotal)\n                    .HasColumnType(\"numeric(18,2)\")\n                    .IsRequired();\n            });\n            // ----- Payment: Coupon -----\n            modelBuilder.Entity<Coupon>(b =>\n            {\n                b.ToTable(\"Coupons\");\n                b.HasKey(x => x.Id);\n\n                b.Property(x => x.Code)\n                    .HasMaxLength(100)\n                    .IsRequired();\n\n                b.HasIndex(x => x.Code)\n                    .IsUnique();\n\n                b.Property(x => x.DiscountType)\n                    .HasConversion<int>()\n                    .IsRequired();\n\n                b.Property(x => x.DiscountValue)\n                    .HasColumnType(\"numeric(18,2)\")\n                    .IsRequired();\n\n                b.Property(x => x.IsActive)\n                    .IsRequired();\n\n                // Optional plan scope\n                b.HasOne<Plan>()\n                    .WithMany()\n                    .HasForeignKey(x => x.PlanId)\n                    .OnDelete(DeleteBehavior.SetNull);\n            });\n            var toUpper = new ValueConverter<string, string>(\n                    v => v == null ? null : v.ToUpperInvariant(),\n                    v => v\n                );\n\n            // --- PlanQuota ---\n            modelBuilder.Entity<PlanQuota>(e =>\n            {\n                e.Property(p => p.QuotaKey)\n                    .HasMaxLength(128)\n                    .HasConversion(toUpper); // normalize\n\n                // Unique per Plan + QuotaKey\n                e.HasIndex(p => new { p.PlanId, p.QuotaKey }).IsUnique();\n            });\n\n            // --- BusinessQuotaOverride ---\n            modelBuilder.Entity<BusinessQuotaOverride>(e =>\n            {\n                e.Property(p => p.QuotaKey)\n                    .HasMaxLength(128)\n                    .HasConversion(toUpper); // normalize\n\n                // Unique per Business + QuotaKey\n                e.HasIndex(p => new { p.BusinessId, p.QuotaKey }).IsUnique();\n            });\n\n            // --- BusinessUsageCounter ---\n            modelBuilder.Entity<BusinessUsageCounter>(e =>\n            {\n                e.Property(p => p.QuotaKey)\n                    .HasMaxLength(128)\n                    .HasConversion(toUpper); // normalize\n\n                // One active window per Business + QuotaKey + Period + WindowStart\n                e.HasIndex(u => new { u.BusinessId, u.QuotaKey, u.Period, u.WindowStartUtc }).IsUnique();\n            });\n\n            // --- Permission ---\n            modelBuilder.Entity<Permission>(e =>\n            {\n                e.Property(p => p.Code)\n                    .IsRequired()\n                    .HasMaxLength(120)\n                    .HasConversion(toUpper); // normalize\n\n                e.HasIndex(p => p.Code).IsUnique(); // enforce uniqueness\n            });\n\n        }\n\n    }\n}\n"
    }
  ]
}
