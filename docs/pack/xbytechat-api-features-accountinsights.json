{
  "name": "xbytechat-api/Features/AccountInsights",
  "generatedAt": "2025-12-10 08:27:07 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Features/AccountInsights/Controllers/AccountInsightsController.cs",
      "sha256": "64cd25ac7e7add6b1b977d821ca5a3bbd51f641bab27fe9b07eeef17c55d220e",
      "language": "csharp",
      "size": 8520,
      "content": "using System;\nusing System.Security.Claims;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.AccountInsights.DTOs;\nusing xbytechat.api.Features.AccountInsights.Models;\nusing xbytechat.api.Features.AccountInsights.Services;\nusing xbytechat.api.Features.PlanManagement.Models;\nusing System.Text.Json;\nnamespace xbytechat.api.Features.AccountInsights.Controllers\n{\n    [ApiController]\n    [Route(\"api/admin/account-insights\")]\n    [Authorize(Roles = \"admin,superadmin,partner\")]\n    public class AccountInsightsController : ControllerBase\n    {\n        private readonly IAccountInsightsService _svc;\n        private readonly AppDbContext _db;\n        public AccountInsightsController(IAccountInsightsService svc, AppDbContext db)\n        {\n            _svc = svc;\n            _db = db;\n        }\n\n        [HttpGet(\"{businessId:guid}\")]\n        public async Task<IActionResult> GetOne(Guid businessId)\n        {\n            var snapshot = await _svc.GetSnapshotAsync(businessId);\n            return Ok(snapshot);\n        }\n\n        [HttpGet]\n        public async Task<IActionResult> GetMany([FromQuery] int page = 1, [FromQuery] int pageSize = 50, [FromQuery] Guid? partnerId = null)\n        {\n            var snapshots = await _svc.GetSnapshotsAsync(page, pageSize, partnerId);\n            return Ok(snapshots);\n        }\n        [HttpGet(\"summary\")]\n        public async Task<IActionResult> GetSummary([FromQuery] Guid? partnerId = null)\n        {\n            var summary = await _svc.GetSummaryAsync(partnerId);\n            return Ok(summary);\n        }\n\n        [HttpGet(\"trial-expiring-soon\")]\n        public async Task<IActionResult> GetTrialsExpiringSoon([FromQuery] int days = 3)\n        {\n            var items = await _svc.GetTrialsExpiringSoonAsync(days);\n            return Ok(items);\n        }\n        [HttpGet(\"by-stage\")]\n        public async Task<IActionResult> GetByStage(\n            [FromQuery] AccountLifecycleStage stage,\n            [FromQuery] Guid? partnerId = null,\n            [FromQuery] int page = 1,\n            [FromQuery] int pageSize = 100)\n        {\n            var items = await _svc.GetByLifecycleStageAsync(stage, partnerId, page, pageSize);\n            return Ok(items);\n        }\n        [HttpGet(\"segment\")]\n        public async Task<IActionResult> GetSegment(\n            [FromQuery] string key,\n            [FromQuery] Guid? partnerId = null,\n            [FromQuery] int days = 3,\n            [FromQuery] int page = 1,\n            [FromQuery] int pageSize = 200)\n        {\n            if (string.IsNullOrWhiteSpace(key))\n                return BadRequest(\"Segment key is required.\");\n\n            key = key.Trim().ToLowerInvariant();\n\n            if (page <= 0) page = 1;\n            if (pageSize <= 0 || pageSize > 500) pageSize = 200;\n\n            IReadOnlyList<AccountInsightsSnapshotDto> items;\n\n            switch (key)\n            {\n                case \"trials-near-expiry\":\n                    // Trials whose trial window ends within next {days}\n                    items = await _svc.GetTrialsExpiringSoonAsync(days);\n                    break;\n\n                case \"no-usage-post-approval\":\n                case \"wa-setup-no-usage\":\n                    // Approved, never sent a message\n                    items = await _svc.GetByLifecycleStageAsync(\n                        AccountLifecycleStage.NoUsagePostApproval,\n                        partnerId,\n                        page,\n                        pageSize);\n                    break;\n\n                case \"at-risk\":\n                    items = await _svc.GetByLifecycleStageAsync(\n                        AccountLifecycleStage.AtRisk,\n                        partnerId,\n                        page,\n                        pageSize);\n                    break;\n\n                case \"dormant\":\n                    items = await _svc.GetByLifecycleStageAsync(\n                        AccountLifecycleStage.Dormant,\n                        partnerId,\n                        page,\n                        pageSize);\n                    break;\n\n                case \"healthy-active\":\n                    items = await _svc.GetByLifecycleStageAsync(\n                        AccountLifecycleStage.Active,\n                        partnerId,\n                        page,\n                        pageSize);\n                    break;\n\n                default:\n                    return BadRequest($\"Unknown segment key '{key}'.\");\n            }\n\n            return Ok(items);\n        }\n\n        [HttpGet(\"{businessId:guid}/actions\")]\n        public async Task<IActionResult> GetRecentActions(Guid businessId, [FromQuery] int limit = 10)\n        {\n            var items = await _svc.GetRecentActionsAsync(businessId, limit);\n            // Frontend supports both array and { items }; use { items } for clarity.\n            return Ok(new { items });\n        }\n        private string GetActor()\n        {\n            // Prefer email/username, fall back to subject or role\n            var email = User?.FindFirst(ClaimTypes.Email)?.Value;\n            var name = User?.Identity?.Name;\n\n            return !string.IsNullOrWhiteSpace(email)\n                ? email\n                : !string.IsNullOrWhiteSpace(name)\n                    ? name\n                    : \"admin\";\n        }\n\n        [HttpPost(\"{businessId:guid}/mark-contacted\")]\n        public async Task<IActionResult> MarkContacted(Guid businessId)\n        {\n            // No schema flag change; purely timeline-based\n            var actor = GetActor();\n\n            await _svc.LogActionAsync(\n                businessId,\n                AccountInsightActionTypes.TagContacted,\n                \"Marked as contacted\",\n                actor);\n\n            return Ok(new\n            {\n                ok = true,\n                businessId,\n                contacted = true\n            });\n        }\n        public class ExtendTrialRequest\n        {\n            public int ExtraDays { get; set; }\n        }\n\n        [HttpPost(\"{businessId:guid}/extend-trial\")]\n        public async Task<IActionResult> ExtendTrial(\n            Guid businessId,\n            [FromBody] ExtendTrialRequest body)\n        {\n            if (body == null || body.ExtraDays <= 0 || body.ExtraDays > 365)\n                return BadRequest(\"ExtraDays must be between 1 and 365.\");\n\n            var actor = GetActor();\n\n            var biz = await _db.Businesses\n                .Include(b => b.BusinessPlanInfo)\n                .FirstOrDefaultAsync(b => b.Id == businessId);\n\n            if (biz == null)\n                return NotFound(\"Business not found.\");\n\n            var plan = biz.BusinessPlanInfo;\n            if (plan == null)\n                return BadRequest(\"Business has no plan info.\");\n\n            if (plan.Plan != PlanType.Trial)\n                return BadRequest(\"Trial extension is only allowed for Trial plan.\");\n\n            var now = DateTime.UtcNow;\n\n            // current end date resolution (aligned with BuildSnapshotAsync)\n            var trialStart = plan.CreatedAt != default\n                ? plan.CreatedAt\n                : biz.CreatedAt;\n\n            DateTime currentEnd;\n            if (plan.QuotaResetDate != default && plan.QuotaResetDate > trialStart)\n            {\n                currentEnd = plan.QuotaResetDate;\n            }\n            else\n            {\n                currentEnd = trialStart.AddDays(14); // fallback consistent with DefaultTrialDaysFallback\n            }\n\n            var oldEnd = currentEnd;\n            var newEnd = oldEnd.AddDays(body.ExtraDays);\n\n            plan.QuotaResetDate = newEnd;\n            await _db.SaveChangesAsync();\n\n            var meta = JsonSerializer.Serialize(new\n            {\n                oldEnd,\n                newEnd,\n                extraDays = body.ExtraDays\n            });\n\n            await _svc.LogActionAsync(\n                businessId,\n                AccountInsightActionTypes.ExtendTrial,\n                $\"Trial extended by {body.ExtraDays} days\",\n                actor,\n                meta);\n\n            // Return updated snapshot so frontend stays in sync without extra roundtrip\n            var snapshot = await _svc.GetSnapshotAsync(businessId);\n\n            return Ok(new\n            {\n                ok = true,\n                businessId,\n                oldEnd,\n                newEnd,\n                snapshot\n            });\n        }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccountInsights/DTOs/AccountInsightsActionDto.cs",
      "sha256": "b77b9c0ccf810b320dbbae050e075b6dc2da7cc80c8ac9316cc2136498311905",
      "language": "csharp",
      "size": 430,
      "content": "using System;\n\nnamespace xbytechat.api.Features.AccountInsights.DTOs\n{\n    public class AccountInsightsActionDto\n    {\n        public long Id { get; set; }\n        public Guid BusinessId { get; set; }\n\n        public string Type { get; set; }\n        public string Label { get; set; }\n        public string Actor { get; set; }\n\n        public string MetaJson { get; set; }\n\n        public DateTime CreatedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccountInsights/DTOs/AccountInsightsSnapshotDto.cs",
      "sha256": "c2da56319228b929b1fd68165baacda30d7288b931c6c9a1c97c515c9c88d17f",
      "language": "csharp",
      "size": 1738,
      "content": "using System;\nusing xbytechat.api.Features.AccountInsights.Models;\nusing xbytechat.api.Features.PlanManagement.Models; // PlanType\n\nnamespace xbytechat.api.Features.AccountInsights.DTOs\n{\n    public class AccountInsightsSnapshotDto\n    {\n        public Guid BusinessId { get; set; }\n        public string BusinessName { get; set; }\n        public string BusinessEmail { get; set; }\n\n        public bool IsDeleted { get; set; }\n        public string Status { get; set; }           // Pending / Approved / Rejected (raw)\n        public bool IsApproved { get; set; }\n\n        public Guid? CreatedByPartnerId { get; set; }\n        public DateTime CreatedAt { get; set; }\n        public DateTime? ApprovedAt { get; set; }\n\n        // Plan / quota\n        public PlanType? PlanType { get; set; }\n        public int? TotalMonthlyQuota { get; set; }\n        public int? RemainingMessages { get; set; }\n        public DateTime? QuotaResetDate { get; set; }\n\n        // WhatsApp / onboarding\n        public bool HasWhatsAppConfig { get; set; }\n        public bool HasActiveWhatsAppNumber { get; set; }\n\n        // Usage\n        public bool HasAnyMessages { get; set; }\n        public DateTime? FirstMessageAt { get; set; }\n        public DateTime? LastMessageAt { get; set; }\n        public int MessagesLast30Days { get; set; }\n\n        // Lifecycle\n        public AccountLifecycleStage LifecycleStage { get; set; }\n        public int HealthScore { get; set; }\n\n        // Trial intelligence\n        public bool IsTrial { get; set; }\n        public DateTime? TrialStartAt { get; set; }\n        public DateTime? TrialEndsAt { get; set; }\n        public bool IsTrialExpiringSoon { get; set; }\n        public bool IsTrialExpired { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccountInsights/DTOs/AccountInsightsSummaryDto.cs",
      "sha256": "ccd45ad696bb4109efbaacbef1df10cc2e041a085b7e001b951d6ed2eaee4560",
      "language": "csharp",
      "size": 1128,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.AccountInsights.DTOs\n{\n    public class AccountInsightsSummaryDto\n    {\n        public DateTime GeneratedAtUtc { get; set; }\n\n        // Core counts\n        public int TotalBusinesses { get; set; }\n        public int ActiveBusinesses { get; set; }\n        public int AtRiskBusinesses { get; set; }\n        public int DormantBusinesses { get; set; }\n        public int NoUsagePostApproval { get; set; }\n\n        public int PendingApproval { get; set; }\n        public int Rejected { get; set; }\n        public int Deleted { get; set; }\n\n        // Plan\n        public int TrialPlan { get; set; }\n        public int PaidPlan { get; set; }\n        public int UnknownPlan { get; set; }\n\n        // Trial lifecycle\n        public int TrialTotal { get; set; }\n        public int TrialExpiringSoon { get; set; }\n        public int TrialExpiredNoUpgrade { get; set; }\n\n        // Distributions\n        public Dictionary<string, int> ByLifecycleStage { get; set; } = new();\n        public Dictionary<string, int> ByPlanType { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccountInsights/Models/AccountInsightActionTypes.cs",
      "sha256": "7055e4c6a231ed5f9738be56baf19b9a6fe8cf019469c2a74616a2b04d373f09",
      "language": "csharp",
      "size": 875,
      "content": "namespace xbytechat.api.Features.AccountInsights.Models\n{\n    /// <summary>\n    /// Canonical action type codes for AccountInsightsAction.ActionType.\n    /// Keeps frontend and backend aligned and avoids random strings.\n    /// </summary>\n    public static class AccountInsightActionTypes\n    {\n        // Manual sales / CS actions\n        public const string TagContacted = \"TAG_CONTACTED\";\n\n        // Trial lifecycle (only log when an actual manual/system CHANGE happens)\n        public const string ExtendTrial = \"EXTEND_TRIAL\";\n\n        // Plan changes\n        public const string PlanUpgraded = \"PLAN_UPGRADED\";\n        public const string PlanDowngraded = \"PLAN_DOWNGRADED\";\n\n        // System nudges (emails / campaigns etc.)\n        public const string SystemNudge = \"SYSTEM_NUDGE\";\n\n        // Generic manual note\n        public const string Note = \"NOTE\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccountInsights/Models/AccountInsightsAction.cs",
      "sha256": "06bf45cb34c4a8d6d783ccbe9794df5a37e3972cbd2527ab66434170f5e5355b",
      "language": "csharp",
      "size": 1298,
      "content": "using System;\n\nnamespace xbytechat.api.Features.AccountInsights.Models\n{\n    /// <summary>\n    /// Lightweight append-only log of important micro-actions taken on an account.\n    /// Used to power the Recent Activity timeline in Account Insights UI.\n    /// </summary>\n    public class AccountInsightsAction\n    {\n        public long Id { get; set; }\n\n        public Guid BusinessId { get; set; }\n\n        /// <summary>\n        /// Machine-friendly action code, e.g. \"TAG_CONTACTED\", \"EXTEND_TRIAL\".\n        /// </summary>\n        public string ActionType { get; set; }\n\n        /// <summary>\n        /// Human-readable label shown in the UI timeline.\n        /// </summary>\n        public string Label { get; set; }\n\n        /// <summary>\n        /// Who performed the action (user email/id) or \"system\".\n        /// </summary>\n        public string Actor { get; set; }\n\n        /// <summary>\n        /// Optional JSON blob for extra context (e.g. { \"extraDays\": 7 }).\n        /// Stored as string for simplicity; can be mapped to JSONB on the DB side.\n        /// </summary>\n        public string MetaJson { get; set; }\n\n        /// <summary>\n        /// UTC timestamp when the action occurred.\n        /// </summary>\n        public DateTime CreatedAtUtc { get; set; } = DateTime.UtcNow;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccountInsights/Models/AccountLifecycleStage.cs",
      "sha256": "4fcb2d0f0326c4bc85cc7e3e2836bc2c64d0956002e5807ee4cb1f3df2cef89c",
      "language": "csharp",
      "size": 695,
      "content": "namespace xbytechat.api.Features.AccountInsights.Models\n{\n    public enum AccountLifecycleStage\n    {\n        Unknown = 0,\n\n        PendingApproval = 10,      // Signed up, not yet approved\n        Rejected = 20,             // Explicitly rejected\n        InactiveDeleted = 25,      // Soft-deleted\n\n        Trial = 30,                // Trial plan, approved, some activity or in trial window\n        Active = 40,               // Approved + active usage\n        AtRisk = 50,               // Approved + low/no recent usage\n        Dormant = 60,              // Approved but idle for a long time\n\n        NoUsagePostApproval = 70   // Approved but literally never used (high churn risk)\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccountInsights/Services/AccountInsightsAlertService.cs",
      "sha256": "ee402e60508d432937e55c465d3a883d5708315bd4e297cddca077f99e7793d8",
      "language": "csharp",
      "size": 2033,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.AccountInsights.DTOs;\nusing xbytechat.api.Features.AccountInsights.Models;\nusing xbytechat.api.Features.AccountInsights.Services;\n\nnamespace xbytechat.api.Features.AccountInsights.Services\n{\n    public interface IAccountInsightsAlertService\n    {\n        Task<IReadOnlyList<AccountInsightsSnapshotDto>> GetTrialExpiringSoonAsync(int days = 3);\n        Task<IReadOnlyList<AccountInsightsSnapshotDto>> GetInactivePostApprovalAsync();\n    }\n\n    /// <summary>\n    /// Read-only helper for schedulers / workers to fetch cohorts that should be nudged.\n    /// This layer does NOT send messages itself.\n    /// </summary>\n    public class AccountInsightsAlertService : IAccountInsightsAlertService\n    {\n        private readonly IAccountInsightsService _insights;\n        private readonly ILogger<AccountInsightsAlertService> _log;\n\n        public AccountInsightsAlertService(\n            IAccountInsightsService insights,\n            ILogger<AccountInsightsAlertService> log)\n        {\n            _insights = insights;\n            _log = log;\n        }\n\n        public async Task<IReadOnlyList<AccountInsightsSnapshotDto>> GetTrialExpiringSoonAsync(int days = 3)\n        {\n            // Uses core logic; safe to call from a daily/cron job.\n            var list = await _insights.GetTrialsExpiringSoonAsync(days);\n            _log.LogInformation(\"Found {Count} trials expiring in next {Days} days\", list.Count, days);\n            return list;\n        }\n\n        public async Task<IReadOnlyList<AccountInsightsSnapshotDto>> GetInactivePostApprovalAsync()\n        {\n            // NoUsagePostApproval cohort: approved, no messages ever.\n            var list = await _insights.GetByLifecycleStageAsync(AccountLifecycleStage.NoUsagePostApproval);\n            _log.LogInformation(\"Found {Count} approved accounts with no usage post-approval\", list.Count);\n            return list;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccountInsights/Services/AccountInsightsService.cs",
      "sha256": "8d6457fc7aefe15956384777654cf665ca72fc9349990888d8ae9ba5764bdfe2",
      "language": "csharp",
      "size": 18261,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api;\nusing xbytechat.api.Features.AccountInsights.DTOs;\nusing xbytechat.api.Features.AccountInsights.Models;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.PlanManagement.Models; // PlanType\nusing xbytechat.api.Models.BusinessModel;          // BusinessPlanInfo\n\nnamespace xbytechat.api.Features.AccountInsights.Services\n{\n    public class AccountInsightsService : IAccountInsightsService\n    {\n        private readonly AppDbContext _db;\n        private readonly ILogger<AccountInsightsService> _log;\n\n        private const int TrialExpiringSoonDays = 3;\n        private const int DefaultTrialDaysFallback = 14;\n\n        public AccountInsightsService(AppDbContext db, ILogger<AccountInsightsService> log)\n        {\n            _db = db;\n            _log = log;\n        }\n\n        public async Task<AccountInsightsSnapshotDto> GetSnapshotAsync(Guid businessId)\n        {\n            var biz = await _db.Businesses\n                .Include(b => b.BusinessPlanInfo)\n                .FirstOrDefaultAsync(b => b.Id == businessId);\n\n            if (biz == null)\n                throw new InvalidOperationException($\"Business {businessId} not found\");\n\n            return await BuildSnapshotAsync(biz);\n        }\n\n        public async Task<IReadOnlyList<AccountInsightsSnapshotDto>> GetSnapshotsAsync(\n            int page = 1,\n            int pageSize = 50,\n            Guid? partnerId = null)\n        {\n            if (page <= 0) page = 1;\n            if (pageSize <= 0 || pageSize > 500) pageSize = 50;\n\n            var query = _db.Businesses\n                .Include(b => b.BusinessPlanInfo)\n                .AsQueryable();\n\n            if (partnerId.HasValue)\n            {\n                query = query.Where(b => b.CreatedByPartnerId == partnerId.Value);\n            }\n\n            query = query.OrderByDescending(b => b.CreatedAt);\n\n            var list = await query\n                .Skip((page - 1) * pageSize)\n                .Take(pageSize)\n                .ToListAsync();\n\n            var snapshots = new List<AccountInsightsSnapshotDto>(list.Count);\n            foreach (var biz in list)\n            {\n                snapshots.Add(await BuildSnapshotAsync(biz));\n            }\n\n            return snapshots;\n        }\n\n        // ---------- Core snapshot builder ----------\n\n        private async Task<AccountInsightsSnapshotDto> BuildSnapshotAsync(Business biz)\n        {\n            var now = DateTime.UtcNow;\n            var thirtyDaysAgo = now.AddDays(-30);\n            var ninetyDaysAgo = now.AddDays(-90);\n\n            var hasWaConfig = await _db.WhatsAppSettings\n                .AnyAsync(x => x.BusinessId == biz.Id && x.IsActive);\n\n            var hasActiveWaNumber = await _db.WhatsAppPhoneNumbers\n                .AnyAsync(x => x.BusinessId == biz.Id && x.IsActive);\n\n            var msgQuery = _db.MessageLogs.Where(m => m.BusinessId == biz.Id);\n            var hasAnyMessages = await msgQuery.AnyAsync();\n\n            DateTime? firstMessageAt = null;\n            DateTime? lastMessageAt = null;\n            var messagesLast30 = 0;\n\n            if (hasAnyMessages)\n            {\n                firstMessageAt = await msgQuery.MinAsync(m => (DateTime?)m.CreatedAt);\n                lastMessageAt = await msgQuery.MaxAsync(m => (DateTime?)m.CreatedAt);\n                messagesLast30 = await msgQuery.CountAsync(m => m.CreatedAt >= thirtyDaysAgo);\n            }\n\n            var planInfo = biz.BusinessPlanInfo;\n\n            // ---- Trial derivation ----\n            bool isTrial = false;\n            DateTime? trialStart = null;\n            DateTime? trialEnd = null;\n            bool trialExpiringSoon = false;\n            bool trialExpired = false;\n\n            if (planInfo != null &&\n                planInfo.Plan == PlanType.Trial &&\n                !biz.IsDeleted)\n            {\n                isTrial = true;\n\n                trialStart = planInfo.CreatedAt != default\n                    ? planInfo.CreatedAt\n                    : biz.CreatedAt;\n\n                if (trialStart.HasValue)\n                {\n                    if (planInfo.QuotaResetDate != default &&\n                        planInfo.QuotaResetDate > trialStart.Value)\n                    {\n                        trialEnd = planInfo.QuotaResetDate;\n                    }\n                    else\n                    {\n                        trialEnd = trialStart.Value.AddDays(DefaultTrialDaysFallback);\n                    }\n                }\n\n                if (trialEnd.HasValue)\n                {\n                    if (now <= trialEnd.Value)\n                    {\n                        var daysLeft = (trialEnd.Value - now).TotalDays;\n                        if (daysLeft >= 0 && daysLeft <= TrialExpiringSoonDays)\n                            trialExpiringSoon = true;\n                    }\n                    else\n                    {\n                        trialExpired = true;\n                    }\n                }\n            }\n\n            var stage = ComputeLifecycleStage(\n                biz,\n                hasWaConfig,\n                hasActiveWaNumber,\n                hasAnyMessages,\n                lastMessageAt,\n                messagesLast30,\n                now,\n                ninetyDaysAgo);\n\n            var health = ComputeHealthScore(\n                stage,\n                hasWaConfig,\n                hasActiveWaNumber,\n                messagesLast30,\n                lastMessageAt,\n                now);\n\n            return new AccountInsightsSnapshotDto\n            {\n                BusinessId = biz.Id,\n                BusinessName = biz.BusinessName,\n                BusinessEmail = biz.BusinessEmail,\n                IsDeleted = biz.IsDeleted,\n                Status = biz.Status.ToString(),\n                IsApproved = biz.IsApproved,\n                CreatedByPartnerId = biz.CreatedByPartnerId,\n                CreatedAt = biz.CreatedAt,\n                ApprovedAt = biz.ApprovedAt,\n\n                PlanType = planInfo?.Plan,\n                TotalMonthlyQuota = planInfo?.TotalMonthlyQuota,\n                RemainingMessages = planInfo?.RemainingMessages,\n                QuotaResetDate = planInfo?.QuotaResetDate,\n\n                HasWhatsAppConfig = hasWaConfig,\n                HasActiveWhatsAppNumber = hasActiveWaNumber,\n\n                HasAnyMessages = hasAnyMessages,\n                FirstMessageAt = firstMessageAt,\n                LastMessageAt = lastMessageAt,\n                MessagesLast30Days = messagesLast30,\n\n                LifecycleStage = stage,\n                HealthScore = health,\n\n                IsTrial = isTrial,\n                TrialStartAt = trialStart,\n                TrialEndsAt = trialEnd,\n                IsTrialExpiringSoon = trialExpiringSoon,\n                IsTrialExpired = trialExpired\n            };\n        }\n\n        private static AccountLifecycleStage ComputeLifecycleStage(\n            Business biz,\n            bool hasWaConfig,\n            bool hasActiveWaNumber,\n            bool hasAnyMessages,\n            DateTime? lastMessageAt,\n            int messagesLast30,\n            DateTime now,\n            DateTime ninetyDaysAgo)\n        {\n            if (biz.IsDeleted)\n                return AccountLifecycleStage.InactiveDeleted;\n\n            switch (biz.Status)\n            {\n                case Business.StatusType.Rejected:\n                    return AccountLifecycleStage.Rejected;\n                case Business.StatusType.Pending:\n                    return AccountLifecycleStage.PendingApproval;\n            }\n\n            if (!biz.IsApproved)\n                return AccountLifecycleStage.Unknown;\n\n            if (!hasAnyMessages)\n                return AccountLifecycleStage.NoUsagePostApproval;\n\n            if (messagesLast30 > 0)\n                return AccountLifecycleStage.Active;\n\n            if (lastMessageAt.HasValue && lastMessageAt.Value < ninetyDaysAgo)\n                return AccountLifecycleStage.Dormant;\n\n            return AccountLifecycleStage.AtRisk;\n        }\n\n        private static int ComputeHealthScore(\n            AccountLifecycleStage stage,\n            bool hasWaConfig,\n            bool hasActiveWaNumber,\n            int messagesLast30,\n            DateTime? lastMessageAt,\n            DateTime now)\n        {\n            if (stage == AccountLifecycleStage.InactiveDeleted ||\n                stage == AccountLifecycleStage.Rejected)\n                return 0;\n\n            var score = 0;\n\n            if (hasWaConfig) score += 15;\n            if (hasActiveWaNumber) score += 15;\n\n            if (messagesLast30 > 0)\n            {\n                score += 40;\n                if (messagesLast30 > 50) score += 10;\n                if (messagesLast30 > 200) score += 10;\n            }\n            else if (lastMessageAt.HasValue)\n            {\n                var days = (now - lastMessageAt.Value).TotalDays;\n                if (days <= 30) score += 30;\n                else if (days <= 90) score += 15;\n            }\n\n            switch (stage)\n            {\n                case AccountLifecycleStage.Active:\n                    score += 20;\n                    break;\n                case AccountLifecycleStage.AtRisk:\n                    score += 5;\n                    break;\n                case AccountLifecycleStage.NoUsagePostApproval:\n                    score -= 10;\n                    break;\n                case AccountLifecycleStage.Dormant:\n                    score -= 20;\n                    break;\n            }\n\n            if (score < 0) score = 0;\n            if (score > 100) score = 100;\n\n            return score;\n        }\n\n        // ---------- Summary ----------\n\n        public async Task<AccountInsightsSummaryDto> GetSummaryAsync(Guid? partnerId = null)\n        {\n            var now = DateTime.UtcNow;\n\n            var bizQuery = _db.Businesses\n                .Include(b => b.BusinessPlanInfo)\n                .AsQueryable();\n\n            if (partnerId.HasValue)\n                bizQuery = bizQuery.Where(b => b.CreatedByPartnerId == partnerId.Value);\n\n            var businesses = await bizQuery.ToListAsync();\n\n            var summary = new AccountInsightsSummaryDto\n            {\n                GeneratedAtUtc = now,\n                TotalBusinesses = businesses.Count\n            };\n\n            var stageCounts = new Dictionary<AccountLifecycleStage, int>();\n            var planCounts = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);\n\n            foreach (var biz in businesses)\n            {\n                var snapshot = await BuildSnapshotAsync(biz);\n\n                if (snapshot.IsDeleted)\n                    summary.Deleted++;\n\n                switch (snapshot.Status)\n                {\n                    case nameof(Business.StatusType.Pending):\n                        summary.PendingApproval++;\n                        break;\n                    case nameof(Business.StatusType.Rejected):\n                        summary.Rejected++;\n                        break;\n                }\n\n                if (!stageCounts.ContainsKey(snapshot.LifecycleStage))\n                    stageCounts[snapshot.LifecycleStage] = 0;\n                stageCounts[snapshot.LifecycleStage]++;\n\n                switch (snapshot.LifecycleStage)\n                {\n                    case AccountLifecycleStage.Active:\n                        summary.ActiveBusinesses++;\n                        break;\n                    case AccountLifecycleStage.AtRisk:\n                        summary.AtRiskBusinesses++;\n                        break;\n                    case AccountLifecycleStage.Dormant:\n                        summary.DormantBusinesses++;\n                        break;\n                    case AccountLifecycleStage.NoUsagePostApproval:\n                        summary.NoUsagePostApproval++;\n                        break;\n                }\n\n                if (snapshot.PlanType.HasValue)\n                {\n                    var planKey = snapshot.PlanType.Value.ToString();\n                    if (!planCounts.ContainsKey(planKey))\n                        planCounts[planKey] = 0;\n                    planCounts[planKey]++;\n\n                    if (snapshot.PlanType.Value == PlanType.Trial)\n                        summary.TrialPlan++;\n                    else\n                        summary.PaidPlan++;\n                }\n                else\n                {\n                    summary.UnknownPlan++;\n                    if (!planCounts.ContainsKey(\"Unknown\"))\n                        planCounts[\"Unknown\"] = 0;\n                    planCounts[\"Unknown\"]++;\n                }\n\n                if (snapshot.IsTrial)\n                {\n                    summary.TrialTotal++;\n\n                    if (snapshot.IsTrialExpiringSoon &&\n                        !snapshot.IsDeleted &&\n                        snapshot.LifecycleStage != AccountLifecycleStage.Rejected)\n                    {\n                        summary.TrialExpiringSoon++;\n                    }\n\n                    if (snapshot.IsTrialExpired &&\n                        !snapshot.IsDeleted &&\n                        snapshot.PlanType == PlanType.Trial)\n                    {\n                        summary.TrialExpiredNoUpgrade++;\n                    }\n                }\n            }\n\n            foreach (var kv in stageCounts)\n                summary.ByLifecycleStage[kv.Key.ToString()] = kv.Value;\n\n            foreach (var kv in planCounts)\n                summary.ByPlanType[kv.Key] = kv.Value;\n\n            return summary;\n        }\n\n        // ---------- Queries used by AlertService ----------\n\n        public async Task<IReadOnlyList<AccountInsightsSnapshotDto>> GetTrialsExpiringSoonAsync(int days = TrialExpiringSoonDays)\n        {\n            if (days <= 0) days = TrialExpiringSoonDays;\n\n            var now = DateTime.UtcNow;\n            var maxDate = now.AddDays(days);\n\n            var trials = await _db.Businesses\n                .Include(b => b.BusinessPlanInfo)\n                .Where(b =>\n                    !b.IsDeleted &&\n                    b.BusinessPlanInfo != null &&\n                    b.BusinessPlanInfo.Plan == PlanType.Trial)\n                .ToListAsync();\n\n            var list = new List<AccountInsightsSnapshotDto>();\n\n            foreach (var biz in trials)\n            {\n                var snapshot = await BuildSnapshotAsync(biz);\n\n                if (snapshot.IsTrial &&\n                    snapshot.TrialEndsAt.HasValue &&\n                    snapshot.TrialEndsAt.Value >= now &&\n                    snapshot.TrialEndsAt.Value <= maxDate &&\n                    !snapshot.IsTrialExpired)\n                {\n                    list.Add(snapshot);\n                }\n            }\n\n            return list;\n        }\n\n        public async Task<IReadOnlyList<AccountInsightsSnapshotDto>> GetByLifecycleStageAsync(\n            AccountLifecycleStage stage,\n            Guid? partnerId = null,\n            int page = 1,\n            int pageSize = 100)\n        {\n            if (page <= 0) page = 1;\n            if (pageSize <= 0 || pageSize > 500) pageSize = 100;\n\n            var query = _db.Businesses\n                .Include(b => b.BusinessPlanInfo)\n                .AsQueryable();\n\n            if (partnerId.HasValue)\n                query = query.Where(b => b.CreatedByPartnerId == partnerId.Value);\n\n            query = query.OrderByDescending(b => b.CreatedAt);\n\n            var businesses = await query\n                .Skip((page - 1) * pageSize)\n                .Take(pageSize)\n                .ToListAsync();\n\n            var result = new List<AccountInsightsSnapshotDto>();\n\n            foreach (var biz in businesses)\n            {\n                var snapshot = await BuildSnapshotAsync(biz);\n                if (snapshot.LifecycleStage == stage)\n                    result.Add(snapshot);\n            }\n\n            return result;\n        }\n\n        public async Task<IReadOnlyList<AccountInsightsActionDto>> GetRecentActionsAsync(\n        Guid businessId,\n        int limit = 10)\n        {\n            if (limit <= 0 || limit > 100)\n                limit = 10;\n\n            var actions = await _db.AccountInsightsActions\n                .Where(a => a.BusinessId == businessId)\n                .OrderByDescending(a => a.CreatedAtUtc)\n                .Take(limit)\n                .ToListAsync();\n\n            var dtos = actions\n                .Select(a => new AccountInsightsActionDto\n                {\n                    Id = a.Id,\n                    BusinessId = a.BusinessId,\n                    Type = a.ActionType,\n                    Label = a.Label,\n                    Actor = a.Actor,\n                    MetaJson = a.MetaJson,\n                    CreatedAt = a.CreatedAtUtc\n                })\n                .ToList();\n\n            return dtos;\n        }\n\n        public async Task LogActionAsync(\n    Guid businessId,\n    string actionType,\n    string label,\n    string actor,\n    string metaJson = null)\n        {\n            if (businessId == Guid.Empty)\n                throw new ArgumentException(\"BusinessId is required\", nameof(businessId));\n\n            if (string.IsNullOrWhiteSpace(actionType))\n                throw new ArgumentException(\"ActionType is required\", nameof(actionType));\n\n            if (string.IsNullOrWhiteSpace(label))\n                label = actionType;\n\n            var safeActor = string.IsNullOrWhiteSpace(actor) ? \"system\" : actor.Trim();\n\n            var entity = new AccountInsightsAction\n            {\n                BusinessId = businessId,\n                ActionType = actionType,\n                Label = label,\n                Actor = safeActor,\n                MetaJson = metaJson ?? string.Empty,\n                CreatedAtUtc = DateTime.UtcNow\n            };\n\n            _db.AccountInsightsActions.Add(entity);\n            await _db.SaveChangesAsync();\n\n            _log.LogInformation(\n                \"AccountInsightsAction logged: {BusinessId} {Type} by {Actor}\",\n                businessId,\n                actionType,\n                safeActor);\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/AccountInsights/Services/IAccountInsightsService.cs",
      "sha256": "a3ae86511f2774208f11cdbac7813469b4970c16ad5ff767b7f23273cc6bc1d8",
      "language": "csharp",
      "size": 1202,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.AccountInsights.DTOs;\nusing xbytechat.api.Features.AccountInsights.Models;\n\nnamespace xbytechat.api.Features.AccountInsights.Services\n{\n    public interface IAccountInsightsService\n    {\n        Task<AccountInsightsSnapshotDto> GetSnapshotAsync(Guid businessId);\n\n        Task<IReadOnlyList<AccountInsightsSnapshotDto>> GetSnapshotsAsync(\n            int page = 1,\n            int pageSize = 50,\n            Guid? partnerId = null);\n\n        Task<AccountInsightsSummaryDto> GetSummaryAsync(Guid? partnerId = null);\n\n        Task<IReadOnlyList<AccountInsightsSnapshotDto>> GetTrialsExpiringSoonAsync(int days = 3);\n\n        Task<IReadOnlyList<AccountInsightsSnapshotDto>> GetByLifecycleStageAsync(\n            AccountLifecycleStage stage,\n            Guid? partnerId = null,\n            int page = 1,\n            int pageSize = 100);\n\n        Task<IReadOnlyList<AccountInsightsActionDto>> GetRecentActionsAsync(\n       Guid businessId,\n       int limit = 10);\n\n        Task LogActionAsync(\n           Guid businessId, string actionType,string label, string actor,string metaJson = null);\n    }\n}\n"
    }
  ]
}
