{
  "name": "xbytechat-api/Features/BusinessModule",
  "generatedAt": "2025-12-10 08:27:07 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Features/BusinessModule/Controllers/BusinessesController.cs",
      "sha256": "0d631762644dc2d0cbed26c956d521e1d93f26689a5ba243146689be0fd375f6",
      "language": "csharp",
      "size": 6135,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Helpers;\nusing Serilog;\nusing System.Security.Claims;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.BusinessModule.Services;\nusing Microsoft.AspNetCore.Authorization;\n\nnamespace xbytechat.api.Features.BusinessModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class BusinessesController : ControllerBase\n    {\n        private readonly IBusinessService _businessService;\n\n        public BusinessesController(IBusinessService businessService)\n        {\n            _businessService = businessService;\n        }\n\n\n\n        [HttpGet(\"pending\")]\n        [Authorize(Roles = \"admin,superadmin,partner\")] // partners see scoped; admin/superadmin see ALL\n        public async Task<IActionResult> GetPendingBusinesses()\n        {\n            try\n            {\n                // Read role/id from multiple possible claim types\n                var role = User.FindFirst(ClaimTypes.Role)?.Value\n                           ?? User.FindFirst(\"role\")?.Value\n                           ?? User.FindFirst(\"roles\")?.Value\n                           ?? \"\";\n\n                var userId = User.FindFirst(\"id\")?.Value\n                           ?? User.FindFirst(ClaimTypes.NameIdentifier)?.Value\n                           ?? User.FindFirst(\"sub\")?.Value\n                           ?? \"\";\n\n                var result = await _businessService.GetPendingBusinessesAsync(role, userId);\n                return Ok(ResponseResult.SuccessInfo(\"‚úÖ Pending businesses fetched successfully.\", result));\n            }\n            catch\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"‚ùå Failed to fetch pending businesses. Please try again later.\"));\n            }\n        }\n\n\n        // ‚úÖ Get business by ID (used for profile completion)\n\n        [HttpGet(\"{id}\")]\n        public async Task<IActionResult> GetBusinessById(Guid id)\n        {\n            try\n            {\n                var business = await _businessService.GetByIdAsync(id);\n                if (business == null)\n                    return NotFound(ResponseResult.ErrorInfo(\"‚ùå Business not found.\"));\n\n                return Ok(business);\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"üö® Failed to fetch business. \" + ex.Message));\n            }\n        }\n\n        //[HttpPut(\"assigned-to/{id}\")]\n        [HttpPut(\"{id}\")]\n        [Authorize]\n        public async Task<IActionResult> UpdateBusiness(Guid id, [FromBody] UpdateBusinessDto dto)\n        {\n            if (dto == null)\n                return BadRequest(ResponseResult.ErrorInfo(\"‚ùå Invalid payload.\"));\n\n            var result = await _businessService.UpdateBusinessAsync(id, dto);\n\n            if (!result.Success)\n                return BadRequest(result);\n\n            return Ok(result);\n        }\n\n        // üü¢ Approve a business\n        [HttpPost(\"approve/{id}\")]\n        public async Task<IActionResult> Approve(Guid id)\n        {\n            try\n            {\n                var result = await _businessService.ApproveBusinessAsync(id);\n\n                if (result.Success)\n                {\n                    // ‚úÖ Optional Success Logging\n                    Log.Information(\"‚úÖ Business approved successfully. BusinessId: {BusinessId}\", id);\n                    return Ok(result);\n                }\n                else\n                {\n                    // ‚úÖ Optional Warning Logging\n                    Log.Warning(\"‚ö†Ô∏è Business approval failed. BusinessId: {BusinessId} - Message: {Message}\", id, result.Message);\n                    return BadRequest(result);\n                }\n            }\n            catch (Exception ex)\n            {\n                // ‚úÖ Proper Error Logging\n                Log.Error(ex, \"‚ùå Exception occurred while approving business. BusinessId: {BusinessId}\", id);\n\n                return StatusCode(500, ResponseResult.ErrorInfo(\n                    \"‚ùå Something went wrong while approving business. Please try again later.\"\n                ));\n            }\n        }\n\n\n        // üî¥ Reject a business\n        [HttpPost(\"reject/{id}\")]\n        public async Task<IActionResult> Reject(Guid id)\n        {\n            try\n            {\n                var result = await _businessService.RejectBusinessAsync(id);\n                return result.Success ? Ok(result) : NotFound(result);\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"‚ùå Failed to reject business. \" + ex.Message));\n            }\n        }\n\n        // üü° Put a business on hold\n        [HttpPost(\"hold/{id}\")]\n        public async Task<IActionResult> Hold(Guid id)\n        {\n            try\n            {\n                var result = await _businessService.HoldBusinessAsync(id);\n                return result.Success ? Ok(result) : NotFound(result);\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"‚ùå Failed to hold business. \" + ex.Message));\n            }\n        }\n\n        // üõ† Complete profile after signup\n        [HttpPost(\"profile-completion/{businessId}\")]\n        public async Task<IActionResult> CompleteProfile(Guid businessId, [FromBody] ProfileCompletionDto dto)\n        {\n            try\n            {\n                var result = await _businessService.CompleteProfileAsync(businessId, dto);\n                return result.Success ? Ok(result) : BadRequest(result);\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, ResponseResult.ErrorInfo(\"‚ùå Failed to update profile. \" + ex.Message));\n            }\n        }\n\n        [HttpGet(\"approved\")]\n        [Authorize(Roles = \"SuperAdmin\")]\n        public async Task<IActionResult> GetApprovedBusinesses()\n        {\n            var result = await _businessService.GetApprovedBusinessesAsync();\n            return Ok(result);\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/DTOs/PendingBusinessDto.cs",
      "sha256": "262c7390254b692bef62525ec48c34eb502354e446d2e98e77586b32f640f2be",
      "language": "csharp",
      "size": 482,
      "content": "namespace xbytechat.api.Features.BusinessModule.DTOs\n{\n    public class PendingBusinessDto\n    {\n        public Guid BusinessId { get; set; }\n        public string CompanyName { get; set; }\n        public string BusinessEmail { get; set; }\n        public string? RepresentativeName { get; set; }\n        public string? Phone { get; set; }\n        public string Plan { get; set; }\n        public DateTime CreatedAt { get; set; }\n        public bool? IsApproved { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/DTOs/ProfileCompletionDto.cs",
      "sha256": "cbd238cd045c0ee7bfc5061311058fa84005f29244727a11ef5b7a6eedbcf64f",
      "language": "csharp",
      "size": 489,
      "content": "namespace xbytechat.api.Features.BusinessModule.DTOs\n{\n    public class ProfileCompletionDto\n    {\n        public string? BusinessName { get; set; }\n        public string? ReperesentativeName { get; set; }\n        public string? CompanyPhone { get; set; }\n        public string? Phone { get; set; }\n        public string? Website { get; set; }\n        public string? Address { get; set; }\n        public string? Industry { get; set; }\n        public string? LogoUrl { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/DTOs/SignupBusinessDto.cs",
      "sha256": "daebace2d54e91a96825decc469c8acd57822d3e74bd5271ca80792e36cbb30e",
      "language": "csharp",
      "size": 717,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.BusinessModule.DTOs\n{\n    public class SignupBusinessDto\n    {\n        [Required]\n        public string CompanyName { get; set; }\n\n        [Required]\n        [EmailAddress]\n        public string Email { get; set; }\n\n        [Required]\n        public string Password { get; set; }\n\n        public string? RepresentativeName { get; set; }\n\n        public string? Phone { get; set; }\n        public string RoleName { get; set; } = \"business\"; // Default to business role\n\n        // üÜï NEW FIELD (Internal use only)\n        public Guid? CreatedByPartnerId { get; set; } // to assign the business to a specific user/agent/partner}\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/DTOs/UpdateBusinessDto.cs",
      "sha256": "d220065497b49d19e2e1ee681723ac965ddecc155c3de606f397fbdcc87ac585",
      "language": "csharp",
      "size": 756,
      "content": "namespace xbytechat.api.Features.BusinessModule.DTOs\n{\n    /// <summary>\n    /// Allowed fields for business profile updates.\n    /// No lifecycle / plan / ownership fields here.\n    /// </summary>\n    public class UpdateBusinessDto\n    {\n        public string? CompanyName { get; set; }\n        public string? BusinessName { get; set; }\n        public string? BusinessEmail { get; set; }\n        public string? Phone { get; set; }\n        public string? CompanyPhone { get; set; }\n        public string? Website { get; set; }\n        public string? Address { get; set; }\n        public string? Industry { get; set; }\n        public string? LogoUrl { get; set; }\n        public string? Tags { get; set; }\n        public string? Notes { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/Models/Business.cs",
      "sha256": "88684dd541d49eb7c1c8d896f46aa2a50c59c2f7385cdbaae206d7829b0616c3",
      "language": "csharp",
      "size": 2914,
      "content": "using System;\nusing System.Collections.Generic;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Models.BusinessModel;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.BusinessModule.Models\n{\n    public class Business\n    {\n        public Guid Id { get; set; }\n\n        // üè¢ Basic Info\n        public string? CompanyName { get; set; }\n        public string BusinessName { get; set; }\n        public string BusinessEmail { get; set; }  // Not used for login, just business contact\n        public string? RepresentativeName { get; set; }\n\n        public Guid? CreatedByPartnerId { get; set; }\n        public string? Phone { get; set; }\n        public string? CompanyPhone { get; set; }\n        public string? Website { get; set; }\n        public string? Address { get; set; }\n        public string? Industry { get; set; }\n        public string? LogoUrl { get; set; }\n\n        // üì¶ SaaS Plan & Status using Enums\n        // public enum PlanType { Basic, Smart, Advanced } -- moved to bisinessinfo\n        // public PlanType Plan { get; set; } = PlanType.Basic;  // moved to bisinessinfo\n        public enum StatusType { Pending, Approved, Rejected }\n        public StatusType Status { get; set; } = StatusType.Pending;  // Default to Pending\n\n        // üìù Metadata\n        public string? Tags { get; set; }\n        public string? Source { get; set; }\n        public string? Notes { get; set; }\n\n        // üìÖ Timestamps\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public string? CreatedBy { get; set; }\n        public bool IsApproved { get; set; } = false;\n        public string? ApprovedBy { get; set; }\n        public DateTime? ApprovedAt { get; set; }\n        public DateTime? LastLoginAt { get; set; }\n\n        // üóë Soft Deletion\n        public bool IsDeleted { get; set; } = false;\n        public DateTime? DeletedAt { get; set; }\n        public string? DeletedBy { get; set; }\n\n        // üë• Navigation Property - List of Users (nullable if no users)\n        public List<User> Users { get; set; } = new();\n\n\n        public ICollection<MessageStatusLog> MessageStatusLogs { get; set; }\n        public ICollection<Campaign> Campaigns { get; set; } = new List<Campaign>();\n        // üîó Plan Info linked\n\n        /// This is a one-to-one relationship with BusinessPlanInfo\n        public BusinessPlanInfo? BusinessPlanInfo { get; set; }\n\n        public Guid? PlanId { get; set; } // Nullable in case no plan is assigned yet\n        public Plan? Plan { get; set; }   // Navigation property to the Plan entity\n\n       // public WhatsAppSettingEntity WhatsAppSettings { get; set; }\n        public ICollection<WhatsAppSettingEntity> WhatsAppSettings { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/Services/BusinessService.cs",
      "sha256": "26049eafd3bce6b1a72d895f5d7a310df8623bc0e268b3b24ec76c92fd3eb69a",
      "language": "csharp",
      "size": 22613,
      "content": "using Microsoft.AspNetCore.Identity;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing System.Security.Claims;\nusing System.Security.Cryptography;\nusing System.Text;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.AccessControl.Models;\nusing xbytechat.api.Features.AuditTrail.Models;\nusing xbytechat.api.Features.AuditTrail.Services;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.PlanManagement.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Models.BusinessModel;\nusing xbytechat.api.Repositories.Interfaces;\n\nnamespace xbytechat.api.Features.BusinessModule.Services\n{\n    public class BusinessService : IBusinessService\n    {\n        private readonly IGenericRepository<Business> _businessRepo;\n        private readonly IGenericRepository<User> _userRepo;\n        private readonly IGenericRepository<Role> _roleRepo;\n        private readonly IAuditLogService _auditLogService;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n        // inside BusinessService class (class scope, not inside a method)\n        private static readonly Guid BASIC_PLAN_ID = Guid.Parse(\"5f9f5de1-a0b2-48ba-b03d-77b27345613f\");\n        private readonly IPasswordHasher<User> _passwordHasher;\n\n        private readonly AppDbContext _db;\n        public BusinessService(\n            AppDbContext db,\n            IGenericRepository<Business> businessRepo,\n            IGenericRepository<User> userRepo,\n            IGenericRepository<Role> roleRepo,\n            IAuditLogService auditLogService,\n            IHttpContextAccessor httpContextAccessor, IPasswordHasher<User> passwordHasher)\n        {\n            _db = db;\n            _passwordHasher = passwordHasher;\n            _businessRepo = businessRepo;\n            _userRepo = userRepo;\n            _roleRepo = roleRepo;\n            _auditLogService = auditLogService;\n            _httpContextAccessor = httpContextAccessor;\n        }\n\n        //public async Task<ResponseResult> SignupBusinessAsync(SignupBusinessDto dto)\n        //{\n        //    var normalizedEmail = dto.Email.Trim().ToLower();\n        //    var existing = await _userRepo.FirstOrDefaultAsync(u => u.Email == normalizedEmail);\n        //    if (existing != null)\n        //        return ResponseResult.ErrorInfo(\"‚ùå Email already exists\");\n\n        //    var business = new Business\n        //    {\n        //        Id = Guid.NewGuid(),\n        //        CompanyName = dto.CompanyName,\n        //        BusinessName = dto.CompanyName,\n        //        BusinessEmail = normalizedEmail,\n        //        RepresentativeName = dto.RepresentativeName,\n        //        Phone = dto.Phone,\n        //        CreatedByPartnerId = dto.CreatedByPartnerId,\n        //        Status = Business.StatusType.Pending,\n        //        // Plan = PlanType.Basic,\n        //        IsApproved = false,\n        //        CreatedAt = DateTime.UtcNow,\n        //        PlanId = BASIC_PLAN_ID   // ‚úÖ hard-code Basic plan here\n        //    };\n        //    // STEP 2: Create Plan Info separately\n        //    var planInfo = new BusinessPlanInfo\n        //    {\n        //        BusinessId = business.Id,\n        //        Plan = PlanType.Basic,\n        //        TotalMonthlyQuota = 1000,\n        //        RemainingMessages = 1000,\n        //        QuotaResetDate = DateTime.UtcNow.AddMonths(1),\n        //        WalletBalance = 0\n        //    };\n        //    // STEP 3: Link them\n        //    business.BusinessPlanInfo = planInfo;\n        //    // STEP 4: Save both\n        //    await _businessRepo.AddAsync(business);\n        //    await _businessRepo.SaveAsync();\n\n        //    var role = await _roleRepo.FirstOrDefaultAsync(r => r.Name.ToLower() == dto.RoleName.Trim().ToLower());\n\n        //    if (role == null)\n        //        return ResponseResult.ErrorInfo(\"‚ùå Invalid role specified\");\n\n        //    var user = new User\n        //    {\n        //        Id = Guid.NewGuid(),\n        //        Name = dto.CompanyName,\n        //        Email = normalizedEmail,\n        //        PasswordHash = HashPassword(dto.Password),\n        //        //PasswordHash = _passwordHasher.HashPassword(null!, dto.Password),\n        //        Role = role,\n        //        Status = \"Pending\",\n        //        BusinessId = business.Id\n        //    };\n\n        //    await _userRepo.AddAsync(user);\n        //    await _userRepo.SaveAsync();\n\n        //    await _auditLogService.SaveLogAsync(new AuditLog\n        //    {\n        //        BusinessId = business.Id,\n        //        PerformedByUserId = user.Id,\n        //        PerformedByUserName = user.Name,\n        //        RoleAtTime = \"business\",\n        //        ActionType = \"business.signup\",\n        //        Description = $\"New business signup: {business.CompanyName}\",\n        //        IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n        //        UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n        //    });\n\n        //    return ResponseResult.SuccessInfo(\"‚úÖ Signup successful. Pending approval.\", new { BusinessId = business.Id });\n        //}\n\n        public async Task<ResponseResult> SignupBusinessAsync(SignupBusinessDto dto)\n        {\n            var normalizedEmail = dto.Email.Trim().ToLower();\n            var existing = await _userRepo.FirstOrDefaultAsync(u => u.Email == normalizedEmail);\n            if (existing != null)\n                return ResponseResult.ErrorInfo(\"‚ùå Email already exists\");\n\n            var business = new Business\n            {\n                Id = Guid.NewGuid(),\n                CompanyName = dto.CompanyName,\n                BusinessName = dto.CompanyName,\n                BusinessEmail = normalizedEmail,\n                RepresentativeName = dto.RepresentativeName,\n                Phone = dto.Phone,\n                CreatedByPartnerId = dto.CreatedByPartnerId,\n                Status = Business.StatusType.Pending,\n                IsApproved = false,\n                CreatedAt = DateTime.UtcNow,\n\n                // ‚ùå IMPORTANT: no plan yet at signup\n                PlanId = null,              // if Guid?  (or just omit setting it)\n                                            // BusinessPlanInfo = null   // will be created at plan-selection time\n            };\n\n            // Only save the business now, without plan info\n            await _businessRepo.AddAsync(business);\n            await _businessRepo.SaveAsync();\n\n            var role = await _roleRepo.FirstOrDefaultAsync(\n                r => r.Name.ToLower() == dto.RoleName.Trim().ToLower()\n            );\n\n            if (role == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid role specified\");\n\n            var user = new User\n            {\n                Id = Guid.NewGuid(),\n                Name = dto.CompanyName,\n                Email = normalizedEmail,\n                PasswordHash = HashPassword(dto.Password),\n                Role = role,\n                Status = \"Pending\",\n                BusinessId = business.Id\n            };\n\n            await _userRepo.AddAsync(user);\n            await _userRepo.SaveAsync();\n\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = user.Id,\n                PerformedByUserName = user.Name,\n                RoleAtTime = \"business\",\n                ActionType = \"business.signup\",\n                Description = $\"New business signup: {business.CompanyName}\",\n                IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\n                \"‚úÖ Signup successful. Pending approval.\",\n                new { BusinessId = business.Id }\n            );\n        }\n\n\n\n        public async Task<ResponseResult> UpdateBusinessAsync(Guid businessId, UpdateBusinessDto dto)\n        {\n            if (dto == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid business update payload.\");\n\n            var business = await _businessRepo.AsQueryable()\n                .FirstOrDefaultAsync(b => b.Id == businessId && !b.IsDeleted);\n\n            if (business == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Business not found.\");\n\n            // ---- Authorization: who is allowed to edit this business? ----\n\n            var httpContext = _httpContextAccessor.HttpContext;\n            var user = httpContext?.User;\n\n            if (user == null || !user.Identity?.IsAuthenticated == true)\n                return ResponseResult.ErrorInfo(\"‚ùå Unauthorized. Please login again.\");\n\n            var role =\n                user.FindFirst(ClaimTypes.Role)?.Value ??\n                user.FindFirst(\"role\")?.Value ??\n                user.FindFirst(\"roles\")?.Value ??\n                string.Empty;\n\n            var userIdStr =\n                user.FindFirst(\"id\")?.Value ??\n                user.FindFirst(ClaimTypes.NameIdentifier)?.Value ??\n                user.FindFirst(\"sub\")?.Value ??\n                string.Empty;\n\n            Guid.TryParse(userIdStr, out var userId);\n\n            var roleLc = (role ?? string.Empty).ToLowerInvariant();\n            var isAdmin = roleLc == \"admin\" || roleLc == \"superadmin\";\n            var isPartner = roleLc == \"partner\";\n            var isAssignedPartner = isPartner && business.CreatedByPartnerId.HasValue &&\n                                    business.CreatedByPartnerId.Value == userId;\n\n            var isBusinessUser = false;\n            if (userId != Guid.Empty)\n            {\n                var userEntity = await _userRepo.AsQueryable()\n                    .AsNoTracking()\n                    .FirstOrDefaultAsync(u => u.Id == userId);\n\n                if (userEntity != null && userEntity.BusinessId == business.Id)\n                    isBusinessUser = true;\n            }\n\n            if (!isAdmin && !isAssignedPartner && !isBusinessUser)\n            {\n                return ResponseResult.ErrorInfo(\"‚õî You are not allowed to update this business.\");\n            }\n\n            // ---- Apply only allowed fields ----\n\n            if (!string.IsNullOrWhiteSpace(dto.CompanyName))\n                business.CompanyName = dto.CompanyName.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.BusinessName))\n                business.BusinessName = dto.BusinessName.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.BusinessEmail))\n                business.BusinessEmail = dto.BusinessEmail.Trim().ToLowerInvariant();\n\n            if (!string.IsNullOrWhiteSpace(dto.Phone))\n                business.Phone = dto.Phone.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.CompanyPhone))\n                business.CompanyPhone = dto.CompanyPhone.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.Website))\n                business.Website = dto.Website.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.Address))\n                business.Address = dto.Address.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.Industry))\n                business.Industry = dto.Industry.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.LogoUrl))\n                business.LogoUrl = dto.LogoUrl.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.Tags))\n                business.Tags = dto.Tags.Trim();\n\n            if (!string.IsNullOrWhiteSpace(dto.Notes))\n                business.Notes = dto.Notes.Trim();\n\n            // ‚ùå DO NOT touch:\n            // - business.Status\n            // - business.IsApproved\n            // - business.PlanId\n            // - business.BusinessPlanInfo\n            // - business.CreatedByPartnerId\n            // - deletion flags\n            // These are controlled only by dedicated admin/partner flows.\n\n            try\n            {\n                _businessRepo.Update(business);\n                await _businessRepo.SaveAsync();\n                return ResponseResult.SuccessInfo(\"‚úÖ Business updated successfully.\");\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Failed to update business: \" + ex.Message);\n            }\n        }\n\n\n        public async Task<List<PendingBusinessDto>> GetPendingBusinessesAsync(string role, string userId)\n        {\n            try\n            {\n                var roleLc = (role ?? \"\").ToLowerInvariant();\n\n                // base: pending + not deleted\n                IQueryable<Business> q = _businessRepo.AsQueryable()\n                    .AsNoTracking()\n                    .Include(b => b.BusinessPlanInfo)   // ‚úÖ load enum Plan from BusinessPlanInfo\n                                                        // .Include(b => b.Plan)            // ‚Üê only if you have a Plan navigation property\n                    .Where(b => b.Status == Business.StatusType.Pending && !b.IsDeleted);\n\n                // scope for partner\n                if (roleLc == \"partner\")\n                {\n                    if (!Guid.TryParse(userId, out var partnerId)) return new();\n                    q = q.Where(b => b.CreatedByPartnerId == partnerId);\n                }\n                else if (roleLc != \"admin\" && roleLc != \"superadmin\")\n                {\n                    return new(); // anyone else: nothing\n                }\n\n                var items = await q.OrderByDescending(b => b.CreatedAt).ToListAsync();\n\n                // Map to your existing DTO; with Include() the enum will be present\n                return items.Select(b => new PendingBusinessDto\n                {\n                    BusinessId = b.Id,\n                    CompanyName = b.CompanyName ?? \"\",\n                    BusinessEmail = b.BusinessEmail ?? \"\",\n                    RepresentativeName = b.RepresentativeName ?? \"\",\n                    Phone = b.Phone ?? \"\",\n                    // Shows \"Basic\" etc. because BusinessPlanInfo is now loaded\n                    Plan = b.BusinessPlanInfo?.Plan.ToString() ?? \"Unknown\",\n                    CreatedAt = b.CreatedAt,\n                    IsApproved = b.IsApproved\n                }).ToList();\n            }\n            catch\n            {\n                return new();\n            }\n        }\n\n        public async Task<ResponseResult> ApproveBusinessAsync(Guid businessId)\n        {\n            var business = await _businessRepo\n                .AsQueryable()\n                .Include(b => b.Users)\n                .FirstOrDefaultAsync(b => b.Id == businessId);\n\n            if (business == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Business not found.\");\n\n            // ‚úÖ Current Logged-in User Details\n            var httpContext = _httpContextAccessor.HttpContext;\n            var currentUserId = httpContext?.User?.FindFirst(\"id\")?.Value;\n            var currentUserRole = httpContext?.User?.Claims\n    .FirstOrDefault(c => c.Type.Contains(\"role\"))?.Value;\n            //httpContext?.User?.FindFirst(\"role\")?.Value;\n\n            // var currentUserName = httpContext?.User?.FindFirst(\"name\")?.Value ?? \"Unknown\";\n            var currentUserName = httpContext?.User?.Claims\n    .FirstOrDefault(c => c.Type.Contains(\"name\"))?.Value ?? \"Unknown\";\n            if (string.IsNullOrEmpty(currentUserId) || string.IsNullOrEmpty(currentUserRole))\n                return ResponseResult.ErrorInfo(\"‚ùå Unauthorized access. Please login again.\");\n\n            var currentGuid = Guid.Parse(currentUserId);\n\n            // ‚úÖ Authorization Logic\n            var isSuperAdmin = currentUserRole.Equals(\"admin\", StringComparison.OrdinalIgnoreCase) ||\n                               currentUserRole.Equals(\"superadmin\", StringComparison.OrdinalIgnoreCase);\n\n            var isAssignedPartner = business.CreatedByPartnerId.HasValue &&\n                                     business.CreatedByPartnerId.Value == currentGuid;\n\n            if (!isSuperAdmin && !isAssignedPartner)\n            {\n                return ResponseResult.ErrorInfo(\"‚õî You are not authorized to approve this business.\");\n            }\n\n            // ‚úÖ Approve Business\n\n            business.IsApproved = true;\n            business.Status = Business.StatusType.Approved;\n            business.ApprovedAt = DateTime.UtcNow;\n            business.ApprovedBy = currentUserName;\n            _businessRepo.Update(business);\n\n            // ‚úÖ Update all Users to \"ProfilePending\"\n            foreach (var user in business.Users)\n            {\n                user.Status = \"Active\";\n                _userRepo.Update(user);\n            }\n\n            await _businessRepo.SaveAsync();\n            await _userRepo.SaveAsync();\n\n            // ‚úÖ Audit Log\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = currentGuid,\n                PerformedByUserName = currentUserName,\n                RoleAtTime = currentUserRole,\n                ActionType = \"business.approved\",\n                Description = $\"Business approved: {business.CompanyName}\",\n                IPAddress = httpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = httpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\"‚úÖ Business approved successfully.\");\n        }\n\n        public async Task<ResponseResult> RejectBusinessAsync(Guid businessId)\n        {\n            var business = await _businessRepo.FindByIdAsync(businessId);\n            if (business is null)\n                return ResponseResult.ErrorInfo(\"‚ùå Business not found\");\n\n            business.Status = Business.StatusType.Rejected;\n            business.IsDeleted = true;\n            business.DeletedAt = DateTime.UtcNow;\n\n            _businessRepo.Update(business);\n            await _businessRepo.SaveAsync();\n\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = Guid.TryParse(_httpContextAccessor.HttpContext?.User?.FindFirst(\"id\")?.Value, out var userId) ? userId : Guid.Empty,\n                PerformedByUserName = _httpContextAccessor.HttpContext?.User?.FindFirst(\"email\")?.Value,\n                RoleAtTime = _httpContextAccessor.HttpContext?.User?.FindFirst(\"role\")?.Value,\n                ActionType = \"business.rejected\",\n                Description = $\"Business rejected: {business.CompanyName}\",\n                IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\"‚úÖ Business rejected and marked as deleted\");\n        }\n\n        public async Task<ResponseResult> HoldBusinessAsync(Guid businessId)\n        {\n            var business = await _businessRepo.FindByIdAsync(businessId);\n            if (business is null)\n                return ResponseResult.ErrorInfo(\"‚ùå Business not found\");\n\n            business.IsApproved = false;\n            business.Status = Business.StatusType.Pending;\n\n            _businessRepo.Update(business);\n            await _businessRepo.SaveAsync();\n\n            await _auditLogService.SaveLogAsync(new AuditLog\n            {\n                BusinessId = business.Id,\n                PerformedByUserId = Guid.TryParse(_httpContextAccessor.HttpContext?.User?.FindFirst(\"id\")?.Value, out var userId) ? userId : Guid.Empty,\n                PerformedByUserName = _httpContextAccessor.HttpContext?.User?.FindFirst(\"email\")?.Value,\n                RoleAtTime = _httpContextAccessor.HttpContext?.User?.FindFirst(\"role\")?.Value,\n                ActionType = \"business.hold\",\n                Description = $\"Business put on hold: {business.CompanyName}\",\n                IPAddress = _httpContextAccessor.HttpContext?.Connection?.RemoteIpAddress?.ToString(),\n                UserAgent = _httpContextAccessor.HttpContext?.Request?.Headers[\"User-Agent\"].ToString()\n            });\n\n            return ResponseResult.SuccessInfo(\"‚è∏ Business put on hold\");\n        }\n\n        public async Task<ResponseResult> CompleteProfileAsync(Guid businessId, ProfileCompletionDto dto)\n        {\n            var business = await _businessRepo.FindByIdAsync(businessId);\n            if (business is null)\n                return ResponseResult.ErrorInfo(\"‚ùå Business not found\");\n\n            if (!string.IsNullOrEmpty(dto.BusinessName)) business.BusinessName = dto.BusinessName;\n            if (!string.IsNullOrEmpty(dto.CompanyPhone)) business.CompanyPhone = dto.CompanyPhone;\n            if (!string.IsNullOrEmpty(dto.Website)) business.Website = dto.Website;\n            if (!string.IsNullOrEmpty(dto.Address)) business.Address = dto.Address;\n            if (!string.IsNullOrEmpty(dto.Industry)) business.Industry = dto.Industry;\n            if (!string.IsNullOrEmpty(dto.LogoUrl)) business.LogoUrl = dto.LogoUrl;\n            if (!string.IsNullOrEmpty(dto.ReperesentativeName)) business.RepresentativeName = dto.ReperesentativeName;\n            if (!string.IsNullOrEmpty(dto.Phone)) business.Phone = dto.Phone;\n            _businessRepo.Update(business);\n            await _businessRepo.SaveAsync();\n            return ResponseResult.SuccessInfo(\"‚úÖ Profile updated successfully\");\n        }\n\n        public async Task<Business?> GetBusinessByEmailAsync(string email)\n        {\n            return await _businessRepo.FirstOrDefaultAsync(b => b.BusinessEmail.ToLower() == email.Trim().ToLower());\n        }\n\n        private string HashPassword(string password)\n        {\n            using var sha = SHA256.Create();\n            var bytes = Encoding.UTF8.GetBytes(password);\n            var hash = sha.ComputeHash(bytes);\n            return Convert.ToBase64String(hash);\n        }\n\n        public async Task<Business?> GetByIdAsync(Guid businessId)\n        {\n            return await _businessRepo.FindByIdAsync(businessId);\n        }\n\n        public async Task<List<Business>> GetApprovedBusinessesAsync()\n        {\n            return await _businessRepo.AsQueryable()\n               .Where(b => b.IsApproved && !b.IsDeleted)\n               .OrderBy(b => b.CompanyName)\n               .ToListAsync();\n        }\n        public IQueryable<Business> Query()\n        {\n            return _businessRepo.AsQueryable();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/BusinessModule/Services/IBusinessService.cs",
      "sha256": "9220e7179eb4f63c8d9bd1278f36663493dd9e12a997747aef396415cdf99fab",
      "language": "csharp",
      "size": 1204,
      "content": "using System.Runtime.CompilerServices;\nusing xbytechat.api.Features.BusinessModule.DTOs;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Models;\nnamespace xbytechat.api.Features.BusinessModule.Services\n{\n\n    public interface IBusinessService\n    {\n        IQueryable<Business> Query();\n        Task<ResponseResult> SignupBusinessAsync(SignupBusinessDto dto); /// Signup + create admin user\n\n        Task<ResponseResult> ApproveBusinessAsync(Guid businessId);      // Admin action\n        Task<ResponseResult> RejectBusinessAsync(Guid businessId);       // Admin action\n        Task<ResponseResult> HoldBusinessAsync(Guid businessId);         // Admin action\n        Task<ResponseResult> CompleteProfileAsync(Guid businessId, ProfileCompletionDto dto); // Post-login completion\n        Task<Business?> GetBusinessByEmailAsync(string email);\n        Task<Business?> GetByIdAsync(Guid businessId);\n \n        Task<ResponseResult> UpdateBusinessAsync(Guid businessId, UpdateBusinessDto dto);\n\n        Task<List<PendingBusinessDto>> GetPendingBusinessesAsync(string role, string userId);\n        Task<List<Business>> GetApprovedBusinessesAsync();\n    }\n\n}\n"
    }
  ]
}
