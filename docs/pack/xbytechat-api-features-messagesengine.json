{
  "name": "xbytechat-api/Features/MessagesEngine",
  "generatedAt": "2025-12-10 08:27:07 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Features/MessagesEngine/Abstractions/IWhatsAppProvider.cs",
      "sha256": "25a1b1105d245abb3cf620574e2cca3c0da007884f8ba8a062c2cd4724b88022",
      "language": "csharp",
      "size": 1124,
      "content": "// üìÑ File: Features/MessagesEngine/Abstractions/IWhatsAppProvider.cs\nusing System.Threading.Tasks;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.Features.MessagesEngine.Abstractions\n{\n   \n    public interface IWhatsAppProvider\n    {\n        Task<WaSendResult> SendTextAsync(string to, string body);\n        Task<WaSendResult> SendTemplateAsync(string to, string templateName, string languageCode, IEnumerable<object> components);\n        Task<WaSendResult> SendInteractiveAsync(object fullPayload); // prebuilt object (e.g., image + CTA)\n    }\n}\n\n\n\n//namespace xbytechat.api.Features.MessagesEngine.Abstractions\n//{\n//    public interface IWhatsAppProvider\n//    {\n//        string Provider { get; }\n\n//        Task<WaSendResult> SendTextAsync(string to, string body, CancellationToken ct = default);\n\n//        Task<WaSendResult> SendTemplateAsync(string to, string templateName, string language, object? components, CancellationToken ct = default);\n\n//        // Optional: interactive/image+CTA\n//        Task<WaSendResult> SendInteractiveAsync(object payload, CancellationToken ct = default);\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Abstractions/WaSendResult.cs",
      "sha256": "cbdf2f4ea14dafdbfd281c92d4701d11b385c52c89785faa04d1848b6af5bd8f",
      "language": "csharp",
      "size": 320,
      "content": "using System.Net;\n\nnamespace xbytechat.api.Features.MessagesEngine.Abstractions\n{\n    public record WaSendResult(\n        bool Success,\n        string Provider,\n        string? ProviderMessageId = null,\n        HttpStatusCode? StatusCode = null,\n        string? RawResponse = null,\n        string? Error = null\n    );\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Abstractions/WaSendTemplate.cs",
      "sha256": "ce04cfc0e5abaca6ef42cf5593159791a9ae093be9b7399eae4442252b2362bd",
      "language": "csharp",
      "size": 378,
      "content": "using System;\n\nnamespace xbytechat.api.Features.MessagesEngine.Abstractions\n{\n    public class WaSendTemplate\n    {\n        public Guid BusinessId { get; init; }\n        public string To { get; init; } = \"\";\n        public string TemplateName { get; init; } = \"\";\n        public string Language { get; init; } = \"en_US\";\n        public object? Components { get; init; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Abstractions/WaSendText.cs",
      "sha256": "192ded7365dc037581055e12a8e00816487953e786e107447465183e8e0f83a7",
      "language": "csharp",
      "size": 260,
      "content": "using System;\n\nnamespace xbytechat.api.Features.MessagesEngine.Abstractions\n{\n    public class WaSendText\n    {\n        public Guid BusinessId { get; init; }\n        public string To { get; init; } = \"\";\n        public string Body { get; init; } = \"\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Contracts/MessageEnvelope.cs",
      "sha256": "7d9a3c2180154a34b5c48dbcc92d2b9ce3affbcadaacba097bba0eae1af2925e",
      "language": "csharp",
      "size": 648,
      "content": "using System.Collections.Generic;\n\nnamespace xbytechat.api.Features.MessagesEngine.Contracts\n{\n    /// <summary>\n    /// Provider-agnostic message envelope. Maps to Meta/Pinbot under the hood.\n    /// </summary>\n    public sealed record MessageEnvelope(\n        string To,\n        string Kind,                       // \"text\" | \"template\" | \"interactive\"\n        string? TemplateName = null,\n        string LanguageCode = \"en_US\",\n        List<object>? Components = null,    // template components\n        object? Interactive = null,         // interactive payload (if any)\n        string? TextBody = null,\n        string? ImageUrl = null\n    );\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Controllers/MessageEngineController.cs",
      "sha256": "dccc3a3007e5829ebb5161cc80da73208b3eec3a715695a0e4c467584bb87735",
      "language": "csharp",
      "size": 8267,
      "content": "\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing System.Security.Claims;\nusing System.Text.Json;\nusing xbytechat.api.DTOs.Messages;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.Features.ReportingModule.Services;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.MessagesEngine.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    [Authorize]\n    public class MessageEngineController : ControllerBase\n    {\n        private readonly IMessageEngineService _messageEngineService;\n        private readonly IMessageAnalyticsService _messageAnalyticsServiceervice;\n\n\n        public MessageEngineController(IMessageEngineService messageService, IMessageAnalyticsService messageAnalyticsService)\n        {\n            _messageEngineService = messageService;\n            _messageAnalyticsServiceervice = messageAnalyticsService;\n        }\n        //[HttpPost(\"send-contentfree-text\")]\n        //public async Task<IActionResult> SendTextMessage([FromBody] TextMessageSendDto dto)\n        //{\n        //    if (!ModelState.IsValid)\n        //        return BadRequest(ResponseResult.ErrorInfo(\"‚ùå Invalid text message payload.\"));\n\n        //    try\n        //    {\n        //        var result = await _messageEngineService.SendTextDirectAsync(dto); // üëà New direct method\n\n        //        return result.Success\n        //            ? Ok(result)\n        //            : BadRequest(ResponseResult.ErrorInfo(result.Message, result.RawResponse));\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        Console.WriteLine($\"‚ùå Exception while sending text message: {ex.Message}\");\n        //        return StatusCode(500, ResponseResult.ErrorInfo(\"üö® Server error while sending text message.\", ex.ToString()));\n        //    }\n        //}\n        [HttpPost(\"send-contentfree-text\")]\n        public async Task<IActionResult> SendTextMessage([FromBody] TextMessageSendDto dto)\n        {\n            // 0) Null/body guard\n            if (dto is null)\n                return BadRequest(ResponseResult.ErrorInfo(\n                    \"‚ùå Invalid request body.\",\n                    \"Request JSON was null or malformed.\"));\n\n            // 1) Minimal required-field validation (provider is optional here)\n            var missing = new List<string>();\n            if (string.IsNullOrWhiteSpace(dto.RecipientNumber)) missing.Add(\"recipientNumber\");\n            if (string.IsNullOrWhiteSpace(dto.TextContent)) missing.Add(\"textContent\");\n\n            if (missing.Count > 0)\n            {\n                return BadRequest(ResponseResult.ErrorInfo(\n                    \"‚ùå Invalid text message payload.\",\n                    $\"Missing/empty: {string.Join(\", \", missing)}\"\n                ));\n            }\n\n            // 2) Diagnostics while debugging\n            Console.WriteLine($\"[SendTextMessage] Incoming: {JsonSerializer.Serialize(dto)}\");\n            Console.WriteLine($\"[SendTextMessage] provider(raw)='{dto.Provider}' phoneNumberId(raw)='{dto.PhoneNumberId}'\");\n\n            try\n            {\n                // 3) Delegate to service (service will resolve provider if missing)\n                var result = await _messageEngineService.SendTextDirectAsync(dto);\n\n                // 4) Return exactly what service produced\n                return result.Success ? Ok(result) : BadRequest(result);\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"‚ùå Exception while sending text message: {ex}\");\n                return StatusCode(500, ResponseResult.ErrorInfo(\n                    \"üö® Server error while sending text message.\", ex.ToString()));\n            }\n        }\n        [HttpPost(\"send-template-simple\")]\n        public async Task<IActionResult> SendTemplateMessageSimple([FromBody] SimpleTemplateMessageDto dto)\n        {\n            if (!ModelState.IsValid)\n                return BadRequest(ResponseResult.ErrorInfo(\"‚ùå Invalid template message request.\"));\n\n            try\n            {\n                var businessIdClaim = User.FindFirst(\"businessId\")?.Value;\n                if (!Guid.TryParse(businessIdClaim, out Guid businessId))\n                    return Unauthorized(ResponseResult.ErrorInfo(\"‚ùå Business ID not found in token.\"));\n\n                var result = await _messageEngineService.SendTemplateMessageSimpleAsync(businessId, dto);\n\n                return result.Success\n                    ? Ok(result)\n                    : BadRequest(ResponseResult.ErrorInfo(result.Message ?? \"‚ùå Failed to send template.\", result.RawResponse));\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"‚ùå Exception while sending template: {ex.Message}\");\n                return StatusCode(500, ResponseResult.ErrorInfo(\"üö® Server error while sending template.\", ex.ToString()));\n            }\n        }\n\n\n        [HttpPost(\"send-image-campaign/{campaignId}\")]\n        public async Task<IActionResult> SendImageCampaign(Guid campaignId)\n        {\n            try\n            {\n                var businessId = UserClaimHelper.GetBusinessId(User); // ‚úÖ from\n                                                                      // claims\n                var userName = UserClaimHelper.GetUserName(User);     // for logging (if needed)\n\n                var result = await _messageEngineService.SendImageCampaignAsync(campaignId, businessId, userName);\n\n                return result.Success\n                    ? Ok(result)\n                    : BadRequest(result);\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(\"‚ùå Error while sending image campaign: \" + ex.Message);\n                return StatusCode(500, ResponseResult.ErrorInfo(\"Server error while sending campaign.\", ex.ToString()));\n            }\n        }\n        public static class UserClaimHelper\n        {\n            public static Guid GetBusinessId(ClaimsPrincipal user)\n            {\n                var claim = user.Claims.FirstOrDefault(c => c.Type == \"businessId\");\n                return claim != null ? Guid.Parse(claim.Value) : Guid.Empty;\n            }\n\n            public static string GetUserName(ClaimsPrincipal user)\n            {\n                return user?.Identity?.Name ?? \"Unknown\";\n            }\n        }\n\n        [HttpPost(\"send-image-template\")]\n        public async Task<IActionResult> SendImageTemplateMessage([FromBody] ImageTemplateMessageDto dto)\n        {\n            Guid businessId;\n            try\n            {\n                businessId = User.GetBusinessId(); // Uses your extension method!\n            }\n            catch (UnauthorizedAccessException ex)\n            {\n                return Unauthorized(new { message = ex.Message });\n            }\n\n            var result = await _messageEngineService.SendImageTemplateMessageAsync(dto, businessId);\n\n            if (result.Success)\n                return Ok(new { message = result.Message, raw = result.RawResponse });\n\n            return BadRequest(new { message = result.Message, raw = result.RawResponse });\n        }\n\n\n        //[HttpPost(\"send-video-template\")]\n        //public async Task<IActionResult> SendVideoTemplateMessage([FromBody] VideoTemplateMessageDto dto)\n        //{\n        //    Guid businessId;\n        //    try { businessId = User.GetBusinessId(); }\n        //    catch (UnauthorizedAccessException ex) { return Unauthorized(new { message = ex.Message }); }\n\n        //    var result = await _messageEngineService.SendVideoTemplateMessageAsync(dto, businessId);\n        //    return result.Successin\n        //        ? Ok(new { message = result.Message, raw = result.RawResponse })\n        //        : BadRequest(new { message = result.Message, raw = result.RawResponse });\n        //}\n\n        [HttpGet(\"recent\")]\n        public async Task<IActionResult> GetRecentLogs([FromQuery] int limit = 20)\n        {\n            var businessId = User.GetBusinessId();\n            var logs = await _messageAnalyticsServiceervice.GetRecentLogsAsync(businessId, limit);\n            return Ok(new { success = true, data = logs });\n        }\n\n    }\n}"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/AutoSendTemplateMessageDto.cs",
      "sha256": "99519bdaed8df38337d3485148cfc53b4972c2616ebb386417321455ad582576",
      "language": "csharp",
      "size": 422,
      "content": "namespace xbytechat.api.Features.MessagesEngine.DTOs\n{\n    public class AutoSendTemplateMessageDto\n    {\n        public Guid BusinessId { get; set; }\n        public Guid ContactId { get; set; }\n        public string PhoneNumber { get; set; }\n        public Guid TemplateId { get; set; }\n        public string TemplateName { get; set; }\n        public Dictionary<string, string> Placeholders { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/CtaButtonDto.cs",
      "sha256": "60ecf5aa33d787f635ef05f11c48b8f9f6a11d48b2d7322f7f2ef575b91f9657",
      "language": "csharp",
      "size": 307,
      "content": "namespace xbytechat.api.Features.MessagesEngine.DTOs\n{\n    public class CtaButtonDto\n    {\n        public string Title { get; set; } = string.Empty; // e.g., \"Buy Now\", \"View Details\"\n        public string Type { get; set; } = string.Empty;\n        public string Value { get; set; } = string.Empty;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/DocumentTemplateDto.cs",
      "sha256": "bbda0a8069d8f5d2cd55009d1276b85f5ba6bd077a0c8c41cb055431dbed2507",
      "language": "csharp",
      "size": 161,
      "content": "namespace xbytechat.api.Features.MessagesEngine.DTOs\n{\n    public class DocumentTemplateDto\n    {\n        public string? HeaderDocumentUrl { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/DocumentTemplateMessageDto.cs",
      "sha256": "d1661773f6bc14badc4979362169c3170319abbebf19ca7b004eecab4a377a1f",
      "language": "csharp",
      "size": 1813,
      "content": "using System;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.CampaignModule.DTOs; // for CampaignButtonDto in this folder\n\nnamespace xbytechat.api.Features.CampaignModule.DTOs\n{\n    /// <summary>\n    /// Payload for sending a template with a DOCUMENT header.\n    /// Aliases provided so code using Parameters/Buttons OR TemplateParameters/ButtonParameters compiles.\n    /// </summary>\n    public sealed class DocumentTemplateMessageDto\n    {\n        public Guid BusinessId { get; set; }\n\n        // Routing / provider\n        public string? Provider { get; set; }            // \"META\" | \"PINNACLE\"\n        public string? PhoneNumberId { get; set; }       // Meta WABA phone id (sender)\n\n        // Recipient & template identity\n        public string RecipientNumber { get; set; } = \"\"; // E.164\n        public string TemplateName { get; set; } = \"\";\n        public string LanguageCode { get; set; } = \"en_US\";\n\n        // Header\n        public string? HeaderDocumentUrl { get; set; }\n\n        // Body params (ordered {{1}}..)\n        public List<string> Parameters { get; set; } = new();\n        // Alias for older call sites\n        public List<string> TemplateParameters\n        {\n            get => Parameters;\n            set => Parameters = value ?? new List<string>();\n        }\n\n        // Buttons (we use your actual CampaignButtonDto: ButtonText, ButtonType, TargetUrl)\n        public List<CampaignButtonDto> Buttons { get; set; } = new();\n        // Alias for older call sites\n        public List<CampaignButtonDto> ButtonParameters\n        {\n            get => Buttons;\n            set => Buttons = value ?? new List<CampaignButtonDto>();\n        }\n\n        // Optional extras\n        public Guid? CTAFlowConfigId { get; set; }\n        public string? TemplateBody { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/ImageTemplateMessageDto.cs",
      "sha256": "471132fb66303d77584686def7af22e2365d5b68d32a950f9582f245c966452c",
      "language": "csharp",
      "size": 861,
      "content": "using System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\npublic class ImageTemplateMessageDto\n{\n    public Guid BusinessId { get; set; }\n    public string RecipientNumber { get; set; }\n    public string TemplateName { get; set; }\n    public string LanguageCode { get; set; } = \"en_US\";\n    public string HeaderImageUrl { get; set; }\n    public List<string> TemplateParameters { get; set; } = new();\n    public List<CampaignButtonDto> ButtonParameters { get; set; } = new();\n\n    // ‚úÖ Add these two for flow tracking\n    public Guid? CTAFlowConfigId { get; set; }\n    public Guid? CTAFlowStepId { get; set; }\n    public string? TemplateBody { get; set; }\n\n\n   // [RegularExpression(\"^(PINNACLE|META_CLOUD)$\")]\n    public string Provider { get; set; } = string.Empty;\n    public string? PhoneNumberId { get; set; }\n   \n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/MessageTypeEnum.cs",
      "sha256": "d3120f117dc16b8ab9901ba3726defab664b2a9b4a5414eff586e7e27f55062a",
      "language": "csharp",
      "size": 286,
      "content": "using System.Text.Json.Serialization;\n\nnamespace xbytechat.api.Features.MessagesEngine.DTOs\n{\n    [JsonConverter(typeof(JsonStringEnumConverter))] // Enables string parsing in JSON\n    public enum MessageTypeEnum\n    {\n        Text,\n        Image,\n        Template,\n        Cta\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/SendMessageDto.cs",
      "sha256": "5121018135042d9cdd9a4a404307559a8024ffa4bc1b851f346690fedb544886",
      "language": "csharp",
      "size": 2059,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.MessagesEngine.DTOs.Validation;\n\nnamespace xbytechat.api.Features.MessagesEngine.DTOs\n{\n    [ValidateMessageDto] // ‚úÖ Custom validator will enforce conditional field rules\n    public class SendMessageDto\n    {\n        [Required]\n        public Guid BusinessId { get; set; }\n\n        [Required]\n        [Phone]\n        public string RecipientNumber { get; set; } = string.Empty;\n\n        [Required]\n        public MessageTypeEnum MessageType { get; set; }\n\n        // üìù Text Message\n        public string? TextContent { get; set; }\n\n        // üñºÔ∏è Image Message\n        public string? MediaUrl { get; set; }\n\n        // üìã Template Message\n        public string? TemplateName { get; set; }\n        public Dictionary<string, string>? TemplateParameters { get; set; }\n\n        // üõí CTA Message\n        public List<CtaButtonDto>? CtaButtons { get; set; }\n\n        // ‚úÖ Required: this was missing [Optional but needed for CTA/Template message sending]\n        public List<string>? ButtonParams { get; set; }\n\n        // üìä Optional Metadata\n        public Guid? CampaignId { get; set; }\n        public Guid? CTAFlowConfigId { get; set; }\n        public Guid? CTAFlowStepId { get; set; }\n\n        public string? SourceModule { get; set; }\n        public string? CustomerId { get; set; }\n        public string? CustomerName { get; set; }\n        public string? CustomerPhone { get; set; }\n        public string? BotId { get; set; }\n        public string? RefMessageId { get; set; }\n        public string? CTATriggeredFrom { get; set; }\n        public DateTime? ScheduledAt { get; set; }\n\n        // ‚úÖ Add these two for flow tracking\n        public string? TemplateBody { get; set; }  // üî• Used to render actual message body from placeholders\n\n      //  [RegularExpression(\"^(PINNACLE|META_CLOUD)$\")]\n        public string Provider { get; set; } = string.Empty;\n\n        public string? PhoneNumberId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/SendTemplateMessageSimpleDto.cs",
      "sha256": "00dc74bb6a1b396bab6fcd63f93454cfd59671260c4da8b0afd8754e83e10ce8",
      "language": "csharp",
      "size": 478,
      "content": "namespace xbytechat.api.Features.MessagesEngine.DTOs\n{\n    public class SendTemplateMessageSimpleDto\n    {\n        public Guid BusinessId { get; set; }\n        public string RecipientNumber { get; set; }\n        public string TemplateName { get; set; }\n        public List<string> TemplateParameters { get; set; } = new();\n        // ‚úÖ Add these two for flow tracking\n        public Guid? CTAFlowConfigId { get; set; }\n        public Guid? CTAFlowStepId { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/SimpleTemplateMessageDto.cs",
      "sha256": "59b0c0322fc51f0bf8e9cfea8bddb61c89dfbbe10ff5f04c1b5d033409bb624c",
      "language": "csharp",
      "size": 1095,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.MessagesEngine.Enums;\n\nnamespace xbytechat.api.Features.MessagesEngine.DTOs\n{\n    public class SimpleTemplateMessageDto\n    {\n        //public Guid BusinessId { get; set; }\n\n        public string RecipientNumber { get; set; }\n\n        public string TemplateName { get; set; }\n\n        public List<string> TemplateParameters { get; set; } = new();\n        public bool HasStaticButtons { get; set; } = false;\n\n       // [RegularExpression(\"^(PINNACLE|META_CLOUD)$\")]\n        public string Provider { get; set; } = string.Empty;\n        public string? PhoneNumberId { get; set; }\n        // ‚úÖ Add these two for flow tracking\n        public Guid? CTAFlowConfigId { get; set; }\n        public Guid? CTAFlowStepId { get; set; }\n        public string? TemplateBody { get; set; }  // üî• Used to render actual message body from placeholders\n\n        public string? LanguageCode { get; set; }\n        public DeliveryMode DeliveryMode { get; set; } = DeliveryMode.Queue;\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/TemplateForUIResponseDto.cs",
      "sha256": "8598c768ad7f753c61a4a2c296a18db6285c872705ca0b16a479b5d5bdedde55",
      "language": "csharp",
      "size": 626,
      "content": "using xbytechat.api.WhatsAppSettings.DTOs;\n\npublic class TemplateForUIResponseDto\n{\n    public string Name { get; set; }\n    public string Language { get; set; }\n    public string Body { get; set; }\n\n    // ‚úÖ Correct naming for frontend\n    public int ParametersCount { get; set; }\n\n    public List<ButtonMetadataDto> ButtonParams { get; set; }\n    public bool HasImageHeader { get; set; } // üÜï Used to detect image templates\n\n    public string? HeaderKind { get; set; }          // \"text\" | \"image\" | \"video\" | \"document\" | \"none\"\n    public bool RequiresHeaderMediaUrl { get; set; } // true for image/video/document\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/TextMessageSendDto.cs",
      "sha256": "ac840891c791dd1b7c45b920ce2db245ce63eb12364e3a606b492c053268da6c",
      "language": "csharp",
      "size": 847,
      "content": "using System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat.api.Features.MessagesEngine.DTOs\n{\n    public class TextMessageSendDto\n    {\n        public Guid BusinessId { get; set; }\n\n        public string RecipientNumber { get; set; }\n\n        public string TextContent { get; set; }\n\n        public Guid ContactId { get; set; }\n\n        public string? PhoneNumberId { get; set; }\n        // ‚úÖ NEW: Optional source indicator (e.g., \"campaign\", \"auto-reply\", etc.)\n\n        //[RegularExpression(\"^(PINNACLE|META_CLOUD)$\")]\n        //[Required]\n        public string Provider { get; set; } = string.Empty;\n        public string? Source { get; set; }\n\n        // ‚úÖ NEW: Optional message ID for campaign tracing\n        public string? MessageId { get; set; }\n\n        public bool IsSaveContact { get; set; } = false; // default true\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/DTOs/VideoTemplateMessageDto.cs",
      "sha256": "57c4f2a9a6c884efb7c3ec74c8674e04482aaaa04428ab6232a7ea3db1adc043",
      "language": "csharp",
      "size": 941,
      "content": "using System;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\npublic class VideoTemplateMessageDto\n{\n    public Guid BusinessId { get; set; }\n    public string RecipientNumber { get; set; } = string.Empty;\n\n    public string TemplateName { get; set; } = string.Empty;\n    public string LanguageCode { get; set; } = \"en_US\";\n\n    // mirrors HeaderImageUrl\n    public string? HeaderVideoUrl { get; set; }\n\n    public List<string> TemplateParameters { get; set; } = new();\n    public List<CampaignButtonDto> ButtonParameters { get; set; } = new();\n\n    // for flow tracking parity\n    public Guid? CTAFlowConfigId { get; set; }\n    public Guid? CTAFlowStepId { get; set; }\n    public string? TemplateBody { get; set; }\n\n    // same explicit provider knobs you already use\n    public string Provider { get; set; } = string.Empty; // \"PINNACLE\" | \"META_CLOUD\"\n    public string? PhoneNumberId { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Enums/DeliveryMode.cs",
      "sha256": "34b987a3b5ca838182dc0aeec507b3ed1a0641adc6c0aac7167feb2336f9e80d",
      "language": "csharp",
      "size": 501,
      "content": "using System.Collections;\n\nnamespace xbytechat.api.Features.MessagesEngine.Enums\n{\n    public enum DeliveryMode\n    {\n        /// <summary>\n        /// Default behaviour: enqueue into Outbox/worker.\n        /// Use this for campaigns, bulk sends, and scheduled jobs.\n        /// </summary>\n        Queue = 0,\n\n        /// <summary>\n        /// High-priority conversational sends:\n        /// call the WhatsApp provider directly inside the request.\n        /// </summary>\n        Immediate = 1\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Factory/IWhatsAppProviderFactory.cs",
      "sha256": "342d4ace84b80c735c364b8ff654502fff27f1bfeb70eb78d5469879ec57ce1f",
      "language": "csharp",
      "size": 578,
      "content": "using System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.MessagesEngine.Abstractions;\n\nnamespace xbytechat.api.Features.MessagesEngine.Factory\n{\n    public interface IWhatsAppProviderFactory\n    {\n        //Task<IWhatsAppProvider> CreateAsync(Guid businessId, CancellationToken ct = default);\n        Task<IWhatsAppProvider> CreateAsync(Guid businessId);\n       //Task<IWhatsAppProvider> CreateAsync(Guid businessId, string? phoneNumberId);\n        Task<IWhatsAppProvider> CreateAsync(Guid businessId, string provider, string? phoneNumberId);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Factory/WhatsAppProviderFactory.cs",
      "sha256": "4277e6669492d91b902efa2b8002e0f31b0523da3c9f5f3edbb7ff45d0462513",
      "language": "csharp",
      "size": 11987,
      "content": "using System;\nusing System.Net.Http;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.DependencyInjection;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.MessagesEngine.Abstractions;\nusing xbytechat.api.Features.MessagesEngine.Providers;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing static System.Net.WebRequestMethods;\nusing static System.Runtime.InteropServices.JavaScript.JSType;\n\nnamespace xbytechat.api.Features.MessagesEngine.Factory\n{\n    public class WhatsAppProviderFactory : IWhatsAppProviderFactory\n    {\n        private readonly IServiceProvider _sp;\n        private readonly AppDbContext _db;\n        private readonly ILogger<WhatsAppProviderFactory> _logger;\n\n        public WhatsAppProviderFactory(IServiceProvider sp, AppDbContext db, ILogger<WhatsAppProviderFactory> logger)\n        {\n            _sp = sp;\n            _db = db;\n            _logger = logger;\n        }\n\n        //public async Task<IWhatsAppProvider> CreateAsync(Guid businessId)\n        //{\n        //    var setting = await _db.WhatsAppSettings\n        //        .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive)\n        //        ?? throw new InvalidOperationException(\"WhatsApp settings not found for this business.\");\n\n        //    var providerKey = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n\n        //    using var scope = _sp.CreateScope();\n\n        //    var httpClientFactory = scope.ServiceProvider.GetService<IHttpClientFactory>();\n        //    var http =\n        //        httpClientFactory != null\n        //            ? httpClientFactory.CreateClient(providerKey == \"meta_cloud\" ? \"wa:meta_cloud\" : \"wa:pinnacle\")\n        //            : scope.ServiceProvider.GetRequiredService<HttpClient>();\n\n        //    return providerKey switch\n        //    {\n        //        //\"pinnacle\" =>\n        //        //            new PinnacleProvider(http, scope.ServiceProvider.GetRequiredService<ILogger<PinnacleProvider>>(), setting),\n        //        \"pinnacle\" => new PinnacleProvider(http, scope.ServiceProvider.GetRequiredService<ILogger<PinnacleProvider>>(), setting),\n        //        \"meta_cloud\" =>\n        //            new MetaCloudProvider(_db, http, scope.ServiceProvider.GetRequiredService<ILogger<MetaCloudProvider>>(), setting),\n\n        //        _ => throw new NotSupportedException($\"Unsupported WhatsApp provider: {providerKey}\")\n        //    };\n        //}\n\n\n\n        //public async Task<IWhatsAppProvider> CreateAsync(Guid businessId, string? phoneNumberId)\n        //{\n        //    var setting = await _db.WhatsAppSettings\n        //        .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive)\n        //        ?? throw new InvalidOperationException(\"WhatsApp settings not found for this business.\");\n\n        //    // per-send override of the sender number (in-memory only)\n        //    if (!string.IsNullOrWhiteSpace(phoneNumberId))\n        //        setting.PhoneNumberId = phoneNumberId.Trim();\n\n        //    var providerKey = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n\n        //    using var scope = _sp.CreateScope();\n\n        //    var httpClientFactory = scope.ServiceProvider.GetService<IHttpClientFactory>();\n        //    var http =\n        //        httpClientFactory != null\n        //            ? httpClientFactory.CreateClient(providerKey == \"meta_cloud\" ? \"wa:meta_cloud\" : \"wa:pinnacle\")\n        //            : scope.ServiceProvider.GetRequiredService<HttpClient>();\n\n        //    return providerKey switch\n        //    {\n        //        \"pinnacle\" => new PinnacleProvider(http, scope.ServiceProvider.GetRequiredService<ILogger<PinnacleProvider>>(), setting),\n        //        \"meta_cloud\" => new MetaCloudProvider(_db, http, scope.ServiceProvider.GetRequiredService<ILogger<MetaCloudProvider>>(), setting),\n        //        _ => throw new NotSupportedException($\"Unsupported WhatsApp provider: {providerKey}\")\n        //    };\n        //}\n\n        public async Task<IWhatsAppProvider> CreateAsync(Guid businessId)\n        {\n            var setting = await _db.WhatsAppSettings\n                .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive)\n                ?? throw new InvalidOperationException(\"WhatsApp settings not found for this business.\");\n\n            // Canonical provider: META_CLOUD | PINNACLE (ALL CAPS)\n            var provider = (setting.Provider ?? \"META_CLOUD\")\n                .Trim()\n                .Replace(\"-\", \"_\")\n                .Replace(\" \", \"_\")\n                .ToUpperInvariant();\n\n            using var scope = _sp.CreateScope();\n\n            var httpFactory = scope.ServiceProvider.GetService<IHttpClientFactory>();\n            var clientName = provider == \"META_CLOUD\" ? \"wa:meta_cloud\" : \"wa:pinnacle\"; // named client key\n            var http = httpFactory != null\n                ? httpFactory.CreateClient(clientName)\n                : scope.ServiceProvider.GetRequiredService<HttpClient>();\n\n            switch (provider)\n            {\n                case \"PINNACLE\":\n                    {\n                        // Prefer WABA id; else default active number for PINNACLE\n                        string? pathIdOverride = !string.IsNullOrWhiteSpace(setting.WabaId)\n                            ? setting.WabaId!.Trim()\n                            : await _db.WhatsAppPhoneNumbers\n                                .AsNoTracking()\n                                .Where(p => p.BusinessId == businessId\n                                            && p.IsActive\n                                            && p.Provider.ToUpper() == \"PINNACLE\")\n                                .OrderByDescending(p => p.IsDefault)\n                                .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                                .Select(p => p.PhoneNumberId)\n                                .FirstOrDefaultAsync();\n\n                        return new PinnacleProvider(\n                            _db,\n                            http,\n                            scope.ServiceProvider.GetRequiredService<ILogger<PinnacleProvider>>(),\n                            setting,\n                            pathIdOverride);\n                    }\n\n                case \"META_CLOUD\":\n                    return new MetaCloudProvider(\n                        _db,\n                        http,\n                        scope.ServiceProvider.GetRequiredService<ILogger<MetaCloudProvider>>(),\n                        setting);\n\n                default:\n                    throw new NotSupportedException($\"Unsupported WhatsApp provider: {provider}\");\n            }\n        }\n\n        public async Task<IWhatsAppProvider> CreateAsync(Guid businessId, string provider, string? phoneNumberId)\n        {\n            if (string.IsNullOrWhiteSpace(provider))\n                throw new ArgumentException(\"Provider is required.\", nameof(provider));\n\n            // Canonical provider: PINNACLE | META_CLOUD (ALL CAPS)\n            provider = provider.Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n            if (provider is not (\"PINNACLE\" or \"META_CLOUD\"))\n                throw new NotSupportedException($\"Unsupported provider: {provider}\");\n\n            // If a sender was chosen, ensure it belongs to THIS business+provider\n            if (!string.IsNullOrWhiteSpace(phoneNumberId))\n            {\n                var exists = await _db.WhatsAppPhoneNumbers\n                    .AsNoTracking()\n                    .AnyAsync(n => n.BusinessId == businessId\n                                   && n.Provider.ToUpper() == provider\n                                   && n.PhoneNumberId == phoneNumberId);\n                if (!exists)\n                    throw new InvalidOperationException(\n                        \"Selected PhoneNumberId does not belong to this provider/business.\");\n            }\n\n            // Load the settings row for the exact (BusinessId, Provider)\n            var setting = await _db.WhatsAppSettings\n                .FirstOrDefaultAsync(s => s.BusinessId == businessId\n                                          && s.IsActive\n                                          && s.Provider.ToUpper() == provider)\n                ?? throw new InvalidOperationException(\n                    $\"WhatsApp settings not found for provider {provider}.\");\n\n            if (string.IsNullOrWhiteSpace(setting.ApiUrl))\n                throw new InvalidOperationException(\"API URL is empty. Save provider settings first.\");\n            if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                throw new InvalidOperationException(\"API Key/Token is empty. Save provider settings first.\");\n\n            using var scope = _sp.CreateScope();\n            var http = scope.ServiceProvider\n                .GetRequiredService<IHttpClientFactory>()\n                .CreateClient(provider == \"META_CLOUD\" ? \"wa:meta_cloud\" : \"wa:pinnacle\");\n\n            // NOTE: providers accept optional overrides; do NOT write into settings\n            return provider switch\n            {\n                \"PINNACLE\" => new PinnacleProvider(\n                    _db,\n                    http,\n                    scope.ServiceProvider.GetRequiredService<ILogger<PinnacleProvider>>(),\n                    setting,\n                    pathIdOverride: string.IsNullOrWhiteSpace(phoneNumberId) ? setting.WabaId : phoneNumberId),\n\n                \"META_CLOUD\" => new MetaCloudProvider(\n                    _db,\n                    http,\n                    scope.ServiceProvider.GetRequiredService<ILogger<MetaCloudProvider>>(),\n                    setting,\n                    phoneNumberIdOverride: phoneNumberId),\n\n                _ => throw new NotSupportedException($\"Unsupported provider: {provider}\")\n            };\n        }\n\n    }\n}\n\n\n//// üìÑ File: Features/MessagesEngine/Factory/WhatsAppProviderFactory.cs\n//using System;\n//using System.Threading.Tasks;\n//using Microsoft.EntityFrameworkCore;\n//using Microsoft.Extensions.DependencyInjection;\n//using Microsoft.Extensions.Logging;\n//using xbytechat.api;\n//using xbytechat.api.Features.MessagesEngine.Abstractions;\n//using xbytechat.api.Features.MessagesEngine.Providers;\n\n//namespace xbytechat.api.Features.MessagesEngine.Factory\n//{\n\n//    public class WhatsAppProviderFactory : IWhatsAppProviderFactory\n//    {\n//        private readonly IServiceProvider _sp;\n//        private readonly AppDbContext _db;\n//        private readonly ILogger<WhatsAppProviderFactory> _logger;\n\n//        public WhatsAppProviderFactory(IServiceProvider sp, AppDbContext db, ILogger<WhatsAppProviderFactory> logger)\n//        {\n//            _sp = sp;\n//            _db = db;\n//            _logger = logger;\n//        }\n\n//        public async Task<IWhatsAppProvider> CreateAsync(Guid businessId)\n//        {\n//            var setting = await _db.WhatsAppSettings.FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive)\n//                          ?? throw new InvalidOperationException(\"WhatsApp settings not found for this business.\");\n\n//            var providerKey = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n\n//            // Create a new scope to inject the per-tenant setting into provider constructor\n//            var scope = _sp.CreateScope();\n//            var http = scope.ServiceProvider.GetRequiredService<HttpClient>();\n\n//            return providerKey switch\n//            {\n//                \"pinnacle\" => new PinbotProvider(http, scope.ServiceProvider.GetRequiredService<ILogger<PinbotProvider>>(), setting),\n//                \"meta_cloud\" => new MetaCloudProvider(_db, http, scope.ServiceProvider.GetRequiredService<ILogger<MetaCloudProvider>>(), setting),\n//                _ => throw new NotSupportedException($\"Unsupported WhatsApp provider: {providerKey}\")\n//            };\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Outbox/OutboxMessage.cs",
      "sha256": "caa5c09bc7c28e6aaa5bb1aa93cd76f38c41f5c2754790d9c45f6af037ed1a25",
      "language": "csharp",
      "size": 1109,
      "content": "using System;\n\nnamespace xbytechat.api.Features.MessagesEngine.Outbox\n{\n    public enum OutboxStatus\n    {\n        Queued = 0,\n        Sending = 1,\n        Sent = 2,\n        Failed = 3\n    }\n\n    public class OutboxMessage\n    {\n        public Guid Id { get; set; }\n        public Guid BusinessId { get; set; }\n        public Guid? CampaignId { get; set; }\n        public Guid? ContactId { get; set; }\n\n        public string RecipientNumber { get; set; } = \"\";\n        public string ProviderKey { get; set; } = \"\"; // \"meta_cloud\" | \"pinnacle\" (optional hint)\n        public string PayloadJson { get; set; } = \"\"; // serialized MessageEnvelope\n        public string CorrelationId { get; set; } = \"\"; // for idempotency & tracing\n\n        public OutboxStatus Status { get; set; } = OutboxStatus.Queued;\n        public int AttemptCount { get; set; }\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime? NextAttemptAt { get; set; } = DateTime.UtcNow;\n        public string? LastError { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/CtaMessagePayloadBuilder.cs",
      "sha256": "f23794fdb8775eff63c5d249f23e74b7ff5e4497daa7b255ce94693b3ba9a6f7",
      "language": "csharp",
      "size": 1063,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public class CtaMessagePayloadBuilder : IWhatsAppPayloadBuilder\n    {\n        public object BuildPayload(SendMessageDto dto)\n        {\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = dto.RecipientNumber,\n                type = \"interactive\",\n                interactive = new\n                {\n                    type = \"button\",\n                    body = new { text = dto.TextContent },\n                    action = new\n                    {\n                        buttons = dto.CtaButtons?.Select(b => new\n                        {\n                            type = \"reply\",\n                            reply = new\n                            {\n                                id = b.Value,\n                                title = b.Title\n                            }\n                        }).ToList()\n                    }\n                }\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/ImageMessagePayloadBuilder.cs",
      "sha256": "1400148a9ed0b32af7ece6c87b111a1407feda0f5b651819257c5b740bb01106",
      "language": "csharp",
      "size": 554,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public class ImageMessagePayloadBuilder : IWhatsAppPayloadBuilder\n    {\n        public object BuildPayload(SendMessageDto dto)\n        {\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = dto.RecipientNumber,\n                type = \"image\",\n                image = new\n                {\n                    link = dto.MediaUrl\n                }\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/IWhatsAppPayloadBuilder.cs",
      "sha256": "89d6b688ba597eb931cd71401717698a692f3e3b645a02d60c1d73dae24731d3",
      "language": "csharp",
      "size": 225,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public interface IWhatsAppPayloadBuilder\n    {\n        object BuildPayload(SendMessageDto dto);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/MessagePayloadBuilder.cs",
      "sha256": "ec8606e744a878efdd7f12dadcc799b2aaf290e66c9e419f639672d0003b4bd0",
      "language": "csharp",
      "size": 7842,
      "content": "// Features/MessagesEngine/PayloadBuilders/MessagePayloadBuilder.cs\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public static class MessagePayloadBuilder\n    {\n        // New: a single canonical builder that understands our CSV-materialized shapes.\n        public static object BuildTemplatePayload(\n            string toPhoneE164,\n            string templateName,\n            string languageCode,\n            string headerType,                 // \"none\"|\"text\"|\"image\"|\"video\"|\"document\"\n            string? headerMediaUrl,            // for image/video/document\n            IReadOnlyList<string> bodyParams,  // {{1}}..{{N}}\n            IReadOnlyList<string>? headerTextParams, // header text {{n}} if headerType==\"text\"\n            IReadOnlyDictionary<string, string>? buttonUrlParams // keys: \"button1.url_param\"..\"button3.url_param\"\n        )\n        {\n            var components = new List<object>();\n\n            // 1) HEADER\n            switch ((headerType ?? \"none\").ToLowerInvariant())\n            {\n                case \"text\":\n                    if (headerTextParams != null && headerTextParams.Count > 0)\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = headerTextParams.Select(v => new { type = \"text\", text = v ?? string.Empty }).ToArray()\n                        });\n                    }\n                    break;\n\n                case \"image\":\n                    if (!string.IsNullOrWhiteSpace(headerMediaUrl))\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = new object[]\n                            {\n                                new { type = \"image\", image = new { link = headerMediaUrl } }\n                            }\n                        });\n                    }\n                    break;\n\n                case \"video\":\n                    if (!string.IsNullOrWhiteSpace(headerMediaUrl))\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = new object[]\n                            {\n                                new { type = \"video\", video = new { link = headerMediaUrl } }\n                            }\n                        });\n                    }\n                    break;\n\n                case \"document\":\n                    if (!string.IsNullOrWhiteSpace(headerMediaUrl))\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = new object[]\n                            {\n                                new { type = \"document\", document = new { link = headerMediaUrl } }\n                            }\n                        });\n                    }\n                    break;\n            }\n\n            // 2) BODY\n            if (bodyParams != null && bodyParams.Count > 0)\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = bodyParams.Select(v => new { type = \"text\", text = v ?? string.Empty }).ToArray()\n                });\n            }\n\n            // 3) BUTTONS (URL dynamic only)\n            // Expect buttonUrlParams: button{1..3}.url_param -> string\n            if (buttonUrlParams != null && buttonUrlParams.Count > 0)\n            {\n                var buttons = new List<object>();\n\n                for (var pos = 1; pos <= 3; pos++)\n                {\n                    var key = $\"button{pos}.url_param\";\n                    if (buttonUrlParams.TryGetValue(key, out var val) && !string.IsNullOrWhiteSpace(val))\n                    {\n                        buttons.Add(new\n                        {\n                            type = \"button\",\n                            sub_type = \"url\",\n                            index = pos - 1, // Meta expects 0-based index\n                            parameters = new object[]\n                            {\n                                new { type = \"text\", text = val }\n                            }\n                        });\n                    }\n                }\n\n                if (buttons.Count > 0)\n                {\n                    components.AddRange(buttons);\n                }\n            }\n\n            // Meta/Pinnacle style template envelope\n            var payload = new\n            {\n                messaging_product = \"whatsapp\",\n                to = toPhoneE164,\n                type = \"template\",\n                template = new\n                {\n                    name = templateName,\n                    language = new { code = languageCode }, // << not hardcoded\n                    components = components.ToArray()\n                }\n            };\n\n            return payload;\n        }\n    }\n}\n\n\n//using xbytechat.api.Features.CampaignModule.Models;\n//using xbytechat.api.Shared.utility;\n\n//namespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n//{\n//    public static class MessagePayloadBuilder\n//    {\n//        /// <summary>\n//        /// Builds a WhatsApp template message payload for image header + buttons.\n//        /// </summary>\n//        public static object BuildImageTemplatePayload(\n//            string templateName,\n//            string languageCode,\n//            string recipientNumber,\n//            List<string> templateParams,\n//            string? imageUrl,\n//            List<CampaignButton>? buttons\n//        )\n//        {\n//            var components = new List<object>();\n\n//            // ‚úÖ Body with template params\n//            if (templateParams != null && templateParams.Any())\n//            {\n//                components.Add(new\n//                {\n//                    type = \"body\",\n//                    parameters = templateParams.Select(p => new { type = \"text\", text = p }).ToArray()\n//                });\n//            }\n\n//            // ‚úÖ Header image if present\n//            if (!string.IsNullOrWhiteSpace(imageUrl))\n//            {\n//                components.Add(new\n//                {\n//                    type = \"header\",\n//                    parameters = new[]\n//                    {\n//                    new { type = \"image\", image = new { link = imageUrl } }\n//                }\n//                });\n//            }\n\n//            // ‚úÖ CTA buttons\n//            if (buttons != null && buttons.Any())\n//            {\n//                var buttonComponents = buttons\n//                    .OrderBy(b => b.Position)\n//                    .Take(3)\n//                    .Select((btn, index) => new\n//                    {\n//                        type = \"button\",\n//                        sub_type = btn.Type, // \"url\" or \"phone_number\"\n//                        index = index.ToString(),\n//                        parameters = new[]\n//                        {\n//                        new { type = \"text\", text = btn.Value }\n//                        }\n//                    });\n\n//                components.AddRange(buttonComponents);\n//            }\n\n//            // ‚úÖ Final WhatsApp Template Payload\n//            return new\n//            {\n//                messaging_product = \"whatsapp\",\n//                to = recipientNumber,\n//                type = \"template\",\n//                template = new\n//                {\n//                    name = templateName,\n//                    language = new { code = languageCode },\n//                    components = components\n//                }\n//            };\n//        }\n//    }\n\n//}"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/TemplateMessagePayloadBuilder.cs",
      "sha256": "1beb36776f57bf30bf67df07af07052f4d5fe2609dfe6a4015bf512dff64aee8",
      "language": "csharp",
      "size": 5342,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public class TemplateMessagePayloadBuilder : IWhatsAppPayloadBuilder\n    {\n        public object BuildPayload(SendMessageDto dto)\n        {\n            if (dto == null) throw new ArgumentNullException(nameof(dto));\n            if (string.IsNullOrWhiteSpace(dto.TemplateName))\n                throw new ArgumentException(\"TemplateName is required.\");\n            if (dto.TemplateParameters == null || dto.TemplateParameters.Count == 0)\n                throw new ArgumentException(\"TemplateParameters are required for template messages.\");\n\n            // Sort by placeholder index like {{1}}, {{2}}, guarding against bad keys\n            var bodyParams = dto.TemplateParameters\n                .Select(kvp =>\n                {\n                    var key = kvp.Key?.Trim('{', '}');\n                    _ = int.TryParse(key, out var idx);\n                    return (idx, kvp.Value);\n                })\n                .OrderBy(t => t.idx)\n                .Select(t => new { type = \"text\", text = t.Value })\n                .ToArray();\n\n            var components = new List<object>\n            {\n                new { type = \"body\", parameters = bodyParams }\n            };\n\n            if (dto.ButtonParams != null && dto.ButtonParams.Any())\n            {\n                for (int i = 0; i < dto.ButtonParams.Count; i++)\n                {\n                    components.Add(new\n                    {\n                        type = \"button\",\n                        sub_type = \"url\",\n                        index = i.ToString(),\n                        parameters = new[]\n                        {\n                            new { type = \"text\", text = dto.ButtonParams[i] }\n                        }\n                    });\n                }\n            }\n\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = dto.RecipientNumber,\n                type = \"template\",\n                template = new\n                {\n                    name = dto.TemplateName,\n                    language = new { code = \"en_US\" },\n                    components\n                }\n            };\n        }\n    }\n}\n\n\n//using xbytechat.api.Features.MessagesEngine.DTOs;\n//using xbytechat.api.Helpers;\n\n//namespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n//{\n//    public class TemplateMessagePayloadBuilder : IWhatsAppPayloadBuilder\n//    {\n//        public object BuildPayload(SendMessageDto dto)\n//        {\n//            var components = new List<object>();\n\n//            // ‚úÖ BODY PARAMETERS: Insert dynamic values into the template body\n//            // WhatsApp expects these to be in order ({{1}}, {{2}}, etc.)\n//            if (dto.TemplateParameters == null || dto.TemplateParameters.Count == 0)\n//                return ResponseResult.ErrorInfo(\"‚ùå Missing template parameters.\");\n//            if (dto.TemplateParameters != null && dto.TemplateParameters.Any())\n//                {\n//                var bodyParams = dto.TemplateParameters\n//                    .OrderBy(kvp => int.Parse(kvp.Key.Trim('{', '}'))) // üî¢ Extract and sort by index\n//                    .Select(kvp => new\n//                    {\n//                        type = \"text\",\n//                        text = kvp.Value\n//                    }).ToArray();\n\n//                components.Add(new\n//                {\n//                    type = \"body\",\n//                    parameters = bodyParams\n//                });\n//            }\n\n//            // ‚úÖ BUTTON PARAMETERS: For templates with dynamic URL buttons (index-based)\n//            if (dto.ButtonParams != null && dto.ButtonParams.Any())\n//            {\n//                for (int i = 0; i < dto.ButtonParams.Count; i++)\n//                {\n//                    components.Add(new\n//                    {\n//                        type = \"button\",\n//                        sub_type = \"url\",\n//                        index = i.ToString(), // WhatsApp requires index as a string\n//                        parameters = new[]\n//                        {\n//                            new\n//                            {\n//                                type = \"text\",\n//                                text = dto.ButtonParams[i]\n//                            }\n//                        }\n//                    });\n//                }\n//            }\n\n//            // ‚úÖ FINAL WHATSAPP TEMPLATE PAYLOAD\n//            var payload = new\n//            {\n//                messaging_product = \"whatsapp\",\n//                to = dto.RecipientNumber,\n//                type = \"template\",\n//                template = new\n//                {\n//                    name = dto.TemplateName,\n//                    language = new { code = \"en_US\" },\n//                    components = components\n//                }\n//            };\n\n//            // ü™µ Debug log for developer console (optional)\n//            Console.WriteLine(\"üì¶ Built WhatsApp Template Payload:\");\n//            Console.WriteLine(System.Text.Json.JsonSerializer.Serialize(payload, new System.Text.Json.JsonSerializerOptions\n//            {\n//                WriteIndented = true\n//            }));\n\n//            return payload;\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/TemplateStaticButtonPayloadBuilder.cs",
      "sha256": "68979e5fa2d53ce3fa319c20377ca2022bf9e46b7244c817fb53f84594392f72",
      "language": "csharp",
      "size": 1397,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public class TemplateStaticButtonPayloadBuilder\n    {\n        public static object Build(SendTemplateMessageSimpleDto dto)\n        {\n            var components = new List<object>();\n\n            // ‚úÖ Add Body Params\n            if (dto.TemplateParameters != null && dto.TemplateParameters.Any())\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = dto.TemplateParameters.Select(p => new\n                    {\n                        type = \"text\",\n                        text = p\n                    }).ToArray()\n                });\n            }\n\n            // ‚ö†Ô∏è DO NOT add button components for static buttons\n            // Meta will render them automatically if template has static buttons defined\n            // You can later add logic here for dynamic buttons if needed\n\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = dto.RecipientNumber,\n                type = \"template\",\n                template = new\n                {\n                    name = dto.TemplateName,\n                    language = new { code = \"en_US\" },\n                    components = components\n                }\n            };\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/PayloadBuilders/TextMessagePayloadBuilder.cs",
      "sha256": "abc17e5a60e2f58ba07c610db126262040f598a15aca27d2f85d52afc2fb4766",
      "language": "csharp",
      "size": 554,
      "content": "using xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.PayloadBuilders\n{\n    public class TextMessagePayloadBuilder : IWhatsAppPayloadBuilder\n    {\n        public object BuildPayload(SendMessageDto dto)\n        {\n            return new\n            {\n                messaging_product = \"whatsapp\",\n                to = dto.RecipientNumber,\n                type = \"text\",\n                text = new\n                {\n                    body = dto.TextContent\n                }\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Providers/MetaCloudProvider.cs",
      "sha256": "0bcab60a10252b65d74e289fbbc539e500374db9c0f3c72e405d1b60fe8b1ed0",
      "language": "csharp",
      "size": 6942,
      "content": "// üìÑ File: Features/MessagesEngine/Providers/MetaCloudProvider.cs\nusing System.Collections.Generic;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing System.Text.Json.Nodes;\nusing System.Text.Json.Serialization;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore; // for AsNoTracking()\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api;\nusing xbytechat.api.Features.MessagesEngine.Abstractions;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.MessagesEngine.Providers\n{\n    public class MetaCloudProvider : IWhatsAppProvider\n    {\n        private readonly AppDbContext _db;\n        private readonly HttpClient _http;\n        private readonly ILogger<MetaCloudProvider> _logger;\n        private readonly WhatsAppSettingEntity _setting;\n\n        // Optional per-send override injected by the factory/engine (safe to leave null)\n        private readonly string? _phoneNumberIdOverride;\n\n        private static readonly JsonSerializerOptions _jsonOpts = new()\n        {\n            // camelCase ensures typed models serialize as Meta expects (e.g. `language.code`)\n            PropertyNamingPolicy = JsonNamingPolicy.CamelCase,\n            DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull\n        };\n\n        public MetaCloudProvider(\n            AppDbContext db,\n            HttpClient http,\n            ILogger<MetaCloudProvider> logger,\n            WhatsAppSettingEntity setting,\n            string? phoneNumberIdOverride = null)\n        {\n            _db = db;\n            _http = http;\n            _logger = logger;\n            _setting = setting;\n            _phoneNumberIdOverride = phoneNumberIdOverride;\n        }\n\n        /// <summary>\n        /// Resolve the phone_number_id to use for Meta Cloud:\n        /// 1) explicit override if provided; else\n        /// 2) default active number from WhatsAppPhoneNumbers for this business+provider.\n        /// </summary>\n        private string? ResolvePhoneNumberId()\n        {\n            if (!string.IsNullOrWhiteSpace(_phoneNumberIdOverride))\n                return _phoneNumberIdOverride;\n\n            var providerKey = (_setting.Provider ?? string.Empty).Trim().ToLowerInvariant();\n\n            var pnid = _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == _setting.BusinessId\n                            && n.IsActive\n                            && n.Provider.ToLower() == providerKey)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .Select(n => n.PhoneNumberId)\n                .FirstOrDefault();\n\n            return pnid;\n        }\n\n        private string BuildUrl()\n        {\n            var baseUrl = string.IsNullOrWhiteSpace(_setting.ApiUrl)\n                ? \"https://graph.facebook.com/v22.0\"\n                : _setting.ApiUrl.TrimEnd('/');\n\n            var phoneNumberId = ResolvePhoneNumberId();\n            if (string.IsNullOrWhiteSpace(phoneNumberId))\n            {\n                _logger.LogError(\"MetaCloudProvider: PhoneNumberId is missing for BusinessId {BusinessId}\", _setting.BusinessId);\n                return $\"{baseUrl}/-/messages\"; // inert path; request will fail with clear logs\n            }\n\n            return $\"{baseUrl}/{phoneNumberId}/messages\";\n        }\n\n        /// <summary>\n        /// Recursively remove any `$type` discriminator properties from a JsonNode tree.\n        /// Meta rejects unknown keys like `$type` inside template.components[*].\n        /// </summary>\n        private static void StripDollarType(JsonNode? node)\n        {\n            if (node is null) return;\n\n            if (node is JsonObject obj)\n            {\n                if (obj.ContainsKey(\"$type\"))\n                    obj.Remove(\"$type\");\n\n                // safe enumeration snapshot\n                foreach (var kv in obj.ToList())\n                    StripDollarType(kv.Value);\n            }\n            else if (node is JsonArray arr)\n            {\n                foreach (var child in arr)\n                    StripDollarType(child);\n            }\n        }\n\n        private async Task<WaSendResult> PostAsync(object payload)\n        {\n            var url = BuildUrl();\n\n            // Sanitize payload to remove any $type injected by polymorphic models\n            var node = JsonSerializer.SerializeToNode(payload, _jsonOpts);\n            StripDollarType(node);\n            var json = node?.ToJsonString(_jsonOpts) ?? \"{}\";\n\n            using var req = new HttpRequestMessage(HttpMethod.Post, url)\n            {\n                Content = new StringContent(json, Encoding.UTF8, \"application/json\")\n            };\n            req.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue(\"application/json\"));\n\n            if (!string.IsNullOrWhiteSpace(_setting.ApiKey))\n            {\n                req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", _setting.ApiKey);\n            }\n            else\n            {\n                _logger.LogWarning(\"MetaCloudProvider: ApiToken is empty for BusinessId {BusinessId}\", _setting.BusinessId);\n            }\n\n            var res = await _http.SendAsync(req);\n            var body = await res.Content.ReadAsStringAsync();\n\n            if (!res.IsSuccessStatusCode)\n            {\n                _logger.LogWarning(\"MetaCloud send failed (HTTP {Status}): {Body}\", (int)res.StatusCode, body);\n                return new WaSendResult(false, \"MetaCloud\", null, res.StatusCode, body, res.ReasonPhrase);\n            }\n\n            string? id = null;\n            try\n            {\n                var root = JsonNode.Parse(body);\n                id = root?[\"messages\"]?[0]?[\"id\"]?.GetValue<string>();\n            }\n            catch { /* keep raw */ }\n\n            return new WaSendResult(true, \"MetaCloud\", id, res.StatusCode, body, null);\n        }\n\n        public Task<WaSendResult> SendTextAsync(string to, string body)\n            => PostAsync(new\n            {\n                messaging_product = \"whatsapp\",\n                to,\n                type = \"text\",\n                text = new { preview_url = false, body }\n            });\n\n        public Task<WaSendResult> SendTemplateAsync(string to, string templateName, string languageCode, IEnumerable<object> components)\n            => PostAsync(new\n            {\n                messaging_product = \"whatsapp\",\n                to,\n                type = \"template\",\n                template = new\n                {\n                    name = templateName,\n                    language = new { code = languageCode }, // Meta expects { \"code\": \"en_US\" }\n                    components = components ?? System.Linq.Enumerable.Empty<object>()\n                }\n            });\n\n        public Task<WaSendResult> SendInteractiveAsync(object fullPayload)\n            => PostAsync(fullPayload);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Providers/PinnacleProvider.cs",
      "sha256": "d803171cd01474f2c03261a8db09e547472a5af8272ca59d08eaffe95990051f",
      "language": "csharp",
      "size": 8325,
      "content": "// üìÑ File: Features/MessagesEngine/Providers/PinnacleProvider.cs\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing System.Text.Json.Serialization;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api;\nusing xbytechat.api.Features.MessagesEngine.Abstractions;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.MessagesEngine.Providers\n{\n    public class PinnacleProvider : IWhatsAppProvider\n    {\n        private readonly AppDbContext _db;\n        private readonly HttpClient _http;\n        private readonly ILogger<PinnacleProvider> _logger;\n        private readonly WhatsAppSettingEntity _setting;\n\n        // optional per-send override (phone_number_id or wabaId path segment)\n        private readonly string? _pathIdOverride;\n\n        private static readonly JsonSerializerOptions _jsonOpts = new()\n        {\n            DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull\n        };\n\n        public PinnacleProvider(\n            AppDbContext db,\n            HttpClient http,\n            ILogger<PinnacleProvider> logger,\n            WhatsAppSettingEntity setting,\n            string? pathIdOverride = null)\n        {\n            _db = db;\n            _http = http;\n            _logger = logger;\n            _setting = setting;\n            _pathIdOverride = pathIdOverride;\n        }\n\n        /// <summary>\n        /// Resolve the path identifier used by Pinnacle: prefer explicit override,\n        /// then WabaId from settings, then PhoneNumberId from WhatsAppPhoneNumbers.\n        /// </summary>\n        private string? ResolvePathIdOrNull()\n        {\n            if (!string.IsNullOrWhiteSpace(_pathIdOverride))\n                return _pathIdOverride;\n\n            if (!string.IsNullOrWhiteSpace(_setting.WabaId))\n                return _setting.WabaId;\n\n            var providerKey = (_setting.Provider ?? string.Empty).Trim().ToLowerInvariant();\n\n            // fallback to default active sender for this provider\n            var phoneId = _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == _setting.BusinessId\n                            && n.IsActive\n                            && n.Provider.ToLower() == providerKey)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .Select(n => n.PhoneNumberId)\n                .FirstOrDefault();\n\n            return phoneId;\n        }\n\n        private string BuildBaseUrl()\n        {\n            var baseUrl = string.IsNullOrWhiteSpace(_setting.ApiUrl)\n                ? \"https://partnersv1.pinbot.ai\"\n                : _setting.ApiUrl.TrimEnd('/');\n\n            if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase))\n                baseUrl += \"/v3\";\n\n            return baseUrl;\n        }\n\n        /// <summary>\n        /// Build the final send URL. If pathId is already a full URL, use as-is (for tracking cases).\n        /// Otherwise, compose the Pinnacle endpoint and ALWAYS append apikey in the query.\n        /// </summary>\n        private string BuildSendUrlWithApiKey(string pathId)\n        {\n            if (Uri.IsWellFormedUriString(pathId, UriKind.Absolute))\n                return pathId;\n\n            var baseUrl = BuildBaseUrl();\n            var apiKey = _setting.ApiKey ?? string.Empty;\n            return $\"{baseUrl}/{pathId}/messages?apikey={Uri.EscapeDataString(apiKey)}\";\n        }\n\n        private async Task<WaSendResult> PostAsync(object payload)\n        {\n            var pathId = ResolvePathIdOrNull();\n            if (string.IsNullOrWhiteSpace(pathId))\n            {\n                const string err = \"Pinnacle: Missing path id (need WabaId or PhoneNumberId/default sender).\";\n                _logger.LogError(err);\n                return new WaSendResult(false, \"Pinnacle\", null, null, null, err);\n            }\n\n            if (string.IsNullOrWhiteSpace(_setting.ApiKey))\n            {\n                const string err = \"Pinnacle: ApiKey is missing in WhatsApp settings.\";\n                _logger.LogError(err);\n                return new WaSendResult(false, \"Pinnacle\", null, null, null, err);\n            }\n\n            var url = BuildSendUrlWithApiKey(pathId);\n            var json = JsonSerializer.Serialize(payload, _jsonOpts);\n\n            using var req = new HttpRequestMessage(HttpMethod.Post, url);\n            req.Content = new StringContent(json, Encoding.UTF8, \"application/json\");\n\n            // Put key in all common header places (some tenants validate one or the other)\n            req.Headers.Remove(\"apikey\");\n            req.Headers.Remove(\"x-api-key\");\n            req.Headers.TryAddWithoutValidation(\"apikey\", _setting.ApiKey);\n            req.Headers.TryAddWithoutValidation(\"x-api-key\", _setting.ApiKey);\n            req.Headers.Authorization = new AuthenticationHeaderValue(\"Apikey\", _setting.ApiKey);\n            req.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue(\"application/json\"));\n\n            // trace (shortened key)\n            _logger.LogInformation(\"Pinnacle POST {Url}\", url);\n\n            var res = await _http.SendAsync(req);\n            var body = await res.Content.ReadAsStringAsync();\n\n            if (!res.IsSuccessStatusCode)\n            {\n                _logger.LogWarning(\"Pinnacle send failed (HTTP {Status}): {Body}\", (int)res.StatusCode, body);\n                return new WaSendResult(false, \"Pinnacle\", null, res.StatusCode, body, res.ReasonPhrase);\n            }\n\n            string? id = TryGetPinnMessageId(body);\n            return new WaSendResult(true, \"Pinnacle\", id, res.StatusCode, body, null);\n        }\n\n        public Task<WaSendResult> SendTextAsync(string to, string body)\n            => PostAsync(new\n            {\n                messaging_product = \"whatsapp\",\n                to,\n                type = \"text\",\n                text = new { preview_url = false, body }\n            });\n\n        public Task<WaSendResult> SendTemplateAsync(string to, string templateName, string languageCode, IEnumerable<object> components)\n        {\n            components ??= Enumerable.Empty<object>();\n            // Pinnacle expects language as-is (not { code: \"xx_YY\" })\n            var langValue = languageCode;\n            return PostAsync(new\n            {\n                messaging_product = \"whatsapp\",\n                to,\n                type = \"template\",\n                template = new\n                {\n                    name = templateName,\n                    language = langValue,\n                    components\n                }\n            });\n        }\n\n        private static string? TryGetPinnMessageId(string json)\n        {\n            try\n            {\n                using var doc = JsonDocument.Parse(json);\n                var root = doc.RootElement;\n\n                if (root.TryGetProperty(\"messages\", out var msgs) &&\n                    msgs.ValueKind == JsonValueKind.Array &&\n                    msgs.GetArrayLength() > 0 &&\n                    msgs[0].TryGetProperty(\"id\", out var id0))\n                    return id0.GetString();\n\n                if (root.TryGetProperty(\"message\", out var msg) && msg.ValueKind == JsonValueKind.Object)\n                {\n                    if (msg.TryGetProperty(\"id\", out var id1)) return id1.GetString();\n                    if (msg.TryGetProperty(\"messageId\", out var id2)) return id2.GetString();\n                }\n\n                if (root.TryGetProperty(\"message_id\", out var id3)) return id3.GetString();\n                if (root.TryGetProperty(\"messageId\", out var id4)) return id4.GetString();\n                if (root.TryGetProperty(\"data\", out var data) &&\n                    data.ValueKind == JsonValueKind.Object &&\n                    data.TryGetProperty(\"messageId\", out var id5)) return id5.GetString();\n                if (root.TryGetProperty(\"id\", out var idTop)) return idTop.GetString();\n            }\n            catch { /* ignore parse errors, return null */ }\n\n            return null;\n        }\n\n        public Task<WaSendResult> SendInteractiveAsync(object fullPayload) => PostAsync(fullPayload);\n    }\n}\n\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/IMessageEngineService.cs",
      "sha256": "af2bb7c9271d22f1f001be3d76efc24fe91fbe396847ff2734cdf0e9e6047e1d",
      "language": "csharp",
      "size": 2020,
      "content": "// ‚úÖ Step 1: Final interface\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Helpers;\nusing System.Threading.Tasks;\nusing System.IO.Pipelines;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing System.Threading;\nusing xbytechat.api.Features.MessagesEngine.Enums;\n\n\nnamespace xbytechat.api.Features.MessagesEngine.Services\n{\n    public interface IMessageEngineService\n    {\n\n        Task<ResponseResult> SendTemplateMessageAsync(SendMessageDto dto); //\n        Task<ResponseResult> SendTextDirectAsync(TextMessageSendDto dto);\n        Task<ResponseResult> SendAutomationReply(TextMessageSendDto dto);\n        Task<ResponseResult> SendTemplateMessageSimpleAsync(Guid businessId, SimpleTemplateMessageDto dto);\n        Task<ResponseResult> SendImageCampaignAsync(Guid campaignId, Guid businessId, string triggeredBy);\n        Task<ResponseResult> SendImageTemplateMessageAsync(ImageTemplateMessageDto dto, Guid businessId);\n            Task<ResponseResult> SendPayloadAsync(\n         Guid businessId,\n         string provider,          // \"PINNACLE\" or \"META_CLOUD\"\n         object payload,\n         string? phoneNumberId = null);\n        Task<ResponseResult> SendVideoTemplateMessageAsync(VideoTemplateMessageDto dto, Guid businessId);\n        Task<ResponseResult> SendDocumentTemplateMessageAsync(\n           DocumentTemplateMessageDto dto,\n           Guid businessId);\n\n        // ‚úÖ NEW: Auto-reply helper (for webhook / AutoReplyBuilder runtime)\n        Task<ResponseResult> SendAutoReplyTextAsync(\n             Guid businessId,\n             string recipientNumber,\n             string body,\n             CancellationToken ct = default);\n\n        // ‚úÖ NEW overload ‚Äì AutoReply with explicit DeliveryMode\n        Task<ResponseResult> SendAutoReplyTextAsync(\n            Guid businessId,\n            string recipientNumber,\n            string body,\n            DeliveryMode mode,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/ITemplateMessageSender.cs",
      "sha256": "7051d636ceaac1c53f50319b247f59828ed24e774132628d0e4894e65da74c87",
      "language": "csharp",
      "size": 831,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Shared;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Features.CRM.Models;\n\nnamespace xbytechat.api.Features.MessagesEngine.Services\n{\n    public interface ITemplateMessageSender\n    {\n        Task<ResponseResult> SendTemplateMessageToContactAsync(\n           Guid businessId,\n           Contact contact,\n           string templateName,\n           List<string> templateParams,\n           string? imageUrl = null,\n           List<CampaignButton>? buttons = null,\n           string? source = null,\n           Guid? refMessageId = null\n       );\n\n        Task<ResponseResult> SendTemplateCampaignAsync(Campaign campaign);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/MessageEngineDeliveryModeExtensions.cs",
      "sha256": "4ba3a0dffa1efa78453ac6f3aa9055a7af0fc6108feef391852a8f8e9b4b61e1",
      "language": "csharp",
      "size": 2671,
      "content": "// üìÑ xbytechat-api/Features/MessagesEngine/Services/MessageEngineDeliveryModeExtensions.cs\nusing System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Enums;\nusing xbytechat.api.Helpers; // ResponseResult\n\nnamespace xbytechat.api.Features.MessagesEngine.Services\n{\n    /// <summary>\n    /// Extension methods that add DeliveryMode-aware overloads\n    /// on top of the existing IMessageEngineService interface.\n    ///\n    /// v1 behaviour:\n    /// - These methods mostly delegate to the original overloads.\n    /// - For templates, we now copy the DeliveryMode onto the DTO.\n    /// - The core MessageEngineService can later read dto.DeliveryMode\n    ///   and decide whether to use the Outbox or send immediately.\n    /// </summary>\n    public static class MessageEngineDeliveryModeExtensions\n    {\n        /// <summary>\n        /// DeliveryMode-aware overload for sending simple template messages.\n        /// Currently sets dto.DeliveryMode = mode, then calls the existing implementation.\n        /// </summary>\n        public static Task<ResponseResult> SendTemplateMessageSimpleAsync(\n            this IMessageEngineService engine,\n            Guid businessId,\n            SimpleTemplateMessageDto dto,\n            DeliveryMode mode,\n            CancellationToken ct = default)\n        {\n            if (engine is null) throw new ArgumentNullException(nameof(engine));\n            if (dto is null) throw new ArgumentNullException(nameof(dto));\n\n            // üÜï Stamp the requested mode onto the DTO so the engine can inspect it.\n            dto.DeliveryMode = mode;\n\n            // v1: underlying implementation still behaves the same.\n            return engine.SendTemplateMessageSimpleAsync(businessId, dto);\n        }\n\n        /// <summary>\n        /// DeliveryMode-aware overload for auto-reply text messages.\n        /// For now, the mode is ignored and we delegate to the existing method.\n        /// Later we can teach the engine to branch on mode here as well.\n        /// </summary>\n        public static Task<ResponseResult> SendAutoReplyTextAsync(\n            this IMessageEngineService engine,\n            Guid businessId,\n            string recipientNumber,\n            string body,\n            DeliveryMode mode,\n            CancellationToken ct = default)\n        {\n            if (engine is null) throw new ArgumentNullException(nameof(engine));\n\n            // v1: keep existing behaviour for text; still uses the current pipeline.\n            return engine.SendAutoReplyTextAsync(businessId, recipientNumber, body, ct);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/MessageEngineService.cs",
      "sha256": "c7ce707fa6c91d30598bd5e4ceb1c945e34cf55211876f8fe387a9060a24af5d",
      "language": "csharp",
      "size": 98983,
      "content": "// üìÑ File: Features/MessagesEngine/Services/MessageEngineService.cs\nusing System;\nusing System.Collections.Concurrent;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Text;\nusing System.Text.Json;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.SignalR;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Meta;\nusing xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Pinnacle;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.Inbox.Hubs;\nusing xbytechat.api.Features.MessageManagement.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Abstractions;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Enums;\nusing xbytechat.api.Features.MessagesEngine.Factory;\nusing xbytechat.api.Features.MessagesEngine.PayloadBuilders;\nusing xbytechat.api.Features.PlanManagement.Services;\nusing xbytechat.api.Features.ReportingModule.DTOs;\nusing xbytechat.api.Features.Webhooks.Services.Resolvers;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Infrastructure.Json;         // <- source-gen context (JsonCtx)\nusing xbytechat.api.Shared;\nusing xbytechat.api.Shared.utility;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.MessagesEngine.Services\n{\n    public class MessageEngineService : IMessageEngineService\n    {\n        private readonly AppDbContext _db;\n        private readonly HttpClient _http; // kept for any internal calls\n        private readonly TextMessagePayloadBuilder _textBuilder;\n        private readonly ImageMessagePayloadBuilder _imageBuilder;\n        private readonly TemplateMessagePayloadBuilder _templateBuilder;\n        private readonly CtaMessagePayloadBuilder _ctaBuilder;\n        private readonly IPlanManager _planManager;\n        private readonly IHubContext<InboxHub> _hubContext;\n        private readonly IMessageIdResolver _messageIdResolver;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n        private readonly IContactService _contactService;\n        private readonly IWhatsAppProviderFactory _providerFactory;\n        private readonly ILogger<MessageEngineService> _logger;\n\n        // Basic cache for WhatsApp settings to reduce DB load\n        private readonly ConcurrentDictionary<Guid, (IReadOnlyList<WhatsAppSettingEntity> setting, DateTime expiresAt)> _settingsCache = new();\n\n        public MessageEngineService(\n            AppDbContext db,\n            HttpClient http,\n            TextMessagePayloadBuilder textBuilder,\n            ImageMessagePayloadBuilder imageBuilder,\n            TemplateMessagePayloadBuilder templateBuilder,\n            CtaMessagePayloadBuilder ctaBuilder,\n            IPlanManager planManager,\n            IHubContext<InboxHub> hubContext,\n            IMessageIdResolver messageIdResolver,\n            IHttpContextAccessor httpContextAccessor,\n            IContactService contactService,\n            IWhatsAppProviderFactory providerFactory,\n            ILogger<MessageEngineService> logger)\n        {\n            _db = db;\n            _http = http;\n            _textBuilder = textBuilder;\n            _imageBuilder = imageBuilder;\n            _templateBuilder = templateBuilder;\n            _ctaBuilder = ctaBuilder;\n            _planManager = planManager;\n            _hubContext = hubContext;\n            _messageIdResolver = messageIdResolver;\n            _httpContextAccessor = httpContextAccessor;\n            _contactService = contactService;\n            _providerFactory = providerFactory;\n            _logger = logger;\n        }\n\n        // ---------- small helpers ----------\n        private static string ResolveGreeting(string? profileName, string? contactName)\n        {\n            var s = (profileName ?? contactName)?.Trim();\n            return string.IsNullOrEmpty(s) ? \"there\" : s;\n        }\n\n        private static void EnsureArgsLength(List<string> args, int slot1Based)\n        {\n            while (args.Count < slot1Based) args.Add(string.Empty);\n        }\n\n        // ‚úÖ Public helper so both Flow + Campaign send paths can use it\n        //public async Task<List<string>> ApplyProfileNameAsync(\n        //    Guid businessId,\n        //    Guid contactId,\n        //    bool useProfileName,\n        //    int? profileNameSlot,\n        //    List<string> args,\n        //    CancellationToken ct = default)\n        //{\n        //    if (!useProfileName || !(profileNameSlot is int slot) || slot < 1)\n        //        return args;\n\n        //    //var contact = await _db.Contacts\n        //    //    .AsNoTracking()\n        //    //    .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.Id == contactId, ct);\n\n        //    var greet = ResolveGreeting(contact?.ProfileName, contact?.Name);\n        //    EnsureArgsLength(args, slot);\n        //    args[slot - 1] = greet;\n        //    return args;\n        //}\n        public async Task<List<string>> ApplyProfileNameAsync(\n    Guid businessId,\n    Guid contactId,\n    bool useProfileName,\n    int? profileNameSlot,\n    List<string> args,\n    CancellationToken ct = default)\n        {\n            // Normalize args so we never return null\n            args ??= new List<string>();\n\n            // Quick outs\n            if (!useProfileName || profileNameSlot is not int slot || slot < 1)\n                return args;\n\n            // Load the contact only when needed\n            var contact = await _db.Contacts\n                .AsNoTracking()\n                .Where(c => c.BusinessId == businessId && c.Id == contactId)\n                .Select(c => new { c.Name, c.ProfileName })\n                .FirstOrDefaultAsync(ct);\n\n            // If no contact, just return args unchanged\n            if (contact is null)\n                return args;\n\n            // Build the greeting / display name (adjust ResolveGreeting to your needs)\n            var greet = ResolveGreeting(contact.ProfileName, contact.Name);\n            if (string.IsNullOrWhiteSpace(greet))\n                return args; // nothing to apply\n\n            // Ensure args has capacity for the requested slot (1-based)\n            if (args.Count < slot)\n                args.AddRange(Enumerable.Repeat(string.Empty, slot - args.Count));\n\n            // Set the value at the requested slot\n            args[slot - 1] = greet;\n\n            return args;\n        }\n\n        // ============================================================\n        //  SOURCE-GEN PATH FOR TYPED PAYLOADS (Step 9 ‚Äì point #5)\n        // ============================================================\n        public async Task<ResponseResult> SendPayloadAsync(Guid businessId, string provider, object payload, string? phoneNumberId = null)\n        {\n            if (string.IsNullOrWhiteSpace(provider) || (provider != \"PINNACLE\" && provider != \"META_CLOUD\"))\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\", \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n\n            // If already-typed, keep your current JsonElement path:\n            if (payload is MetaTemplateMessage m)\n            {\n                var json = JsonSerializer.Serialize(m, JsonCtx.Default.MetaTemplateMessage);\n                using var doc = JsonDocument.Parse(json);\n                return await SendViaProviderAsync(businessId, provider, p => p.SendInteractiveAsync(doc.RootElement.Clone()), phoneNumberId);\n            }\n            if (payload is PinnacleTemplateMessage pmsg)\n            {\n                var json = JsonSerializer.Serialize(pmsg, JsonCtx.Default.PinnacleTemplateMessage);\n                using var doc = JsonDocument.Parse(json);\n                return await SendViaProviderAsync(businessId, provider, p => p.SendInteractiveAsync(doc.RootElement.Clone()), phoneNumberId);\n            }\n\n            // NEW: if the anonymous payload looks like a WhatsApp \"template\" message,\n            // extract the parts and call SendTemplateAsync directly (no raw object pass-through).\n            if (payload is JsonElement je && je.ValueKind == JsonValueKind.Object &&\n                je.TryGetProperty(\"type\", out var t) && t.GetString() == \"template\" &&\n                je.TryGetProperty(\"to\", out var toProp) &&\n                je.TryGetProperty(\"template\", out var tmpl) &&\n                tmpl.TryGetProperty(\"name\", out var nameProp) &&\n                tmpl.TryGetProperty(\"language\", out var langProp) &&\n                langProp.TryGetProperty(\"code\", out var codeProp) &&\n                tmpl.TryGetProperty(\"components\", out var comps))\n            {\n                var to = toProp.GetString()!;\n                var name = nameProp.GetString()!;\n                var code = codeProp.GetString()!;\n                // Materialize components as plain anonymous objects to guarantee no $type:\n                var components = new List<object>();\n                foreach (var c in comps.EnumerateArray())\n                {\n                    var type = c.GetProperty(\"type\").GetString();\n                    if (type == \"body\")\n                    {\n                        var pars = c.TryGetProperty(\"parameters\", out var pr)\n                            ? pr.EnumerateArray().Select(p => new { type = p.GetProperty(\"type\").GetString(), text = p.GetProperty(\"text\").GetString() }).ToArray()\n                            : System.Array.Empty<object>();\n                        components.Add(new { type = \"body\", parameters = pars });\n                    }\n                    else if (type == \"header\")\n                    {\n                        // support header image\n                        if (c.TryGetProperty(\"parameters\", out var pr) && pr.GetArrayLength() > 0)\n                        {\n                            var p0 = pr[0];\n                            if (p0.TryGetProperty(\"type\", out var pt) && pt.GetString() == \"image\")\n                            {\n                                var link = p0.GetProperty(\"image\").GetProperty(\"link\").GetString();\n                                components.Add(new { type = \"header\", parameters = new object[] { new { type = \"image\", image = new { link } } } });\n                            }\n                            else\n                            {\n                                components.Add(new { type = \"header\", parameters = new object[] { } });\n                            }\n                        }\n                        else components.Add(new { type = \"header\", parameters = new object[] { } });\n                    }\n                    else if (type == \"button\")\n                    {\n                        var subType = c.GetProperty(\"sub_type\").GetString();\n                        var index = c.GetProperty(\"index\").GetString();\n                        if (subType == \"url\" && c.TryGetProperty(\"parameters\", out var pr) && pr.GetArrayLength() > 0)\n                        {\n                            var urlParam = pr[0].GetProperty(\"text\").GetString();\n                            components.Add(new { type = \"button\", sub_type = \"url\", index, parameters = new object[] { new { type = \"text\", text = urlParam } } });\n                        }\n                    }\n                }\n\n                return await SendViaProviderAsync(businessId, provider,\n                    p => p.SendTemplateAsync(to, name, code, components),\n                    phoneNumberId);\n            }\n\n            // Fallback: send as-is via interactive\n            return await SendViaProviderAsync(businessId, provider, p => p.SendInteractiveAsync(payload), phoneNumberId);\n        }\n\n\n\n\n\n        private static string NormalizeProviderOrThrow(string? p)\n        {\n            if (string.IsNullOrWhiteSpace(p))\n                throw new ArgumentException(\"Provider is required.\");\n\n            var u = p.Trim().ToUpperInvariant();\n            return u switch\n            {\n                \"META\" => \"META_CLOUD\", // internal convenience; callers should still pass exact values\n                \"META_CLOUD\" => \"META_CLOUD\",\n                \"PINNACLE\" => \"PINNACLE\",\n                _ => throw new ArgumentException($\"Invalid provider: {p}\")\n            };\n        }\n\n        private async Task<ResponseResult> SendViaProviderAsync(\n            Guid businessId,\n            string provider,                                // explicit\n            Func<IWhatsAppProvider, Task<WaSendResult>> action,\n            string? phoneNumberId = null)\n        {\n            try\n            {\n                // normalize internally (tolerate \"META\" here) but keep external API strict\n                var normalizedProvider = NormalizeProviderOrThrow(provider);\n\n                // For both META_CLOUD and PINNACLE we require a sender id here\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Campaign has no sender number.\",\n                        \"Missing PhoneNumberId\");\n\n                // Build provider bound to business + sender\n                var wa = await _providerFactory.CreateAsync(\n                    businessId,\n                    normalizedProvider,\n                    phoneNumberId);\n\n                // post request to http URL\n                var response = await action(wa);\n\n                if (!response.Success)\n                    return ResponseResult.ErrorInfo(\"‚ùå WhatsApp API returned an error.\", response.Error, response.RawResponse);\n\n                var rr = ResponseResult.SuccessInfo(\"‚úÖ Message sent successfully\", data: null, raw: response.RawResponse);\n                rr.MessageId = string.IsNullOrWhiteSpace(response.ProviderMessageId)\n                    ? TryExtractMetaWamid(response.RawResponse)\n                    : response.ProviderMessageId;\n                return rr;\n            }\n            catch (ArgumentException ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\", ex.Message);\n            }\n            catch (InvalidOperationException ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Provider configuration error.\", ex.Message);\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Provider call failed.\", ex.Message);\n            }\n        }\n\n        private static string? TryExtractMetaWamid(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return null;\n            var s = raw.TrimStart();\n            if (!s.StartsWith(\"{\")) return null;\n            try\n            {\n                using var doc = JsonDocument.Parse(s);\n                if (doc.RootElement.TryGetProperty(\"messages\", out var msgs) &&\n                    msgs.ValueKind == JsonValueKind.Array &&\n                    msgs.GetArrayLength() > 0 &&\n                    msgs[0].TryGetProperty(\"id\", out var idProp))\n                {\n                    return idProp.GetString();\n                }\n            }\n            catch { }\n            return null;\n        }\n\n        // ---------- CSV-materialized variable helpers (for campaign recipients) ----------\n        private static string[] ReadBodyParams(string? json)\n        {\n            if (string.IsNullOrWhiteSpace(json)) return Array.Empty<string>();\n            try { return JsonSerializer.Deserialize<string[]>(json) ?? Array.Empty<string>(); }\n            catch { return Array.Empty<string>(); }\n        }\n\n        private static Dictionary<string, string> ReadVarDict(string? json)\n        {\n            if (string.IsNullOrWhiteSpace(json))\n                return new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            try\n            {\n                return JsonSerializer.Deserialize<Dictionary<string, string>>(json)\n                       ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            }\n            catch\n            {\n                return new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            }\n        }\n\n        private static List<string> BuildHeaderTextParams(IDictionary<string, string> kv)\n        {\n            var matches = kv.Keys\n                .Select(k => new\n                {\n                    k,\n                    m = System.Text.RegularExpressions.Regex.Match(\n                        k, @\"^(?:header(?:\\.text)?\\.)?(\\d+)$|^header(?:\\.text)?\\.(\\d+)$|^headerpara(\\d+)$\",\n                        System.Text.RegularExpressions.RegexOptions.IgnoreCase)\n                })\n                .Where(x => x.m.Success)\n                .Select(x =>\n                {\n                    for (int g = 1; g < x.m.Groups.Count; g++)\n                        if (x.m.Groups[g].Success) return int.Parse(x.m.Groups[g].Value);\n                    return 0;\n                })\n                .Where(n => n > 0)\n                .Distinct()\n                .OrderBy(n => n)\n                .ToList();\n\n            if (matches.Count == 0) return new List<string>();\n\n            var list = new List<string>(new string[matches.Last()]);\n            for (int i = 1; i <= list.Count; i++)\n            {\n                var k1 = $\"header.text.{i}\";\n                var k2 = $\"headerpara{i}\";\n                if (!kv.TryGetValue(k1, out var v))\n                    kv.TryGetValue(k2, out v);\n                list[i - 1] = v ?? string.Empty;\n            }\n\n            return list;\n        }\n\n        private static IReadOnlyDictionary<string, string> BuildButtonUrlParams(IDictionary<string, string> kv)\n        {\n            var map = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            for (int pos = 1; pos <= 3; pos++)\n            {\n                var k1 = $\"button{pos}.url_param\";\n                var k2 = $\"buttonpara{pos}\";\n                if (kv.TryGetValue(k1, out var v1) && !string.IsNullOrWhiteSpace(v1))\n                    map[k1] = v1;\n                else if (kv.TryGetValue(k2, out var v2) && !string.IsNullOrWhiteSpace(v2))\n                    map[k1] = v2;\n            }\n            return map;\n        }\n\n        // ======================================================================\n        //  SEND METHODS (kept from your file; minor tidy + consistent responses)\n        // ======================================================================\n\n        public async Task<ResponseResult> SendTemplateMessageAsync(SendMessageDto dto)\n        {\n            try\n            {\n                Console.WriteLine($\"üì® Sending template message to {dto.RecipientNumber} via BusinessId {dto.BusinessId}\");\n\n                if (dto.MessageType != MessageTypeEnum.Template)\n                    return ResponseResult.ErrorInfo(\"Only template messages are supported in this method.\");\n\n                // strict provider check at API surface\n                if (string.IsNullOrWhiteSpace(dto.Provider) ||\n                    (dto.Provider != \"PINNACLE\" && dto.Provider != \"META_CLOUD\"))\n                {\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\",\n                        \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n                }\n\n                // Quota\n                var quotaCheck = await _planManager.CheckQuotaBeforeSendingAsync(dto.BusinessId);\n                if (!quotaCheck.Success) return quotaCheck;\n\n                // Build components (body only here)\n                var bodyParams = (dto.TemplateParameters?.Values?.ToList() ?? new List<string>())\n                    .Select(p => new { type = \"text\", text = p })\n                    .ToArray();\n\n                var components = new List<object>();\n                if (bodyParams.Length > 0)\n                    components.Add(new { type = \"body\", parameters = bodyParams });\n\n                // Send via provider\n                var sendResult = await SendViaProviderAsync(\n                    dto.BusinessId,\n                    dto.Provider,\n                    p => p.SendTemplateAsync(dto.RecipientNumber, dto.TemplateName!, \"en_US\", components),\n                    dto.PhoneNumberId\n                );\n\n                // Rendered body (for logs)\n                var resolvedBody = TemplateParameterHelper.FillPlaceholders(\n                    dto.TemplateBody ?? \"\",\n                    dto.TemplateParameters?.Values.ToList() ?? new List<string>());\n\n                // Log result\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TemplateName ?? \"N/A\",\n                    RenderedBody = resolvedBody,\n                    MediaUrl = null,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                var planInfo = await _db.BusinessPlanInfos.FirstOrDefaultAsync(p => p.BusinessId == dto.BusinessId);\n                if (planInfo != null && planInfo.RemainingMessages > 0)\n                {\n                    planInfo.RemainingMessages -= 1;\n                    planInfo.UpdatedAt = DateTime.UtcNow;\n                }\n                await _db.SaveChangesAsync();\n\n                // SignalR push\n                await _hubContext.Clients\n                    .Group($\"business_{dto.BusinessId}\")\n                    .SendAsync(\"ReceiveMessage\", new\n                    {\n                        Id = log.Id,\n                        RecipientNumber = log.RecipientNumber,\n                        MessageContent = log.RenderedBody,\n                        MediaUrl = log.MediaUrl,\n                        Status = log.Status,\n                        CreatedAt = log.CreatedAt,\n                        SentAt = log.SentAt\n                    });\n\n                return ResponseResult.SuccessInfo(\"‚úÖ Template message sent successfully.\", sendResult, log.RawResponse);\n            }\n            catch (Exception ex)\n            {\n                var errorId = Guid.NewGuid();\n                Console.WriteLine($\"üß® Error ID: {errorId}\\n{ex}\");\n\n                await _db.MessageLogs.AddAsync(new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TemplateName ?? \"N/A\",\n                    RenderedBody = TemplateParameterHelper.FillPlaceholders(\n                        dto.TemplateBody ?? \"\",\n                        dto.TemplateParameters?.Values.ToList() ?? new List<string>()),\n                    Status = \"Failed\",\n                    ErrorMessage = ex.Message,\n                    RawResponse = ex.ToString(),\n                    CreatedAt = DateTime.UtcNow\n                });\n\n                await _db.SaveChangesAsync();\n\n                return ResponseResult.ErrorInfo(\n                    $\"‚ùå Exception occurred while sending template message. [Ref: {errorId}]\",\n                    ex.ToString());\n            }\n        }\n        [Obsolete(\"Use outbox + SendPayloadAsync via worker.\")]\n        public async Task<ResponseResult> SendVideoTemplateMessageAsync(VideoTemplateMessageDto dto, Guid businessId)\n        {\n            try\n            {\n                var provider = (dto.Provider ?? \"META_CLOUD\").Trim().ToUpperInvariant();\n                if (provider != \"PINNACLE\" && provider != \"META_CLOUD\")\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\", \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n\n                if (string.IsNullOrWhiteSpace(dto.RecipientNumber))\n                    return ResponseResult.ErrorInfo(\"‚ùå Missing recipient number.\");\n                if (string.IsNullOrWhiteSpace(dto.TemplateName))\n                    return ResponseResult.ErrorInfo(\"‚ùå Missing template name.\");\n                if (string.IsNullOrWhiteSpace(dto.HeaderVideoUrl))\n                    return ResponseResult.ErrorInfo(\"üö´ Missing HeaderVideoUrl (must be a direct HTTPS link to a video file).\");\n\n                var langCode = string.IsNullOrWhiteSpace(dto.LanguageCode) ? \"en_US\" : dto.LanguageCode!.Trim();\n\n                // components: header video + body + optional buttons\n                var components = new List<object>\n                {\n                    new\n                    {\n                        type = \"header\",\n                        parameters = new object[]\n                        {\n                            new { type = \"video\", video = new { link = dto.HeaderVideoUrl! } }\n                        }\n                    }\n                };\n\n                var bodyParams = (dto.TemplateParameters ?? new List<string>())\n                    .Select(p => new { type = \"text\", text = p })\n                    .ToArray();\n\n                components.Add(new { type = \"body\", parameters = bodyParams });\n\n                var btns = (dto.ButtonParameters ?? new List<CampaignButtonDto>()).Take(3).ToList();\n                for (int i = 0; i < btns.Count; i++)\n                {\n                    var b = btns[i];\n                    var sub = (b.ButtonType ?? \"\").Trim().ToLowerInvariant();\n                    if (string.IsNullOrEmpty(sub)) continue;\n\n                    var button = new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"button\",\n                        [\"sub_type\"] = sub,\n                        [\"index\"] = i.ToString()\n                    };\n\n                    if (sub == \"url\" && !string.IsNullOrWhiteSpace(b.TargetUrl))\n                        button[\"parameters\"] = new object[] { new { type = \"text\", text = b.TargetUrl! } };\n                    else if (sub == \"quick_reply\" && !string.IsNullOrWhiteSpace(b.TargetUrl))\n                        button[\"parameters\"] = new object[] { new { type = \"payload\", payload = b.TargetUrl! } };\n\n                    components.Add(button);\n                }\n\n                // full payload object for WhatsApp template\n                var payload = new\n                {\n                    messaging_product = \"whatsapp\",\n                    to = dto.RecipientNumber!,\n                    type = \"template\",\n                    template = new\n                    {\n                        name = dto.TemplateName!,\n                        language = new { code = langCode },\n                        components = components\n                    }\n                };\n\n                var sendResult = await SendPayloadAsync(businessId, provider, payload, dto.PhoneNumberId);\n\n                var renderedBody = TemplateParameterHelper.FillPlaceholders(\n                    dto.TemplateBody ?? \"\",\n                    dto.TemplateParameters ?? new List<string>());\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = dto.RecipientNumber!,\n                    MessageContent = dto.TemplateName!,\n                    MediaUrl = dto.HeaderVideoUrl,\n                    RenderedBody = renderedBody,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.ErrorMessage ?? (sendResult.Success ? null : \"WhatsApp API returned an error.\"),\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    SentAt = DateTime.UtcNow,\n                    CreatedAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success ? \"‚úÖ Template sent successfully.\" : (sendResult.ErrorMessage ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new { Success = sendResult.Success, MessageId = sendResult.MessageId, LogId = log.Id },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                try\n                {\n                    await _db.MessageLogs.AddAsync(new MessageLog\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        RecipientNumber = dto.RecipientNumber ?? \"\",\n                        MessageContent = dto.TemplateName ?? \"\",\n                        RenderedBody = TemplateParameterHelper.FillPlaceholders(dto.TemplateBody ?? \"\", dto.TemplateParameters ?? new List<string>()),\n                        MediaUrl = dto.HeaderVideoUrl,\n                        Status = \"Failed\",\n                        ErrorMessage = ex.Message,\n                        CreatedAt = DateTime.UtcNow,\n                        CTAFlowConfigId = dto.CTAFlowConfigId,\n                        CTAFlowStepId = dto.CTAFlowStepId\n                    });\n                    await _db.SaveChangesAsync();\n                }\n                catch { /* ignore */ }\n\n                return ResponseResult.ErrorInfo(\"‚ùå Template send failed\", ex.Message);\n            }\n        }\n\n        public async Task<ResponseResult> SendTextDirectAsync(TextMessageSendDto dto)\n        {\n            try\n            {\n                var businessId = _httpContextAccessor.HttpContext?.User?.GetBusinessId()\n                    ?? throw new UnauthorizedAccessException(\"‚ùå Cannot resolve BusinessId from context.\");\n\n                // Normalize inbound intent\n                string? providerUpper = string.IsNullOrWhiteSpace(dto.Provider)\n                    ? null\n                    : dto.Provider!.Trim().ToUpperInvariant();\n                string? providerKey = providerUpper?.ToLowerInvariant();\n                string? phoneNumberId = string.IsNullOrWhiteSpace(dto.PhoneNumberId) ? null : dto.PhoneNumberId!.Trim();\n\n                // Derive provider/sender from default phone row if needed\n                if (string.IsNullOrWhiteSpace(providerUpper))\n                {\n                    var defaultPhone = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId && n.IsActive)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => new { n.Provider, n.PhoneNumberId })\n                        .FirstOrDefaultAsync();\n\n                    if (defaultPhone == null)\n                    {\n                        var anySetting = await _db.WhatsAppSettings\n                            .AsNoTracking()\n                            .Where(s => s.BusinessId == businessId && s.IsActive)\n                            .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                            .Select(s => s.Provider)\n                            .FirstOrDefaultAsync();\n\n                        if (string.IsNullOrWhiteSpace(anySetting))\n                            return ResponseResult.ErrorInfo(\"‚ùå WhatsApp configuration not found (no active numbers or settings).\");\n\n                        providerUpper = anySetting.Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                    }\n                    else\n                    {\n                        providerUpper = (defaultPhone.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                        if (string.IsNullOrWhiteSpace(phoneNumberId))\n                            phoneNumberId = defaultPhone.PhoneNumberId;\n                    }\n                }\n\n                if (providerUpper != \"PINNACLE\" && providerUpper != \"META_CLOUD\")\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider. Must be 'PINNACLE' or 'META_CLOUD'.\");\n\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                {\n                    var phoneRow = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId\n                                    && n.IsActive\n                                    && n.Provider.ToLower() == providerKey)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => n.PhoneNumberId)\n                        .FirstOrDefaultAsync();\n\n                    if (!string.IsNullOrWhiteSpace(phoneRow))\n                        phoneNumberId = phoneRow;\n                }\n\n                if (providerUpper == \"META_CLOUD\" && string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\"‚ùå Missing PhoneNumberId for META_CLOUD. Configure a default sender or pass PhoneNumberId.\");\n\n                var chosenSetting = await _db.WhatsAppSettings\n                    .AsNoTracking()\n                    .Where(s => s.BusinessId == businessId\n                                && s.IsActive\n                                && s.Provider.ToLower() == providerKey)\n                    .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                    .FirstOrDefaultAsync();\n\n                if (chosenSetting == null)\n                    return ResponseResult.ErrorInfo(\"‚ùå WhatsApp settings row not found for the selected provider.\");\n\n                // Contact upsert/touch\n                Guid? contactId = null;\n                var contact = await _db.Contacts.FirstOrDefaultAsync(c =>\n                    c.BusinessId == businessId && c.PhoneNumber == dto.RecipientNumber);\n\n                if (contact != null)\n                {\n                    contactId = contact.Id;\n                    contact.LastContactedAt = DateTime.UtcNow;\n                }\n                else if (dto.IsSaveContact)\n                {\n                    contact = new Contact\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        Name = \"WhatsApp User\",\n                        PhoneNumber = dto.RecipientNumber,\n                        CreatedAt = DateTime.UtcNow,\n                        LastContactedAt = DateTime.UtcNow\n                    };\n                    _db.Contacts.Add(contact);\n                    contactId = contact.Id;\n                }\n\n                await _db.SaveChangesAsync();\n\n                // Send\n                var sendResult = await SendViaProviderAsync(\n                    businessId,\n                    providerUpper!,\n                    p => p.SendTextAsync(dto.RecipientNumber, dto.TextContent),\n                    phoneNumberId\n                );\n\n                // Extract provider message id if missing\n                string? messageId = sendResult.MessageId;\n                if (string.IsNullOrWhiteSpace(messageId) && !string.IsNullOrWhiteSpace(sendResult.RawResponse))\n                {\n                    try\n                    {\n                        var raw = sendResult.RawResponse!.TrimStart();\n                        if (raw.StartsWith(\"{\"))\n                        {\n                            using var parsed = JsonDocument.Parse(raw);\n                            if (parsed.RootElement.TryGetProperty(\"messages\", out var msgs)\n                                && msgs.ValueKind == JsonValueKind.Array\n                                && msgs.GetArrayLength() > 0\n                                && msgs[0].TryGetProperty(\"id\", out var idProp))\n                            {\n                                messageId = idProp.GetString();\n                            }\n                        }\n                    }\n                    catch { /* ignore parse issues */ }\n                }\n\n                // Log\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TextContent,\n                    RenderedBody = dto.TextContent,\n                    ContactId = contactId,\n                    MediaUrl = null,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    MessageId = messageId\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                // Optional campaign mapping\n                Guid? campaignSendLogId = null;\n                if (dto.Source == \"campaign\" && !string.IsNullOrEmpty(messageId))\n                {\n                    try { campaignSendLogId = await _messageIdResolver.ResolveCampaignSendLogIdAsync(messageId); }\n                    catch { /* non-fatal */ }\n                }\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"‚úÖ Text message sent successfully.\"\n                        : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new\n                    {\n                        Success = sendResult.Success,\n                        MessageId = messageId,\n                        LogId = log.Id,\n                        CampaignSendLogId = campaignSendLogId\n                    },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = messageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                try\n                {\n                    var businessId = _httpContextAccessor.HttpContext?.User?.GetBusinessId();\n                    if (businessId != null)\n                    {\n                        await _db.MessageLogs.AddAsync(new MessageLog\n                        {\n                            Id = Guid.NewGuid(),\n                            BusinessId = businessId.Value,\n                            RecipientNumber = dto.RecipientNumber,\n                            MessageContent = dto.TextContent,\n                            Status = \"Failed\",\n                            ErrorMessage = ex.Message,\n                            CreatedAt = DateTime.UtcNow\n                        });\n                        await _db.SaveChangesAsync();\n                    }\n                }\n                catch { /* ignore */ }\n\n                return ResponseResult.ErrorInfo(\"‚ùå Failed to send text message.\", ex.ToString());\n            }\n        }\n\n        public async Task<ResponseResult> SendAutomationReply(TextMessageSendDto dto)\n        {\n            try\n            {\n                var businessId =\n                    dto.BusinessId != Guid.Empty\n                        ? dto.BusinessId\n                        : _httpContextAccessor.HttpContext?.User?.GetBusinessId()\n                          ?? throw new UnauthorizedAccessException(\"‚ùå Cannot resolve BusinessId from context or DTO.\");\n\n                if (string.IsNullOrWhiteSpace(dto.Provider) ||\n                    (dto.Provider != \"PINNACLE\" && dto.Provider != \"META_CLOUD\"))\n                {\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\",\n                        \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n                }\n\n                Guid? contactId = null;\n                try\n                {\n                    var contact = await _contactService.FindOrCreateAsync(businessId, dto.RecipientNumber);\n                    contactId = contact.Id;\n                }\n                catch (Exception ex)\n                {\n                    Console.WriteLine($\"‚ö†Ô∏è Failed to resolve or create contact: {ex.Message}\");\n                }\n\n                var sendResult = await SendViaProviderAsync(\n                    businessId,\n                    dto.Provider,\n                    p => p.SendTextAsync(dto.RecipientNumber, dto.TextContent),\n                    dto.PhoneNumberId\n                );\n\n                string? messageId = sendResult.MessageId;\n                var raw = sendResult.RawResponse;\n                if (string.IsNullOrWhiteSpace(messageId) && !string.IsNullOrWhiteSpace(raw))\n                {\n                    try\n                    {\n                        var s = raw.TrimStart();\n                        if (s.StartsWith(\"{\"))\n                        {\n                            using var parsed = JsonDocument.Parse(s);\n                            if (parsed.RootElement.TryGetProperty(\"messages\", out var messages) &&\n                                messages.ValueKind == JsonValueKind.Array &&\n                                messages.GetArrayLength() > 0 &&\n                                messages[0].TryGetProperty(\"id\", out var idProp))\n                            {\n                                messageId = idProp.GetString();\n                            }\n                        }\n                    }\n                    catch { /* ignore */ }\n                }\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TextContent,\n                    RenderedBody = dto.TextContent,\n                    ContactId = contactId,\n                    MediaUrl = null,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    MessageId = messageId\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                Guid? campaignSendLogId = null;\n                if (dto.Source == \"campaign\" && !string.IsNullOrEmpty(messageId))\n                {\n                    try\n                    {\n                        campaignSendLogId = await _messageIdResolver.ResolveCampaignSendLogIdAsync(messageId);\n                        Console.WriteLine($\"üì¶ CampaignSendLog resolved: {campaignSendLogId}\");\n                    }\n                    catch (Exception ex)\n                    {\n                        Console.WriteLine($\"‚ö†Ô∏è Failed to resolve campaign log for {messageId}: {ex.Message}\");\n                    }\n                }\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"‚úÖ Text message sent successfully.\"\n                        : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new\n                    {\n                        Success = sendResult.Success,\n                        MessageId = messageId,\n                        LogId = log.Id,\n                        CampaignSendLogId = campaignSendLogId\n                    },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = messageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"‚ùå Exception in SendAutomationReply: {ex.Message}\");\n\n                try\n                {\n                    var businessId =\n                        dto.BusinessId != Guid.Empty\n                            ? dto.BusinessId\n                            : _httpContextAccessor.HttpContext?.User?.GetBusinessId()\n                              ?? throw new UnauthorizedAccessException(\"‚ùå Cannot resolve BusinessId in failure path.\");\n\n                    await _db.MessageLogs.AddAsync(new MessageLog\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        RecipientNumber = dto.RecipientNumber,\n                        MessageContent = dto.TextContent,\n                        Status = \"Failed\",\n                        ErrorMessage = ex.Message,\n                        CreatedAt = DateTime.UtcNow\n                    });\n\n                    await _db.SaveChangesAsync();\n                }\n                catch { /* ignore log errors */ }\n\n                return ResponseResult.ErrorInfo(\"‚ùå Failed to send text message.\", ex.ToString());\n            }\n        }\n\n        /// <summary>\n        /// Sends a simple text auto-reply on behalf of a business.\n        /// This helper assumes Meta Cloud as the default provider and\n        /// uses the default active WhatsAppPhoneNumber to resolve PhoneNumberId.\n        /// Intended for AutoReplyBuilder / webhook runtime (no user context).\n        /// </summary>\n        public async Task<ResponseResult> SendAutoReplyTextAsync(\n       Guid businessId,\n       string recipientNumber,\n       string body,\n       CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty)\n            {\n                return ResponseResult.ErrorInfo(\n                    \"‚ùå Auto-reply failed.\",\n                    \"BusinessId is required.\");\n            }\n\n            if (string.IsNullOrWhiteSpace(recipientNumber))\n            {\n                return ResponseResult.ErrorInfo(\n                    \"‚ùå Auto-reply failed.\",\n                    \"Recipient phone number is required.\");\n            }\n\n            if (string.IsNullOrWhiteSpace(body))\n            {\n                return ResponseResult.ErrorInfo(\n                    \"‚ùå Auto-reply failed.\",\n                    \"Reply body is empty.\");\n            }\n\n            try\n            {\n                // 1) Normalize the recipient a bit (full E.164 normalization happens elsewhere)\n                var trimmedNumber = recipientNumber.Trim();\n\n                // 2) Load active WhatsApp settings for this business\n                var setting = await _db.WhatsAppSettings\n                    .AsNoTracking()\n                    .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.IsActive, ct);\n\n                if (setting == null)\n                {\n                    _logger.LogWarning(\n                        \"‚ö†Ô∏è AutoReply: WhatsApp settings not found for BusinessId={BusinessId}.\",\n                        businessId);\n\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Auto-reply failed.\",\n                        \"WhatsApp settings are not configured for this business.\");\n                }\n\n                var provider = (setting.Provider ?? string.Empty)\n                    .Trim()\n                    .ToUpperInvariant();\n\n                if (provider != \"META_CLOUD\" && provider != \"PINNACLE\")\n                {\n                    _logger.LogWarning(\n                        \"‚ö†Ô∏è AutoReply: Unsupported provider '{Provider}' for BusinessId={BusinessId}.\",\n                        provider,\n                        businessId);\n\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Auto-reply failed.\",\n                        \"WhatsApp provider is not correctly configured for this business.\");\n                }\n\n                // 3) Resolve the default sender (PhoneNumberId) for this provider\n                var phone = await _db.WhatsAppPhoneNumbers\n                    .AsNoTracking()\n                    .Where(p => p.BusinessId == businessId\n                                && p.IsActive\n                                && p.Provider.ToLower() == provider.ToLower())\n                    .OrderByDescending(p => p.IsDefault)\n                    .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                    .Select(p => new { p.PhoneNumberId, p.WhatsAppBusinessNumber })\n                    .FirstOrDefaultAsync(ct);\n\n                string? phoneNumberId = phone?.PhoneNumberId;\n\n                if (provider == \"META_CLOUD\" && string.IsNullOrWhiteSpace(phoneNumberId))\n                {\n                    _logger.LogWarning(\n                        \"‚ö†Ô∏è AutoReply: No default PhoneNumberId configured for BusinessId={BusinessId}, Provider={Provider}.\",\n                        businessId,\n                        provider);\n\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Auto-reply failed.\",\n                        \"No default WhatsApp sender number is configured for this business.\");\n                }\n\n                // 4) Build DTO for the core text sender\n                var dto = new TextMessageSendDto\n                {\n                    BusinessId = businessId,\n                    RecipientNumber = trimmedNumber,\n                    TextContent = body,\n                    Provider = provider,         // use provider from settings\n                    PhoneNumberId = phoneNumberId,\n                    Source = \"auto-reply\"\n                };\n\n                _logger.LogInformation(\n                    \"üì§ AutoReply: sending simple text reply for BusinessId={BusinessId}, Recipient={Recipient}, Preview={Preview}\",\n                    businessId,\n                    trimmedNumber,\n                    body.Length > 60 ? body.Substring(0, 60) + \"...\" : body);\n\n                // 5) Delegate to the existing pipeline (logs + OutboundMessageJob, etc.)\n                var result = await SendAutomationReply(dto);\n\n                if (!result.Success)\n                {\n                    _logger.LogWarning(\n                        \"‚ùå AutoReply: SendAutomationReply failed for BusinessId={BusinessId}, Recipient={Recipient}. Error={Error}\",\n                        businessId,\n                        trimmedNumber,\n                        result.Message);\n                }\n                else\n                {\n                    _logger.LogInformation(\n                        \"‚úÖ AutoReply: message sent successfully for BusinessId={BusinessId}, Recipient={Recipient}.\",\n                        businessId,\n                        trimmedNumber);\n                }\n\n                return result;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(\n                    ex,\n                    \"‚ùå AutoReply: unexpected exception while sending simple text reply for BusinessId={BusinessId}, Recipient={Recipient}.\",\n                    businessId,\n                    recipientNumber);\n\n                return ResponseResult.ErrorInfo(\n                    \"‚ùå Auto-reply failed due to an unexpected error.\",\n                    ex.Message);\n            }\n        }\n\n\n        /// <summary>\n        /// New overload for AutoReply that accepts a DeliveryMode.\n        /// Currently it delegates to the legacy implementation so\n        /// behaviour is unchanged. In the next steps we will route\n        /// Immediate vs Queued differently.\n        /// </summary>\n        public Task<ResponseResult> SendAutoReplyTextAsync(\n            Guid businessId,\n            string recipientNumber,\n            string body,\n            DeliveryMode mode,\n            CancellationToken ct = default)\n        {\n            // üîÅ Step 1: ignore mode, keep current behaviour.\n            return SendAutoReplyTextAsync(businessId, recipientNumber, body, ct);\n        }\n\n\n\n        #region SendTemplateMessageSimpleAsync Overload\n\n\n\n        //public async Task<ResponseResult> SendTemplateMessageSimpleAsync(Guid businessId, SimpleTemplateMessageDto dto)\n        //{\n        //    try\n        //    {\n        //        // Normalize inbound\n        //        string? providerUpper = string.IsNullOrWhiteSpace(dto.Provider)\n        //            ? null\n        //            : dto.Provider!.Trim().ToUpperInvariant();\n        //        string? providerKey = providerUpper?.ToLowerInvariant();\n        //        string? phoneNumberId = string.IsNullOrWhiteSpace(dto.PhoneNumberId)\n        //            ? null\n        //            : dto.PhoneNumberId!.Trim();\n\n        //        // Resolve missing provider/sender from WhatsAppPhoneNumbers\n        //        if (string.IsNullOrWhiteSpace(providerUpper))\n        //        {\n        //            var defPhone = await _db.WhatsAppPhoneNumbers\n        //                .AsNoTracking()\n        //                .Where(n => n.BusinessId == businessId && n.IsActive)\n        //                .OrderByDescending(n => n.IsDefault)\n        //                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n        //                .Select(n => new { n.Provider, n.PhoneNumberId })\n        //                .FirstOrDefaultAsync();\n\n        //            if (defPhone != null)\n        //            {\n        //                providerUpper = (defPhone.Provider ?? string.Empty).Trim().ToUpperInvariant();\n        //                providerKey = providerUpper.ToLowerInvariant();\n        //                if (string.IsNullOrWhiteSpace(phoneNumberId))\n        //                    phoneNumberId = defPhone.PhoneNumberId;\n        //            }\n        //        }\n\n        //        if (string.IsNullOrWhiteSpace(providerUpper))\n        //        {\n        //            var anySettingProvider = await _db.WhatsAppSettings\n        //                .AsNoTracking()\n        //                .Where(s => s.BusinessId == businessId && s.IsActive)\n        //                .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n        //                .Select(s => s.Provider)\n        //                .FirstOrDefaultAsync();\n\n        //            if (!string.IsNullOrWhiteSpace(anySettingProvider))\n        //            {\n        //                providerUpper = anySettingProvider.Trim().ToUpperInvariant();\n        //                providerKey = providerUpper.ToLowerInvariant();\n        //            }\n        //        }\n\n        //        if (providerUpper != \"PINNACLE\" && providerUpper != \"META_CLOUD\")\n        //        {\n        //            return ResponseResult.ErrorInfo(\n        //                \"‚ùå Missing provider.\",\n        //                \"No active WhatsApp sender found. Configure a PINNACLE or META_CLOUD sender for this business.\"\n        //            );\n        //        }\n\n        //        if (string.IsNullOrWhiteSpace(phoneNumberId))\n        //        {\n        //            var pn = await _db.WhatsAppPhoneNumbers\n        //                .AsNoTracking()\n        //                .Where(n => n.BusinessId == businessId\n        //                            && n.IsActive\n        //                            && n.Provider.ToLower() == providerKey)\n        //                .OrderByDescending(n => n.IsDefault)\n        //                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n        //                .Select(n => n.PhoneNumberId)\n        //                .FirstOrDefaultAsync();\n\n        //            if (!string.IsNullOrWhiteSpace(pn))\n        //                phoneNumberId = pn;\n        //        }\n\n        //        if (providerUpper == \"META_CLOUD\" && string.IsNullOrWhiteSpace(phoneNumberId))\n        //            return ResponseResult.ErrorInfo(\"‚ùå Missing PhoneNumberId for META_CLOUD. Configure a default sender or pass PhoneNumberId.\");\n\n        //        // Build minimal components (body only)\n        //        var parameters = (dto.TemplateParameters ?? new List<string>())\n        //            .Select(p => new { type = \"text\", text = p })\n        //            .ToArray();\n\n        //        var components = new List<object>();\n        //        if (parameters.Length > 0)\n        //            components.Add(new { type = \"body\", parameters });\n\n        //        var lang = string.IsNullOrWhiteSpace(dto.LanguageCode) ? \"en_US\" : dto.LanguageCode!;\n        //        _logger?.LogInformation(\"‚û°Ô∏è SEND-INTENT tmpl={Template} to={To} provider={Provider} pnid={PhoneNumberId}\",\n        //            dto.TemplateName, dto.RecipientNumber, providerUpper, phoneNumberId ?? \"(default)\");\n\n        //        var sendResult = await SendViaProviderAsync(\n        //            businessId,\n        //            providerUpper,\n        //            p => p.SendTemplateAsync(dto.RecipientNumber, dto.TemplateName, lang, components),\n        //            phoneNumberId\n        //        );\n\n        //        var log = new MessageLog\n        //        {\n        //            Id = Guid.NewGuid(),\n        //            BusinessId = businessId,\n        //            RecipientNumber = dto.RecipientNumber,\n        //            MessageContent = dto.TemplateName,\n        //            RenderedBody = TemplateParameterHelper.FillPlaceholders(\n        //                dto.TemplateBody ?? string.Empty,\n        //                dto.TemplateParameters ?? new List<string>()),\n\n        //            CTAFlowConfigId = dto.CTAFlowConfigId,\n        //            CTAFlowStepId = dto.CTAFlowStepId,\n\n        //            Provider = providerUpper,\n        //            ProviderMessageId = sendResult.MessageId,\n\n        //            Status = sendResult.Success ? \"Sent\" : \"Failed\",\n        //            ErrorMessage = sendResult.Success ? null : sendResult.Message,\n        //            RawResponse = sendResult.RawResponse,\n        //            MessageId = sendResult.MessageId,\n        //            SentAt = sendResult.Success ? DateTime.UtcNow : (DateTime?)null,\n        //            CreatedAt = DateTime.UtcNow,\n        //            Source = \"api\"\n        //        };\n\n        //        await _db.MessageLogs.AddAsync(log);\n        //        await _db.SaveChangesAsync();\n\n        //        return new ResponseResult\n        //        {\n        //            Success = sendResult.Success,\n        //            Message = sendResult.Success\n        //                ? \"‚úÖ Template sent successfully.\"\n        //                : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n        //            Data = new\n        //            {\n        //                Success = sendResult.Success,\n        //                MessageId = sendResult.MessageId,\n        //                LogId = log.Id\n        //            },\n        //            RawResponse = sendResult.RawResponse,\n        //            MessageId = sendResult.MessageId,\n        //            LogId = log.Id\n        //        };\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        try\n        //        {\n        //            await _db.MessageLogs.AddAsync(new MessageLog\n        //            {\n        //                Id = Guid.NewGuid(),\n        //                BusinessId = businessId,\n        //                RecipientNumber = dto.RecipientNumber,\n        //                MessageContent = dto.TemplateName,\n        //                RenderedBody = TemplateParameterHelper.FillPlaceholders(\n        //                    dto.TemplateBody ?? string.Empty,\n        //                    dto.TemplateParameters ?? new List<string>()),\n        //                Status = \"Failed\",\n        //                ErrorMessage = ex.Message,\n        //                CreatedAt = DateTime.UtcNow,\n        //                Source = \"api\"\n        //            });\n        //            await _db.SaveChangesAsync();\n        //        }\n        //        catch { /* ignore */ }\n\n        //        return ResponseResult.ErrorInfo(\"‚ùå Template send failed\", ex.Message);\n        //    }\n        //}\n        ///// <summary>\n        ///// New overload that is aware of DeliveryMode.\n        ///// For now, it simply delegates to the existing implementation\n        ///// (which behaves as immediate/direct send).\n        ///// In the next steps, we will branch on <paramref name=\"mode\"/>.\n        ///// </summary>\n        //// Over Load method\n        //public Task<ResponseResult> SendTemplateMessageSimpleAsync(\n        //    Guid businessId,\n        //    SimpleTemplateMessageDto dto,\n        //    DeliveryMode mode)\n        //{\n        //    // üîÅ Step 1: keep behaviour identical.\n        //    // We ignore `mode` for now and just call the existing method.\n        //    // Later we will:\n        //    //  - use Queued mode for outbox\n        //    //  - use Immediate mode for direct Meta Cloud sends\n        //    return SendTemplateMessageSimpleAsync(businessId, dto);\n        //}\n\n        #endregion\n\n        public async Task<ResponseResult> SendTemplateMessageSimpleAsync(Guid businessId, SimpleTemplateMessageDto dto)\n        {\n            try\n            {\n                // üîé Normalize inbound + respect DeliveryMode for logging/analytics\n                var mode = dto.DeliveryMode; // default is Queued if caller didn't set\n\n                string? providerUpper = string.IsNullOrWhiteSpace(dto.Provider)\n                    ? null\n                    : dto.Provider!.Trim().ToUpperInvariant();\n                string? providerKey = providerUpper?.ToLowerInvariant();\n                string? phoneNumberId = string.IsNullOrWhiteSpace(dto.PhoneNumberId)\n                    ? null\n                    : dto.PhoneNumberId!.Trim();\n\n                // Resolve missing provider/sender from WhatsAppPhoneNumbers\n                if (string.IsNullOrWhiteSpace(providerUpper))\n                {\n                    var defPhone = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId && n.IsActive)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => new { n.Provider, n.PhoneNumberId })\n                        .FirstOrDefaultAsync();\n\n                    if (defPhone != null)\n                    {\n                        providerUpper = (defPhone.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                        if (string.IsNullOrWhiteSpace(phoneNumberId))\n                            phoneNumberId = defPhone.PhoneNumberId;\n                    }\n                }\n\n                if (string.IsNullOrWhiteSpace(providerUpper))\n                {\n                    var anySettingProvider = await _db.WhatsAppSettings\n                        .AsNoTracking()\n                        .Where(s => s.BusinessId == businessId && s.IsActive)\n                        .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                        .Select(s => s.Provider)\n                        .FirstOrDefaultAsync();\n\n                    if (!string.IsNullOrWhiteSpace(anySettingProvider))\n                    {\n                        providerUpper = anySettingProvider.Trim().ToUpperInvariant();\n                        providerKey = providerUpper.ToLowerInvariant();\n                    }\n                }\n\n                if (providerUpper != \"PINNACLE\" && providerUpper != \"META_CLOUD\")\n                {\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Missing provider.\",\n                        \"No active WhatsApp sender found. Configure a PINNACLE or META_CLOUD sender for this business.\"\n                    );\n                }\n\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                {\n                    var pn = await _db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.BusinessId == businessId\n                                    && n.IsActive\n                                    && n.Provider.ToLower() == providerKey)\n                        .OrderByDescending(n => n.IsDefault)\n                        .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                        .Select(n => n.PhoneNumberId)\n                        .FirstOrDefaultAsync();\n\n                    if (!string.IsNullOrWhiteSpace(pn))\n                        phoneNumberId = pn;\n                }\n\n                if (providerUpper == \"META_CLOUD\" && string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\n                        \"‚ùå Missing PhoneNumberId for META_CLOUD. Configure a default sender or pass PhoneNumberId.\");\n\n                // Build minimal components (body only)\n                var parameters = (dto.TemplateParameters ?? new List<string>())\n                    .Select(p => new { type = \"text\", text = p })\n                    .ToArray();\n\n                var components = new List<object>();\n                if (parameters.Length > 0)\n                    components.Add(new { type = \"body\", parameters });\n\n                var lang = string.IsNullOrWhiteSpace(dto.LanguageCode) ? \"en_US\" : dto.LanguageCode!;\n\n                _logger?.LogInformation(\n                    \"‚û°Ô∏è SEND-INTENT tmpl={Template} to={To} provider={Provider} pnid={PhoneNumberId} mode={Mode} ctaFlowConfig={CtaFlowConfigId} ctaFlowStep={CtaFlowStepId}\",\n                    dto.TemplateName,\n                    dto.RecipientNumber,\n                    providerUpper,\n                    phoneNumberId ?? \"(default)\",\n                    mode,\n                    dto.CTAFlowConfigId,\n                    dto.CTAFlowStepId\n                );\n\n                // üßµ IMPORTANT:\n                // For now, BOTH Queued + Immediate behave the same: direct send.\n                // Later, if you wire a true Outbox, you can special-case `mode == DeliveryMode.Queued`\n                // to enqueue instead of calling SendViaProviderAsync.\n                var sendResult = await SendViaProviderAsync(\n                    businessId,\n                    providerUpper,\n                    p => p.SendTemplateAsync(dto.RecipientNumber, dto.TemplateName, lang, components),\n                    phoneNumberId\n                );\n\n                // üè∑ Smarter Source tagging:\n                // - If CTAFlowConfigId is set ‚Üí this is a CTA Flow step\n                // - Else ‚Üí normal API/template send\n                var isCtaFlow = dto.CTAFlowConfigId.HasValue;\n\n                var sourceTag = isCtaFlow\n                    ? (mode == DeliveryMode.Immediate ? \"cta-flow-immediate\" : \"cta-flow-queued\")\n                    : (mode == DeliveryMode.Immediate ? \"api-immediate\" : \"api-queued\");\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TemplateName,\n                    RenderedBody = TemplateParameterHelper.FillPlaceholders(\n                        dto.TemplateBody ?? string.Empty,\n                        dto.TemplateParameters ?? new List<string>()),\n\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n\n                    Provider = providerUpper,\n                    ProviderMessageId = sendResult.MessageId,\n\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    SentAt = sendResult.Success ? DateTime.UtcNow : (DateTime?)null,\n                    CreatedAt = DateTime.UtcNow,\n\n                    // üëá now carries CTA vs non-CTA + mode\n                    Source = sourceTag\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"‚úÖ Template sent successfully.\"\n                        : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new\n                    {\n                        Success = sendResult.Success,\n                        MessageId = sendResult.MessageId,\n                        LogId = log.Id\n                    },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                try\n                {\n                    await _db.MessageLogs.AddAsync(new MessageLog\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        RecipientNumber = dto.RecipientNumber,\n                        MessageContent = dto.TemplateName,\n                        RenderedBody = TemplateParameterHelper.FillPlaceholders(\n                            dto.TemplateBody ?? string.Empty,\n                            dto.TemplateParameters ?? new List<string>()),\n                        Status = \"Failed\",\n                        ErrorMessage = ex.Message,\n                        CreatedAt = DateTime.UtcNow,\n                        Source = \"api-error\"\n                    });\n                    await _db.SaveChangesAsync();\n                }\n                catch { /* ignore */ }\n\n                return ResponseResult.ErrorInfo(\"‚ùå Template send failed\", ex.Message);\n            }\n        }\n\n        /// <summary>\n        /// New overload that is aware of DeliveryMode.\n        /// Right now it just stamps the mode into the DTO\n        /// and calls the core implementation. Later, if you\n        /// implement a real outbox, this is the natural place\n        /// to branch behaviour.\n        /// </summary>\n        public Task<ResponseResult> SendTemplateMessageSimpleAsync(\n            Guid businessId,\n            SimpleTemplateMessageDto dto,\n            DeliveryMode mode)\n        {\n            // Keep DTO + intent in sync\n            dto.DeliveryMode = mode;\n\n            // For now, both modes use the same path.\n            return SendTemplateMessageSimpleAsync(businessId, dto);\n        }\n\n        public async Task<ResponseResult> SendImageCampaignAsync(Guid campaignId, Guid businessId, string sentBy)\n        {\n            try\n            {\n                var campaign = await _db.Campaigns\n                    .Include(c => c.MultiButtons)\n                    .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n\n                if (campaign == null)\n                    return ResponseResult.ErrorInfo(\"‚ùå Campaign not found or unauthorized.\");\n\n                var recipients = await _db.CampaignRecipients\n                    .Include(r => r.Contact)\n                    .Where(r => r.CampaignId == campaignId && r.BusinessId == businessId)\n                    .ToListAsync();\n\n                if (recipients.Count == 0)\n                    return ResponseResult.ErrorInfo(\"‚ö†Ô∏è No recipients assigned to this campaign.\");\n\n                var validButtons = campaign.MultiButtons\n                    ?.Where(b => !string.IsNullOrWhiteSpace(b.Title))\n                    .Select(b => new CtaButtonDto { Title = b.Title, Value = b.Value })\n                    .ToList();\n\n                if (validButtons == null || validButtons.Count == 0)\n                    return ResponseResult.ErrorInfo(\"‚ùå At least one CTA button with a valid title is required.\");\n\n                int successCount = 0, failCount = 0;\n\n                foreach (var recipient in recipients)\n                {\n                    if (recipient.Contact == null || string.IsNullOrWhiteSpace(recipient.Contact.PhoneNumber))\n                    {\n                        recipient.Status = \"Failed\";\n                        recipient.UpdatedAt = DateTime.UtcNow;\n                        failCount++;\n                        continue;\n                    }\n\n                    var dto = new SendMessageDto\n                    {\n                        BusinessId = businessId,\n                        RecipientNumber = recipient.Contact.PhoneNumber,\n                        MessageType = MessageTypeEnum.Image,\n                        MediaUrl = campaign.ImageUrl,\n                        TextContent = campaign.MessageTemplate,\n                        CtaButtons = validButtons,\n\n                        CampaignId = campaign.Id,\n                        SourceModule = \"image-campaign\",\n                        CustomerId = recipient.Contact.Id.ToString(),\n                        CustomerName = recipient.Contact.Name,\n                        CustomerPhone = recipient.Contact.PhoneNumber,\n                        CTATriggeredFrom = \"campaign\"\n                    };\n\n                    var result = await SendImageWithCtaAsync(dto);\n\n                    var sendLog = new CampaignSendLog\n                    {\n                        Id = Guid.NewGuid(),\n                        CampaignId = campaign.Id,\n                        ContactId = recipient.Contact.Id,\n                        RecipientId = recipient.Id,\n                        MessageLogId = result?.LogId,\n                        SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                        SentAt = DateTime.UtcNow,\n                        CreatedBy = sentBy,\n                        BusinessId = businessId,\n                    };\n                    await _db.CampaignSendLogs.AddAsync(sendLog);\n\n                    if (result.Success)\n                    {\n                        recipient.Status = \"Sent\";\n                        recipient.SentAt = DateTime.UtcNow;\n                        recipient.UpdatedAt = DateTime.UtcNow;\n                        successCount++;\n                    }\n                    else\n                    {\n                        recipient.Status = \"Failed\";\n                        recipient.UpdatedAt = DateTime.UtcNow;\n                        failCount++;\n                    }\n                }\n\n                await _db.SaveChangesAsync();\n\n                await _db.Campaigns\n                    .Where(c => c.Id == campaign.Id && c.BusinessId == businessId)\n                    .ExecuteUpdateAsync(s => s\n                        .SetProperty(c => c.Status, _ => \"Sent\")\n                        .SetProperty(c => c.UpdatedAt, _ => DateTime.UtcNow));\n\n                return ResponseResult.SuccessInfo($\"‚úÖ Campaign sent.\\nüì§ Success: {successCount}, ‚ùå Failed: {failCount}\");\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine($\"‚ùå Error sending image campaign: {ex.Message}\");\n                return ResponseResult.ErrorInfo(\"‚ùå Unexpected error while sending image campaign.\", ex.ToString());\n            }\n        }\n\n        public async Task<ResponseResult> SendTemplateCampaignAsync(Guid campaignId, Guid businessId, string sentBy)\n        {\n            try\n            {\n                var campaign = await _db.Campaigns\n                    .AsNoTracking()\n                    .Where(c => c.Id == campaignId && c.BusinessId == businessId)\n                    .Select(c => new\n                    {\n                        c.Id,\n                        c.BusinessId,\n                        c.MessageTemplate,\n                        c.TemplateId,\n                        c.Provider,\n                        c.PhoneNumberId,\n                        c.ImageUrl\n                    })\n                    .FirstOrDefaultAsync();\n\n                if (campaign == null)\n                    return ResponseResult.ErrorInfo(\"‚ùå Campaign not found or unauthorized.\");\n\n                var templateName = !string.IsNullOrWhiteSpace(campaign.TemplateId)\n                    ? campaign.TemplateId!\n                    : (campaign.MessageTemplate ?? \"\").Trim();\n\n                if (string.IsNullOrWhiteSpace(templateName))\n                    return ResponseResult.ErrorInfo(\"‚ùå Campaign has no template selected.\");\n\n                var lang = await _db.WhatsAppTemplates\n                    .AsNoTracking()\n                    .Where(w => w.BusinessId == businessId && w.Name == templateName)\n                    .OrderByDescending(w => (w.UpdatedAt > w.CreatedAt ? w.UpdatedAt : w.CreatedAt))\n                    .Select(w => w.LanguageCode)\n                    .FirstOrDefaultAsync();\n                if (string.IsNullOrWhiteSpace(lang)) lang = \"en_US\";\n\n                var recipients = await _db.CampaignRecipients\n                    .AsNoTracking()\n                    .Include(r => r.AudienceMember)\n                    .Include(r => r.Contact)\n                    .Where(r => r.CampaignId == campaignId && r.BusinessId == businessId)\n                    .Select(r => new\n                    {\n                        r.Id,\n                        r.ContactId,\n                        AudienceContactId = r.AudienceMember != null ? r.AudienceMember.ContactId : (Guid?)null,\n                        r.ResolvedParametersJson,\n                        r.ResolvedButtonUrlsJson,\n                        Phone = r.AudienceMember != null && !string.IsNullOrEmpty(r.AudienceMember.PhoneE164)\n                                ? r.AudienceMember.PhoneE164\n                                : (r.Contact != null ? r.Contact.PhoneNumber : null)\n                    })\n                    .ToListAsync();\n\n                if (recipients.Count == 0)\n                    return ResponseResult.ErrorInfo(\"‚ö†Ô∏è No recipients materialized for this campaign.\");\n\n                var provider = (campaign.Provider ?? \"\").Trim().ToUpperInvariant();\n                if (provider != \"PINNACLE\" && provider != \"META_CLOUD\")\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider on campaign. Must be 'PINNACLE' or 'META_CLOUD'.\");\n\n                var phoneNumberId = string.IsNullOrWhiteSpace(campaign.PhoneNumberId) ? null : campaign.PhoneNumberId!.Trim();\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\"‚ùå Campaign has no sender number (PhoneNumberId).\");\n\n                int success = 0, fail = 0;\n                var successIds = new List<Guid>(recipients.Count);\n                var failedIds = new List<Guid>();\n                var sendLogs = new List<CampaignSendLog>(recipients.Count);\n\n                foreach (var r in recipients)\n                {\n                    if (string.IsNullOrWhiteSpace(r.Phone))\n                    {\n                        failedIds.Add(r.Id);\n                        continue;\n                    }\n\n                    string[] bodyParams;\n                    try\n                    {\n                        bodyParams = string.IsNullOrWhiteSpace(r.ResolvedParametersJson)\n                            ? Array.Empty<string>()\n                            : JsonSerializer.Deserialize<string[]>(r.ResolvedParametersJson!) ?? Array.Empty<string>();\n                    }\n                    catch { bodyParams = Array.Empty<string>(); }\n\n                    Dictionary<string, string> buttonVars;\n                    try\n                    {\n                        buttonVars = string.IsNullOrWhiteSpace(r.ResolvedButtonUrlsJson)\n                            ? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)\n                            : JsonSerializer.Deserialize<Dictionary<string, string>>(r.ResolvedButtonUrlsJson!)\n                              ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n                    }\n                    catch { buttonVars = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase); }\n\n                    var components = new List<object>();\n\n                    var headerImage = !string.IsNullOrWhiteSpace(campaign.ImageUrl)\n                        ? campaign.ImageUrl\n                        : (buttonVars.TryGetValue(\"header.image_url\", out var hv) && !string.IsNullOrWhiteSpace(hv) ? hv : null);\n\n                    if (!string.IsNullOrWhiteSpace(headerImage))\n                    {\n                        components.Add(new\n                        {\n                            type = \"header\",\n                            parameters = new object[]\n                            {\n                                new { type = \"image\", image = new { link = headerImage! } }\n                            }\n                        });\n                    }\n\n                    if (bodyParams.Length > 0)\n                    {\n                        components.Add(new\n                        {\n                            type = \"body\",\n                            parameters = bodyParams.Select(p => (object)new { type = \"text\", text = p }).ToArray()\n                        });\n                    }\n\n                    foreach (var pos in new[] { 1, 2, 3 })\n                    {\n                        var key = $\"button{pos}.url_param\";\n                        if (buttonVars.TryGetValue(key, out var urlParam) && !string.IsNullOrWhiteSpace(urlParam))\n                        {\n                            components.Add(new\n                            {\n                                type = \"button\",\n                                sub_type = \"url\",\n                                index = (pos - 1).ToString(),\n                                parameters = new object[] { new { type = \"text\", text = urlParam } }\n                            });\n                        }\n                    }\n\n                    var payload = new\n                    {\n                        messaging_product = \"whatsapp\",\n                        to = r.Phone!,\n                        type = \"template\",\n                        template = new\n                        {\n                            name = templateName,\n                            language = new { code = lang },\n                            components = components\n                        }\n                    };\n\n                    var result = await SendPayloadAsync(businessId, provider, payload, phoneNumberId);\n                    if (result.Success) { success++; successIds.Add(r.Id); } else { fail++; failedIds.Add(r.Id); }\n\n                    var contactId = r.ContactId ?? r.AudienceContactId;\n                    sendLogs.Add(new CampaignSendLog\n                    {\n                        Id = Guid.NewGuid(),\n                        CampaignId = campaign.Id,\n                        ContactId = contactId,\n                        RecipientId = r.Id,\n                        MessageLogId = result?.LogId,\n                        SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                        SentAt = DateTime.UtcNow,\n                        CreatedBy = sentBy,\n                        BusinessId = businessId,\n                    });\n                }\n\n                if (sendLogs.Count > 0)\n                    await _db.CampaignSendLogs.AddRangeAsync(sendLogs);\n\n                if (successIds.Count > 0)\n                {\n                    await _db.CampaignRecipients\n                        .Where(x => x.CampaignId == campaignId && x.BusinessId == businessId && successIds.Contains(x.Id))\n                        .ExecuteUpdateAsync(s => s\n                            .SetProperty(x => x.Status, _ => \"Sent\")\n                            .SetProperty(x => x.SentAt, _ => DateTime.UtcNow)\n                            .SetProperty(x => x.UpdatedAt, _ => DateTime.UtcNow));\n                }\n\n                if (failedIds.Count > 0)\n                {\n                    await _db.CampaignRecipients\n                        .Where(x => x.CampaignId == campaignId && x.BusinessId == businessId && failedIds.Contains(x.Id))\n                        .ExecuteUpdateAsync(s => s\n                            .SetProperty(x => x.Status, _ => \"Failed\")\n                            .SetProperty(x => x.UpdatedAt, _ => DateTime.UtcNow));\n                }\n\n                await _db.SaveChangesAsync();\n\n                await _db.Campaigns\n                    .Where(c => c.Id == campaign.Id && c.BusinessId == businessId)\n                    .ExecuteUpdateAsync(s => s\n                        .SetProperty(c => c.Status, _ => \"Sent\")\n                        .SetProperty(c => c.UpdatedAt, _ => DateTime.UtcNow));\n\n                return ResponseResult.SuccessInfo($\"‚úÖ Template campaign sent. üì§ Success: {success}, ‚ùå Failed: {fail}\");\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"‚ùå Error sending template campaign.\", ex.ToString());\n            }\n        }\n\n        public async Task<ResponseResult> SendImageWithCtaAsync(SendMessageDto dto)\n        {\n            try\n            {\n                Console.WriteLine($\"üì§ Sending image+CTA to {dto.RecipientNumber}\");\n\n                if (string.IsNullOrWhiteSpace(dto.TextContent))\n                    return ResponseResult.ErrorInfo(\"‚ùå Image message caption (TextContent) cannot be empty.\");\n\n                if (string.IsNullOrWhiteSpace(dto.Provider) ||\n                    (dto.Provider != \"PINNACLE\" && dto.Provider != \"META_CLOUD\"))\n                {\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\",\n                        \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n                }\n\n                var validButtons = dto.CtaButtons?\n                    .Where(b => !string.IsNullOrWhiteSpace(b.Title))\n                    .Take(3)\n                    .Select((btn, index) => new\n                    {\n                        type = \"reply\",\n                        reply = new\n                        {\n                            id = $\"btn_{index + 1}_{Guid.NewGuid():N}\".Substring(0, 16),\n                            title = btn.Title\n                        }\n                    })\n                    .ToList();\n\n                if (validButtons == null || validButtons.Count == 0)\n                    return ResponseResult.ErrorInfo(\"‚ùå At least one CTA button with a valid title is required.\");\n\n                var payload = new\n                {\n                    messaging_product = \"whatsapp\",\n                    to = dto.RecipientNumber,\n                    type = \"interactive\",\n                    interactive = new\n                    {\n                        type = \"button\",\n                        body = new { text = dto.TextContent },\n                        action = new { buttons = validButtons }\n                    },\n                    image = string.IsNullOrWhiteSpace(dto.MediaUrl) ? null : new { link = dto.MediaUrl }\n                };\n\n                var sendResult = await SendViaProviderAsync(\n                    dto.BusinessId,\n                    dto.Provider,\n                    p => p.SendInteractiveAsync(payload),\n                    dto.PhoneNumberId\n                );\n\n                string? messageId = sendResult.MessageId;\n                if (string.IsNullOrWhiteSpace(messageId) && !string.IsNullOrWhiteSpace(sendResult.RawResponse))\n                {\n                    try\n                    {\n                        var raw = sendResult.RawResponse.TrimStart();\n                        if (raw.StartsWith(\"{\"))\n                        {\n                            using var doc = JsonDocument.Parse(raw);\n                            if (doc.RootElement.TryGetProperty(\"messages\", out var msgs) &&\n                                msgs.ValueKind == JsonValueKind.Array &&\n                                msgs.GetArrayLength() > 0 &&\n                                msgs[0].TryGetProperty(\"id\", out var idProp))\n                            {\n                                messageId = idProp.GetString();\n                            }\n                        }\n                    }\n                    catch { /* best-effort */ }\n                }\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TextContent ?? \"[Image with CTA]\",\n                    RenderedBody = dto.TextContent ?? \"\",\n                    MediaUrl = dto.MediaUrl,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = messageId,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"‚úÖ Image+CTA message sent.\"\n                        : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new\n                    {\n                        Success = sendResult.Success,\n                        MessageId = messageId,\n                        LogId = log.Id\n\n                    },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = messageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                Console.WriteLine(\"‚ùå Exception in SendImageWithCtaAsync: \" + ex.Message);\n\n                await _db.MessageLogs.AddAsync(new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TextContent ?? \"[Image CTA Failed]\",\n                    RenderedBody = dto.TextContent ?? \"[Failed image CTA]\",\n                    Status = \"Failed\",\n                    ErrorMessage = ex.Message,\n                    RawResponse = ex.ToString(),\n                    CreatedAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n                });\n\n                await _db.SaveChangesAsync();\n\n                return ResponseResult.ErrorInfo(\"‚ùå Failed to send image+CTA.\", ex.ToString());\n            }\n        }\n        [Obsolete(\"Use outbox + SendPayloadAsync via worker.\")]\n        public async Task<ResponseResult> SendImageTemplateMessageAsync(ImageTemplateMessageDto dto, Guid businessId)\n        {\n            try\n            {\n                if (string.IsNullOrWhiteSpace(dto.Provider) ||\n                    (dto.Provider != \"PINNACLE\" && dto.Provider != \"META_CLOUD\"))\n                {\n                    return ResponseResult.ErrorInfo(\"‚ùå Invalid provider.\",\n                        \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n                }\n\n                var components = new List<object>();\n\n                if (!string.IsNullOrWhiteSpace(dto.HeaderImageUrl))\n                {\n                    components.Add(new\n                    {\n                        type = \"header\",\n                        parameters = new[]\n                        {\n                            new { type = \"image\", image = new { link = dto.HeaderImageUrl! } }\n                        }\n                    });\n                }\n\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = (dto.TemplateParameters ?? new List<string>())\n                        .Select(p => new { type = \"text\", text = p })\n                        .ToArray()\n                });\n\n                var btns = dto.ButtonParameters ?? new List<CampaignButtonDto>();\n                for (int i = 0; i < btns.Count && i < 3; i++)\n                {\n                    var btn = btns[i];\n                    var subType = btn.ButtonType?.ToLowerInvariant();\n                    if (string.IsNullOrWhiteSpace(subType)) continue;\n\n                    var button = new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"button\",\n                        [\"sub_type\"] = subType,\n                        [\"index\"] = i.ToString()\n                    };\n\n                    if (subType == \"quick_reply\" && !string.IsNullOrWhiteSpace(btn.TargetUrl))\n                        button[\"parameters\"] = new[] { new { type = \"payload\", payload = btn.TargetUrl! } };\n                    else if (subType == \"url\" && !string.IsNullOrWhiteSpace(btn.TargetUrl))\n                        button[\"parameters\"] = new[] { new { type = \"text\", text = btn.TargetUrl! } };\n\n                    components.Add(button);\n                }\n\n                var lang = string.IsNullOrWhiteSpace(dto.LanguageCode) ? \"en_US\" : dto.LanguageCode!;\n\n                var sendResult = await SendViaProviderAsync(\n                    businessId,\n                    dto.Provider,\n                    p => p.SendTemplateAsync(dto.RecipientNumber, dto.TemplateName, lang, components),\n                    dto.PhoneNumberId\n                );\n\n                var renderedBody = TemplateParameterHelper.FillPlaceholders(\n                    dto.TemplateBody ?? \"\",\n                    dto.TemplateParameters ?? new List<string>());\n\n                var log = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TemplateName,\n                    MediaUrl = dto.HeaderImageUrl,\n                    RenderedBody = renderedBody,\n                    Status = sendResult.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = sendResult.Success ? null : sendResult.Message,\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n                };\n\n                await _db.MessageLogs.AddAsync(log);\n                await _db.SaveChangesAsync();\n\n                return new ResponseResult\n                {\n                    Success = sendResult.Success,\n                    Message = sendResult.Success\n                        ? \"‚úÖ Image template sent successfully.\"\n                        : (sendResult.Message ?? \"‚ùå WhatsApp API returned an error.\"),\n                    Data = new { Success = sendResult.Success, MessageId = sendResult.MessageId, LogId = log.Id },\n                    RawResponse = sendResult.RawResponse,\n                    MessageId = sendResult.MessageId,\n                    LogId = log.Id\n                };\n            }\n            catch (Exception ex)\n            {\n                await _db.MessageLogs.AddAsync(new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    RecipientNumber = dto.RecipientNumber,\n                    MessageContent = dto.TemplateName,\n                    RenderedBody = TemplateParameterHelper.FillPlaceholders(dto.TemplateBody ?? \"\", dto.TemplateParameters ?? new List<string>()),\n                    MediaUrl = dto.HeaderImageUrl,\n                    Status = \"Failed\",\n                    ErrorMessage = ex.Message,\n                    RawResponse = ex.ToString(),\n                    CreatedAt = DateTime.UtcNow,\n                    CTAFlowConfigId = dto.CTAFlowConfigId,\n                    CTAFlowStepId = dto.CTAFlowStepId,\n                });\n\n                await _db.SaveChangesAsync();\n                return ResponseResult.ErrorInfo(\"‚ùå Error sending image template.\", ex.ToString());\n            }\n        }\n\n        public async Task<IEnumerable<RecentMessageLogDto>> GetLogsByBusinessIdAsync(Guid businessId)\n        {\n            var logs = await _db.MessageLogs\n                .Where(m => m.BusinessId == businessId)\n                .OrderByDescending(m => m.CreatedAt)\n                .Take(1000)\n                .Select(m => new RecentMessageLogDto\n                {\n                    Id = m.Id,\n                    RecipientNumber = m.RecipientNumber,\n                    MessageContent = m.MessageContent,\n                    Status = m.Status,\n                    CreatedAt = m.CreatedAt,\n                    SentAt = m.SentAt,\n                    ErrorMessage = m.ErrorMessage\n                })\n                .ToListAsync();\n\n            return logs;\n        }\n\n        public Task<ResponseResult> SendDocumentTemplateMessageAsync(DocumentTemplateMessageDto dto, Guid businessId)\n        {\n            throw new NotImplementedException();\n        }\n\n        private async Task<IReadOnlyList<WhatsAppSettingEntity>> GetBusinessWhatsAppSettingsAsync(Guid businessId)\n        {\n            if (_settingsCache.TryGetValue(businessId, out var cached) && cached.expiresAt > DateTime.UtcNow)\n                return cached.setting;\n\n            var items = await _db.WhatsAppSettings\n                .Where(s => s.BusinessId == businessId)\n                .ToListAsync();\n\n            if (items == null || items.Count == 0)\n                throw new Exception(\"WhatsApp settings not found.\");\n\n            var ro = items.AsReadOnly();\n            _settingsCache[businessId] = (ro, DateTime.UtcNow.AddMinutes(5));\n            return ro;\n        }\n    }\n}\n\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/SendPipeline/ProviderNormalizer.cs",
      "sha256": "b1aa904138bd23abe377835e2a4ccce78f1742142ddb717df48287d9d1e100ea",
      "language": "csharp",
      "size": 846,
      "content": "namespace xbytechat.api.Features.CampaignModule.Services.SendPipeline\n{\n    public static class ProviderNormalizer\n    {\n\n        public static string ForDb(string? providerFromSettings)\n        {\n            var v = (providerFromSettings ?? string.Empty).Trim();\n            // If you store \"meta_cloud\" / \"pinnacle\" in DB, keep it as-is:\n            return v.ToLowerInvariant(); // e.g. \"meta_cloud\", \"pinnacle\"\n        }\n\n        public static string ForSend(string? providerFromSettings)\n        {\n            var v = (providerFromSettings ?? string.Empty).Trim().ToLowerInvariant();\n            return v switch\n            {\n                \"pinnacle\" => \"PINNACLE\",\n                \"meta_cloud\" => \"META_CLOUD\",\n                _ => providerFromSettings ?? string.Empty // pass-through for future providers\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/SendPipeline/TemplateHeaderInspector.cs",
      "sha256": "d6dfbd0106161bd235f70126864bcb5cf4ede304695288ffd610794077c5b428",
      "language": "csharp",
      "size": 3096,
      "content": "using System;\nusing Newtonsoft.Json.Linq;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services.SendPipeline\n{\n    public enum TemplateHeaderKind\n    {\n        Text,\n        Image,\n        Video,\n        Document\n    }\n\n    public static class TemplateHeaderInspector\n    {\n        /// <summary>\n        /// Reads a WhatsApp template row (from DB) and infers the HEADER kind quickly,\n        /// using RawJson when present, otherwise falling back to flags like HasImageHeader.\n        /// No network calls. Pure and deterministic.\n        /// </summary>\n        public static TemplateHeaderKind Infer(WhatsAppTemplate templateRow)\n        {\n            if (templateRow == null) return TemplateHeaderKind.Text;\n\n            // 1) Prefer RawJson (when available) ‚Äî read only the minimal bits we need\n            var raw = templateRow.RawJson;\n            if (!string.IsNullOrWhiteSpace(raw))\n            {\n                try\n                {\n                    var root = JObject.Parse(raw);\n                    var comps = root[\"components\"] as JArray;\n                    if (comps != null)\n                    {\n                        foreach (var comp in comps)\n                        {\n                            var type = comp?[\"type\"]?.ToString()?.Trim().ToUpperInvariant();\n                            if (type == \"HEADER\")\n                            {\n                                var format = comp?[\"format\"]?.ToString()?.Trim().ToUpperInvariant();\n                                if (!string.IsNullOrEmpty(format))\n                                {\n                                    if (format == \"IMAGE\") return TemplateHeaderKind.Image;\n                                    if (format == \"VIDEO\") return TemplateHeaderKind.Video;\n                                    if (format == \"DOCUMENT\" || format == \"PDF\") return TemplateHeaderKind.Document;\n                                    return TemplateHeaderKind.Text;\n                                }\n                                // If TYPE=HEADER but no format => treat as Text\n                                return TemplateHeaderKind.Text;\n                            }\n                        }\n                    }\n                }\n                catch\n                {\n                    // swallow; fall through to flags\n                }\n            }\n\n            // 2) Fallback: existing DB flags\n           // if (templateRow.HasImageHeader) return TemplateHeaderKind.Image;\n\n            return TemplateHeaderKind.Text;\n        }\n\n        /// <summary>\n        /// Maps a header kind to our ‚ÄúmediaType‚Äù shorthand used by send routing.\n        /// </summary>\n        public static string ToMediaType(TemplateHeaderKind kind)\n        {\n            return kind switch\n            {\n                TemplateHeaderKind.Image => \"image\",\n                TemplateHeaderKind.Video => \"video\",\n                TemplateHeaderKind.Document => \"document\",\n                _ => \"text\"\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Services/TemplateMessageSender.cs",
      "sha256": "ccf337582a45a95cf31b6229f11d4734a66913dcdbf49f14b0499257ccc01fbe",
      "language": "csharp",
      "size": 15092,
      "content": "// üìÑ File: Features/MessagesEngine/Services/TemplateMessageSender.cs\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.Helpers;\n\n//using xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\nusing xbytechat.api.Shared.utility;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.Features.MessagesEngine.Services\n{\n    public class TemplateMessageSender : ITemplateMessageSender\n    {\n        private readonly AppDbContext _db;\n        private readonly HttpClient _httpClient;\n        private readonly ILogger<TemplateMessageSender> _logger;\n        private readonly IWhatsAppTemplateFetcherService _templateService;\n\n        public TemplateMessageSender(\n            AppDbContext db,\n            HttpClient httpClient,\n            ILogger<TemplateMessageSender> logger,\n            IWhatsAppTemplateFetcherService templateService)\n        {\n            _db = db;\n            _httpClient = httpClient;\n            _logger = logger;\n            _templateService = templateService;\n        }\n\n        //public async Task<ResponseResult> SendTemplateMessageToContactAsync(\n        //    Guid businessId,\n        //    Contact contact,\n        //    string templateName,\n        //    List<string> templateParams,\n        //    string? imageUrl = null,\n        //    List<CampaignButton>? buttons = null,\n        //    string? source = null,\n        //    Guid? refMessageId = null)\n        //{\n        //    var setting = await _db.WhatsAppSettings.FirstOrDefaultAsync(s => s.BusinessId == businessId && s.IsActive);\n        //    if (setting == null)\n        //        return ResponseResult.ErrorInfo(\"WhatsApp settings not found for this business.\");\n\n        //    var template = await _templateService.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n        //    if (template == null)\n        //        return ResponseResult.ErrorInfo(\"Template not found or invalid.\");\n\n        //    var payload = new Dictionary<string, object>\n        //    {\n        //        [\"messaging_product\"] = \"whatsapp\",\n        //        [\"to\"] = contact.PhoneNumber,\n        //        [\"type\"] = \"template\",\n        //        [\"template\"] = new\n        //        {\n        //            name = template.Name,\n        //            language = new { code = template.Language },\n        //            components = BuildTemplateComponents(template, templateParams, imageUrl, buttons)\n        //        }\n        //    };\n\n        //    _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n        //    var json = JsonSerializer.Serialize(payload);\n        //    var response = await _httpClient.PostAsync(\n        //        $\"{setting.ApiUrl?.TrimEnd('/') ?? \"https://graph.facebook.com/v22.0\"}/{setting.PhoneNumberId}/messages\",\n        //        new StringContent(json, Encoding.UTF8, \"application/json\"));\n\n        //    var responseBody = await response.Content.ReadAsStringAsync();\n        //    var status = response.IsSuccessStatusCode ? \"Sent\" : \"Failed\";\n\n        //    await _db.MessageLogs.AddAsync(new MessageLog\n        //    {\n        //        Id = Guid.NewGuid(),\n        //        BusinessId = businessId,\n        //        ContactId = contact.Id,\n        //        MessageContent = template.Name,\n        //        MediaUrl = imageUrl,\n        //        Status = status,\n        //        RawResponse = responseBody,\n        //        ErrorMessage = response.IsSuccessStatusCode ? null : responseBody,\n        //        Source = source,\n        //        RefMessageId = refMessageId,\n        //        CreatedAt = DateTime.UtcNow,\n        //        SentAt = DateTime.UtcNow\n        //    });\n\n        //    await _db.SaveChangesAsync();\n        //    return response.IsSuccessStatusCode\n        //        ? ResponseResult.SuccessInfo(\"‚úÖ Message sent successfully\", null, responseBody)\n        //        : ResponseResult.ErrorInfo(\"‚ùå Message failed\", null, responseBody);\n\n        //}\n\n        public async Task<ResponseResult> SendTemplateMessageToContactAsync(\n    Guid businessId,\n    Contact contact,\n    string templateName,\n    List<string> templateParams,\n    string? imageUrl = null,\n    List<CampaignButton>? buttons = null,\n    string? source = null,\n    Guid? refMessageId = null)\n        {\n            // 1) Load settings (provider, keys, base url, etc.)\n            var setting = await _db.WhatsAppSettings\n                .AsNoTracking()\n                .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.IsActive);\n\n            if (setting == null)\n                return ResponseResult.ErrorInfo(\"‚ùå WhatsApp settings not found for this business.\");\n\n            // 2) Pick the default phone number for THIS provider from WhatsAppPhoneNumbers\n            var phone = await _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(p => p.BusinessId == businessId\n                            && p.IsActive\n                            && p.Provider.ToLower() == (setting.Provider ?? string.Empty).ToLower())\n                .OrderByDescending(p => p.IsDefault)\n                .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                .Select(p => new { p.PhoneNumberId, p.WhatsAppBusinessNumber })\n                .FirstOrDefaultAsync();\n\n            var provider = (setting.Provider ?? string.Empty).Trim().ToUpperInvariant();\n            var phoneNumberId = phone?.PhoneNumberId;  // may be null for Pinnacle if you use WABA id\n            var baseUrl = (setting.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n\n            // 3) Template meta\n            var template = await _templateService.GetTemplateByNameAsync(\n                businessId, templateName, includeButtons: true);\n\n            if (template == null)\n                return ResponseResult.ErrorInfo(\"‚ùå Template not found or invalid.\");\n\n            // 4) Provider-specific URL + headers\n            string url;\n            using var req = new HttpRequestMessage(HttpMethod.Post, \"\");\n\n            if (provider == \"META_CLOUD\")\n            {\n                if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                    return ResponseResult.ErrorInfo(\"‚ùå Meta access token (ApiKey) missing.\");\n                if (string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\"‚ùå PhoneNumberId not configured for Meta Cloud.\");\n\n                if (string.IsNullOrWhiteSpace(baseUrl))\n                    baseUrl = \"https://graph.facebook.com/v22.0\";\n\n                url = $\"{baseUrl}/{phoneNumberId}/messages\";\n                req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n            }\n            else if (provider == \"PINNACLE\")\n            {\n                if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                    return ResponseResult.ErrorInfo(\"‚ùå Pinnacle API key missing.\");\n\n                if (string.IsNullOrWhiteSpace(baseUrl))\n                    baseUrl = \"https://partnersv1.pinbot.ai\";\n                if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase))\n                    baseUrl += \"/v3\";\n\n                var pathId = !string.IsNullOrWhiteSpace(setting.WabaId)\n                                ? setting.WabaId!.Trim()\n                                : (phoneNumberId ?? string.Empty).Trim();\n                if (string.IsNullOrWhiteSpace(pathId))\n                    return ResponseResult.ErrorInfo(\"‚ùå Provide WABA ID or PhoneNumberId for Pinnacle.\");\n\n                url = $\"{baseUrl}/{pathId}/messages\";\n                // put the key everywhere Pinnacle might accept it\n                req.Headers.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n                req.Headers.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n                req.Headers.Authorization = new AuthenticationHeaderValue(\"Apikey\", setting.ApiKey);\n            }\n            else\n            {\n                return ResponseResult.ErrorInfo($\"‚ùå Unsupported provider: {setting.Provider}\");\n            }\n\n            // 5) Payload (language field differs by provider)\n            object components = BuildTemplateComponents(template, templateParams, imageUrl, buttons);\n            object payload = (provider == \"PINNACLE\")\n                ? new\n                {\n                    messaging_product = \"whatsapp\",\n                    to = contact.PhoneNumber,\n                    type = \"template\",\n                    template = new\n                    {\n                        name = template.Name,\n                        language = template.Language,    // Pinnacle expects a string\n                        components\n                    }\n                }\n                : new\n                {\n                    messaging_product = \"whatsapp\",\n                    to = contact.PhoneNumber,\n                    type = \"template\",\n                    template = new\n                    {\n                        name = template.Name,\n                        language = new { code = template.Language }, // Meta needs { code: \"en_US\" }\n                        components\n                    }\n                };\n\n            var json = JsonSerializer.Serialize(payload, new JsonSerializerOptions\n            {\n                DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull\n            });\n\n            req.RequestUri = new Uri(url);\n            req.Content = new StringContent(json, Encoding.UTF8, \"application/json\");\n\n            // 6) Send and log\n            var response = await _httpClient.SendAsync(req);\n            var responseBody = await response.Content.ReadAsStringAsync();\n            var status = response.IsSuccessStatusCode ? \"Sent\" : \"Failed\";\n\n            await _db.MessageLogs.AddAsync(new MessageLog\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                ContactId = contact.Id,\n                MessageContent = template.Name,\n                MediaUrl = imageUrl,\n                Status = status,\n                RawResponse = responseBody,\n                ErrorMessage = response.IsSuccessStatusCode ? null : responseBody,\n                Source = source,\n                RefMessageId = refMessageId,\n                CreatedAt = DateTime.UtcNow,\n                SentAt = DateTime.UtcNow\n            });\n\n            await _db.SaveChangesAsync();\n\n            return response.IsSuccessStatusCode\n                ? ResponseResult.SuccessInfo(\"‚úÖ Message sent successfully\", null, responseBody)\n                : ResponseResult.ErrorInfo(\"‚ùå Message failed\", null, responseBody);\n        }\n\n        public async Task<ResponseResult> SendTemplateCampaignAsync(Campaign campaign)\n        {\n            if (campaign == null || campaign.IsDeleted)\n                return ResponseResult.ErrorInfo(\"Invalid or deleted campaign.\");\n\n            var contacts = await _db.CampaignRecipients\n                .Include(r => r.Contact)\n                .Where(r => r.CampaignId == campaign.Id && r.Contact != null)\n                .ToListAsync();\n\n            if (!contacts.Any())\n                return ResponseResult.ErrorInfo(\"No contacts found for this campaign.\");\n\n            var templateName = campaign.TemplateId;\n            var templateParams = TemplateParameterHelper.ParseTemplateParams(campaign.TemplateParameters);\n            var templateMeta = await _templateService.GetTemplateByNameAsync(campaign.BusinessId, templateName, includeButtons: true);\n\n            if (templateMeta == null)\n                return ResponseResult.ErrorInfo(\"Template metadata not found.\");\n\n            int success = 0, failed = 0;\n\n            foreach (var r in contacts)\n            {\n                var result = await SendTemplateMessageToContactAsync(\n                    campaign.BusinessId,\n                    r.Contact,\n                    templateName,\n                    templateParams,\n                    campaign.ImageUrl,\n                    campaign.MultiButtons?.ToList(),\n                    source: \"campaign\",\n                    refMessageId: campaign.Id);\n\n                await _db.CampaignSendLogs.AddAsync(new CampaignSendLog\n                {\n                    Id = Guid.NewGuid(),\n                    CampaignId = campaign.Id,\n                    ContactId = r.ContactId,\n                    RecipientId = r.Id,\n                    MessageBody = campaign.MessageBody ?? templateName,\n                    TemplateId = templateName,\n                    SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    CreatedBy = campaign.CreatedBy\n                });\n\n                if (result.Success) success++;\n                else failed++;\n            }\n\n            await _db.SaveChangesAsync();\n            return ResponseResult.SuccessInfo($\"üì§ Sent to {success}, ‚ùå Failed for {failed}.\");\n        }\n\n        private List<object> BuildTemplateComponents(\n            TemplateMetadataDto template,\n            List<string> paramsList,\n            string? imageUrl,\n            List<CampaignButton>? buttons)\n        {\n            var components = new List<object>();\n\n            if (template.HasImageHeader && !string.IsNullOrWhiteSpace(imageUrl))\n            {\n                components.Add(new\n                {\n                    type = \"header\",\n                    parameters = new[] { new { type = \"image\", image = new { link = imageUrl } } }\n                });\n            }\n\n            if (paramsList.Any())\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = paramsList.Select(p => new { type = \"text\", text = p }).ToList()\n                });\n            }\n\n            if (buttons != null && buttons.Any())\n            {\n                for (int i = 0; i < buttons.Count; i++)\n                {\n                    var btn = buttons[i];\n                    components.Add(new\n                    {\n                        type = \"button\",\n                        sub_type = btn.Type?.ToLower() == \"url\" ? \"url\" : \"quick_reply\",\n                        index = i.ToString(),\n                        parameters = new[] {\n                            new {\n                                type = \"text\",\n                                text = btn.Value ?? btn.Title\n                            }\n                        }\n                    });\n                }\n            }\n\n            return components;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/MessagesEngine/Validators/ValidateMessageDtoAttribute.cs",
      "sha256": "9b7355295c8cecdf6c4416a324d05f0910b3ff67e99fd35e04e397f715096a9b",
      "language": "csharp",
      "size": 1760,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\n\nnamespace xbytechat.api.Features.MessagesEngine.DTOs.Validation\n{\n    [AttributeUsage(AttributeTargets.Class, AllowMultiple = false)]\n    public class ValidateMessageDtoAttribute : ValidationAttribute\n    {\n        protected override ValidationResult? IsValid(object? value, ValidationContext validationContext)\n        {\n            if (value is not SendMessageDto dto)\n                return ValidationResult.Success;\n\n            switch (dto.MessageType)\n            {\n                case MessageTypeEnum.Text:\n                    if (string.IsNullOrWhiteSpace(dto.TextContent))\n                        return new ValidationResult(\"TextContent is required for text messages.\", new[] { nameof(dto.TextContent) });\n                    break;\n\n                case MessageTypeEnum.Image:\n                    if (string.IsNullOrWhiteSpace(dto.MediaUrl))\n                        return new ValidationResult(\"MediaUrl is required for image messages.\", new[] { nameof(dto.MediaUrl) });\n                    break;\n\n                case MessageTypeEnum.Template:\n                    if (string.IsNullOrWhiteSpace(dto.TemplateName))\n                        return new ValidationResult(\"TemplateName is required for template messages.\", new[] { nameof(dto.TemplateName) });\n                    break;\n\n                case MessageTypeEnum.Cta:\n                    if (dto.CtaButtons == null || dto.CtaButtons.Count == 0)\n                        return new ValidationResult(\"CtaButtons is required for CTA messages.\", new[] { nameof(dto.CtaButtons) });\n                    break;\n            }\n\n            return ValidationResult.Success;\n        }\n    }\n}\n"
    }
  ]
}
