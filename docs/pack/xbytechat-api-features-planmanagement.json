{
  "name": "xbytechat-api/Features/PlanManagement",
  "generatedAt": "2025-12-10 08:27:07 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Features/PlanManagement/MakeDump.bat",
      "sha256": "1f0c8a79e7859146dab81f8a13dcdf495c12b54b888024e8500fefb4abd58a9e",
      "language": "bat",
      "size": 1618,
      "content": "@echo off\nREM This script will find relevant source files and output their names and contents into one file.\nREM The output file will be named [FolderName]_AllFileDump.txt.\n\nREM Get the current folder's name and set it as the output file name with the custom suffix\nfor %%I in (\"%cd%\") do set \"outputFile=%%~nI_AllFileDump.txt\"\n\nREM Clear the output file to start fresh and write a small header\n> \"%outputFile%\" (\n    echo Folder and File Content Report\n    echo Root folder: %cd%\n    echo Generated at: %date% %time%\n)\necho. >> \"%outputFile%\"\n\nREM NOTE:\nREM We now only dump RELEVANT text/code files (no binaries, no images, no node_modules, etc.)\nREM This keeps the file smaller and much easier to review.\n\nREM Loop through all relevant files in the current directory and subdirectories\nREM Extensions included: C#, JS/TS/React, JSON, config, SQL, Markdown, YAML\nfor /R . %%F in (*.cs *.csproj *.jsx *.tsx *.js *.ts *.json *.config *.sql *.md *.yml *.yaml *.bat) do (\n\n    REM Skip some noisy folders by path substring (node_modules, bin, obj, .git, dist, .vs)\n    echo \"%%F\" | findstr /I /C:\"\\node_modules\\\" /C:\"\\bin\\\" /C:\"\\obj\\\" /C:\"\\.git\\\" /C:\"\\dist\\\" /C:\"\\.vs\\\" >nul\n    if errorlevel 1 (\n        echo ====================================================== >> \"%outputFile%\"\n        echo FILE: %%F >> \"%outputFile%\"\n        echo ====================================================== >> \"%outputFile%\"\n        echo. >> \"%outputFile%\"\n        type \"%%F\" >> \"%outputFile%\" 2>nul\n        echo. >> \"%outputFile%\"\n        echo. >> \"%outputFile%\"\n    )\n)\n\necho Finished! All content has been extracted to %outputFile%\n"
    },
    {
      "path": "xbytechat-api/Features/PlanManagement/Models/BusinessPlanInfo.cs",
      "sha256": "4a8d4603750b0630eec386cbb831948aaa2cc2f5872d4e1b178da2b9a6952bc7",
      "language": "csharp",
      "size": 1240,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.PlanManagement.Models;\n\nnamespace xbytechat.api.Models.BusinessModel\n{\n    public class BusinessPlanInfo\n    {\n        [Key]\n        public Guid Id { get; set; } = Guid.NewGuid();\n\n        // ðŸ”— Foreign key to Business\n        [Required]\n        public Guid BusinessId { get; set; }\n\n        [ForeignKey(nameof(BusinessId))]\n        public Business Business { get; set; }\n\n        // ðŸ“¦ Plan Management\n        [Required]\n        public PlanType Plan { get; set; } = PlanType.Trial; // Default Trial\n\n        [Required]\n        public int TotalMonthlyQuota { get; set; } = 100; // Default Trial Messages\n\n        [Required]\n        public int RemainingMessages { get; set; } = 100;\n\n        public DateTime QuotaResetDate { get; set; } = DateTime.UtcNow.AddMonths(1);\n\n        // ðŸ’° Wallet Management (optional)\n        public decimal WalletBalance { get; set; } = 0.00m;\n\n        // ðŸ“… Timestamps\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/PlanManagement/Models/PlanFeature.cs",
      "sha256": "af8483d1a28e7555f8111b552d2730fd4ef167d9ba562bebb508328248b01a12",
      "language": "csharp",
      "size": 687,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace xbytechat.api.Features.PlanManagement.Models\n{\n    [Table(\"PlanFeatureMatrix\")]\n    public class PlanFeatureMatrix\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        [Required]\n        [MaxLength(20)]\n        public string PlanName { get; set; } = string.Empty;  // \"Basic\", \"Smart\", \"Advance\"\n\n        [Required]\n        [MaxLength(50)]\n        public string FeatureName { get; set; } = string.Empty; // \"Contacts\", \"Catalog\", etc.\n\n        [Required]\n        public bool IsEnabled { get; set; }  // Default state for this plan-feature pair\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/PlanManagement/Models/PlanType.cs",
      "sha256": "52170542c11ff0a0e52b9f16289446106038cd266cd602169980aa1d684672ea",
      "language": "csharp",
      "size": 187,
      "content": "namespace xbytechat.api.Features.PlanManagement.Models\n{\n    public enum PlanType\n    {\n       \n        Basic = 0,\n        Smart = 1,\n        Advanced = 2,\n            Trial = 3,\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/PlanManagement/Services/IPlanManager.cs",
      "sha256": "69cb77d9f587d971ee0cc96bf3fa399d9982294045981db84e714050dc242d85",
      "language": "csharp",
      "size": 418,
      "content": "using xbytechat.api.Helpers;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.PlanManagement.Services\n{\n    public interface IPlanManager\n    {\n        /// <summary>\n        /// Checks if business has enough quota to send a message.\n        /// </summary>\n        Task<ResponseResult> CheckQuotaBeforeSendingAsync(Guid businessId);\n        Dictionary<string, bool> GetPlanFeatureMap(string plan);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/PlanManagement/Services/PlanManager.cs",
      "sha256": "707ec30ee3f48687b9eaae8569ef4c6152ca6dc7b72d2f8662687b3cec58f666",
      "language": "csharp",
      "size": 4252,
      "content": "// ðŸ“„ Features/PlanManagement/Services/PlanManager.cs\nusing System;\nusing System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.Entitlements;\nusing xbytechat.api.Features.Entitlements.Services;\nusing xbytechat.api.Features.PlanManagement.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Models.BusinessModel;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.PlanManagement.Services\n{\n    public class PlanManager : IPlanManager\n    {\n        private readonly AppDbContext _db;\n        private readonly IQuotaService _quota;\n\n        public PlanManager(AppDbContext db, IQuotaService quota)\n        {\n            _db = db;\n            _quota = quota;\n        }\n\n        /// <summary>\n        /// Check and CONSUME 1 unit of \"messages per month\" quota for this business.\n        /// If not allowed, returns a ResponseResult with a user-friendly error.\n        /// </summary>\n        public async Task<ResponseResult> CheckQuotaBeforeSendingAsync(Guid businessId)\n        {\n            // Load plan info for better error messaging (Trial vs Paid)\n            var business = await _db.Businesses\n                .Include(b => b.BusinessPlanInfo)\n                .FirstOrDefaultAsync(b => b.Id == businessId);\n\n            if (business is null)\n            {\n                return ResponseResult.ErrorInfo(\n                    \"Business not found.\",\n                    \"Invalid business ID in CheckQuotaBeforeSendingAsync.\");\n            }\n\n            var planType = business.BusinessPlanInfo?.Plan ?? PlanType.Trial;\n\n            // Use the generic quota engine\n            var result = await _quota.CheckAndConsumeAsync(\n                businessId,\n                QuotaKeys.MessagesPerMonth,\n                amount: 1,\n                ct: CancellationToken.None);\n\n            if (!result.Allowed)\n            {\n                // 1) Prefer denial text coming from PlanQuotas / overrides\n                var userMessage = !string.IsNullOrWhiteSpace(result.Message)\n                    ? result.Message!\n                    // 2) Fallback to your old behavior\n                    : planType == PlanType.Trial\n                        ? \"Trial limit reached. Please upgrade your plan.\"\n                        : \"Monthly message quota exhausted. Please upgrade or wait for reset.\";\n\n                return ResponseResult.ErrorInfo(\n                    userMessage,\n                    $\"Quota exceeded for {QuotaKeys.MessagesPerMonth}\");\n            }\n\n            // OK â†’ caller (message send service) can proceed to send\n            return ResponseResult.SuccessInfo(\"Quota check passed.\");\n        }\n\n        /// <summary>\n        /// Legacy feature map per plan.\n        /// You can keep this for now; later we can align it with Permission/Entitlements.\n        /// </summary>\n        public Dictionary<string, bool> GetPlanFeatureMap(string plan)\n        {\n            // Keep your previous behavior here.\n            // If your old code had slightly different maps, just plug them in.\n\n            switch (plan?.Trim().ToLowerInvariant())\n            {\n                case \"basic\":\n                    return new Dictionary<string, bool>\n                    {\n                        { \"CATALOG\", true },\n                        { \"MESSAGE_SEND\", true },\n                        { \"CRM_NOTES\", true },\n                        { \"CRM_TAGS\", true }\n                    };\n\n                case \"smart\":\n                    return new Dictionary<string, bool>\n                    {\n                        { \"CATALOG\", true },\n                        { \"MESSAGE_SEND\", true },\n                        { \"CRM_NOTES\", true },\n                        { \"CRM_TAGS\", true }\n                    };\n\n                case \"advanced\":\n                    return new Dictionary<string, bool>\n                    {\n                        { \"CATALOG\", true },\n                        { \"MESSAGE_SEND\", true },\n                        { \"CRM_NOTES\", true },\n                        { \"CRM_TAGS\", true }\n                    };\n\n                default:\n                    return new Dictionary<string, bool>();\n            }\n        }\n    }\n}\n"
    }
  ]
}
