{
  "name": "xbytechat-api/Features/TemplatesModule",
  "generatedAt": "2025-12-10 08:27:07 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/IMetaCredentialsResolver.cs",
      "sha256": "a125bad3a01ab3c3b0580520bd784cce2364342ff6fb4c31795f3028aed9497d",
      "language": "csharp",
      "size": 526,
      "content": "namespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic sealed record MetaCredentials(\n    string AccessToken,\n    string GraphBaseUrl,\n    string GraphVersion,\n    string WabaId\n);\n\npublic interface IMetaCredentialsResolver\n{\n    /// <summary>\n    /// Resolve access token, graph base/version, and WABA ID for a business.\n    /// Implement this by reading your WhatsAppSettings (active provider row).\n    /// </summary>\n    Task<MetaCredentials> ResolveAsync(Guid businessId, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/IMetaTemplateClient.cs",
      "sha256": "1abddaa3a7e43cbc866f7a508e7148487d8cd90456696abc13cdeb5cf3b673b2",
      "language": "csharp",
      "size": 609,
      "content": "namespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic interface IMetaTemplateClient\n{\n    Task<string> UploadMediaAsync(Guid businessId, string localPathOrUrl, string mediaType, CancellationToken ct = default);\n    Task<bool> CreateTemplateAsync(Guid businessId, string name, string category, string language, object componentsPayload, object examplesPayload, CancellationToken ct = default);\n    Task<int> SyncTemplatesAsync(Guid businessId, CancellationToken ct = default);\n    Task<bool> DeleteTemplateAsync(Guid businessId, string name, string language, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/IMetaUploadService.cs",
      "sha256": "8349b79165a2ffc86bfbcca62c8a50cfa8eb88b657fe228844b1ed182413e150",
      "language": "csharp",
      "size": 846,
      "content": "namespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic enum HeaderMediaType { IMAGE, VIDEO, DOCUMENT }\n\npublic sealed record HeaderUploadResult(\n    string Handle,        // raw handle, e.g. \"4::abc...\"\n    string MimeType,\n    long SizeBytes,\n    bool IsStub         // true if returned by stub mode\n);\n\npublic interface IMetaUploadService\n{\n    /// <summary>\n    /// Upload a header media to Meta (resumable) and return the asset handle.\n    /// If sourceUrl is provided, the service will download and upload it.\n    /// Exactly one of (fileStream, sourceUrl) must be provided.\n    /// </summary>\n    Task<HeaderUploadResult> UploadHeaderAsync(\n        Guid businessId,\n        HeaderMediaType mediaType,\n        Stream? fileStream,\n        string? fileName,\n        string? sourceUrl,\n        CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/ITemplateDraftLifecycleService.cs",
      "sha256": "5dd2420dfce13c3d40e3e907a8c52ff437999295361f8c1e7089f3c28ecf1d0a",
      "language": "csharp",
      "size": 596,
      "content": "using xbytechat.api.Features.TemplateModule.Models;\n\nnamespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic interface ITemplateDraftLifecycleService\n{\n    Task<TemplateDraft> DuplicateDraftAsync(Guid businessId, Guid draftId, CancellationToken ct = default);\n    Task<bool> DeleteDraftAsync(Guid businessId, Guid draftId, CancellationToken ct = default);\n\n    /// <summary>Delete an approved WhatsApp template at Meta and soft-delete it locally.</summary>\n    Task<bool> DeleteApprovedTemplateAsync(Guid businessId, string name, string language, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/ITemplateDraftService.cs",
      "sha256": "4ceb896e4de43731ccfccd668c4a0cb39db8532dd26f38854fb04d9e1cbfec52",
      "language": "csharp",
      "size": 1319,
      "content": "using xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Models;\n\nnamespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic interface ITemplateDraftService\n{\n    Task<TemplateDraft> CreateDraftAsync(Guid businessId, TemplateDraftCreateDto dto, CancellationToken ct = default);\n    Task<TemplateDraftVariant> UpsertVariantAsync(Guid businessId, Guid draftId, TemplateDraftVariantUpsertDto dto, CancellationToken ct = default);\n    Task<bool> ValidateAsync(Guid businessId, Guid draftId, CancellationToken ct = default);\n    Task<TemplateDraft?> GetDraftAsync(Guid businessId, Guid draftId, CancellationToken ct = default);\n    Task<IReadOnlyList<TemplateDraft>> ListDraftsAsync(Guid businessId, CancellationToken ct = default);\n    Task<(bool ok, Dictionary<string, List<string>> errors)> ValidateAllAsync(Guid businessId, Guid draftId, CancellationToken ct = default);\n    Task<bool> SetHeaderHandleAsync(\n    Guid businessId,\n    Guid draftId,\n    string language,\n    string mediaType,          // IMAGE | VIDEO | DOCUMENT\n    string assetHandle,        // raw handle without \"handle:\" prefix\n    CancellationToken ct = default);\n    Task<TemplatePreviewDto?> GetPreviewAsync(\n        Guid businessId, Guid draftId, string language, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/ITemplateLibraryService.cs",
      "sha256": "59834c407d151c75fa70b329cc653ad4f7cb19d09ffd90ed402976a1ab61f7a3",
      "language": "csharp",
      "size": 1208,
      "content": "using xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Models;\n\nnamespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic interface ITemplateLibraryService\n{\n    Task<IReadOnlyList<TemplateLibraryItem>> ListAsync(string? industry, CancellationToken ct = default);\n    Task<TemplateDraft> InstantiateDraftAsync(Guid businessId, Guid libraryItemId, IEnumerable<string> languages, CancellationToken ct = default);\n    Task<(TemplateLibraryItem item, List<TemplateLibraryVariant> variants)> GetItemAsync(\n               Guid libraryItemId,\n               CancellationToken ct = default);\n    Task<IReadOnlyList<string>> ListIndustriesAsync(CancellationToken ct = default);\n    //Task<LibraryImportResult> ImportAsync(LibraryImportRequest request, CancellationToken ct = default);\n    Task<LibraryImportResult> ImportAsync(LibraryImportRequest request, bool dryRun = false, CancellationToken ct = default);\n    Task<TemplateLibraryListResponse> SearchAsync(\n        string? industry, string? q, string? sort, int page, int pageSize, CancellationToken ct = default);\n    Task<LibraryImportRequest> ExportAsync(string? industry, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/ITemplateStatusService.cs",
      "sha256": "deef6281241c55e436207d42dacf72b10bce5a23cfdfb994b0cb9897c51cfb65",
      "language": "csharp",
      "size": 681,
      "content": "using xbytechat.api.Features.TemplateModule.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic sealed record TemplateStatusItemDto(\n    string LanguageCode,\n    string Status,\n    string? TemplateId,\n    DateTime? UpdatedAt,\n    DateTime? LastSyncedAt\n);\n\npublic interface ITemplateStatusService\n{\n    /// <summary>\n    /// Returns the Meta name derived from the draft key (the one used on submit)\n    /// and the per-language rows from WhatsAppTemplates for that business.\n    /// </summary>\n    Task<(string metaName, IReadOnlyList<TemplateStatusItemDto> items)> GetStatusAsync(\n        Guid businessId, Guid draftId, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Abstractions/ITemplateSubmissionService.cs",
      "sha256": "2d026f2801ec06397e4f2336c0cda4ca58d81982e6b5c90c897be5add9101b6f",
      "language": "csharp",
      "size": 354,
      "content": "using xbytechat.api.Features.TemplateModule.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Abstractions;\n\npublic interface ITemplateSubmissionService\n{\n    Task<TemplateSubmitResponseDto> SubmitAsync(Guid businessId, Guid draftId, CancellationToken ct = default);\n    Task<int> SyncStatusAsync(Guid businessId, CancellationToken ct = default);\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Config/UploadLimitsOptions.cs",
      "sha256": "4bfc057a416b9f746ba2f25cf65483f30630451c5c4501a46cf9f54c90fddbdf",
      "language": "csharp",
      "size": 844,
      "content": "namespace xbytechat.api.Features.TemplateModule.Config;\n\npublic sealed class UploadLimitsOptions\n{\n    public long ImageMaxBytes { get; set; } = 10 * 1024 * 1024;    // 10 MB\n    public long VideoMaxBytes { get; set; } = 32 * 1024 * 1024;    // 32 MB\n    public long DocumentMaxBytes { get; set; } = 16 * 1024 * 1024; // 16 MB\n\n    public string[] AllowedImageMime { get; set; } = new[] { \"image/jpeg\", \"image/png\", \"image/webp\" };\n    public string[] AllowedVideoMime { get; set; } = new[] { \"video/mp4\" };\n    public string[] AllowedDocMime { get; set; } = new[] { \"application/pdf\" };\n\n    /// <summary>\n    /// If true, the upload service returns a generated fake handle instead of calling Meta.\n    /// Flip to false when you implement the real HTTP resumable flow.\n    /// </summary>\n    public bool UseStubHandle { get; set; } = true;\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Controllers/TemplateDraftsController.cs",
      "sha256": "f9e9d459412e685c8b520ea492f88f7de0a7d7633568864b53210db8cd0fb3e6",
      "language": "csharp",
      "size": 12052,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Validators;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat_api.WhatsAppSettings.Services;\nusing xbytechat.api.Shared;\nusing xbytechat.api.Features.TemplateModule.Services; // User.GetBusinessId()\n\nnamespace xbytechat.api.Features.TemplateModule.Controllers;\n\n[ApiController]\n[Route(\"api/template-builder\")]\n[Authorize]\npublic sealed class TemplateDraftsController : ControllerBase\n{\n    private readonly ITemplateDraftService _drafts;\n\n    private readonly ITemplateSubmissionService _submitter;\n    private readonly ITemplateNameCheckService _nameCheck;\n\n    private readonly ITemplateStatusService _status;\n    private readonly ITemplateDraftLifecycleService _lifecycle;\n    public TemplateDraftsController(ITemplateDraftService drafts, ITemplateSubmissionService submitter,\n\n        ITemplateNameCheckService nameCheck,\n        ITemplateStatusService status, ITemplateDraftLifecycleService lifecycle)\n\n    {\n        _drafts = drafts;\n        _submitter = submitter;\n        _status = status;\n        _nameCheck = nameCheck;\n        _lifecycle = lifecycle;\n    }\n\n    [HttpPost(\"drafts\")]\n    public async Task<ActionResult<object>> CreateDraft([FromBody] TemplateDraftCreateDto dto, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty) return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n        if (dto is null) return BadRequest(new { success = false, message = \"Body required\" });\n        if (string.IsNullOrWhiteSpace(dto.Key)) return BadRequest(new { success = false, message = \"Key is required.\" });\n\n        try\n        {\n            var draft = await _drafts.CreateDraftAsync(businessId, dto, ct);\n            return CreatedAtAction(nameof(GetDraft), new { draftId = draft.Id }, new\n            {\n                success = true,\n                message = \"Draft created.\",\n                draftId = draft.Id,\n                key = draft.Key,\n                category = draft.Category,\n                defaultLanguage = draft.DefaultLanguage\n            });\n        }\n        catch (InvalidOperationException ex)\n        {\n            return Conflict(new { success = false, message = ex.Message });\n        }\n    }\n\n    [HttpPost(\"drafts/{draftId:guid}/variants\")]\n    public async Task<ActionResult<object>> UpsertVariant(Guid draftId, [FromBody] TemplateDraftVariantUpsertDto dto, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty) return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n        if (draftId == Guid.Empty) return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n        if (dto is null) return BadRequest(new { success = false, message = \"Body required\" });\n\n        if (string.IsNullOrWhiteSpace(dto.Language)) dto.Language = \"en_US\";\n        if (string.IsNullOrWhiteSpace(dto.HeaderType)) dto.HeaderType = \"NONE\";\n\n        try\n        {\n            var variant = await _drafts.UpsertVariantAsync(businessId, draftId, dto, ct);\n            return Accepted(new\n            {\n                success = true,\n                message = \"Variant saved.\",\n                draftId,\n                language = variant.Language\n            });\n        }\n        catch (KeyNotFoundException)\n        {\n            return NotFound(new { success = false, message = \"Draft not found.\" });\n        }\n        catch (InvalidOperationException ex)\n        {\n            return BadRequest(new { success = false, message = ex.Message });\n        }\n    }\n\n    // Validation endpoint stays payload-only (single variant), same as Step-4\n    [HttpPost(\"{draftId:guid}/validate\")]\n    public ActionResult<object> Validate(Guid draftId, [FromBody] TemplateDraftVariantUpsertDto body)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty) return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n        if (draftId == Guid.Empty) return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n        if (body is null) return BadRequest(new { success = false, message = \"Body required.\" });\n\n        var result = VariantValidator.Validate(body);\n        return Ok(new\n        {\n            success = result.Ok,\n            message = result.Ok ? \"Validation passed.\" : \"Validation failed.\",\n            businessId,\n            draftId,\n            errors = result.Errors\n        });\n    }\n\n    // Submit stays stub (no Meta) — will be implemented in Step-7/8\n    [HttpPost(\"{draftId:guid}/submit\")]\n    public async Task<ActionResult<object>> Submit(Guid draftId, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty) return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n        if (draftId == Guid.Empty) return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        var resp = await _submitter.SubmitAsync(businessId, draftId, ct);\n        if (!resp.Success)\n            return BadRequest(resp);\n\n        return Accepted(resp);\n    }\n\n    [HttpGet(\"drafts\")]\n    public async Task<ActionResult<object>> ListDrafts(CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty) return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        var items = await _drafts.ListDraftsAsync(businessId, ct);\n        return Ok(new\n        {\n            success = true,\n            message = \"Drafts loaded.\",\n            businessId,\n            count = items.Count,\n            items = items.Select(d => new { d.Id, d.Key, d.Category, d.DefaultLanguage, d.UpdatedAt })\n        });\n    }\n\n    [HttpGet(\"drafts/{draftId:guid}\")]\n    public async Task<ActionResult<object>> GetDraft(Guid draftId, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty) return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n        if (draftId == Guid.Empty) return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        var draft = await _drafts.GetDraftAsync(businessId, draftId, ct);\n        if (draft is null) return NotFound(new { success = false, message = \"Draft not found.\" });\n\n        return Ok(new\n        {\n            success = true,\n            message = \"Draft loaded.\",\n            draft\n        });\n    }\n    // POST /api/template-builder/{draftId}/validate-all\n    [HttpPost(\"{draftId:guid}/validate-all\")]\n    public async Task<ActionResult<object>> ValidateAll(Guid draftId, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty) return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n        if (draftId == Guid.Empty) return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        var (ok, errors) = await _drafts.ValidateAllAsync(businessId, draftId, ct);\n\n        return Ok(new\n        {\n            success = ok,\n            message = ok ? \"All language variants are valid and consistent.\" : \"Validation failed for one or more languages.\",\n            draftId,\n            errors\n        });\n    }\n    [HttpGet(\"drafts/{draftId:guid}/status\")]\n    public async Task<ActionResult<object>> GetStatus(Guid draftId, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n        if (draftId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        try\n        {\n            var (metaName, items) = await _status.GetStatusAsync(businessId, draftId, ct);\n            return Ok(new\n            {\n                success = true,\n                message = items.Count == 0 ? \"No synced rows yet. Try again later.\" : \"Latest status from WhatsAppTemplates.\",\n                draftId,\n                name = metaName,\n                items\n            });\n        }\n        catch (KeyNotFoundException)\n        {\n            return NotFound(new { success = false, message = \"Draft not found.\" });\n        }\n    }\n\n\n    // GET /api/template-builder/drafts/{draftId}/preview?language=en_US\n    [HttpGet(\"preview\")]\n    public async Task<ActionResult<object>> Preview(Guid draftId, [FromQuery] string language, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (draftId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n        if (string.IsNullOrWhiteSpace(language))\n            return BadRequest(new { success = false, message = \"language is required.\" });\n\n        var dto = await _drafts.GetPreviewAsync(businessId, draftId, language, ct);\n        if (dto is null)\n            return NotFound(new { success = false, message = \"Draft or language variant not found.\" });\n\n        return Ok(new { success = true, preview = dto });\n    }\n\n    // GET /api/template-builder/drafts/{draftId:guid}/name-check?language=en_US\n    [HttpGet(\"{draftId:guid}/name-check\")]\n    public async Task<ActionResult<object>> NameCheck(Guid draftId, [FromQuery] string? language, CancellationToken ct = default)\n    {\n        //var businessId = UserBusinessId(); // your existing extractor\n        var businessId = User.GetBusinessId();\n        var lang = string.IsNullOrWhiteSpace(language) ? \"en_US\" : language;\n\n        var result = await _nameCheck.CheckAsync(businessId, draftId, lang, ct);\n        if (result is null)\n            return NotFound(new { success = false, message = \"Draft not found.\" });\n\n        return Ok(new\n        {\n            success = true,\n            name = result.Name,\n            available = result.Available,\n            suggestion = result.Suggestion,\n            language = result.Language,\n            draftId = result.DraftId\n        });\n    }\n\n    // POST /api/template-builder/drafts/{draftId:guid}/duplicate\n    [HttpPost(\"{draftId:guid}/duplicate\")]\n    public async Task<ActionResult<object>> Duplicate(Guid draftId, CancellationToken ct = default)\n    {\n        var businessId = User.GetBusinessId();\n        var dup = await _lifecycle.DuplicateDraftAsync(businessId, draftId, ct);\n        return Ok(new { success = true, draftId = dup.Id, key = dup.Key });\n    }\n\n    // DELETE /api/template-builder/drafts/{draftId:guid}\n    [HttpDelete(\"{draftId:guid}\")]\n    public async Task<ActionResult<object>> Delete(Guid draftId, CancellationToken ct = default)\n    {\n        var businessId = User.GetBusinessId();\n        var ok = await _lifecycle.DeleteDraftAsync(businessId, draftId, ct);\n        if (!ok) return NotFound(new { success = false, message = \"Draft not found.\" });\n        return Ok(new { success = true });\n    }\n    // DELETE /api/template-builder/templates/{name}?language=en_US\n    [HttpDelete(\"~/api/template-builder/templates/{name}\")]\n    public async Task<ActionResult<object>> DeleteApprovedTemplate(\n        [FromRoute] string name,\n        [FromQuery] string language = \"en_US\",\n        CancellationToken ct = default)\n    {\n        var businessId = User.GetBusinessId(); // your existing extractor\n        if (string.IsNullOrWhiteSpace(name))\n            return BadRequest(new { success = false, message = \"Template name is required.\" });\n\n        var ok = await _lifecycle.DeleteApprovedTemplateAsync(businessId, name, language, ct);\n        return Ok(new { success = ok, name, language });\n    }\n\n\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Controllers/TemplateLibraryAdminController.cs",
      "sha256": "0247de08701765cef198ea2eec0de87320ad519b5d362d7ef0a437acd39733a6",
      "language": "csharp",
      "size": 2836,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/admin/template-builder/library\")] // <-- unique admin prefix (no conflict with public controller)\n    [Authorize]                                    // add policy/roles as needed\n    [Produces(\"application/json\")]\n    public sealed class TemplateLibraryAdminController : ControllerBase\n    {\n        private readonly ITemplateLibraryService _library;\n\n        public TemplateLibraryAdminController(ITemplateLibraryService library)\n        {\n            _library = library;\n        }\n\n        // POST /api/admin/template-builder/library/import?dryRun=true\n        [HttpPost(\"import\")]\n        public async Task<ActionResult<object>> Import(\n            [FromBody] LibraryImportRequest request,\n            [FromQuery] bool dryRun = false,\n            CancellationToken ct = default)\n        {\n            if (request is null || request.Items is null)\n                return BadRequest(new { success = false, message = \"Invalid request payload.\" });\n\n            // If you want admin-only: [Authorize(Policy = \"templates.library.import\")] at class or action level.\n\n            var result = await _library.ImportAsync(request, dryRun, ct);\n\n            return Ok(new\n            {\n                success = result.Success,\n                dryRun,\n                result.TotalItems,\n                result.CreatedItems,\n                result.UpdatedItems,\n                result.CreatedVariants,\n                result.UpdatedVariants,\n                errors = result.Errors\n            });\n        }\n\n        // GET /api/admin/template-builder/library/browse?industry=...&q=...&sort=name&page=1&pageSize=20\n        [HttpGet(\"browse\")]\n        public async Task<ActionResult<object>> Browse(\n            [FromQuery] string? industry,\n            [FromQuery] string? q,\n            [FromQuery] string? sort,\n            [FromQuery] int page = 1,\n            [FromQuery] int pageSize = 20,\n            CancellationToken ct = default)\n        {\n            var resp = await _library.SearchAsync(industry, q, sort, page, pageSize, ct);\n            return Ok(resp);\n        }\n\n        // GET /api/admin/template-builder/library/export?industry=SALON\n        [HttpGet(\"export\")]\n        public async Task<ActionResult<object>> Export([FromQuery] string? industry, CancellationToken ct = default)\n        {\n            var payload = await _library.ExportAsync(industry, ct);\n            return Ok(new\n            {\n                success = true,\n                count = payload.Items.Count,\n                items = payload.Items\n            });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Controllers/TemplateLibraryController.cs",
      "sha256": "dc4dac5078ca00d398e2b6236453602fe0a332d658da7dbef1ccb365366a2cc5",
      "language": "csharp",
      "size": 9186,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat_api.WhatsAppSettings.Services; // User.GetBusinessId()\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.TemplateModule.Controllers;\n\n[ApiController]\n[Route(\"api/template-builder/library\")]\n[Authorize]\n[Produces(\"application/json\")]\npublic sealed class TemplateLibraryController : ControllerBase\n{\n    private readonly ITemplateLibraryService _library;\n\n    public TemplateLibraryController(ITemplateLibraryService library)\n    {\n        _library = library;\n    }\n\n    // ─────────────────────────────────────────────────────────────────────────────\n    // Legacy, simple list (kept under /list to avoid collision with /browse)\n    // GET /api/template-builder/library/list?industry=SALON\n    // ─────────────────────────────────────────────────────────────────────────────\n    [HttpGet(\"list\")]\n    public async Task<ActionResult<object>> List([FromQuery] string? industry, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        var items = await _library.ListAsync(industry, ct);\n\n        return Ok(new\n        {\n            success = true,\n            message = \"Library loaded.\",\n            businessId,\n            count = items.Count,\n            items = items.Select(i => new { i.Id, i.Industry, i.Key, i.Category, i.IsFeatured })\n        });\n    }\n\n    // ─────────────────────────────────────────────────────────────────────────────\n    // New, paged & searchable browse endpoint used by the UI\n    // GET /api/template-builder/library/browse?industry=&q=&sort=&page=&pageSize=\n    // sort: \"featured\" | \"name\"\n    // ─────────────────────────────────────────────────────────────────────────────\n    [HttpGet(\"browse\")]\n    public async Task<ActionResult<TemplateLibraryListResponse>> Browse(\n        [FromQuery] string? industry,\n        [FromQuery] string? q,\n        [FromQuery] string? sort,\n        [FromQuery] int page = 1,\n        [FromQuery] int pageSize = 20,\n        CancellationToken ct = default)\n    {\n        var data = await _library.SearchAsync(industry, q, sort, page, pageSize, ct);\n        return Ok(data);\n    }\n\n    // ─────────────────────────────────────────────────────────────────────────────\n    // Activate (variant A) - legacy style\n    // POST /api/template-builder/library/use/{libraryItemId}\n    // body: { \"languages\": [\"en_US\",\"hi_IN\"] }\n    // ─────────────────────────────────────────────────────────────────────────────\n    [HttpPost(\"use/{libraryItemId:guid}\")]\n    public async Task<ActionResult<object>> Use(Guid libraryItemId, [FromBody] TemplateLibraryUseRequestDto body, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (libraryItemId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid libraryItemId.\" });\n\n        if (body is null || body.Languages is null || body.Languages.Count == 0)\n            return BadRequest(new { success = false, message = \"At least one language is required.\" });\n\n        var draft = await _library.InstantiateDraftAsync(businessId, libraryItemId, body.Languages, ct);\n\n        // If your TemplateDraftsController exposes GetDraft, keep CreatedAtAction; otherwise return Ok(...)\n        return CreatedAtAction(\"GetDraft\", \"TemplateDrafts\", new { draftId = draft.Id }, new\n        {\n            success = true,\n            message = \"Draft created from library.\",\n            draftId = draft.Id,\n            key = draft.Key,\n            category = draft.Category\n        });\n    }\n\n    public sealed class ActivateRequest\n    {\n        public IEnumerable<string>? Languages { get; set; } // e.g., [\"en_US\",\"hi_IN\"]\n    }\n\n    // ─────────────────────────────────────────────────────────────────────────────\n    // Activate (variant B) - current UI contract\n    // POST /api/template-builder/library/{itemId}/activate\n    // body: { \"languages\": [\"en_US\",\"hi_IN\"] }  (supports \"ALL\" if your service does)\n    // ─────────────────────────────────────────────────────────────────────────────\n    [HttpPost(\"{itemId:guid}/activate\")]\n    public async Task<ActionResult<object>> Activate(Guid itemId, [FromBody] ActivateRequest body, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (itemId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid itemId.\" });\n\n        var langs = (body?.Languages ?? Array.Empty<string>()).ToArray();\n        if (langs.Length == 0)\n            return BadRequest(new { success = false, message = \"At least one language is required. You can also pass \\\"ALL\\\".\" });\n\n        try\n        {\n            var draft = await _library.InstantiateDraftAsync(businessId, itemId, langs, ct);\n            return Ok(new\n            {\n                success = true,\n                message = \"Template activated as draft.\",\n                draftId = draft.Id,\n                draft\n            });\n        }\n        catch (KeyNotFoundException)\n        {\n            return NotFound(new { success = false, message = \"Library item not found.\" });\n        }\n        catch (InvalidOperationException ex)\n        {\n            return BadRequest(new { success = false, message = ex.Message });\n        }\n    }\n\n    // ─────────────────────────────────────────────────────────────────────────────\n    // Get a library item with its variants for preview\n    // GET /api/template-builder/library/item/{itemId}\n    // ─────────────────────────────────────────────────────────────────────────────\n    [HttpGet(\"item/{itemId:guid}\")]\n    public async Task<ActionResult<object>> GetItem(Guid itemId, CancellationToken ct)\n    {\n        if (itemId == Guid.Empty)\n            return BadRequest(new { success = false, message = \"Invalid itemId.\" });\n\n        try\n        {\n            var (item, variants) = await _library.GetItemAsync(itemId, ct);\n            return Ok(new\n            {\n                success = true,\n                item,\n                variants\n            });\n        }\n        catch (KeyNotFoundException)\n        {\n            return NotFound(new { success = false, message = \"Library item not found.\" });\n        }\n    }\n\n    // ─────────────────────────────────────────────────────────────────────────────\n    // List distinct industries available in the library\n    // GET /api/template-builder/library/industries\n    // ─────────────────────────────────────────────────────────────────────────────\n    [HttpGet(\"industries\")]\n    public async Task<ActionResult<object>> Industries(CancellationToken ct)\n    {\n        var list = await _library.ListIndustriesAsync(ct);\n        return Ok(new\n        {\n            success = true,\n            count = list.Count,\n            industries = list\n        });\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Controllers/TemplatesController.cs",
      "sha256": "b7014e9c08b5d3cf85e8dbd5edf632bc51e34a2acac661dbb3109dcd259edf4c",
      "language": "csharp",
      "size": 1479,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.TemplateModule.Services;\n\nnamespace xbytechat.api.Features.TemplateModule.Controllers\n{\n    [ApiController]\n    [Route(\"api/templates\")]\n    public class TemplatesController : ControllerBase\n    {\n        private readonly IWhatsAppTemplateService _templateService;\n        private readonly ILogger<TemplatesController> _logger;\n\n        public TemplatesController(IWhatsAppTemplateService templateService, ILogger<TemplatesController> logger)\n        {\n            _templateService = templateService;\n            _logger = logger;\n        }\n\n        /// <summary>\n        /// Fetches WhatsApp template metadata (name, language, body, placeholders)\n        /// </summary>\n        [HttpGet(\"metadata\")]\n        public async Task<IActionResult> GetTemplates()\n        {\n            try\n            {\n                var templates = await _templateService.FetchTemplatesAsync();\n                return Ok(new\n                {\n                    success = true,\n                    templates\n                });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(\"Error fetching template metadata: \" + ex.Message);\n                return StatusCode(500, new\n                {\n                    success = false,\n                    message = \"❌ Failed to retrieve template metadata\",\n                    error = ex.Message\n                });\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Controllers/TemplateUploadsController.cs",
      "sha256": "443cc7e9a227c8e894ec6a0baa50dea68fa1be15d32ee9a8e7c72a94fa6393cd",
      "language": "csharp",
      "size": 8384,
      "content": "using System.ComponentModel.DataAnnotations;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.TemplateModule.Controllers;\n\n[ApiController]\n[Route(\"api/template-builder/uploads\")]\n[Authorize]\n[Produces(\"application/json\")]\npublic sealed class TemplateUploadsController : ControllerBase\n{\n    private readonly IMetaUploadService _uploader;\n    private readonly ITemplateDraftService _drafts;\n\n    public TemplateUploadsController(IMetaUploadService uploader, ITemplateDraftService drafts)\n    {\n        _uploader = uploader;\n        _drafts = drafts;\n    }\n\n    // ---------- Form DTO so Swagger can model multipart correctly ----------\n    public sealed class UploadHeaderForm\n    {\n        /// <summary>Draft Id to update</summary>\n        [Required]\n        public Guid DraftId { get; set; }\n\n        /// <summary>Variant language, e.g. en_US</summary>\n        [Required]\n        public string Language { get; set; } = default!;\n\n        /// <summary>IMAGE | VIDEO | DOCUMENT</summary>\n        [Required]\n        public string MediaType { get; set; } = default!;\n\n        /// <summary>Upload a file (use either File or SourceUrl)</summary>\n        public IFormFile? File { get; set; }\n\n        /// <summary>Remote URL to fetch and upload (use either File or SourceUrl)</summary>\n        public string? SourceUrl { get; set; }\n\n        /// <summary>Optional override filename (improves MIME guess)</summary>\n        public string? FileName { get; set; }\n    }\n\n    // POST /api/template-builder/uploads/header\n    [HttpPost(\"header\")]\n    [Consumes(\"multipart/form-data\")]\n    [RequestSizeLimit(64_000_000)] // 64MB cap; per-type limits enforced in service\n    [ProducesResponseType(typeof(object), StatusCodes.Status200OK)]\n    [ProducesResponseType(typeof(object), StatusCodes.Status400BadRequest)]\n    [ProducesResponseType(typeof(object), StatusCodes.Status401Unauthorized)]\n    public async Task<ActionResult<object>> UploadHeader([FromForm] UploadHeaderForm form, CancellationToken ct)\n    {\n        var businessId = User.GetBusinessId();\n        if (businessId == Guid.Empty)\n            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n        if (form is null)\n            return BadRequest(new { success = false, message = \"Empty form.\" });\n\n        if (string.IsNullOrWhiteSpace(form.Language))\n            return BadRequest(new { success = false, message = \"language is required.\" });\n\n        if ((form.File is null && string.IsNullOrWhiteSpace(form.SourceUrl)) ||\n            (form.File is not null && !string.IsNullOrWhiteSpace(form.SourceUrl)))\n        {\n            return BadRequest(new { success = false, message = \"Provide either a file or a sourceUrl (not both).\" });\n        }\n\n        if (!Enum.TryParse<HeaderMediaType>(form.MediaType?.Trim(), true, out var kind))\n            return BadRequest(new { success = false, message = \"mediaType must be IMAGE, VIDEO, or DOCUMENT.\" });\n\n        Stream? stream = null;\n        string? fileName = form.FileName;\n\n        if (form.File is not null)\n        {\n            if (form.File.Length <= 0)\n                return BadRequest(new { success = false, message = \"Empty file.\" });\n\n            stream = form.File.OpenReadStream();\n            fileName ??= form.File.FileName;\n        }\n\n        try\n        {\n            var result = await _uploader.UploadHeaderAsync(\n                businessId: businessId,\n                mediaType: kind,\n                fileStream: stream,\n                fileName: fileName,\n                sourceUrl: form.SourceUrl,\n                ct: ct\n            );\n\n            // Persist handle on the variant. Service stores \"handle:{handle}\" internally.\n            var ok = await _drafts.SetHeaderHandleAsync(\n                businessId,\n                form.DraftId,\n                form.Language,\n                kind.ToString(),\n                result.Handle,\n                ct\n            );\n\n            if (!ok)\n                return NotFound(new { success = false, message = \"Draft not found for this business.\" });\n\n            return Ok(new\n            {\n                success = true,\n                message = result.IsStub ? \"Uploaded (stub handle generated).\" : \"Uploaded successfully.\",\n                draftId = form.DraftId,\n                language = form.Language,\n                mediaType = kind.ToString(),\n                handle = result.Handle,   // e.g., \"4::abcdef...\"\n                mime = result.MimeType,\n                bytes = result.SizeBytes,\n                isStub = result.IsStub\n            });\n        }\n        catch (Exception ex)\n        {\n            return BadRequest(new { success = false, message = ex.Message });\n        }\n    }\n}\n\n\n//using Microsoft.AspNetCore.Authorization;\n//using Microsoft.AspNetCore.Mvc;\n//using xbytechat.api.Features.TemplateModule.Abstractions;\n//using xbytechat.api.Shared;\n\n//namespace xbytechat.api.Features.TemplateModule.Controllers;\n\n//[ApiController]\n//[Route(\"api/template-builder/uploads\")]\n//[Authorize]\n//public sealed class TemplateUploadsController : ControllerBase\n//{\n//    private readonly IMetaUploadService _uploader;\n//    private readonly ITemplateDraftService _drafts;\n\n//    public TemplateUploadsController(IMetaUploadService uploader, ITemplateDraftService drafts)\n//    {\n//        _uploader = uploader;\n//        _drafts = drafts;\n//    }\n\n//    // POST /api/template-builder/uploads/header\n//    // multipart/form-data:\n//    //  - draftId: guid (required)\n//    //  - language: string (required)\n//    //  - mediaType: IMAGE|VIDEO|DOCUMENT (required)\n//    //  - file: IFormFile (optional if sourceUrl provided)\n//    //  - sourceUrl: string (optional if file provided)\n//    [HttpPost(\"header\")]\n//    [RequestSizeLimit(64_000_000)] // 64MB cap; actual limits enforced per type in service\n//    public async Task<ActionResult<object>> UploadHeader(\n//        [FromForm] Guid draftId,\n//        [FromForm] string language,\n//        [FromForm] string mediaType,\n//        [FromForm] IFormFile? file,\n//        [FromForm] string? sourceUrl,\n//        CancellationToken ct)\n//    {\n//        var businessId = User.GetBusinessId();\n//        if (businessId == Guid.Empty)\n//            return Unauthorized(new { success = false, message = \"Invalid or missing BusinessId claim.\" });\n\n//        if (draftId == Guid.Empty)\n//            return BadRequest(new { success = false, message = \"Invalid draftId.\" });\n\n//        if (string.IsNullOrWhiteSpace(language))\n//            return BadRequest(new { success = false, message = \"language is required.\" });\n\n//        if (!Enum.TryParse<HeaderMediaType>(mediaType, true, out var kind))\n//            return BadRequest(new { success = false, message = \"mediaType must be IMAGE, VIDEO, or DOCUMENT.\" });\n\n//        Stream? stream = null;\n//        string? fileName = null;\n\n//        if (file is not null)\n//        {\n//            if (file.Length <= 0) return BadRequest(new { success = false, message = \"Empty file.\" });\n//            stream = file.OpenReadStream();\n//            fileName = file.FileName;\n//        }\n\n//        try\n//        {\n//            var result = await _uploader.UploadHeaderAsync(businessId, kind, stream, fileName, sourceUrl, ct);\n\n//            // Persist handle on the variant\n//            var ok = await _drafts.SetHeaderHandleAsync(\n//                businessId, draftId, language, kind.ToString(), result.Handle, ct);\n\n//            if (!ok) return NotFound(new { success = false, message = \"Draft not found for this business.\" });\n\n//            return Ok(new\n//            {\n//                success = true,\n//                message = result.IsStub ? \"Uploaded (stub handle generated).\" : \"Uploaded successfully.\",\n//                draftId,\n//                language,\n//                mediaType = kind.ToString(),\n//                handle = result.Handle, // raw handle; draft stores \"handle:{handle}\"\n//                mime = result.MimeType,\n//                size = result.SizeBytes,\n//                isStub = result.IsStub\n//            });\n//        }\n//        catch (Exception ex)\n//        {\n//            return BadRequest(new { success = false, message = ex.Message });\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/ButtonDto.cs",
      "sha256": "c2555d5cc7d0128fda2e7cffee67e3eefb104cc34586f04d4c6128a580c4ed65",
      "language": "csharp",
      "size": 298,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class ButtonDto\n{\n    public string Type { get; set; } = \"QUICK_REPLY\";  // QUICK_REPLY|URL|PHONE\n    public string Text { get; set; } = string.Empty;\n    public string? Url { get; set; }\n    public string? Phone { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/ButtonMetadataDto.cs",
      "sha256": "ec982e593c9ef32a980dd298dcb89ba9990c7f10b0ca7822fa9c613e23b98dfc",
      "language": "csharp",
      "size": 512,
      "content": "namespace xbytechat.api.Features.TemplatesModule.DTOs\n{\n    // e.g. in the same file or a shared DTOs folder\n    public sealed class ButtonMetadataDto\n    {\n        public string Text { get; set; } = \"\";\n        public string Type { get; set; } = \"\";     // e.g. \"QUICK_REPLY\", \"URL\", \"COPY_CODE\", \"FLOW\"\n        public string SubType { get; set; } = \"\";  // e.g. \"url\", \"copy_code\", \"flow\" (lowercase for UI)\n        public string? ParameterValue { get; set; } // URL template or static value (if any)\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/emplateDraftVariantUpsertDto.cs",
      "sha256": "8232c54d4ba3e0a1b79831acf95451129befc0371f792773350eaad0d6697710",
      "language": "csharp",
      "size": 576,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateDraftVariantUpsertDto\n{\n    public string Language { get; set; } = \"en_US\";\n    public string BodyText { get; set; } = string.Empty;\n\n    public string HeaderType { get; set; } = \"NONE\";\n    public string? HeaderText { get; set; }\n    public string? HeaderMediaLocalUrl { get; set; }\n\n    public string? FooterText { get; set; }\n    public List<ButtonDto> Buttons { get; set; } = new();\n    public Dictionary<string, string> Examples { get; set; } = new(); // e.g., {\"1\":\"John\",\"2\":\"12345\"}\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/LibraryImportDtos.cs",
      "sha256": "011dad7c69a602c48067fa3864bb4a15f4c8f019ce9da6798215de7530c01f9d",
      "language": "csharp",
      "size": 2570,
      "content": "using System.Text.Json.Serialization;\n\nnamespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class LibraryImportRequest\n{\n    [JsonPropertyName(\"items\")]\n    public List<LibraryImportItem> Items { get; set; } = new();\n}\n\npublic sealed class LibraryImportItem\n{\n    [JsonPropertyName(\"industry\")]\n    public string Industry { get; set; } = default!; // required\n\n    [JsonPropertyName(\"key\")]\n    public string Key { get; set; } = default!;      // required (unique per industry)\n\n    [JsonPropertyName(\"category\")]\n    public string Category { get; set; } = default!; // required: UTILITY|MARKETING|AUTHENTICATION\n\n    [JsonPropertyName(\"isFeatured\")]\n    public bool IsFeatured { get; set; }\n\n    [JsonPropertyName(\"variants\")]\n    public List<LibraryImportVariant> Variants { get; set; } = new();\n}\n\npublic sealed class LibraryImportVariant\n{\n    [JsonPropertyName(\"language\")]\n    public string Language { get; set; } = default!;   // required (e.g., en_US)\n\n    [JsonPropertyName(\"headerType\")]\n    public string? HeaderType { get; set; }            // NONE|TEXT|IMAGE|VIDEO|DOCUMENT\n\n    [JsonPropertyName(\"headerText\")]\n    public string? HeaderText { get; set; }\n\n    [JsonPropertyName(\"bodyText\")]\n    public string BodyText { get; set; } = default!;   // required\n\n    [JsonPropertyName(\"footerText\")]\n    public string? FooterText { get; set; }\n\n    // Buttons as simple POCOs (we serialize to JSON string)\n    [JsonPropertyName(\"buttons\")]\n    public List<LibraryImportButton> Buttons { get; set; } = new();\n\n    // Examples map for {{n}} placeholders\n    [JsonPropertyName(\"examples\")]\n    public Dictionary<string, string>? Examples { get; set; }\n}\n\npublic sealed class LibraryImportButton\n{\n    [JsonPropertyName(\"type\")] public string Type { get; set; } = default!; // QUICK_REPLY|URL|PHONE\n    [JsonPropertyName(\"text\")] public string Text { get; set; } = default!;\n    [JsonPropertyName(\"url\")] public string? Url { get; set; }\n    [JsonPropertyName(\"phone\")] public string? Phone { get; set; }\n}\n\npublic sealed class LibraryImportResult\n{\n    public bool Success { get; set; }\n    public int TotalItems { get; set; }\n    public int CreatedItems { get; set; }\n    public int UpdatedItems { get; set; }\n    public int CreatedVariants { get; set; }\n    public int UpdatedVariants { get; set; }\n    public List<LibraryImportError> Errors { get; set; } = new();\n}\n\npublic sealed class LibraryImportError\n{\n    public int ItemIndex { get; set; }\n    public int? VariantIndex { get; set; }\n    public string Message { get; set; } = default!;\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/SubmittedVariantResult.cs",
      "sha256": "43055ef6d4346ffc22ab02159fc72102cee35e2e741ec33258916bc8c2167746",
      "language": "csharp",
      "size": 255,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class SubmittedVariantResult\n{\n    public string Language { get; set; } = \"en_US\";\n    public string Status { get; set; } = \"PENDING\";\n    public string? RejectionReason { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateDraftCreateDto.cs",
      "sha256": "204b1e60b8e3c6810a7ab228ac6465ed2a9153c0c42d756ccbe41466eac38836",
      "language": "csharp",
      "size": 267,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateDraftCreateDto\n{\n    public string Key { get; set; } = string.Empty;\n    public string Category { get; set; } = \"UTILITY\";\n    public string DefaultLanguage { get; set; } = \"en_US\";\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateLanguageAddDto.cs",
      "sha256": "04be3b8fe33ecc0777720e37a7c4d36ad2bdb030af6d28cc664c017cfcb6949c",
      "language": "csharp",
      "size": 154,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateLanguageAddDto\n{\n    public string Language { get; set; } = \"en_US\";\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateLibraryListDtos.cs",
      "sha256": "909489a02b0eafb61968b6fb040457bd16df4ff71132e582d998f96b655f82d3",
      "language": "csharp",
      "size": 1026,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateLibraryListItemDto\n{\n    public Guid Id { get; set; }\n    public string Industry { get; set; } = default!;\n    public string Key { get; set; } = default!;\n    public string Category { get; set; } = default!;\n    public bool IsFeatured { get; set; }\n\n    // UI helpers (from first variant or a representative one)\n    public string Language { get; set; } = default!;\n    public string HeaderType { get; set; } = \"NONE\";\n    public int Placeholders { get; set; }       // {{n}} count in body\n    public string BodyPreview { get; set; } = \"\"; // first 120 chars (no examples applied)\n    public string ButtonsSummary { get; set; } = \"\"; // e.g., \"URL, QUICK_REPLY\"\n}\n\npublic sealed class TemplateLibraryListResponse\n{\n    public bool Success { get; set; } = true;\n    public int Page { get; set; }\n    public int PageSize { get; set; }\n    public int Total { get; set; }\n    public List<TemplateLibraryListItemDto> Items { get; set; } = new();\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateLibraryUseRequestDto.cs",
      "sha256": "655070646d57a4f3bd0f28c4d7d01ca3acc6ca55d6fc9e0dfca5e5ef88116978",
      "language": "csharp",
      "size": 209,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateLibraryUseRequestDto\n{\n    public Guid LibraryItemId { get; set; }\n    public List<string> Languages { get; set; } = new();\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateNameCheckDtos.cs",
      "sha256": "ddf6636a72012b50c1578dd1aaec5fee052b0a26239cba1823ca9864382f4f13",
      "language": "csharp",
      "size": 488,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateNameCheckResponse\n{\n    public Guid DraftId { get; set; }\n    public string Language { get; set; } = \"en_US\";\n\n    public string Name { get; set; } = default!;       // computed name we intend to use\n    public bool Available { get; set; }                // true if no collision in WhatsAppTemplates\n    public string? Suggestion { get; set; }            // first available suggestion, if not available\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplatePreviewDto.cs",
      "sha256": "ee8f3feec15359f418b2b6b4dca58978125322fad5da8a3ab4fc30068d7dc4db",
      "language": "csharp",
      "size": 739,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplatePreviewDto\n{\n    // High-level preview for UI\n    public string Language { get; set; } = default!;\n    public string Header { get; set; } = string.Empty;  // resolved header text (or “[IMAGE HEADER]”, etc.)\n    public string Body { get; set; } = string.Empty;  // resolved with example params\n    public string Footer { get; set; } = string.Empty;\n    public List<string> Buttons { get; set; } = new();\n\n    // Raw payload pieces your UI may also want\n    public object ComponentsPayload { get; set; } = default!;  // as built by MetaComponentsBuilder\n    public object ExamplesPayload { get; set; } = default!;  // as built by MetaComponentsBuilder\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/DTOs/TemplateSubmitResponseDto.cs",
      "sha256": "21ac421e71fb4f661527066fed3c5fea94f9cb3809f76e24f7bf0aa0c4bb45e0",
      "language": "csharp",
      "size": 271,
      "content": "namespace xbytechat.api.Features.TemplateModule.DTOs;\n\npublic sealed class TemplateSubmitResponseDto\n{\n    public bool Success { get; set; }\n    public string Message { get; set; } = string.Empty;\n    public List<SubmittedVariantResult> Variants { get; set; } = new();\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Language/SupportedLanguages.cs",
      "sha256": "783dad349fe10aee1ce978f5b11897424355adc0f90ee91f85c0cb61f18f9c93",
      "language": "csharp",
      "size": 507,
      "content": "namespace xbytechat.api.Features.TemplatesModule.Language;\n\n\npublic static class SupportedLanguages\n{\n    // Seed a small set; we’ll extend when needed.\n    public static readonly HashSet<string> All = new(StringComparer.OrdinalIgnoreCase)\n    {\n        \"en_US\", // English (US)\n        \"hi_IN\", // Hindi (India)\n        // add more later: \"en_GB\", \"mr_IN\", \"bn_IN\", ...\n    };\n\n    public static bool IsSupported(string? code)\n        => !string.IsNullOrWhiteSpace(code) && All.Contains(code.Trim());\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Models/TemplateDraft.cs",
      "sha256": "01390d591639e7dc085e21cd9b30c33bf1454247b82b00e56698f3f767c16238",
      "language": "csharp",
      "size": 592,
      "content": "namespace xbytechat.api.Features.TemplateModule.Models;\n\npublic sealed class TemplateDraft\n{\n    public Guid Id { get; set; }\n    public Guid BusinessId { get; set; }\n    public string Key { get; set; } = string.Empty;              // logical name (slug)\n    public string Category { get; set; } = \"UTILITY\";            // MARKETING|UTILITY|AUTHENTICATION\n    public string DefaultLanguage { get; set; } = \"en_US\";\n    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;\n    public string? CreatedByUserId { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Models/TemplateDraftVariant.cs",
      "sha256": "225a2c5d9fc993121caa920349ead738333ea18f8c715dd3d62ec738865142a8",
      "language": "csharp",
      "size": 748,
      "content": "namespace xbytechat.api.Features.TemplateModule.Models;\n\npublic sealed class TemplateDraftVariant\n{\n    public Guid Id { get; set; }\n    public Guid TemplateDraftId { get; set; }\n    public string Language { get; set; } = \"en_US\";\n    public string BodyText { get; set; } = string.Empty;\n\n    public string HeaderType { get; set; } = \"NONE\";             // TEXT|IMAGE|VIDEO|DOCUMENT|NONE\n    public string? HeaderText { get; set; }\n    public string? HeaderMediaLocalUrl { get; set; }\n\n    public string? FooterText { get; set; }\n    public string ButtonsJson { get; set; } = \"[]\";\n    public string ExampleParamsJson { get; set; } = \"{}\";\n\n    public bool IsReadyForSubmission { get; set; }\n    public string? ValidationErrorsJson { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Models/TemplateLibraryItem.cs",
      "sha256": "edd5de348418b1adbb660df10a10ec1ef87346fbac2fdcda58ee091361daa756",
      "language": "csharp",
      "size": 416,
      "content": "namespace xbytechat.api.Features.TemplateModule.Models;\n\npublic sealed class TemplateLibraryItem\n{\n    public Guid Id { get; set; }\n    public string Industry { get; set; } = \"RETAIL\";\n    public string Key { get; set; } = string.Empty;\n    public string Category { get; set; } = \"UTILITY\";\n    public string? TagsJson { get; set; }                 // [\"reminder\",\"promo\"]\n    public bool IsFeatured { get; set; }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Models/TemplateLibraryVariant.cs",
      "sha256": "eeb3735c5a46f4e5cec3f52f788dd8c201c48fa0d709d5a717f711f028861aa0",
      "language": "csharp",
      "size": 590,
      "content": "namespace xbytechat.api.Features.TemplateModule.Models;\n\npublic sealed class TemplateLibraryVariant\n{\n    public Guid Id { get; set; }\n    public Guid LibraryItemId { get; set; }\n    public string Language { get; set; } = \"en_US\";\n    public string BodyText { get; set; } = string.Empty;\n\n    public string HeaderType { get; set; } = \"NONE\";\n    public string? HeaderText { get; set; }\n    public string? HeaderDemoUrl { get; set; }\n    public string? FooterText { get; set; }\n\n    public string ButtonsJson { get; set; } = \"[]\";\n    public string ExampleParamsJson { get; set; } = \"{}\";\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Payload/MetaComponentsBuilder.cs",
      "sha256": "15086d5751247f124565acf4b4b6b6f42693f24639627ba7d23b0b2776a23797",
      "language": "csharp",
      "size": 3805,
      "content": "using System.Text.Json;\nusing xbytechat.api.Features.TemplateModule.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Payload;\n\npublic static class MetaComponentsBuilder\n{\n    // Builds a minimal Graph payload compatible structure.\n    // We return \"object\" (anonymous shape) so the Meta client can serialize directly.\n    public static (object components, object examples) Build(\n        string headerType,\n        string? headerText,\n        string? headerMetaMediaId,\n        string bodyText,\n        string? footerText,\n        List<ButtonDto> buttons,\n        Dictionary<string, string> examplesMap)\n    {\n        // Header\n        var components = new List<object>();\n\n        if (!headerType.Equals(\"NONE\", StringComparison.OrdinalIgnoreCase))\n        {\n            if (headerType.Equals(\"TEXT\", StringComparison.OrdinalIgnoreCase))\n            {\n                components.Add(new\n                {\n                    type = \"HEADER\",\n                    format = \"TEXT\",\n                    text = headerText ?? string.Empty\n                });\n            }\n            else\n            {\n                // IMAGE|VIDEO|DOCUMENT\n                components.Add(new\n                {\n                    type = \"HEADER\",\n                    format = headerType.ToUpperInvariant(),\n                    example = new\n                    {\n                        header_handle = new[] { headerMetaMediaId ?? string.Empty }\n                    }\n                });\n            }\n        }\n\n        // Body\n        components.Add(new\n        {\n            type = \"BODY\",\n            text = bodyText\n        });\n\n        // Footer\n        if (!string.IsNullOrWhiteSpace(footerText))\n        {\n            components.Add(new\n            {\n                type = \"FOOTER\",\n                text = footerText\n            });\n        }\n\n        // Buttons\n        if (buttons is { Count: > 0 })\n        {\n            var btns = new List<object>();\n            foreach (var b in buttons)\n            {\n                if (b.Type.Equals(\"QUICK_REPLY\", StringComparison.OrdinalIgnoreCase))\n                {\n                    btns.Add(new { type = \"QUICK_REPLY\", text = b.Text });\n                }\n                else if (b.Type.Equals(\"URL\", StringComparison.OrdinalIgnoreCase))\n                {\n                    btns.Add(new { type = \"URL\", text = b.Text, url = b.Url });\n                }\n                else if (b.Type.Equals(\"PHONE\", StringComparison.OrdinalIgnoreCase))\n                {\n                    btns.Add(new { type = \"PHONE_NUMBER\", text = b.Text, phone_number = b.Phone });\n                }\n            }\n\n            if (btns.Count > 0)\n            {\n                components.Add(new\n                {\n                    type = \"BUTTONS\",\n                    buttons = btns\n                });\n            }\n        }\n\n        // Examples: WA expects arrays per component; for body variables, supply example text array\n        // We map {\"1\":\"John\",\"2\":\"12345\"} -> [[\"John\",\"12345\"]]\n        var maxIndex = 0;\n        foreach (var k in examplesMap.Keys)\n        {\n            if (int.TryParse(k, out var n) && n > maxIndex) maxIndex = n;\n        }\n        var bodyExampleRow = new List<string>();\n        for (int i = 1; i <= maxIndex; i++)\n        {\n            examplesMap.TryGetValue(i.ToString(), out var val);\n            bodyExampleRow.Add(val ?? \"\");\n        }\n\n        var examples = new\n        {\n            // aligns with newer Graph requirements (body_text examples)\n            // bodyExampleRow: List<string>  -> convert to string[] so both branches are string[][]\n            body_text = bodyExampleRow.Count > 0\n         ? new[] { bodyExampleRow.ToArray() }\n         : Array.Empty<string[]>()\n        };\n\n\n        return (components, examples);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/IWhatsAppTemplateService.cs",
      "sha256": "2ed5f5891246b4fec02e29892760c3d033e76572488701c525fd801763f742a9",
      "language": "csharp",
      "size": 226,
      "content": "using xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Services\n{\n    public interface IWhatsAppTemplateService\n    {\n        Task<List<TemplateMetadataDto>> FetchTemplatesAsync();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/MetaCredentialsResolver.cs",
      "sha256": "a87254837c74c6908a3f63d6c43ecf90afd88667186dd4ccd51e8fecb257728b",
      "language": "csharp",
      "size": 2287,
      "content": "using System.Text.RegularExpressions;\nusing xbytechat_api.WhatsAppSettings.Services; // IWhatsAppSettingsService\nusing xbytechat.api.Features.TemplateModule.Abstractions;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class MetaCredentialsResolver : IMetaCredentialsResolver\n{\n    private readonly IWhatsAppSettingsService _wa;\n\n    // Matches .../vXX or .../vXX.X (optionally with trailing slash)\n    private static readonly Regex VersionSeg = new(@\"/(v\\d+(?:\\.\\d+)?)\\/?$\", RegexOptions.IgnoreCase | RegexOptions.Compiled);\n\n    public MetaCredentialsResolver(IWhatsAppSettingsService waSettings)\n    {\n        _wa = waSettings;\n    }\n\n    public async Task<MetaCredentials> ResolveAsync(Guid businessId, CancellationToken ct = default)\n    {\n        // Your existing call; if you have a ct-aware version, wire it here.\n        var s = await _wa.GetSettingsByBusinessIdAsync(businessId);\n        if (s is null) throw new InvalidOperationException(\"WhatsApp settings not found for this business.\");\n\n        var apiUrl = (s.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n        var token = (s.ApiKey ?? string.Empty).Trim();\n        var wabaId = (s.WabaId ?? string.Empty).Trim();\n\n        if (string.IsNullOrWhiteSpace(apiUrl)) throw new InvalidOperationException(\"Meta ApiUrl is missing.\");\n        if (string.IsNullOrWhiteSpace(token)) throw new InvalidOperationException(\"Meta access token is missing.\");\n        if (string.IsNullOrWhiteSpace(wabaId)) throw new InvalidOperationException(\"Meta WABA ID is missing.\");\n\n        // If ApiUrl already includes a version (e.g., https://graph.facebook.com/v21.0)\n        // split it into base + version; otherwise leave version empty.\n        string baseUrl = apiUrl;\n        string version = string.Empty;\n\n        var m = VersionSeg.Match(apiUrl);\n        if (m.Success)\n        {\n            version = m.Groups[1].Value;                                // e.g., v21.0\n            baseUrl = apiUrl.Substring(0, m.Index).TrimEnd('/');        // e.g., https://graph.facebook.com\n        }\n\n        return new MetaCredentials(\n            AccessToken: token,\n            GraphBaseUrl: baseUrl,\n            GraphVersion: version,   // can be \"\" if ApiUrl had no version\n            WabaId: wabaId\n        );\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/MetaTemplateClient.cs",
      "sha256": "c35af0bdf85633c162db2c3bc19cacbc537c961109b1857bd183b2dc9bf2e24f",
      "language": "csharp",
      "size": 7599,
      "content": "using System.Net;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class MetaTemplateClient : IMetaTemplateClient\n{\n    private readonly IHttpClientFactory _httpClientFactory;\n    private readonly IMetaCredentialsResolver _creds;\n    private readonly ILogger<MetaTemplateClient> _log;\n\n    private static readonly JsonSerializerOptions JsonOpts = new(JsonSerializerDefaults.Web)\n    {\n        WriteIndented = false\n    };\n\n    public MetaTemplateClient(\n        IHttpClientFactory httpClientFactory,\n        IMetaCredentialsResolver creds,\n        ILogger<MetaTemplateClient> log)\n    {\n        _httpClientFactory = httpClientFactory;\n        _creds = creds;\n        _log = log;\n    }\n\n    public async Task<string> UploadMediaAsync(Guid businessId, string localPathOrUrl, string mediaType, CancellationToken ct = default)\n    {\n        // For template headers, Meta requires an \"asset handle\" (aka header_handle).\n        // If the caller passes an already-generated handle, accept it.\n        if (localPathOrUrl.StartsWith(\"handle:\", StringComparison.OrdinalIgnoreCase))\n            return localPathOrUrl.Substring(\"handle:\".Length);\n\n        // Otherwise, we expect the caller to have performed the Resumable Upload flow.\n        throw new NotSupportedException(\n            \"Media headers require a Meta asset handle (header_handle). \" +\n            \"Upload the media via Meta Resumable Upload API first and pass the resulting handle \" +\n            \"(prefix with 'handle:' if you want to bypass this guard).\");\n    }\n\n    public async Task<bool> CreateTemplateAsync(\n        Guid businessId,\n        string name,\n        string category,\n        string language,\n        object componentsPayload,\n        object examplesPayload,\n        CancellationToken ct = default)\n    {\n        // Resolve real credentials from your WhatsAppSettings-backed resolver.\n        // Your resolver can return either:\n        //  - GraphBaseUrl + GraphVersion (e.g., https://graph.facebook.com + v21.0), or\n        //  - ApiUrl that already includes a version (e.g., https://graph.facebook.com/v21.0)\n        var c = await _creds.ResolveAsync(businessId, ct);\n\n        // Build base URL robustly whether version is present or not.\n        // If your resolver sets GraphVersion to \"\", pathPart becomes \"\".\n        var baseRoot = (c.GraphBaseUrl ?? \"\").TrimEnd('/');\n        var versionPart = string.IsNullOrWhiteSpace(c.GraphVersion) ? \"\" : \"/\" + c.GraphVersion.Trim('/');\n        var baseWithVersion = $\"{baseRoot}{versionPart}/\";\n\n        var client = _httpClientFactory.CreateClient(\"meta-graph\");\n        client.BaseAddress = new Uri(baseWithVersion);\n        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", c.AccessToken);\n\n        // Per Meta docs: POST /{WABA_ID}/message_templates\n        // Body: name, category, language, components (examples for variables embedded via BODY).\n        var payload = new\n        {\n            name,\n            category,\n            allow_category_change = true, // helps reduce rejections due to miscategorization\n            language,\n            components = componentsPayload\n            // NOTE: If you later need top-level examples, include them here per the latest API version.\n        };\n\n        using var content = new StringContent(JsonSerializer.Serialize(payload, JsonOpts), Encoding.UTF8, \"application/json\");\n        using var resp = await client.PostAsync($\"{c.WabaId}/message_templates\", content, ct);\n\n        var body = await resp.Content.ReadAsStringAsync(ct);\n\n        if (resp.IsSuccessStatusCode)\n        {\n            _log.LogInformation(\"Meta create template OK | WABA {WabaId} | name {Name} | lang {Lang}\", c.WabaId, name, language);\n            return true;\n        }\n\n        // Try to parse Meta error for clearer diagnostics.\n        string friendlyError = ExtractMetaError(body, (int)resp.StatusCode);\n\n        // Common statuses:\n        // 400: invalid payload (components/examples/name)\n        // 401/403: auth/permission\n        // 409: duplicate name+language\n        // 429/5xx: rate limiting / transient errors\n        _log.LogWarning(\"Meta create failed ({StatusCode} {Status}): {Error}\",\n            (int)resp.StatusCode, resp.StatusCode, friendlyError);\n\n        return false;\n    }\n\n    public Task<int> SyncTemplatesAsync(Guid businessId, CancellationToken ct = default)\n        => Task.FromResult(0);\n\n   \n\n    // ───────────────────────── helpers ─────────────────────────\n\n    private static string ExtractMetaError(string responseBody, int statusCode)\n    {\n        try\n        {\n            // Meta error shape: { \"error\": { \"message\": \"...\", \"type\": \"...\", \"code\": 0, \"error_subcode\": 0, \"fbtrace_id\": \"...\" } }\n            using var doc = JsonDocument.Parse(responseBody);\n            var root = doc.RootElement;\n\n            if (root.TryGetProperty(\"error\", out var err))\n            {\n                var msg = err.TryGetProperty(\"message\", out var m) ? m.GetString() : null;\n                var type = err.TryGetProperty(\"type\", out var t) ? t.GetString() : null;\n                var code = err.TryGetProperty(\"code\", out var c) ? c.GetInt32() : (int?)null;\n                var sub = err.TryGetProperty(\"error_subcode\", out var s) ? s.GetInt32() : (int?)null;\n                var fb = err.TryGetProperty(\"fbtrace_id\", out var f) ? f.GetString() : null;\n\n                return $\"Meta error: {(type ?? \"N/A\")} | code {(code?.ToString() ?? \"N/A\")}\" +\n                       $\"{(sub.HasValue ? $\" subcode {sub}\" : \"\")} | message: {msg ?? \"N/A\"} | fbtrace_id: {fb ?? \"N/A\"}\";\n            }\n        }\n        catch\n        {\n            // ignore JSON parse errors, fall back to raw body\n        }\n\n        // Fallback to raw text if not JSON or unexpected\n        return $\"HTTP {statusCode}: {responseBody}\";\n    }\n\n    public async Task<bool> DeleteTemplateAsync(Guid businessId, string name, string language, CancellationToken ct = default)\n    {\n        var c = await _creds.ResolveAsync(businessId, ct);\n        var client = _httpClientFactory.CreateClient(\"meta-graph\");\n        client.BaseAddress = new Uri($\"{c.GraphBaseUrl.TrimEnd('/')}/{c.GraphVersion.Trim('/')}/\");\n        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", c.AccessToken);\n\n        // Graph supports DELETE on /{wabaId}/message_templates with query params name & language\n        var url = $\"{c.WabaId}/message_templates?name={Uri.EscapeDataString(name)}&language={Uri.EscapeDataString(language)}\";\n        using var resp = await client.DeleteAsync(url, ct);\n        var body = await resp.Content.ReadAsStringAsync(ct);\n\n        if (resp.IsSuccessStatusCode)\n        {\n            _log.LogInformation(\"Meta delete template OK | WABA {WabaId} | name {Name} | lang {Lang}\", c.WabaId, name, language);\n            return true;\n        }\n\n        // 404/400 means already gone or not found; treat as success from UX standpoint\n        if ((int)resp.StatusCode == 404 || (int)resp.StatusCode == 400)\n        {\n            _log.LogWarning(\"Meta delete returned {Code} but treating as success. Body: {Body}\", resp.StatusCode, body);\n            return true;\n        }\n\n        _log.LogWarning(\"Meta delete failed ({Code}): {Body}\", resp.StatusCode, body);\n        return false;\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/MetaUploadService.cs",
      "sha256": "f258f50789b93cdf3e578a22b2bc28d3a49c92bd1943e167e89e1aa366725229",
      "language": "csharp",
      "size": 13940,
      "content": "using System;\nusing System.IO;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Collections.Generic;\nusing System.Text.Json;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.Extensions.Options;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.Config;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class MetaUploadService : IMetaUploadService\n{\n    private readonly IHttpClientFactory _httpFactory;\n    private readonly IMetaCredentialsResolver _creds;\n    private readonly UploadLimitsOptions _opts;\n\n    public MetaUploadService(\n        IHttpClientFactory httpFactory,\n        IMetaCredentialsResolver creds,\n        IOptions<UploadLimitsOptions> opts)\n    {\n        _httpFactory = httpFactory;\n        _creds = creds;\n        _opts = opts.Value;\n    }\n\n    public async Task<HeaderUploadResult> UploadHeaderAsync(\n        Guid businessId,\n        HeaderMediaType mediaType,\n        Stream? fileStream,\n        string? fileName,\n        string? sourceUrl,\n        CancellationToken ct = default)\n    {\n        if ((fileStream is null && string.IsNullOrWhiteSpace(sourceUrl)) ||\n            (fileStream is not null && !string.IsNullOrWhiteSpace(sourceUrl)))\n            throw new ArgumentException(\"Provide either a file or a sourceUrl, not both.\");\n\n        // If sourceUrl provided, download then proceed\n        if (fileStream is null && sourceUrl is not null)\n        {\n            using var http = new HttpClient();\n            using var resp = await http.GetAsync(sourceUrl, HttpCompletionOption.ResponseHeadersRead, ct);\n            resp.EnsureSuccessStatusCode();\n\n            var tmp = new MemoryStream();\n            await resp.Content.CopyToAsync(tmp, ct);\n            tmp.Position = 0;\n\n            var mime = resp.Content.Headers.ContentType?.MediaType ?? \"application/octet-stream\";\n            var fname = Path.GetFileName(new Uri(sourceUrl).LocalPath);\n            return await UploadCoreAsync(businessId, mediaType, tmp, fname, mime, ct);\n        }\n\n        // File provided\n        if (fileStream is not null)\n        {\n            var mime = GuessMime(fileName, mediaType);\n            return await UploadCoreAsync(businessId, mediaType, fileStream, fileName ?? \"upload.bin\", mime, ct);\n        }\n\n        throw new InvalidOperationException(\"No file or URL provided.\");\n    }\n\n    private async Task<HeaderUploadResult> UploadCoreAsync(\n        Guid businessId,\n        HeaderMediaType mediaType,\n        Stream content,\n        string fileName,\n        string mime,\n        CancellationToken ct)\n    {\n        // Ensure we can read length + seek (so we can retry Path B after Path A)\n        if (!content.CanSeek)\n        {\n            var mem = new MemoryStream();\n            await content.CopyToAsync(mem, ct);\n            mem.Position = 0;\n            content = mem;\n        }\n\n        var size = content.Length;\n\n        // Size/MIME guards\n        switch (mediaType)\n        {\n            case HeaderMediaType.IMAGE:\n                if (size > _opts.ImageMaxBytes) throw new InvalidOperationException(\"Image too large.\");\n                if (!_opts.AllowedImageMime.Contains(mime, StringComparer.OrdinalIgnoreCase))\n                    throw new InvalidOperationException($\"Invalid image MIME: {mime}\");\n                break;\n\n            case HeaderMediaType.VIDEO:\n                if (size > _opts.VideoMaxBytes) throw new InvalidOperationException(\"Video too large.\");\n                if (!_opts.AllowedVideoMime.Contains(mime, StringComparer.OrdinalIgnoreCase))\n                    throw new InvalidOperationException($\"Invalid video MIME: {mime}\");\n                break;\n\n            case HeaderMediaType.DOCUMENT:\n                if (size > _opts.DocumentMaxBytes) throw new InvalidOperationException(\"Document too large.\");\n                if (!_opts.AllowedDocMime.Contains(mime, StringComparer.OrdinalIgnoreCase))\n                    throw new InvalidOperationException($\"Invalid document MIME: {mime}\");\n                break;\n        }\n\n        // ── STUB MODE ─────────────────────────────────────────────────────────────\n        if (_opts.UseStubHandle)\n        {\n            var handleStub = $\"{(int)mediaType}:{Guid.NewGuid():N}\".Insert(1, \"::\");\n            return new HeaderUploadResult(handleStub, mime, size, IsStub: true);\n        }\n\n        // ── REAL MODE: Meta Resumable Upload ─────────────────────────────────────\n        var c = await _creds.ResolveAsync(businessId, ct);\n\n        var baseRoot = (c.GraphBaseUrl ?? \"\").TrimEnd('/');\n        var versionPart = string.IsNullOrWhiteSpace(c.GraphVersion) ? \"\" : \"/\" + c.GraphVersion.Trim('/');\n        var baseWithVersion = $\"{baseRoot}{versionPart}\";\n\n        using var client = _httpFactory.CreateClient(\"meta-graph\");\n        client.BaseAddress = new Uri(baseWithVersion + \"/\");\n        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", c.AccessToken);\n\n        // Meta expects IMAGE|VIDEO|DOCUMENT\n        string fileTypeParam = mediaType switch\n        {\n            HeaderMediaType.IMAGE => \"IMAGE\",\n            HeaderMediaType.VIDEO => \"VIDEO\",\n            HeaderMediaType.DOCUMENT => \"DOCUMENT\",\n            _ => \"DOCUMENT\"\n        };\n\n        // Path A: uploads session\n        var handle = await TryPathA_UploadsEndpointAsync(client, c.WabaId, fileTypeParam, content, fileName, mime, size, ct);\n        if (!string.IsNullOrWhiteSpace(handle))\n            return new HeaderUploadResult(handle!, mime, size, false);\n\n        // Rewind before fallback (Path A already consumed the stream)\n        try { content.Position = 0; } catch { /* ignore */ }\n\n        // Path B: phased upload\n        handle = await TryPathB_PhasedUploadAsync(client, c.WabaId, fileTypeParam, content, fileName, mime, size, ct);\n        if (!string.IsNullOrWhiteSpace(handle))\n            return new HeaderUploadResult(handle!, mime, size, false);\n\n        throw new InvalidOperationException(\"Meta upload did not return an asset handle. Check app permissions and the response logs.\");\n    }\n\n    // ── Path A: WABA uploads session (single-shot Content-Range) ────────────────\n    private async Task<string?> TryPathA_UploadsEndpointAsync(\n        HttpClient client,\n        string wabaId,\n        string fileTypeParam,\n        Stream content,\n        string fileName,\n        string mime,\n        long size,\n        CancellationToken ct)\n    {\n        // INIT\n        var initPayload = new Dictionary<string, string>\n        {\n            [\"file_type\"] = fileTypeParam,\n            [\"file_length\"] = size.ToString()\n        };\n        using var initResp = await client.PostAsync($\"{wabaId}/uploads\", new FormUrlEncodedContent(initPayload), ct);\n        var initText = await initResp.Content.ReadAsStringAsync(ct);\n        if (!initResp.IsSuccessStatusCode) return null;\n\n        var initJson = SafeParse(initText);\n        var uploadId = initJson.TryGetValue(\"id\", out var idObj) ? idObj?.ToString() : null;\n        if (string.IsNullOrWhiteSpace(uploadId)) return null;\n\n        // TRANSFER (single range)\n        using (var req = new HttpRequestMessage(HttpMethod.Post, uploadId))\n        {\n            req.Content = new StreamContent(content);\n            req.Content.Headers.ContentType = new MediaTypeHeaderValue(\"application/octet-stream\");\n            req.Content.Headers.ContentLength = size;\n            req.Headers.TryAddWithoutValidation(\"Content-Range\", $\"bytes 0-{size - 1}/{size}\");\n\n            using var upResp = await client.SendAsync(req, HttpCompletionOption.ResponseHeadersRead, ct);\n            var upText = await upResp.Content.ReadAsStringAsync(ct);\n            if (!upResp.IsSuccessStatusCode) return null;\n        }\n\n        // FINISH\n        var finPayload = new Dictionary<string, string> { [\"finish\"] = \"true\" };\n        using var finResp = await client.PostAsync(uploadId, new FormUrlEncodedContent(finPayload), ct);\n        var finText = await finResp.Content.ReadAsStringAsync(ct);\n        if (!finResp.IsSuccessStatusCode) return null;\n\n        var finJson = SafeParse(finText);\n        if (TryExtractHandle(finJson, out var handle)) return handle;\n\n        return null;\n    }\n\n    // ── Path B: classic phased upload (start/transfer/finish) ───────────────────\n    private async Task<string?> TryPathB_PhasedUploadAsync(\n        HttpClient client,\n        string wabaId,\n        string fileTypeParam,\n        Stream content,\n        string fileName,\n        string mime,\n        long size,\n        CancellationToken ct)\n    {\n        // START\n        var startPayload = new Dictionary<string, string>\n        {\n            [\"upload_phase\"] = \"start\",\n            [\"file_type\"] = fileTypeParam,\n            [\"file_length\"] = size.ToString()\n        };\n        using var startResp = await client.PostAsync($\"{wabaId}/uploads\", new FormUrlEncodedContent(startPayload), ct);\n        var startText = await startResp.Content.ReadAsStringAsync(ct);\n        if (!startResp.IsSuccessStatusCode) return null;\n\n        var startJson = SafeParse(startText);\n        var sessionId = startJson.TryGetValue(\"id\", out var idObj) ? idObj?.ToString() : null;\n        if (string.IsNullOrWhiteSpace(sessionId)) return null;\n\n        // TRANSFER\n        using (var req = new HttpRequestMessage(HttpMethod.Post, $\"{sessionId}?upload_phase=transfer\"))\n        {\n            req.Content = new StreamContent(content);\n            req.Content.Headers.ContentType = new MediaTypeHeaderValue(\"application/octet-stream\");\n            req.Content.Headers.ContentLength = size;\n            req.Headers.TryAddWithoutValidation(\"Content-Range\", $\"bytes 0-{size - 1}/{size}\");\n\n            using var transferResp = await client.SendAsync(req, HttpCompletionOption.ResponseHeadersRead, ct);\n            var transferText = await transferResp.Content.ReadAsStringAsync(ct);\n            if (!transferResp.IsSuccessStatusCode) return null;\n        }\n\n        // FINISH\n        using (var req = new HttpRequestMessage(HttpMethod.Post, $\"{sessionId}?upload_phase=finish\"))\n        {\n            req.Content = new FormUrlEncodedContent(new Dictionary<string, string> { [\"confirm\"] = \"true\" });\n\n            using var finishResp = await client.SendAsync(req, ct);\n            var finishText = await finishResp.Content.ReadAsStringAsync(ct);\n            if (!finishResp.IsSuccessStatusCode) return null;\n\n            var finJson = SafeParse(finishText);\n            if (TryExtractHandle(finJson, out var handle)) return handle;\n        }\n\n        return null;\n    }\n\n    // ── JSON helpers ────────────────────────────────────────────────────────────\n    private static Dictionary<string, object?> SafeParse(string json)\n    {\n        try\n        {\n            var root = JsonSerializer.Deserialize<Dictionary<string, object?>>(json);\n            return root ?? new Dictionary<string, object?>();\n        }\n        catch\n        {\n            return new Dictionary<string, object?>();\n        }\n    }\n\n    private static bool TryExtractHandle(Dictionary<string, object?> json, out string? handle)\n    {\n        handle = null;\n\n        if (json.TryGetValue(\"h\", out var h) && !string.IsNullOrWhiteSpace(h?.ToString()))\n        {\n            handle = h!.ToString();\n            return true;\n        }\n\n        if (json.TryGetValue(\"handle\", out var hh) && !string.IsNullOrWhiteSpace(hh?.ToString()))\n        {\n            handle = hh!.ToString();\n            return true;\n        }\n\n        if (json.TryGetValue(\"asset_handle\", out var ah) && !string.IsNullOrWhiteSpace(ah?.ToString()))\n        {\n            handle = ah!.ToString();\n            return true;\n        }\n\n        // sometimes nested { \"result\": { \"h\": \"4::...\" } }\n        if (json.TryGetValue(\"result\", out var resObj) &&\n            resObj is JsonElement el &&\n            el.ValueKind == JsonValueKind.Object)\n        {\n            if (el.TryGetProperty(\"h\", out var h2) && h2.ValueKind == JsonValueKind.String)\n            {\n                handle = h2.GetString();\n                return true;\n            }\n            if (el.TryGetProperty(\"handle\", out var h3) && h3.ValueKind == JsonValueKind.String)\n            {\n                handle = h3.GetString();\n                return true;\n            }\n            if (el.TryGetProperty(\"asset_handle\", out var h4) && h4.ValueKind == JsonValueKind.String)\n            {\n                handle = h4.GetString();\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    // ── MIME guessing ───────────────────────────────────────────────────────────\n    private static string GuessMime(string? fileName, HeaderMediaType mediaType)\n    {\n        var ext = Path.GetExtension(fileName ?? string.Empty).ToLowerInvariant();\n\n        if (mediaType == HeaderMediaType.IMAGE)\n            return ext switch\n            {\n                \".jpg\" or \".jpeg\" => \"image/jpeg\",\n                \".png\" => \"image/png\",\n                \".webp\" => \"image/webp\",\n                _ => \"image/jpeg\"\n            };\n\n        if (mediaType == HeaderMediaType.VIDEO)\n            return \"video/mp4\";\n\n        if (mediaType == HeaderMediaType.DOCUMENT)\n            return ext switch\n            {\n                \".pdf\" => \"application/pdf\",\n                _ => \"application/pdf\"\n            };\n\n        return \"application/octet-stream\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateDraftLifecycleService.cs",
      "sha256": "2666d108237bdcc3f78dd6e85e8e7a4ca4c0f19531bce326eeb1b92ee5abe974",
      "language": "csharp",
      "size": 4916,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.Models;\nusing xbytechat.api.Features.TemplateModule.Services;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class TemplateDraftLifecycleService : ITemplateDraftLifecycleService\n{\n    private readonly AppDbContext _db;\n    private readonly IMetaTemplateClient _meta;\n\n    public TemplateDraftLifecycleService(AppDbContext db, IMetaTemplateClient meta)\n    {\n        _db = db;\n        _meta = meta;\n    }\n\n    public async Task<TemplateDraft> DuplicateDraftAsync(Guid businessId, Guid draftId, CancellationToken ct = default)\n    {\n        var src = await _db.TemplateDrafts.AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (src is null) throw new KeyNotFoundException(\"Draft not found.\");\n\n        var keyBase = src.Key;\n        var suffix = 2;\n        var newKey = $\"{keyBase}_copy\";\n        while (await _db.TemplateDrafts.AnyAsync(x => x.BusinessId == businessId && x.Key == newKey, ct))\n        {\n            newKey = $\"{keyBase}_copy{suffix}\";\n            suffix++;\n        }\n\n        var now = DateTime.UtcNow;\n        var dup = new TemplateDraft\n        {\n            Id = Guid.NewGuid(),\n            BusinessId = businessId,\n            Key = newKey,\n            Category = src.Category,\n            DefaultLanguage = src.DefaultLanguage,\n            CreatedAt = now,\n            UpdatedAt = now\n        };\n\n        _db.TemplateDrafts.Add(dup);\n\n        var variants = await _db.TemplateDraftVariants\n            .AsNoTracking()\n            .Where(v => v.TemplateDraftId == src.Id)\n            .ToListAsync(ct);\n\n        foreach (var v in variants)\n        {\n            _db.TemplateDraftVariants.Add(new TemplateDraftVariant\n            {\n                Id = Guid.NewGuid(),\n                TemplateDraftId = dup.Id,\n                Language = v.Language,\n                HeaderType = v.HeaderType,\n                HeaderText = v.HeaderText,\n                HeaderMediaLocalUrl = v.HeaderMediaLocalUrl, // keep handle if present; user can replace\n                BodyText = v.BodyText,\n                FooterText = v.FooterText,\n                ButtonsJson = v.ButtonsJson,\n                ExampleParamsJson = v.ExampleParamsJson,\n                IsReadyForSubmission = v.IsReadyForSubmission,\n                ValidationErrorsJson = v.ValidationErrorsJson\n            });\n        }\n\n        await _db.SaveChangesAsync(ct);\n        return dup;\n    }\n\n\n    public async Task<bool> DeleteDraftAsync(Guid businessId, Guid draftId, CancellationToken ct = default)\n    {\n        // 1) Find the draft scoped to the tenant\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n\n        if (draft is null) return false;\n\n        // 2) Hard-delete variants explicitly (no nav needed)\n\n        // If you're on EF Core 7+, this is the fastest way:\n        try\n        {\n            await _db.TemplateDraftVariants\n                .Where(v => v.TemplateDraftId == draft.Id)\n                .ExecuteDeleteAsync(ct);\n        }\n        catch (NotSupportedException)\n        {\n            // Fallback for EF Core < 7: load + RemoveRange\n            var children = await _db.TemplateDraftVariants\n                .Where(v => v.TemplateDraftId == draft.Id)\n                .ToListAsync(ct);\n            if (children.Count > 0)\n                _db.TemplateDraftVariants.RemoveRange(children);\n        }\n\n        // 3) Delete the parent draft\n        _db.TemplateDrafts.Remove(draft);\n\n        // 4) Commit\n        await _db.SaveChangesAsync(ct);\n        return true;\n    }\n\n\n    public async Task<bool> DeleteApprovedTemplateAsync(Guid businessId, string name, string language, CancellationToken ct = default)\n    {\n        if (string.IsNullOrWhiteSpace(name) || string.IsNullOrWhiteSpace(language))\n            throw new ArgumentException(\"Name and language are required.\");\n\n        // 1) Ask Meta to delete\n        var okMeta = await _meta.DeleteTemplateAsync(businessId, name, language, ct);\n\n        // 2) Soft-delete locally even if Meta already deleted (idempotent UX)\n        var rows = await _db.WhatsAppTemplates\n            .Where(t => t.BusinessId == businessId && t.Name == name && t.LanguageCode == language)\n            .ToListAsync(ct);\n\n        if (rows.Count > 0)\n        {\n            var now = DateTime.UtcNow;\n            foreach (var t in rows)\n            {\n                t.IsActive = false;\n                t.Status = \"DELETED\"; // keep a conventional marker\n                t.UpdatedAt = now;\n                t.LastSyncedAt = now;\n            }\n            await _db.SaveChangesAsync(ct);\n        }\n\n        return okMeta;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateDraftService.cs",
      "sha256": "9ab4518740e79733ed3f5ae2c338e373d953fe540ece2caf65420387152b45ef",
      "language": "csharp",
      "size": 11874,
      "content": "using System.Text.Json;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Models;\nusing xbytechat.api.Features.TemplateModule.Payload;\nusing xbytechat.api.Features.TemplateModule.Validators;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class TemplateDraftService : ITemplateDraftService\n{\n    private readonly AppDbContext _db;\n    private static readonly JsonSerializerOptions JsonOpts = new(JsonSerializerDefaults.Web);\n\n    public TemplateDraftService(AppDbContext db)\n    {\n        _db = db;\n    }\n\n    public async Task<TemplateDraft> CreateDraftAsync(Guid businessId, TemplateDraftCreateDto dto, CancellationToken ct = default)\n    {\n        var exists = await _db.TemplateDrafts\n            .AnyAsync(x => x.BusinessId == businessId && x.Key == dto.Key, ct);\n        if (exists)\n            throw new InvalidOperationException(\"A draft with the same Key already exists for this business.\");\n\n        var draft = new TemplateDraft\n        {\n            Id = Guid.NewGuid(),\n            BusinessId = businessId,\n            Key = dto.Key.Trim(),\n            Category = string.IsNullOrWhiteSpace(dto.Category) ? \"UTILITY\" : dto.Category.Trim().ToUpperInvariant(),\n            DefaultLanguage = string.IsNullOrWhiteSpace(dto.DefaultLanguage) ? \"en_US\" : dto.DefaultLanguage.Trim(),\n            CreatedAt = DateTime.UtcNow,\n            UpdatedAt = DateTime.UtcNow\n        };\n\n        _db.TemplateDrafts.Add(draft);\n        await _db.SaveChangesAsync(ct);\n        return draft;\n    }\n\n    public async Task<TemplateDraftVariant> UpsertVariantAsync(Guid businessId, Guid draftId, TemplateDraftVariantUpsertDto dto, CancellationToken ct = default)\n    {\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n\n        if (draft is null)\n            throw new KeyNotFoundException(\"Draft not found for this business.\");\n\n        var validation = VariantValidator.Validate(dto);\n        if (!validation.Ok)\n            throw new InvalidOperationException(string.Join(\" | \", validation.Errors));\n\n        var lang = dto.Language.Trim();\n\n        var variant = await _db.TemplateDraftVariants\n            .FirstOrDefaultAsync(v => v.TemplateDraftId == draft.Id && v.Language == lang, ct);\n\n        var buttonsJson = JsonSerializer.Serialize(dto.Buttons ?? new List<ButtonDto>(), JsonOpts);\n        var examplesJson = JsonSerializer.Serialize(dto.Examples ?? new Dictionary<string, string>(), JsonOpts);\n\n        if (variant is null)\n        {\n            variant = new TemplateDraftVariant\n            {\n                Id = Guid.NewGuid(),\n                TemplateDraftId = draft.Id,\n                Language = lang,\n                BodyText = dto.BodyText,\n                HeaderType = dto.HeaderType,\n                HeaderText = dto.HeaderText,\n                HeaderMediaLocalUrl = dto.HeaderMediaLocalUrl,\n                FooterText = dto.FooterText,\n                ButtonsJson = buttonsJson,\n                ExampleParamsJson = examplesJson,\n                IsReadyForSubmission = true,\n                ValidationErrorsJson = null\n            };\n            _db.TemplateDraftVariants.Add(variant);\n        }\n        else\n        {\n            variant.BodyText = dto.BodyText;\n            variant.HeaderType = dto.HeaderType;\n            variant.HeaderText = dto.HeaderText;\n            variant.HeaderMediaLocalUrl = dto.HeaderMediaLocalUrl;\n            variant.FooterText = dto.FooterText;\n            variant.ButtonsJson = buttonsJson;\n            variant.ExampleParamsJson = examplesJson;\n            variant.IsReadyForSubmission = true;\n            variant.ValidationErrorsJson = null;\n        }\n\n        draft.UpdatedAt = DateTime.UtcNow;\n\n        await _db.SaveChangesAsync(ct);\n        return variant;\n    }\n\n    public async Task<bool> ValidateAsync(Guid businessId, Guid draftId, CancellationToken ct = default)\n    {\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (draft is null) return false;\n\n        var variants = await _db.TemplateDraftVariants\n            .Where(v => v.TemplateDraftId == draft.Id)\n            .ToListAsync(ct);\n\n        return variants.Any(v => v.IsReadyForSubmission);\n    }\n\n    public async Task<(bool ok, Dictionary<string, List<string>> errors)> ValidateAllAsync(Guid businessId, Guid draftId, CancellationToken ct = default)\n    {\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (draft is null) return (false, new() { { \"global\", new() { \"Draft not found.\" } } });\n\n        var variants = await _db.TemplateDraftVariants\n            .Where(v => v.TemplateDraftId == draft.Id)\n            .ToListAsync(ct);\n\n        if (variants.Count == 0)\n            return (false, new() { { \"global\", new() { \"No language variants found.\" } } });\n\n        // Map DB rows to validator view\n        var views = variants.Select(v => new MultiLanguageValidator.VariantView\n        {\n            Language = v.Language,\n            BodyText = v.BodyText,\n            HeaderType = v.HeaderType,\n            HeaderText = v.HeaderText,\n            HeaderMediaLocalUrl = v.HeaderMediaLocalUrl,\n            FooterText = v.FooterText,\n            Buttons = SafeDeserialize<List<ButtonDto>>(v.ButtonsJson) ?? new(),\n            Examples = SafeDeserialize<Dictionary<string, string>>(v.ExampleParamsJson) ?? new()\n        }).ToList();\n\n        var (ok, errors) = MultiLanguageValidator.Validate(views);\n\n        // Persist per-variant readiness & last validation errors (optional but helpful)\n        foreach (var v in variants)\n        {\n            v.IsReadyForSubmission = !errors.ContainsKey(v.Language) || errors[v.Language].Count == 0;\n            v.ValidationErrorsJson = errors.ContainsKey(v.Language)\n                ? JsonSerializer.Serialize(errors[v.Language], JsonOpts)\n                : null;\n        }\n        await _db.SaveChangesAsync(ct);\n\n        return (ok, errors);\n    }\n\n    public Task<TemplateDraft?> GetDraftAsync(Guid businessId, Guid draftId, CancellationToken ct = default)\n        => _db.TemplateDrafts.AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n\n    public async Task<IReadOnlyList<TemplateDraft>> ListDraftsAsync(Guid businessId, CancellationToken ct = default)\n    {\n        var list = await _db.TemplateDrafts.AsNoTracking()\n            .Where(x => x.BusinessId == businessId)\n            .OrderByDescending(x => x.UpdatedAt)\n            .ThenByDescending(x => x.CreatedAt)\n            .ToListAsync(ct);\n\n        return list;\n    }\n\n    private static T? SafeDeserialize<T>(string? json)\n    {\n        if (string.IsNullOrWhiteSpace(json)) return default;\n        try { return JsonSerializer.Deserialize<T>(json!, JsonOpts); } catch { return default; }\n    }\n\n    public async Task<bool> SetHeaderHandleAsync(\n    Guid businessId,\n    Guid draftId,\n    string language,\n    string mediaType,\n    string assetHandle,\n    CancellationToken ct = default)\n    {\n        var draft = await _db.TemplateDrafts\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (draft is null) return false;\n\n        var lang = language.Trim();\n        var variant = await _db.TemplateDraftVariants\n            .FirstOrDefaultAsync(v => v.TemplateDraftId == draft.Id && v.Language == lang, ct);\n\n        if (variant is null)\n        {\n            // create the variant if it doesn't exist yet (handy UX)\n            variant = new TemplateDraftVariant\n            {\n                Id = Guid.NewGuid(),\n                TemplateDraftId = draft.Id,\n                Language = lang,\n                BodyText = string.Empty,\n                HeaderType = mediaType.ToUpperInvariant(),\n                HeaderText = null,\n                HeaderMediaLocalUrl = $\"handle:{assetHandle}\",\n                FooterText = null,\n                ButtonsJson = \"[]\",\n                ExampleParamsJson = \"{}\",\n                IsReadyForSubmission = false,\n                ValidationErrorsJson = null\n            };\n            _db.TemplateDraftVariants.Add(variant);\n        }\n        else\n        {\n            variant.HeaderType = mediaType.ToUpperInvariant(); // IMAGE|VIDEO|DOCUMENT\n            variant.HeaderMediaLocalUrl = $\"handle:{assetHandle}\";\n            // don't force IsReadyForSubmission here; Validate/Submit will compute it\n        }\n\n        draft.UpdatedAt = DateTime.UtcNow;\n        await _db.SaveChangesAsync(ct);\n        return true;\n    }\n    // xbytechat-api/Features/TemplateModule/Services/TemplateDraftService.cs\n    // (inside the class; no local SafeDeserialize here — reuse your existing one)\n\n\n    public async Task<TemplatePreviewDto?> GetPreviewAsync(\n        Guid businessId, Guid draftId, string language, CancellationToken ct = default)\n    {\n        var draft = await _db.TemplateDrafts\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (draft is null) return null;\n\n        var variant = await _db.TemplateDraftVariants\n            .AsNoTracking()\n            .FirstOrDefaultAsync(v => v.TemplateDraftId == draft.Id && v.Language == language, ct);\n        if (variant is null) return null;\n\n        // Reuse your existing SafeDeserialize<T>(json, JsonOpts)\n        var buttons = SafeDeserialize<List<ButtonDto>>(variant.ButtonsJson) ?? new();\n        var examples = SafeDeserialize<Dictionary<string, string>>(variant.ExampleParamsJson) ?? new();\n\n        // Preview: no binary fetch; just mark media header types\n        string? headerHandleOrNull = null;\n\n        var (components, examplesPayload) = MetaComponentsBuilder.Build(\n            variant.HeaderType,\n            variant.HeaderText,\n            headerHandleOrNull,\n            variant.BodyText,\n            variant.FooterText,\n            buttons,\n            examples\n        );\n\n        string ResolveVars(string s)\n        {\n            if (string.IsNullOrEmpty(s)) return string.Empty;\n            var result = s;\n            foreach (var kv in examples)\n                result = result.Replace(\"{{\" + kv.Key + \"}}\", kv.Value ?? string.Empty, StringComparison.Ordinal);\n            return result;\n        }\n\n        string headerPreview = variant.HeaderType?.ToUpperInvariant() switch\n        {\n            \"TEXT\" => ResolveVars(variant.HeaderText ?? string.Empty),\n            \"IMAGE\" => \"[IMAGE HEADER]\",\n            \"VIDEO\" => \"[VIDEO HEADER]\",\n            \"DOCUMENT\" => \"[DOCUMENT HEADER]\",\n            _ => string.Empty\n        };\n\n        var buttonLabels = new List<string>();\n        foreach (var b in buttons)\n        {\n            if (string.Equals(b.Type, \"QUICK_REPLY\", StringComparison.OrdinalIgnoreCase))\n                buttonLabels.Add($\"[Quick Reply] {b.Text}\");\n            else if (string.Equals(b.Type, \"URL\", StringComparison.OrdinalIgnoreCase))\n                buttonLabels.Add($\"[URL] {b.Text}\");\n            else if (string.Equals(b.Type, \"PHONE\", StringComparison.OrdinalIgnoreCase))\n                buttonLabels.Add($\"[Phone] {b.Text}\");\n        }\n\n        return new TemplatePreviewDto\n        {\n            Language = language,\n            Header = headerPreview,\n            Body = ResolveVars(variant.BodyText ?? string.Empty),\n            Footer = ResolveVars(variant.FooterText ?? string.Empty),\n            Buttons = buttonLabels,\n            ComponentsPayload = components,\n            ExamplesPayload = examplesPayload\n        };\n    }\n\n    // Keep your SafeDeserialize helper in this class:\n\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateLibraryService.cs",
      "sha256": "d4a3ed47d7007a941610dc2049ce2ce65fc856babfe6ecea30305520ce51f1b6",
      "language": "csharp",
      "size": 21431,
      "content": "using System.Text.Json;\nusing System.Text.RegularExpressions;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Models;\nusing System.Text.Json;\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class TemplateLibraryService : ITemplateLibraryService\n{\n    private readonly AppDbContext _db;\n    private static readonly JsonSerializerOptions JsonOpts = new(JsonSerializerDefaults.Web);\n\n    public TemplateLibraryService(AppDbContext db)\n    {\n        _db = db;\n    }\n\n    public async Task<IReadOnlyList<TemplateLibraryItem>> ListAsync(string? industry, CancellationToken ct = default)\n    {\n        var q = _db.TemplateLibraryItems.AsNoTracking();\n        if (!string.IsNullOrWhiteSpace(industry))\n        {\n            var ind = industry.Trim().ToUpperInvariant();\n            q = q.Where(x => x.Industry == ind);\n        }\n\n        return await q\n            .OrderByDescending(x => x.IsFeatured)\n            .ThenBy(x => x.Industry)\n            .ThenBy(x => x.Key)\n            .ToListAsync(ct);\n    }\n\n    public async Task<TemplateDraft> InstantiateDraftAsync(\n      Guid businessId,\n      Guid libraryItemId,\n      IEnumerable<string> languages,\n      CancellationToken ct = default)\n    {\n        var item = await _db.TemplateLibraryItems\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == libraryItemId, ct);\n\n        if (item is null)\n            throw new KeyNotFoundException(\"Library item not found.\");\n\n        // ---- Normalize incoming languages ----\n        var requested = (languages ?? Array.Empty<string>())\n            .Where(l => !string.IsNullOrWhiteSpace(l))\n            .Select(l => l.Trim())\n            .ToArray();\n\n        // Load all variants for this item once\n        var allLibVariants = await _db.TemplateLibraryVariants\n            .AsNoTracking()\n            .Where(v => v.LibraryItemId == item.Id)\n            .ToListAsync(ct);\n\n        if (allLibVariants.Count == 0)\n            throw new InvalidOperationException(\"Selected library item has no language variants.\");\n\n        // If \"ALL\" is requested (case-insensitive), use all languages available\n        bool wantsAll = requested.Any(l => string.Equals(l, \"ALL\", StringComparison.OrdinalIgnoreCase));\n        var targetLangs = wantsAll\n            ? allLibVariants.Select(v => v.Language).Distinct(StringComparer.OrdinalIgnoreCase).ToArray()\n            : requested;\n\n        // Validate: ensure at least one requested language exists\n        var availableLangs = new HashSet<string>(\n            allLibVariants.Select(v => v.Language),\n            StringComparer.OrdinalIgnoreCase);\n\n        var matchedLangs = targetLangs.Where(l => availableLangs.Contains(l)).Distinct(StringComparer.OrdinalIgnoreCase).ToArray();\n\n        if (matchedLangs.Length == 0)\n            throw new InvalidOperationException(\n                $\"None of the requested languages exist for this template. \" +\n                $\"Requested: [{string.Join(\", \", targetLangs)}]; \" +\n                $\"Available: [{string.Join(\", \", availableLangs)}]\");\n\n        // ---- Make a unique key for the business if needed ----\n        var key = item.Key;\n        var suffix = 1;\n        while (await _db.TemplateDrafts.AnyAsync(x => x.BusinessId == businessId && x.Key == key, ct))\n        {\n            suffix++;\n            key = $\"{item.Key}_{suffix}\";\n        }\n\n        // ---- Create draft ----\n        var defaultLang = matchedLangs[0];\n        var draft = new TemplateDraft\n        {\n            Id = Guid.NewGuid(),\n            BusinessId = businessId,\n            Key = key,\n            Category = item.Category,\n            DefaultLanguage = defaultLang,\n            CreatedAt = DateTime.UtcNow,\n            UpdatedAt = DateTime.UtcNow\n        };\n        _db.TemplateDrafts.Add(draft);\n\n        // ---- Clone only the matched languages ----\n        var libVariants = allLibVariants\n            .Where(v => matchedLangs.Contains(v.Language, StringComparer.OrdinalIgnoreCase))\n            .ToList();\n\n        foreach (var lv in libVariants)\n        {\n            var variant = new TemplateDraftVariant\n            {\n                Id = Guid.NewGuid(),\n                TemplateDraftId = draft.Id,\n                Language = lv.Language,\n                BodyText = lv.BodyText,\n                HeaderType = lv.HeaderType,\n                HeaderText = lv.HeaderText,\n                HeaderMediaLocalUrl = null,         // Library media is preview-only; users upload their own\n                FooterText = lv.FooterText,\n                ButtonsJson = lv.ButtonsJson ?? \"[]\",\n                // IMPORTANT: examples are a map/object -> \"{}\" by default\n                ExampleParamsJson = lv.ExampleParamsJson ?? \"{}\",\n                IsReadyForSubmission = true,\n                ValidationErrorsJson = null\n            };\n            _db.TemplateDraftVariants.Add(variant);\n        }\n\n        await _db.SaveChangesAsync(ct);\n        return draft;\n    }\n\n    public async Task<(TemplateLibraryItem item, List<TemplateLibraryVariant> variants)> GetItemAsync(\n    Guid libraryItemId,\n    CancellationToken ct = default)\n    {\n        var item = await _db.TemplateLibraryItems\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == libraryItemId, ct);\n\n        if (item is null)\n            throw new KeyNotFoundException(\"Library item not found.\");\n\n        var variants = await _db.TemplateLibraryVariants\n            .AsNoTracking()\n            .Where(v => v.LibraryItemId == item.Id)\n            .OrderBy(v => v.Language)\n            .ToListAsync(ct);\n\n        return (item, variants);\n    }\n    public async Task<IReadOnlyList<string>> ListIndustriesAsync(CancellationToken ct = default)\n    {\n        var raw = await _db.TemplateLibraryItems\n            .AsNoTracking()\n            .Select(x => x.Industry)\n            .Where(x => x != null && x != \"\")\n            .ToListAsync(ct);\n\n        // Normalize to upper (your storage uses UPPER), then distinct & sort for UX\n        var set = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n        foreach (var s in raw)\n        {\n            var v = s!.Trim();\n            if (v.Length == 0) continue;\n            set.Add(v.ToUpperInvariant());\n        }\n        return set.OrderBy(x => x).ToList();\n    }\n    //public async Task<LibraryImportResult> ImportAsync(LibraryImportRequest request, CancellationToken ct = default)\n    public async Task<LibraryImportResult> ImportAsync(LibraryImportRequest request, bool dryRun = false, CancellationToken ct = default)\n    {\n        var res = new LibraryImportResult();\n        if (request?.Items == null || request.Items.Count == 0)\n        {\n            res.Success = true;\n            return res;\n        }\n\n        // reasonable safety cap; adjust if needed\n        if (request.Items.Count > 1000)\n            throw new InvalidOperationException(\"Too many items in one import. Split into smaller batches (≤1000).\");\n\n        using var tx = await _db.Database.BeginTransactionAsync(ct);\n\n        var jsonOpts = new JsonSerializerOptions(JsonSerializerDefaults.Web) { WriteIndented = false };\n\n        string NormalizeCategory(string cat)\n        {\n            var c = (cat ?? \"\").Trim().ToUpperInvariant();\n            return c switch\n            {\n                \"UTILITY\" or \"MARKETING\" or \"AUTHENTICATION\" => c,\n                _ => throw new InvalidOperationException(\"category must be one of UTILITY, MARKETING, AUTHENTICATION\")\n            };\n        }\n\n        string NormalizeHeaderType(string? ht)\n        {\n            var t = (ht ?? \"NONE\").Trim().ToUpperInvariant();\n            return t switch\n            {\n                \"NONE\" or \"TEXT\" or \"IMAGE\" or \"VIDEO\" or \"DOCUMENT\" => t,\n                _ => throw new InvalidOperationException(\"headerType must be NONE|TEXT|IMAGE|VIDEO|DOCUMENT\")\n            };\n        }\n\n        string ButtonsToJson(List<LibraryImportButton> buttons)\n        {\n            // light validation: max 3; text required; type-specific fields\n            if (buttons is { Count: > 3 })\n                throw new InvalidOperationException(\"A variant cannot have more than 3 buttons.\");\n\n            foreach (var b in buttons)\n            {\n                if (string.IsNullOrWhiteSpace(b.Type)) throw new InvalidOperationException(\"button.type is required.\");\n                if (string.IsNullOrWhiteSpace(b.Text)) throw new InvalidOperationException(\"button.text is required.\");\n\n                var t = b.Type.Trim().ToUpperInvariant();\n                if (t == \"URL\" && string.IsNullOrWhiteSpace(b.Url))\n                    throw new InvalidOperationException(\"URL button requires url.\");\n                if (t == \"PHONE\" && string.IsNullOrWhiteSpace(b.Phone))\n                    throw new InvalidOperationException(\"PHONE button requires phone.\");\n            }\n\n            return JsonSerializer.Serialize(buttons ?? new(), jsonOpts);\n        }\n\n        string ExamplesToJson(Dictionary<string, string>? map)\n            => JsonSerializer.Serialize(map ?? new Dictionary<string, string>(), jsonOpts); // {} default\n\n        for (int i = 0; i < request.Items.Count; i++)\n        {\n            var raw = request.Items[i];\n            try\n            {\n                // ---- normalize + validate item ----\n                var industry = (raw.Industry ?? \"\").Trim().ToUpperInvariant();\n                if (string.IsNullOrWhiteSpace(industry)) throw new InvalidOperationException(\"industry is required.\");\n\n                var key = (raw.Key ?? \"\").Trim();\n                if (string.IsNullOrWhiteSpace(key)) throw new InvalidOperationException(\"key is required.\");\n\n                var category = NormalizeCategory(raw.Category);\n\n                if (raw.Variants == null || raw.Variants.Count == 0)\n                    throw new InvalidOperationException(\"at least one variant is required.\");\n\n                // ---- upsert item by (Industry, Key) ----\n                var item = await _db.TemplateLibraryItems\n                    .FirstOrDefaultAsync(x => x.Industry == industry && x.Key == key, ct);\n\n                if (item == null)\n                {\n                    item = new TemplateLibraryItem\n                    {\n                        Id = Guid.NewGuid(),\n                        Industry = industry,\n                        Key = key,\n                        Category = category,\n                        IsFeatured = raw.IsFeatured\n                    };\n                    _db.TemplateLibraryItems.Add(item);\n                    res.CreatedItems++;\n                    await _db.SaveChangesAsync(ct); // ensure item.Id for variants\n                }\n                else\n                {\n                    // update mutable fields\n                    item.Category = category;\n                    item.IsFeatured = raw.IsFeatured;\n                    res.UpdatedItems++;\n                    await _db.SaveChangesAsync(ct);\n                }\n\n                // ---- per-variant upsert by (LibraryItemId, Language) ----\n                for (int v = 0; v < raw.Variants.Count; v++)\n                {\n                    var vv = raw.Variants[v];\n\n                    var lang = (vv.Language ?? \"\").Trim();\n                    if (string.IsNullOrWhiteSpace(lang))\n                        throw new InvalidOperationException(\"variant.language is required.\");\n\n                    var headerType = NormalizeHeaderType(vv.HeaderType);\n                    var bodyText = (vv.BodyText ?? \"\").Trim();\n                    if (string.IsNullOrWhiteSpace(bodyText))\n                        throw new InvalidOperationException(\"variant.bodyText is required.\");\n\n                    if (headerType == \"TEXT\" && string.IsNullOrWhiteSpace(vv.HeaderText))\n                        throw new InvalidOperationException(\"headerText is required when headerType=TEXT.\");\n\n                    var buttonsJson = ButtonsToJson(vv.Buttons ?? new());\n                    var examplesJson = ExamplesToJson(vv.Examples);\n\n                    var existing = await _db.TemplateLibraryVariants\n                        .FirstOrDefaultAsync(x => x.LibraryItemId == item.Id && x.Language == lang, ct);\n\n                    if (existing == null)\n                    {\n                        _db.TemplateLibraryVariants.Add(new TemplateLibraryVariant\n                        {\n                            Id = Guid.NewGuid(),\n                            LibraryItemId = item.Id,\n                            Language = lang,\n                            HeaderType = headerType,\n                            HeaderText = vv.HeaderText,\n                            BodyText = bodyText,\n                            FooterText = vv.FooterText,\n                            ButtonsJson = buttonsJson,\n                            ExampleParamsJson = examplesJson\n                        });\n                        res.CreatedVariants++;\n                    }\n                    else\n                    {\n                        existing.HeaderType = headerType;\n                        existing.HeaderText = vv.HeaderText;\n                        existing.BodyText = bodyText;\n                        existing.FooterText = vv.FooterText;\n                        existing.ButtonsJson = buttonsJson;\n                        existing.ExampleParamsJson = examplesJson;\n                        res.UpdatedVariants++;\n                    }\n                }\n            }\n            catch (Exception ex)\n            {\n                res.Errors.Add(new LibraryImportError\n                {\n                    ItemIndex = i,\n                    Message = ex.Message\n                });\n            }\n        }\n\n        //await _db.SaveChangesAsync(ct);\n        //await tx.CommitAsync(ct);\n        await _db.SaveChangesAsync(ct);\n        if (dryRun)\n        {\n            // Undo all writes made within this transaction\n            await tx.RollbackAsync(ct);\n        }\n        else\n        {\n            await tx.CommitAsync(ct);\n        }\n        res.TotalItems = request.Items.Count;\n        res.Success = res.Errors.Count == 0;\n        return res;\n    }\n\n    public async Task<TemplateLibraryListResponse> SearchAsync(\n    string? industry, string? q, string? sort, int page, int pageSize, CancellationToken ct = default)\n    {\n        page = page <= 0 ? 1 : page;\n        pageSize = pageSize <= 0 ? 20 : Math.Min(pageSize, 100);\n\n        var query = _db.TemplateLibraryItems.AsNoTracking().AsQueryable();\n\n        if (!string.IsNullOrWhiteSpace(industry))\n        {\n            var ind = industry.Trim().ToUpperInvariant();\n            query = query.Where(x => x.Industry == ind);\n        }\n\n        if (!string.IsNullOrWhiteSpace(q))\n        {\n            var tq = q.Trim();\n            query = query.Where(x =>\n                x.Key.Contains(tq) ||\n                x.Category.Contains(tq) ||\n                x.Industry.Contains(tq));\n        }\n\n        // Sorting\n        sort = (sort ?? \"featured\").ToLowerInvariant();\n        query = sort switch\n        {\n            \"name\" => query.OrderBy(x => x.Key).ThenBy(x => x.Industry),\n            \"featured\" => query.OrderByDescending(x => x.IsFeatured).ThenBy(x => x.Key),\n            _ => query.OrderByDescending(x => x.IsFeatured).ThenBy(x => x.Key)\n        };\n\n        var total = await query.CountAsync(ct);\n\n        var pageItems = await query\n            .Skip((page - 1) * pageSize)\n            .Take(pageSize)\n            .Select(x => new\n            {\n                x.Id,\n                x.Industry,\n                x.Key,\n                x.Category,\n                x.IsFeatured,\n                // representative variant: prefer en_US if present; otherwise first by language asc\n                Variant = _db.TemplateLibraryVariants\n                            .AsNoTracking()\n                            .Where(v => v.LibraryItemId == x.Id)\n                            .OrderByDescending(v => v.Language == \"en_US\")\n                            .ThenBy(v => v.Language)\n                            .Select(v => new { v.Language, v.HeaderType, v.BodyText, v.ButtonsJson })\n                            .FirstOrDefault()\n            })\n            .ToListAsync(ct);\n\n        var items = new List<TemplateLibraryListItemDto>(pageItems.Count);\n\n        foreach (var row in pageItems)\n        {\n            var lang = row.Variant?.Language ?? \"en_US\";\n            var headerType = row.Variant?.HeaderType ?? \"NONE\";\n            var body = row.Variant?.BodyText ?? \"\";\n\n            // Placeholder count in body {{n}}\n            var ph = Regex.Matches(body, @\"\\{\\{\\d+\\}\\}\").Count;\n\n            // Body preview (first 120 chars, one-line)\n            var preview = body.Replace(\"\\r\", \" \").Replace(\"\\n\", \" \");\n            if (preview.Length > 120) preview = preview.Substring(0, 120) + \"…\";\n\n            // Buttons summary from JSON (keep simple & resilient)\n            string btnSummary = \"\";\n            try\n            {\n                var rawJson = row.Variant?.ButtonsJson ?? \"[]\";\n                var btns = System.Text.Json.JsonSerializer.Deserialize<List<ButtonDto>>(rawJson)\n                           ?? new List<ButtonDto>();\n\n                if (btns.Count > 0)\n                {\n                    btnSummary = string.Join(\", \",\n                        btns.Select(b => (b.Type ?? \"\").ToUpperInvariant())\n                            .Distinct());\n                }\n            }\n            catch { /* ignore malformed buttons json */ }\n\n            items.Add(new TemplateLibraryListItemDto\n            {\n                Id = row.Id,\n                Industry = row.Industry,\n                Key = row.Key,\n                Category = row.Category,\n                IsFeatured = row.IsFeatured,\n                Language = lang,\n                HeaderType = headerType,\n                Placeholders = ph,\n                BodyPreview = preview,\n                ButtonsSummary = btnSummary\n            });\n        }\n\n        return new TemplateLibraryListResponse\n        {\n            Page = page,\n            PageSize = pageSize,\n            Total = total,\n            Items = items\n        };\n    }\n\n\n\n    public async Task<LibraryImportRequest> ExportAsync(string? industry, CancellationToken ct = default)\n    {\n        var request = new LibraryImportRequest();\n\n        var q = _db.TemplateLibraryItems.AsNoTracking();\n        if (!string.IsNullOrWhiteSpace(industry))\n        {\n            var ind = industry.Trim().ToUpperInvariant();\n            q = q.Where(x => x.Industry == ind);\n        }\n\n        var items = await q\n            .OrderByDescending(x => x.IsFeatured)\n            .ThenBy(x => x.Industry)\n            .ThenBy(x => x.Key)\n            .ToListAsync(ct);\n\n        if (items.Count == 0)\n            return request;\n\n        var variantsLookup = await _db.TemplateLibraryVariants\n            .AsNoTracking()\n            .Where(v => items.Select(i => i.Id).Contains(v.LibraryItemId))\n            .GroupBy(v => v.LibraryItemId)\n            .ToDictionaryAsync(g => g.Key, g => g.ToList(), ct);\n\n        foreach (var it in items)\n        {\n            variantsLookup.TryGetValue(it.Id, out var vs);\n            var dto = new LibraryImportItem\n            {\n                Industry = it.Industry,\n                Key = it.Key,\n                Category = it.Category,\n                IsFeatured = it.IsFeatured,\n                Variants = new List<LibraryImportVariant>()\n            };\n\n            if (vs != null)\n            {\n                foreach (var v in vs.OrderBy(v => v.Language))\n                {\n                    List<LibraryImportButton> buttons;\n                    try\n                    {\n                        buttons = string.IsNullOrWhiteSpace(v.ButtonsJson)\n                            ? new List<LibraryImportButton>()\n                            : System.Text.Json.JsonSerializer.Deserialize<List<LibraryImportButton>>(v.ButtonsJson)\n                              ?? new List<LibraryImportButton>();\n                    }\n                    catch\n                    {\n                        buttons = new List<LibraryImportButton>();\n                    }\n\n                    Dictionary<string, string>? examples;\n                    try\n                    {\n                        examples = string.IsNullOrWhiteSpace(v.ExampleParamsJson)\n                            ? new Dictionary<string, string>()\n                            : System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(v.ExampleParamsJson)\n                              ?? new Dictionary<string, string>();\n                    }\n                    catch\n                    {\n                        examples = new Dictionary<string, string>();\n                    }\n\n                    dto.Variants.Add(new LibraryImportVariant\n                    {\n                        Language = v.Language,\n                        HeaderType = v.HeaderType,\n                        HeaderText = v.HeaderText,\n                        BodyText = v.BodyText ?? string.Empty,\n                        FooterText = v.FooterText,\n                        Buttons = buttons,\n                        Examples = examples\n                    });\n                }\n            }\n\n            request.Items.Add(dto);\n        }\n\n        return request;\n    }\n\n}"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateNameCheckService.cs",
      "sha256": "37f8f1562eaa6dc29b4a1253c718db698bf8551a7ff052d12e8ca7d206e4a4ad",
      "language": "csharp",
      "size": 2906,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Models;\nusing xbytechat.api.Features.TemplateModule.Utils;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic interface ITemplateNameCheckService\n{\n    Task<TemplateNameCheckResponse?> CheckAsync(Guid businessId, Guid draftId, string language, CancellationToken ct = default);\n}\n\npublic sealed class TemplateNameCheckService : ITemplateNameCheckService\n{\n    private readonly AppDbContext _db;\n\n    public TemplateNameCheckService(AppDbContext db) => _db = db;\n\n    public async Task<TemplateNameCheckResponse?> CheckAsync(Guid businessId, Guid draftId, string language, CancellationToken ct = default)\n    {\n        language = string.IsNullOrWhiteSpace(language) ? \"en_US\" : language;\n\n        var draft = await _db.TemplateDrafts\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n\n        if (draft is null) return null;\n\n        // Compute the Meta template name we use during Submit\n        var baseName = MetaNameHelper.FromKey(draft.Key, businessId, MetaNameHelper.ShortBizSuffix(businessId));\n\n        var available = !await ExistsAsync(businessId, baseName, language, ct);\n        if (available)\n        {\n            return new TemplateNameCheckResponse\n            {\n                DraftId = draft.Id,\n                Language = language,\n                Name = baseName,\n                Available = true,\n                Suggestion = null\n            };\n        }\n\n        // Find first available suggestion by appending _2, _3, ...\n        var suggestion = await FirstAvailableAsync(businessId, baseName, language, ct);\n\n        return new TemplateNameCheckResponse\n        {\n            DraftId = draft.Id,\n            Language = language,\n            Name = baseName,\n            Available = false,\n            Suggestion = suggestion\n        };\n    }\n\n    private Task<bool> ExistsAsync(Guid businessId, string name, string language, CancellationToken ct)\n        => _db.WhatsAppTemplates.AsNoTracking()\n            .AnyAsync(t => t.BusinessId == businessId\n                        && t.Name == name\n                        && t.LanguageCode == language, ct);\n\n    private async Task<string> FirstAvailableAsync(Guid businessId, string baseName, string language, CancellationToken ct)\n    {\n        // avoid unbounded loops; Meta’s name limit is generous, but we keep it sane\n        for (int i = 2; i <= 1000; i++)\n        {\n            var candidate = $\"{baseName}_{i}\";\n            var exists = await ExistsAsync(businessId, candidate, language, ct);\n            if (!exists)\n                return candidate;\n        }\n        // fallback: add random short suffix\n        return $\"{baseName}_{Guid.NewGuid():N}\".Substring(0, Math.Min(baseName.Length + 9, 50));\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateStatusService.cs",
      "sha256": "bbfb0a6d1dc9bf2c148231c85459999c68d7956b8095da9a36d804716cf10fc4",
      "language": "csharp",
      "size": 1518,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.Utils;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class TemplateStatusService : ITemplateStatusService\n{\n    private readonly AppDbContext _db;\n\n    public TemplateStatusService(AppDbContext db)\n    {\n        _db = db;\n    }\n\n    public async Task<(string metaName, IReadOnlyList<TemplateStatusItemDto> items)> GetStatusAsync(\n        Guid businessId, Guid draftId, CancellationToken ct = default)\n    {\n        // Load draft (to get Key for Meta name derivation)\n        var draft = await _db.TemplateDrafts\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n\n        if (draft is null)\n            throw new KeyNotFoundException(\"Draft not found.\");\n\n        var name = MetaNameHelper.FromKey(draft.Key, businessId, MetaNameHelper.ShortBizSuffix(businessId));\n\n        // Query your SoT table\n        var rows = await _db.WhatsAppTemplates\n            .AsNoTracking()\n            .Where(t => t.BusinessId == businessId && t.Name == name)\n            .OrderBy(t => t.LanguageCode)\n            .Select(t => new TemplateStatusItemDto(\n                t.LanguageCode,\n                t.Status ?? string.Empty,\n                t.TemplateId,\n                t.UpdatedAt,\n                t.LastSyncedAt\n            ))\n            .ToListAsync(ct);\n\n        return (name, rows);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/TemplateSubmissionService.cs",
      "sha256": "6e9b65e65657759dddf3bc883deeaf9a7ca313887f62894226b939bd38ce0f39",
      "language": "csharp",
      "size": 6549,
      "content": "using System.Text.Json;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.TemplateModule.Abstractions;\nusing xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Payload;\nusing xbytechat.api.Features.TemplateModule.Utils;\nusing xbytechat.api.Features.TemplateModule.Validators;\nusing xbytechat.api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.Features.TemplateModule.Services;\n\npublic sealed class TemplateSubmissionService : ITemplateSubmissionService\n{\n    private readonly AppDbContext _db;\n    private readonly IMetaTemplateClient _meta;\n    private readonly ITemplateSyncService _templateSyncService;\n    public TemplateSubmissionService(AppDbContext db, IMetaTemplateClient meta, ITemplateSyncService templateSyncService)\n    {\n        _db = db;\n        _meta = meta;\n        _templateSyncService = templateSyncService;\n        \n    }\n\n    public async Task<TemplateSubmitResponseDto> SubmitAsync(Guid businessId, Guid draftId, CancellationToken ct = default)\n    {\n        // 1) Load draft + variants\n        var draft = await _db.TemplateDrafts\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.Id == draftId && x.BusinessId == businessId, ct);\n        if (draft is null)\n            return new TemplateSubmitResponseDto { Success = false, Message = \"Draft not found.\" };\n\n        var variants = await _db.TemplateDraftVariants\n            .AsNoTracking()\n            .Where(v => v.TemplateDraftId == draft.Id)\n            .ToListAsync(ct);\n        if (variants.Count == 0)\n            return new TemplateSubmitResponseDto { Success = false, Message = \"No language variants to submit.\" };\n\n        // 2) Validate cross-language parity\n        var views = variants.Select(v => new MultiLanguageValidator.VariantView\n        {\n            Language = v.Language,\n            BodyText = v.BodyText,\n            HeaderType = v.HeaderType,\n            HeaderText = v.HeaderText,\n            HeaderMediaLocalUrl = v.HeaderMediaLocalUrl,\n            FooterText = v.FooterText,\n            Buttons = SafeDeserialize<List<ButtonDto>>(v.ButtonsJson) ?? new(),\n            Examples = SafeDeserialize<Dictionary<string, string>>(v.ExampleParamsJson) ?? new()\n        }).ToList();\n\n        var (ok, errors) = MultiLanguageValidator.Validate(views);\n        if (!ok)\n        {\n            var errMsg = string.Join(\" | \", errors.Select(kv => $\"{kv.Key}: {string.Join(\" ; \", kv.Value)}\"));\n            return new TemplateSubmitResponseDto\n            {\n                Success = false,\n                Message = \"Validation failed before submission.\",\n                Variants = variants.Select(v => new SubmittedVariantResult\n                {\n                    Language = v.Language,\n                    Status = errors.ContainsKey(v.Language) ? \"INVALID\" : \"READY\",\n                    RejectionReason = errors.ContainsKey(v.Language) ? string.Join(\" ; \", errors[v.Language]) : null\n                }).ToList()\n            };\n        }\n\n        // 3) Derive Meta template name from Key (+ short biz suffix for safety)\n        var name = MetaNameHelper.FromKey(draft.Key, businessId, MetaNameHelper.ShortBizSuffix(businessId));\n\n        // 4) Submit per language\n        var results = new List<SubmittedVariantResult>();\n        foreach (var v in variants)\n        {\n            var buttons = SafeDeserialize<List<ButtonDto>>(v.ButtonsJson) ?? new();\n            var examples = SafeDeserialize<Dictionary<string, string>>(v.ExampleParamsJson) ?? new();\n\n            // For media headers, HeaderMediaLocalUrl must be uploaded before CreateTemplate\n            string? headerMetaId = null;\n            if (!v.HeaderType.Equals(\"NONE\", StringComparison.OrdinalIgnoreCase) &&\n                !v.HeaderType.Equals(\"TEXT\", StringComparison.OrdinalIgnoreCase))\n            {\n                if (string.IsNullOrWhiteSpace(v.HeaderMediaLocalUrl))\n                {\n                    results.Add(new SubmittedVariantResult\n                    {\n                        Language = v.Language,\n                        Status = \"FAILED\",\n                        RejectionReason = \"Missing media for header.\"\n                    });\n                    continue;\n                }\n                headerMetaId = await _meta.UploadMediaAsync(businessId, v.HeaderMediaLocalUrl!, v.HeaderType, ct);\n            }\n\n            var (components, examplePayload) =\n                MetaComponentsBuilder.Build(v.HeaderType, v.HeaderText, headerMetaId, v.BodyText, v.FooterText, buttons, examples);\n\n            var created = await _meta.CreateTemplateAsync(\n                businessId: businessId,\n                name: name,\n                category: draft.Category,\n                language: v.Language,\n                componentsPayload: components,\n                examplesPayload: examplePayload,\n                ct: ct\n            );\n\n            results.Add(new SubmittedVariantResult\n            {\n                Language = v.Language,\n                Status = created ? \"PENDING\" : \"FAILED\",\n                RejectionReason = created ? null : \"Meta create call failed.\"\n            });\n        }\n\n        var success = results.All(r => r.Status == \"PENDING\");\n\n        // 🔄 Auto-sync only if every language submitted OK\n        if (success)\n        {\n            try\n            {\n                // Force = true (ignore TTL), onlyUpsert = true (don’t deactivate others)\n                await _templateSyncService.SyncBusinessTemplatesAsync(businessId, force: true, onlyUpsert: true, ct);\n            }\n            catch (Exception ex)\n            {\n                // Non-fatal: submission succeeded; sync can be retried via existing endpoint\n                Console.WriteLine($\"[Template Submit] Sync warning: {ex.Message}\");\n            }\n        }\n\n        return new TemplateSubmitResponseDto\n        {\n            Success = success,\n            Message = success ? \"Submitted to Meta. Awaiting review.\" : \"Submitted with some failures.\",\n            Variants = results\n        };\n    }\n\n    public Task<int> SyncStatusAsync(Guid businessId, CancellationToken ct = default)\n    {\n        // Placeholder: in a later step we’ll call provider ListTemplates and update your WhatsAppTemplates via your existing sync flow.\n        return Task.FromResult(0);\n    }\n\n    private static T? SafeDeserialize<T>(string? json)\n    {\n        if (string.IsNullOrWhiteSpace(json)) return default;\n        try { return JsonSerializer.Deserialize<T>(json!); } catch { return default; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Services/WhatsAppTemplateService.cs",
      "sha256": "ee70376834e701f63425a69d50a4ea5d02170321edf828fe7fd2bd5d100bf3a1",
      "language": "csharp",
      "size": 2815,
      "content": "using Microsoft.Extensions.Configuration;\nusing Newtonsoft.Json;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Services\n{\n    public class WhatsAppTemplateService : IWhatsAppTemplateService\n    {\n        private readonly HttpClient _httpClient;\n        private readonly IConfiguration _config;\n        private readonly ILogger<WhatsAppTemplateService> _logger;\n\n        public WhatsAppTemplateService(HttpClient httpClient, IConfiguration config, ILogger<WhatsAppTemplateService> logger)\n        {\n            _httpClient = httpClient;\n            _config = config;\n            _logger = logger;\n        }\n\n        public async Task<List<TemplateMetadataDto>> FetchTemplatesAsync()\n        {\n            var wabaId = _config[\"WhatsApp:WABA_ID\"];\n            var token = _config[\"WhatsApp:apiToken\"];\n            var url = $\"https://graph.facebook.com/v18.0/{wabaId}/message_templates\";\n\n            var templates = new List<TemplateMetadataDto>();\n\n            try\n            {\n                _httpClient.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue(\"Bearer\", token);\n                var response = await _httpClient.GetAsync(url);\n                var json = await response.Content.ReadAsStringAsync();\n\n                if (!response.IsSuccessStatusCode)\n                {\n                    _logger.LogError(\"Failed to fetch WhatsApp templates: \" + json);\n                    return templates;\n                }\n\n                var parsed = JsonConvert.DeserializeObject<dynamic>(json);\n\n                foreach (var tpl in parsed.data)\n                {\n                    string name = tpl.name;\n                    string language = tpl.language ?? \"en_US\";\n                    string body = \"\";\n\n                    foreach (var component in tpl.components)\n                    {\n                        if (component.type == \"BODY\")\n                        {\n                            body = component.text;\n                            break;\n                        }\n                    }\n\n                    // Count {{placeholders}}\n                    var placeholderCount = System.Text.RegularExpressions.Regex.Matches(body, \"{{(.*?)}}\").Count;\n\n                    templates.Add(new TemplateMetadataDto\n                    {\n                        Name = name,\n                        Language = language,\n                        Body = body,\n                        PlaceholderCount = placeholderCount\n                    });\n                }\n\n                return templates;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(\"Error while fetching templates from Meta: \" + ex.Message);\n                return templates;\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Utils/MetaNameHelper.cs",
      "sha256": "49bc1bb7e8945412aae2987bb0f6c7c539131cfa1b3db78cf43132431775b7cf",
      "language": "csharp",
      "size": 1237,
      "content": "using System.Text;\nusing System.Text.RegularExpressions;\n\nnamespace xbytechat.api.Features.TemplateModule.Utils;\n\npublic static class MetaNameHelper\n{\n    // WhatsApp template name rules: lowercase, underscores, alnum and _ only, <= 25 chars.\n    private static readonly Regex Allowed = new(@\"[^a-z0-9_]+\", RegexOptions.Compiled);\n\n    public static string FromKey(string key, Guid businessId, string? suffix = null)\n    {\n        // 1) lower + underscores\n        var s = key.Trim().ToLowerInvariant()\n            .Replace(' ', '_')\n            .Replace('-', '_');\n\n        // 2) strip invalids\n        s = Allowed.Replace(s, \"\");\n\n        // 3) ensure starts with a letter\n        if (s.Length == 0 || !char.IsLetter(s[0]))\n            s = \"t_\" + s;\n\n        // 4) add optional suffix for uniqueness (e.g., short biz hash)\n        if (!string.IsNullOrWhiteSpace(suffix))\n            s = $\"{s}_{suffix}\".TrimEnd('_');\n\n        // 5) cap length 25 (WA limit)\n        if (s.Length > 25) s = s[..25];\n\n        // fallback safety\n        if (string.IsNullOrWhiteSpace(s)) s = \"t_\" + businessId.ToString(\"N\")[..6];\n        return s;\n    }\n\n    public static string ShortBizSuffix(Guid businessId)\n        => businessId.ToString(\"N\")[..6];\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/MultiLanguageValidator.cs",
      "sha256": "127b69bcf7da20b98dfa5ed636ade2a7858c176a770b5f32827e7d5f94774b76",
      "language": "csharp",
      "size": 3021,
      "content": "using System.Text.Json;\nusing xbytechat.api.Features.TemplateModule.Validation;\nusing xbytechat.api.Features.TemplateModule.DTOs;\n\nnamespace xbytechat.api.Features.TemplateModule.Validators;\n\npublic static class MultiLanguageValidator\n{\n    public sealed class VariantView\n    {\n        public required string Language { get; init; }\n        public required string BodyText { get; init; }\n        public required string HeaderType { get; init; }\n        public string? HeaderText { get; init; }\n        public string? HeaderMediaLocalUrl { get; init; }\n        public string? FooterText { get; init; }\n        public required List<ButtonDto> Buttons { get; init; }\n        public required Dictionary<string, string> Examples { get; init; }\n    }\n\n    public static (bool ok, Dictionary<string, List<string>> errors) Validate(IReadOnlyList<VariantView> variants)\n    {\n        var errors = new Dictionary<string, List<string>>(StringComparer.OrdinalIgnoreCase);\n        bool OkLang(string lang) => !errors.ContainsKey(lang) || errors[lang].Count == 0;\n        void Add(string lang, string msg)\n        {\n            if (!errors.TryGetValue(lang, out var list)) { list = new(); errors[lang] = list; }\n            list.Add(msg);\n        }\n\n        // 1) Per-variant rules (reuse VariantValidator)\n        foreach (var v in variants)\n        {\n            var dto = new TemplateDraftVariantUpsertDto\n            {\n                Language = v.Language,\n                BodyText = v.BodyText,\n                HeaderType = v.HeaderType,\n                HeaderText = v.HeaderText,\n                HeaderMediaLocalUrl = v.HeaderMediaLocalUrl,\n                FooterText = v.FooterText,\n                Buttons = v.Buttons,\n                Examples = v.Examples\n            };\n            var r = VariantValidator.Validate(dto);\n            foreach (var e in r.Errors) Add(v.Language, e);\n        }\n\n        // 2) Cross-language placeholder arity/order parity\n        if (variants.Count > 1)\n        {\n            var reference = variants[0];\n            var refSlots = PlaceholderHelper.ExtractSlots(reference.BodyText);\n            var refSet = refSlots.ToHashSet();\n\n            foreach (var v in variants.Skip(1))\n            {\n                var slots = PlaceholderHelper.ExtractSlots(v.BodyText);\n                var set = slots.ToHashSet();\n\n                // arity parity\n                if (set.Count != refSet.Count)\n                    Add(v.Language, $\"Placeholder count mismatch vs {reference.Language}: expected {refSet.Count}, got {set.Count}.\");\n\n                // exact set parity (e.g., {1,2,3})\n                if (!set.SetEquals(refSet))\n                    Add(v.Language, $\"Placeholder indices mismatch vs {reference.Language}: expected {{{string.Join(\",\", refSet.OrderBy(x => x))}}}.\");\n\n                // continuity check already handled per-variant; this ensures cross-lang equality.\n            }\n        }\n\n        var ok = errors.Values.All(l => l.Count == 0);\n        return (ok, errors);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/PlaceholderHelper.cs",
      "sha256": "ed97ab0aeb570642914acf818213226b108002c5a37eff9b71b34f22f073ce08",
      "language": "csharp",
      "size": 1053,
      "content": "using System.Text.RegularExpressions;\n\nnamespace xbytechat.api.Features.TemplateModule.Validation;\n\npublic static class PlaceholderHelper\n{\n    private static readonly Regex PlaceholderRx = new(@\"\\{\\{(\\d+)\\}\\}\", RegexOptions.Compiled);\n\n    public static List<int> ExtractSlots(string? text)\n    {\n        var list = new List<int>();\n        if (string.IsNullOrEmpty(text)) return list;\n        foreach (Match m in PlaceholderRx.Matches(text))\n        {\n            if (int.TryParse(m.Groups[1].Value, out var n)) list.Add(n);\n        }\n        return list;\n    }\n\n    public static (bool ok, string? error) EnsureContinuousFrom1(IReadOnlyCollection<int> slots)\n    {\n        if (slots.Count == 0) return (true, null);\n        var max = slots.Max();\n        var set = slots.ToHashSet();\n        for (int i = 1; i <= max; i++)\n        {\n            if (!set.Contains(i)) return (false, $\"Missing placeholder {{${i}}} (placeholders must be continuous from {{1}}..{{{max}}}).\".Replace(\"${i}\", i.ToString()));\n        }\n        return (true, null);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/TemplateDraftValidator.cs",
      "sha256": "b4d9c66c1acf1fd12bcfbeee9c84987acfe2a106989552e8bd9b271e3dd4df3a",
      "language": "csharp",
      "size": 170,
      "content": "namespace xbytechat.api.Features.TemplateModule.Validators;\n\npublic sealed class TemplateDraftValidator\n{\n    // TODO: implement FluentValidation rules in a later step\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/TemplateDraftVariantValidator.cs",
      "sha256": "3b3c5e900711fd6a17344242b8f0e296a1e2b6f0fb1f6328718ecdf8752ec42e",
      "language": "csharp",
      "size": 196,
      "content": "namespace xbytechat.api.Features.TemplateModule.Validators;\n\npublic sealed class TemplateDraftVariantValidator\n{\n    // TODO: implement rules: placeholders, buttons, media, language codes, etc.\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/TemplateRules.cs",
      "sha256": "d9236e131fabd0663a6ecf28f3a63527085fdf86ccc19ce2f63f2584586b2308",
      "language": "csharp",
      "size": 1336,
      "content": "namespace xbytechat.api.Features.TemplateModule.Validation;\n\npublic static class TemplateRules\n{\n    public const int MaxTemplateName = 25;              // applies when we later derive Meta name from Key\n    public const int MaxButtons = 3;\n    public const int MaxQuickReplyText = 25;            // conservative; WA may allow ~20-25\n    public const int MaxHeaderText = 60;                // conservative header text length\n    public const int MaxFooterText = 60;                // conservative footer text length\n    public const int MaxBodyLength = 1024;              // safe upper bound for WA template body\n\n    public static readonly HashSet<string> AllowedHeaderTypes = new(StringComparer.OrdinalIgnoreCase)\n    { \"NONE\", \"TEXT\", \"IMAGE\", \"VIDEO\", \"DOCUMENT\" };\n\n    public static readonly HashSet<string> AllowedButtonTypes = new(StringComparer.OrdinalIgnoreCase)\n    { \"QUICK_REPLY\", \"URL\", \"PHONE\" };\n\n    public static bool IsValidPhone(string? phone)\n        => !string.IsNullOrWhiteSpace(phone) && phone!.Trim().Length >= 7 && phone.Trim().Length <= 20;\n\n    public static bool IsValidUrl(string? url)\n    {\n        if (string.IsNullOrWhiteSpace(url)) return false;\n        return Uri.TryCreate(url, UriKind.Absolute, out var u)\n               && (u.Scheme == Uri.UriSchemeHttps || u.Scheme == Uri.UriSchemeHttp);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/TemplatesModule/Validators/VariantValidator.cs",
      "sha256": "4f514844e6a284d23e1f43ea866642045024bc36180dd3d4bab8ade84684edf0",
      "language": "csharp",
      "size": 4688,
      "content": "using xbytechat.api.Features.TemplateModule.DTOs;\nusing xbytechat.api.Features.TemplateModule.Validation;\nusing xbytechat.api.Features.TemplatesModule.Language;\n\nnamespace xbytechat.api.Features.TemplateModule.Validators;\n\npublic static class VariantValidator\n{\n    public sealed class Result\n    {\n        public bool Ok => Errors.Count == 0;\n        public List<string> Errors { get; } = new();\n        public void Add(string msg) { if (!string.IsNullOrWhiteSpace(msg)) Errors.Add(msg); }\n    }\n\n    public static Result Validate(TemplateDraftVariantUpsertDto dto)\n    {\n        var r = new Result();\n\n        // language\n        if (!SupportedLanguages.IsSupported(dto.Language))\n            r.Add($\"Unsupported language: {dto.Language}\");\n\n        // body\n        if (string.IsNullOrWhiteSpace(dto.BodyText))\n            r.Add(\"BodyText is required.\");\n        else if (dto.BodyText.Length > TemplateRules.MaxBodyLength)\n            r.Add($\"BodyText too long (>{TemplateRules.MaxBodyLength}).\");\n\n        // placeholders\n        var slots = PlaceholderHelper.ExtractSlots(dto.BodyText);\n        var cont = PlaceholderHelper.EnsureContinuousFrom1(slots);\n        if (!cont.ok) r.Add(cont.error!);\n\n        // header\n        if (!TemplateRules.AllowedHeaderTypes.Contains(dto.HeaderType))\n            r.Add($\"HeaderType must be one of: {string.Join(\", \", TemplateRules.AllowedHeaderTypes)}\");\n\n        if (dto.HeaderType.Equals(\"TEXT\", StringComparison.OrdinalIgnoreCase))\n        {\n            if (string.IsNullOrWhiteSpace(dto.HeaderText))\n                r.Add(\"HeaderText required for TEXT header.\");\n            else if (dto.HeaderText.Length > TemplateRules.MaxHeaderText)\n                r.Add($\"HeaderText too long (>{TemplateRules.MaxHeaderText}).\");\n        }\n        else if (!dto.HeaderType.Equals(\"NONE\", StringComparison.OrdinalIgnoreCase))\n        {\n            // media header types\n            if (string.IsNullOrWhiteSpace(dto.HeaderMediaLocalUrl))\n                r.Add($\"HeaderMediaLocalUrl required for media header type {dto.HeaderType}.\");\n        }\n\n        // footer\n        if (!string.IsNullOrWhiteSpace(dto.FooterText) && dto.FooterText.Length > TemplateRules.MaxFooterText)\n            r.Add($\"FooterText too long (>{TemplateRules.MaxFooterText}).\");\n\n        // buttons\n        if (dto.Buttons is not null)\n        {\n            if (dto.Buttons.Count > TemplateRules.MaxButtons)\n                r.Add($\"At most {TemplateRules.MaxButtons} buttons are allowed.\");\n\n            int phoneCtas = 0;\n            var quickReplyTexts = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n\n            foreach (var b in dto.Buttons)\n            {\n                if (!TemplateRules.AllowedButtonTypes.Contains(b.Type))\n                {\n                    r.Add($\"Button type '{b.Type}' is invalid.\");\n                    continue;\n                }\n\n                if (string.IsNullOrWhiteSpace(b.Text))\n                {\n                    r.Add(\"Button text is required.\");\n                }\n                else if (b.Type.Equals(\"QUICK_REPLY\", StringComparison.OrdinalIgnoreCase))\n                {\n                    if (b.Text.Length > TemplateRules.MaxQuickReplyText)\n                        r.Add($\"Quick Reply text too long (>{TemplateRules.MaxQuickReplyText}).\");\n                    if (!quickReplyTexts.Add(b.Text))\n                        r.Add(\"Duplicate Quick Reply button text not allowed.\");\n                }\n\n                if (b.Type.Equals(\"URL\", StringComparison.OrdinalIgnoreCase))\n                {\n                    if (!TemplateRules.IsValidUrl(b.Url))\n                        r.Add(\"URL button must have a valid http(s) Url.\");\n                }\n\n                if (b.Type.Equals(\"PHONE\", StringComparison.OrdinalIgnoreCase))\n                {\n                    phoneCtas++;\n                    if (!TemplateRules.IsValidPhone(b.Phone))\n                        r.Add(\"PHONE button must have a valid phone number.\");\n                }\n            }\n\n            if (phoneCtas > 1) r.Add(\"Only one PHONE CTA button is allowed.\");\n        }\n\n        // examples for placeholders\n        if (slots.Count > 0)\n        {\n            var need = slots.Max();\n            var missing = new List<string>();\n            for (int i = 1; i <= need; i++)\n            {\n                if (dto.Examples is null || !dto.Examples.ContainsKey(i.ToString()) || string.IsNullOrWhiteSpace(dto.Examples[i.ToString()]))\n                    missing.Add($\"{{{{{i}}}}}\");\n            }\n            if (missing.Count > 0)\n                r.Add($\"Examples required for placeholders: {string.Join(\", \", missing)}\");\n        }\n\n        return r;\n    }\n}\n"
    }
  ]
}
