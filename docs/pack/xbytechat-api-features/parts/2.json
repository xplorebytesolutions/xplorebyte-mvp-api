{
  "name": "xbytechat-api/Features",
  "part": 2,
  "of": 5,
  "generatedAt": "2025-12-10 08:27:07 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Features/CampaignModule/SendEngine/TemplatePayloadBuilder.cs",
      "sha256": "a17c0dcb06ca9a2513070ca37218d5754f877bdf9a59eadefe124ffa30ba3c04",
      "language": "csharp",
      "size": 4995,
      "content": "// Features/CampaignModule/SendEngine/TemplatePayloadBuilder.cs\nusing System;\nusing System.Linq;\nusing System.Text.Json;\nusing System.Collections.Generic;\nusing System.Text.RegularExpressions;\n\nnamespace xbytechat.api.Features.CampaignModule.SendEngine\n{\n    public interface ITemplatePayloadBuilder\n    {\n        TemplateEnvelope Build(SendPlan plan, RecipientPlan r);\n    }\n\n    public sealed class TemplatePayloadBuilder : ITemplatePayloadBuilder\n    {\n        // Back-compat for legacy CSV/header names:\n        //   headerpara1     => header.text_param1\n        //   buttonpara2     => button2.url_param\n        private static readonly Regex RxHeaderPara = new(@\"^headerpara(\\d+)$\",\n            RegexOptions.IgnoreCase | RegexOptions.Compiled);\n        private static readonly Regex RxButtonPara = new(@\"^buttonpara(\\d+)$\",\n            RegexOptions.IgnoreCase | RegexOptions.Compiled);\n\n        private static string CanonicalizeKey(string key)\n        {\n            if (string.IsNullOrWhiteSpace(key)) return string.Empty;\n            key = key.Trim();\n\n            var m1 = RxHeaderPara.Match(key);\n            if (m1.Success) return $\"header.text_param{m1.Groups[1].Value}\";\n\n            var m2 = RxButtonPara.Match(key);\n            if (m2.Success) return $\"button{m2.Groups[1].Value}.url_param\";\n\n            return key; // already canonical (parameterN, header.text_paramN, buttonX.url_param, named tokens, etc.)\n        }\n\n        private static Dictionary<string, string> NormalizeKeys(Dictionary<string, string> dict)\n        {\n            var res = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            foreach (var kv in dict)\n            {\n                var canon = CanonicalizeKey(kv.Key);\n                res[canon] = kv.Value ?? string.Empty;\n            }\n            return res;\n        }\n\n        public TemplateEnvelope Build(SendPlan plan, RecipientPlan r)\n        {\n            var bodyParams = DeserializeStringArray(r.ParametersJson);\n\n            // Parse per-recipient extras (header + button params live here)\n            var origJson = r.ButtonParamsJson ?? \"{}\";\n            var looksLikeList = LooksLikeJsonArray(origJson);\n\n            // If dict → normalize legacy keys; if list → keep as-is (we'll align Pinnacle in Step 4)\n            var perRecipientDict = DeserializeDict(looksLikeList ? \"{}\" : origJson);\n            var perRecipient = NormalizeKeys(perRecipientDict);\n\n            // Accept both styles: \"header.text.1\" and \"header.text_param1\"\n            var headerParams =\n                ExtractOrdered(perRecipient, \"header.text.\")\n                .Concat(ExtractOrdered(perRecipient, \"header.text_param\"))\n                .ToArray();\n\n            // If input was a dict, write back normalized dict so mappers see canonical keys.\n            // If input was a list, preserve original JSON to avoid breaking current Pinnacle behavior.\n            var outButtonParamsJson = looksLikeList\n                ? origJson\n                : JsonSerializer.Serialize(perRecipient);\n\n            return new TemplateEnvelope(\n                HeaderKind: plan.HeaderKind,\n                HeaderParams: headerParams,\n                HeaderUrl: plan.HeaderUrl,\n                BodyParams: bodyParams,\n                Buttons: plan.Buttons,\n                PerRecipientButtonParamsJson: outButtonParamsJson\n            );\n        }\n\n        private static bool LooksLikeJsonArray(string json)\n        {\n            if (string.IsNullOrWhiteSpace(json)) return false;\n            for (int i = 0; i < json.Length; i++)\n            {\n                var ch = json[i];\n                if (char.IsWhiteSpace(ch)) continue;\n                return ch == '['; // first non-space\n            }\n            return false;\n        }\n\n        private static string[] DeserializeStringArray(string? json)\n        {\n            if (string.IsNullOrWhiteSpace(json)) return Array.Empty<string>();\n            try { return JsonSerializer.Deserialize<string[]>(json!) ?? Array.Empty<string>(); }\n            catch { return Array.Empty<string>(); }\n        }\n\n        private static Dictionary<string, string> DeserializeDict(string? json)\n        {\n            if (string.IsNullOrWhiteSpace(json)) return new();\n            try { return JsonSerializer.Deserialize<Dictionary<string, string>>(json!) ?? new(); }\n            catch { return new(); }\n        }\n\n        private static string[] ExtractOrdered(Dictionary<string, string> dict, string prefix)\n        {\n            return dict\n                .Where(kv => kv.Key.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))\n                .Select(kv => (Idx: TryIndex(kv.Key, prefix), Val: kv.Value))\n                .Where(x => x.Idx > 0)\n                .OrderBy(x => x.Idx)\n                .Select(x => x.Val)\n                .ToArray();\n\n            static int TryIndex(string key, string prefix)\n                => int.TryParse(key.AsSpan(prefix.Length), out var i) ? i : -1;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignDeletionResult.cs",
      "sha256": "710f394b8a1c578edc909b649fe696c5ad9a3bd0fa7d33ea7fba8fc1fe2f21b3",
      "language": "csharp",
      "size": 1270,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n\n    public sealed class CampaignDeletionOptions { public bool Force { get; set; } }\n\n    public enum CampaignDeletionStatus\n    {\n        Deleted,\n        NotFound,\n        BlockedSending,\n        BlockedState,\n        Error\n    }\n\n    public sealed class CampaignDeletionResult\n    {\n        public CampaignDeletionStatus Status { get; init; }\n        public int Recipients { get; init; }\n        public int QueuedJobs { get; init; }\n        public int SendLogs { get; init; }\n\n        public static CampaignDeletionResult Deleted(int r, int q, int s)\n            => new() { Status = CampaignDeletionStatus.Deleted, Recipients = r, QueuedJobs = q, SendLogs = s };\n\n        public static CampaignDeletionResult NotFound()\n            => new() { Status = CampaignDeletionStatus.NotFound };\n\n        public static CampaignDeletionResult BlockedSending(int r, int q, int s)\n            => new() { Status = CampaignDeletionStatus.BlockedSending, Recipients = r, QueuedJobs = q, SendLogs = s };\n\n        public static CampaignDeletionResult BlockedState(int r, int q, int s)\n            => new() { Status = CampaignDeletionStatus.BlockedState, Recipients = r, QueuedJobs = q, SendLogs = s };\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignDispatcher.cs",
      "sha256": "3d2dde021dad6913b85c106875271d20afbd73a861509db2c8b98c8fd676b336",
      "language": "csharp",
      "size": 9628,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\n// DO NOT import a different interface namespace; the interface is in this same namespace.\nusing xbytechat.api.Features.Queueing.DTOs;     // OutboundCampaignJobCreateDto\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    /// <summary>\n    /// Picks materialized recipients (MaterializedAt != null) in a stable order,\n    /// filters to \"ready\" statuses, and enqueues send jobs via your outbound queue.\n    /// </summary>\n    public sealed class CampaignDispatcher : ICampaignDispatcher\n    {\n        private readonly AppDbContext _db;\n        private readonly IOutboundCampaignQueueService _queue; // interface is in this same namespace\n\n        // If you use enums, map these accordingly.\n        private static readonly string[] ReadyStatuses = { \"Pending\", \"Ready\" };\n\n        public CampaignDispatcher(AppDbContext db, IOutboundCampaignQueueService queue)\n        {\n            _db = db;\n            _queue = queue;\n        }\n\n        //public async Task<CampaignDispatchResponseDto> DispatchAsync(\n        //    Guid businessId,\n        //    Guid campaignId,\n        //    string mode,\n        //    int count,\n        //    CancellationToken ct = default)\n        //{\n        //    if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n        //    if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required.\");\n\n        //    mode = (mode ?? \"canary\").Trim().ToLowerInvariant();\n        //    if (mode != \"canary\" && mode != \"full\") mode = \"canary\";\n        //    if (count <= 0) count = 25;\n\n        //    // 1) Sanity: ownership\n        //    var owns = await _db.Campaigns.AsNoTracking()\n        //        .AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n        //    if (!owns) throw new UnauthorizedAccessException(\"Campaign not found or not owned by this business.\");\n\n        //    // 2) Base recipients query (materialized + ready)\n        //    var baseQuery = _db.CampaignRecipients.AsNoTracking()\n        //        .Where(r => r.BusinessId == businessId\n        //                 && r.CampaignId == campaignId\n        //                 && r.MaterializedAt != null\n        //                 && ReadyStatuses.Contains(r.Status));\n\n        //    // 3) Stable order: oldest materialized first; then Id as tiebreaker\n        //    baseQuery = baseQuery.OrderBy(r => r.MaterializedAt).ThenBy(r => r.Id);\n\n        //    // 4) Select candidates (slightly over-select; queue dedupes)\n        //    var desired = mode == \"canary\" ? count : int.MaxValue;\n        //    var take = Math.Min(desired * 2, 5000);\n        //    var candidates = await baseQuery.Take(take).ToListAsync(ct);\n\n        //    // --- Build queue jobs ---\n        //    var jobs = new List<OutboundCampaignJobCreateDto>(candidates.Count);\n        //    foreach (var r in candidates)\n        //    {\n        //        jobs.Add(new OutboundCampaignJobCreateDto\n        //        {\n        //            BusinessId = businessId,\n        //            CampaignId = campaignId,\n        //            CampaignRecipientId = r.Id,\n        //            IdempotencyKey = r.IdempotencyKey\n        //        });\n        //    }\n\n        //    // 5) Enqueue (no-op adapter will just count)\n        //    var enqueued = await _queue.EnqueueBulkAsync(jobs, ct);\n\n        //    // --- Prepare response ---\n\n        //    // Fetch phones for the sample (phone is on AudienceMember, not CampaignRecipient)\n        //    var memberIds = candidates\n        //        .Where(r => r.AudienceMemberId.HasValue)\n        //        .Select(r => r.AudienceMemberId!.Value)\n        //        .Distinct()\n        //        .ToList();\n\n        //    var phoneByMemberId = await _db.AudiencesMembers.AsNoTracking()\n        //        .Where(m => m.BusinessId == businessId && memberIds.Contains(m.Id))\n        //        .Select(m => new { m.Id, m.PhoneE164 })\n        //        .ToDictionaryAsync(x => x.Id, x => x.PhoneE164, ct);\n\n        //    var resp = new CampaignDispatchResponseDto\n        //    {\n        //        CampaignId = campaignId,\n        //        Mode = mode,\n        //        RequestedCount = count,\n        //        SelectedCount = candidates.Count,\n        //        EnqueuedCount = enqueued,\n        //        Sample = candidates\n        //            .Take(10)\n        //            .Select(r => new DispatchedRecipientDto\n        //            {\n        //                RecipientId = r.Id,\n        //                Phone = (r.AudienceMemberId.HasValue &&\n        //                         phoneByMemberId.TryGetValue(r.AudienceMemberId.Value, out var p))\n        //                            ? p\n        //                            : null,\n        //                Status = r.Status,\n        //                MaterializedAt = r.MaterializedAt,\n        //                IdempotencyKey = r.IdempotencyKey\n        //            })\n        //            .ToList()\n        //    };\n\n        //    if (mode == \"full\")\n        //    {\n        //        resp.Warnings.Add(\"Full dispatch requested; rate limiting/backoff is enforced by the worker/queue.\");\n        //    }\n\n        //    Log.Information(\"Dispatch queued {@Summary}\", new\n        //    {\n        //        businessId,\n        //        campaignId,\n        //        mode,\n        //        requested = count,\n        //        selected = candidates.Count,\n        //        enqueued\n        //    });\n\n        //    return resp;\n        //}\n\n        public async Task<CampaignDispatchResponseDto> DispatchAsync(\n    Guid businessId,\n    Guid campaignId,\n    string mode,\n    int count,\n    CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required.\");\n\n            mode = (mode ?? \"canary\").Trim().ToLowerInvariant();\n            if (mode != \"canary\" && mode != \"full\") mode = \"canary\";\n            if (count <= 0) count = 25;\n\n            var owns = await _db.Campaigns.AsNoTracking()\n                .AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n            if (!owns) throw new UnauthorizedAccessException(\"Campaign not found or not owned by this business.\");\n\n            var baseQuery = _db.CampaignRecipients.AsNoTracking()\n                .Where(r => r.BusinessId == businessId\n                         && r.CampaignId == campaignId\n                         && r.MaterializedAt != null\n                         && ReadyStatuses.Contains(r.Status))\n                .OrderBy(r => r.MaterializedAt).ThenBy(r => r.Id);\n\n            var desired = mode == \"canary\" ? count : int.MaxValue;\n            var take = Math.Min(desired * 2, 5000);\n            var candidates = await baseQuery.Take(take).ToListAsync(ct);\n\n            var jobs = new List<OutboundCampaignJobCreateDto>(candidates.Count);\n            foreach (var r in candidates)\n            {\n                jobs.Add(new OutboundCampaignJobCreateDto\n                {\n                    BusinessId = businessId,\n                    CampaignId = campaignId,\n                    CampaignRecipientId = r.Id,\n                    IdempotencyKey = r.IdempotencyKey\n                });\n            }\n            var enqueued = await _queue.EnqueueBulkAsync(jobs, ct);\n\n            // ---- CHANGED: AudienceMemberId is Guid (non-nullable)\n            //var memberIds = candidates\n            //    .Select(r => r.AudienceMemberId)\n            //    .Distinct()\n            //    .ToHashSet(); // perf for Contains\n\n            var memberIds = candidates\n    .Where(r => r.AudienceMemberId.HasValue)\n    .Select(r => r.AudienceMemberId!.Value)\n    .Distinct()\n    .ToHashSet();\n\n            var phoneByMemberId = await _db.AudienceMembers   // or _db.AudiencesMembers if that's your DbSet\n      .AsNoTracking()\n      .Where(m => m.BusinessId == businessId && memberIds.Contains(m.Id))\n      .Select(m => new { m.Id, m.PhoneE164 })\n      .ToDictionaryAsync(x => x.Id, x => x.PhoneE164, ct);\n\n            var resp = new CampaignDispatchResponseDto\n            {\n                CampaignId = campaignId,\n                Mode = mode,\n                RequestedCount = count,\n                SelectedCount = candidates.Count,\n                EnqueuedCount = enqueued,\n                Sample = candidates\n                .Take(10)\n                .Select(r => new DispatchedRecipientDto\n                {\n                    RecipientId = r.Id,\n                    Phone = (r.AudienceMemberId.HasValue &&\n                             phoneByMemberId.TryGetValue(r.AudienceMemberId.Value, out var p))\n                                ? p\n                                : null,\n                    Status = r.Status,\n                    MaterializedAt = r.MaterializedAt,\n                    IdempotencyKey = r.IdempotencyKey\n                })\n                .ToList()\n            };\n\n            if (mode == \"full\")\n                resp.Warnings.Add(\"Full dispatch requested; rate limiting/backoff is enforced by the worker/queue.\");\n\n            Log.Information(\"Dispatch queued {@Summary}\", new { businessId, campaignId, mode, requested = count, selected = candidates.Count, enqueued });\n            return resp;\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignDispatchPlannerService.cs",
      "sha256": "fe613afed24f76c48409b379b1e82e36e259c41afe57aacb1122ace6dff1ea83",
      "language": "csharp",
      "size": 8973,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Services;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignDispatchPlannerService\n    {\n        /// <summary>\n        /// Build a read-only dispatch plan: batches, offsets, size estimates, and throttle summary.\n        /// No messages are sent and no DB writes are performed.\n        /// </summary>\n        Task<CampaignDispatchPlanResultDto> PlanAsync(Guid businessId, Guid campaignId, int limit = 2000, CancellationToken ct = default);\n    }\n\n    /// <summary>\n    /// Computes batch plan from materialized rows with simple throttling:\n    /// - Derives batch size and per-minute cap from Business.Plan (fallback defaults).\n    /// - Slices rows into batches and schedules offsets (seconds) so per-minute cap is respected.\n    /// - Approximates payload size per row/batch for sanity checks.\n    /// </summary>\n    public class CampaignDispatchPlannerService : ICampaignDispatchPlannerService\n    {\n        private readonly AppDbContext _db;\n        private readonly ICampaignMaterializationService _materializer;\n\n        public CampaignDispatchPlannerService(AppDbContext db, ICampaignMaterializationService materializer)\n        {\n            _db = db;\n            _materializer = materializer;\n        }\n\n        public async Task<CampaignDispatchPlanResultDto> PlanAsync(Guid businessId, Guid campaignId, int limit = 2000, CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"CampaignId is required.\");\n\n            // Load campaign shell for meta\n            var campaign = await _db.Campaigns\n                .AsNoTracking()\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct)\n                ?? throw new KeyNotFoundException(\"Campaign not found.\");\n\n            // Materialize (reuses Step 2.11) — read-only\n            var mat = await _materializer.MaterializeAsync(businessId, campaignId, limit, ct);\n\n            // Business plan & provider heuristics (non-fatal if missing)\n            var biz = await _db.Businesses\n                .AsNoTracking()\n                .FirstOrDefaultAsync(b => b.Id == businessId, ct);\n\n            // var planName = (biz?.Plan ?? \"Basic\").Trim();\n            var planName = (biz == null\n     ? \"Basic\"\n     : (biz.Plan?.ToString() ?? \"Basic\")\n ).Trim();\n            var provider = (campaign.Provider ?? \"Auto\").Trim(); // if you snapshot provider on Campaign; otherwise \"Auto\"\n\n            // Throttle rules (sane defaults; adjust to your real plan matrix if available)\n            var (maxBatch, perMinute) = GetThrottleForPlan(planName);\n\n            var result = new CampaignDispatchPlanResultDto\n            {\n                CampaignId = campaignId,\n                TemplateName = mat.TemplateName,\n                Language = mat.Language,\n                PlaceholderCount = mat.PlaceholderCount,\n                TotalRecipients = mat.Rows.Count,\n                Throttle = new DispatchThrottleDto\n                {\n                    Plan = planName,\n                    Provider = provider,\n                    MaxBatchSize = maxBatch,\n                    MaxPerMinute = perMinute\n                }\n            };\n\n            if (mat.Rows.Count == 0)\n            {\n                result.GlobalWarnings.Add(\"No recipients available to plan. Ensure audience or campaign recipients exist.\");\n                result.WarningCount = result.GlobalWarnings.Count;\n                return result;\n            }\n\n            // Approx size per row (naive): sum of parameter lengths + resolved button urls + a small fixed header cost\n            var approxBytesPerRow = new List<int>(mat.Rows.Count);\n            foreach (var row in mat.Rows)\n            {\n                var paramBytes = row.Parameters.Sum(p => (p.Value?.Length ?? 0));\n                var btnBytes = row.Buttons.Sum(b => (b.ResolvedUrl?.Length ?? 0) + (b.ButtonText?.Length ?? 0));\n                // add a tiny constant for template envelope; tweak if you maintain captions/text\n                var approx = (paramBytes + btnBytes + 64);\n                approxBytesPerRow.Add(approx);\n            }\n\n            result.TotalApproxBytes = approxBytesPerRow.Sum();\n\n            // Build batches by MaxBatchSize\n            var batches = new List<DispatchBatchDto>();\n            var total = mat.Rows.Count;\n            var batchCount = (int)Math.Ceiling(total / (double)maxBatch);\n\n            // Schedule offsets constrained by MaxPerMinute:\n            // At most 'perMinute' messages may start within any 60-second window.\n            // Strategy: bucket batches into \"minutes\", each minute can hold floor(perMinute / maxBatch) full batches.\n            var batchesPerMinute = Math.Max(1, perMinute / Math.Max(1, maxBatch));\n            if (batchesPerMinute == 0) batchesPerMinute = 1; // guard\n\n            var offsetMinutes = 0;\n            var slotInMinute = 0;\n            int globalIdx = 0;\n\n            for (int b = 0; b < batchCount; b++)\n            {\n                var startIndex = b * maxBatch;\n                var take = Math.Min(maxBatch, total - startIndex);\n\n                var slicePhones = new List<string?>(take);\n                var sliceRecipientIds = new List<Guid?>(take);\n                var sliceApprox = 0;\n\n                for (int i = 0; i < take; i++)\n                {\n                    var row = mat.Rows[startIndex + i];\n                    slicePhones.Add(row.Phone);\n                    sliceRecipientIds.Add(row.RecipientId);\n                    sliceApprox += approxBytesPerRow[startIndex + i];\n                }\n\n                var batch = new DispatchBatchDto\n                {\n                    BatchNumber = b + 1,\n                    StartIndex = startIndex,\n                    Count = take,\n                    ApproxBytes = sliceApprox,\n                    RecipientIds = sliceRecipientIds,\n                    Phones = slicePhones,\n                    OffsetSeconds = offsetMinutes * 60\n                };\n\n                // Notes for the curious\n                if (slicePhones.Any(p => string.IsNullOrWhiteSpace(p)))\n                    batch.Notes.Add(\"Some rows missing phone; those will fail at send-time unless corrected.\");\n                if (sliceApprox / Math.Max(1, take) > 2000)\n                    batch.Notes.Add(\"Average payload per row is large; provider truncation risk.\");\n\n                batches.Add(batch);\n\n                // advance slot & minute window\n                slotInMinute++;\n                if (slotInMinute >= batchesPerMinute)\n                {\n                    slotInMinute = 0;\n                    offsetMinutes++;\n                }\n\n                globalIdx += take;\n            }\n\n            result.Batches = batches;\n            result.Throttle.ComputedBatches = batches.Count;\n            // Estimated minutes: ceil(total recipients / perMinute)\n            result.Throttle.EstimatedMinutes = (int)Math.Ceiling(total / (double)Math.Max(1, perMinute));\n\n            // Warnings\n            if (perMinute < 30) result.Throttle.Warnings.Add(\"Low per-minute limit; delivery may be slow for large audiences.\");\n            if (result.TotalApproxBytes > 5_000_000) result.GlobalWarnings.Add(\"Plan size is large (>5MB). Consider splitting the audience.\");\n\n            result.WarningCount =\n                result.GlobalWarnings.Count +\n                result.Throttle.Warnings.Count +\n                result.Batches.Sum(bh => bh.Notes.Count);\n\n            Log.Information(\"Dispatch plan computed {@PlanSummary}\",\n                new\n                {\n                    campaignId,\n                    businessId,\n                    mat.TemplateName,\n                    mat.Language,\n                    totalRecipients = result.TotalRecipients,\n                    batches = result.Batches.Count,\n                    perMinute,\n                    maxBatch,\n                    estMinutes = result.Throttle.EstimatedMinutes\n                });\n\n            return result;\n        }\n\n        private static (int maxBatch, int perMinute) GetThrottleForPlan(string planName)\n        {\n            // Conservative defaults; align with your real billing/plan matrix when available.\n            switch ((planName ?? \"\").Trim().ToLowerInvariant())\n            {\n                case \"advanced\":\n                    return (100, 600);\n                case \"smart\":\n                    return (50, 300);\n                case \"basic\":\n                default:\n                    return (25, 120);\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignDryRunService.cs",
      "sha256": "7951a4dbf036d9ec05750278c322b32b635d8135cb7a51d75748e0ac3f1a0d0a",
      "language": "csharp",
      "size": 9184,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Shared.utility;\nusing xbytechat.api.WhatsAppSettings.Services;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    /// <summary>\n    /// Dry-run validator for campaigns. Checks template existence, parameter counts,\n    /// dynamic button placeholders, and recipient phone presence/shape.\n    /// </summary>\n    public class CampaignDryRunService : ICampaignDryRunService\n    {\n        private readonly AppDbContext _db;\n        private readonly IWhatsAppTemplateFetcherService _templateFetcher;\n\n        private static readonly Regex PlaceholderRe = new(@\"\\{\\{\\s*(\\d+)\\s*\\}\\}\", RegexOptions.Compiled);\n\n        public CampaignDryRunService(AppDbContext db, IWhatsAppTemplateFetcherService templateFetcher)\n        {\n            _db = db;\n            _templateFetcher = templateFetcher;\n        }\n\n        public async Task<CampaignDryRunResultDto> ValidateAsync(\n            Guid businessId,\n            Guid campaignId,\n            int limit = 200,\n            CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required.\");\n\n            // Load campaign + recipients(+contacts) + variable maps + buttons (read-only)\n            var campaign = await _db.Campaigns\n                .AsNoTracking()\n                .Include(c => c.MultiButtons)\n                .Include(c => c.VariableMaps)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n\n            if (campaign == null)\n                throw new KeyNotFoundException(\"Campaign not found.\");\n\n            // Recipients (contact needed for phone)\n            var recipients = await _db.CampaignRecipients\n                .AsNoTracking()\n                .Include(r => r.Contact)\n                .Where(r => r.CampaignId == campaignId && r.BusinessId == businessId)\n                .OrderBy(r => r.UpdatedAt)\n                .Take(limit)\n                .ToListAsync(ct);\n\n            // Determine template name (prefer TemplateId → MessageTemplate) and fetch metadata\n            var templateName = (campaign.TemplateId ?? campaign.MessageTemplate ?? \"\").Trim();\n            if (string.IsNullOrWhiteSpace(templateName))\n            {\n                // No template at all — return result with a single global error across all recipients\n                return BuildResult(\n                    campaignId,\n                    templateName: \"\",\n                    language: \"en_US\",\n                    placeholderCount: 0,\n                    recipients: recipients,\n                    globalError: \"Template name is missing on campaign.\"\n                );\n            }\n\n            var meta = await _templateFetcher.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n            if (meta == null)\n            {\n                return BuildResult(\n                    campaignId,\n                    templateName,\n                    language: \"en_US\",\n                    placeholderCount: 0,\n                    recipients: recipients,\n                    globalError: $\"Template '{templateName}' not found for business.\"\n                );\n            }\n\n            var language = (meta.Language ?? \"en_US\").Trim();\n            var placeholderCount = Math.Max(0, meta.PlaceholderCount);\n\n            // Campaign-stored parameters: if supplied, compare counts\n            var storedParams = TemplateParameterHelper.ParseTemplateParams(campaign.TemplateParameters);\n            bool paramCountMismatch = storedParams.Count > 0 && storedParams.Count != placeholderCount;\n\n            // Validate buttons for dynamic placeholders ({{n}})\n            var dynamicButtonIssues = new List<string>();\n            var buttonPlaceholdersNeeded = new HashSet<int>();\n\n            foreach (var b in (campaign.MultiButtons ?? Enumerable.Empty<CampaignButton>()))\n            {\n                var value = b.Value ?? \"\";\n                foreach (Match m in PlaceholderRe.Matches(value))\n                {\n                    if (int.TryParse(m.Groups[1].Value, out var n))\n                    {\n                        buttonPlaceholdersNeeded.Add(n);\n                    }\n                }\n            }\n\n            foreach (var n in buttonPlaceholdersNeeded)\n            {\n                if (storedParams.Count > 0 && (n < 1 || n > storedParams.Count))\n                {\n                    dynamicButtonIssues.Add($\"Button needs placeholder {{%{n}%}} but campaign parameters only provide {storedParams.Count} value(s).\");\n                }\n                if (placeholderCount > 0 && (n < 1 || n > placeholderCount))\n                {\n                    dynamicButtonIssues.Add($\"Button needs placeholder {{%{n}%}} but template defines only {placeholderCount} placeholder(s).\");\n                }\n            }\n\n            // Build per-recipient issues\n            var issues = new List<CampaignDryRunIssueDto>();\n            foreach (var r in recipients)\n            {\n                var phone = r.Contact?.PhoneNumber?.Trim();\n\n                if (string.IsNullOrWhiteSpace(phone))\n                {\n                    issues.Add(new CampaignDryRunIssueDto\n                    {\n                        RecipientId = r.Id,\n                        ContactId = r.ContactId,\n                        Phone = phone,\n                        Severity = \"error\",\n                        Message = \"Phone is missing.\"\n                    });\n                }\n                else if (!IsLikelyPhone(phone))\n                {\n                    issues.Add(new CampaignDryRunIssueDto\n                    {\n                        RecipientId = r.Id,\n                        ContactId = r.ContactId,\n                        Phone = phone,\n                        Severity = \"warning\",\n                        Message = \"Phone format looks unusual.\"\n                    });\n                }\n            }\n\n            // Add global-ish issues once (we’ll attribute them to a null recipient)\n            if (paramCountMismatch)\n            {\n                issues.Add(new CampaignDryRunIssueDto\n                {\n                    Severity = \"warning\",\n                    Message = $\"Placeholder count mismatch: template expects {placeholderCount}, campaign provided {storedParams.Count}.\",\n                });\n            }\n\n            foreach (var bi in dynamicButtonIssues.Distinct())\n            {\n                issues.Add(new CampaignDryRunIssueDto\n                {\n                    Severity = \"error\",\n                    Message = bi\n                });\n            }\n\n            var result = new CampaignDryRunResultDto\n            {\n                CampaignId = campaignId,\n                TemplateName = templateName,\n                Language = language,\n                PlaceholderCount = placeholderCount,\n                CheckedRecipients = recipients.Count,\n                Issues = issues,\n                ErrorCount = issues.Count(i => string.Equals(i.Severity, \"error\", StringComparison.OrdinalIgnoreCase)),\n                WarningCount = issues.Count(i => string.Equals(i.Severity, \"warning\", StringComparison.OrdinalIgnoreCase)),\n            };\n\n            Log.Information(\"Dry-run completed for Campaign {CampaignId} (biz {BusinessId}) → {Errors} errors, {Warnings} warnings over {Checked} recipients\",\n                campaignId, businessId, result.ErrorCount, result.WarningCount, result.CheckedRecipients);\n\n            return result;\n        }\n\n        private static CampaignDryRunResultDto BuildResult(\n            Guid campaignId,\n            string templateName,\n            string language,\n            int placeholderCount,\n            List<CampaignRecipient> recipients,\n            string globalError)\n        {\n            var issues = new List<CampaignDryRunIssueDto>\n            {\n                new CampaignDryRunIssueDto\n                {\n                    Severity = \"error\",\n                    Message = globalError\n                }\n            };\n\n            return new CampaignDryRunResultDto\n            {\n                CampaignId = campaignId,\n                TemplateName = templateName,\n                Language = language,\n                PlaceholderCount = placeholderCount,\n                CheckedRecipients = recipients.Count,\n                Issues = issues,\n                ErrorCount = issues.Count,\n                WarningCount = 0\n            };\n        }\n\n        private static bool IsLikelyPhone(string? s)\n        {\n            if (string.IsNullOrWhiteSpace(s)) return false;\n            var digits = s.Count(char.IsDigit);\n            return digits >= 10 && digits <= 15;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignMaterializationService.cs",
      "sha256": "4a5f472d01df252626340dc976ed72905f8ed91da5f745f0c5897bf9a72ca4d4",
      "language": "csharp",
      "size": 33263,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.Json;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.WhatsAppSettings.Services; // ensure namespace matches your project\nusing xbytechat.api.Features.MessageManagement.Services;\nusing xbytechat_api.WhatsAppSettings.Services;\nusing xbytechat.api.Features.Tracking.Services;\nusing xbytechat.api.WhatsAppSettings.DTOs; // IUrlBuilderService\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    \n\n    /// <summary>\n    /// Read-only “compiler” that materializes template params and button URLs per recipient.\n    /// Mirrors the live send behavior (no dispatch, no DB writes).\n    /// </summary>\n    public sealed class CampaignMaterializationService : ICampaignMaterializationService\n    {\n        private readonly AppDbContext _db;\n        private readonly IWhatsAppTemplateFetcherService _templateFetcher;\n        private readonly IUrlBuilderService _urlBuilderService;\n\n        private static readonly Regex PlaceholderRe = new(@\"\\{\\{\\s*(\\d+)\\s*\\}\\}\", RegexOptions.Compiled);\n\n        public CampaignMaterializationService(\n            AppDbContext db,\n            IWhatsAppTemplateFetcherService templateFetcher,\n            IUrlBuilderService urlBuilderService)\n        {\n            _db = db;\n            _templateFetcher = templateFetcher;\n            _urlBuilderService = urlBuilderService;\n        }\n\n        //public async Task<CampaignMaterializeResultDto> MaterializeAsync(\n        //    Guid businessId,\n        //    Guid campaignId,\n        //    int limit = 200,\n        //    CancellationToken ct = default)\n        //{\n        //    if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n        //    if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required\");\n        //    if (limit <= 0) limit = 200;\n\n        //    // Load campaign + variable maps + buttons + recipients (+ contacts)\n        //    var campaign = await _db.Campaigns\n        //        .AsNoTracking()\n        //        .Include(c => c.VariableMaps)\n        //        .Include(c => c.MultiButtons)\n        //        .Include(c => c.Recipients).ThenInclude(r => r.Contact)\n        //        .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n\n        //    if (campaign == null)\n        //        throw new KeyNotFoundException(\"Campaign not found.\");\n\n        //    // Resolve template meta from snapshot/params; fallback to live\n        //    var meta = await ResolveTemplateMetaAsync(campaign, businessId, ct);\n        //    var templateName = meta.TemplateName;\n        //    var language = meta.Language;\n        //    var placeholderCount = meta.PlaceholderCount;\n\n        //    if (string.IsNullOrWhiteSpace(templateName))\n        //        throw new InvalidOperationException(\"Campaign does not have a resolvable template name.\");\n\n        //    // Try to fetch provider button meta (for dynamic URL detection & alignment)\n        //    TemplateMetadataDto? liveMeta = null;\n        //    try\n        //    {\n        //        liveMeta = await _templateFetcher.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        Log.Warning(ex, \"Template fetch failed during materialization for {Template}\", templateName);\n        //    }\n\n        //    var result = new CampaignMaterializeResultDto\n        //    {\n        //        CampaignId = campaignId,\n        //        TemplateName = templateName,\n        //        Language = language,\n        //        PlaceholderCount = placeholderCount\n        //    };\n\n        //    var varMaps = (campaign.VariableMaps ?? new List<CampaignVariableMap>())\n        //        .Where(m => m.CampaignId == campaignId)\n        //        .ToList();\n\n        //    var recipients = (campaign.Recipients ?? new List<CampaignRecipient>())\n        //        .OrderBy(r => r.UpdatedAt)\n        //        .Take(limit)\n        //        .ToList();\n\n        //    // order buttons by Position (then by their original index) to align with template button index\n        //    var orderedButtons = (campaign.MultiButtons ?? new List<CampaignButton>())\n        //        .Select((b, idx) => new { Btn = b, idx })\n        //        .OrderBy(x => (int?)x.Btn.Position ?? int.MaxValue)\n        //        .ThenBy(x => x.idx)\n        //        .Select(x => x.Btn)\n        //        .ToList();\n\n        //    foreach (var r in recipients)\n        //    {\n        //        var row = new MaterializedRecipientDto\n        //        {\n        //            RecipientId = r.Id,\n        //            ContactId = r.ContactId,\n        //            Phone = NormalizePhone(r?.Contact?.PhoneNumber)\n        //        };\n\n        //        // Parameters 1..N via variable maps (Static/Default/Expression placeholder)\n        //        for (int idx = 1; idx <= placeholderCount; idx++)\n        //        {\n        //            var map = varMaps.FirstOrDefault(m => m.Index == idx);\n        //            if (map == null)\n        //            {\n        //                row.Parameters.Add(new TemplateParamResolutionDto\n        //                {\n        //                    Index = idx,\n        //                    Value = null,\n        //                    IsMissing = true,\n        //                    SourceType = \"Unmapped\",\n        //                    Note = \"No variable map for this placeholder.\"\n        //                });\n        //                continue;\n        //            }\n\n        //            var (value, isMissing, note) = ResolveValue(map, r);\n        //            row.Parameters.Add(new TemplateParamResolutionDto\n        //            {\n        //                Index = idx,\n        //                Value = value,\n        //                IsMissing = isMissing,\n        //                SourceType = map.SourceType ?? string.Empty,\n        //                SourceKey = map.SourceKey\n        //            });\n\n        //            if (!string.IsNullOrWhiteSpace(note))\n        //                row.Warnings.Add($\"{{{{{idx}}}}}: {note}\");\n        //        }\n\n        //        // Buttons: mirror live send behavior for dynamic URL buttons (index 0..2)\n        //        if (liveMeta?.ButtonParams != null && liveMeta.ButtonParams.Count > 0 && orderedButtons.Count > 0)\n        //        {\n        //            var total = Math.Min(3, Math.Min(orderedButtons.Count, liveMeta.ButtonParams.Count));\n\n        //            for (int i = 0; i < total; i++)\n        //            {\n        //                var metaBtn = liveMeta.ButtonParams[i];\n        //                var subType = (metaBtn.SubType ?? \"url\").ToLowerInvariant();\n        //                var metaParam = metaBtn.ParameterValue?.Trim();\n\n        //                var br = new ButtonResolutionDto\n        //                {\n        //                    ButtonText = orderedButtons[i]?.Title ?? string.Empty,\n        //                    RawTemplateValue = orderedButtons[i]?.Value\n        //                };\n\n        //                // We only handle dynamic URL buttons here (consistent with send logic)\n        //                if (!string.Equals(subType, \"url\", StringComparison.OrdinalIgnoreCase))\n        //                {\n        //                    br.Notes.Add(\"Non-URL button (no dynamic resolution).\");\n        //                    row.Buttons.Add(br);\n        //                    continue;\n        //                }\n\n        //                var isDynamic = !string.IsNullOrWhiteSpace(metaParam) && metaParam.Contains(\"{{\");\n        //                if (!isDynamic)\n        //                {\n        //                    br.Notes.Add(\"Static URL button (no parameters required by template).\");\n        //                    row.Buttons.Add(br);\n        //                    continue;\n        //                }\n\n        //                var btn = orderedButtons[i];\n        //                var btnType = (btn?.Type ?? \"URL\").ToUpperInvariant();\n        //                if (!string.Equals(btnType, \"URL\", StringComparison.OrdinalIgnoreCase))\n        //                {\n        //                    br.Notes.Add($\"Template expects a dynamic URL at index {i}, but campaign button type is '{btn?.Type}'.\");\n        //                    row.Buttons.Add(br);\n        //                    continue;\n        //                }\n\n        //                var valueRaw = btn?.Value?.Trim();\n        //                if (string.IsNullOrWhiteSpace(valueRaw))\n        //                {\n        //                    br.Notes.Add($\"Template requires a dynamic URL at index {i}, but campaign button value is empty.\");\n        //                    br.MissingArguments.Add(\"{{1}}\");\n        //                    row.Buttons.Add(br);\n        //                    continue;\n        //                }\n\n        //                // optional phone substitution into destination\n        //                var phone = row.Phone ?? \"\";\n        //                var encodedPhone = Uri.EscapeDataString(phone);\n\n        //                var resolvedDestination = valueRaw.Contains(\"{{1}}\")\n        //                    ? valueRaw.Replace(\"{{1}}\", encodedPhone)\n        //                    : valueRaw;\n\n        //                // normalize/validate URL (allow tel:, wa:, wa.me links)\n        //                try\n        //                {\n        //                    resolvedDestination = NormalizeAbsoluteUrlOrThrowForButton(resolvedDestination, btn!.Title ?? $\"Button {i + 1}\", i);\n        //                }\n        //                catch (Exception ex)\n        //                {\n        //                    br.Notes.Add($\"Destination invalid: {ex.Message}\");\n        //                    row.Buttons.Add(br);\n        //                    continue;\n        //                }\n\n        //                // Build both styles and pick based on template absolute base rule\n        //                var fakeSendLogId = Guid.NewGuid(); // preview-only tokenization\n        //                var fullTrackedUrl = _urlBuilderService.BuildTrackedButtonUrl(\n        //                    fakeSendLogId, i, btn!.Title, resolvedDestination);\n\n        //                var tokenParam = BuildTokenParam(fakeSendLogId, i, btn.Title, resolvedDestination);\n\n        //                var templateHasAbsoluteBase = LooksLikeAbsoluteBaseUrlWithPlaceholder(metaParam);\n        //                var valueToSend = templateHasAbsoluteBase ? tokenParam : fullTrackedUrl;\n\n        //                br.UsedPlaceholders.Add(\"{{1}}\"); // meta indicates dynamic\n        //                br.ResolvedUrl = valueToSend;\n        //                row.Buttons.Add(br);\n        //            }\n        //        }\n        //        else\n        //        {\n        //            // no dynamic buttons in template\n        //        }\n\n        //        // Basic phone sanity\n        //        if (string.IsNullOrWhiteSpace(row.Phone))\n        //            row.Errors.Add(\"Phone is missing.\");\n        //        else if (!IsLikelyPhone(row.Phone))\n        //            row.Warnings.Add(\"Phone format looks unusual.\");\n\n        //        result.Rows.Add(row);\n        //    }\n\n        //    result.ReturnedCount = result.Rows.Count;\n        //    result.ErrorCount = result.Rows.Sum(r => r.Errors.Count);\n        //    result.WarningCount = result.Rows.Sum(r => r.Warnings.Count)\n        //                          + result.Rows.Sum(r => r.Parameters.Count(p => p.IsMissing));\n\n        //    Log.Information(\"Campaign materialization computed {@Summary}\",\n        //        new\n        //        {\n        //            campaignId,\n        //            businessId,\n        //            result.ReturnedCount,\n        //            result.ErrorCount,\n        //            result.WarningCount,\n        //            result.PlaceholderCount,\n        //            result.TemplateName,\n        //            result.Language\n        //        });\n\n        //    return result;\n        //}\n        public async Task<CampaignMaterializeResultDto> MaterializeAsync(\n    Guid businessId,\n    Guid campaignId,\n    int limit = 200,\n    CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required\");\n            if (limit <= 0) limit = 200;\n\n            // Load campaign + variable maps + buttons + recipients (+ contacts)\n            var campaign = await _db.Campaigns\n                .AsNoTracking()\n                .Include(c => c.VariableMaps)\n                .Include(c => c.MultiButtons)\n                .Include(c => c.Recipients).ThenInclude(r => r.Contact)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n\n            if (campaign == null)\n                throw new KeyNotFoundException(\"Campaign not found.\");\n\n            // Resolve template meta from snapshot/params; fallback to live\n            var meta = await ResolveTemplateMetaAsync(campaign, businessId, ct);\n            var templateName = meta.TemplateName;\n            var language = meta.Language;\n            var placeholderCount = meta.PlaceholderCount;\n\n            if (string.IsNullOrWhiteSpace(templateName))\n                throw new InvalidOperationException(\"Campaign does not have a resolvable template name.\");\n\n            // Try to fetch provider button meta (for dynamic URL detection & alignment)\n            TemplateMetadataDto? liveMeta = null;\n            try\n            {\n                liveMeta = await _templateFetcher.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n            }\n            catch (Exception ex)\n            {\n                Log.Warning(ex, \"Template fetch failed during materialization for {Template}\", templateName);\n            }\n\n            var result = new CampaignMaterializeResultDto\n            {\n                CampaignId = campaignId,\n                TemplateName = templateName,\n                Language = language,\n                PlaceholderCount = placeholderCount\n            };\n\n            var varMaps = (campaign.VariableMaps ?? new List<CampaignVariableMap>())\n                .Where(m => m.CampaignId == campaignId)\n                .ToList();\n\n            var recipients = (campaign.Recipients ?? new List<CampaignRecipient>())\n                .OrderBy(r => r.UpdatedAt)\n                .Take(limit)\n                .ToList();\n\n            // order buttons by Position (then by their original index) to align with template button index\n            var orderedButtons = (campaign.MultiButtons ?? new List<CampaignButton>())\n                .Select((b, idx) => new { Btn = b, idx })\n                .OrderBy(x => (int?)x.Btn.Position ?? int.MaxValue)\n                .ThenBy(x => x.idx)\n                .Select(x => x.Btn)\n                .ToList();\n\n            foreach (var r in recipients)\n            {\n                var row = new MaterializedRecipientDto\n                {\n                    RecipientId = r.Id,\n                    ContactId = r.ContactId,\n                    Phone = NormalizePhone(r?.Contact?.PhoneNumber)\n                };\n\n                // 🔧 INLINE TOLERANT CONTACT LOOKUP (no helpers, no DB writes)\n                // If the recipient isn't linked to a Contact yet but we have a phone,\n                // try to find a Contact by either +E.164 or plain-digits form.\n                if ((row.ContactId == null || row.ContactId == Guid.Empty) && !string.IsNullOrWhiteSpace(row.Phone))\n                {\n                    string pPlus, pPlain;\n\n                    if (row.Phone.StartsWith(\"+\", StringComparison.Ordinal))\n                    {\n                        var digitsOnly = new string(row.Phone.Skip(1).Where(char.IsDigit).ToArray());\n                        pPlus = row.Phone;\n                        pPlain = digitsOnly;\n                    }\n                    else\n                    {\n                        var digitsOnly = new string(row.Phone.Where(char.IsDigit).ToArray());\n                        pPlus = \"+\" + digitsOnly;\n                        pPlain = digitsOnly;\n                    }\n\n                    // Only query if we have something meaningful\n                    if (!string.IsNullOrWhiteSpace(pPlus) || !string.IsNullOrWhiteSpace(pPlain))\n                    {\n                        var foundId = await _db.Contacts\n                            .AsNoTracking()\n                            .Where(c => c.BusinessId == businessId &&\n                                        (c.PhoneNumber == pPlus || c.PhoneNumber == pPlain))\n                            .Select(c => c.Id)\n                            .FirstOrDefaultAsync(ct);\n\n                        if (foundId != Guid.Empty)\n                            row.ContactId = foundId; // reflect resolvable linkage in preview\n                    }\n                }\n\n                // Parameters 1..N via variable maps (Static/Default/Expression placeholder)\n                for (int idx = 1; idx <= placeholderCount; idx++)\n                {\n                    var map = varMaps.FirstOrDefault(m => m.Index == idx);\n                    if (map == null)\n                    {\n                        row.Parameters.Add(new TemplateParamResolutionDto\n                        {\n                            Index = idx,\n                            Value = null,\n                            IsMissing = true,\n                            SourceType = \"Unmapped\",\n                            Note = \"No variable map for this placeholder.\"\n                        });\n                        continue;\n                    }\n\n                    var (value, isMissing, note) = ResolveValue(map, r);\n                    row.Parameters.Add(new TemplateParamResolutionDto\n                    {\n                        Index = idx,\n                        Value = value,\n                        IsMissing = isMissing,\n                        SourceType = map.SourceType ?? string.Empty,\n                        SourceKey = map.SourceKey\n                    });\n\n                    if (!string.IsNullOrWhiteSpace(note))\n                        row.Warnings.Add($\"{{{{{idx}}}}}: {note}\");\n                }\n\n                // Buttons: mirror live send behavior for dynamic URL buttons (index 0..2)\n                if (liveMeta?.ButtonParams != null && liveMeta.ButtonParams.Count > 0 && orderedButtons.Count > 0)\n                {\n                    var total = Math.Min(3, Math.Min(orderedButtons.Count, liveMeta.ButtonParams.Count));\n\n                    for (int i = 0; i < total; i++)\n                    {\n                        var metaBtn = liveMeta.ButtonParams[i];\n                        var subType = (metaBtn.SubType ?? \"url\").ToLowerInvariant();\n                        var metaParam = metaBtn.ParameterValue?.Trim();\n\n                        var br = new ButtonResolutionDto\n                        {\n                            ButtonText = orderedButtons[i]?.Title ?? string.Empty,\n                            RawTemplateValue = orderedButtons[i]?.Value\n                        };\n\n                        // We only handle dynamic URL buttons here (consistent with send logic)\n                        if (!string.Equals(subType, \"url\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            br.Notes.Add(\"Non-URL button (no dynamic resolution).\");\n                            row.Buttons.Add(br);\n                            continue;\n                        }\n\n                        var isDynamic = !string.IsNullOrWhiteSpace(metaParam) && metaParam.Contains(\"{{\");\n                        if (!isDynamic)\n                        {\n                            br.Notes.Add(\"Static URL button (no parameters required by template).\");\n                            row.Buttons.Add(br);\n                            continue;\n                        }\n\n                        var btn = orderedButtons[i];\n                        var btnType = (btn?.Type ?? \"URL\").ToUpperInvariant();\n                        if (!string.Equals(btnType, \"URL\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            br.Notes.Add($\"Template expects a dynamic URL at index {i}, but campaign button type is '{btn?.Type}'.\");\n                            row.Buttons.Add(br);\n                            continue;\n                        }\n\n                        var valueRaw = btn?.Value?.Trim();\n                        if (string.IsNullOrWhiteSpace(valueRaw))\n                        {\n                            br.Notes.Add($\"Template requires a dynamic URL at index {i}, but campaign button value is empty.\");\n                            br.MissingArguments.Add(\"{{1}}\");\n                            row.Buttons.Add(br);\n                            continue;\n                        }\n\n                        // optional phone substitution into destination\n                        var phone = row.Phone ?? \"\";\n                        var encodedPhone = Uri.EscapeDataString(phone);\n\n                        var resolvedDestination = valueRaw.Contains(\"{{1}}\")\n                            ? valueRaw.Replace(\"{{1}}\", encodedPhone)\n                            : valueRaw;\n\n                        // normalize/validate URL (allow tel:, wa:, wa.me links)\n                        try\n                        {\n                            resolvedDestination = NormalizeAbsoluteUrlOrThrowForButton(resolvedDestination, btn!.Title ?? $\"Button {i + 1}\", i);\n                        }\n                        catch (Exception ex)\n                        {\n                            br.Notes.Add($\"Destination invalid: {ex.Message}\");\n                            row.Buttons.Add(br);\n                            continue;\n                        }\n\n                        // Build both styles and pick based on template absolute base rule\n                        var fakeSendLogId = Guid.NewGuid(); // preview-only tokenization\n                        var fullTrackedUrl = _urlBuilderService.BuildTrackedButtonUrl(\n                            fakeSendLogId, i, btn!.Title, resolvedDestination);\n\n                        var tokenParam = BuildTokenParam(fakeSendLogId, i, btn.Title, resolvedDestination);\n\n                        var templateHasAbsoluteBase = LooksLikeAbsoluteBaseUrlWithPlaceholder(metaParam);\n                        var valueToSend = templateHasAbsoluteBase ? tokenParam : fullTrackedUrl;\n\n                        br.UsedPlaceholders.Add(\"{{1}}\"); // meta indicates dynamic\n                        br.ResolvedUrl = valueToSend;\n                        row.Buttons.Add(br);\n                    }\n                }\n                else\n                {\n                    // no dynamic buttons in template\n                }\n\n                // Basic phone sanity\n                if (string.IsNullOrWhiteSpace(row.Phone))\n                    row.Errors.Add(\"Phone is missing.\");\n                else if (!IsLikelyPhone(row.Phone))\n                    row.Warnings.Add(\"Phone format looks unusual.\");\n\n                result.Rows.Add(row);\n            }\n\n            result.ReturnedCount = result.Rows.Count;\n            result.ErrorCount = result.Rows.Sum(r => r.Errors.Count);\n            result.WarningCount = result.Rows.Sum(r => r.Warnings.Count)\n                                  + result.Rows.Sum(r => r.Parameters.Count(p => p.IsMissing));\n\n            Log.Information(\"Campaign materialization computed {@Summary}\",\n                new\n                {\n                    campaignId,\n                    businessId,\n                    result.ReturnedCount,\n                    result.ErrorCount,\n                    result.WarningCount,\n                    result.PlaceholderCount,\n                    result.TemplateName,\n                    result.Language\n                });\n\n            return result;\n        }\n\n\n        // --- Helpers (mirror your send logic where relevant) ---\n\n        private static (string? value, bool isMissing, string? note) ResolveValue(\n            CampaignVariableMap map,\n            CampaignRecipient recipient)\n        {\n            var source = (map.SourceType ?? \"\").Trim();\n\n            switch (source)\n            {\n                case \"Static\":\n                    {\n                        var v = map.StaticValue;\n                        var missing = string.IsNullOrWhiteSpace(v) && map.IsRequired;\n                        return (v, missing, missing ? \"Required static value missing.\" : null);\n                    }\n\n                case \"Expression\":\n                    {\n                        // no eval engine; use DefaultValue if provided\n                        var v = map.DefaultValue;\n                        var note = \"Expression present; no evaluation engine configured. Used DefaultValue.\";\n                        var missing = string.IsNullOrWhiteSpace(v) && map.IsRequired;\n                        return (v, missing, missing ? \"Required expression result missing (no default provided).\" : note);\n                    }\n\n                case \"AudienceColumn\":\n                    {\n                        // Current CampaignRecipient shape doesn't carry Audience/CSV row data.\n                        // If you later link AudienceMember.AttributesJson here, resolve from it.\n                        var v = map.DefaultValue;\n                        var missing = string.IsNullOrWhiteSpace(v) && map.IsRequired;\n                        return (v, missing, \"Audience/CSV source not available on CampaignRecipient; used DefaultValue.\");\n                    }\n\n                default:\n                    {\n                        var v = map.DefaultValue;\n                        var missing = string.IsNullOrWhiteSpace(v) && map.IsRequired;\n                        return (v, missing, missing ? \"Unrecognized mapping type and no default.\" : \"Unrecognized mapping type; used DefaultValue.\");\n                    }\n            }\n        }\n\n        private static string NormalizePhone(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return \"\";\n            var p = raw.Trim();\n            if (!p.StartsWith(\"+\")) p = \"+\" + new string(p.Where(char.IsDigit).ToArray());\n            return p;\n        }\n\n        private static bool IsLikelyPhone(string? s)\n        {\n            if (string.IsNullOrWhiteSpace(s)) return false;\n            var digits = s.Count(char.IsDigit);\n            return digits >= 10 && digits <= 15;\n        }\n\n        private static string NormalizeAbsoluteUrlOrThrowForButton(string input, string buttonTitle, int buttonIndex)\n        {\n            if (string.IsNullOrWhiteSpace(input))\n                throw new ArgumentException($\"Destination is required for button '{buttonTitle}' (index {buttonIndex}).\");\n\n            var cleaned = new string(input.Trim().Where(c => !char.IsControl(c)).ToArray());\n            if (cleaned.Length == 0)\n                throw new ArgumentException($\"Destination is required for button '{buttonTitle}' (index {buttonIndex}).\");\n\n            // Accept tel: / wa: / wa.me deep links\n            if (cleaned.StartsWith(\"tel:\", StringComparison.OrdinalIgnoreCase) ||\n                cleaned.StartsWith(\"wa:\", StringComparison.OrdinalIgnoreCase) ||\n                cleaned.StartsWith(\"https://wa.me/\", StringComparison.OrdinalIgnoreCase))\n            {\n                return cleaned;\n            }\n\n            if (Uri.TryCreate(cleaned, UriKind.Absolute, out var uri) &&\n                (uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                 uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase)))\n            {\n                return uri.ToString();\n            }\n\n            throw new ArgumentException(\n                $\"Destination must be an absolute http/https/tel/wa URL for button '{buttonTitle}' (index {buttonIndex}). Got: '{input}'\");\n        }\n\n        private static bool LooksLikeAbsoluteBaseUrlWithPlaceholder(string? templateUrl)\n        {\n            if (string.IsNullOrWhiteSpace(templateUrl)) return false;\n            var s = templateUrl.Trim();\n            if (!s.Contains(\"{{\")) return false;\n            var probe = s.Replace(\"{{1}}\", \"x\").Replace(\"{{0}}\", \"x\");\n            return Uri.TryCreate(probe, UriKind.Absolute, out var abs) &&\n                   (abs.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                    abs.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase));\n        }\n\n        private string BuildTokenParam(Guid campaignSendLogId, int buttonIndex, string? buttonTitle, string destinationUrlAbsolute)\n        {\n            var full = _urlBuilderService.BuildTrackedButtonUrl(campaignSendLogId, buttonIndex, buttonTitle, destinationUrlAbsolute);\n            var pos = full.LastIndexOf(\"/r/\", StringComparison.OrdinalIgnoreCase);\n            return (pos >= 0) ? full[(pos + 3)..] : full;\n        }\n\n        private sealed record ResolvedTemplateMeta(string TemplateName, string Language, int PlaceholderCount);\n\n       \n\n        private static int CountPlaceholders(string? text)\n        {\n            if (string.IsNullOrWhiteSpace(text)) return 0;\n            // matches {{1}}, {{ 2 }}, etc.\n            return Regex.Matches(text, @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count;\n        }\n\n        private async Task<ResolvedTemplateMeta> ResolveTemplateMetaAsync(\n            Campaign campaign,\n            Guid businessId,\n            CancellationToken ct)\n        {\n            string templateName = string.Empty;\n            string language = \"en\";\n            int placeholderCount = 0;\n\n            // 1) Snapshot first (if stored)\n            if (!string.IsNullOrWhiteSpace(campaign.TemplateSchemaSnapshot))\n            {\n                try\n                {\n                    using var doc = JsonDocument.Parse(campaign.TemplateSchemaSnapshot);\n                    var root = doc.RootElement;\n\n                    if (root.TryGetProperty(\"name\", out var n) && n.ValueKind == JsonValueKind.String)\n                        templateName = n.GetString() ?? string.Empty;\n\n                    if (root.TryGetProperty(\"language\", out var l) && l.ValueKind == JsonValueKind.String)\n                        language = l.GetString() ?? \"en\";\n\n                    if (root.TryGetProperty(\"placeholderCount\", out var pc) && pc.TryGetInt32(out var snapCount))\n                        placeholderCount = snapCount;\n                }\n                catch { /* non-fatal */ }\n            }\n\n            // 2) Prefer stored TemplateParameters count if present\n            if (!string.IsNullOrWhiteSpace(campaign.TemplateParameters))\n            {\n                try\n                {\n                    var arr = JsonSerializer.Deserialize<List<string>>(campaign.TemplateParameters) ?? new();\n                    placeholderCount = Math.Max(placeholderCount, arr.Count);\n                }\n                catch { /* ignore bad param JSON */ }\n            }\n\n            // 3) If name still missing, use MessageTemplate as canonical name (fall back to TemplateId)\n            if (string.IsNullOrWhiteSpace(templateName))\n                templateName = campaign.MessageTemplate ?? campaign.TemplateId ?? string.Empty;\n\n            // 4) Fallback to live metadata if essentials missing\n            if (placeholderCount <= 0 || string.IsNullOrWhiteSpace(templateName))\n            {\n                try\n                {\n                    var live = await _templateFetcher.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n                    if (live != null)\n                    {\n                        if (string.IsNullOrWhiteSpace(templateName) && !string.IsNullOrWhiteSpace(live.Name))\n                            templateName = live.Name!;\n                        if (!string.IsNullOrWhiteSpace(live.Language))\n                            language = live.Language!;\n\n                        // Your TemplateMetadataDto exposes PlaceholderCount and Body (no .Parameters)\n                        var liveCount = live.PlaceholderCount > 0\n                            ? live.PlaceholderCount\n                            : CountPlaceholders(live.Body);\n\n                        placeholderCount = Math.Max(placeholderCount, liveCount);\n                    }\n                }\n                catch (Exception ex)\n                {\n                    Log.Warning(ex, \"Live template meta fetch failed for {Template}/{Lang}\", templateName, language);\n                }\n            }\n\n            if (string.IsNullOrWhiteSpace(language)) language = \"en\";\n            if (placeholderCount < 0) placeholderCount = 0;\n\n            return new ResolvedTemplateMeta(templateName, language, placeholderCount);\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignMaterializer.cs",
      "sha256": "ca19d82cd07cc479f0f0a77b326a15f30c159981f9644e928fe93f94f3a12996",
      "language": "csharp",
      "size": 26822,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Security.Cryptography;\nusing System.Text;\nusing System.Text.Json;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Helpers;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n\n    public sealed class CampaignMaterializer : ICampaignMaterializer\n    {\n        private readonly AppDbContext _db;\n        private readonly IVariableResolver _resolver;\n\n        // Common phone header candidates (case-insensitive)\n        private static readonly string[] PhoneHeaderCandidates =\n        {\n            \"phone\", \"mobile\", \"whatsapp\", \"msisdn\", \"whatsapp_number\", \"contact\", \"contact_number\"\n        };\n\n        public CampaignMaterializer(AppDbContext db, IVariableResolver resolver)\n        {\n            _db = db;\n            _resolver = resolver;\n        }\n       \n        private static Dictionary<string, string> BuildAutoMappingsFromRow(\n            IDictionary<string, string> rowDict,\n            int requiredBodySlots,\n            IReadOnlyCollection<string>? namedBodyTokens = null)\n        {\n            var map = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n            // 1) BODY (positional)\n            int n = requiredBodySlots > 0\n                ? requiredBodySlots\n                : rowDict.Keys.Select(k =>\n                {\n                    var m = System.Text.RegularExpressions.Regex.Match(k, @\"^parameter(\\d+)$\", System.Text.RegularExpressions.RegexOptions.IgnoreCase);\n                    return m.Success ? int.Parse(m.Groups[1].Value) : 0;\n                }).DefaultIfEmpty(0).Max();\n\n            for (int i = 1; i <= n; i++)\n            {\n                var csvHeader = rowDict.Keys.FirstOrDefault(k => string.Equals(k, $\"parameter{i}\", StringComparison.OrdinalIgnoreCase));\n                if (!string.IsNullOrWhiteSpace(csvHeader))\n                    map[$\"{{{{{i}}}}}\"] = csvHeader; // -> {{i}}\n            }\n\n            // 1b) BODY (named): if template has named tokens and CSV has columns with those names\n            if (namedBodyTokens != null && namedBodyTokens.Count > 0)\n            {\n                foreach (var token in namedBodyTokens)\n                {\n                    // look for a column exactly named as token (case-insensitive)\n                    var csvHeader = rowDict.Keys.FirstOrDefault(k => string.Equals(k, token, StringComparison.OrdinalIgnoreCase));\n                    if (!string.IsNullOrWhiteSpace(csvHeader))\n                    {\n                        // map \"{{token}}\" -> that column\n                        map[$\"{{{{{token}}}}}\"] = csvHeader;\n                    }\n                }\n            }\n\n            // 2) HEADER (text) variables: headerparaN -> header.text_paramN\n            foreach (var kv in rowDict)\n            {\n                var m = System.Text.RegularExpressions.Regex.Match(kv.Key, @\"^headerpara(\\d+)$\", System.Text.RegularExpressions.RegexOptions.IgnoreCase);\n                if (m.Success)\n                {\n                    var slot = int.Parse(m.Groups[1].Value);\n                    map[$\"header.text_param{slot}\"] = kv.Key;\n                }\n            }\n\n            // 3) dynamic URL buttons: buttonparaN -> buttonN.url_param\n            foreach (var kv in rowDict)\n            {\n                var m = System.Text.RegularExpressions.Regex.Match(kv.Key, @\"^buttonpara(\\d+)$\", System.Text.RegularExpressions.RegexOptions.IgnoreCase);\n                if (m.Success)\n                {\n                    var pos = int.Parse(m.Groups[1].Value);\n                    if (pos >= 1 && pos <= 3)\n                        map[$\"button{pos}.url_param\"] = kv.Key;\n                }\n            }\n\n            return map;\n        }\n\n\n        private async Task<int> GetRequiredBodySlotsAsync(Guid businessId, Guid campaignId, CancellationToken ct)\n        {\n            // Get campaign’s saved template identifiers\n            var snap = await _db.Campaigns\n                .AsNoTracking()\n                .Where(c => c.Id == campaignId && c.BusinessId == businessId)\n                .Select(c => new { c.TemplateId, c.MessageTemplate })\n                .FirstOrDefaultAsync(ct);\n\n            if (snap is null) return 0;\n\n            WhatsAppTemplate? tpl = null;\n\n            // 1) Prefer exact provider id match (TemplateId)\n            if (!string.IsNullOrWhiteSpace(snap.TemplateId))\n            {\n                tpl = await _db.WhatsAppTemplates\n                    .AsNoTracking()\n                    .Where(t => t.BusinessId == businessId &&\n                                t.IsActive &&\n                                t.TemplateId == snap.TemplateId)\n                    .OrderByDescending(t => t.UpdatedAt > t.CreatedAt ? t.UpdatedAt : t.CreatedAt)\n                    .FirstOrDefaultAsync(ct);\n            }\n\n            // 2) Fallback: match by template Name (MessageTemplate)\n            if (tpl is null && !string.IsNullOrWhiteSpace(snap.MessageTemplate))\n            {\n                tpl = await _db.WhatsAppTemplates\n                    .AsNoTracking()\n                    .Where(t => t.BusinessId == businessId &&\n                                t.IsActive &&\n                                t.Name == snap.MessageTemplate)\n                    .OrderByDescending(t => t.UpdatedAt > t.CreatedAt ? t.UpdatedAt : t.CreatedAt)\n                    .FirstOrDefaultAsync(ct);\n            }\n\n            // BODY slots only. If you need header+buttons too, use TotalTextParamCount instead.\n            return tpl?.BodyVarCount ?? 0;\n        }\n\n\n        private static string[]? EnsureBodyParamsComplete(string[] bodyParams, int requiredSlots, out List<string> missing)\n        {\n            missing = new List<string>();\n            if (requiredSlots <= 0) return bodyParams; // nothing to enforce\n\n            // Resize to requiredSlots\n            var arr = new string[requiredSlots];\n            for (int i = 0; i < requiredSlots; i++)\n            {\n                var v = (i < bodyParams.Length ? bodyParams[i] : string.Empty) ?? string.Empty;\n                arr[i] = v;\n                if (string.IsNullOrWhiteSpace(v))\n                    missing.Add($\"{{{{{i + 1}}}}}\");\n            }\n\n            if (missing.Count > 0)\n                return null;\n\n            return arr;\n        }\n\n        // File: Features/CampaignModule/Services/CampaignMaterializer.cs\n        // Method: CreateAsync(...)\n        // NOTE: This version is identical to yours except we pull `requiredBodySlots` ONCE before the foreach.\n        //       Everything else remains the same (including the enforcement you added).\n\n        public async Task<CampaignCsvMaterializeResponseDto> CreateAsync(\n       Guid businessId,\n       Guid campaignId,\n       CampaignCsvMaterializeRequestDto request,\n       CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"Invalid campaign id.\");\n            if (request is null) throw new ArgumentNullException(nameof(request));\n            if (request.CsvBatchId == Guid.Empty) throw new ArgumentException(\"CsvBatchId is required.\");\n            if (request.Persist && string.IsNullOrWhiteSpace(request.AudienceName))\n                throw new ArgumentException(\"AudienceName is required when Persist=true.\");\n\n            // Campaign ownership check\n            var owns = await _db.Campaigns\n                .AsNoTracking()\n                .AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n            if (!owns) throw new UnauthorizedAccessException(\"Campaign not found or not owned by this business.\");\n\n            // Load CSV rows for the batch\n            var rowsQuery = _db.CsvRows\n                .AsNoTracking()\n                .Where(r => r.BusinessId == businessId && r.BatchId == request.CsvBatchId)\n                .OrderBy(r => r.RowIndex);\n\n            var totalRows = await rowsQuery.CountAsync(ct);\n            var csvRows = (request.Limit.HasValue && request.Limit.Value > 0)\n                ? await rowsQuery.Take(request.Limit.Value).ToListAsync(ct)\n                : await rowsQuery.ToListAsync(ct);\n\n            var resp = new CampaignCsvMaterializeResponseDto\n            {\n                CampaignId = campaignId,\n                CsvBatchId = request.CsvBatchId,\n                TotalRows = totalRows\n            };\n\n            // Build header set to help autodetect phone field\n            var headerSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n            foreach (var r in csvRows)\n            {\n                foreach (var k in JsonToDict(r.DataJson).Keys)\n                    headerSet.Add(k);\n            }\n\n            // Mapping precedence: request → fallback header==token\n            var effectiveMappings = request.Mappings ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n            // Determine phone field\n            var phoneField = request.PhoneField;\n            if (string.IsNullOrWhiteSpace(phoneField))\n                phoneField = PhoneHeaderCandidates.FirstOrDefault(headerSet.Contains);\n\n            if (string.IsNullOrWhiteSpace(phoneField))\n                resp.Warnings.Add(\"No phone field provided or detected; rows without phone will be skipped.\");\n\n            // 🔎 Pull required body slots ONCE (avoid N queries)\n            var requiredBodySlots = await GetRequiredBodySlotsAsync(businessId, campaignId, ct);\n\n            // 🔎 NEW: pull named BODY tokens ONCE (e.g., first_name, slug) for auto-mapping\n            var namedBodyTokens = await GetNamedBodyTokensAsync(businessId, campaignId, ct);\n\n            var seenPhones = new HashSet<string>(StringComparer.Ordinal);\n            var preview = resp.Preview; // alias\n\n            foreach (var row in csvRows)\n            {\n                ct.ThrowIfCancellationRequested();\n\n                var rowDict = JsonToDict(row.DataJson);\n                var m = new CsvMaterializedRowDto { RowIndex = row.RowIndex };\n\n                // 🧭 effective mappings: request.Mappings OR auto-infer from row\n                var mappingsToUse =\n                    (effectiveMappings != null && effectiveMappings.Count > 0)\n                        ? new Dictionary<string, string>(effectiveMappings, StringComparer.OrdinalIgnoreCase)\n                        // NEW: include namedBodyTokens so CSV columns like \"slug\" map to {{slug}}\n                        : BuildAutoMappingsFromRow(rowDict, requiredBodySlots, namedBodyTokens);\n\n                // Variables for template (canonicalized by resolver)\n                m.Variables = _resolver.ResolveVariables(rowDict, mappingsToUse);\n\n                // Phone selection\n                string? phone = null;\n                if (!string.IsNullOrWhiteSpace(phoneField))\n                {\n                    rowDict.TryGetValue(phoneField, out phone);\n                }\n                else\n                {\n                    foreach (var cand in PhoneHeaderCandidates)\n                        if (rowDict.TryGetValue(cand, out phone) && !string.IsNullOrWhiteSpace(phone))\n                            break;\n                }\n\n                phone = NormalizePhoneMaybe(phone, request.NormalizePhones);\n                m.Phone = phone;\n\n                if (string.IsNullOrWhiteSpace(m.Phone))\n                {\n                    m.Errors.Add(\"Missing phone\");\n                    resp.SkippedCount++;\n                    continue;\n                }\n\n                if (request.Deduplicate && !seenPhones.Add(m.Phone))\n                {\n                    m.Errors.Add(\"Duplicate phone (deduped)\");\n                    resp.SkippedCount++;\n                    continue;\n                }\n\n                // 🔒 Enforce required body placeholders BEFORE adding to preview\n                var prelimBodyParams = BuildBodyParamArrayFromVariables(\n                    m.Variables ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase));\n\n                var enforced = EnsureBodyParamsComplete(prelimBodyParams, requiredBodySlots, out var missingSlots);\n                if (enforced == null)\n                {\n                    // at least one required slot missing → skip this row\n                    m.Errors.Add($\"Missing body parameters: {string.Join(\", \", missingSlots)}\");\n                    resp.SkippedCount++;\n                    continue;\n                }\n\n                // (Optional) keep for troubleshooting:\n                // m.DebugBodyParams = enforced;\n\n                preview.Add(m);\n            }\n\n            resp.MaterializedCount = preview.Count;\n\n            // Persist if requested\n            if (request.Persist && resp.MaterializedCount > 0)\n            {\n                var audienceId = await PersistAudienceAndRecipientsAsync(\n                    businessId, campaignId, request.AudienceName!, preview, ct);\n\n                resp.AudienceId = audienceId;\n            }\n\n            return resp;\n        }\n\n\n\n        private static string[] BuildBodyParamArrayFromVariables(IDictionary<string, string> vars)\n        {\n            var pairs = new List<(int idx, string val)>();\n\n            foreach (var kv in vars)\n            {\n                var k = kv.Key ?? string.Empty;\n                var v = kv.Value ?? string.Empty;\n\n                // 1) body.N\n                if (k.StartsWith(\"body.\", StringComparison.OrdinalIgnoreCase))\n                {\n                    if (int.TryParse(k.AsSpan(\"body.\".Length), out var n) && n > 0)\n                        pairs.Add((n, v));\n                    continue;\n                }\n\n                // 2) parameterN (FE mapping keys)\n                if (k.StartsWith(\"parameter\", StringComparison.OrdinalIgnoreCase))\n                {\n                    if (int.TryParse(k.AsSpan(\"parameter\".Length), out var n) && n > 0)\n                        pairs.Add((n, v));\n                    continue;\n                }\n\n                // 3) {{N}} (auto-mapper tokens)\n                // match exactly {{  number  }}\n                var m = System.Text.RegularExpressions.Regex.Match(k, @\"^\\{\\{\\s*(\\d+)\\s*\\}\\}$\");\n                if (m.Success && int.TryParse(m.Groups[1].Value, out var t) && t > 0)\n                {\n                    pairs.Add((t, v));\n                    continue;\n                }\n            }\n\n            if (pairs.Count == 0) return Array.Empty<string>();\n\n            var max = pairs.Max(p => p.idx);\n            var arr = new string[max];\n            for (int i = 0; i < max; i++) arr[i] = string.Empty;\n            foreach (var (idx, val) in pairs) arr[idx - 1] = val ?? string.Empty;\n            return arr;\n        }\n\n        private async Task<Guid> PersistAudienceAndRecipientsAsync(\n            Guid businessId,\n            Guid campaignId,\n            string audienceName,\n            List<CsvMaterializedRowDto> rows,\n            CancellationToken ct)\n        {\n            await using var tx = await _db.Database.BeginTransactionAsync(ct);\n            try\n            {\n                var now = DateTime.UtcNow;\n\n                var audience = new Audience\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Name = audienceName,\n                    CreatedAt = now,\n                    UpdatedAt = now\n                };\n                _db.Audiences.Add(audience);\n\n                // --- local helpers --------------------------------------------------\n                static string[] BuildBodyParamArray(IDictionary<string, string> vars)\n                {\n                    // Accept both \"body.N\" and \"parameterN\"\n                    var pairs = new List<(int idx, string val)>();\n\n                    foreach (var kv in vars)\n                    {\n                        var k = kv.Key;\n\n                        // body.N\n                        if (k.StartsWith(\"body.\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            if (int.TryParse(k.AsSpan(\"body.\".Length), out var n) && n > 0)\n                                pairs.Add((n, kv.Value ?? string.Empty));\n                            continue;\n                        }\n\n                        // parameterN (compat)\n                        if (k.StartsWith(\"parameter\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            if (int.TryParse(k.AsSpan(\"parameter\".Length), out var n) && n > 0)\n                                pairs.Add((n, kv.Value ?? string.Empty));\n                        }\n                    }\n\n                    if (pairs.Count == 0) return Array.Empty<string>();\n\n                    var max = pairs.Max(p => p.idx);\n                    var arr = new string[max];\n                    for (int i = 0; i < max; i++) arr[i] = string.Empty;\n                    foreach (var (idx, val) in pairs) arr[idx - 1] = val ?? string.Empty;\n                    return arr;\n                }\n\n                static Dictionary<string, string> BuildHeaderAndButtonVars(IDictionary<string, string> vars)\n                {\n                    // We store non-body keys in ResolvedButtonUrlsJson (generic bag):\n                    // - header.image_url / header.video_url / header.document_url\n                    // - header.text.N\n                    // - button{1..3}.url_param\n                    var dict = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n                    foreach (var kv in vars)\n                    {\n                        var k = kv.Key;\n                        var v = kv.Value ?? string.Empty;\n\n                        // header media urls\n                        if (k.StartsWith(\"header.\", StringComparison.OrdinalIgnoreCase) &&\n                           (k.EndsWith(\"_url\", StringComparison.OrdinalIgnoreCase) ||\n                            k.EndsWith(\".url\", StringComparison.OrdinalIgnoreCase)))\n                        {\n                            dict[k] = v;\n                            continue;\n                        }\n\n                        // header text placeholders: header.text.N\n                        if (k.StartsWith(\"header.text.\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            var tail = k.Substring(\"header.text.\".Length);\n                            if (int.TryParse(tail, out var n) && n > 0)\n                                dict[k] = v;\n                            continue;\n                        }\n\n                        // URL button param variants → normalize to .url_param\n                        if (k.StartsWith(\"button\", StringComparison.OrdinalIgnoreCase))\n                        {\n                            var normKey = k\n                                .Replace(\".url.param\", \".url_param\", StringComparison.OrdinalIgnoreCase)\n                                .Replace(\".urlparam\", \".url_param\", StringComparison.OrdinalIgnoreCase);\n\n                            if (normKey.EndsWith(\".url_param\", StringComparison.OrdinalIgnoreCase))\n                                dict[normKey] = v;\n                        }\n                    }\n\n                    return dict;\n                }\n                // --------------------------------------------------------------------\n\n                foreach (var r in rows)\n                {\n                    if (string.IsNullOrWhiteSpace(r.Phone))\n                        continue; // safety; missing phone rows were already filtered\n\n                    // Try to link to an existing Contact by normalized phone\n                    Guid? contactId = await _db.Contacts\n                        .Where(c => c.BusinessId == businessId && c.PhoneNumber == r.Phone)\n                        .Select(c => (Guid?)c.Id)\n                        .FirstOrDefaultAsync(ct);\n\n                    var variables = r.Variables ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n                    // Keep full variable map on AudienceMember for export/debug\n                    var attributesJson = JsonSerializer.Serialize(variables);\n\n                    // Shapes expected by sender:\n                    var bodyParams = BuildBodyParamArray(variables);            // string[] for {{1}}..{{N}}\n                    var headerAndButtons = BuildHeaderAndButtonVars(variables); // dict for header.* + button*.url_param\n\n                    var resolvedParamsJson = JsonSerializer.Serialize(bodyParams);\n                    var resolvedButtonsJson = JsonSerializer.Serialize(headerAndButtons);\n\n                    // Idempotency: include both body params and header/button vars\n                    var idemPayload = JsonSerializer.Serialize(new { p = bodyParams, b = headerAndButtons });\n                    var idempotencyKey = ComputeIdempotencyKey(campaignId, r.Phone, idemPayload);\n\n                    var member = new AudienceMember\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        AudienceId = audience.Id,\n                        ContactId = contactId,                 // stays null if no match\n                        PhoneE164 = r.Phone,                   // normalized earlier\n                        AttributesJson = attributesJson,\n                        IsTransientContact = !contactId.HasValue,\n                        CreatedAt = now,\n                        UpdatedAt = now\n                    };\n                    _db.AudienceMembers.Add(member);\n\n                    var recipient = new CampaignRecipient\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        CampaignId = campaignId,\n                        AudienceMemberId = member.Id,\n                        IdempotencyKey = idempotencyKey,\n                        ResolvedParametersJson = resolvedParamsJson,   // string[] (body)\n                        ResolvedButtonUrlsJson = resolvedButtonsJson,  // dict (header + buttons)\n                        MaterializedAt = now,\n                        Status = \"Pending\",\n                        UpdatedAt = now\n                    };\n\n                    if (contactId.HasValue)\n                        recipient.ContactId = contactId.Value;\n\n                    _db.CampaignRecipients.Add(recipient);\n                }\n\n                await _db.SaveChangesAsync(ct);\n                await tx.CommitAsync(ct);\n                return audience.Id;\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Materialize persist failed\");\n                await tx.RollbackAsync(ct);\n                throw;\n            }\n        }\n\n\n        // ---------- Utils ----------\n        private static Dictionary<string, string> JsonToDict(string? json)\n        {\n            var dict = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            if (string.IsNullOrWhiteSpace(json)) return dict;\n\n            using var doc = JsonDocument.Parse(json);\n            if (doc.RootElement.ValueKind != JsonValueKind.Object) return dict;\n            foreach (var p in doc.RootElement.EnumerateObject())\n                dict[p.Name] = p.Value.ValueKind == JsonValueKind.Null ? \"\" : p.Value.ToString();\n\n            return dict;\n        }\n\n       \n        private static string NormalizePhoneMaybe(string? raw, bool normalize)\n        {\n            var s = raw?.Trim();\n            if (string.IsNullOrWhiteSpace(s)) return string.Empty;\n\n            // Keep digits only\n            var digits = new string(s.Where(char.IsDigit).ToArray());\n            if (digits.Length == 0) return string.Empty;\n\n            if (normalize)\n            {\n                // Preserve your current behavior for now (we'll make this country-aware in STEP 2):\n                // If it \"looks like\" a local Indian number (10 digits), prepend 91.\n                if (digits.Length == 10)\n                    digits = \"91\" + digits;\n                // Else leave as-is (assumed to already include country code).\n            }\n\n            // Ensure we store E.164 with '+' (DB and downstream should always see '+')\n            return \"+\" + digits;\n        }\n\n        private static string ComputeIdempotencyKey(Guid campaignId, string phone, string parametersJson)\n        {\n            var raw = $\"{campaignId}|{phone}|{parametersJson}\";\n            using var sha = SHA256.Create();\n            var bytes = sha.ComputeHash(Encoding.UTF8.GetBytes(raw));\n            return Convert.ToHexString(bytes);\n        }\n\n        // NEW: fetch named BODY tokens by parsing WhatsAppTemplate.RawJson canonically.\n        private async Task<IReadOnlyList<string>> GetNamedBodyTokensAsync(Guid businessId, Guid campaignId, CancellationToken ct)\n        {\n            var data = await _db.Campaigns\n                .AsNoTracking()\n                .Where(c => c.Id == campaignId && c.BusinessId == businessId)\n                .Select(c => new { c.MessageTemplate, c.TemplateId })\n                .FirstOrDefaultAsync(ct);\n\n            var templateName = !string.IsNullOrWhiteSpace(data?.TemplateId)\n                ? data!.TemplateId!\n                : (data?.MessageTemplate ?? string.Empty);\n\n            if (string.IsNullOrWhiteSpace(templateName))\n                return Array.Empty<string>();\n\n            var tpl = await _db.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.IsActive && t.Name == templateName)\n                .OrderByDescending(t => t.UpdatedAt > t.CreatedAt ? t.UpdatedAt : t.CreatedAt)\n                .FirstOrDefaultAsync(ct);\n\n            if (tpl == null) return Array.Empty<string>();\n\n            var summary = xbytechat.api.WhatsAppSettings.Helpers.TemplateJsonHelper\n                .SummarizeDetailed(tpl.RawJson, tpl.Body);\n\n            var names = summary.Placeholders\n                .Where(p => p.Location == xbytechat.api.WhatsAppSettings.Helpers.PlaceholderLocation.Body\n                         && p.Type == xbytechat.api.WhatsAppSettings.Helpers.PlaceholderType.Named)\n                .Select(p => p.Name!)\n                .Where(n => !string.IsNullOrWhiteSpace(n))\n                .Distinct(StringComparer.OrdinalIgnoreCase)\n                .OrderBy(n => n, StringComparer.OrdinalIgnoreCase)\n                .ToList();\n\n            return names;\n        }\n\n    }\n}\n\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignPreviewService.cs",
      "sha256": "f22c3c48656b000ef7cae70e285c577aeca2d1a1e68f34053854c8c676622b3d",
      "language": "csharp",
      "size": 11562,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog; // ✅ use Serilog like the rest of your services\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Services;\nusing xbytechat.api.Features.Tracking.Services;\nusing xbytechat.api.Shared.utility;\nusing xbytechat.api.Features.CRM.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignPreviewService\n    {\n        Task<CampaignPreviewResponseDto> PreviewAsync(Guid businessId, Guid campaignId, Guid? contactId);\n    }\n\n    public class CampaignPreviewService : ICampaignPreviewService\n    {\n        private readonly AppDbContext _db;\n        private readonly IWhatsAppTemplateFetcherService _templateFetcher;\n        private readonly IUrlBuilderService _urlBuilder;\n\n        public CampaignPreviewService(\n            AppDbContext db,\n            IWhatsAppTemplateFetcherService templateFetcher,\n            IUrlBuilderService urlBuilder)\n        {\n            _db = db;\n            _templateFetcher = templateFetcher;\n            _urlBuilder = urlBuilder;\n        }\n\n        public async Task<CampaignPreviewResponseDto> PreviewAsync(Guid businessId, Guid campaignId, Guid? contactId)\n        {\n            try\n            {\n                Log.Information(\"🧪 Preview start | biz={BusinessId} campaign={CampaignId} contactId={ContactId}\",\n                    businessId, campaignId, contactId);\n\n                var campaign = await _db.Campaigns\n                    .AsNoTracking()\n                    .Include(c => c.MultiButtons)\n                    .Include(c => c.Recipients).ThenInclude(r => r.Contact)\n                    .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n\n                if (campaign == null)\n                {\n                    Log.Warning(\"❌ Preview aborted: campaign not found | biz={BusinessId} campaign={CampaignId}\",\n                        businessId, campaignId);\n                    throw new InvalidOperationException(\"Campaign not found.\");\n                }\n\n                // Resolve template name (respect flow entry if any)\n                var templateName = await ResolveStartTemplateName(businessId, campaign);\n                Log.Information(\"🔎 Preview resolved template | campaign={CampaignId} template={TemplateName}\",\n                    campaign.Id, templateName);\n\n                // Fetch template meta (body/buttons/lang/header)\n                var meta = await _templateFetcher.GetTemplateByNameAsync(businessId, templateName, includeButtons: true);\n                if (meta == null)\n                {\n                    Log.Warning(\"❌ Preview aborted: template metadata not found | biz={BusinessId} template={TemplateName}\",\n                        businessId, templateName);\n                    throw new InvalidOperationException(\"Template metadata not found.\");\n                }\n\n                // Prepare parameters/body\n                var parsedParams = TemplateParameterHelper.ParseTemplateParams(campaign.TemplateParameters);\n                var body = meta.Body ?? campaign.MessageTemplate ?? string.Empty;\n                var bodyPreview = TemplateParameterHelper.FillPlaceholders(body, parsedParams);\n\n                // Compute missing params (simple check: count vs supplied)\n                var missing = new List<string>();\n                if (meta.PlaceholderCount > 0)\n                {\n                    var supplied = parsedParams?.Count ?? 0;\n                    if (supplied < meta.PlaceholderCount)\n                    {\n                        for (int i = supplied + 1; i <= meta.PlaceholderCount; i++)\n                            missing.Add($\"{{{{{i}}}}} parameter is missing\");\n\n                        Log.Warning(\"⚠️ Preview found missing params | campaign={CampaignId} required={Required} supplied={Supplied}\",\n                            campaign.Id, meta.PlaceholderCount, supplied);\n                    }\n                }\n\n                // Choose contact for dynamic phone substitutions\n                var contact = await PickContactAsync(campaign, contactId);\n\n                // Buttons preview\n                var buttons = BuildButtonsPreview(campaign, meta, contact);\n\n                var result = new CampaignPreviewResponseDto\n                {\n                    CampaignId = campaign.Id,\n                    TemplateName = templateName,\n                    Language = meta.Language ?? \"en_US\",\n                    PlaceholderCount = meta.PlaceholderCount,\n                    BodyPreview = bodyPreview,\n                    MissingParams = missing,\n                    HasHeaderMedia = meta.HasImageHeader,\n                    HeaderType = meta.HasImageHeader ? \"IMAGE\" : null,\n                    Buttons = buttons\n                };\n\n                Log.Information(\"✅ Preview ready | campaign={CampaignId} template={TemplateName} placeholders={Count}\",\n                    campaign.Id, templateName, meta.PlaceholderCount);\n\n                return result;\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"🚨 Preview failed | biz={BusinessId} campaign={CampaignId}\", businessId, campaignId);\n                throw; // let controller shape the HTTP response (keeps consistency with your pattern)\n            }\n        }\n\n        // ---------- helpers ----------\n\n        private async Task<string> ResolveStartTemplateName(Guid businessId, Campaign campaign)\n        {\n            string selected = campaign.TemplateId ?? campaign.MessageTemplate ?? string.Empty;\n            if (!campaign.CTAFlowConfigId.HasValue || campaign.CTAFlowConfigId.Value == Guid.Empty)\n                return selected;\n\n            var flow = await _db.CTAFlowConfigs\n                .Include(f => f.Steps).ThenInclude(s => s.ButtonLinks)\n                .FirstOrDefaultAsync(f => f.Id == campaign.CTAFlowConfigId.Value\n                                        && f.BusinessId == businessId\n                                        && f.IsActive);\n\n            if (flow == null || flow.Steps == null || flow.Steps.Count == 0)\n                return selected;\n\n            var incoming = new HashSet<Guid>(flow.Steps\n                .SelectMany(s => s.ButtonLinks)\n                .Where(l => l.NextStepId.HasValue)\n                .Select(l => l.NextStepId!.Value));\n\n            var entry = flow.Steps.OrderBy(s => s.StepOrder)\n                                  .FirstOrDefault(s => !incoming.Contains(s.Id));\n\n            return string.IsNullOrWhiteSpace(entry?.TemplateToSend) ? selected : entry!.TemplateToSend!;\n        }\n\n        private async Task<Contact?> PickContactAsync(Campaign campaign, Guid? requestedContactId)\n        {\n            if (requestedContactId.HasValue)\n            {\n                var specific = campaign.Recipients?.FirstOrDefault(r => r.ContactId == requestedContactId)?.Contact;\n                if (specific != null) return specific;\n\n                // allow direct lookup if not in recipients yet\n                return await _db.Contacts.FirstOrDefaultAsync(c =>\n                    c.Id == requestedContactId.Value && c.BusinessId == campaign.BusinessId);\n            }\n\n            // fallback: first recipient’s contact\n            return campaign.Recipients?.FirstOrDefault()?.Contact;\n        }\n\n        private List<ButtonPreviewDto> BuildButtonsPreview(Campaign campaign, TemplateMetadataDto meta, Contact? contact)\n        {\n            var result = new List<ButtonPreviewDto>();\n            var campaignButtons = campaign.MultiButtons?\n                .OrderBy(b => b.Position)\n                .Take(3)\n                .ToList() ?? new List<CampaignButton>();\n\n            var templateButtons = meta.ButtonParams ?? new List<ButtonMetadataDto>();\n            var total = Math.Min(3, Math.Min(campaignButtons.Count, templateButtons.Count));\n\n            for (int i = 0; i < total; i++)\n            {\n                var tplBtn = templateButtons[i];\n                var campBtn = campaignButtons[i];\n\n                var subType = (tplBtn.SubType ?? \"url\").ToLowerInvariant();\n                var baseParam = tplBtn.ParameterValue?.Trim();\n                var isDynamic = subType == \"url\" && !string.IsNullOrWhiteSpace(baseParam) && baseParam.Contains(\"{{\");\n\n                string? token = null;\n                string? previewUrl = null;\n                string? campaignValue = campBtn.Value?.Trim();\n\n                if (isDynamic && string.IsNullOrWhiteSpace(campaignValue))\n                {\n                    Log.Warning(\"⚠️ Preview: dynamic URL button without campaign value | campaign={CampaignId} idx={Index} label={Label}\",\n                        campaign.Id, i, tplBtn.Text ?? campBtn.Title ?? \"\");\n                }\n\n                if (isDynamic && !string.IsNullOrWhiteSpace(campaignValue))\n                {\n                    // optional phone substitution\n                    var phone = NormalizePhone(contact?.PhoneNumber);\n                    var replaced = campaignValue.Contains(\"{{1}}\")\n                        ? campaignValue.Replace(\"{{1}}\", Uri.EscapeDataString(phone ?? \"\"))\n                        : campaignValue;\n\n                    // Build tracked URL using a synthetic id (only for preview)\n                    var fakeLogId = Guid.NewGuid();\n                    var tracked = _urlBuilder.BuildTrackedButtonUrl(fakeLogId, i, campBtn.Title, NormalizeAbsoluteUrl(replaced));\n                    previewUrl = tracked;\n\n                    // extract token after \"/r/\"\n                    token = ExtractToken(tracked);\n                }\n\n                result.Add(new ButtonPreviewDto\n                {\n                    Index = i,\n                    Text = tplBtn.Text ?? campBtn.Title ?? \"\",\n                    Type = tplBtn.Type ?? \"URL\",\n                    IsDynamic = isDynamic,\n                    TemplateParamBase = baseParam,\n                    CampaignValue = campaignValue,\n                    TokenParam = token,\n                    FinalUrlPreview = previewUrl\n                });\n            }\n\n            return result;\n        }\n\n        private static string? NormalizePhone(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return null;\n            var s = raw.Trim();\n            if (!s.StartsWith(\"+\")) s = \"+\" + new string(s.Where(char.IsDigit).ToArray());\n            return s;\n        }\n\n        private static string NormalizeAbsoluteUrl(string input)\n        {\n            // allow tel:/wa: for preview, but tracking expects http(s); if not absolute http(s), keep as-is.\n            if (Uri.TryCreate(input, UriKind.Absolute, out var uri) &&\n                (uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                 uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase)))\n            {\n                return uri.ToString();\n            }\n            return input;\n        }\n\n        private static string? ExtractToken(string fullTrackedUrl)\n        {\n            var pos = fullTrackedUrl.LastIndexOf(\"/r/\", StringComparison.OrdinalIgnoreCase);\n            if (pos < 0) return null;\n            var token = fullTrackedUrl[(pos + 3)..];\n            return string.IsNullOrWhiteSpace(token) ? null : token;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignRecipientService.cs",
      "sha256": "3e199694bbe770521c2d3b8b5e58770ed0390d9bc2b2c845e26d4806a41c1ea7",
      "language": "csharp",
      "size": 8095,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public class CampaignRecipientService : ICampaignRecipientService\n    {\n        private readonly AppDbContext _context;\n\n        public CampaignRecipientService(AppDbContext context)\n        {\n            _context = context;\n        }\n\n        // 🔍 Get a single recipient by ID\n        public async Task<CampaignRecipientDto?> GetByIdAsync(Guid id)\n        {\n            return await _context.CampaignRecipients\n                .Include(r => r.Contact)\n                .Where(r => r.Id == id)\n                .Select(r => new CampaignRecipientDto\n                {\n                    Id = r.Id,\n                    ContactId = r.ContactId,\n                    ContactName = r.Contact.Name,\n                    ContactPhone = r.Contact.PhoneNumber,\n                    Status = r.Status,\n                    SentAt = r.SentAt\n                })\n                .FirstOrDefaultAsync();\n        }\n\n        // 📦 Get all recipients of a specific campaign\n        public async Task<List<CampaignRecipientDto>> GetByCampaignIdAsync(Guid campaignId)\n        {\n            return await _context.CampaignRecipients\n                .Include(r => r.Contact)\n                .Where(r => r.CampaignId == campaignId)\n                .Select(r => new CampaignRecipientDto\n                {\n                    Id = r.Id,\n                    ContactId = r.ContactId,\n                    ContactName = r.Contact.Name,\n                    ContactPhone = r.Contact.PhoneNumber,\n                    Status = r.Status,\n                    SentAt = r.SentAt\n                })\n                .ToListAsync();\n        }\n\n        // ✏️ Update status of a specific recipient\n        public async Task<bool> UpdateStatusAsync(Guid recipientId, string newStatus)\n        {\n            var recipient = await _context.CampaignRecipients.FindAsync(recipientId);\n            if (recipient == null) return false;\n\n            recipient.Status = newStatus;\n            recipient.UpdatedAt = DateTime.UtcNow;\n\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        // 💬 Track customer reply or CTA\n        // 🗣️ Track customer reply on a recipient\n        public async Task<bool> TrackReplyAsync(Guid recipientId, string replyText)\n        {\n            var recipient = await _context.CampaignRecipients.FindAsync(recipientId);\n            if (recipient == null) return false;\n\n            recipient.ClickedCTA = replyText;\n            recipient.UpdatedAt = DateTime.UtcNow;\n\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n\n        // 🔎 Global recipient search across all campaigns\n        // 🔍 Search recipients by optional status or keyword\n        public async Task<List<CampaignRecipientDto>> SearchRecipientsAsync(string status = null, string keyword = null)\n        {\n            var query = _context.CampaignRecipients\n                .Include(r => r.Contact)\n                .AsQueryable();\n\n            if (!string.IsNullOrEmpty(status))\n                query = query.Where(r => r.Status == status);\n\n            if (!string.IsNullOrEmpty(keyword))\n                query = query.Where(r =>\n                    r.Contact.Name.Contains(keyword) ||\n                    r.Contact.PhoneNumber.Contains(keyword)\n                );\n\n            return await query\n                .Select(r => new CampaignRecipientDto\n                {\n                    Id = r.Id,\n                    ContactId = r.ContactId,\n                    ContactName = r.Contact.Name,\n                    ContactPhone = r.Contact.PhoneNumber,\n                    Status = r.Status,\n                    SentAt = r.SentAt\n                })\n                .ToListAsync();\n        }\n\n        //public async Task AssignContactsToCampaignAsync(Guid campaignId, List<Guid> contactIds)\n        //{\n        //    var campaign = await _context.Campaigns\n        //        .AsNoTracking()\n        //        .FirstOrDefaultAsync(c => c.Id == campaignId);\n\n        //    if (campaign == null)\n        //        throw new Exception(\"Campaign not found.\");\n\n        //    var businessId = campaign.BusinessId;\n\n        //    var existing = await _context.CampaignRecipients\n        //        .Where(r => r.CampaignId == campaignId && contactIds.Contains(r.ContactId))\n        //        .Select(r => r.ContactId)\n        //        .ToListAsync();\n\n        //    var newRecipients = contactIds\n        //        .Where(id => !existing.Contains(id))\n        //        .Select(contactId => new CampaignRecipient\n        //        {\n        //            Id = Guid.NewGuid(),\n        //            CampaignId = campaignId,\n        //            ContactId = contactId,\n        //            BusinessId = businessId, // ✅ required\n        //            Status = \"Pending\",\n        //            SentAt = DateTime.UtcNow,\n        //            UpdatedAt = DateTime.UtcNow,\n        //            IsAutoTagged = false\n        //        }).ToList();\n\n        //    if (newRecipients.Any())\n        //    {\n        //        await _context.CampaignRecipients.AddRangeAsync(newRecipients);\n        //        await _context.SaveChangesAsync();\n        //    }\n        //}\n\n        public async Task AssignContactsToCampaignAsync(Guid campaignId, List<Guid> contactIds)\n        {\n            var campaign = await _context.Campaigns\n                .AsNoTracking()\n                .FirstOrDefaultAsync(c => c.Id == campaignId);\n\n            if (campaign == null)\n                throw new Exception(\"Campaign not found.\");\n\n            var businessId = campaign.BusinessId;\n            var now = DateTime.UtcNow;\n\n            // 1) Sanitize inputs (no duplicates, no Guid.Empty)\n            var contactIdsClean = (contactIds ?? new List<Guid>())\n                .Where(id => id != Guid.Empty)\n                .Distinct()\n                .ToList();\n\n            if (contactIdsClean.Count == 0)\n                return;\n\n            // 2) Ensure all contacts belong to the same business (tenant safety)\n            var validContactIds = await _context.Contacts\n                .Where(c => c.BusinessId == businessId && contactIdsClean.Contains(c.Id))\n                .Select(c => c.Id)\n                .ToListAsync();\n\n            if (validContactIds.Count == 0)\n                return;\n\n            // 3) Find existing recipients for this campaign (ContactId is Guid?)\n            var existingContactIds = await _context.CampaignRecipients\n                .Where(r => r.CampaignId == campaignId\n                            && r.ContactId.HasValue\n                            && validContactIds.Contains(r.ContactId.Value))\n                .Select(r => r.ContactId!.Value) // project to non-nullable Guid\n                .ToListAsync();\n\n            // 4) Create recipients only for truly new contacts\n            var newContactIds = validContactIds.Except(existingContactIds).ToList();\n            if (newContactIds.Count == 0)\n                return;\n\n            var newRecipients = newContactIds.Select(contactId => new CampaignRecipient\n            {\n                Id = Guid.NewGuid(),\n                CampaignId = campaignId,\n                BusinessId = businessId,\n                ContactId = contactId,         // non-null Guid\n                Status = \"Pending\",\n                // This is *assignment/materialization*, not send:\n                MaterializedAt = now,\n                SentAt = null,                 // leave null until actually sent\n                UpdatedAt = now,\n                IsAutoTagged = false\n                // AudienceMemberId/IdempotencyKey/etc. if your flow sets them here\n            }).ToList();\n\n            await _context.CampaignRecipients.AddRangeAsync(newRecipients);\n            await _context.SaveChangesAsync();\n        }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignRetryService.cs",
      "sha256": "0e4a2ec463e21ef4eb537bc3ae1cae0e54f3c9282b73bfb666017834dab474f2",
      "language": "csharp",
      "size": 4212,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n \n    public sealed class CampaignRetryService : ICampaignRetryService\n    {\n        private readonly AppDbContext _db;\n        private readonly CampaignService _campaignService; // use concrete to reach batch method\n\n        public CampaignRetryService(AppDbContext db, ICampaignService campaignService)\n        {\n            _db = db;\n            // We know our concrete implementation exposes the batch entry.\n            _campaignService = (CampaignService)campaignService;\n        }\n\n        public async Task<CampaignRetryResultDto> RetryFailedAsync(Guid businessId, Guid campaignId, int limit = 200)\n        {\n            if (businessId == Guid.Empty) throw new UnauthorizedAccessException(\"Invalid business id.\");\n            if (campaignId == Guid.Empty) throw new ArgumentException(\"campaignId is required\");\n            if (limit <= 0) limit = 200;\n\n            var exists = await _db.Campaigns\n                .AsNoTracking()\n                .AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId && !c.IsDeleted);\n            if (!exists) throw new KeyNotFoundException(\"Campaign not found.\");\n\n            // Most recent log per recipient, keep only those whose latest is Failed\n            var failedQuery =\n                from log in _db.CampaignSendLogs.AsNoTracking()\n                where log.BusinessId == businessId && log.CampaignId == campaignId\n                group log by log.RecipientId into g\n                let last = g.OrderByDescending(x => x.CreatedAt).First()\n                where last.SendStatus == \"Failed\"\n                select new { RecipientId = last.RecipientId }; // <-- Guid (non-nullable)\n\n            var failed = await failedQuery\n                .Select(x => x.RecipientId)   // <-- no .Value\n                .Distinct()\n                .Take(limit)\n                .ToListAsync();\n\n            var result = new CampaignRetryResultDto\n            {\n                CampaignId = campaignId,\n                ConsideredFailed = failed.Count\n            };\n\n            if (failed.Count == 0)\n            {\n                result.Note = \"No failed recipients found to retry.\";\n                return result;\n            }\n\n            // Filter out recipients whose latest log is Sent (paranoia/safety)\n            var latestOkQuery =\n                from log in _db.CampaignSendLogs.AsNoTracking()\n                where log.BusinessId == businessId && log.CampaignId == campaignId\n                group log by log.RecipientId into g\n                let last = g.OrderByDescending(x => x.CreatedAt).First()\n                where last.SendStatus == \"Sent\"\n                select new { RecipientId = last.RecipientId }; // Guid\n\n            var alreadyOk = await latestOkQuery\n                .Select(x => x.RecipientId)\n                .ToListAsync();\n\n            var toRetry = failed.Except(alreadyOk).ToList();\n            result.Skipped = failed.Count - toRetry.Count;\n\n            if (toRetry.Count == 0)\n            {\n                result.Note = \"All failed recipients appear to have a later successful send.\";\n                return result;\n            }\n\n            // Send the batch via canonical pipeline (freezing + idempotency safeguard)\n            var resp = await _campaignService.SendTemplateCampaignBatchAsync(campaignId, toRetry);\n\n            result.Retried = resp.Success ? toRetry.Count : 0;\n            result.Note = resp.Success ? \"Retry dispatched.\" : (\"Retry failed: \" + (resp.Message ?? \"Unknown error.\"));\n            result.RecipientIdsSample = toRetry.Take(20).ToList();\n\n            Log.Information(\"Campaign retry executed {@Retry}\", new\n            {\n                businessId,\n                campaignId,\n                consideredFailed = result.ConsideredFailed,\n                skipped = result.Skipped,\n                retried = result.Retried\n            });\n\n            return result;\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignService.BatchSend.cs",
      "sha256": "9d3785359f7dace6742cd0602183c331c17695aa9c1cbfb7346421d774cdaf0c",
      "language": "csharp",
      "size": 1876,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Helpers;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public partial class CampaignService\n    {\n        /// <summary>\n        /// Sends a text/template campaign to a given subset of recipient IDs (batch).\n        /// Leverages the same pipeline & idempotency you just implemented.\n        /// </summary>\n        public async Task<ResponseResult> SendTemplateCampaignBatchAsync(Guid campaignId, IEnumerable<Guid> recipientIds)\n        {\n            if (campaignId == Guid.Empty) return ResponseResult.ErrorInfo(\"Invalid campaign id.\");\n            var ids = recipientIds?.Where(id => id != Guid.Empty).Distinct().ToList() ?? new List<Guid>();\n            if (ids.Count == 0) return ResponseResult.ErrorInfo(\"No recipients to send in this batch.\");\n\n            var campaign = await _context.Campaigns\n                .Include(c => c.Recipients.Where(r => ids.Contains(r.Id))).ThenInclude(r => r.Contact)\n                .Include(c => c.MultiButtons)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && !c.IsDeleted);\n\n            if (campaign == null) return ResponseResult.ErrorInfo(\"Campaign not found.\");\n            if (campaign.Recipients == null || campaign.Recipients.Count == 0)\n                return ResponseResult.ErrorInfo(\"No batch recipients matched this campaign.\");\n\n            // Reuse your existing method that sends a single campaign object with its recipients loaded.\n            // It already handles: provider resolution, template meta, freezing params/URLs,\n            // idempotency key, logs, and billing ingest.\n            return await SendTextTemplateCampaignAsync(campaign);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CampaignService.cs",
      "sha256": "3f901193fb0c519a73651e4a8e7963390a5eed519dd1aaf1595eb603abff7268",
      "language": "csharp",
      "size": 220289,
      "content": "\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Shared;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Services.Messages.Interfaces;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.Helpers;\nusing xbytechat_api.WhatsAppSettings.Services;\nusing xbytechat.api.Shared.utility;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat.api.Features.Tracking.Services;\nusing xbytechat.api.Features.CTAFlowBuilder.Models;\n\nusing xbytechat.api.WhatsAppSettings.Services;\nusing xbytechat_api.Features.Billing.Services;\nusing System.Text.RegularExpressions;\nusing xbytechat.api.Common.Utils;\nusing xbytechat.api.Features.TemplateModule.Services;\nusing System.Linq;\nusing xbytechat.api.Features.BusinessModule.Models;\nusing xbytechat.api.Features.CampaignModule.Services.SendPipeline;\nusing System.Text.Json;\nusing Newtonsoft.Json;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Features.CRM.Dtos;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.CRM.Timelines.Services;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public partial class CampaignService : ICampaignService\n    {\n        private readonly AppDbContext _context;\n        private readonly IMessageService _messageService;\n        private readonly IServiceProvider _serviceProvider;\n        private readonly ILeadTimelineService _timelineService;\n        private readonly IMessageEngineService _messageEngineService;\n        private readonly IWhatsAppTemplateFetcherService _templateFetcherService;\n        private readonly IUrlBuilderService _urlBuilderService;\n        private readonly IWhatsAppSenderService _whisatsAppSenderService;\n        private readonly IBillingIngestService _billingIngest;\n\n        private readonly IWhatsAppSettingsService _whatsAppSettingsService;\n        // private readonly Serilog.ILogger _logger = Log.ForContext<CampaignService>();\n        // CampaignService.cs (fields)\n\n\n        private readonly ILogger<WhatsAppTemplateService> _logger;\n        public CampaignService(AppDbContext context, IMessageService messageService,\n                               IServiceProvider serviceProvider,\n                               ILeadTimelineService timelineService,\n                               IMessageEngineService messageEngineService,\n                               IWhatsAppTemplateFetcherService templateFetcherService,\n                               IUrlBuilderService urlBuilderService,\n                               IWhatsAppSenderService whatsAppSenderService, IBillingIngestService billingIngest,\n                               ILogger<WhatsAppTemplateService> logger, IWhatsAppSettingsService whatsAppSettingsService\n                               )\n        {\n            _context = context;\n            _messageService = messageService;\n            _serviceProvider = serviceProvider;\n            _timelineService = timelineService; // ✅ new\n            _messageEngineService = messageEngineService;\n            _templateFetcherService = templateFetcherService;\n            _urlBuilderService = urlBuilderService;\n            _whisatsAppSenderService = whatsAppSenderService;\n            _billingIngest = billingIngest;\n            _logger = logger;\n            _whatsAppSettingsService = whatsAppSettingsService;\n\n\n        }\n\n\n\n\n        #region Private method\n        private static string? ResolvePerRecipientValue(CampaignRecipient r, string key)\n        {\n            if (string.IsNullOrWhiteSpace(r.ResolvedButtonUrlsJson)) return null;\n            try\n            {\n                var dict = JsonConvert.DeserializeObject<Dictionary<string, string>>(r.ResolvedButtonUrlsJson)\n                           ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n                return dict.TryGetValue(key, out var v) ? v : null;\n            }\n            catch { return null; }\n        }\n        private static List<string> BuildBodyParametersForRecipient(Campaign campaign, CampaignRecipient r)\n        {\n            // Preferred: frozen params on recipient (string[])\n            if (!string.IsNullOrWhiteSpace(r.ResolvedParametersJson))\n            {\n                try\n                {\n                    var arr = JsonConvert.DeserializeObject<string[]>(r.ResolvedParametersJson);\n                    if (arr != null) return arr.ToList();\n                }\n                catch { /* ignore */ }\n            }\n\n            // Fallback: campaign.TemplateParameters (stored as JSON array of strings)\n            try\n            {\n                return TemplateParameterHelper.ParseTemplateParams(campaign.TemplateParameters).ToList();\n            }\n            catch\n            {\n                return new List<string>();\n            }\n        }\n        private static Dictionary<string, string> BuildButtonParametersForRecipient(Campaign campaign, CampaignRecipient r)\n        {\n            var dict = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n            // 1) Recipient-specific vars (from CSV materialization)\n            if (!string.IsNullOrWhiteSpace(r.ResolvedButtonUrlsJson))\n            {\n                try\n                {\n                    var d = JsonConvert.DeserializeObject<Dictionary<string, string>>(r.ResolvedButtonUrlsJson);\n                    if (d != null)\n                    {\n                        foreach (var kv in d)\n                            dict[kv.Key] = kv.Value ?? string.Empty;\n                    }\n                }\n                catch { /* ignore */ }\n            }\n\n            // 2) Header fallbacks from campaign (only ImageUrl exists in this branch)\n            if (!dict.ContainsKey(\"header.image_url\") && !string.IsNullOrWhiteSpace(campaign.ImageUrl))\n                dict[\"header.image_url\"] = campaign.ImageUrl!;\n\n            // NOTE:\n            // We do NOT touch header.video_url/header.document_url here,\n            // because Campaign.VideoUrl/DocumentUrl do not exist in this branch.\n\n            // 3) Button URL fallbacks from campaign buttons\n            if (campaign.MultiButtons != null)\n            {\n                foreach (var b in campaign.MultiButtons.OrderBy(b => b.Position).Take(3))\n                {\n                    var key = $\"button{b.Position}.url_param\";\n                    if (!dict.ContainsKey(key) && !string.IsNullOrWhiteSpace(b.Value))\n                        dict[key] = b.Value!;\n                }\n            }\n\n            return dict;\n        }\n        private async Task<(Guid? entryStepId, string? entryTemplate)> ResolveFlowEntryAsync(Guid businessId, Guid? flowId)\n        {\n            if (!flowId.HasValue || flowId.Value == Guid.Empty) return (null, null);\n\n            var flow = await _context.CTAFlowConfigs\n                 .AsNoTracking()\n                .Include(f => f.Steps)\n                    .ThenInclude(s => s.ButtonLinks)\n                .FirstOrDefaultAsync(f => f.Id == flowId.Value && f.BusinessId == businessId && f.IsActive);\n\n            if (flow == null || flow.Steps == null || flow.Steps.Count == 0) return (null, null);\n\n            var incoming = new HashSet<Guid>(\n                flow.Steps.SelectMany(s => s.ButtonLinks)\n                          .Where(l => l.NextStepId.HasValue)\n                          .Select(l => l.NextStepId!.Value)\n            );\n\n            var entry = flow.Steps\n                .OrderBy(s => s.StepOrder)\n                .FirstOrDefault(s => !incoming.Contains(s.Id));\n\n            return entry == null ? (null, null) : (entry.Id, entry.TemplateToSend);\n        }\n\n        #endregion\n\n        #region Get All Types of Get and Update and Delete Methods\n\n        public async Task<List<CampaignSummaryDto>> GetAllCampaignsAsync(Guid businessId)\n        {\n            return await _context.Campaigns\n                .Where(c => c.BusinessId == businessId)\n                .OrderByDescending(c => c.CreatedAt)\n                .Select(c => new CampaignSummaryDto\n                {\n                    Id = c.Id,\n                    Name = c.Name,\n                    Status = c.Status,\n                    ScheduledAt = c.ScheduledAt,\n                    CreatedAt = c.CreatedAt,\n\n                })\n                .ToListAsync();\n        }\n        public async Task<CampaignDto?> GetCampaignByIdAsync(Guid campaignId, Guid businessId)\n        {\n            var campaign = await _context.Campaigns\n                .AsNoTracking()\n                .Include(c => c.Cta)\n                .Include(c => c.MultiButtons)\n                .Include(c => c.CTAFlowConfig)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n\n            if (campaign == null) return null;\n\n            return new CampaignDto\n            {\n                Id = campaign.Id,\n                Name = campaign.Name,\n                MessageTemplate = campaign.MessageTemplate,\n                MessageBody = campaign.MessageBody,\n                TemplateId = campaign.TemplateId,\n                CampaignType = campaign.CampaignType,\n                Status = campaign.Status,\n                ImageUrl = campaign.ImageUrl,\n                ImageCaption = campaign.ImageCaption,\n                CreatedAt = campaign.CreatedAt,\n                ScheduledAt = campaign.ScheduledAt,\n                CtaId = campaign.CtaId,\n                Cta = campaign.Cta == null ? null : new CtaPreviewDto\n                {\n                    Title = campaign.Cta.Title,\n                    ButtonText = campaign.Cta.ButtonText\n                },\n                MultiButtons = campaign.MultiButtons?\n                    .Select(b => new CampaignButtonDto\n                    {\n                        ButtonText = b.Title,\n                        ButtonType = b.Type,\n                        TargetUrl = b.Value\n                    }).ToList() ?? new List<CampaignButtonDto>(),\n                // ✅ Flow surface to UI\n                CTAFlowConfigId = campaign.CTAFlowConfigId,\n                CTAFlowName = campaign.CTAFlowConfig?.FlowName\n            };\n        }\n        // Returns the entry step (no incoming links) and its template name.\n        // If flow is missing/invalid, returns (null, null) and caller should ignore.\n\n        public async Task<List<CampaignSummaryDto>> GetAllCampaignsAsync(Guid businessId, string? type = null)\n        {\n            var query = _context.Campaigns\n                .Where(c => c.BusinessId == businessId)\n                .AsQueryable();\n\n            if (!string.IsNullOrEmpty(type))\n                query = query.Where(c => c.CampaignType == type);\n\n            return await query\n                .OrderByDescending(c => c.CreatedAt)\n                .Select(c => new CampaignSummaryDto\n                {\n                    Id = c.Id,\n                    Name = c.Name,\n                    Status = c.Status,\n                    ScheduledAt = c.ScheduledAt,\n                    CreatedAt = c.CreatedAt,\n                    ImageUrl = c.ImageUrl,            // ✅ Now mapped\n                    ImageCaption = c.ImageCaption,    // ✅ Now mapped\n                    CtaTitle = c.Cta != null ? c.Cta.Title : null,  // optional\n                    RecipientCount = c.Recipients.Count()\n                })\n                .ToListAsync();\n        }\n\n        public async Task<List<ContactDto>> GetRecipientsByCampaignIdAsync(Guid campaignId, Guid businessId)\n        {\n            var recipients = await _context.CampaignRecipients\n                .Include(r => r.Contact)\n                .Where(r => r.CampaignId == campaignId && r.Contact.BusinessId == businessId)\n                .Select(r => new ContactDto\n                {\n                    Id = r.Contact.Id,\n                    Name = r.Contact.Name,\n                    PhoneNumber = r.Contact.PhoneNumber,\n                    Email = r.Contact.Email,\n                    LeadSource = r.Contact.LeadSource,\n                    CreatedAt = r.Contact.CreatedAt\n                })\n                .ToListAsync();\n\n            return recipients;\n        }\n\n        public async Task<PaginatedResponse<CampaignSummaryDto>> GetPaginatedCampaignsAsync(Guid businessId, PaginatedRequest request)\n        {\n            var query = _context.Campaigns\n                .Where(c => c.BusinessId == businessId)\n                .OrderByDescending(c => c.CreatedAt);\n\n            var total = await query.CountAsync();\n\n            var items = await query\n                .Skip((request.Page - 1) * request.PageSize)\n                .Take(request.PageSize)\n                .Select(c => new CampaignSummaryDto\n                {\n                    Id = c.Id,\n                    Name = c.Name,\n                    Status = c.Status,\n                    ScheduledAt = c.ScheduledAt,\n                    CreatedAt = c.CreatedAt\n                })\n                .ToListAsync();\n\n            return new PaginatedResponse<CampaignSummaryDto>\n            {\n                Items = items,\n                TotalCount = total,\n                Page = request.Page,\n                PageSize = request.PageSize\n            };\n        }\n        public async Task<bool> UpdateCampaignAsync(Guid id, CampaignCreateDto dto)\n        {\n            var campaign = await _context.Campaigns.FindAsync(id);\n            if (campaign == null || campaign.Status != \"Draft\")\n                return false;\n\n            // ✅ Extract BusinessId from current campaign\n            var businessId = campaign.BusinessId;\n\n            // ✅ Optional CTA ownership validation\n            if (dto.CtaId.HasValue)\n            {\n                var cta = await _context.CTADefinitions\n                    .FirstOrDefaultAsync(c => c.Id == dto.CtaId && c.BusinessId == businessId && c.IsActive);\n\n                if (cta == null)\n                    throw new UnauthorizedAccessException(\"❌ The selected CTA does not belong to your business or is inactive.\");\n            }\n\n            // ✏️ Update campaign fields\n            campaign.Name = dto.Name;\n            campaign.MessageTemplate = dto.MessageTemplate;\n            campaign.TemplateId = dto.TemplateId;\n            campaign.FollowUpTemplateId = dto.FollowUpTemplateId;\n            campaign.CampaignType = dto.CampaignType;\n            campaign.CtaId = dto.CtaId;\n            campaign.ImageUrl = dto.ImageUrl;\n            campaign.ImageCaption = dto.ImageCaption;\n            campaign.UpdatedAt = DateTime.UtcNow;\n            // 🔒 Step 2.1: Refresh snapshot on update when template may have changed\n            try\n            {\n                var effectiveTemplateName = !string.IsNullOrWhiteSpace(campaign.TemplateId)\n                    ? campaign.TemplateId!\n                    : (campaign.MessageTemplate ?? \"\");\n\n                if (!string.IsNullOrWhiteSpace(effectiveTemplateName))\n                {\n                    var snapshotMeta = await _templateFetcherService.GetTemplateMetaAsync(\n                        businessId,\n                        effectiveTemplateName,\n                        language: null,\n                        provider: campaign.Provider\n                    );\n\n                    campaign.TemplateSchemaSnapshot = snapshotMeta != null\n                        ? JsonConvert.SerializeObject(snapshotMeta)\n                        : JsonConvert.SerializeObject(new\n                        {\n                            Provider = campaign.Provider ?? \"\",\n                            TemplateName = effectiveTemplateName,\n                            Language = \"\" // unknown if not in provider meta\n                        });\n                }\n            }\n            catch (Exception ex)\n            {\n                Log.Warning(ex, \"⚠️ Template schema snapshot (update) failed for campaign {CampaignId}\", id);\n            }\n\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<CampaignDeletionResult> DeleteCampaignAsync(\n        Guid businessId,\n        Guid id,\n        CampaignDeletionOptions options,\n        CancellationToken ct = default)\n        {\n            // 1) Ownership + existence\n            var campaign = await _context.Campaigns\n                .FirstOrDefaultAsync(c => c.Id == id && c.BusinessId == businessId, ct);\n\n            if (campaign == null)\n                return CampaignDeletionResult.NotFound();\n\n            // 2) Usage snapshot (for UX & guards)\n            var recipients = await _context.CampaignRecipients.CountAsync(r => r.CampaignId == id, ct);\n\n            var activeJobStatuses = new[] { \"queued\", \"pending\", \"retry\", \"scheduled\", \"inprogress\", \"processing\", \"sending\" };\n            var queuedJobs = await _context.OutboundCampaignJobs\n                .CountAsync(j => j.CampaignId == id && activeJobStatuses.Contains((j.Status ?? \"\").ToLower()), ct);\n\n            var sendLogs = await _context.CampaignSendLogs.CountAsync(s => s.CampaignId == id, ct);\n\n            var isSending = ((campaign.Status ?? \"\").Equals(\"sending\", StringComparison.OrdinalIgnoreCase)) || queuedJobs > 0;\n\n            if (isSending && !options.Force)\n                return CampaignDeletionResult.BlockedSending(recipients, queuedJobs, sendLogs);\n\n            var clean = recipients == 0 && queuedJobs == 0 && sendLogs == 0;\n            if (!options.Force && !clean)\n                return CampaignDeletionResult.BlockedState(recipients, queuedJobs, sendLogs);\n\n            // 3) Transaction: purge RESTRICT chains first, then remove campaign (CASCADE handles the rest)\n            await using var tx = await _context.Database.BeginTransactionAsync(ct);\n            try\n            {\n                // 3A) Collect dependent ids (for TrackingLogs purge)\n                var msgIds = await _context.MessageLogs\n                    .Where(m => m.BusinessId == businessId && m.CampaignId == id)\n                    .Select(m => m.Id)\n                    .ToListAsync(ct);\n\n                var sendIds = await _context.CampaignSendLogs\n                    .Where(s => s.BusinessId == businessId && s.CampaignId == id)\n                    .Select(s => s.Id)\n                    .ToListAsync(ct);\n\n                // 3B) Purge TrackingLogs (FKs to Campaign/MessageLog/SendLog are RESTRICT)\n#if NET7_0_OR_GREATER\n                await _context.TrackingLogs\n                    .Where(t => t.CampaignId == id\n                        || (t.MessageLogId != null && msgIds.Contains(t.MessageLogId.Value))\n                        || (t.CampaignSendLogId != null && sendIds.Contains(t.CampaignSendLogId.Value)))\n                    .ExecuteDeleteAsync(ct);\n#else\n        // EF Core < 7 fallback\n                    await _db.Database.ExecuteSqlRawAsync(@\"\n            DELETE FROM \"\"TrackingLogs\"\"\n            WHERE \"\"CampaignId\"\" = {0}\n               OR (\"\"MessageLogId\"\" IS NOT NULL AND \"\"MessageLogId\"\" = ANY({1}))\n               OR (\"\"CampaignSendLogId\"\" IS NOT NULL AND \"\"CampaignSendLogId\"\" = ANY({2}));\n            \", new object[] { id, msgIds.ToArray(), sendIds.ToArray() }, ct);\n#endif\n\n                // 3C) Clear any outstanding jobs (if not configured to cascade)\n#if NET7_0_OR_GREATER\n                await _context.OutboundCampaignJobs\n                    .Where(j => j.CampaignId == id)\n                    .ExecuteDeleteAsync(ct);\n#else\n        var jobs = await _db.OutboundCampaignJobs.Where(j => j.CampaignId == id).ToListAsync(ct);\n        _db.OutboundCampaignJobs.RemoveRange(jobs);\n        await _db.SaveChangesAsync(ct);\n#endif\n\n                // 3D) Delete the campaign (CASCADE removes audiences, members, recipients,\n                //     send logs, message logs, status logs, etc. per your Fluent config)\n                _context.Campaigns.Remove(campaign);\n                await _context.SaveChangesAsync(ct);\n\n                await tx.CommitAsync(ct);\n\n                return CampaignDeletionResult.Deleted(recipients, queuedJobs, sendLogs);\n            }\n            catch (DbUpdateException)\n            {\n                await tx.RollbackAsync(ct);\n                return new CampaignDeletionResult { Status = CampaignDeletionStatus.Error };\n            }\n        }\n\n        #endregion\n\n        #region // 🆕 CreateCampaignAsync(Text/Image)\n\n        //public async Task<Guid?> CreateTextCampaignAsync(CampaignCreateDto dto, Guid businessId, string createdBy)\n        //{\n        //    try\n        //    {\n        //        // === NEW: duplicate-name guard (per Business) ===\n        //        // If you have soft-delete or archived states, add those filters here.\n        //        var nameExists = await _context.Campaigns\n        //            .AsNoTracking()\n        //            .AnyAsync(c => c.BusinessId == businessId && c.Name == dto.Name);\n\n        //        if (nameExists)\n        //            throw new InvalidOperationException(\"A campaign with this name already exists for this business. Please choose a different name.\");\n\n        //        var campaignId = Guid.NewGuid();\n\n        //        // 🔁 Parse/normalize template parameters once\n        //        var parsedParams = TemplateParameterHelper.ParseTemplateParams(\n        //            JsonConvert.SerializeObject(dto.TemplateParameters ?? new List<string>())\n        //        );\n\n        //        // 🔒 Validate + resolve sender (optional but recommended)\n        //        string? providerNorm = null;\n        //        if (!string.IsNullOrWhiteSpace(dto.PhoneNumberId))\n        //        {\n        //            var pair = await _whisatsAppSenderService.ResolveSenderPairAsync(businessId, dto.PhoneNumberId);\n        //            if (pair == null)\n        //                throw new InvalidOperationException(\"❌ Selected sender is invalid or does not belong to this business.\");\n        //            providerNorm = pair.Value.Provider; // already normalized to UPPER\n        //        }\n\n        //        // 🔄 Flow id from UI (null/empty => no flow)\n        //        Guid? incomingFlowId = (dto.CTAFlowConfigId.HasValue && dto.CTAFlowConfigId.Value != Guid.Empty)\n        //            ? dto.CTAFlowConfigId.Value\n        //            : (Guid?)null;\n\n        //        Guid? savedFlowId = incomingFlowId;\n\n        //        // 🧩 FLOW VALIDATION (only to align the starting template)\n        //        string selectedTemplateName = dto.TemplateId ?? dto.MessageTemplate ?? string.Empty;\n\n        //        CTAFlowConfig? flow = null;\n        //        CTAFlowStep? entryStep = null;\n\n        //        if (incomingFlowId.HasValue)\n        //        {\n        //            flow = await _context.CTAFlowConfigs\n        //                .Include(f => f.Steps).ThenInclude(s => s.ButtonLinks)\n        //                .FirstOrDefaultAsync(f =>\n        //                    f.Id == incomingFlowId.Value &&\n        //                    f.BusinessId == businessId &&\n        //                    f.IsActive);\n\n        //            if (flow != null)\n        //            {\n        //                var allIncoming = new HashSet<Guid>(flow.Steps\n        //                    .SelectMany(s => s.ButtonLinks)\n        //                    .Where(l => l.NextStepId.HasValue)\n        //                    .Select(l => l.NextStepId!.Value));\n\n        //                entryStep = flow.Steps\n        //                    .OrderBy(s => s.StepOrder)\n        //                    .FirstOrDefault(s => !allIncoming.Contains(s.Id));\n\n        //                if (entryStep != null &&\n        //                    !string.Equals(selectedTemplateName, entryStep.TemplateToSend, StringComparison.OrdinalIgnoreCase))\n        //                {\n        //                    selectedTemplateName = entryStep.TemplateToSend;\n        //                }\n        //            }\n        //        }\n\n        //        //var template = await _templateFetcherService.GetTemplateByNameAsync(\n        //        //    businessId,\n        //        //    selectedTemplateName,\n        //        //    includeButtons: true\n        //        //);\n\n        //        //var templateBody = template?.Body ?? dto.MessageTemplate ?? string.Empty;\n\n        //        var template = await _templateFetcherService.GetTemplateByNameAsync(\n        //            businessId,\n        //            selectedTemplateName,\n        //            includeButtons: true\n        //        );\n        //        if (template == null)\n        //            throw new InvalidOperationException($\"Template '{selectedTemplateName}' not found from provider.\");\n\n        //        var templateBody = template.Body ?? string.Empty;\n\n\n        //        var resolvedBody = TemplateParameterHelper.FillPlaceholders(templateBody, parsedParams);\n\n        //        // =========================\n        //        // 🆕 Header kind + URL logic\n        //        // =========================\n        //        string headerKind = (dto.HeaderKind ?? \"\").Trim().ToLowerInvariant(); // \"image\" | \"video\" | \"document\" | \"text\" | \"none\"\n        //        bool isMediaHeader = headerKind == \"image\" || headerKind == \"video\" || headerKind == \"document\";\n\n        //        // Prefer new unified HeaderMediaUrl; fall back to ImageUrl for legacy image campaigns\n        //        string? headerUrl = string.IsNullOrWhiteSpace(dto.HeaderMediaUrl)\n        //            ? (headerKind == \"image\" ? dto.ImageUrl : null)\n        //            : dto.HeaderMediaUrl;\n\n        //        // ✅ Campaign type: headerKind ALWAYS wins (FE may still send \"text\")\n        //        string finalCampaignType = isMediaHeader\n        //            ? headerKind                               // \"image\" | \"video\" | \"document\"\n        //            : (dto.CampaignType ?? \"text\").Trim().ToLowerInvariant();\n\n        //        // clamp to known values\n        //        if (finalCampaignType != \"image\" &&\n        //            finalCampaignType != \"video\" &&\n        //            finalCampaignType != \"document\")\n        //        {\n        //            finalCampaignType = \"text\";\n        //        }\n\n        //        // Validate media header needs URL\n        //        if (isMediaHeader && string.IsNullOrWhiteSpace(headerUrl))\n        //            throw new InvalidOperationException(\"❌ Header media URL is required for this template.\");\n\n        //        // =========================================\n        //        // Create entity with correct media fields set\n        //        // =========================================\n        //        var campaign = new Campaign\n        //        {\n        //            Id = campaignId,\n        //            BusinessId = businessId,\n        //            Name = dto.Name,\n\n        //            MessageTemplate = dto.MessageTemplate,\n        //            TemplateId = selectedTemplateName,\n\n        //            FollowUpTemplateId = dto.FollowUpTemplateId,\n        //            CampaignType = finalCampaignType,\n        //            CtaId = dto.CtaId,\n        //            CTAFlowConfigId = savedFlowId,\n\n        //            ScheduledAt = dto.ScheduledAt, // FE should send UTC ISO\n        //            CreatedBy = createdBy,\n        //            CreatedAt = DateTime.UtcNow,\n        //            UpdatedAt = DateTime.UtcNow,\n\n        //            // Default status will be finalized below after we reason about ScheduledAt\n        //            Status = \"Draft\",\n\n        //            // Media fields (set exactly one depending on header kind)\n        //            ImageUrl = headerKind == \"image\" ? headerUrl : null,\n        //            ImageCaption = dto.ImageCaption,\n        //            VideoUrl = headerKind == \"video\" ? headerUrl : null,\n        //            DocumentUrl = headerKind == \"document\" ? headerUrl : null,\n\n        //            TemplateParameters = JsonConvert.SerializeObject(dto.TemplateParameters ?? new List<string>()),\n        //            MessageBody = resolvedBody,\n\n        //            // 🟢 Persist sender choice (nullable if not selected)\n        //            Provider = providerNorm,\n        //            PhoneNumberId = dto.PhoneNumberId\n        //        };\n\n        //        // 🔒 Step 2.1: Snapshot template schema (text path)\n        //        try\n        //        {\n        //            var snapshotMeta = await _templateFetcherService.GetTemplateMetaAsync(\n        //                businessId,\n        //                selectedTemplateName,\n        //                language: null,\n        //                provider: providerNorm?.ToLowerInvariant() // normalize to match DB (\"meta_cloud\"/\"pinnacle\")\n        //            );\n\n        //            campaign.TemplateSchemaSnapshot = snapshotMeta != null\n        //                ? JsonConvert.SerializeObject(snapshotMeta)\n        //                : JsonConvert.SerializeObject(new\n        //                {\n        //                    Provider = providerNorm ?? \"\",\n        //                    TemplateName = selectedTemplateName,\n        //                    Language = template?.Language ?? \"\"\n        //                });\n        //        }\n        //        catch (Exception ex)\n        //        {\n        //            Log.Warning(ex, \"⚠️ Template schema snapshot failed for campaign {CampaignId}\", campaignId);\n        //        }\n\n        //        await _context.Campaigns.AddAsync(campaign);\n\n        //        if (dto.ContactIds != null && dto.ContactIds.Any())\n        //        {\n        //            var recipients = dto.ContactIds.Select(contactId => new CampaignRecipient\n        //            {\n        //                Id = Guid.NewGuid(),\n        //                CampaignId = campaignId,\n        //                ContactId = contactId,\n        //                BusinessId = businessId,\n        //                Status = \"Pending\",\n        //                SentAt = null,\n        //                UpdatedAt = DateTime.UtcNow\n        //            });\n\n        //            await _context.CampaignRecipients.AddRangeAsync(recipients);\n        //        }\n\n        //        if (dto.MultiButtons != null && dto.MultiButtons.Any())\n        //        {\n        //            var buttons = dto.MultiButtons\n        //                .Where(btn => !string.IsNullOrWhiteSpace(btn.ButtonText) && !string.IsNullOrWhiteSpace(btn.TargetUrl))\n        //                .Take(3)\n        //                .Select((btn, index) => new CampaignButton\n        //                {\n        //                    Id = Guid.NewGuid(),\n        //                    CampaignId = campaignId,\n        //                    Title = btn.ButtonText,\n        //                    Type = btn.ButtonType ?? \"url\",\n        //                    Value = btn.TargetUrl,\n        //                    Position = index + 1,\n        //                    IsFromTemplate = false\n        //                });\n\n        //            await _context.CampaignButtons.AddRangeAsync(buttons);\n        //        }\n\n        //        if (template != null && template.ButtonParams?.Count > 0)\n        //        {\n        //            var buttonsToSave = new List<CampaignButton>();\n        //            var userButtons = dto.ButtonParams ?? new List<CampaignButtonParamFromMetaDto>();\n\n        //            var total = Math.Min(3, template.ButtonParams.Count);\n        //            for (int i = 0; i < total; i++)\n        //            {\n        //                var tplBtn = template.ButtonParams[i];\n        //                var isDynamic = (tplBtn.ParameterValue?.Contains(\"{{1}}\") ?? false);\n\n        //                var userBtn = userButtons.FirstOrDefault(b => b.Position == i + 1);\n        //                var valueToSave = (isDynamic && userBtn != null)\n        //                    ? userBtn.Value?.Trim()\n        //                    : tplBtn.ParameterValue;\n\n        //                buttonsToSave.Add(new CampaignButton\n        //                {\n        //                    Id = Guid.NewGuid(),\n        //                    CampaignId = campaignId,\n        //                    Title = tplBtn.Text,\n        //                    Type = tplBtn.Type,\n        //                    Value = valueToSave,\n        //                    Position = i + 1,\n        //                    IsFromTemplate = true\n        //                });\n        //            }\n\n        //            await _context.CampaignButtons.AddRangeAsync(buttonsToSave);\n        //        }\n\n        //        // === NEW: schedule-aware status + enqueue job ===\n        //        // If ScheduledAt is in the future → mark as \"Queued\"/\"Scheduled\" and enqueue a job due at ScheduledAt.\n        //        // Else keep as \"Draft\" (user can send manually).\n        //        var nowUtc = DateTime.UtcNow;\n        //        if (campaign.ScheduledAt.HasValue && campaign.ScheduledAt.Value > nowUtc)\n        //        {\n        //            campaign.Status = \"Queued\"; // name it \"Scheduled\" if you have that enumeration in UI\n        //            campaign.UpdatedAt = nowUtc;\n\n        //            // One campaign → one active queued job. Since this is a fresh campaign, no job yet.\n        //            var job = new OutboundCampaignJob\n        //            {\n        //                Id = Guid.NewGuid(),\n        //                BusinessId = businessId,\n        //                CampaignId = campaign.Id,\n        //                Status = \"queued\",\n        //                Attempt = 0,\n        //                MaxAttempts = 5,\n        //                // CRITICAL: use UTC moment from ScheduledAt\n        //                NextAttemptAt = campaign.ScheduledAt.Value\n        //            };\n        //            await _context.OutboundCampaignJobs.AddAsync(job);\n        //        }\n        //        else\n        //        {\n        //            // Draft by default; user can trigger \"Send now\" elsewhere\n        //            campaign.Status = \"Draft\";\n        //        }\n\n        //        await _context.SaveChangesAsync();\n\n        //        Log.Information(\"✅ Campaign '{Name}' created | Type:{Type} | Header:{HeaderKind} | FlowId:{Flow} | EntryTemplate:{Entry} | Sender:{Provider}/{PhoneId} | Recipients:{Contacts} | ScheduledAt:{ScheduledAt} | Status:{Status}\",\n        //            dto.Name, finalCampaignType, headerKind,\n        //            savedFlowId,\n        //            entryStep?.TemplateToSend ?? selectedTemplateName,\n        //            providerNorm,\n        //            dto.PhoneNumberId,\n        //            dto.ContactIds?.Count ?? 0,\n        //            campaign.ScheduledAt,\n        //            campaign.Status);\n\n        //        return campaignId;\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        // If you want the FE to show the exact message (like duplicate-name),\n        //        // make sure your controller surfaces ex.Message in the response body.\n        //        Log.Error(ex, \"❌ Failed to create campaign\");\n        //        return null;\n        //    }\n        //}\n        public async Task<Guid?> CreateTextCampaignAsync(CampaignCreateDto dto, Guid businessId, string createdBy)\n        {\n            try\n            {\n                // === duplicate-name guard (per Business) ===\n                var nameExists = await _context.Campaigns\n                    .AsNoTracking()\n                    .AnyAsync(c => c.BusinessId == businessId && c.Name == dto.Name);\n                if (nameExists)\n                    throw new InvalidOperationException(\"A campaign with this name already exists for this business. Please choose a different name.\");\n\n                var campaignId = Guid.NewGuid();\n\n                // Parse template parameters once\n                var parsedParams = TemplateParameterHelper.ParseTemplateParams(\n                    JsonConvert.SerializeObject(dto.TemplateParameters ?? new List<string>())\n                );\n\n                // Validate + resolve sender (optional)\n                string? providerNorm = null;\n                if (!string.IsNullOrWhiteSpace(dto.PhoneNumberId))\n                {\n                    var pair = await _whisatsAppSenderService.ResolveSenderPairAsync(businessId, dto.PhoneNumberId);\n                    if (pair == null)\n                        throw new InvalidOperationException(\"❌ Selected sender is invalid or does not belong to this business.\");\n                    providerNorm = pair.Value.Provider; // normalized to UPPER\n                }\n\n                // Flow id from UI (null/empty => no flow)\n                Guid? incomingFlowId = (dto.CTAFlowConfigId.HasValue && dto.CTAFlowConfigId.Value != Guid.Empty)\n                    ? dto.CTAFlowConfigId.Value\n                    : (Guid?)null;\n\n                Guid? savedFlowId = incomingFlowId;\n\n                // FLOW VALIDATION (align starting template if flow provided)\n                string selectedTemplateName = dto.TemplateId ?? dto.MessageTemplate ?? string.Empty;\n\n                CTAFlowConfig? flow = null;\n                CTAFlowStep? entryStep = null;\n\n                if (incomingFlowId.HasValue)\n                {\n                    flow = await _context.CTAFlowConfigs\n                        .Include(f => f.Steps).ThenInclude(s => s.ButtonLinks)\n                        .FirstOrDefaultAsync(f =>\n                            f.Id == incomingFlowId.Value &&\n                            f.BusinessId == businessId &&\n                            f.IsActive);\n\n                    if (flow != null)\n                    {\n                        var allIncoming = new HashSet<Guid>(flow.Steps\n                            .SelectMany(s => s.ButtonLinks)\n                            .Where(l => l.NextStepId.HasValue)\n                            .Select(l => l.NextStepId!.Value));\n\n                        entryStep = flow.Steps\n                            .OrderBy(s => s.StepOrder)\n                            .FirstOrDefault(s => !allIncoming.Contains(s.Id));\n\n                        if (entryStep != null &&\n                            !string.Equals(selectedTemplateName, entryStep.TemplateToSend, StringComparison.OrdinalIgnoreCase))\n                        {\n                            selectedTemplateName = entryStep.TemplateToSend;\n                        }\n                    }\n                }\n\n                // === Fetch template strictly from DB (includes header kind + combined body if TEXT header) ===\n                var template = await _templateFetcherService.GetTemplateByNameAsync(\n                    businessId,\n                    selectedTemplateName,\n                    includeButtons: true\n                );\n                if (template == null)\n                    throw new InvalidOperationException($\"Template '{selectedTemplateName}' not found.\");\n\n                // Use template's combined body (TEXT header + body) so placeholders in header are also filled\n                var templateBody = template.Body ?? string.Empty;\n                var resolvedBody = TemplateParameterHelper.FillPlaceholders(templateBody, parsedParams);\n\n                // =========================\n                // Header kind + URL logic\n                // =========================\n                // Trust the template’s header kind; fall back to FE only if template says \"none\"\n                var headerKind = (template.HeaderKind ?? dto.HeaderKind ?? \"none\").Trim().ToLowerInvariant();\n\n                // If FE sent a conflicting kind, fail early (helps catch wrong selections)\n                if (!string.IsNullOrWhiteSpace(dto.HeaderKind) &&\n                    !string.Equals(headerKind, dto.HeaderKind.Trim().ToLowerInvariant(), StringComparison.Ordinal))\n                {\n                    throw new InvalidOperationException($\"Selected template requires a '{headerKind}' header, but request specified '{dto.HeaderKind}'.\");\n                }\n\n                bool isMediaHeader = headerKind is \"image\" or \"video\" or \"document\";\n\n                // Prefer unified HeaderMediaUrl; legacy ImageUrl still supported for \"image\"\n                string? headerUrl = string.IsNullOrWhiteSpace(dto.HeaderMediaUrl)\n                    ? (headerKind == \"image\" ? dto.ImageUrl : null)\n                    : dto.HeaderMediaUrl;\n\n                // For media headers, URL is mandatory\n                if (isMediaHeader && string.IsNullOrWhiteSpace(headerUrl))\n                    throw new InvalidOperationException(\"❌ Header media URL is required for this template.\");\n\n                // Campaign type: headerKind drives media campaigns; otherwise use FE value (default text)\n                string finalCampaignType = isMediaHeader\n                    ? headerKind                                   // \"image\" | \"video\" | \"document\"\n                    : (dto.CampaignType ?? \"text\").Trim().ToLowerInvariant();\n\n                if (finalCampaignType is not (\"image\" or \"video\" or \"document\"))\n                    finalCampaignType = \"text\";\n\n                // =========================================\n                // Create entity with correct media fields set\n                // =========================================\n                var campaign = new Campaign\n                {\n                    Id = campaignId,\n                    BusinessId = businessId,\n                    Name = dto.Name,\n\n                    MessageTemplate = dto.MessageTemplate,\n                    TemplateId = selectedTemplateName,\n\n                    FollowUpTemplateId = dto.FollowUpTemplateId,\n                    CampaignType = finalCampaignType,\n                    CtaId = dto.CtaId,\n                    CTAFlowConfigId = savedFlowId,\n\n                    ScheduledAt = dto.ScheduledAt, // FE should send UTC ISO\n                    CreatedBy = createdBy,\n                    CreatedAt = DateTime.UtcNow,\n                    UpdatedAt = DateTime.UtcNow,\n\n                    Status = \"Draft\",\n\n                    // Media fields (set exactly one depending on header kind)\n                    ImageUrl = headerKind == \"image\" ? headerUrl : null,\n                    ImageCaption = dto.ImageCaption,\n                    VideoUrl = headerKind == \"video\" ? headerUrl : null,\n                    DocumentUrl = headerKind == \"document\" ? headerUrl : null,\n\n                    TemplateParameters = JsonConvert.SerializeObject(dto.TemplateParameters ?? new List<string>()),\n                    MessageBody = resolvedBody,\n\n                    Provider = providerNorm,\n                    PhoneNumberId = dto.PhoneNumberId\n                };\n\n                // Snapshot template schema (from DB meta)\n                try\n                {\n                    var snapshotMeta = await _templateFetcherService.GetTemplateMetaAsync(\n                        businessId,\n                        selectedTemplateName,\n                        language: null,\n                        provider: providerNorm?.ToLowerInvariant()\n                    );\n\n                    campaign.TemplateSchemaSnapshot = snapshotMeta != null\n                        ? JsonConvert.SerializeObject(snapshotMeta)\n                        : JsonConvert.SerializeObject(new\n                        {\n                            Provider = providerNorm ?? \"\",\n                            TemplateName = selectedTemplateName,\n                            Language = template.Language ?? \"\"\n                        });\n                }\n                catch (Exception ex)\n                {\n                    Log.Warning(ex, \"⚠️ Template schema snapshot failed for campaign {CampaignId}\", campaignId);\n                }\n\n                await _context.Campaigns.AddAsync(campaign);\n\n                // Recipients\n                if (dto.ContactIds != null && dto.ContactIds.Any())\n                {\n                    var recipients = dto.ContactIds.Select(contactId => new CampaignRecipient\n                    {\n                        Id = Guid.NewGuid(),\n                        CampaignId = campaignId,\n                        ContactId = contactId,\n                        BusinessId = businessId,\n                        Status = \"Pending\",\n                        SentAt = null,\n                        UpdatedAt = DateTime.UtcNow\n                    });\n                    await _context.CampaignRecipients.AddRangeAsync(recipients);\n                }\n\n                // Custom buttons from FE\n                if (dto.MultiButtons != null && dto.MultiButtons.Any())\n                {\n                    var buttons = dto.MultiButtons\n                        .Where(btn => !string.IsNullOrWhiteSpace(btn.ButtonText) && !string.IsNullOrWhiteSpace(btn.TargetUrl))\n                        .Take(3)\n                        .Select((btn, index) => new CampaignButton\n                        {\n                            Id = Guid.NewGuid(),\n                            CampaignId = campaignId,\n                            Title = btn.ButtonText,\n                            Type = btn.ButtonType ?? \"url\",\n                            Value = btn.TargetUrl,\n                            Position = index + 1,\n                            IsFromTemplate = false\n                        });\n\n                    await _context.CampaignButtons.AddRangeAsync(buttons);\n                }\n\n                // Buttons coming from the template (DB metadata)\n                if (template.ButtonParams?.Count > 0)\n                {\n                    var buttonsToSave = new List<CampaignButton>();\n                    var userButtons = dto.ButtonParams ?? new List<CampaignButtonParamFromMetaDto>();\n\n                    var total = Math.Min(3, template.ButtonParams.Count);\n                    for (int i = 0; i < total; i++)\n                    {\n                        var tplBtn = template.ButtonParams[i];\n                        var isDynamic = (tplBtn.ParameterValue?.Contains(\"{{1}}\") ?? false);\n\n                        var userBtn = userButtons.FirstOrDefault(b => b.Position == i + 1);\n                        var valueToSave = (isDynamic && userBtn != null)\n                            ? userBtn.Value?.Trim()\n                            : tplBtn.ParameterValue;\n\n                        buttonsToSave.Add(new CampaignButton\n                        {\n                            Id = Guid.NewGuid(),\n                            CampaignId = campaignId,\n                            Title = tplBtn.Text,\n                            Type = tplBtn.Type,\n                            Value = valueToSave,\n                            Position = i + 1,\n                            IsFromTemplate = true\n                        });\n                    }\n\n                    await _context.CampaignButtons.AddRangeAsync(buttonsToSave);\n                }\n\n                // schedule-aware status + enqueue job\n                var nowUtc = DateTime.UtcNow;\n                if (campaign.ScheduledAt.HasValue && campaign.ScheduledAt.Value > nowUtc)\n                {\n                    campaign.Status = \"Queued\";\n                    campaign.UpdatedAt = nowUtc;\n\n                    var job = new OutboundCampaignJob\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        CampaignId = campaign.Id,\n                        Status = \"queued\",\n                        Attempt = 0,\n                        MaxAttempts = 5,\n                        NextAttemptAt = campaign.ScheduledAt.Value\n                    };\n                    await _context.OutboundCampaignJobs.AddAsync(job);\n                }\n                else\n                {\n                    campaign.Status = \"Draft\";\n                }\n\n                await _context.SaveChangesAsync();\n\n                Log.Information(\"✅ Campaign '{Name}' created | Type:{Type} | Header:{HeaderKind} | FlowId:{Flow} | EntryTemplate:{Entry} | Sender:{Provider}/{PhoneId} | Recipients:{Contacts} | ScheduledAt:{ScheduledAt} | Status:{Status}\",\n                    dto.Name, finalCampaignType, headerKind,\n                    savedFlowId,\n                    entryStep?.TemplateToSend ?? selectedTemplateName,\n                    providerNorm,\n                    dto.PhoneNumberId,\n                    dto.ContactIds?.Count ?? 0,\n                    campaign.ScheduledAt,\n                    campaign.Status);\n\n                return campaignId;\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"❌ Failed to create campaign\");\n                return null;\n            }\n        }\n\n        public async Task<Guid> CreateImageCampaignAsync(Guid businessId, CampaignCreateDto dto, string createdBy)\n        {\n            var campaignId = Guid.NewGuid();\n\n            // 🔁 Parse/normalize template parameters once\n            var parsedParams = TemplateParameterHelper.ParseTemplateParams(\n                JsonConvert.SerializeObject(dto.TemplateParameters ?? new List<string>())\n            );\n\n            // 🔄 Flow id from UI (null/empty => no flow). We will persist this as-is.\n            Guid? incomingFlowId = (dto.CTAFlowConfigId.HasValue && dto.CTAFlowConfigId.Value != Guid.Empty)\n                ? dto.CTAFlowConfigId.Value\n                : (Guid?)null;\n\n            // We will save this value regardless of validation outcome\n            Guid? savedFlowId = incomingFlowId;\n\n            // ============================================================\n            // 🧩 FLOW VALIDATION (only to align the starting template)\n            // ============================================================\n            string selectedTemplateName = dto.TemplateId ?? dto.MessageTemplate ?? string.Empty;\n\n            CTAFlowConfig? flow = null;\n            CTAFlowStep? entryStep = null;\n\n            if (incomingFlowId.HasValue)\n            {\n                // load flow with steps+links and verify ownership\n                flow = await _context.CTAFlowConfigs\n                    .Include(f => f.Steps).ThenInclude(s => s.ButtonLinks)\n                    .FirstOrDefaultAsync(f =>\n                        f.Id == incomingFlowId.Value &&\n                        f.BusinessId == businessId &&\n                        f.IsActive);\n\n                if (flow == null)\n                {\n                    Log.Warning(\"❌ Flow {FlowId} not found/active for business {Biz}. Will persist FlowId but not align template.\",\n                        incomingFlowId, businessId);\n                }\n                else\n                {\n                    // compute entry step: step with NO incoming links\n                    var allIncoming = new HashSet<Guid>(flow.Steps\n                        .SelectMany(s => s.ButtonLinks)\n                        .Where(l => l.NextStepId.HasValue)\n                        .Select(l => l.NextStepId!.Value));\n\n                    entryStep = flow.Steps\n                        .OrderBy(s => s.StepOrder)\n                        .FirstOrDefault(s => !allIncoming.Contains(s.Id));\n\n                    if (entryStep == null)\n                    {\n                        Log.Warning(\"❌ Flow {FlowId} has no entry step. Persisting FlowId but not aligning template.\", flow.Id);\n                    }\n                    else if (!string.Equals(selectedTemplateName, entryStep.TemplateToSend, StringComparison.OrdinalIgnoreCase))\n                    {\n                        Log.Information(\"ℹ️ Aligning selected template '{Sel}' to flow entry '{Entry}'.\",\n                            selectedTemplateName, entryStep.TemplateToSend);\n                        selectedTemplateName = entryStep.TemplateToSend;\n                    }\n                }\n            }\n            else\n            {\n                Log.Information(\"ℹ️ No flow attached to image campaign '{Name}'. Proceeding as plain template campaign.\", dto.Name);\n            }\n\n            // 🧠 Fetch template (for body + buttons) using the aligned/selected template name\n            var template = await _templateFetcherService.GetTemplateByNameAsync(\n                businessId,\n                selectedTemplateName,\n                includeButtons: true\n            );\n\n            // 🧠 Resolve message body using template body (if available) else dto.MessageTemplate\n            var templateBody = template?.Body ?? dto.MessageTemplate ?? string.Empty;\n            var resolvedBody = TemplateParameterHelper.FillPlaceholders(templateBody, parsedParams);\n\n            // 🎯 Step 1: Create campaign (CTAFlowConfigId now always = savedFlowId)\n            var campaign = new Campaign\n            {\n                Id = campaignId,\n                BusinessId = businessId,\n                Name = dto.Name,\n\n                // store the (possibly aligned) template name\n                MessageTemplate = dto.MessageTemplate,      // keep original text for UI if you use it\n                TemplateId = selectedTemplateName,          // ensure start template matches flow entry when available\n\n                FollowUpTemplateId = dto.FollowUpTemplateId,\n                CampaignType = \"image\",\n                CtaId = dto.CtaId,\n                CTAFlowConfigId = savedFlowId,              // 👈 persist what UI sent (or null if no flow)\n\n                ScheduledAt = dto.ScheduledAt,\n                CreatedBy = createdBy,\n                CreatedAt = DateTime.UtcNow,\n                UpdatedAt = DateTime.UtcNow,\n                Status = \"Draft\",\n\n                // image-specific fields\n                ImageUrl = dto.ImageUrl,\n                ImageCaption = dto.ImageCaption,\n\n                // params/body snapshot (useful for previews & auditing)\n                TemplateParameters = JsonConvert.SerializeObject(dto.TemplateParameters ?? new List<string>()),\n                MessageBody = resolvedBody\n            };\n            // 🔒 Step 2.1: Snapshot template schema (image path)\n            try\n            {\n                var snapshotMeta = await _templateFetcherService.GetTemplateMetaAsync(\n                    businessId,\n                    selectedTemplateName,\n                    language: null,\n                    provider: null\n                );\n\n                campaign.TemplateSchemaSnapshot = snapshotMeta != null\n                    ? JsonConvert.SerializeObject(snapshotMeta)\n                    : JsonConvert.SerializeObject(new\n                    {\n                        Provider = \"\",\n                        TemplateName = selectedTemplateName,\n                        Language = template?.Language ?? \"\"\n                    });\n            }\n            catch (Exception ex)\n            {\n                Log.Warning(ex, \"⚠️ Template schema snapshot failed for (image) campaign {CampaignId}\", campaignId);\n            }\n\n            await _context.Campaigns.AddAsync(campaign);\n\n            // ✅ Step 2: Assign contacts (leave SentAt null until send)\n            if (dto.ContactIds != null && dto.ContactIds.Any())\n            {\n                var recipients = dto.ContactIds.Select(contactId => new CampaignRecipient\n                {\n                    Id = Guid.NewGuid(),\n                    CampaignId = campaignId,\n                    ContactId = contactId,\n                    BusinessId = businessId,\n                    Status = \"Pending\",\n                    SentAt = null,\n                    UpdatedAt = DateTime.UtcNow\n                });\n\n                await _context.CampaignRecipients.AddRangeAsync(recipients);\n            }\n\n            // ✅ Step 3a: Save manual buttons from frontend\n            if (dto.MultiButtons != null && dto.MultiButtons.Any())\n            {\n                var buttons = dto.MultiButtons\n                    .Where(btn => !string.IsNullOrWhiteSpace(btn.ButtonText) && !string.IsNullOrWhiteSpace(btn.TargetUrl))\n                    .Take(3)\n                    .Select((btn, index) => new CampaignButton\n                    {\n                        Id = Guid.NewGuid(),\n                        CampaignId = campaignId,\n                        Title = btn.ButtonText,\n                        Type = btn.ButtonType ?? \"url\",\n                        Value = btn.TargetUrl,\n                        Position = index + 1,\n                        IsFromTemplate = false\n                    });\n\n                await _context.CampaignButtons.AddRangeAsync(buttons);\n            }\n\n            // ======================== Dynamic buttons merge ========================\n            // EXACTLY mirrors your text-creator pattern to avoid type issues with ButtonMetadataDto\n            if (template != null && template.ButtonParams?.Count > 0)\n            {\n                var buttonsToSave = new List<CampaignButton>();\n                var userButtons = dto.ButtonParams ?? new List<CampaignButtonParamFromMetaDto>();\n\n                var total = Math.Min(3, template.ButtonParams.Count);\n                for (int i = 0; i < total; i++)\n                {\n                    var tplBtn = template.ButtonParams[i];                         // ButtonMetadataDto: Text, Type, SubType, Index, ParameterValue\n                    var isDynamic = (tplBtn.ParameterValue?.Contains(\"{{1}}\") ?? false);\n\n                    var userBtn = userButtons.FirstOrDefault(b => b.Position == i + 1);\n                    var valueToSave = (isDynamic && userBtn != null)\n                        ? userBtn.Value?.Trim()                                    // user override for dynamic URL\n                        : tplBtn.ParameterValue;                                   // pattern or static value from meta\n\n                    buttonsToSave.Add(new CampaignButton\n                    {\n                        Id = Guid.NewGuid(),\n                        CampaignId = campaignId,\n                        Title = tplBtn.Text,                                       // from ButtonMetadataDto\n                        Type = tplBtn.Type,                                        // from ButtonMetadataDto\n                        Value = valueToSave,\n                        Position = i + 1,\n                        IsFromTemplate = true\n                    });\n                }\n\n                await _context.CampaignButtons.AddRangeAsync(buttonsToSave);\n            }\n            // ======================================================================\n\n            await _context.SaveChangesAsync();\n\n            Log.Information(\"✅ Image campaign '{Name}' created | FlowId: {Flow} | EntryTemplate: {Entry} | Recipients: {Contacts} | UserButtons: {ManualButtons} | TemplateButtons: {TemplateButtons} | Params: {Params}\",\n                dto.Name,\n                savedFlowId,\n                entryStep?.TemplateToSend ?? selectedTemplateName,\n                dto.ContactIds?.Count ?? 0,\n                dto.MultiButtons?.Count ?? 0,\n                template?.ButtonParams?.Count ?? 0,\n                dto.TemplateParameters?.Count ?? 0\n            );\n\n            return campaignId;\n        }\n        #endregion\n\n     \n        public async Task<bool> SendCampaignAsync(Guid campaignId, string ipAddress, string userAgent)\n        {\n            // 1) Load campaign (no tracking)\n            var campaign = await _context.Campaigns\n                .Where(c => c.Id == campaignId)\n                .Select(c => new { c.Id, c.BusinessId, c.TemplateId, MessageTemplate = c.MessageTemplate })\n                .AsNoTracking()\n                .FirstOrDefaultAsync();\n\n            if (campaign == null)\n            {\n                Log.Warning(\"🚫 Campaign {CampaignId} not found\", campaignId);\n                return false;\n            }\n\n            // 1.1) Resolve active WA settings → Provider + sender (optional)\n            var wa = await _whatsAppSettingsService.GetSettingsByBusinessIdAsync(campaign.BusinessId);\n            //if (wa is null)\n            //return ResponseResult.ErrorInfo(\"❌ WhatsApp settings not found for this business.\");\n\n            //.AsNoTracking()\n            //.Where(w => w.BusinessId == campaign.BusinessId && w.IsActive)\n            //.FirstOrDefaultAsync();\n\n            var provider = wa.Provider;\n            var phoneNumberId = wa.PhoneNumberId;         // optional\n\n            // 2) Load recipients with explicit LEFT JOINs to Contact and AudienceMember\n            var recipients = await (\n                from r in _context.CampaignRecipients.AsNoTracking()\n                where r.CampaignId == campaignId\n\n                join c in _context.Contacts.AsNoTracking()\n                    on r.ContactId equals c.Id into cg\n                from c in cg.DefaultIfEmpty()\n\n                join am in _context.AudienceMembers.AsNoTracking()\n                    on r.AudienceMemberId equals am.Id into amg\n                from am in amg.DefaultIfEmpty()\n\n                select new\n                {\n                    r.Id,\n                    r.ContactId,\n                    Phone = c != null && c.PhoneNumber != null ? c.PhoneNumber : am!.PhoneE164,\n                    Name = c != null && c.Name != null ? c.Name : am!.Name,\n                    ParamsJson = r.ResolvedParametersJson\n                })\n                .Where(x => !string.IsNullOrWhiteSpace(x.Phone))\n                .ToListAsync();\n\n            if (recipients.Count == 0)\n            {\n                Log.Warning(\"🚫 Campaign {CampaignId} has no recipients\", campaignId);\n                return false;\n            }\n\n            // 3) Mark Sending\n            var campaignRow = await _context.Campaigns.FirstAsync(c => c.Id == campaign.Id);\n            campaignRow.Status = \"Sending\";\n            campaignRow.UpdatedAt = DateTime.UtcNow;\n            await _context.SaveChangesAsync();\n\n            // 4) Parallel send\n            var throttleLimit = 5;\n            var total = recipients.Count;\n            var sent = 0;\n            var failed = 0;\n\n            await Parallel.ForEachAsync(\n                recipients,\n                new ParallelOptions { MaxDegreeOfParallelism = throttleLimit },\n                async (r, ct) =>\n                {\n                    try\n                    {\n                        var phone = r.Phone!;\n                        // NOTE: we intentionally do NOT inject profile name here.\n                        // Parameters come from frozen ResolvedParametersJson (if any).\n                        var parameters = ParseParams(r.ParamsJson);\n\n                        using var scope = _serviceProvider.CreateScope();\n                        var scopedDb = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n\n                        var dto = new SimpleTemplateMessageDto\n                        {\n                            Provider = provider,                 // ✅ REQUIRED by send method\n                            PhoneNumberId = phoneNumberId,       // optional sender override\n                            RecipientNumber = phone,\n                            TemplateName = campaign.TemplateId ?? campaign.MessageTemplate,\n                            TemplateParameters = parameters      // ✅ use frozen params (or empty list)\n                        };\n\n                        var result = await _messageEngineService\n                            .SendTemplateMessageSimpleAsync(campaign.BusinessId, dto);\n\n                        var sendLog = new CampaignSendLog\n                        {\n                            Id = Guid.NewGuid(),\n                            BusinessId = campaign.BusinessId,\n                            CampaignId = campaign.Id,\n                            ContactId = r.ContactId,            // Guid? OK to be null\n                            RecipientId = r.Id,\n                            TemplateId = campaign.TemplateId,\n                            MessageBody = campaign.MessageTemplate,\n                            MessageId = result.MessageId,       // ✅ capture WAMID\n                            SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                            ErrorMessage = result.Message,\n                            SentAt = DateTime.UtcNow,\n                            CreatedAt = DateTime.UtcNow,\n                            SourceChannel = \"whatsapp\",\n                            IpAddress = ipAddress,\n                            DeviceInfo = userAgent\n                            // (Optional) ButtonBundleJson = SnapshotTemplateButtons(...);\n                        };\n\n                        await scopedDb.CampaignSendLogs.AddAsync(sendLog, ct);\n\n                        var rec = await scopedDb.CampaignRecipients.FirstOrDefaultAsync(x => x.Id == r.Id, ct);\n                        if (rec != null)\n                        {\n                            rec.Status = result.Success ? \"Sent\" : \"Failed\";\n                            rec.MessagePreview = campaign.MessageTemplate;\n                            rec.SentAt = DateTime.UtcNow;\n                            rec.UpdatedAt = DateTime.UtcNow;\n                        }\n\n                        await scopedDb.SaveChangesAsync(ct);\n\n                        if (result.Success) Interlocked.Increment(ref sent);\n                        else Interlocked.Increment(ref failed);\n                    }\n                    catch (Exception ex)\n                    {\n                        Interlocked.Increment(ref failed);\n                        Log.Error(ex, \"❌ Send failed for recipient: {RecipientId}\", r.Id);\n                    }\n                });\n\n            // 5) Finalize\n            campaignRow = await _context.Campaigns.FirstAsync(c => c.Id == campaignId);\n            campaignRow.Status = \"Sent\";\n            campaignRow.UpdatedAt = DateTime.UtcNow;\n            await _context.SaveChangesAsync();\n\n            Log.Information(\"📤 Campaign {CampaignId} sent via template to {Count} recipients (✅ {Sent}, ❌ {Failed})\",\n                campaignId, total, sent, failed);\n\n            return sent > 0;\n\n            // ---- local helpers ----\n            static List<string> ParseParams(string? json)\n            {\n                if (string.IsNullOrWhiteSpace(json)) return new List<string>();\n                try\n                {\n                    var arr = System.Text.Json.JsonSerializer.Deserialize<List<string>>(json);\n                    return arr ?? new List<string>();\n                }\n                catch\n                {\n                    return new List<string>();\n                }\n            }\n        }\n        public async Task<bool> SendCampaignInParallelAsync(Guid campaignId, string ipAddress, string userAgent)\n        {\n            var campaign = await _context.Campaigns\n                .Include(c => c.Recipients)\n                .ThenInclude(r => r.Contact)\n                .FirstOrDefaultAsync(c => c.Id == campaignId);\n\n            if (campaign == null || campaign.Recipients.Count == 0)\n            {\n                Log.Warning(\"🚫 Campaign not found or has no recipients\");\n                return false;\n            }\n\n            campaign.Status = \"Sending\";\n            campaign.UpdatedAt = DateTime.UtcNow;\n            await _context.SaveChangesAsync();\n\n            int maxParallelism = 5;\n\n#if NET6_0_OR_GREATER\n            await Parallel.ForEachAsync(campaign.Recipients, new ParallelOptions\n            {\n                MaxDegreeOfParallelism = maxParallelism\n            },\n            async (recipient, cancellationToken) =>\n            {\n                await SendToRecipientAsync(campaign, recipient, ipAddress, userAgent);\n            });\n#else\n    var tasks = campaign.Recipients.Select(recipient =>\n        SendToRecipientAsync(campaign, recipient, ipAddress, userAgent)\n    );\n    await Task.WhenAll(tasks);\n#endif\n\n            campaign.Status = \"Sent\";\n            campaign.UpdatedAt = DateTime.UtcNow;\n            await _context.SaveChangesAsync();\n\n            Log.Information(\"📤 Campaign {CampaignId} sent in parallel to {Count} recipients\", campaign.Id, campaign.Recipients.Count);\n            return true;\n        }\n        private async Task SendToRecipientAsync(Campaign campaign, CampaignRecipient recipient, string ip, string ua)\n        {\n            try\n            {\n                var dto = new SimpleTemplateMessageDto\n                {\n                    RecipientNumber = recipient.Contact.PhoneNumber,\n                    TemplateName = campaign.TemplateId,// campaign.MessageTemplate,\n                    TemplateParameters = new List<string> { recipient.Contact.Name ?? \"Customer\" }\n                };\n\n                var result = await _messageEngineService.SendTemplateMessageSimpleAsync(campaign.BusinessId, dto);\n\n\n                var log = new CampaignSendLog\n                {\n                    Id = Guid.NewGuid(),\n                    CampaignId = campaign.Id,\n                    ContactId = recipient.ContactId,\n                    RecipientId = recipient.Id,\n                    TemplateId = campaign.TemplateId,\n                    MessageBody = campaign.MessageTemplate,\n                    MessageId = null,\n                    SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                    ErrorMessage = result.Message,\n                    SentAt = DateTime.UtcNow,\n                    CreatedAt = DateTime.UtcNow,\n                    SourceChannel = \"whatsapp\",\n                    IpAddress = ip,\n                    DeviceInfo = ua\n                };\n\n                lock (_context)\n                {\n                    _context.CampaignSendLogs.Add(log);\n                    recipient.Status = result.Success ? \"Sent\" : \"Failed\";\n                    recipient.MessagePreview = campaign.MessageTemplate;\n                    recipient.SentAt = DateTime.UtcNow;\n                    recipient.UpdatedAt = DateTime.UtcNow;\n                }\n\n                await _context.SaveChangesAsync();\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"❌ Failed to send template to recipient: {RecipientId}\", recipient.Id);\n            }\n        }\n\n        public async Task<bool> RemoveRecipientAsync(Guid businessId, Guid campaignId, Guid contactId)\n        {\n            var entry = await _context.CampaignRecipients\n                .FirstOrDefaultAsync(r =>\n                    r.CampaignId == campaignId &&\n                    r.ContactId == contactId &&\n                    r.Campaign.BusinessId == businessId); // ✅ Filter by related Campaign.BusinessId\n\n            if (entry == null)\n                return false;\n\n            _context.CampaignRecipients.Remove(entry);\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> AssignContactsToCampaignAsync(Guid campaignId, Guid businessId, List<Guid> contactIds)\n        {\n            var campaign = await _context.Campaigns\n                .Include(c => c.Recipients)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n\n            if (campaign == null)\n                return false;\n\n            var newRecipients = contactIds.Select(id => new CampaignRecipient\n            {\n                Id = Guid.NewGuid(),\n                CampaignId = campaignId,\n                ContactId = id,\n                BusinessId = businessId,\n                Status = \"Pending\",\n                SentAt = DateTime.UtcNow,\n                UpdatedAt = DateTime.UtcNow\n            });\n\n            _context.CampaignRecipients.AddRange(newRecipients);\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        // This is the Entry point to send Temaplte (Text Based and Image Based)\n        public async Task<ResponseResult> SendTemplateCampaignAsync(Guid campaignId)\n        {\n            try\n            {\n                var campaign = await _context.Campaigns\n                    .Include(c => c.Recipients)\n                        .ThenInclude(r => r.Contact) // 🧠 include contact details\n                    .Include(c => c.MultiButtons)\n                    .FirstOrDefaultAsync(c => c.Id == campaignId && !c.IsDeleted);\n\n                if (campaign == null)\n                    return ResponseResult.ErrorInfo(\"❌ Campaign not found.\");\n\n                if (campaign.Recipients == null || !campaign.Recipients.Any())\n                    return ResponseResult.ErrorInfo(\"❌ No recipients assigned to this campaign.\");\n\n                var templateName = campaign.MessageTemplate;\n                var templateId = campaign.TemplateId;\n                var language = \"en_US\"; // Optional: make dynamic later\n                var isImageTemplate = !string.IsNullOrEmpty(campaign.ImageUrl);\n\n                var templateParams = JsonConvert.DeserializeObject<List<string>>(campaign.TemplateParameters ?? \"[]\");\n\n                int success = 0, failed = 0;\n\n                foreach (var recipient in campaign.Recipients)\n                {\n                    var messageDto = new ImageTemplateMessageDto\n                    {\n                        // BusinessId = campaign.BusinessId,\n                        RecipientNumber = recipient.Contact.PhoneNumber,\n                        TemplateName = templateName,\n                        LanguageCode = language,\n                        HeaderImageUrl = isImageTemplate ? campaign.ImageUrl : null,\n                        TemplateParameters = templateParams,\n                        ButtonParameters = campaign.MultiButtons\n                            .OrderBy(b => b.Position)\n                            .Take(3)\n                            .Select(btn => new CampaignButtonDto\n                            {\n                                ButtonText = btn.Title,\n                                ButtonType = btn.Type,\n                                TargetUrl = btn.Value\n                            }).ToList()\n                    };\n\n                    // ✅ Call the image/template sender\n                    var sendResult = await _messageEngineService.SendImageTemplateMessageAsync(messageDto, campaign.BusinessId);\n                    var isSuccess = sendResult.ToString().ToLower().Contains(\"messages\");\n\n                    var log = new MessageLog\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = campaign.BusinessId,\n                        RecipientNumber = recipient.Contact.PhoneNumber,\n                        MessageContent = campaign.MessageBody,// templateName,\n                        MediaUrl = campaign.ImageUrl,\n                        Status = isSuccess ? \"Sent\" : \"Failed\",\n                        ErrorMessage = isSuccess ? null : \"API Failure\",\n                        RawResponse = JsonConvert.SerializeObject(sendResult),\n                        CreatedAt = DateTime.UtcNow,\n                        SentAt = DateTime.UtcNow\n                    };\n\n                    await _context.MessageLogs.AddAsync(log);\n\n                    if (isSuccess) success++;\n                    else failed++;\n                }\n\n                await _context.SaveChangesAsync();\n                return ResponseResult.SuccessInfo($\"✅ Sent: {success}, ❌ Failed: {failed}\");\n            }\n            catch (Exception ex)\n            {\n                return ResponseResult.ErrorInfo(\"❌ Unexpected error during campaign send.\", ex.ToString());\n            }\n        }\n\n        // #region  This region include all the code related to sending text and image based\n\n        public async Task<ResponseResult> SendTemplateCampaignWithTypeDetectionAsync(Guid campaignId, CancellationToken ct = default)\n        {\n            var correlationId = Guid.NewGuid();\n            var sw = System.Diagnostics.Stopwatch.StartNew();\n            using var scope = _logger.BeginScope(new Dictionary<string, object>\n            {\n                [\"corr\"] = correlationId,\n                [\"campaignId\"] = campaignId\n            });\n\n            _logger.LogInformation(\"[SendDetect] BEGIN send for campaign {CampaignId}\", campaignId);\n\n            // 1) Load a slim campaign snapshot \n            var campaignSnap = await _context.Campaigns\n                .AsNoTracking()\n                .Where(c => c.Id == campaignId && !c.IsDeleted)\n                .Select(c => new\n                {\n                    c.Id,\n                    c.BusinessId,\n                    c.CampaignType,\n                    c.TemplateId,\n                    c.MessageTemplate,\n                    c.TemplateParameters,\n                    c.ImageUrl,\n                    c.VideoUrl,\n                    c.DocumentUrl,\n                    c.CTAFlowConfigId,\n                    Recipients = c.Recipients\n                        .Where(r =>\n                            (r.Contact != null && r.Contact.PhoneNumber != null && r.Contact.PhoneNumber != \"\") ||\n                            (r.AudienceMember != null && (\n                                (r.AudienceMember.PhoneE164 != null && r.AudienceMember.PhoneE164 != \"\") ||\n                                (r.AudienceMember.PhoneRaw != null && r.AudienceMember.PhoneRaw != \"\")\n                            )))\n                        .Select(r => new\n                        {\n                            r.Id,\n                            r.ContactId,\n                            ContactPhone = r.Contact != null ? r.Contact.PhoneNumber : null,\n                            ContactName = r.Contact != null ? r.Contact.Name : null,\n                            AMPhoneE164 = r.AudienceMember != null ? r.AudienceMember.PhoneE164 : null,\n                            AMPhoneRaw = r.AudienceMember != null ? r.AudienceMember.PhoneRaw : null,\n                            AMName = r.AudienceMember != null ? r.AudienceMember.Name : null,\n                            AMAttributes = r.AudienceMember != null ? r.AudienceMember.AttributesJson : null\n                        })\n                        .ToList(),\n                    Buttons = c.MultiButtons\n                        .Select(b => new { b.Id, b.Position, b.Title, b.Type, b.Value })\n                        .ToList()\n                })\n                .FirstOrDefaultAsync(ct);\n\n            if (campaignSnap == null)\n            {\n                _logger.LogWarning(\"[SendDetect] ❌ Campaign not found\");\n                return ResponseResult.ErrorInfo(\"❌ Campaign not found.\");\n            }\n\n            _logger.LogInformation(\"[SendDetect] Loaded campaign snapshot: biz={Biz} recipients={Recipients} tplId={TplId} msgTpl={MsgTpl}\",\n                campaignSnap.BusinessId, campaignSnap.Recipients.Count, campaignSnap.TemplateId, campaignSnap.MessageTemplate);\n\n            if (campaignSnap.Recipients.Count == 0)\n            {\n                _logger.LogWarning(\"[SendDetect] ⚠️ No valid recipients with phone. total=0\");\n                return ResponseResult.ErrorInfo(\"⚠️ No valid recipients with phone numbers (checked Contact.PhoneNumber and AudienceMember.PhoneE164/PhoneRaw).\");\n            }\n\n            // 2) Flow entry template\n            var (_, entryTemplate) = await ResolveFlowEntryAsync(campaignSnap.BusinessId, campaignSnap.CTAFlowConfigId);\n            var tplName =\n                !string.IsNullOrWhiteSpace(entryTemplate) ? entryTemplate! :\n                !string.IsNullOrWhiteSpace(campaignSnap.TemplateId) ? campaignSnap.TemplateId! :\n                !string.IsNullOrWhiteSpace(campaignSnap.MessageTemplate) ? campaignSnap.MessageTemplate! :\n                string.Empty;\n\n            if (string.IsNullOrWhiteSpace(tplName))\n            {\n                _logger.LogWarning(\"[SendDetect] ❌ No template name (TemplateId/MessageTemplate/FlowEntry empty).\");\n                return ResponseResult.ErrorInfo(\"❌ Campaign has no template name (TemplateId/MessageTemplate is empty).\");\n            }\n\n            _logger.LogInformation(\"[SendDetect] Using template '{TplName}' (flowEntry={FlowEntry}, TemplateId={TplId}, MessageTemplate={MsgTpl})\",\n                tplName, entryTemplate, campaignSnap.TemplateId, campaignSnap.MessageTemplate);\n\n            // 3) Provider from settings\n            var setting = await _context.WhatsAppSettings\n                .AsNoTracking()\n                .Where(s => s.BusinessId == campaignSnap.BusinessId && s.IsActive)\n                .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                .FirstOrDefaultAsync(ct);\n\n            if (setting == null)\n            {\n                _logger.LogWarning(\"[SendDetect] ❌ WhatsApp settings not found for biz={Biz}\", campaignSnap.BusinessId);\n                return ResponseResult.ErrorInfo(\"❌ WhatsApp settings not found for this business.\");\n            }\n\n            var providerFromDb = (setting.Provider ?? string.Empty).Trim();\n            var providerUpper = providerFromDb.ToUpperInvariant();\n            _logger.LogInformation(\"[SendDetect] Provider={Provider}\", providerFromDb);\n\n            // 4) Template row from DB\n            var templateRow = await _context.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == campaignSnap.BusinessId\n                         && t.IsActive\n                         && t.Name == tplName\n                         && t.Provider == providerUpper)\n                .OrderByDescending(t => t.UpdatedAt)\n                .ThenByDescending(t => t.LastSyncedAt)\n                .FirstOrDefaultAsync(ct);\n\n            if (templateRow == null)\n            {\n                _logger.LogWarning(\"[SendDetect] ❌ Template not found in DB. biz={Biz} provider={Provider} name={Name}\",\n                    campaignSnap.BusinessId, providerFromDb, tplName);\n                return ResponseResult.ErrorInfo(\"❌ Campaign template not found in DB for this provider.\");\n            }\n\n            _logger.LogInformation(\"[SendDetect] Template row ok: name={Name} lang={Lang} status={Status} bodyLen={Len} placeholderCount(DB)={PC}\",\n                templateRow.Name, templateRow.LanguageCode, templateRow.Status, templateRow.Body?.Length ?? 0, templateRow.BodyVarCount);\n\n            // Recompute BODY placeholder count (supports POSITIONAL vs NAMED)\n            int recomputedBodyCount = 0;\n            try\n            {\n                recomputedBodyCount = CountBodyPlaceholdersFromRaw(\n                    templateRow.RawJson,\n                    templateRow.Body,\n                    templateRow.ParameterFormat // <- now passed through\n                );\n                if (recomputedBodyCount != Math.Max(0, templateRow.BodyVarCount))\n                {\n                    _logger.LogWarning(\"[SendDetect] PlaceholderCount mismatch: DB={DbCount} recomputed(BODY)={Recomputed} tpl={Tpl}\",\n                        templateRow.BodyVarCount, recomputedBodyCount, templateRow.Name);\n                }\n                else\n                {\n                    _logger.LogDebug(\"[SendDetect] PlaceholderCount verified: {Count}\", recomputedBodyCount);\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"[SendDetect] Failed to recompute BODY placeholder count for tpl={Tpl}\", templateRow.Name);\n            }\n\n            // 5) Infer media type\n            var headerKind = TemplateHeaderInspector.Infer(templateRow);\n            var inferredType = TemplateHeaderInspector.ToMediaType(headerKind);\n\n            var mediaType = (campaignSnap.CampaignType ?? string.Empty).Trim();\n            mediaType = string.IsNullOrEmpty(mediaType) || mediaType.Equals(\"auto\", StringComparison.OrdinalIgnoreCase)\n                ? inferredType\n                : mediaType.ToLowerInvariant();\n\n            _logger.LogInformation(\"[SendDetect] MediaType resolved: campaignType={CampaignType} inferred={Inferred} => chosen={Chosen}\",\n                campaignSnap.CampaignType, inferredType, mediaType);\n\n            // 6) Validate media URLs\n            if (mediaType == \"image\" && string.IsNullOrWhiteSpace(campaignSnap.ImageUrl))\n                return ResponseResult.ErrorInfo(\"🚫 Image template requires ImageUrl on the campaign.\");\n            if (mediaType == \"video\" && string.IsNullOrWhiteSpace(campaignSnap.VideoUrl))\n                return ResponseResult.ErrorInfo(\"🚫 Video template requires VideoUrl on the campaign.\");\n            if (mediaType == \"document\" && string.IsNullOrWhiteSpace(campaignSnap.DocumentUrl))\n                return ResponseResult.ErrorInfo(\"🚫 Document template requires DocumentUrl on the campaign.\");\n\n            // 6.1 Parameter mapping support\n            var parameterFormat = templateRow.ParameterFormat; // \"POSITIONAL\" | \"NAMED\"\n            var bodyParamNames = ExtractBodyParamNamesFromTemplate(templateRow.RawJson, templateRow.Body, parameterFormat);\n\n            // 7) Rehydrate light Campaign for downstream\n            var campaign = new Campaign\n            {\n                Id = campaignSnap.Id,\n                BusinessId = campaignSnap.BusinessId,\n                CampaignType = mediaType,\n                TemplateId = tplName,\n                MessageTemplate = tplName,\n                TemplateParameters = campaignSnap.TemplateParameters,\n                ImageUrl = campaignSnap.ImageUrl,\n                VideoUrl = campaignSnap.VideoUrl,\n                DocumentUrl = campaignSnap.DocumentUrl,\n                CTAFlowConfigId = campaignSnap.CTAFlowConfigId,\n                Provider = providerFromDb,\n                MultiButtons = campaignSnap.Buttons\n                    .OrderBy(b => b.Position)\n                    .Select(b => new CampaignButton\n                    {\n                        Id = b.Id,\n                        Position = b.Position,\n                        Title = b.Title,\n                        Type = b.Type,\n                        Value = b.Value\n                    })\n                    .ToList(),\n                Recipients = campaignSnap.Recipients.Select(r => new CampaignRecipient\n                {\n                    Id = r.Id,\n                    ContactId = r.ContactId,\n                    Contact = r.ContactPhone != null ? new Contact\n                    {\n                        PhoneNumber = r.ContactPhone,\n                        Name = r.ContactName\n                    } : null,\n                    AudienceMember = (r.AMPhoneE164 != null || r.AMPhoneRaw != null) ? new AudienceMember\n                    {\n                        PhoneE164 = r.AMPhoneE164,\n                        PhoneRaw = r.AMPhoneRaw,\n                        Name = r.AMName,\n                        AttributesJson = r.AMAttributes   // <-- add this\n                    } : null\n                }).ToList()\n            };\n\n            // 8) Unified enqueue (text | image | video | document)\n            {\n                var enqueueSw = System.Diagnostics.Stopwatch.StartNew();\n\n                var wa = await _whatsAppSettingsService.GetSettingsByBusinessIdAsync(campaign.BusinessId);\n                if (wa is null)\n                    return ResponseResult.ErrorInfo(\"❌ WhatsApp settings not found.\");\n\n                var languageCode = string.IsNullOrWhiteSpace(templateRow.LanguageCode) ? \"en_US\" : templateRow.LanguageCode!.Trim();\n\n                var buttonsOrdered = campaign.MultiButtons?\n                    .Select((b, idx) => new { Btn = b, idx })\n                    .OrderBy(x => (int?)x.Btn.Position ?? int.MaxValue)\n                    .ThenBy(x => x.idx)\n                    .Select(x => x.Btn)\n                    .ToList() ?? new List<CampaignButton>();\n\n                string? phoneNumberId = !string.IsNullOrWhiteSpace(campaign.PhoneNumberId)\n                    ? campaign.PhoneNumberId\n                    : wa.PhoneNumberId;\n\n                var isMeta = string.Equals(providerFromDb, \"META_CLOUD\", StringComparison.OrdinalIgnoreCase);\n                if (isMeta && string.IsNullOrWhiteSpace(phoneNumberId))\n                    return ResponseResult.ErrorInfo(\"❌ No PhoneNumberId configured for Meta Cloud sender.\");\n\n                static string? ResolvePhone(CampaignRecipient r) =>\n                    r?.Contact?.PhoneNumber ?? r?.AudienceMember?.PhoneE164 ?? r?.AudienceMember?.PhoneRaw;\n\n                var placeholderCount = Math.Max(0, recomputedBodyCount);\n\n                var templateMeta = new TemplateMetadataDto\n                {\n                    Name = templateRow.Name,\n                    Language = languageCode,\n                    Body = templateRow.Body,\n                    PlaceholderCount = placeholderCount,\n                    ButtonParams = string.IsNullOrWhiteSpace(templateRow.UrlButtons)\n                        ? new List<ButtonMetadataDto>()\n                        : (JsonConvert.DeserializeObject<List<ButtonMetadataDto>>(templateRow.UrlButtons!)\n                            ?? new List<ButtonMetadataDto>())\n                };\n\n                _logger.LogInformation(\"[SendDetect] Buttons: templateHas={TplBtnCount} campaignHas={CampBtnCount}\",\n                    templateMeta.ButtonParams.Count, buttonsOrdered.Count);\n\n                var now = DateTime.UtcNow;\n                var items = new List<(CampaignRecipient r, string paramsJson, string btnsJson, string? headerUrl, string idemKey)>();\n\n                int recipientsWithPhone = 0, recipientsMissingParams = 0;\n                foreach (var r in campaign.Recipients)\n                {\n                    var phone = ResolvePhone(r);\n                    if (string.IsNullOrWhiteSpace(phone))\n                    {\n                        _logger.LogWarning(\"[SendDetect] Skip recipient {RecipientId}: empty phone\", r.Id);\n                        continue;\n                    }\n                    recipientsWithPhone++;\n\n                    // BODY params (now supports POSITIONAL and NAMED)\n                    var resolvedParams = GetRecipientBodyParams(\n                        r,\n                        placeholderCount,\n                        campaign.TemplateParameters,\n                        bodyParamNames,\n                        parameterFormat\n                    );\n\n                    // Missing parameter check — use FILLED count (not just list length)\n                    var filled = resolvedParams.Count(v => !string.IsNullOrWhiteSpace(v));\n                    if (placeholderCount > 0 && filled < placeholderCount)\n                    {\n                        recipientsMissingParams++;\n                        var why = $\"Missing body parameter(s): expected {placeholderCount}, got {filled}.\";\n                        _logger.LogWarning(\"[SendDetect] Skip recipient {RecipientId}: {Why} resolved=[{Vals}] phone={Phone}\",\n                            r.Id, why, string.Join(\"|\", resolvedParams), phone);\n\n                        var logIdLocal = Guid.NewGuid();\n                        _context.MessageLogs.Add(new MessageLog\n                        {\n                            Id = logIdLocal,\n                            BusinessId = campaign.BusinessId,\n                            CampaignId = campaign.Id,\n                            ContactId = r.ContactId,\n                            RecipientNumber = phone,\n                            MessageContent = campaign.TemplateId,\n                            Status = \"Failed\",\n                            ErrorMessage = why,\n                            RawResponse = \"{\\\"local_error\\\":\\\"missing_template_body_params\\\"}\",\n                            CreatedAt = now,\n                            Source = \"campaign\",\n                            CTAFlowConfigId = campaign.CTAFlowConfigId\n                        });\n\n                        await _context.CampaignSendLogs.AddAsync(new CampaignSendLog\n                        {\n                            Id = Guid.NewGuid(),\n                            CampaignId = campaign.Id,\n                            BusinessId = campaign.BusinessId,\n                            ContactId = r.ContactId,\n                            RecipientId = r.Id,\n                            MessageBody = campaign.MessageBody ?? campaign.TemplateId,\n                            TemplateId = campaign.TemplateId!,\n                            SendStatus = \"Failed\",\n                            MessageLogId = logIdLocal,\n                            ErrorMessage = why,\n                            CreatedAt = now,\n                            CTAFlowConfigId = campaign.CTAFlowConfigId\n                        }, ct);\n\n                        continue;\n                    }\n\n                    // Resolve dynamic URL buttons for snapshot (using your existing builders)\n                    var contactForTemplating = r.Contact ?? new Contact\n                    {\n                        Id = Guid.Empty,\n                        BusinessId = campaign.BusinessId,\n                        PhoneNumber = phone,\n                        Name = r.Contact?.Name ?? r.AudienceMember?.Name ?? \"Customer\"\n                    };\n\n                    var dummySendLogId = Guid.NewGuid();\n                    List<string> resolvedButtonUrls;\n\n                    var btnComponents = string.Equals(providerFromDb, \"PINNACLE\", StringComparison.OrdinalIgnoreCase)\n                        ? BuildTextTemplateComponents_Pinnacle(resolvedParams, buttonsOrdered, templateMeta, dummySendLogId, contactForTemplating, out resolvedButtonUrls)\n                        : BuildTextTemplateComponents_Meta(resolvedParams, buttonsOrdered, templateMeta, dummySendLogId, contactForTemplating, out resolvedButtonUrls);\n\n                    _logger.LogDebug(\"[SendDetect] Recipient {RecipientId}: bodyResolved=[{Vals}] btnResolved=[{BtnVals}] btnCompCount={BtnCompCount}\",\n                        r.Id, string.Join(\"|\", resolvedParams), string.Join(\" , \", resolvedButtonUrls ?? new List<string>()), (btnComponents?.Count ?? 0));\n\n                    // persist materialization snapshot\n                    var recStub = new CampaignRecipient { Id = r.Id };\n                    _context.CampaignRecipients.Attach(recStub);\n                    recStub.ResolvedParametersJson = JsonConvert.SerializeObject(resolvedParams);\n                    recStub.ResolvedButtonUrlsJson = JsonConvert.SerializeObject(resolvedButtonUrls);\n                    recStub.MaterializedAt = now;\n                    recStub.UpdatedAt = now;\n\n                    string? headerUrl = mediaType switch\n                    {\n                        \"image\" => campaign.ImageUrl,\n                        \"video\" => campaign.VideoUrl,\n                        \"document\" => campaign.DocumentUrl,\n                        _ => null\n                    };\n\n                    var paramsJson = JsonConvert.SerializeObject(resolvedParams);\n                    var btnsJson = JsonConvert.SerializeObject(resolvedButtonUrls);\n                    var idemKey = Idempotency.Sha256(\n                        $\"{campaign.Id}|{phone}|{campaign.TemplateId}|{paramsJson}|{btnsJson}|{mediaType}|{headerUrl}\");\n\n                    items.Add((r, paramsJson, btnsJson, headerUrl, idemKey));\n\n                    _logger.LogInformation(\"[SendDetect] +EnqueueCandidate recipient={RecipientId} phone={Phone} idemKeyHashPrefix={Hash}\",\n                        r.Id, phone, idemKey.Substring(0, 8));\n                }\n\n                await _context.SaveChangesAsync(ct);\n\n                _logger.LogInformation(\"[SendDetect] Recipients summary: withPhone={WithPhone} missingParams={Missing} candidates={Candidates}\",\n                    recipientsWithPhone, recipientsMissingParams, items.Count);\n\n                if (items.Count == 0)\n                    return ResponseResult.ErrorInfo(\"No messages enqueued. Missing data for all recipients.\");\n\n                try\n                {\n                    _logger.LogInformation(\"[SendDetect] EnqueueOutboundJobsAsync start: mediaType={Media} template={Tpl} lang={Lang} phoneNumberId={PhoneId}\",\n                        mediaType, campaign.TemplateId, languageCode, phoneNumberId);\n\n                    await EnqueueOutboundJobsAsync(\n                        campaign: campaign,\n                        provider: providerFromDb,\n                        mediaType: mediaType,\n                        templateName: campaign.TemplateId!,\n                        languageCode: languageCode,\n                        phoneNumberId: phoneNumberId,\n                        items: items\n                    );\n\n                    enqueueSw.Stop();\n                    _logger.LogInformation(\"[SendDetect] Enqueue done in {Ms} ms. Items={Count}\", enqueueSw.ElapsedMilliseconds, items.Count);\n\n                    sw.Stop();\n                    _logger.LogInformation(\"[SendDetect] ✅ SUCCESS in {Ms} ms\", sw.ElapsedMilliseconds);\n\n                    return ResponseResult.SuccessInfo($\"📤 Enqueued {items.Count} {mediaType} message(s) for async delivery.\");\n                }\n                catch (Exception ex)\n                {\n                    enqueueSw.Stop();\n                    _logger.LogError(ex, \"[SendDetect] ❌ Enqueue failed after {Ms} ms\", enqueueSw.ElapsedMilliseconds);\n                    return ResponseResult.ErrorInfo(\"❌ Failed to enqueue outbound jobs.\");\n                }\n            }\n\n            // ── local: BODY placeholder counter (POSITIONAL vs NAMED) ───────────────────────\n            int CountBodyPlaceholdersFromRaw(string? raw, string? bodyFallback, string? parameterFormat = null)\n            {\n                try\n                {\n                    if (!string.IsNullOrWhiteSpace(raw))\n                    {\n                        using var doc = System.Text.Json.JsonDocument.Parse(raw);\n                        if (doc.RootElement.TryGetProperty(\"components\", out var comps) &&\n                            comps.ValueKind == System.Text.Json.JsonValueKind.Array)\n                        {\n                            foreach (var c in comps.EnumerateArray())\n                            {\n                                if (c.TryGetProperty(\"type\", out var typeProp) &&\n                                    string.Equals(typeProp.GetString(), \"BODY\", StringComparison.OrdinalIgnoreCase))\n                                {\n                                    if (c.TryGetProperty(\"text\", out var textProp))\n                                    {\n                                        var body = textProp.GetString();\n                                        return CountCurlies(body, parameterFormat);\n                                    }\n                                    break;\n                                }\n                            }\n                        }\n                    }\n                }\n                catch (System.Text.Json.JsonException)\n                {\n                    // ignore parse errors\n                }\n                catch { /* diagnostics only */ }\n\n                return CountCurlies(bodyFallback, parameterFormat);\n\n                static int CountCurlies(string? s, string? parameterFormat)\n                {\n                    if (string.IsNullOrEmpty(s)) return 0;\n\n                    var fmt = (parameterFormat ?? \"POSITIONAL\").Trim().ToUpperInvariant();\n\n                    if (fmt == \"POSITIONAL\")\n                    {\n                        // Only {{1}}, {{2}}, ...\n                        return System.Text.RegularExpressions.Regex.Matches(s, @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count;\n                    }\n                    else if (fmt == \"NAMED\")\n                    {\n                        // Only {{name_like_this}}\n                        return System.Text.RegularExpressions.Regex.Matches(s, @\"\\{\\{\\s*[A-Za-z_][A-Za-z0-9_]*\\s*\\}\\}\").Count;\n                    }\n\n                    return 0;\n                }\n            }\n        }\n\n\n        private static List<string> GetRecipientBodyParams(\n            CampaignRecipient r,\n            int expectedCount,\n            string? campaignTemplateParameters,\n            List<string>? bodyParamNames,\n            string? parameterFormat)\n        {\n            // 1) Start from campaign-level values (often \"[]\", i.e., empty)\n            var values = TemplateParameterHelper.ParseTemplateParams(campaignTemplateParameters)?.ToList()\n                         ?? new List<string>();\n\n            // 2) Trim/pad to expected slots\n            if (values.Count > expectedCount) values = values.Take(expectedCount).ToList();\n            while (values.Count < expectedCount) values.Add(string.Empty);\n\n            // 3) Fill gaps from per-recipient attributes\n            var fmt = (parameterFormat ?? \"POSITIONAL\").Trim().ToUpperInvariant();\n            var attrs = ParseAttributes(r); // e.g., { parameter1: \"Nicolus Benz\", parameter2: \"Email\" }\n\n            if (attrs != null)\n            {\n                if (fmt == \"POSITIONAL\")\n                {\n                    for (int i = 0; i < expectedCount; i++)\n                    {\n                        if (!string.IsNullOrWhiteSpace(values[i])) continue;\n\n                        var key = \"parameter\" + (i + 1);      // {{1}} ← parameter1, {{2}} ← parameter2 ...\n                        if (attrs.TryGetValue(key, out var v) && !string.IsNullOrWhiteSpace(v))\n                            values[i] = v!;\n                    }\n                }\n                else if (fmt == \"NAMED\" && bodyParamNames != null && bodyParamNames.Count > 0)\n                {\n                    // Map named placeholders from attributes with matching keys\n                    var nameToIndex = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);\n                    for (int i = 0; i < bodyParamNames.Count; i++)\n                        if (!nameToIndex.ContainsKey(bodyParamNames[i])) nameToIndex[bodyParamNames[i]] = i;\n\n                    foreach (var kv in attrs)\n                    {\n                        if (nameToIndex.TryGetValue(kv.Key, out var idx) &&\n                            idx < values.Count &&\n                            string.IsNullOrWhiteSpace(values[idx]) &&\n                            !string.IsNullOrWhiteSpace(kv.Value))\n                        {\n                            values[idx] = kv.Value!;\n                        }\n                    }\n                }\n            }\n\n            // 4) Friendly default for slot 1 if still empty\n            if (expectedCount > 0 && values.Count > 0 && string.IsNullOrWhiteSpace(values[0]))\n                values[0] = r?.Contact?.Name ?? r?.AudienceMember?.Name ?? string.Empty;\n\n            // 5) Normalize whitespace\n            for (int i = 0; i < values.Count; i++)\n                values[i] = values[i]?.Trim() ?? string.Empty;\n\n            return values;\n        }\n        private static Dictionary<string, string>? ParseAttributes(CampaignRecipient r)\n        {\n            var raw = r?.AudienceMember?.AttributesJson;\n            if (string.IsNullOrWhiteSpace(raw)) return null;\n\n            try\n            {\n                var obj = JsonConvert.DeserializeObject<Dictionary<string, object>>(raw);\n                if (obj == null) return null;\n\n                var dict = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n                foreach (var kv in obj)\n                    dict[kv.Key] = kv.Value?.ToString() ?? string.Empty;\n\n                return dict;\n            }\n            catch\n            {\n                return null;\n            }\n        }\n\n        private static List<string>? ExtractBodyParamNamesFromTemplate(string? rawJson, string? bodyFallback, string? parameterFormat)\n        {\n            var fmt = (parameterFormat ?? \"POSITIONAL\").Trim().ToUpperInvariant();\n            if (fmt != \"NAMED\") return null;\n\n            // 1) Try provider RAW JSON → components[type=BODY].text\n            string? bodyText = null;\n            if (!string.IsNullOrWhiteSpace(rawJson))\n            {\n                try\n                {\n                    using var doc = System.Text.Json.JsonDocument.Parse(rawJson);\n                    if (doc.RootElement.TryGetProperty(\"components\", out var comps) &&\n                        comps.ValueKind == System.Text.Json.JsonValueKind.Array)\n                    {\n                        foreach (var c in comps.EnumerateArray())\n                        {\n                            if (c.TryGetProperty(\"type\", out var tp) &&\n                                string.Equals(tp.GetString(), \"BODY\", StringComparison.OrdinalIgnoreCase) &&\n                                c.TryGetProperty(\"text\", out var tprop))\n                            {\n                                bodyText = tprop.GetString();\n                                break;\n                            }\n                        }\n                    }\n                }\n                catch { /* ignore malformed provider JSON */ }\n            }\n\n            bodyText ??= bodyFallback;\n            if (string.IsNullOrWhiteSpace(bodyText)) return new List<string>(0);\n\n            // 2) Pull {{name_like_this}} in order; keep unique, valid identifiers\n            var names = new List<string>();\n            var seen = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n            foreach (System.Text.RegularExpressions.Match m in\n                     System.Text.RegularExpressions.Regex.Matches(bodyText, @\"\\{\\{\\s*([A-Za-z_][A-Za-z0-9_]*)\\s*\\}\\}\"))\n            {\n                var name = m.Groups[1].Value;\n                if (seen.Add(name)) names.Add(name);\n            }\n            return names;\n        }\n\n        public async Task<ResponseResult> SendTextTemplateCampaignAsync(Campaign campaign)\n        {\n            try\n            {\n                if (campaign == null || campaign.IsDeleted)\n                    return ResponseResult.ErrorInfo(\"❌ Invalid campaign.\");\n                if (campaign.Recipients == null || campaign.Recipients.Count == 0)\n                    return ResponseResult.ErrorInfo(\"❌ No recipients to send.\");\n\n                var businessId = campaign.BusinessId;\n\n                // 0) Filter recipients that actually have a phone\n                static string? ResolveRecipientPhone(CampaignRecipient r) =>\n                    r?.Contact?.PhoneNumber ?? r?.AudienceMember?.PhoneE164 ?? r?.AudienceMember?.PhoneRaw;\n\n                var recipients = campaign.Recipients\n                    .Where(r => !string.IsNullOrWhiteSpace(ResolveRecipientPhone(r)))\n                    .ToList();\n\n                if (recipients.Count == 0)\n                    return ResponseResult.ErrorInfo(\"⚠️ No valid recipients with phone numbers (Contact/AudienceMember).\");\n\n                // 1) Flow/template selection\n                var (_, entryTemplate) = await ResolveFlowEntryAsync(businessId, campaign.CTAFlowConfigId);\n                var templateKey = !string.IsNullOrWhiteSpace(entryTemplate)\n                    ? entryTemplate!.Trim()\n                    : (campaign.TemplateId ?? campaign.MessageTemplate ?? \"\").Trim();\n\n                if (string.IsNullOrWhiteSpace(templateKey))\n                    return ResponseResult.ErrorInfo(\"❌ No template selected.\");\n\n                // 2) WhatsApp settings\n                var wa = await _whatsAppSettingsService.GetSettingsByBusinessIdAsync(businessId);\n                if (wa is null)\n                    return ResponseResult.ErrorInfo(\"❌ WhatsApp settings not found.\");\n\n                // DB stores Provider in UPPERCASE\n                var provider = (wa.Provider ?? string.Empty).Trim();\n                var providerUpper = provider.ToUpperInvariant();\n\n                // 3) Fetch template from DB (NO network)\n                // Try provider TemplateId first; if not found, fall back to Name.\n                WhatsAppTemplate? templateRow = await _context.WhatsAppTemplates\n                    .AsNoTracking()\n                    .Where(t => t.BusinessId == businessId &&\n                                t.IsActive &&\n                                t.Provider == providerUpper &&\n                                t.TemplateId == templateKey)\n                    .OrderByDescending(t => t.UpdatedAt)\n                    .ThenByDescending(t => t.LastSyncedAt)\n                    .FirstOrDefaultAsync();\n\n                if (templateRow is null)\n                {\n                    templateRow = await _context.WhatsAppTemplates\n                        .AsNoTracking()\n                        .Where(t => t.BusinessId == businessId &&\n                                    t.IsActive &&\n                                    t.Provider == providerUpper &&\n                                    t.Name == templateKey)\n                        .OrderByDescending(t => t.UpdatedAt)\n                        .ThenByDescending(t => t.LastSyncedAt)\n                        .FirstOrDefaultAsync();\n                }\n\n                if (templateRow == null)\n                    return ResponseResult.ErrorInfo(\"❌ Template not found in DB for this business/provider.\");\n\n                // Map DB row -> DTO used by builders\n                var templateMeta = new TemplateMetadataDto\n                {\n                    Name = templateRow.Name,\n                    Language = templateRow.LanguageCode,\n                    Body = templateRow.Body,\n                    // FINAL MODEL: body-only placeholders live in BodyVarCount\n                    PlaceholderCount = Math.Max(0, templateRow.BodyVarCount),\n                    ButtonParams = ParseUrlButtonsToButtonMeta(templateRow.UrlButtons)\n                };\n\n                var languageCode = (templateMeta.Language ?? \"\").Trim();\n                if (string.IsNullOrWhiteSpace(languageCode))\n                    return ResponseResult.ErrorInfo(\"❌ Template language missing in DB.\");\n\n                // 4) Campaign buttons (order by Position)\n                var buttons = campaign.MultiButtons?.OrderBy(b => b.Position).ToList()\n                              ?? new List<CampaignButton>();\n\n                // Sender override; if missing, use WA DTO value\n                string? phoneNumberIdOverride = !string.IsNullOrWhiteSpace(campaign.PhoneNumberId)\n                    ? campaign.PhoneNumberId\n                    : wa.PhoneNumberId;\n\n                // Meta Cloud must have a PhoneNumberId\n                if (providerUpper == \"META_CLOUD\" && string.IsNullOrWhiteSpace(phoneNumberIdOverride))\n                    return ResponseResult.ErrorInfo(\"❌ No PhoneNumberId configured for Meta Cloud sender.\");\n\n                // 5) Optional flow entry step id\n                Guid? entryStepId = null;\n                if (campaign.CTAFlowConfigId.HasValue)\n                {\n                    entryStepId = await _context.CTAFlowSteps\n                        .Where(s => s.CTAFlowConfigId == campaign.CTAFlowConfigId.Value)\n                        .OrderBy(s => s.StepOrder)\n                        .Select(s => (Guid?)s.Id)\n                        .FirstOrDefaultAsync();\n                }\n\n                // 6) Freeze button bundle for click-tracking (from template meta)\n                string? buttonBundleJson = null;\n                if (templateMeta.ButtonParams is { Count: > 0 })\n                {\n                    var bundle = templateMeta.ButtonParams\n                        .OrderBy(b => b.Index)\n                        .Take(3)\n                        .Select((b, i) => new\n                        {\n                            i,\n                            position = i + 1,\n                            text = (b.Text ?? \"\").Trim(),\n                            type = b.Type,\n                            subType = b.SubType\n                        })\n                        .ToList();\n                    buttonBundleJson = JsonConvert.SerializeObject(bundle);\n                }\n\n                // 7) Preload AudienceMember phone/name for recipients that don’t have a Contact\n                var neededMemberIds = recipients\n                    .Where(x => x.ContactId == null && x.AudienceMemberId != null)\n                    .Select(x => x.AudienceMemberId!.Value)\n                    .Distinct()\n                    .ToList();\n\n                var audienceLookup = neededMemberIds.Count == 0\n                    ? new Dictionary<Guid, (string Phone, string? Name)>()\n                    : await _context.AudienceMembers.AsNoTracking()\n                        .Where(m => m.BusinessId == businessId && neededMemberIds.Contains(m.Id))\n                        .Select(m => new { m.Id, m.PhoneE164, m.PhoneRaw, m.Name })\n                        .ToDictionaryAsync(\n                            x => x.Id,\n                            x => (Phone: string.IsNullOrWhiteSpace(x.PhoneE164) ? (x.PhoneRaw ?? \"\") : x.PhoneE164,\n                                  Name: x.Name)\n                        );\n\n                int successCount = 0, failureCount = 0;\n                var now = DateTime.UtcNow;\n                // Derive format + named BODY param names from the stored template\n                var parameterFormat = (templateRow.ParameterFormat ?? \"POSITIONAL\").Trim().ToUpperInvariant();\n                var bodyParamNames = ExtractBodyParamNamesFromTemplate(templateRow.RawJson, templateRow.Body, parameterFormat);\n\n                foreach (var r in recipients)\n                {\n                    // Resolve actual phone + fallback name\n                    var phone = ResolveRecipientPhone(r);\n                    string? name = r.Contact?.Name;\n\n                    if (string.IsNullOrWhiteSpace(phone) && r.AudienceMemberId != null &&\n                        audienceLookup.TryGetValue(r.AudienceMemberId.Value, out var a) &&\n                        !string.IsNullOrWhiteSpace(a.Phone))\n                    {\n                        phone = a.Phone;\n                        name ??= a.Name ?? \"Customer\";\n                    }\n\n                    if (string.IsNullOrWhiteSpace(phone))\n                    {\n                        failureCount++;\n                        continue; // nothing to send to\n                    }\n\n                    // For templating only (do NOT attach to EF)\n                    var contactForTemplating = r.Contact ?? new Contact\n                    {\n                        Id = Guid.Empty,\n                        BusinessId = businessId,\n                        PhoneNumber = phone,\n                        Name = name ?? \"Customer\"\n                    };\n\n                    var runId = Guid.NewGuid();\n                    var campaignSendLogId = Guid.NewGuid();\n\n                    // BODY params per recipient\n                    // var resolvedParams = GetRecipientBodyParams(r, templateMeta.PlaceholderCount, campaign.TemplateParameters);\n                    var resolvedParams = GetRecipientBodyParams(\n                        r,\n                        templateMeta.PlaceholderCount,\n                        campaign.TemplateParameters,\n                        bodyParamNames,\n                        parameterFormat\n                    );\n                    // If template expects body placeholders, block send when blanks exist\n                    if (templateMeta.PlaceholderCount > 0 && resolvedParams.Any(string.IsNullOrWhiteSpace))\n                    {\n                        failureCount++;\n                        var why = $\"Missing body parameter(s): expected {templateMeta.PlaceholderCount}, got {resolvedParams.Count(x => !string.IsNullOrWhiteSpace(x))} filled.\";\n\n                        // Attach recipient stub to update without creating related entities\n                        var recStub1 = new CampaignRecipient { Id = r.Id };\n                        _context.CampaignRecipients.Attach(recStub1);\n                        recStub1.MaterializedAt = now;\n                        recStub1.UpdatedAt = now;\n                        recStub1.ResolvedParametersJson = JsonConvert.SerializeObject(resolvedParams);\n\n                        // Log locally as a failed send without calling provider\n                        var logIdLocal = Guid.NewGuid();\n                        _context.MessageLogs.Add(new MessageLog\n                        {\n                            Id = logIdLocal,\n                            BusinessId = businessId,\n                            CampaignId = campaign.Id,\n                            ContactId = r.ContactId, // may be null\n                            RecipientNumber = phone,\n                            MessageContent = campaign.MessageBody,\n                            Status = \"Failed\",\n                            ErrorMessage = why,\n                            RawResponse = \"{\\\"local_error\\\":\\\"missing_template_body_params\\\"}\",\n                            CreatedAt = now,\n                            Source = \"campaign\",\n                            CTAFlowConfigId = campaign.CTAFlowConfigId,\n                            CTAFlowStepId = entryStepId,\n                            ButtonBundleJson = buttonBundleJson,\n                            RunId = runId\n                        });\n\n                        await _context.CampaignSendLogs.AddAsync(new CampaignSendLog\n                        {\n                            Id = campaignSendLogId,\n                            CampaignId = campaign.Id,\n                            BusinessId = businessId,\n                            ContactId = r.ContactId,  // may be null\n                            RecipientId = r.Id,\n                            MessageBody = campaign.MessageBody ?? templateKey,\n                            TemplateId = templateKey,\n                            SendStatus = \"Failed\",\n                            MessageLogId = logIdLocal,\n                            ErrorMessage = why,\n                            CreatedAt = now,\n                            CreatedBy = campaign.CreatedBy,\n                            CTAFlowConfigId = campaign.CTAFlowConfigId,\n                            CTAFlowStepId = entryStepId,\n                            ButtonBundleJson = buttonBundleJson,\n                            RunId = runId\n                        });\n\n                        continue; // skip provider call\n                    }\n\n                    // Build components using DB template meta\n                    List<string> resolvedButtonUrls;\n                    object components = providerUpper == \"PINNACLE\"\n                        ? BuildTextTemplateComponents_Pinnacle(resolvedParams, buttons, templateMeta, campaignSendLogId, contactForTemplating, out resolvedButtonUrls)\n                        : BuildTextTemplateComponents_Meta(resolvedParams, buttons, templateMeta, campaignSendLogId, contactForTemplating, out resolvedButtonUrls);\n\n                    var payload = new\n                    {\n                        messaging_product = \"whatsapp\",\n                        to = phone,\n                        type = \"template\",\n                        template = new\n                        {\n                            name = templateKey,\n                            language = new { code = languageCode }, // from DB\n                            components\n                        }\n                    };\n\n                    // Freeze recipient materialization BEFORE send — attach via STUB\n                    var recStub2 = new CampaignRecipient { Id = r.Id };\n                    _context.CampaignRecipients.Attach(recStub2);\n                    recStub2.ResolvedParametersJson = JsonConvert.SerializeObject(resolvedParams);\n                    recStub2.ResolvedButtonUrlsJson = JsonConvert.SerializeObject(resolvedButtonUrls);\n                    recStub2.MaterializedAt = now;\n                    recStub2.UpdatedAt = now;\n                    recStub2.IdempotencyKey = Idempotency.Sha256($\"{campaign.Id}|{phone}|{templateKey}|{recStub2.ResolvedParametersJson}|{recStub2.ResolvedButtonUrlsJson}\");\n\n                    var result = await _messageEngineService.SendPayloadAsync(businessId, providerUpper, payload, phoneNumberIdOverride);\n\n                    var logId = Guid.NewGuid();\n                    _context.MessageLogs.Add(new MessageLog\n                    {\n                        Id = logId,\n                        BusinessId = businessId,\n                        CampaignId = campaign.Id,\n                        ContactId = r.ContactId, // may be null\n                        RecipientNumber = phone,\n                        MessageContent = templateKey,\n                        Status = result.Success ? \"Sent\" : \"Failed\",\n                        MessageId = result.MessageId,\n                        ErrorMessage = result.ErrorMessage,\n                        RawResponse = result.RawResponse,\n                        CreatedAt = now,\n                        SentAt = result.Success ? now : (DateTime?)null,\n                        Source = \"campaign\",\n                        CTAFlowConfigId = campaign.CTAFlowConfigId,\n                        CTAFlowStepId = entryStepId,\n                        ButtonBundleJson = buttonBundleJson,\n                        RunId = runId\n                    });\n\n                    await _billingIngest.IngestFromSendResponseAsync(\n                        businessId: businessId,\n                        messageLogId: logId,\n                        provider: providerUpper,\n                        rawResponseJson: result.RawResponse ?? \"{}\"\n                    );\n\n                    await _context.CampaignSendLogs.AddAsync(new CampaignSendLog\n                    {\n                        Id = campaignSendLogId,\n                        CampaignId = campaign.Id,\n                        BusinessId = businessId,\n                        ContactId = r.ContactId,  // may be null\n                        RecipientId = r.Id,\n                        MessageBody = campaign.MessageBody ?? templateKey,\n                        TemplateId = templateKey,\n                        SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                        MessageLogId = logId,\n                        MessageId = result.MessageId,\n                        ErrorMessage = result.ErrorMessage,\n                        CreatedAt = now,\n                        SentAt = result.Success ? now : (DateTime?)null,\n                        CreatedBy = campaign.CreatedBy,\n                        CTAFlowConfigId = campaign.CTAFlowConfigId,\n                        CTAFlowStepId = entryStepId,\n                        ButtonBundleJson = buttonBundleJson,\n                        RunId = runId\n                    });\n\n                    if (result.Success) successCount++; else failureCount++;\n                }\n\n                await _context.SaveChangesAsync();\n                return ResponseResult.SuccessInfo($\"📤 Sent to {successCount} recipients. ❌ Failed for {failureCount}.\");\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Error while sending text template campaign\");\n                return ResponseResult.ErrorInfo(\"🚨 Unexpected error while sending campaign.\", ex.ToString());\n            }\n        }\n\n        private static List<ButtonMetadataDto> ParseUrlButtonsToButtonMeta(string? urlButtonsJson)\n        {\n            if (string.IsNullOrWhiteSpace(urlButtonsJson)) return new List<ButtonMetadataDto>();\n\n            try\n            {\n                var arr = Newtonsoft.Json.Linq.JArray.Parse(urlButtonsJson);\n                var list = new List<ButtonMetadataDto>(arr.Count);\n\n                foreach (var j in arr)\n                {\n                    var idx = (int?)(j?[\"index\"]) ?? list.Count;\n                    list.Add(new ButtonMetadataDto\n                    {\n                        Index = idx,\n                        Type = \"URL\",\n                        SubType = \"url\",\n                        Text = \"\",          // label isn’t stored in UrlButtons; keep empty\n                        ParameterValue = null        // may be resolved later; parameters exist in j[\"parameters\"]\n                    });\n                }\n                return list;\n            }\n            catch\n            {\n                return new List<ButtonMetadataDto>();\n            }\n        }\n\n        private static bool IsHttpsMp4Url(string? url, out string? normalizedError)\n        {\n            normalizedError = null;\n            if (string.IsNullOrWhiteSpace(url))\n            {\n                normalizedError = \"Missing VideoUrl.\";\n                return false;\n            }\n\n            if (!Uri.TryCreate(url.Trim(), UriKind.Absolute, out var uri))\n            {\n                normalizedError = \"VideoUrl is not a valid absolute URL.\";\n                return false;\n            }\n\n            if (!uri.Scheme.Equals(\"https\", StringComparison.OrdinalIgnoreCase))\n            {\n                normalizedError = \"VideoUrl must use HTTPS.\";\n                return false;\n            }\n\n            var ext = Path.GetExtension(uri.AbsolutePath);\n            if (!ext.Equals(\".mp4\", StringComparison.OrdinalIgnoreCase))\n            {\n                normalizedError = \"VideoUrl must point to an .mp4 file.\";\n                return false;\n            }\n\n            return true;\n        }\n        public async Task<ResponseResult> SendVideoTemplateCampaignAsync(Campaign campaign)\n        {\n            try\n            {\n                if (campaign == null || campaign.IsDeleted)\n                    return ResponseResult.ErrorInfo(\"❌ Invalid campaign.\");\n                if (campaign.Recipients == null || campaign.Recipients.Count == 0)\n                    return ResponseResult.ErrorInfo(\"❌ No recipients to send.\");\n\n                var businessId = campaign.BusinessId;\n\n                static string? PhoneOf(CampaignRecipient r) =>\n                    r?.Contact?.PhoneNumber ?? r?.AudienceMember?.PhoneE164 ?? r?.AudienceMember?.PhoneRaw;\n\n                var recipients = campaign.Recipients.Where(r => !string.IsNullOrWhiteSpace(PhoneOf(r))).ToList();\n                if (recipients.Count == 0)\n                    return ResponseResult.ErrorInfo(\"⚠️ No valid recipients with phone numbers.\");\n\n                // Flow/template selection\n                var (_, entryTemplate) = await ResolveFlowEntryAsync(businessId, campaign.CTAFlowConfigId);\n                var templateKey = !string.IsNullOrWhiteSpace(entryTemplate)\n                    ? entryTemplate!.Trim()\n                    : (campaign.TemplateId ?? campaign.MessageTemplate ?? \"\").Trim();\n                if (string.IsNullOrWhiteSpace(templateKey))\n                    return ResponseResult.ErrorInfo(\"❌ No template selected.\");\n\n                // Validate header media URL (must be https .mp4)\n                var videoUrl = (campaign.VideoUrl ?? campaign.ImageUrl ?? \"\").Trim();\n                if (!IsHttpsMp4Url(videoUrl, out var vErr))\n                    return ResponseResult.ErrorInfo(\"🚫 Invalid VideoUrl\", vErr);\n\n                // 1) WhatsApp settings\n                var wa = await _whatsAppSettingsService.GetSettingsByBusinessIdAsync(businessId);\n                if (wa is null)\n                    return ResponseResult.ErrorInfo(\"❌ WhatsApp settings not found.\");\n\n                // DB stores Provider UPPERCASE\n                var providerUpper = (wa.Provider ?? string.Empty).Trim().ToUpperInvariant();\n\n                // 2) Fetch template from DB (NO network) — try TemplateId first, then Name\n                WhatsAppTemplate? templateRow = await _context.WhatsAppTemplates\n                    .AsNoTracking()\n                    .Where(t => t.BusinessId == businessId &&\n                                t.IsActive &&\n                                t.Provider == providerUpper &&\n                                t.TemplateId == templateKey)\n                    .OrderByDescending(t => t.UpdatedAt)\n                    .ThenByDescending(t => t.LastSyncedAt)\n                    .FirstOrDefaultAsync();\n\n                if (templateRow is null)\n                {\n                    templateRow = await _context.WhatsAppTemplates\n                        .AsNoTracking()\n                        .Where(t => t.BusinessId == businessId &&\n                                    t.IsActive &&\n                                    t.Provider == providerUpper &&\n                                    t.Name == templateKey)\n                        .OrderByDescending(t => t.UpdatedAt)\n                        .ThenByDescending(t => t.LastSyncedAt)\n                        .FirstOrDefaultAsync();\n                }\n\n                if (templateRow == null)\n                    return ResponseResult.ErrorInfo(\"❌ Template metadata not found in DB.\");\n\n                var templateMeta = new TemplateMetadataDto\n                {\n                    Name = templateRow.Name,\n                    Language = templateRow.LanguageCode,\n                    Body = templateRow.Body,\n                    // FINAL MODEL: BODY-only placeholder count\n                    PlaceholderCount = Math.Max(0, templateRow.BodyVarCount),\n                    // If you need URL-button structure, adapt UrlButtons here:\n                    ButtonParams = ParseUrlButtonsToButtonMeta(templateRow.UrlButtons)\n                };\n\n                var languageCode = (templateMeta.Language ?? \"\").Trim();\n                if (string.IsNullOrWhiteSpace(languageCode))\n                    return ResponseResult.ErrorInfo(\"❌ Template language missing in DB.\");\n\n                // 3) Sender id\n                string? phoneNumberIdOverride = !string.IsNullOrWhiteSpace(campaign.PhoneNumberId)\n                    ? campaign.PhoneNumberId\n                    : wa.PhoneNumberId;\n\n                if (providerUpper == \"META_CLOUD\" && string.IsNullOrWhiteSpace(phoneNumberIdOverride))\n                    return ResponseResult.ErrorInfo(\"❌ No PhoneNumberId configured for Meta Cloud sender.\");\n\n                // 4) Optional flow entry step id\n                Guid? entryStepId = null;\n                if (campaign.CTAFlowConfigId.HasValue)\n                {\n                    entryStepId = await _context.CTAFlowSteps\n                        .Where(s => s.CTAFlowConfigId == campaign.CTAFlowConfigId.Value)\n                        .OrderBy(s => s.StepOrder)\n                        .Select(s => (Guid?)s.Id)\n                        .FirstOrDefaultAsync();\n                }\n\n                // 5) Freeze button bundle for UI click tracking\n                string? buttonBundleJson = null;\n                if (templateMeta.ButtonParams is { Count: > 0 })\n                {\n                    var bundle = templateMeta.ButtonParams\n                        .OrderBy(b => b.Index)\n                        .Take(3)\n                        .Select((b, i) => new { i, position = i + 1, text = (b.Text ?? \"\").Trim(), type = b.Type, subType = b.SubType })\n                        .ToList();\n                    buttonBundleJson = JsonConvert.SerializeObject(bundle);\n                }\n\n                // 6) Audience lookup for missing contacts\n                var neededMemberIds = recipients\n                    .Where(x => x.ContactId == null && x.AudienceMemberId != null)\n                    .Select(x => x.AudienceMemberId!.Value)\n                    .Distinct()\n                    .ToList();\n\n                var audienceLookup = neededMemberIds.Count == 0\n                    ? new Dictionary<Guid, (string Phone, string? Name)>()\n                    : await _context.AudienceMembers.AsNoTracking()\n                        .Where(m => m.BusinessId == businessId && neededMemberIds.Contains(m.Id))\n                        .Select(m => new { m.Id, m.PhoneE164, m.PhoneRaw, m.Name })\n                        .ToDictionaryAsync(\n                            x => x.Id,\n                            x => (Phone: string.IsNullOrWhiteSpace(x.PhoneE164) ? (x.PhoneRaw ?? \"\") : x.PhoneE164,\n                                  Name: x.Name)\n                        );\n\n                int successCount = 0, failureCount = 0;\n                var now = DateTime.UtcNow;\n\n                foreach (var r in recipients)\n                {\n                    var phone = PhoneOf(r);\n                    string? name = r.Contact?.Name;\n\n                    if (string.IsNullOrWhiteSpace(phone) && r.AudienceMemberId != null &&\n                        audienceLookup.TryGetValue(r.AudienceMemberId.Value, out var a) &&\n                        !string.IsNullOrWhiteSpace(a.Phone))\n                    {\n                        phone = a.Phone;\n                        name ??= a.Name ?? \"Customer\";\n                    }\n                    if (string.IsNullOrWhiteSpace(phone))\n                    {\n                        failureCount++;\n                        continue;\n                    }\n\n                    var runId = Guid.NewGuid();\n                    var campaignSendLogId = Guid.NewGuid();\n\n                    // ✅ Provider-specific component builder\n                    bool built;\n                    List<object> components;\n                    string? buildErr;\n                    if (providerUpper == \"META_CLOUD\")\n                        built = BuildVideoTemplateComponents_Meta(videoUrl, templateMeta, r, out components, out buildErr);\n                    else\n                        built = BuildVideoTemplateComponents_Pinnacle(videoUrl, templateMeta, r, out components, out buildErr);\n\n                    if (!built)\n                    {\n                        failureCount++;\n                        _logger.LogWarning(\"[VideoTpl] Component build failed campaign={CampaignId} phone={Phone}: {Err}\",\n                            campaign.Id, phone, buildErr);\n\n                        _context.CampaignSendLogs.Add(new CampaignSendLog\n                        {\n                            Id = campaignSendLogId,\n                            CampaignId = campaign.Id,\n                            BusinessId = businessId,\n                            ContactId = r.ContactId,\n                            RecipientId = r.Id,\n                            MessageBody = campaign.MessageBody ?? templateKey,\n                            TemplateId = templateKey,\n                            SendStatus = \"Failed\",\n                            ErrorMessage = $\"component-build: {buildErr}\",\n                            CreatedAt = now,\n                            CreatedBy = campaign.CreatedBy,\n                            CTAFlowConfigId = campaign.CTAFlowConfigId,\n                            CTAFlowStepId = entryStepId,\n                            ButtonBundleJson = buttonBundleJson,\n                            RunId = runId,\n                            SourceChannel = \"video_template\"\n                        });\n                        continue;\n                    }\n\n                    var payload = new\n                    {\n                        messaging_product = \"whatsapp\",\n                        to = phone,\n                        type = \"template\",\n                        template = new\n                        {\n                            name = templateKey,\n                            language = new { code = languageCode },\n                            components\n                        }\n                    };\n\n                    // Attach recipient via stub to avoid accidental inserts of related entities\n                    var recStub = new CampaignRecipient { Id = r.Id };\n                    _context.CampaignRecipients.Attach(recStub);\n                    recStub.MaterializedAt = recStub.MaterializedAt ?? now;\n                    recStub.UpdatedAt = now;\n                    recStub.IdempotencyKey = Idempotency.Sha256(\n                        $\"{campaign.Id}|{phone}|{templateKey}|{videoUrl}|{recStub.ResolvedParametersJson}|{recStub.ResolvedButtonUrlsJson}\");\n\n                    var result = await _messageEngineService.SendPayloadAsync(businessId, providerUpper, payload, phoneNumberIdOverride);\n\n                    var logId = Guid.NewGuid();\n                    _context.MessageLogs.Add(new MessageLog\n                    {\n                        Id = logId,\n                        BusinessId = businessId,\n                        CampaignId = campaign.Id,\n                        ContactId = r.ContactId,\n                        RecipientNumber = phone,\n                        MessageContent = templateKey,\n                        MediaUrl = videoUrl,\n                        Status = result.Success ? \"Sent\" : \"Failed\",\n                        MessageId = result.MessageId,\n                        ErrorMessage = result.ErrorMessage,\n                        RawResponse = result.RawResponse,\n                        CreatedAt = now,\n                        SentAt = result.Success ? now : (DateTime?)null,\n                        Source = \"campaign\",\n                        CTAFlowConfigId = campaign.CTAFlowConfigId,\n                        CTAFlowStepId = entryStepId,\n                        ButtonBundleJson = buttonBundleJson,\n                        RunId = runId,\n                        Provider = providerUpper,\n                        ProviderMessageId = result.MessageId\n                    });\n\n                    await _billingIngest.IngestFromSendResponseAsync(\n                        businessId: businessId,\n                        messageLogId: logId,\n                        provider: providerUpper,\n                        rawResponseJson: result.RawResponse ?? \"{}\"\n                    );\n\n                    await _context.CampaignSendLogs.AddAsync(new CampaignSendLog\n                    {\n                        Id = campaignSendLogId,\n                        CampaignId = campaign.Id,\n                        BusinessId = businessId,\n                        ContactId = r.ContactId,\n                        RecipientId = r.Id,\n                        MessageBody = campaign.MessageBody ?? templateKey,\n                        TemplateId = templateKey,\n                        SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                        MessageLogId = logId,\n                        MessageId = result.MessageId,\n                        ErrorMessage = result.ErrorMessage,\n                        CreatedAt = now,\n                        SentAt = result.Success ? now : (DateTime?)null,\n                        CreatedBy = campaign.CreatedBy,\n                        CTAFlowConfigId = campaign.CTAFlowConfigId,\n                        CTAFlowStepId = entryStepId,\n                        ButtonBundleJson = buttonBundleJson,\n                        RunId = runId,\n                        SourceChannel = \"video_template\"\n                    });\n\n                    if (result.Success) successCount++; else failureCount++;\n                }\n\n                await _context.SaveChangesAsync();\n                return ResponseResult.SuccessInfo($\"🎬 Video template sent to {successCount} recipients. ❌ Failed for {failureCount}.\");\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Error while sending video template campaign\");\n                return ResponseResult.ErrorInfo(\"🚨 Unexpected error while sending video campaign.\", ex.ToString());\n            }\n        }\n\n        \n\n    //    private List<object> BuildVideoTemplateComponents(\n    //        string provider, string headerVideoUrl,\n    //        List<string> templateParams, List<CampaignButton>? buttonList,\n    //        TemplateMetadataDto templateMeta, Guid campaignSendLogId,\n    //        Contact contact, out List<string> resolvedButtonUrls)\n    //    {\n    //        // Reuse your current builders to get BODY + BUTTONS\n    //        List<object> nonHeaderComponents;\n    //        if (string.Equals(provider, \"PINNACLE\", StringComparison.Ordinal))\n    //            nonHeaderComponents = BuildTextTemplateComponents_Pinnacle(\n    //                templateParams, buttonList, templateMeta, campaignSendLogId, contact, out resolvedButtonUrls);\n    //        else // META_CLOUD\n    //            nonHeaderComponents = BuildTextTemplateComponents_Meta(\n    //                templateParams, buttonList, templateMeta, campaignSendLogId, contact, out resolvedButtonUrls);\n\n    //        // Prepend the HEADER/VIDEO piece (WhatsApp shape for both providers)\n    //        var components = new List<object>\n    //{\n    //    new\n    //    {\n    //        type = \"header\",\n    //        parameters = new object[] {\n    //            new { type = \"video\", video = new { link = headerVideoUrl } }\n    //        }\n    //    }\n    //};\n\n    //        components.AddRange(nonHeaderComponents);\n    //        return components;\n    //    }\n        private bool BuildVideoTemplateComponents_Meta(\n            string videoUrl, TemplateMetadataDto templateMeta,\n            CampaignRecipient r, out List<object> components, out string? error)\n        {\n            components = new List<object>();\n            error = null;\n\n            if (string.IsNullOrWhiteSpace(videoUrl))\n            {\n                error = \"required header VIDEO url is missing\";\n                return false;\n            }\n\n            // HEADER (video)\n            components.Add(new Dictionary<string, object>\n            {\n                [\"type\"] = \"header\",\n                [\"parameters\"] = new object[]\n                {\n            new Dictionary<string, object>\n            {\n                [\"type\"] = \"video\",\n                [\"video\"] = new Dictionary<string, object>\n                {\n                    [\"link\"] = videoUrl\n                }\n            }\n                }\n            });\n\n            // BODY {{1..N}}\n            var count = Math.Max(0, templateMeta.PlaceholderCount);\n            var bodyParams = DeserializeBodyParams(r.ResolvedParametersJson, count);\n            if (count > 0)\n            {\n                // If template expects text params, enforce presence\n                var missing = MissingIndices(bodyParams, count);\n                if (missing.Count > 0)\n                {\n                    error = $\"missing body params at {{ {string.Join(\",\", missing)} }}\";\n                    return false;\n                }\n\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = bodyParams.Select(p => new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"text\",\n                        [\"text\"] = p ?? string.Empty\n                    }).ToList()\n                });\n            }\n\n            // URL BUTTON parameters (only when template declares dynamic pieces)\n            if (templateMeta.ButtonParams != null && templateMeta.ButtonParams.Count > 0)\n            {\n                var urlDict = DeserializeButtonDict(r.ResolvedButtonUrlsJson);\n                var total = Math.Min(3, templateMeta.ButtonParams.Count);\n\n                for (int i = 0; i < total; i++)\n                {\n                    var bp = templateMeta.ButtonParams[i];\n                    var subType = (bp.SubType ?? \"url\").ToLowerInvariant();\n                    var paramMask = bp.ParameterValue?.Trim();\n\n                    // Only dynamic URL buttons need a \"text\" parameter\n                    if (!string.Equals(subType, \"url\", StringComparison.OrdinalIgnoreCase))\n                        continue;\n\n                    var isDynamic = !string.IsNullOrWhiteSpace(paramMask) && paramMask.Contains(\"{{\");\n                    if (!isDynamic) continue;\n\n                    // materializer persisted: button{1..3}.url_param\n                    var key = $\"button{i + 1}.url_param\";\n                    if (!urlDict.TryGetValue(key, out var dyn) || string.IsNullOrWhiteSpace(dyn))\n                    {\n                        error = $\"missing dynamic URL param for {key}\";\n                        return false;\n                    }\n\n                    components.Add(new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"button\",\n                        [\"sub_type\"] = \"url\",\n                        [\"index\"] = i.ToString(), // \"0\",\"1\",\"2\"\n                        [\"parameters\"] = new object[]\n                        {\n                    new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = dyn }\n                        }\n                    });\n                }\n            }\n\n            return true;\n        }\n\n        private bool BuildVideoTemplateComponents_Pinnacle(\n                string videoUrl,\n                TemplateMetadataDto templateMeta,\n                CampaignRecipient r,\n        out List<object> components,\n        out string? error)\n        {\n            // If Pinnacle uses same structure as Meta for templates, we can reuse Meta logic.\n            // If they require a different header/media envelope, adapt here.\n            return BuildVideoTemplateComponents_Meta(videoUrl, templateMeta, r, out components, out error);\n        }\n        private static Dictionary<string, string> DeserializeButtonDict(string? json)\n        {\n            try\n            {\n                return string.IsNullOrWhiteSpace(json)\n                    ? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)\n                    : JsonConvert.DeserializeObject<Dictionary<string, string>>(json!)\n                      ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            }\n            catch\n            {\n                return new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            }\n        }\n        private static List<int> MissingIndices(List<string> bodyParams, int count)\n        {\n            var miss = new List<int>();\n            for (int i = 0; i < count; i++)\n            {\n                if (string.IsNullOrWhiteSpace(i < bodyParams.Count ? bodyParams[i] : null))\n                    miss.Add(i + 1); // 1-based for readability\n            }\n            return miss;\n        }\n        // ---------- helpers ----------\n        private static List<string> DeserializeBodyParams(string? json, int expectedCount)\n        {\n            try\n            {\n                var arr = string.IsNullOrWhiteSpace(json)\n                    ? Array.Empty<string>()\n                    : JsonConvert.DeserializeObject<string[]>(json!) ?? Array.Empty<string>();\n\n                // pad/trim to template placeholder count\n                var list = new List<string>(Enumerable.Repeat(string.Empty, Math.Max(expectedCount, 0)));\n                for (int i = 0; i < Math.Min(expectedCount, arr.Length); i++)\n                    list[i] = arr[i] ?? string.Empty;\n                return list;\n            }\n            catch\n            {\n                return new List<string>(Enumerable.Repeat(string.Empty, Math.Max(expectedCount, 0)));\n            }\n        }\n        private static readonly Regex PlaceholderRe = new(@\"\\{\\{\\s*(\\d+)\\s*\\}\\}\", RegexOptions.Compiled);\n\n        private string BuildTokenParam(Guid campaignSendLogId, int buttonIndex, string? buttonTitle, string destinationUrlAbsolute)\n        {\n            var full = _urlBuilderService.BuildTrackedButtonUrl(campaignSendLogId, buttonIndex, buttonTitle, destinationUrlAbsolute);\n            var pos = full.LastIndexOf(\"/r/\", StringComparison.OrdinalIgnoreCase);\n            return (pos >= 0) ? full[(pos + 3)..] : full; // fallback: if not found, return full (rare)\n        }\n\n        private static string NormalizeAbsoluteUrlOrThrowForButton(string input, string buttonTitle, int buttonIndex)\n        {\n            if (string.IsNullOrWhiteSpace(input))\n                throw new ArgumentException($\"Destination is required for button '{buttonTitle}' (index {buttonIndex}).\");\n\n            // Trim + strip control chars\n            var cleaned = new string(input.Trim().Where(c => !char.IsControl(c)).ToArray());\n            if (cleaned.Length == 0)\n                throw new ArgumentException($\"Destination is required for button '{buttonTitle}' (index {buttonIndex}).\");\n\n            // Allow tel: and WhatsApp deep links\n            if (cleaned.StartsWith(\"tel:\", StringComparison.OrdinalIgnoreCase) ||\n                cleaned.StartsWith(\"wa:\", StringComparison.OrdinalIgnoreCase) ||\n                cleaned.StartsWith(\"https://wa.me/\", StringComparison.OrdinalIgnoreCase))\n            {\n                return cleaned; // Accept as-is\n            }\n\n            // Normal web links\n            if (Uri.TryCreate(cleaned, UriKind.Absolute, out var uri) &&\n                (uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                 uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase)))\n            {\n                return uri.ToString();\n            }\n\n            // Reject everything else\n            throw new ArgumentException(\n                $\"Destination must be an absolute http/https/tel/wa URL for button '{buttonTitle}' (index {buttonIndex}). Got: '{input}'\");\n        }\n\n        private static bool LooksLikeAbsoluteBaseUrlWithPlaceholder(string? templateUrl)\n        {\n            if (string.IsNullOrWhiteSpace(templateUrl)) return false;\n            var s = templateUrl.Trim();\n            if (!s.Contains(\"{{\")) return false;\n\n            // Probe by replacing common placeholders with a char\n            var probe = PlaceholderRe.Replace(s, \"x\");\n            return Uri.TryCreate(probe, UriKind.Absolute, out var abs) &&\n                   (abs.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                    abs.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase));\n        }\n\n        private static object[] BuildBodyParameters(List<string>? templateParams, int requiredCount)\n        {\n            if (requiredCount <= 0) return Array.Empty<object>();\n\n            var src = templateParams ?? new List<string>();\n            if (src.Count > requiredCount) src = src.Take(requiredCount).ToList();\n            while (src.Count < requiredCount) src.Add(string.Empty);\n\n            return src.Select(p => (object)new { type = \"text\", text = p ?? string.Empty }).ToArray();\n        }\n\n        private static string NormalizePhoneForTel(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return \"\";\n            var p = raw.Trim();\n            var digits = new string(p.Where(char.IsDigit).ToArray());\n            // keep leading + if present initially; always output +<digits>\n            return \"+\" + digits;\n        }\n\n        private static string ReplaceAllPlaceholdersWith(string template, string replacement)\n        {\n            if (string.IsNullOrWhiteSpace(template)) return string.Empty;\n            return PlaceholderRe.Replace(template, _ => replacement ?? string.Empty);\n        }\n\n        // ======================================================\n        // META — TEXT TEMPLATE COMPONENTS\n        // ======================================================\n\n        // Back-compat wrapper (old signature)\n        //private List<object> BuildTextTemplateComponents_Meta(\n        //    List<string> templateParams,\n        //    List<CampaignButton>? buttonList,\n        //    TemplateMetadataDto templateMeta,\n        //    Guid campaignSendLogId,\n        //    Contact contact)\n        //{\n        //    return BuildTextTemplateComponents_Meta(\n        //        templateParams, buttonList, templateMeta, campaignSendLogId, contact, out _);\n        //}\n\n        // New overload with resolvedButtonUrls\n        private List<object> BuildTextTemplateComponents_Meta(\n            List<string> templateParams,\n            List<CampaignButton>? buttonList,\n            TemplateMetadataDto templateMeta,\n            Guid campaignSendLogId,\n            Contact contact,\n            out List<string> resolvedButtonUrls)\n        {\n            var components = new List<object>();\n            resolvedButtonUrls = new List<string>();\n\n            // BODY: send exactly PlaceholderCount\n            if (templateMeta.PlaceholderCount > 0)\n            {\n                var bodyParams = BuildBodyParameters(templateParams, templateMeta.PlaceholderCount);\n                components.Add(new { type = \"body\", parameters = bodyParams });\n            }\n\n            // No buttons or template has no button params\n            if (buttonList == null || buttonList.Count == 0 ||\n                templateMeta.ButtonParams == null || templateMeta.ButtonParams.Count == 0)\n                return components;\n\n            // Ensure index alignment with the template by ordering by Position (then original index)\n            var orderedButtons = buttonList\n                .Select((b, idx) => new { Btn = b, idx })\n                .OrderBy(x => (int?)x.Btn.Position ?? int.MaxValue)\n                .ThenBy(x => x.idx)\n                .Select(x => x.Btn)\n                .ToList();\n\n            var total = Math.Min(3, Math.Min(orderedButtons.Count, templateMeta.ButtonParams.Count));\n\n            // Phone normalization (for optional {{1}} substitution on campaign button value)\n            var phone = NormalizePhoneForTel(contact?.PhoneNumber);\n            var encodedPhone = Uri.EscapeDataString(phone);\n\n            for (int i = 0; i < total; i++)\n            {\n                var meta = templateMeta.ButtonParams[i];\n                var subType = (meta.SubType ?? \"url\").ToLowerInvariant();\n                var metaParam = meta.ParameterValue?.Trim();\n\n                // Meta needs parameters ONLY for dynamic URL buttons\n                if (!string.Equals(subType, \"url\", StringComparison.OrdinalIgnoreCase))\n                    continue;\n\n                var isDynamic = !string.IsNullOrWhiteSpace(metaParam) && metaParam.Contains(\"{{\");\n                if (!isDynamic)\n                    continue;\n\n                var btn = orderedButtons[i];\n                var btnType = (btn?.Type ?? \"URL\").ToUpperInvariant();\n                if (!string.Equals(btnType, \"URL\", StringComparison.OrdinalIgnoreCase))\n                {\n                    // If template expects dynamic URL at this index and your campaign button isn't URL, skip to avoid provider error\n                    continue;\n                }\n\n                var valueRaw = btn.Value?.Trim();\n                if (string.IsNullOrWhiteSpace(valueRaw))\n                {\n                    throw new InvalidOperationException(\n                        $\"Template requires a dynamic URL at button index {i}, but campaign button value is empty.\");\n                }\n\n                // Optional phone substitution in destination (support any {{n}})\n                var resolvedDestination = PlaceholderRe.Replace(valueRaw, m =>\n                {\n                    if (!int.TryParse(m.Groups[1].Value, out var n)) return \"\";\n                    if (n == 1) return encodedPhone; // convention: {{1}} can be phone\n                    var idx = n - 1;\n                    return (idx >= 0 && idx < templateParams.Count) ? (templateParams[idx] ?? \"\") : \"\";\n                });\n\n                resolvedDestination = NormalizeAbsoluteUrlOrThrowForButton(resolvedDestination, btn.Title ?? \"\", i);\n\n                // Build both; choose which to send based on template base style\n                var fullTrackedUrl = _urlBuilderService.BuildTrackedButtonUrl(campaignSendLogId, i, btn.Title, resolvedDestination);\n                var tokenParam = BuildTokenParam(campaignSendLogId, i, btn.Title, resolvedDestination);\n\n                var templateHasAbsoluteBase = LooksLikeAbsoluteBaseUrlWithPlaceholder(metaParam);\n                var valueToSend = templateHasAbsoluteBase ? tokenParam : fullTrackedUrl;\n\n                components.Add(new Dictionary<string, object>\n                {\n                    [\"type\"] = \"button\",\n                    [\"sub_type\"] = \"url\",\n                    [\"index\"] = i.ToString(), // \"0\"/\"1\"/\"2\"\n                    [\"parameters\"] = new[] {\n                new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = valueToSend }\n            }\n                });\n\n                // Provider-resolved URL (what the client actually clicks):\n                // replace all placeholders in provider template with the parameter we sent.\n                var providerResolved = ReplaceAllPlaceholdersWith(metaParam ?? \"\", valueToSend);\n                resolvedButtonUrls.Add(providerResolved);\n            }\n\n            return components;\n        }\n\n        // ======================================================\n        // PINNACLE — TEXT TEMPLATE COMPONENTS\n        // ======================================================\n\n        // Back-compat wrapper (old signature)\n        private List<object> BuildTextTemplateComponents_Pinnacle(\n            List<string> templateParams,\n            List<CampaignButton>? buttonList,\n            TemplateMetadataDto templateMeta,\n            Guid campaignSendLogId,\n            Contact contact)\n        {\n            return BuildTextTemplateComponents_Pinnacle(\n                templateParams, buttonList, templateMeta, campaignSendLogId, contact, out _);\n        }\n\n        // New overload with resolvedButtonUrls\n        private List<object> BuildTextTemplateComponents_Pinnacle(\n            List<string> templateParams,\n            List<CampaignButton>? buttonList,\n            TemplateMetadataDto templateMeta,\n            Guid campaignSendLogId,\n            Contact contact,\n            out List<string> resolvedButtonUrls)\n        {\n            var components = new List<object>();\n            resolvedButtonUrls = new List<string>();\n\n            // BODY: Pinnacle is strict → always send exactly PlaceholderCount\n            if (templateMeta.PlaceholderCount > 0)\n            {\n                var bodyParams = BuildBodyParameters(templateParams, templateMeta.PlaceholderCount);\n                components.Add(new { type = \"body\", parameters = bodyParams });\n            }\n\n            // No buttons to map → return body-only\n            if (buttonList == null || buttonList.Count == 0 ||\n                templateMeta.ButtonParams == null || templateMeta.ButtonParams.Count == 0)\n                return components;\n\n            // Ensure index alignment with the template by ordering by Position (then original index)\n            var orderedButtons = buttonList\n                .Select((b, idx) => new { Btn = b, idx })\n                .OrderBy(x => (int?)x.Btn.Position ?? int.MaxValue)\n                .ThenBy(x => x.idx)\n                .Select(x => x.Btn)\n                .ToList();\n\n            var total = Math.Min(3, Math.Min(orderedButtons.Count, templateMeta.ButtonParams.Count));\n\n            // Phone normalization (for optional {{1}} substitution on campaign button value)\n            var phone = NormalizePhoneForTel(contact?.PhoneNumber);\n            var encodedPhone = Uri.EscapeDataString(phone);\n\n            for (int i = 0; i < total; i++)\n            {\n                var meta = templateMeta.ButtonParams[i];\n                var subType = (meta.SubType ?? \"url\").ToLowerInvariant();\n                var metaParam = meta.ParameterValue?.Trim();\n\n                // This path supports dynamic URL params only\n                if (!string.Equals(subType, \"url\", StringComparison.OrdinalIgnoreCase))\n                    continue;\n\n                var isDynamic = !string.IsNullOrWhiteSpace(metaParam) && metaParam.Contains(\"{{\");\n                if (!isDynamic)\n                    continue;\n\n                var btn = orderedButtons[i];\n                var btnType = (btn?.Type ?? \"URL\").ToUpperInvariant();\n                if (!string.Equals(btnType, \"URL\", StringComparison.OrdinalIgnoreCase))\n                {\n                    throw new InvalidOperationException(\n                        $\"Template expects a dynamic URL at button index {i}, but campaign button type is '{btn?.Type}'.\");\n                }\n\n                var valueRaw = btn?.Value?.Trim();\n                if (string.IsNullOrWhiteSpace(valueRaw))\n                {\n                    throw new InvalidOperationException(\n                        $\"Template requires a dynamic URL at button index {i}, but campaign button value is empty.\");\n                }\n\n                // Optional phone + param substitution (support any {{n}})\n                var resolvedDestination = PlaceholderRe.Replace(valueRaw, m =>\n                {\n                    if (!int.TryParse(m.Groups[1].Value, out var n)) return \"\";\n                    if (n == 1) return encodedPhone;\n                    var idx = n - 1;\n                    return (idx >= 0 && idx < templateParams.Count) ? (templateParams[idx] ?? \"\") : \"\";\n                });\n\n                // Validate + normalize absolute URL\n                resolvedDestination = NormalizeAbsoluteUrlOrThrowForButton(resolvedDestination, btn!.Title ?? \"\", i);\n\n                // Build both options: full tracked URL vs token param (for absolute-base placeholders)\n                var fullTrackedUrl = _urlBuilderService.BuildTrackedButtonUrl(campaignSendLogId, i, btn.Title, resolvedDestination);\n                var tokenParam = BuildTokenParam(campaignSendLogId, i, btn.Title, resolvedDestination);\n\n                var templateHasAbsoluteBase = LooksLikeAbsoluteBaseUrlWithPlaceholder(metaParam);\n                var valueToSend = templateHasAbsoluteBase ? tokenParam : fullTrackedUrl;\n\n                // Pinnacle payload shape (kept aligned with Meta)\n                components.Add(new Dictionary<string, object>\n                {\n                    [\"type\"] = \"button\",\n                    [\"sub_type\"] = \"url\",\n                    [\"index\"] = i.ToString(),\n                    [\"parameters\"] = new[] {\n                new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = valueToSend }\n            }\n                });\n\n                // Provider-resolved URL (what the user will open)\n                var providerResolved = ReplaceAllPlaceholdersWith(metaParam ?? \"\", valueToSend);\n                resolvedButtonUrls.Add(providerResolved);\n            }\n\n            return components;\n        }\n\n        #region SendImagetemplate\n        public async Task<ResponseResult> SendImageTemplateCampaignAsync(Campaign campaign)\n        {\n            try\n            {\n                if (campaign == null || campaign.IsDeleted)\n                    return ResponseResult.ErrorInfo(\"❌ Invalid campaign.\");\n                if (campaign.Recipients == null || campaign.Recipients.Count == 0)\n                    return ResponseResult.ErrorInfo(\"❌ No recipients to send.\");\n\n                var businessId = campaign.BusinessId;\n\n                static string? ResolveRecipientPhone(CampaignRecipient r) =>\n                    r?.Contact?.PhoneNumber ?? r?.AudienceMember?.PhoneE164 ?? r?.AudienceMember?.PhoneRaw;\n\n                var recipients = campaign.Recipients\n                    .Where(r => !string.IsNullOrWhiteSpace(ResolveRecipientPhone(r)))\n                    .ToList();\n\n                if (recipients.Count == 0)\n                    return ResponseResult.ErrorInfo(\"⚠️ No valid recipients with phone numbers (Contact/AudienceMember).\");\n\n                // Flow/template selection\n                var (_, entryTemplate) = await ResolveFlowEntryAsync(businessId, campaign.CTAFlowConfigId);\n                var templateKey = !string.IsNullOrWhiteSpace(entryTemplate)\n                    ? entryTemplate!.Trim()\n                    : (campaign.TemplateId ?? campaign.MessageTemplate ?? \"\").Trim();\n\n                if (string.IsNullOrWhiteSpace(templateKey))\n                    return ResponseResult.ErrorInfo(\"❌ No template selected.\");\n\n                // WhatsApp settings\n                var wa = await _whatsAppSettingsService.GetSettingsByBusinessIdAsync(businessId);\n                if (wa is null)\n                    return ResponseResult.ErrorInfo(\"❌ WhatsApp settings not found.\");\n\n                // DB stores Provider in UPPERCASE\n                var providerUpper = (wa.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                if (providerUpper != \"META_CLOUD\" && providerUpper != \"PINNACLE\")\n                    return ResponseResult.ErrorInfo($\"❌ Unsupported provider configured: {providerUpper}\");\n\n                // Template from DB (try TemplateId first, then Name)\n                WhatsAppTemplate? templateRow = await _context.WhatsAppTemplates\n                    .AsNoTracking()\n                    .Where(t => t.BusinessId == businessId &&\n                                t.IsActive &&\n                                t.Provider == providerUpper &&\n                                t.TemplateId == templateKey)\n                    .OrderByDescending(t => t.UpdatedAt)\n                    .ThenByDescending(t => t.LastSyncedAt)\n                    .FirstOrDefaultAsync();\n\n                if (templateRow is null)\n                {\n                    templateRow = await _context.WhatsAppTemplates\n                        .AsNoTracking()\n                        .Where(t => t.BusinessId == businessId &&\n                                    t.IsActive &&\n                                    t.Provider == providerUpper &&\n                                    t.Name == templateKey)\n                        .OrderByDescending(t => t.UpdatedAt)\n                        .ThenByDescending(t => t.LastSyncedAt)\n                        .FirstOrDefaultAsync();\n                }\n\n                if (templateRow == null)\n                    return ResponseResult.ErrorInfo(\"❌ Template metadata not found in DB.\");\n\n                // Map DB row -> DTO your builders need\n                var tmplMeta = new TemplateMetadataDto\n                {\n                    Name = templateRow.Name,\n                    Language = templateRow.LanguageCode,\n                    Body = templateRow.Body,\n                    // FINAL MODEL: body-only placeholder count:\n                    PlaceholderCount = Math.Max(0, templateRow.BodyVarCount),\n                    ButtonParams = ParseUrlButtonsToButtonMeta(templateRow.UrlButtons)\n\n                };\n                var parameterFormat = (templateRow.ParameterFormat ?? \"POSITIONAL\").Trim().ToUpperInvariant();\n                var bodyParamNames = ExtractBodyParamNamesFromTemplate(templateRow.RawJson, templateRow.Body, parameterFormat);\n                var languageCode = (tmplMeta.Language ?? \"\").Trim();\n                if (string.IsNullOrWhiteSpace(languageCode))\n                    return ResponseResult.ErrorInfo(\"❌ Template language missing in DB.\");\n\n                // Sender (campaign override → DTO)\n                string? phoneNumberIdOverride = !string.IsNullOrWhiteSpace(campaign.PhoneNumberId)\n                    ? campaign.PhoneNumberId\n                    : wa.PhoneNumberId;\n\n                if (providerUpper == \"META_CLOUD\" && string.IsNullOrWhiteSpace(phoneNumberIdOverride))\n                    return ResponseResult.ErrorInfo(\"❌ No PhoneNumberId configured for Meta Cloud sender.\");\n\n                // Flow entry step id\n                Guid? entryStepId = null;\n                if (campaign.CTAFlowConfigId.HasValue)\n                {\n                    entryStepId = await _context.CTAFlowSteps\n                        .Where(s => s.CTAFlowConfigId == campaign.CTAFlowConfigId.Value)\n                        .OrderBy(s => s.StepOrder)\n                        .Select(s => (Guid?)s.Id)\n                        .FirstOrDefaultAsync();\n                }\n\n                // Freeze button bundle (for analytics)\n                string? buttonBundleJson = null;\n                if (tmplMeta.ButtonParams is { Count: > 0 })\n                {\n                    var bundle = tmplMeta.ButtonParams\n                        .OrderBy(b => b.Index)\n                        .Take(3)\n                        .Select((b, i) => new { i, position = i + 1, text = (b.Text ?? \"\").Trim(), type = b.Type, subType = b.SubType })\n                        .ToList();\n                    buttonBundleJson = JsonConvert.SerializeObject(bundle);\n                }\n\n                // Prefetch AudienceMembers for recipients without Contact\n                var neededMemberIds = recipients\n                    .Where(x => x.ContactId == null && x.AudienceMemberId != null)\n                    .Select(x => x.AudienceMemberId!.Value)\n                    .Distinct()\n                    .ToList();\n\n                var audienceLookup = neededMemberIds.Count == 0\n                    ? new Dictionary<Guid, (string Phone, string? Name)>()\n                    : await _context.AudienceMembers.AsNoTracking()\n                        .Where(m => m.BusinessId == businessId && neededMemberIds.Contains(m.Id))\n                        .Select(m => new { m.Id, m.PhoneE164, m.PhoneRaw, m.Name })\n                        .ToDictionaryAsync(\n                            x => x.Id,\n                            x => (Phone: string.IsNullOrWhiteSpace(x.PhoneE164) ? (x.PhoneRaw ?? \"\") : x.PhoneE164,\n                                  Name: x.Name)\n                        );\n\n                // Campaign buttons (stable order)\n                var buttons = campaign.MultiButtons?\n                    .Select((b, idx) => new { Btn = b, idx })\n                    .OrderBy(x => (int?)x.Btn.Position ?? int.MaxValue)\n                    .ThenBy(x => x.idx)\n                    .Select(x => x.Btn)\n                    .ToList() ?? new List<CampaignButton>();\n\n                int successCount = 0, failureCount = 0;\n                var now = DateTime.UtcNow;\n\n                foreach (var r in recipients)\n                {\n                    var phone = ResolveRecipientPhone(r);\n                    string? name = r.Contact?.Name;\n\n                    if (string.IsNullOrWhiteSpace(phone) && r.AudienceMemberId != null &&\n                        audienceLookup.TryGetValue(r.AudienceMemberId.Value, out var a) &&\n                        !string.IsNullOrWhiteSpace(a.Phone))\n                    {\n                        phone = a.Phone;\n                        name ??= a.Name ?? \"Customer\";\n                    }\n\n                    if (string.IsNullOrWhiteSpace(phone))\n                    {\n                        failureCount++;\n                        continue;\n                    }\n\n                    // Synthetic contact for templating only\n                    var contactForTemplating = r.Contact ?? new Contact\n                    {\n                        Id = Guid.Empty,\n                        BusinessId = businessId,\n                        PhoneNumber = phone,\n                        Name = name ?? \"Customer\"\n                    };\n\n                    // BODY params per recipient (positional only; your final model’s hot path)\n                    //var resolvedParams = GetRecipientBodyParams(r, tmplMeta.PlaceholderCount, campaign.TemplateParameters);\n                    var resolvedParams = GetRecipientBodyParams(\n                           r,\n                           tmplMeta.PlaceholderCount, campaign.TemplateParameters, bodyParamNames, parameterFormat\n                        );\n                    if (tmplMeta.PlaceholderCount > 0 && resolvedParams.Any(string.IsNullOrWhiteSpace))\n                    {\n                        failureCount++;\n                        var why = $\"Missing body parameter(s): expected {tmplMeta.PlaceholderCount}, got {resolvedParams.Count(x => !string.IsNullOrWhiteSpace(x))} filled.\";\n\n                        var recStubMiss = new CampaignRecipient { Id = r.Id };\n                        _context.CampaignRecipients.Attach(recStubMiss);\n                        recStubMiss.MaterializedAt = now;\n                        recStubMiss.UpdatedAt = now;\n                        recStubMiss.ResolvedParametersJson = JsonConvert.SerializeObject(resolvedParams);\n\n                        var logIdLocal = Guid.NewGuid();\n                        _context.MessageLogs.Add(new MessageLog\n                        {\n                            Id = logIdLocal,\n                            BusinessId = businessId,\n                            CampaignId = campaign.Id,\n                            ContactId = r.ContactId,\n                            RecipientNumber = phone,\n                            MessageContent = templateKey,\n                            MediaUrl = campaign.ImageUrl,\n                            Status = \"Failed\",\n                            ErrorMessage = why,\n                            RawResponse = \"{\\\"local_error\\\":\\\"missing_template_body_params\\\"}\",\n                            CreatedAt = now,\n                            Source = \"campaign\",\n                            CTAFlowConfigId = campaign.CTAFlowConfigId,\n                            CTAFlowStepId = entryStepId,\n                            ButtonBundleJson = buttonBundleJson\n                        });\n\n                        await _context.CampaignSendLogs.AddAsync(new CampaignSendLog\n                        {\n                            Id = Guid.NewGuid(),\n                            CampaignId = campaign.Id,\n                            BusinessId = businessId,\n                            ContactId = r.ContactId,\n                            RecipientId = r.Id,\n                            MessageBody = campaign.MessageBody ?? templateKey,\n                            TemplateId = templateKey,\n                            SendStatus = \"Failed\",\n                            MessageLogId = logIdLocal,\n                            ErrorMessage = why,\n                            CreatedAt = now,\n                            CTAFlowConfigId = campaign.CTAFlowConfigId,\n                            CTAFlowStepId = entryStepId,\n                            ButtonBundleJson = buttonBundleJson\n                        });\n\n                        continue;\n                    }\n\n                    // Build components and resolve dynamic URL buttons\n                    var runId = Guid.NewGuid();\n                    var campaignSendLogId = Guid.NewGuid();\n                    List<string> resolvedButtonUrls;\n\n                    _ = (providerUpper == \"PINNACLE\")\n                        ? BuildImageTemplateComponents_Pinnacle(\n                            campaign.ImageUrl, resolvedParams, buttons, tmplMeta, campaignSendLogId, contactForTemplating, out resolvedButtonUrls)\n                        : BuildImageTemplateComponents_Meta(\n                            campaign.ImageUrl, resolvedParams, buttons, tmplMeta, campaignSendLogId, contactForTemplating, out resolvedButtonUrls);\n\n                    // Attach recipient via stub before send\n                    var recStub = new CampaignRecipient { Id = r.Id };\n                    _context.CampaignRecipients.Attach(recStub);\n                    recStub.ResolvedParametersJson = JsonConvert.SerializeObject(resolvedParams);\n                    recStub.ResolvedButtonUrlsJson = JsonConvert.SerializeObject(resolvedButtonUrls);\n                    recStub.MaterializedAt = now;\n                    recStub.UpdatedAt = now;\n                    recStub.IdempotencyKey = Idempotency.Sha256(\n                        $\"{campaign.Id}|{phone}|{templateKey}|{recStub.ResolvedParametersJson}|{recStub.ResolvedButtonUrlsJson}|{campaign.ImageUrl}|{campaign.ImageCaption}\");\n\n                    // Send via engine\n                    var dto = new ImageTemplateMessageDto\n                    {\n                        BusinessId = businessId,\n                        Provider = providerUpper,\n                        PhoneNumberId = phoneNumberIdOverride,\n                        RecipientNumber = phone,\n                        TemplateName = templateKey,\n                        LanguageCode = languageCode,\n                        HeaderImageUrl = campaign.ImageUrl,\n                        TemplateBody = campaign.MessageBody,\n                        TemplateParameters = resolvedParams,\n                        ButtonParameters = buttons.Take(3).Select(b => new CampaignButtonDto\n                        {\n                            ButtonText = b.Title,\n                            ButtonType = b.Type,\n                            TargetUrl = b.Value\n                        }).ToList(),\n                        CTAFlowConfigId = campaign.CTAFlowConfigId,\n                        CTAFlowStepId = entryStepId\n                    };\n\n                    var result = await _messageEngineService.SendImageTemplateMessageAsync(dto, businessId);\n\n                    var logId = Guid.NewGuid();\n                    _context.MessageLogs.Add(new MessageLog\n                    {\n                        Id = logId,\n                        BusinessId = businessId,\n                        CampaignId = campaign.Id,\n                        ContactId = r.ContactId,\n                        RecipientNumber = phone,\n                        MessageContent = templateKey,\n                        MediaUrl = campaign.ImageUrl,\n                        Status = result.Success ? \"Sent\" : \"Failed\",\n                        MessageId = result.MessageId,\n                        ErrorMessage = result.ErrorMessage,\n                        RawResponse = result.RawResponse,\n                        CreatedAt = now,\n                        SentAt = result.Success ? now : (DateTime?)null,\n                        Source = \"campaign\",\n                        CTAFlowConfigId = campaign.CTAFlowConfigId,\n                        CTAFlowStepId = entryStepId,\n                        ButtonBundleJson = buttonBundleJson,\n                        RunId = runId\n                    });\n\n                    await _billingIngest.IngestFromSendResponseAsync(\n                        businessId: businessId,\n                        messageLogId: logId,\n                        provider: providerUpper,\n                        rawResponseJson: result.RawResponse ?? \"{}\"\n                    );\n\n                    await _context.CampaignSendLogs.AddAsync(new CampaignSendLog\n                    {\n                        Id = campaignSendLogId,\n                        CampaignId = campaign.Id,\n                        BusinessId = businessId,\n                        ContactId = r.ContactId,\n                        RecipientId = r.Id,\n                        MessageBody = campaign.MessageBody ?? templateKey,\n                        TemplateId = templateKey,\n                        SendStatus = result.Success ? \"Sent\" : \"Failed\",\n                        MessageLogId = logId,\n                        MessageId = result.MessageId,\n                        ErrorMessage = result.ErrorMessage,\n                        CreatedAt = now,\n                        SentAt = result.Success ? now : (DateTime?)null,\n                        CTAFlowConfigId = campaign.CTAFlowConfigId,\n                        CTAFlowStepId = entryStepId,\n                        ButtonBundleJson = buttonBundleJson,\n                        RunId = runId\n                    });\n\n                    if (result.Success) successCount++; else failureCount++;\n                }\n\n                await _context.SaveChangesAsync();\n                return ResponseResult.SuccessInfo($\"📤 Sent to {successCount} recipients. ❌ Failed for {failureCount}.\");\n            }\n            catch (Exception ex)\n            {\n                Log.Error(ex, \"Error while sending image template campaign\");\n                return ResponseResult.ErrorInfo(\"🚨 Unexpected error while sending campaign.\", ex.ToString());\n            }\n        }\n\n        // Storage shape [{ index, parameters: [...] }] → your ButtonMetadataDto\n\n        private List<object> BuildImageTemplateComponents_Pinnacle(\n       string? imageUrl,\n       List<string> templateParams,\n       List<CampaignButton>? buttonList,\n       TemplateMetadataDto templateMeta,\n       Guid campaignSendLogId,\n       Contact contact,\n       out List<string> resolvedButtonUrls)\n        {\n            var components = new List<object>();\n            resolvedButtonUrls = new List<string>();\n\n            // Header\n            if (!string.IsNullOrWhiteSpace(imageUrl) && templateMeta.HasImageHeader)\n            {\n                components.Add(new\n                {\n                    type = \"header\",\n                    parameters = new object[]\n                    {\n                new { type = \"image\", image = new { link = imageUrl } }\n                    }\n                });\n            }\n\n            // Body\n            if (templateMeta.PlaceholderCount > 0 && templateParams?.Count > 0)\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = templateParams.Select(p => new { type = \"text\", text = p }).ToArray()\n                });\n            }\n\n            // Buttons\n            if (buttonList == null || buttonList.Count == 0 ||\n                templateMeta.ButtonParams == null || templateMeta.ButtonParams.Count == 0)\n                return components;\n\n            var total = Math.Min(3, Math.Min(buttonList.Count, templateMeta.ButtonParams.Count));\n\n            // phone for optional {{1}}\n            var phone = string.IsNullOrWhiteSpace(contact?.PhoneNumber) ? \"\" :\n                        (contact.PhoneNumber.StartsWith(\"+\") ? contact.PhoneNumber : \"+\" + contact.PhoneNumber);\n            var encodedPhone = Uri.EscapeDataString(phone);\n\n            for (int i = 0; i < total; i++)\n            {\n                var btn = buttonList[i];\n                var meta = templateMeta.ButtonParams[i];\n                var subtype = (meta.SubType ?? \"url\").ToLowerInvariant();\n                var metaParam = meta.ParameterValue?.Trim() ?? string.Empty; // e.g. \"/r/{{1}}\"\n                var isDynamic = metaParam.Contains(\"{{\");\n\n                if (!isDynamic)\n                {\n                    // static provider button at this index — no parameters to send\n                    components.Add(new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"button\",\n                        [\"sub_type\"] = subtype,\n                        [\"index\"] = i\n                    });\n                    continue;\n                }\n\n                var valueRaw = btn?.Value?.Trim();\n                if (string.IsNullOrWhiteSpace(valueRaw)) continue;\n\n                // Optional phone substitution + body params {{n}}\n                var resolvedDestination = PlaceholderRe.Replace(valueRaw, m =>\n                {\n                    if (!int.TryParse(m.Groups[1].Value, out var n)) return \"\";\n                    if (n == 1) return encodedPhone;\n                    var idx = n - 1;\n                    return (idx >= 0 && idx < templateParams.Count) ? (templateParams[idx] ?? \"\") : \"\";\n                });\n\n                // Track + token (same pattern as text path)\n                var fullTrackedUrl = _urlBuilderService.BuildTrackedButtonUrl(campaignSendLogId, i, btn.Title, resolvedDestination);\n                var tokenParam = BuildTokenParam(campaignSendLogId, i, btn.Title, resolvedDestination);\n\n                var templateHasAbsoluteBase = LooksLikeAbsoluteBaseUrlWithPlaceholder(metaParam);\n                var valueToSend = templateHasAbsoluteBase ? tokenParam : fullTrackedUrl;\n\n                components.Add(new Dictionary<string, object>\n                {\n                    [\"type\"] = \"button\",\n                    [\"sub_type\"] = subtype,\n                    [\"index\"] = i,\n                    [\"parameters\"] = new[] { new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = valueToSend } }\n                });\n\n                // what the client will actually open once provider composes the URL\n                var providerResolved = ReplaceAllPlaceholdersWith(metaParam, valueToSend);\n                resolvedButtonUrls.Add(providerResolved);\n            }\n\n            return components;\n        }\n\n\n        private List<object> BuildImageTemplateComponents_Meta(\n       string? imageUrl,\n       List<string> templateParams,\n       List<CampaignButton>? buttonList,\n       TemplateMetadataDto templateMeta,\n       Guid campaignSendLogId,\n       Contact contact,\n       out List<string> resolvedButtonUrls)\n        {\n            var components = new List<object>();\n            resolvedButtonUrls = new List<string>();\n\n            // Header\n            if (!string.IsNullOrWhiteSpace(imageUrl) && templateMeta.HasImageHeader)\n            {\n                components.Add(new\n                {\n                    type = \"header\",\n                    parameters = new[]\n                    {\n                new { type = \"image\", image = new { link = imageUrl } }\n            }\n                });\n            }\n\n            // Body\n            if (templateMeta.PlaceholderCount > 0 && templateParams?.Count > 0)\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = templateParams.Select(p => new { type = \"text\", text = p }).ToArray()\n                });\n            }\n\n            // Dynamic URL buttons only\n            if (buttonList == null || buttonList.Count == 0 ||\n                templateMeta.ButtonParams == null || templateMeta.ButtonParams.Count == 0)\n                return components;\n\n            var total = Math.Min(3, Math.Min(buttonList.Count, (templateMeta.ButtonParams?.Count() ?? 0)));\n            var phone = string.IsNullOrWhiteSpace(contact?.PhoneNumber) ? \"\" :\n                        (contact.PhoneNumber.StartsWith(\"+\") ? contact.PhoneNumber : \"+\" + contact.PhoneNumber);\n            var encodedPhone = Uri.EscapeDataString(phone);\n\n            for (int i = 0; i < total; i++)\n            {\n                var meta = templateMeta.ButtonParams[i];\n                var metaParam = meta.ParameterValue?.Trim();\n                var isDynamic = !string.IsNullOrWhiteSpace(metaParam) && metaParam.Contains(\"{{\");\n                if (!isDynamic) continue;\n\n                var btn = buttonList[i];\n                var valueRaw = btn.Value?.Trim();\n                if (string.IsNullOrWhiteSpace(valueRaw)) continue;\n\n                var subtype = (meta.SubType ?? \"url\").ToLowerInvariant();\n\n                // {{n}} substitution ({{1}} := phone)\n                var resolvedDestination = PlaceholderRe.Replace(valueRaw, m =>\n                {\n                    if (!int.TryParse(m.Groups[1].Value, out var n)) return \"\";\n                    if (n == 1) return encodedPhone;\n                    var idx = n - 1;\n                    return (idx >= 0 && idx < templateParams.Count) ? (templateParams[idx] ?? \"\") : \"\";\n                });\n\n                var fullTrackedUrl = _urlBuilderService.BuildTrackedButtonUrl(campaignSendLogId, i, btn.Title, resolvedDestination);\n                var tokenParam = BuildTokenParam(campaignSendLogId, i, btn.Title, resolvedDestination);\n\n                var templateHasAbsoluteBase = LooksLikeAbsoluteBaseUrlWithPlaceholder(metaParam);\n                var valueToSend = templateHasAbsoluteBase ? tokenParam : fullTrackedUrl;\n\n                components.Add(new Dictionary<string, object>\n                {\n                    [\"type\"] = \"button\",\n                    [\"sub_type\"] = subtype,      // \"url\"\n                    [\"index\"] = i.ToString(), // \"0\"/\"1\"/\"2\" for Meta\n                    [\"parameters\"] = new[] { new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = valueToSend } }\n                });\n\n                var providerResolved = ReplaceAllPlaceholdersWith(metaParam ?? \"\", valueToSend);\n                resolvedButtonUrls.Add(providerResolved);\n            }\n\n            return components;\n        }\n\n\n        private List<object> BuildVideoTemplateComponents_Pinnacle(\n            string? videoUrl,\n            List<string> templateParams,\n            List<CampaignButton>? buttonList,\n            TemplateMetadataDto templateMeta,\n            Guid campaignSendLogId,\n            Contact contact)\n        {\n            var components = new List<object>();\n\n            // --- Header (VIDEO) ---\n            // TemplateMetadataDto has no HeaderType/HasVideoHeader → emit header when URL is present.\n            if (!string.IsNullOrWhiteSpace(videoUrl))\n            {\n                components.Add(new\n                {\n                    type = \"header\",\n                    parameters = new object[]\n                    {\n                new { type = \"video\", video = new { link = videoUrl } }\n                    }\n                });\n            }\n\n            // --- Body ---\n            var bodyCount = templateMeta?.PlaceholderCount ?? 0;\n            if (templateParams != null && templateParams.Count > 0 && bodyCount > 0)\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = templateParams.Select(p => new { type = \"text\", text = p ?? string.Empty }).ToArray()\n                });\n            }\n\n            // --- Buttons (URL buttons only; indexes 0..2) ---\n            if (buttonList != null && buttonList.Count > 0)\n            {\n                components.AddRange(BuildPinnacleUrlButtons(buttonList));\n            }\n\n            return components;\n        }\n\n        // Works with either CampaignButton (Type/Value) or CampaignButtonDto (ButtonType/TargetUrl).\n        private static IEnumerable<object> BuildPinnacleUrlButtons(IEnumerable<object> rawButtons)\n        {\n            // keep incoming order; cap at 3\n            var ordered = (rawButtons ?? Enumerable.Empty<object>()).Take(3).ToList();\n            var n = ordered is ICollection<object> col ? col.Count : ordered.Count();\n\n            for (int i = 0; i < n; i++)\n            {\n                var b = ordered[i];\n\n                // Try to read \"Type\" or \"ButtonType\"\n                var typeProp = b.GetType().GetProperty(\"Type\") ?? b.GetType().GetProperty(\"ButtonType\");\n                var typeVal = (typeProp?.GetValue(b) as string)?.Trim().ToLowerInvariant() ?? \"url\";\n                if (typeVal != \"url\") continue;\n\n                // Try to read \"Value\" (CampaignButton) or \"TargetUrl\" (CampaignButtonDto)\n                var valueProp = b.GetType().GetProperty(\"Value\") ?? b.GetType().GetProperty(\"TargetUrl\");\n                var paramText = (valueProp?.GetValue(b) as string) ?? string.Empty;\n\n                // If there is a per-recipient URL param, include it; otherwise emit static URL button (no parameters).\n                if (!string.IsNullOrWhiteSpace(paramText))\n                {\n                    yield return new\n                    {\n                        type = \"button\",\n                        sub_type = \"url\",\n                        index = i, // 0-based\n                        parameters = new object[]\n                        {\n                    new { type = \"text\", text = paramText }\n                        }\n                    };\n                }\n                else\n                {\n                    yield return new\n                    {\n                        type = \"button\",\n                        sub_type = \"url\",\n                        index = i\n                    };\n                }\n            }\n        }\n\n        private static List<object> BuildVideoTemplateComponents_Meta(\n                string? videoUrl,\n                List<string>? templateParams,\n                List<CampaignButtonDto>? buttonParams,\n                TemplateMetadataDto? templateMeta)\n        {\n            var components = new List<object>();\n\n            // We’re in the VIDEO sender path, so add header only if a URL is present.\n            if (!string.IsNullOrWhiteSpace(videoUrl))\n            {\n                components.Add(new\n                {\n                    type = \"header\",\n                    parameters = new object[]\n                    {\n                new { type = \"video\", video = new { link = videoUrl } }\n                    }\n                });\n            }\n\n            // Body placeholders: use meta.PlaceholderCount if available, otherwise list length.\n            var bodyCount = templateMeta?.PlaceholderCount ?? templateParams?.Count ?? 0;\n            if (bodyCount > 0 && (templateParams?.Count ?? 0) > 0)\n            {\n                components.Add(new\n                {\n                    type = \"body\",\n                    parameters = templateParams!.Select(p => new { type = \"text\", text = p ?? string.Empty }).ToArray()\n                });\n            }\n\n            // Buttons (URL buttons only). See helper below.\n            if (buttonParams != null && buttonParams.Count > 0)\n            {\n                components.AddRange(BuildMetaTemplateButtons(buttonParams, templateMeta));\n            }\n\n            return components;\n        }\n\n        private static IEnumerable<object> BuildMetaTemplateButtons(\n            List<CampaignButtonDto> buttons,\n            TemplateMetadataDto? templateMeta)   // meta unused here; kept for future expansion\n        {\n            // Keep incoming order; cap at 3\n            var ordered = (buttons ?? new List<CampaignButtonDto>())\n                .Take(3)\n                .ToList();\n\n            // Avoid Count ambiguity by caching n\n            int n = ordered is ICollection<CampaignButtonDto> col ? col.Count : ordered.Count();\n\n            for (int i = 0; i < n; i++)\n            {\n                var b = ordered[i];\n\n                // Only URL buttons are supported for parameterized Meta buttons\n                var isUrl = string.Equals(b?.ButtonType, \"url\", StringComparison.OrdinalIgnoreCase);\n                if (!isUrl) continue;\n\n                // If we have a per-recipient param (TargetUrl), include a parameter; else emit static button\n                var paramText = b?.TargetUrl ?? string.Empty;\n                var needsParam = !string.IsNullOrWhiteSpace(paramText);\n\n                if (needsParam)\n                {\n                    yield return new\n                    {\n                        type = \"button\",\n                        sub_type = \"url\",\n                        index = i, // Meta uses 0-based indexes\n                        parameters = new object[]\n                        {\n                    new { type = \"text\", text = paramText }\n                        }\n                    };\n                }\n                else\n                {\n                    yield return new\n                    {\n                        type = \"button\",\n                        sub_type = \"url\",\n                        index = i\n                    };\n                }\n            }\n        }\n\n\n        public async Task<List<FlowListItemDto>> GetAvailableFlowsAsync(Guid businessId, bool onlyPublished = true)\n        {\n            return await _context.CTAFlowConfigs\n                .AsNoTracking()\n                .Where(f => f.BusinessId == businessId && f.IsActive && (!onlyPublished || f.IsPublished))\n                .OrderByDescending(f => f.UpdatedAt)\n                .Select(f => new FlowListItemDto\n                {\n                    Id = f.Id,\n                    FlowName = f.FlowName,\n                    IsPublished = f.IsPublished\n                })\n                .ToListAsync();\n        }\n        // ===================== DRY RUN (Step 2.3) =====================\n\n        public async Task<CampaignDryRunResponseDto> DryRunTemplateCampaignAsync(Guid campaignId, int maxRecipients = 20)\n        {\n            var resp = new CampaignDryRunResponseDto { CampaignId = campaignId };\n\n            // Load campaign + recipients (+Contact +AudienceMember) + buttons\n            var campaign = await _context.Campaigns\n                .Include(c => c.Recipients).ThenInclude(r => r.Contact)\n                .Include(c => c.Recipients).ThenInclude(r => r.AudienceMember)\n                .Include(c => c.MultiButtons)\n                .FirstOrDefaultAsync(c => c.Id == campaignId && !c.IsDeleted);\n\n            if (campaign == null)\n            {\n                resp.Notes.Add(\"Campaign not found.\");\n                return resp;\n            }\n\n            resp.CampaignType = campaign.CampaignType ?? \"text\";\n\n            // Resolve entry template name from flow if present, else fall back\n            var (_, entryTemplate) = await ResolveFlowEntryAsync(campaign.BusinessId, campaign.CTAFlowConfigId);\n            var templateName = !string.IsNullOrWhiteSpace(entryTemplate)\n                ? entryTemplate!\n                : (campaign.TemplateId ?? campaign.MessageTemplate ?? \"\");\n\n            if (string.IsNullOrWhiteSpace(templateName))\n            {\n                resp.Notes.Add(\"Template name is missing.\");\n                return resp;\n            }\n\n            // Fetch provider template metadata once (language, placeholders, button schema)\n            var templateMeta = await _templateFetcherService.GetTemplateByNameAsync(\n                campaign.BusinessId, templateName, includeButtons: true);\n\n            resp.TemplateName = templateName;\n\n            if (templateMeta == null)\n            {\n                resp.Notes.Add($\"Template metadata not found for business. Name='{templateName}'.\");\n                return resp;\n            }\n\n            resp.Language = (templateMeta.Language ?? \"\").Trim();\n            resp.HasHeaderMedia = templateMeta.HasImageHeader;\n\n            if (string.IsNullOrWhiteSpace(resp.Language))\n                resp.Notes.Add(\"Template language is not specified on metadata.\");\n\n            // Ensure non-null param list for builders (snapshot provided params)\n            var providedParams = TemplateParameterHelper.ParseTemplateParams(campaign.TemplateParameters)\n                                 ?? new List<string>();\n\n            resp.RequiredPlaceholders = Math.Max(0, templateMeta.PlaceholderCount);\n            resp.ProvidedPlaceholders = providedParams.Count;\n\n            if (resp.RequiredPlaceholders != resp.ProvidedPlaceholders)\n                resp.Notes.Add($\"Placeholder mismatch: template requires {resp.RequiredPlaceholders}, provided {resp.ProvidedPlaceholders}. Consider re-snapshotting parameters.\");\n\n            // Dynamic URL button check (template expects params) vs campaign button values\n            var templButtons = templateMeta.ButtonParams ?? new List<ButtonMetadataDto>();\n            bool templateHasDynamicUrl = templButtons.Any(b =>\n                string.Equals(b.SubType ?? \"url\", \"url\", StringComparison.OrdinalIgnoreCase) &&\n                !string.IsNullOrWhiteSpace(b.ParameterValue) &&\n                b.ParameterValue!.Contains(\"{{\"));\n\n            if (templateHasDynamicUrl)\n            {\n                var hasCampaignUrlValues = (campaign.MultiButtons ?? new List<CampaignButton>())\n                    .Any(cb => !string.IsNullOrWhiteSpace(cb.Value));\n                if (!hasCampaignUrlValues)\n                    resp.Notes.Add(\"Template defines dynamic URL button(s) with placeholders, but campaign has no URL button values configured.\");\n            }\n\n            // Provider normalization for preview\n            var provider = (campaign.Provider ?? \"META_CLOUD\").Trim().ToUpperInvariant();\n            if (provider != \"PINNACLE\" && provider != \"META_CLOUD\")\n            {\n                resp.Notes.Add($\"Invalid provider on campaign: '{campaign.Provider}'. Dry run will assume META_CLOUD.\");\n                provider = \"META_CLOUD\";\n            }\n\n            // Slice some recipients (prefer latest activity; CreatedAt is not on CampaignRecipient)\n            var recipients = (campaign.Recipients ?? new List<CampaignRecipient>())\n     .OrderByDescending(r => (DateTime?)r.UpdatedAt\n                              ?? r.MaterializedAt\n                              ?? r.SentAt\n                              ?? DateTime.MinValue)\n     .Take(Math.Clamp(maxRecipients, 1, 200))\n     .ToList();\n\n            resp.RecipientsConsidered = recipients.Count;\n\n            // Helper: resolve a phone for a recipient\n            static string? ResolveRecipientPhone(CampaignRecipient r) =>\n                r?.Contact?.PhoneNumber ?? r?.AudienceMember?.PhoneE164 ?? r?.AudienceMember?.PhoneRaw;\n\n            int okCount = 0, errCount = 0;\n\n            foreach (var r in recipients)\n            {\n                var phoneResolved = ResolveRecipientPhone(r) ?? \"\";\n                var contactName = r.Contact?.Name ?? r.AudienceMember?.Name;\n\n                var one = new CampaignDryRunRecipientResultDto\n                {\n                    ContactId = r.ContactId,\n                    ContactName = contactName,\n                    PhoneNumber = phoneResolved\n                };\n\n                // Phone checks (presence + basic shape)\n                var phone = (one.PhoneNumber ?? string.Empty).Trim();\n                if (string.IsNullOrEmpty(phone))\n                {\n                    one.Errors.Add(\"Recipient phone missing (no Contact and no AudienceMember phone).\");\n                }\n                else if (!Regex.IsMatch(phone, @\"^\\+?\\d{8,15}$\"))\n                {\n                    one.Warnings.Add(\"Recipient phone may be invalid (basic format check failed).\");\n                }\n\n                try\n                {\n                    // Always synthesize a contact to avoid null derefs in builders\n                    var contactForTemplating = r.Contact ?? new Contact\n                    {\n                        Id = Guid.Empty,\n                        BusinessId = campaign.BusinessId,\n                        PhoneNumber = phoneResolved,\n                        Name = contactName ?? \"Customer\"\n                    };\n\n                    // Buttons ordered like send path: by Position then original index; limit 3\n                    var buttons = (campaign.MultiButtons ?? new List<CampaignButton>())\n                        .Select((b, idx) => new { Btn = b, idx })\n                        .OrderBy(x => (int?)x.Btn.Position ?? int.MaxValue)\n                        .ThenBy(x => x.idx)\n                        .Select(x => x.Btn)\n                        .Take(3)\n                        .ToList();\n\n                    // Build components for preview (match send path) — single call, discard out URLs\n                    List<object> components;\n                    var isImage = (campaign.CampaignType ?? \"text\")\n                        .Equals(\"image\", StringComparison.OrdinalIgnoreCase);\n\n                    if (isImage)\n                    {\n                        components = (provider == \"PINNACLE\")\n                            ? BuildImageTemplateComponents_Pinnacle(\n                                campaign.ImageUrl, providedParams, buttons, templateMeta, Guid.NewGuid(), contactForTemplating, out _)\n                            : BuildImageTemplateComponents_Meta(\n                                campaign.ImageUrl, providedParams, buttons, templateMeta, Guid.NewGuid(), contactForTemplating, out _);\n                    }\n                    else\n                    {\n                        components = (provider == \"PINNACLE\")\n                            ? BuildTextTemplateComponents_Pinnacle(\n                                providedParams, buttons, templateMeta, Guid.NewGuid(), contactForTemplating, out _)\n                            : BuildTextTemplateComponents_Meta(\n                                providedParams, buttons, templateMeta, Guid.NewGuid(), contactForTemplating, out _);\n                    }\n\n                    // Additional validations like the send path: blank required params\n                    if (templateMeta.PlaceholderCount > 0 &&\n                        (providedParams.Count < templateMeta.PlaceholderCount ||\n                         providedParams.Take(templateMeta.PlaceholderCount).Any(string.IsNullOrWhiteSpace)))\n                    {\n                        one.Errors.Add($\"Missing body parameter(s): template requires {templateMeta.PlaceholderCount}, provided {providedParams.Count} (or some blank).\");\n                    }\n\n                    one.ProviderComponents = components;\n                    one.WouldSend = one.Errors.Count == 0;\n                    if (one.WouldSend) okCount++; else errCount++;\n                }\n                catch (Exception ex)\n                {\n                    one.Errors.Add(ex.Message);\n                    one.WouldSend = false;\n                    errCount++;\n                }\n\n                resp.Results.Add(one);\n            }\n\n            resp.WouldSendCount = okCount;\n            resp.ErrorCount = errCount;\n\n            // Billability (best-effort)\n            resp.EstimatedChargeable = true;\n            resp.EstimatedConversationCategory = \"template_outbound\";\n            if (!resp.Notes.Any(n => n.Contains(\"Template messages are typically chargeable\")))\n                resp.Notes.Add(\"Estimation: Template messages are typically chargeable and start a new conversation unless covered by free-entry flows.\");\n\n            return resp;\n        }\n\n        private static List<CampaignButtonDto> MapButtonVarsToButtonDtos(Dictionary<string, string>? vars)\n        {\n            var list = new List<CampaignButtonDto>();\n            if (vars == null || vars.Count == 0) return list;\n\n            // We only care about URL buttons 1..3; take the param text\n            for (var i = 1; i <= 3; i++)\n            {\n                if (vars.TryGetValue($\"button{i}.url_param\", out var param) && !string.IsNullOrWhiteSpace(param))\n                {\n                    list.Add(new CampaignButtonDto\n                    {\n                        ButtonText = $\"Button {i}\",   // optional; purely cosmetic\n                        ButtonType = \"url\",\n                        TargetUrl = param\n                    });\n                }\n            }\n            return list;\n        }\n        private async Task<ResponseResult> SendDocumentTemplateCampaignAsync(Campaign campaign)\n        {\n            var sw = System.Diagnostics.Stopwatch.StartNew();\n            _logger.LogInformation(\"[DocSend] Begin. campaignId={CampaignId}\", campaign.Id);\n\n            // force an IEnumerable → List and use a distinct name to avoid symbol collisions\n            var recipientsList = (campaign.Recipients ?? Enumerable.Empty<CampaignRecipient>())\n                    .Where(r =>\n                    !string.IsNullOrWhiteSpace(r.Contact?.PhoneNumber) ||\n                    !string.IsNullOrWhiteSpace(r.AudienceMember?.PhoneE164))\n                         .ToList();\n\n            // Use Any() (robust even if someone shadows Count somewhere)\n            if (!recipientsList.Any())\n                return ResponseResult.ErrorInfo(\"⚠️ No valid recipients with phone numbers.\");\n\n            var templateName = campaign.MessageTemplate;\n            var languageCode = \"en_US\"; // keep consistent with your image/video path\n            var provider = (campaign.Provider ?? \"META\").ToUpperInvariant();\n            var phoneNumberId = campaign.PhoneNumberId;\n\n            // optional static fallback (we don't have Campaign.DocumentUrl in this branch)\n            var staticDocUrl = campaign.ImageUrl;\n\n            var ok = 0; var fail = 0;\n\n            foreach (var r in recipientsList)\n            {\n                var to = r.Contact?.PhoneNumber ?? r.AudienceMember?.PhoneE164 ?? \"\";\n                if (string.IsNullOrWhiteSpace(to)) continue;\n\n                try\n                {\n                    // These helpers were added earlier:\n                    var templateParams = BuildBodyParametersForRecipient(campaign, r);\n                    var buttonVars = BuildButtonParametersForRecipient(campaign, r);\n                    var buttonsDto = MapButtonVarsToButtonDtos(buttonVars);\n                    // Per-recipient doc header; no campaign-level DocumentUrl in this branch\n                    var headerDocUrl = ResolvePerRecipientValue(r, \"header.document_url\") ?? staticDocUrl;\n\n                    var dto = new DocumentTemplateMessageDto\n                    {\n                        BusinessId = campaign.BusinessId,\n                        RecipientNumber = to,\n                        TemplateName = templateName,\n                        LanguageCode = languageCode,\n                        HeaderDocumentUrl = headerDocUrl,\n                        // match your DTO property names exactly — use the ones your MessageEngine expects:\n                        Parameters = templateParams,   // or TemplateParameters if that's your DTO\n                        Buttons = buttonsDto,      // or ButtonParameters if that's your DTO\n                        Provider = provider,\n                        PhoneNumberId = phoneNumberId,\n                        CTAFlowConfigId = campaign.CTAFlowConfigId,\n                        TemplateBody = campaign.MessageBody\n                    };\n\n                    var sent = await _messageEngineService.SendDocumentTemplateMessageAsync(dto, campaign.BusinessId);\n                    var success = sent.Success;\n\n                    if (success) ok++; else fail++;\n\n                    await LogSendAsync(campaign, r, to, provider, success, headerDocUrl, \"document\");\n                    _logger.LogInformation(\"[DocSend] to={To} success={Success}\", to, success);\n                }\n                catch (Exception ex)\n                {\n                    fail++;\n                    _logger.LogError(ex, \"[DocSend] failed to={To}\", to);\n                    await LogSendAsync(campaign, r, to, provider, false, staticDocUrl, \"document\", ex.Message);\n                }\n            }\n\n            sw.Stop();\n            var msg = $\"Document campaign finished. Success={ok}, Failed={fail}\";\n            _logger.LogInformation(\"[DocSend] Done. campaignId={CampaignId} {Msg}\", campaign.Id, msg);\n\n            return fail == 0 ? ResponseResult.SuccessInfo(msg) : ResponseResult.ErrorInfo(msg);\n        }\n        private Task LogSendAsync(\n                    Campaign campaign,\n                    CampaignRecipient recipient,\n                    string to, string provider,\n                    bool success, string? headerUrl,\n                    string channel, string? error = null)\n        {\n            _logger.LogInformation(\n                \"[SendLog] campaignId={CampaignId} to={To} provider={Provider} channel={Channel} success={Success} headerUrl={HeaderUrl} error={Error}\",\n                campaign.Id, to, provider, channel, success, headerUrl, error);\n\n            // If/when you have a CampaignSendLogs table, insert there instead.\n            return Task.CompletedTask;\n        }\n\n        private static string[] ReadResolvedParams(CampaignRecipient r)\n        {\n            var s = r?.ResolvedParametersJson;\n            if (string.IsNullOrWhiteSpace(s)) return Array.Empty<string>();\n            try\n            {\n                return JsonConvert.DeserializeObject<string[]>(s) ?? Array.Empty<string>();\n            }\n            catch\n            {\n                return Array.Empty<string>();\n            }\n        }\n\n        private static Dictionary<string, string> ReadResolvedButtonVars(CampaignRecipient r)\n        {\n            var s = r?.ResolvedButtonUrlsJson;\n            var dict = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            if (string.IsNullOrWhiteSpace(s)) return dict;\n            try\n            {\n                return JsonConvert.DeserializeObject<Dictionary<string, string>>(s)\n                       ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n            }\n            catch\n            {\n                return dict;\n            }\n        }\n\n        private static string? TryGetHeaderMedia(Dictionary<string, string> vars, params string[] keys)\n        {\n            foreach (var k in keys)\n                if (!string.IsNullOrWhiteSpace(k) && vars.TryGetValue(k, out var v) && !string.IsNullOrWhiteSpace(v))\n                    return v;\n            return null;\n        }\n\n        public Task<object> SendVideoTemplateMessageAsync(VideoTemplateMessageDto dto, Guid businessId)\n        {\n            throw new NotImplementedException();\n        }\n\n        public async Task<bool> CheckNameAvailableAsync(Guid businessId, string name)\n        {\n            var exists = await _context.Campaigns\n                .AsNoTracking()\n                .AnyAsync(c => c.BusinessId == businessId && c.Name == name);\n            return !exists;\n        }\n\n        public async Task RescheduleAsync(Guid businessId, Guid campaignId, DateTime newUtcTime)\n        {\n            var now = DateTime.UtcNow;\n            if (newUtcTime <= now) throw new InvalidOperationException(\"New time must be in the future (UTC).\");\n\n            var c = await _context.Campaigns.FirstOrDefaultAsync(x => x.Id == campaignId && x.BusinessId == businessId);\n            if (c == null) throw new KeyNotFoundException(\"Campaign not found.\");\n\n            c.ScheduledAt = newUtcTime;\n            c.Status = \"Queued\"; // UI can show as “Scheduled”\n            c.UpdatedAt = now;\n\n            var job = await _context.OutboundCampaignJobs\n                .FirstOrDefaultAsync(j => j.CampaignId == campaignId && j.Status == \"queued\");\n\n            if (job != null)\n            {\n                job.NextAttemptAt = newUtcTime;\n                job.UpdatedAt = now;\n            }\n            else\n            {\n                await _context.OutboundCampaignJobs.AddAsync(new OutboundCampaignJob\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    CampaignId = campaignId,\n                    Status = \"queued\",\n                    Attempt = 0,\n                    MaxAttempts = 5,\n                    NextAttemptAt = newUtcTime,\n                    CreatedAt = now,\n                    UpdatedAt = now\n                });\n            }\n\n            await _context.SaveChangesAsync();\n        }\n\n        public async Task EnqueueNowAsync(Guid businessId, Guid campaignId)\n        {\n            var now = DateTime.UtcNow;\n\n            var c = await _context.Campaigns.FirstOrDefaultAsync(x => x.Id == campaignId && x.BusinessId == businessId);\n            if (c == null) throw new KeyNotFoundException(\"Campaign not found.\");\n\n            var job = await _context.OutboundCampaignJobs\n                .FirstOrDefaultAsync(j => j.CampaignId == campaignId && j.Status == \"queued\");\n\n            if (job == null)\n            {\n                job = new OutboundCampaignJob\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    CampaignId = campaignId,\n                    Status = \"queued\",\n                    Attempt = 0,\n                    MaxAttempts = 5,\n                    CreatedAt = now,\n                };\n                await _context.OutboundCampaignJobs.AddAsync(job);\n            }\n            job.NextAttemptAt = now;\n            job.UpdatedAt = now;\n\n            c.ScheduledAt = null;\n            c.Status = \"Queued\";\n            c.UpdatedAt = now;\n\n            await _context.SaveChangesAsync();\n        }\n\n        public async Task CancelScheduleAsync(Guid businessId, Guid campaignId)\n        {\n            var now = DateTime.UtcNow;\n\n            var c = await _context.Campaigns.FirstOrDefaultAsync(x => x.Id == campaignId && x.BusinessId == businessId);\n            if (c == null) throw new KeyNotFoundException(\"Campaign not found.\");\n\n            var job = await _context.OutboundCampaignJobs\n                .FirstOrDefaultAsync(j => j.CampaignId == campaignId && j.Status == \"queued\");\n\n            if (job != null)\n            {\n                job.Status = \"canceled\";\n                job.UpdatedAt = now;\n            }\n\n            c.ScheduledAt = null;\n            c.Status = \"Draft\";\n            c.UpdatedAt = now;\n\n            await _context.SaveChangesAsync();\n        }\n        public async Task<CampaignUsageDto?> GetCampaignUsageAsync(Guid businessId, Guid campaignId)\n        {\n            // Base campaign (scoped to business & not deleted)\n            var baseRow = await _context.Campaigns\n                .AsNoTracking()\n                .Where(c => c.Id == campaignId && c.BusinessId == businessId && !c.IsDeleted)\n                .Select(c => new\n                {\n                    c.Id,\n                    c.BusinessId,\n                    c.Name,\n                    c.Status,\n                    c.CreatedAt,\n                    c.ScheduledAt,\n                    c.CTAFlowConfigId\n                })\n                .FirstOrDefaultAsync();\n\n            if (baseRow == null) return null;\n\n            var statusNorm = (baseRow.Status ?? string.Empty).Trim().ToUpperInvariant();\n            if (string.IsNullOrWhiteSpace(statusNorm)) statusNorm = \"DRAFT\";\n\n            // Counts\n            var recipientsCount = await _context.CampaignRecipients\n                .AsNoTracking()\n                .Where(r => r.CampaignId == campaignId)\n                .CountAsync();\n\n            var queuedJobsCount = await _context.OutboundCampaignJobs\n                .AsNoTracking()\n                .Where(j => j.CampaignId == campaignId)\n                .CountAsync();\n\n            var sendLogsCount = await _context.CampaignSendLogs\n                .AsNoTracking()\n                .Where(l => l.CampaignId == campaignId)\n                .CountAsync();\n\n            // Compute FirstSentAt from logs (since Campaign has no FirstSentAt column)\n            var firstSentAt = await _context.CampaignSendLogs\n                .AsNoTracking()\n                .Where(l => l.CampaignId == campaignId)\n                .OrderBy(l => l.SentAt ?? l.CreatedAt) // prefer SentAt if present, else CreatedAt\n                .Select(l => (DateTime?)(l.SentAt ?? l.CreatedAt))\n                .FirstOrDefaultAsync();\n\n            return new CampaignUsageDto\n            {\n                CampaignId = baseRow.Id,\n                Name = baseRow.Name,\n                Status = statusNorm,                  // string, normalized\n                Recipients = recipientsCount,             // int\n                QueuedJobs = queuedJobsCount,             // int\n                SendLogs = sendLogsCount,               // int\n                HasFlow = baseRow.CTAFlowConfigId.HasValue,\n                FlowId = baseRow.CTAFlowConfigId,\n                CreatedAt = baseRow.CreatedAt,           // DateTime?\n                ScheduledAt = baseRow.ScheduledAt,         // DateTime?\n                FirstSentAt = firstSentAt                  // DateTime? (from logs)\n            };\n        }\n\n        private async Task EnqueueOutboundJobsAsync(\n           Campaign campaign,\n           string provider,\n           string mediaType,\n           string templateName,\n           string languageCode,\n           string? phoneNumberId,\n           IEnumerable<(CampaignRecipient r, string paramsJson, string btnsJson, string? headerUrl, string idemKey)> items,\n           CancellationToken ct = default)\n        {\n            const int batchSize = 500;\n            var buffer = new List<OutboundMessageJob>(batchSize);\n            var now = DateTime.UtcNow;\n\n            foreach (var it in items)\n            {\n                buffer.Add(new OutboundMessageJob\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = campaign.BusinessId,\n                    CampaignId = campaign.Id,\n                    RecipientId = it.r.Id,\n                    Provider = (provider ?? string.Empty).Trim(),\n                    MediaType = mediaType,\n                    TemplateName = templateName,\n                    LanguageCode = languageCode,\n                    PhoneNumberId = phoneNumberId,\n                    ResolvedParamsJson = it.paramsJson,\n                    ResolvedButtonUrlsJson = it.btnsJson,\n                    HeaderMediaUrl = it.headerUrl,\n                    MessageBody = campaign.MessageBody,\n                    // ✅ Allow repeats — do not use idempotency for campaign sends\n                    IdempotencyKey = null,\n                    Status = \"Pending\",\n                    Attempt = 0,\n                    CreatedAt = now,\n                    NextAttemptAt = now,\n\n                });\n\n                if (buffer.Count >= batchSize)\n                {\n                    _context.OutboundMessageJobs.AddRange(buffer);\n                    await _context.SaveChangesAsync(ct);\n                    buffer.Clear();\n                }\n            }\n\n            if (buffer.Count > 0)\n            {\n                _context.OutboundMessageJobs.AddRange(buffer);\n                await _context.SaveChangesAsync(ct);\n                buffer.Clear();\n            }\n        }\n\n\n\n    }\n    #endregion\n}\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CsvBatchService.cs",
      "sha256": "aab6257168735e04f271426696addc1907e46d5f0be69310abeea0bfe14793f0",
      "language": "csharp",
      "size": 27780,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Linq;\nusing System.Text;\nusing System.Text.Json;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing Microsoft.Extensions.Options;\nusing xbytechat.api.Features.CampaignModule.CountryCodes;\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public class CsvBatchService : ICsvBatchService\n    {\n        private readonly AppDbContext _db;\n\n        public CsvBatchService(AppDbContext db)\n        {\n            _db = db;\n\n        }\n\n        // ----------------------------\n        // Upload + ingest\n        // ----------------------------\n        public async Task<CsvBatchUploadResultDto> CreateAndIngestAsync(\n        Guid businessId,\n        string fileName,\n        Stream stream,\n        Guid? audienceId = null,\n        Guid? campaignId = null,\n        CancellationToken ct = default)\n        {\n            // If we’re in a campaign context and no audience was supplied, create one now.\n            Audience? audience = null;\n            if (audienceId is null && campaignId is not null)\n            {\n                var campaignExists = await _db.Campaigns\n                    .AnyAsync(c => c.Id == campaignId && c.BusinessId == businessId, ct);\n                if (!campaignExists)\n                    throw new InvalidOperationException(\"Campaign not found for this business.\");\n\n                audience = new Audience\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    CampaignId = campaignId,                  // ← link to campaign (so delete cascades)\n                    Name = Path.GetFileNameWithoutExtension(fileName) + \" (CSV)\",\n                    CreatedAt = DateTime.UtcNow,\n                    IsDeleted = false\n                };\n\n                _db.Audiences.Add(audience);\n                await _db.SaveChangesAsync(ct);              // get Audience.Id\n                audienceId = audience.Id;                    // feed it into the batch\n            }\n\n            // 1) Create batch shell (now with a guaranteed AudienceId if campaignId was provided)\n            var batch = new CsvBatch\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                AudienceId = audienceId,                     // ← no longer null for campaign CSVs\n                FileName = fileName,\n                CreatedAt = DateTime.UtcNow,\n                Status = \"ingesting\",\n                RowCount = 0,\n                SkippedCount = 0,\n                HeadersJson = null\n            };\n\n            _db.CsvBatches.Add(batch);\n            await _db.SaveChangesAsync(ct);\n\n            // Keep both sides in sync if we created the audience here.\n            if (audience is not null)\n            {\n                audience.CsvBatchId = batch.Id;              // ← your model maps this too\n                await _db.SaveChangesAsync(ct);\n            }\n\n            try\n            {\n                // ───── your existing parsing logic (unchanged) ─────\n                stream.Position = 0;\n                using var reader = new StreamReader(stream, Encoding.UTF8, detectEncodingFromByteOrderMarks: true, bufferSize: 1024, leaveOpen: true);\n\n                string? headerLine = await reader.ReadLineAsync();\n                if (string.IsNullOrWhiteSpace(headerLine))\n                {\n                    var headers = new List<string> { \"phone\" };\n                    batch.HeadersJson = JsonSerializer.Serialize(headers);\n                    batch.Status = \"ready\";\n                    await _db.SaveChangesAsync(ct);\n\n                    Log.Warning(\"CSV had no header line. Created batch {BatchId} with fallback 'phone' header.\", batch.Id);\n\n                    return new CsvBatchUploadResultDto\n                    {\n                        BatchId = batch.Id,\n                        AudienceId = batch.AudienceId,\n                        FileName = batch.FileName ?? string.Empty,\n                        RowCount = 0,\n                        Headers = headers\n                    };\n                }\n\n                var delim = DetectDelimiter(headerLine);\n                var headersParsed = ParseCsvLine(headerLine, delim)\n                    .Select(h => h.Trim())\n                    .Where(h => !string.IsNullOrEmpty(h))\n                    .ToList();\n\n                if (headersParsed.Count == 0)\n                    headersParsed = new List<string> { \"phone\" };\n\n                //batch.HeadersJson = JsonSerializer.Serialize(headersParsed);\n                //await _db.SaveChangesAsync(ct);\n\n                //var rowsBuffer = new List<CsvRow>(capacity: 1024);\n                //int rowIndex = 0;\n                batch.HeadersJson = JsonSerializer.Serialize(headersParsed);\n                await _db.SaveChangesAsync(ct);\n\n                var rowsBuffer = new List<CsvRow>(capacity: 1024);\n                int rowIndex = 0;\n\n                // Detect the phone column once from the header row.\n                // We try common names; falls back to exact \"phone\" if present.\n                string? phoneHeader =\n                    headersParsed.FirstOrDefault(h =>\n                        PhoneHeaderCandidates.Any(c => c.Equals(h, StringComparison.OrdinalIgnoreCase)))\n                    ?? headersParsed.FirstOrDefault(h => h.Equals(\"phone\", StringComparison.OrdinalIgnoreCase));\n\n                if (phoneHeader == null)\n                {\n                    Log.Warning(\"CsvBatch {BatchId}: no phone-like header found. Headers={Headers}\",\n                        batch.Id, string.Join(\", \", headersParsed));\n                }\n\n                while (!reader.EndOfStream)\n                {\n                    var line = await reader.ReadLineAsync();\n                    if (line is null) break;\n                    if (string.IsNullOrWhiteSpace(line)) continue;\n\n                    var cols = ParseCsvLine(line, delim);\n\n                    var dict = new Dictionary<string, string?>(StringComparer.OrdinalIgnoreCase);\n                    for (int i = 0; i < headersParsed.Count; i++)\n                    {\n                        var key = headersParsed[i];\n                        var val = i < cols.Count ? cols[i]?.Trim() : null;\n                        dict[key] = val;\n                    }\n\n                    // Pull phone value (if we detected a phone header)\n                    string? phoneRaw = null;\n                    if (!string.IsNullOrEmpty(phoneHeader))\n                    {\n                        dict.TryGetValue(phoneHeader, out phoneRaw);\n                    }\n\n                    // Normalize using your existing validator (E.164); capture error if any\n                    string? phoneErr;\n                    var phoneE164 = NormalizeToE164OrError(phoneRaw, out phoneErr);\n\n                    // Buffer the row with both raw + normalized phone and the whole row JSON\n                    rowsBuffer.Add(new CsvRow\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        BatchId = batch.Id,\n                        RowIndex = rowIndex++,\n\n                        PhoneRaw = phoneRaw,\n                        PhoneE164 = phoneE164,\n                        ValidationError = (phoneE164 is null && !string.IsNullOrWhiteSpace(phoneRaw)) ? phoneErr : null,\n\n                        // Persist the entire row as JSON (your model maps DataJson -> RowJson)\n                        RowJson = JsonSerializer.Serialize(dict)\n                    });\n\n\n                    if (rowsBuffer.Count >= 1000)\n                    {\n                        _db.CsvRows.AddRange(rowsBuffer);\n                        await _db.SaveChangesAsync(ct);\n                        rowsBuffer.Clear();\n                    }\n                }\n\n                if (rowsBuffer.Count > 0)\n                {\n                    _db.CsvRows.AddRange(rowsBuffer);\n                    await _db.SaveChangesAsync(ct);\n                }\n\n                batch.RowCount = rowIndex;\n                batch.Status = \"ready\";\n                await _db.SaveChangesAsync(ct);\n\n                Log.Information(\"CsvBatch {BatchId} ingested: {Rows} rows; headers={HeaderCount}\", batch.Id, batch.RowCount, headersParsed.Count);\n\n                return new CsvBatchUploadResultDto\n                {\n                    BatchId = batch.Id,\n                    AudienceId = batch.AudienceId,           // now reliably set for campaign CSVs\n                    FileName = batch.FileName ?? string.Empty,\n                    RowCount = batch.RowCount,\n                    Headers = headersParsed\n                };\n            }\n            catch (Exception ex)\n            {\n                batch.Status = \"failed\";\n                batch.ErrorMessage = ex.Message;\n                await _db.SaveChangesAsync(ct);\n                Log.Error(ex, \"CSV ingest failed for batch {BatchId}\", batch.Id);\n                throw;\n            }\n        }\n\n        // ----------------------------\n        // Batch info\n        // ----------------------------\n        private async Task<CsvBatchUploadResultDto> IngestCoreAsync(\n            Guid businessId,\n            string fileName,\n            Stream stream,\n            CancellationToken ct)\n        {\n            // Minimal “stage only” helper (kept in case other code calls it)\n            var batch = new CsvBatch\n            {\n                Id = Guid.NewGuid(),\n                BusinessId = businessId,\n                FileName = fileName,\n                CreatedAt = DateTime.UtcNow,\n                Status = \"ready\",\n                HeadersJson = null,\n                RowCount = 0,\n                SkippedCount = 0,\n                ErrorMessage = null\n            };\n            _db.CsvBatches.Add(batch);\n            await _db.SaveChangesAsync(ct);\n\n            Log.Information(\"CsvBatch {BatchId} staged for business {Biz}\", batch.Id, businessId);\n\n            return new CsvBatchUploadResultDto\n            {\n                BatchId = batch.Id,\n                AudienceId = null,\n                FileName = fileName,\n                RowCount = 0,\n                Headers = new List<string>(),\n                Message = \"CSV batch created.\"\n            };\n        }\n\n        public async Task<CsvBatchInfoDto?> GetBatchAsync(Guid businessId, Guid batchId, CancellationToken ct = default)\n        {\n            var batch = await _db.CsvBatches\n                .AsNoTracking()\n                .FirstOrDefaultAsync(b => b.Id == batchId && b.BusinessId == businessId, ct);\n\n            if (batch == null) return null;\n\n            var headers = SafeParseHeaderArray(batch.HeadersJson);\n\n            return new CsvBatchInfoDto\n            {\n                BatchId = batch.Id,\n                AudienceId = batch.AudienceId,\n                RowCount = batch.RowCount,\n                Headers = headers,\n                CreatedAt = batch.CreatedAt\n            };\n        }\n\n        // ----------------------------\n        // Samples (single implementation)\n        // ----------------------------\n        public async Task<IReadOnlyList<CsvRowSampleDto>> GetSamplesAsync(\n            Guid businessId,\n            Guid batchId,\n            int take = 20,\n            CancellationToken ct = default)\n        {\n            if (take <= 0) take = 20;\n            if (take > 100) take = 100;\n\n            var batch = await _db.CsvBatches\n                .AsNoTracking()\n                .Where(b => b.Id == batchId && b.BusinessId == businessId)\n                .Select(b => new { b.Id, b.HeadersJson, b.RowCount })\n                .FirstOrDefaultAsync(ct);\n\n            if (batch is null)\n                throw new KeyNotFoundException(\"Batch not found.\");\n\n            // If no rows yet, return empty samples gracefully\n            if (batch.RowCount <= 0)\n                return Array.Empty<CsvRowSampleDto>();\n\n            var headerList = SafeParseHeaderArray(batch.HeadersJson);\n\n            var rows = await _db.CsvRows\n                .AsNoTracking()\n                .Where(r => r.BusinessId == businessId && r.BatchId == batchId)\n                .OrderBy(r => r.RowIndex)\n                .Take(take)\n                .Select(r => new { r.RowIndex, r.DataJson })\n                .ToListAsync(ct);\n\n            var result = new List<CsvRowSampleDto>(rows.Count);\n            foreach (var r in rows)\n            {\n                var dict = SafeParseDict(r.DataJson);\n\n                // Ensure consistent header order (fill missing with null)\n                var ordered = new Dictionary<string, string?>(headerList.Count, StringComparer.OrdinalIgnoreCase);\n                foreach (var h in headerList)\n                {\n                    dict.TryGetValue(h, out var v);\n                    ordered[h] = v;\n                }\n\n                result.Add(new CsvRowSampleDto\n                {\n                    RowIndex = r.RowIndex,\n                    Data = ordered\n                });\n            }\n\n            return result;\n        }\n\n        // ----------------------------\n        // List / Page / Delete / Validate\n        // ----------------------------\n        public async Task<List<CsvBatchListItemDto>> ListBatchesAsync(Guid businessId, int limit = 20, CancellationToken ct = default)\n        {\n            if (limit <= 0) limit = 20;\n            if (limit > 100) limit = 100;\n\n            return await _db.CsvBatches\n                .AsNoTracking()\n                .Where(b => b.BusinessId == businessId)\n                .OrderByDescending(b => b.CreatedAt)\n                .Take(limit)\n                .Select(b => new CsvBatchListItemDto\n                {\n                    BatchId = b.Id,\n                    FileName = b.FileName,\n                    RowCount = b.RowCount,\n                    Status = b.Status,\n                    CreatedAt = b.CreatedAt\n                })\n                .ToListAsync(ct);\n        }\n\n        public async Task<CsvBatchRowsPageDto> GetRowsPageAsync(Guid businessId, Guid batchId, int skip, int take, CancellationToken ct = default)\n        {\n            if (take <= 0) take = 50;\n            if (take > 200) take = 200;\n            if (skip < 0) skip = 0;\n\n            var exists = await _db.CsvBatches.AsNoTracking()\n                .AnyAsync(b => b.Id == batchId && b.BusinessId == businessId, ct);\n            if (!exists) throw new KeyNotFoundException(\"CSV batch not found.\");\n\n            var total = await _db.CsvRows.AsNoTracking()\n                .Where(r => r.BusinessId == businessId && r.BatchId == batchId)\n                .CountAsync(ct);\n\n            var rows = await _db.CsvRows.AsNoTracking()\n                .Where(r => r.BusinessId == businessId && r.BatchId == batchId)\n                .OrderBy(r => r.RowIndex)\n                .Skip(skip)\n                .Take(take)\n                .Select(r => new CsvRowSampleDto\n                {\n                    RowIndex = r.RowIndex,\n                    Data = SafeParseDict(r.DataJson)\n                })\n                .ToListAsync(ct);\n\n            return new CsvBatchRowsPageDto\n            {\n                BatchId = batchId,\n                TotalRows = total,\n                Skip = skip,\n                Take = take,\n                Rows = rows\n            };\n        }\n\n        public async Task<bool> DeleteBatchAsync(Guid businessId, Guid batchId, CancellationToken ct = default)\n        {\n            var batch = await _db.CsvBatches\n                .FirstOrDefaultAsync(b => b.Id == batchId && b.BusinessId == businessId, ct);\n\n            if (batch == null) return false;\n\n            using var tx = await _db.Database.BeginTransactionAsync(ct);\n            try\n            {\n                var rows = _db.CsvRows.Where(r => r.BusinessId == businessId && r.BatchId == batchId);\n                _db.CsvRows.RemoveRange(rows);\n\n                _db.CsvBatches.Remove(batch);\n\n                await _db.SaveChangesAsync(ct);\n                await tx.CommitAsync(ct);\n                return true;\n            }\n            catch\n            {\n                await tx.RollbackAsync(ct);\n                throw;\n            }\n        }\n\n        private static readonly string[] PhoneHeaderCandidates =\n        {  \"phone\", \"phone_number\", \"phonenumber\", \"phoneNumber\", \"phone-no\", \"phone_no\",\n             \"mobile\", \"mobile_number\", \"mobilenumber\", \"whatsapp\", \"whatsapp_no\", \"whatsapp_number\" };\n\n        public async Task<CsvBatchValidationResultDto> ValidateAsync(\n            Guid businessId,\n            Guid batchId,\n            CsvBatchValidationRequestDto request,\n            CancellationToken ct = default)\n        {\n            if (request is null) throw new ArgumentNullException(nameof(request));\n            if (request.SampleSize <= 0) request.SampleSize = 20;\n            if (request.SampleSize > 100) request.SampleSize = 100;\n\n            var batch = await _db.CsvBatches.AsNoTracking()\n                .Where(b => b.BusinessId == businessId && b.Id == batchId)\n                .Select(b => new { b.Id, b.HeadersJson, b.RowCount })\n                .FirstOrDefaultAsync(ct);\n\n            if (batch == null) throw new KeyNotFoundException(\"CSV batch not found.\");\n\n            var headers = SafeParseHeaderArray(batch.HeadersJson);\n            var headerSet = new HashSet<string>(headers, StringComparer.OrdinalIgnoreCase);\n\n            var result = new CsvBatchValidationResultDto\n            {\n                BatchId = batchId,\n                TotalRows = batch.RowCount\n            };\n\n            // Required headers check\n            if (request.RequiredHeaders != null && request.RequiredHeaders.Count > 0)\n            {\n                foreach (var req in request.RequiredHeaders)\n                {\n                    if (!headerSet.Contains(req))\n                        result.MissingRequiredHeaders.Add(req);\n                }\n\n                if (result.MissingRequiredHeaders.Count > 0)\n                    result.Errors.Add(\"Required headers are missing.\");\n            }\n\n            // Determine phone field\n            var phoneField = request.PhoneField;\n            if (string.IsNullOrWhiteSpace(phoneField))\n                phoneField = PhoneHeaderCandidates.FirstOrDefault(headerSet.Contains);\n\n            result.PhoneField = phoneField;\n\n            if (string.IsNullOrWhiteSpace(phoneField))\n            {\n                result.Errors.Add(\"No phone field provided or detected.\");\n                return result; // cannot scan rows without a phone column\n            }\n\n            // Scan rows for phone presence & duplicates\n            var seenPhones = new HashSet<string>(StringComparer.Ordinal);\n            var problemSamples = new List<CsvRowSampleDto>();\n\n            var rowsQuery = _db.CsvRows.AsNoTracking()\n                .Where(r => r.BusinessId == businessId && r.BatchId == batchId)\n                .OrderBy(r => r.RowIndex)\n                .Select(r => new { r.RowIndex, r.DataJson });\n\n            await foreach (var row in rowsQuery.AsAsyncEnumerable().WithCancellation(ct))\n            {\n                var dict = SafeParseDict(row.DataJson);\n                dict.TryGetValue(phoneField, out var rawPhone);\n\n                // var normalized = NormalizePhoneMaybe(rawPhone, request.NormalizePhones);\n                var normalized = NormalizeToE164OrError(rawPhone, out var phoneErr);\n                var isProblem = false;\n\n                if (string.IsNullOrWhiteSpace(normalized))\n                {\n                    // failed normalization → treat as missing/invalid phone\n                    result.MissingPhoneCount++;\n                    isProblem = true;\n                    if (problemSamples.Count < request.SampleSize)\n                    {\n                        // include the error text in the sample row so UI can show why it failed\n                        var dictWithErr = SafeParseDict(row.DataJson);\n                        dictWithErr[\"__phone_error__\"] = phoneErr;\n                        problemSamples.Add(new CsvRowSampleDto { RowIndex = row.RowIndex, Data = dictWithErr });\n                    }\n                }\n                else if (request.Deduplicate && !seenPhones.Add(normalized))\n                {\n                    result.DuplicatePhoneCount++;\n                    isProblem = true;\n                }\n\n                if (isProblem && problemSamples.Count < request.SampleSize)\n                {\n                    problemSamples.Add(new CsvRowSampleDto\n                    {\n                        RowIndex = row.RowIndex,\n                        Data = dict\n                    });\n                }\n            }\n\n            result.ProblemSamples = problemSamples;\n\n            if (result.MissingPhoneCount > 0)\n                result.Errors.Add(\"Some rows are missing phone numbers.\");\n            if (result.DuplicatePhoneCount > 0)\n                result.Warnings.Add(\"Duplicate phone numbers detected (after normalization).\");\n\n            return result;\n        }\n\n        // ----------------------------\n        // helpers\n        // ----------------------------\n        private static List<string> SafeParseHeaderArray(string? json)\n        {\n            try\n            {\n                return string.IsNullOrWhiteSpace(json)\n                    ? new List<string>()\n                    : (JsonSerializer.Deserialize<List<string>>(json) ?? new List<string>());\n            }\n            catch { return new List<string>(); }\n        }\n\n        private static Dictionary<string, string?> SafeParseDict(string? json)\n        {\n            try\n            {\n                return string.IsNullOrWhiteSpace(json)\n                    ? new Dictionary<string, string?>()\n                    : (JsonSerializer.Deserialize<Dictionary<string, string?>>(json) ??\n                       new Dictionary<string, string?>());\n            }\n            catch { return new Dictionary<string, string?>(); }\n        }\n\n        private static char DetectDelimiter(string headerLine)\n        {\n            var candidates = new[] { ',', ';', '\\t' };\n            var counts = candidates.Select(c => (c, count: headerLine.Count(ch => ch == c))).ToList();\n            var best = counts.OrderByDescending(x => x.count).First();\n            return best.count > 0 ? best.c : ',';\n        }\n\n        /// <summary>\n        /// CSV parser with delimiter support: handles commas/semicolons/tabs, double quotes,\n        /// and escaped quotes (\"\"). It does NOT support embedded newlines inside quoted fields.\n        /// </summary>\n        private static List<string> ParseCsvLine(string line, char delimiter)\n        {\n            var result = new List<string>();\n            if (line == null) return result;\n\n            var sb = new StringBuilder();\n            bool inQuotes = false;\n\n            for (int i = 0; i < line.Length; i++)\n            {\n                var c = line[i];\n\n                if (inQuotes)\n                {\n                    if (c == '\"')\n                    {\n                        // Handle escaped quote \"\"\n                        if (i + 1 < line.Length && line[i + 1] == '\"')\n                        {\n                            sb.Append('\"');\n                            i++;\n                        }\n                        else\n                        {\n                            inQuotes = false;\n                        }\n                    }\n                    else\n                    {\n                        sb.Append(c);\n                    }\n                }\n                else\n                {\n                    if (c == delimiter)\n                    {\n                        result.Add(sb.ToString());\n                        sb.Clear();\n                    }\n                    else if (c == '\"')\n                    {\n                        inQuotes = true;\n                    }\n                    else\n                    {\n                        sb.Append(c);\n                    }\n                }\n            }\n\n            result.Add(sb.ToString());\n            return result;\n        }\n\n\n        private static readonly HashSet<string> VALID_CC = new(StringComparer.Ordinal)\n        {\n            // 1-digit\n            \"1\",          // NANP (US/CA)\n            // 2-digit - common targets\n            \"20\",\"27\",\"30\",\"31\",\"32\",\"33\",\"34\",\"36\",\"39\",\"40\",\"41\",\"43\",\"44\",\"45\",\"46\",\"47\",\"48\",\"49\",\n            \"51\",\"52\",\"53\",\"54\",\"55\",\"56\",\"57\",\"58\",\"60\",\"61\",\"62\",\"63\",\"64\",\"65\",\"66\",\n            \"81\",\"82\",\"84\",\"86\",\"90\",\"91\",\"92\",\"93\",\"94\",\"95\",\"98\",\n            // 3-digit - GCC & a few others you likely need\n            \"966\",\"971\"   // SA, AE\n        };\n\n        private static string? NormalizeToE164OrError(string? input, out string error)\n        {\n            error = \"\";\n            if (string.IsNullOrWhiteSpace(input)) { error = \"Empty phone.\"; return null; }\n\n            var s = input.Trim();\n\n            // Case A: already +E.164\n            if (s.StartsWith(\"+\", StringComparison.Ordinal))\n            {\n                if (!IsE164(s)) { error = \"Must be +E.164: '+' followed by 8–15 digits.\"; return null; }\n\n                var noPlus = s.Substring(1);\n                var cc = ExtractCcByLongestPrefix(noPlus);\n                if (string.IsNullOrEmpty(cc)) { error = \"Unsupported country code.\"; return null; }\n\n                // basic NN sanity for a few big markets; keep permissive otherwise\n                var nn = noPlus.Substring(cc.Length);\n                if (!PassesBasicNationalLength(cc, nn)) { error = $\"Invalid national length for +{cc}.\"; return null; }\n\n                return s;\n            }\n\n            // Case B: digits only\n            var digits = new string(s.Where(char.IsDigit).ToArray());\n            if (digits.Length < 11 || digits.Length > 15)\n            { error = \"Include country code (11–15 digits if no '+').\"; return null; }\n\n            var cc2 = ExtractCcByLongestPrefix(digits);\n            if (string.IsNullOrEmpty(cc2))\n            { error = \"Unsupported country code.\"; return null; }\n\n            var nn2 = digits.Substring(cc2.Length);\n            if (!PassesBasicNationalLength(cc2, nn2))\n            { error = $\"Invalid national length for +{cc2}.\"; return null; }\n\n            return \"+\" + digits;\n        }\n\n        private static bool IsE164(string s)\n        {\n            if (s.Length < 9 || s.Length > 16) return false; // '+' + 8..15 digits\n            for (int i = 1; i < s.Length; i++) if (!char.IsDigit(s[i])) return false;\n            return true;\n        }\n\n        private static string ExtractCcByLongestPrefix(string digitsNoPlus)\n        {\n            if (digitsNoPlus.Length >= 3 && VALID_CC.Contains(digitsNoPlus[..3])) return digitsNoPlus[..3];\n            if (digitsNoPlus.Length >= 2 && VALID_CC.Contains(digitsNoPlus[..2])) return digitsNoPlus[..2];\n            if (digitsNoPlus.Length >= 1 && VALID_CC.Contains(digitsNoPlus[..1])) return digitsNoPlus[..1];\n            return \"\";\n        }\n\n\n        // Pragmatic checks for common markets; keep permissive for others (4..12)\n        private static bool PassesBasicNationalLength(string cc, string nn)\n        {\n            if (cc == \"1\") return nn.Length == 10; // NANP\n            if (cc == \"91\") return nn.Length == 10; // India\n            if (cc == \"94\") return nn.Length == 9;  // Sri Lanka\n            if (cc == \"966\") return nn.Length == 9;  // Saudi Arabia\n            return nn.Length >= 4 && nn.Length <= 12;\n        }\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/CsvExportService.cs",
      "sha256": "98366ed493eba2967478ea12bedd43b2d0c3a355667e89f23db3a6dd734554a9",
      "language": "csharp",
      "size": 7057,
      "content": "using System;\nusing System.IO;\nusing System.Linq;\nusing System.Text;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Serilog;\nusing xbytechat.api.Features.CampaignModule.Services;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICsvExportService\n    {\n        Task<byte[]> BuildMaterializedCsvAsync(Guid businessId, Guid campaignId, int limit = 200, CancellationToken ct = default);\n        Task<byte[]> BuildDispatchPlanCsvAsync(Guid businessId, Guid campaignId, int limit = 2000, CancellationToken ct = default);\n    }\n\n    /// <summary>\n    /// Small CSV builder for exporting materialized rows and dispatch plans.\n    /// Uses UTF-8 with BOM for Excel friendliness. Escapes fields per RFC4180.\n    /// </summary>\n    public class CsvExportService : ICsvExportService\n    {\n        private readonly ICampaignMaterializationService _materializer;\n        private readonly ICampaignDispatchPlannerService _planner;\n\n        public CsvExportService(\n            ICampaignMaterializationService materializer,\n            ICampaignDispatchPlannerService planner)\n        {\n            _materializer = materializer;\n            _planner = planner;\n        }\n\n        public async Task<byte[]> BuildMaterializedCsvAsync(Guid businessId, Guid campaignId, int limit = 200, CancellationToken ct = default)\n        {\n            var data = await _materializer.MaterializeAsync(businessId, campaignId, limit, ct);\n\n            // Header is dynamic based on placeholder count and button count.\n            // Columns:\n            // RecipientId,ContactId,Phone,Param1..ParamN,Btn1Text,Btn1Url,...,Warnings,Errors\n            var maxParam = data.PlaceholderCount;\n            var maxButtons = data.Rows.Max(r => r.Buttons.Count);\n\n            var sb = new StringBuilder();\n            using var writer = new StringWriter(sb);\n\n            // Write header\n            writer.Write(\"RecipientId,ContactId,Phone\");\n            for (int i = 1; i <= maxParam; i++) writer.Write($\",Param{i}\");\n            for (int b = 1; b <= maxButtons; b++) writer.Write($\",Btn{b}Text,Btn{b}Url\");\n            writer.Write(\",Warnings,Errors\");\n            writer.WriteLine();\n\n            foreach (var row in data.Rows)\n            {\n                WriteCsv(writer, row.RecipientId?.ToString());\n                writer.Write(\",\");\n                WriteCsv(writer, row.ContactId?.ToString());\n                writer.Write(\",\");\n                WriteCsv(writer, row.Phone);\n\n                // Params 1..N (pad missing)\n                for (int i = 1; i <= maxParam; i++)\n                {\n                    writer.Write(\",\");\n                    var val = row.Parameters.FirstOrDefault(p => p.Index == i)?.Value;\n                    WriteCsv(writer, val);\n                }\n\n                // Buttons (pad missing)\n                for (int b = 0; b < maxButtons; b++)\n                {\n                    var btn = b < row.Buttons.Count ? row.Buttons[b] : null;\n                    writer.Write(\",\");\n                    WriteCsv(writer, btn?.ButtonText);\n                    writer.Write(\",\");\n                    WriteCsv(writer, btn?.ResolvedUrl);\n                }\n\n                writer.Write(\",\");\n                WriteCsv(writer, string.Join(\" | \", row.Warnings));\n                writer.Write(\",\");\n                WriteCsv(writer, string.Join(\" | \", row.Errors));\n                writer.WriteLine();\n            }\n\n            // Return as UTF-8 with BOM for Excel compatibility\n            var utf8withBom = new UTF8Encoding(encoderShouldEmitUTF8Identifier: true);\n            return utf8withBom.GetBytes(sb.ToString());\n        }\n\n        public async Task<byte[]> BuildDispatchPlanCsvAsync(Guid businessId, Guid campaignId, int limit = 2000, CancellationToken ct = default)\n        {\n            var plan = await _planner.PlanAsync(businessId, campaignId, limit, ct);\n\n            var sb = new StringBuilder();\n            using var writer = new StringWriter(sb);\n\n            // Plan metadata preface (comment-style rows start with '#')\n            writer.WriteLine($\"# CampaignId,{plan.CampaignId}\");\n            writer.WriteLine($\"# TemplateName,{Escape(plan.TemplateName)}\");\n            writer.WriteLine($\"# Language,{Escape(plan.Language)}\");\n            writer.WriteLine($\"# PlaceholderCount,{plan.PlaceholderCount}\");\n            writer.WriteLine($\"# TotalRecipients,{plan.TotalRecipients}\");\n            writer.WriteLine($\"# ProviderPlan,{Escape(plan.Throttle.Plan)}\");\n            writer.WriteLine($\"# Provider,{Escape(plan.Throttle.Provider)}\");\n            writer.WriteLine($\"# MaxBatchSize,{plan.Throttle.MaxBatchSize}\");\n            writer.WriteLine($\"# MaxPerMinute,{plan.Throttle.MaxPerMinute}\");\n            writer.WriteLine($\"# ComputedBatches,{plan.Throttle.ComputedBatches}\");\n            writer.WriteLine($\"# EstimatedMinutes,{plan.Throttle.EstimatedMinutes}\");\n            if (plan.GlobalWarnings.Any())\n                writer.WriteLine($\"# GlobalWarnings,{Escape(string.Join(\" | \", plan.GlobalWarnings))}\");\n            if (plan.Throttle.Warnings.Any())\n                writer.WriteLine($\"# ThrottleWarnings,{Escape(string.Join(\" | \", plan.Throttle.Warnings))}\");\n\n            writer.WriteLine(); // blank line\n\n            // Batches table header\n            writer.WriteLine(\"BatchNumber,OffsetSeconds,StartIndex,Count,ApproxBytes,Phones,RecipientIds,Notes\");\n\n            foreach (var b in plan.Batches)\n            {\n                WriteCsv(writer, b.BatchNumber.ToString());\n                writer.Write(\",\");\n                WriteCsv(writer, b.OffsetSeconds.ToString());\n                writer.Write(\",\");\n                WriteCsv(writer, b.StartIndex.ToString());\n                writer.Write(\",\");\n                WriteCsv(writer, b.Count.ToString());\n                writer.Write(\",\");\n                WriteCsv(writer, b.ApproxBytes.ToString());\n                writer.Write(\",\");\n                WriteCsv(writer, string.Join(\" \", b.Phones.Select(p => p ?? \"\")));\n                writer.Write(\",\");\n                WriteCsv(writer, string.Join(\" \", b.RecipientIds.Select(id => id?.ToString() ?? \"\")));\n                writer.Write(\",\");\n                WriteCsv(writer, string.Join(\" | \", b.Notes));\n                writer.WriteLine();\n            }\n\n            var utf8withBom = new UTF8Encoding(encoderShouldEmitUTF8Identifier: true);\n            return utf8withBom.GetBytes(sb.ToString());\n        }\n\n        private static void WriteCsv(TextWriter writer, string? value)\n        {\n            writer.Write(Escape(value ?? \"\"));\n        }\n\n        private static string Escape(string input)\n        {\n            // RFC4180-style: quote if contains comma, quote or newline; escape quotes by doubling\n            var needsQuote = input.Contains(',') || input.Contains('\"') || input.Contains('\\n') || input.Contains('\\r');\n            if (!needsQuote) return input;\n            return $\"\\\"{input.Replace(\"\\\"\", \"\\\"\\\"\")}\\\"\";\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/ICampaignDispatcher.cs",
      "sha256": "7ea08b6385a5f9c2861a417d0ba9ed59f386c613614b462ffbaa53ace5cb56e8",
      "language": "csharp",
      "size": 652,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignDispatcher\n    {\n        /// <summary>\n        /// mode: \"canary\" (use count) or \"full\" (ignore count, select all ready).\n        /// count: when mode=canary, number of recipients to enqueue (default 25).\n        /// </summary>\n        Task<CampaignDispatchResponseDto> DispatchAsync(\n            Guid businessId,\n            Guid campaignId,\n            string mode,\n            int count,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/ICampaignDryRunService.cs",
      "sha256": "8ee4671e2a7d2ac659e127e72121295904129c5d31e82fad35401dc50f10a717",
      "language": "csharp",
      "size": 662,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    /// <summary>\n    /// Validates a campaign for send safety without actually sending any message.\n    /// </summary>\n    public interface ICampaignDryRunService\n    {\n        /// <summary>\n        /// Run dry-run validation for a campaign. Should not mutate state.\n        /// </summary>\n        Task<CampaignDryRunResultDto> ValidateAsync(\n            Guid businessId,\n            Guid campaignId,\n            int limit = 200,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/ICampaignMaterializationService.cs",
      "sha256": "45174c0e9b318f8f145ffd682ecf042a166872989ec0a9637342c3fe47d8fa6d",
      "language": "csharp",
      "size": 358,
      "content": "using xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignMaterializationService\n    {\n        Task<CampaignMaterializeResultDto> MaterializeAsync(\n        Guid businessId,\n        Guid campaignId,\n        int limit = 200,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/ICampaignMaterializer.cs",
      "sha256": "dba2b5d0e2d4d8e08bc87cc00a353a7636cb5dc7f30e4f1af1620c0b1ba69cde",
      "language": "csharp",
      "size": 434,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignMaterializer\n    {\n        Task<CampaignCsvMaterializeResponseDto> CreateAsync(\n       Guid businessId,\n       Guid campaignId,\n       CampaignCsvMaterializeRequestDto request,\n       CancellationToken ct = default);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/ICampaignRecipientService.cs",
      "sha256": "a2bb5bdb9f8a87dc2436bac017a79dc02ec48bdc1fd425cb6c701807234d4dd3",
      "language": "csharp",
      "size": 729,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignRecipientService\n    {\n        Task<CampaignRecipientDto> GetByIdAsync(Guid id);\n        Task<List<CampaignRecipientDto>> GetByCampaignIdAsync(Guid campaignId);\n\n        Task<bool> UpdateStatusAsync(Guid recipientId, string newStatus);\n        Task<bool> TrackReplyAsync(Guid recipientId, string replyText);\n        Task<List<CampaignRecipientDto>> SearchRecipientsAsync(string status = null, string keyword = null);\n\n        Task AssignContactsToCampaignAsync(Guid campaignId, List<Guid> contactIds);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/ICampaignRetryService.cs",
      "sha256": "77b2d8c8b67c691891ba7e6e1b014af847932714edcd60acfd419c092aa3c4bc",
      "language": "csharp",
      "size": 274,
      "content": "using xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignRetryService\n    {\n        Task<CampaignRetryResultDto> RetryFailedAsync(Guid businessId, Guid campaignId, int limit = 200);\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/ICampaignService.cs",
      "sha256": "a0ff4849ee64db1276d3701af80fd3e5ef58f9d22ef9da224e4fd1bc2e4a7829",
      "language": "csharp",
      "size": 2977,
      "content": "using System;\nusing System.Threading.Tasks;\nusing System.Collections.Generic;\nusing xbytechat.api.Features.CampaignModule.DTOs;\nusing xbytechat.api.Shared;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CRM.Dtos;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICampaignService\n    {\n        /// 🆕 Create a new campaign with recipients\n        Task<Guid?> CreateTextCampaignAsync(CampaignCreateDto dto, Guid businessId, string createdBy);\n\n        /// ✏️ Update an existing draft campaign\n        Task<bool> UpdateCampaignAsync(Guid id, CampaignCreateDto dto);\n\n      \n        /// 📋 Get all campaigns for the business\n        Task<List<CampaignSummaryDto>> GetAllCampaignsAsync(Guid businessId);\n\n        /// 📄 Get paginated campaigns\n        Task<PaginatedResponse<CampaignSummaryDto>> GetPaginatedCampaignsAsync(Guid businessId, PaginatedRequest request);\n        /// 🚀 Trigger campaign send flow (template message to all recipients)\n        Task<bool> SendCampaignAsync(Guid campaignId, string ipAddress, string userAgent);\n        Task<Guid> CreateImageCampaignAsync(Guid businessId, CampaignCreateDto dto, string createdBy);\n        Task<List<CampaignSummaryDto>> GetAllCampaignsAsync(Guid businessId, string? type = null);\n        Task<List<ContactDto>> GetRecipientsByCampaignIdAsync(Guid campaignId, Guid businessId);\n        Task<bool> RemoveRecipientAsync(Guid businessId, Guid campaignId, Guid contactId);\n        Task<CampaignDto?> GetCampaignByIdAsync(Guid campaignId, Guid businessId);\n        Task<bool> AssignContactsToCampaignAsync(Guid campaignId, Guid businessId, List<Guid> contactIds);\n\n        Task<ResponseResult> SendTemplateCampaignAsync(Guid campaignId);\n\n        Task<ResponseResult> SendTemplateCampaignWithTypeDetectionAsync(Guid campaignId, CancellationToken ct = default);\n\n        Task<ResponseResult> SendTextTemplateCampaignAsync(Campaign campaign);\n        Task<ResponseResult> SendImageTemplateCampaignAsync(Campaign campaign);\n\n        Task<List<FlowListItemDto>> GetAvailableFlowsAsync(Guid businessId, bool onlyPublished = true);\n\n        Task<CampaignDryRunResponseDto> DryRunTemplateCampaignAsync(Guid campaignId, int maxRecipients = 20);\n        Task<object> SendVideoTemplateMessageAsync(VideoTemplateMessageDto dto, Guid businessId);\n\n        Task<bool> CheckNameAvailableAsync(Guid businessId, string name);\n        Task RescheduleAsync(Guid businessId, Guid campaignId, DateTime newUtcTime);\n        Task EnqueueNowAsync(Guid businessId, Guid campaignId);\n        Task CancelScheduleAsync(Guid businessId, Guid campaignId);\n        Task<CampaignDeletionResult> DeleteCampaignAsync(\n            Guid businessId,\n            Guid id,\n            CampaignDeletionOptions options,\n            CancellationToken ct = default);\n        Task<CampaignUsageDto?> GetCampaignUsageAsync(Guid businessId, Guid campaignId);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/ICsvBatchService.cs",
      "sha256": "354a34ab57d057ccd0d3fade616e9e149d7e6a5c697c3d81a1d0347999f14d6f",
      "language": "csharp",
      "size": 1601,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignModule.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface ICsvBatchService\n    {\n        //Task<CsvBatchUploadResultDto> CreateAndIngestAsync(\n        //    Guid businessId,\n        //    string fileName,\n        //    Stream stream,\n        //    Guid? audienceId = null,\n        //    CancellationToken ct = default\n        //);\n    \n            Task<CsvBatchUploadResultDto> CreateAndIngestAsync(\n                Guid businessId,\n                string fileName,\n                Stream stream,\n                Guid? audienceId = null,\n                Guid? campaignId = null,\n                CancellationToken ct = default);\n      \n\n        Task<CsvBatchInfoDto?> GetBatchAsync(Guid businessId, Guid batchId, CancellationToken ct = default);\n        Task<IReadOnlyList<CsvRowSampleDto>> GetSamplesAsync(Guid businessId, Guid batchId, int take = 20, CancellationToken ct = default);\n        Task<CsvBatchValidationResultDto> ValidateAsync(Guid businessId, Guid batchId, CsvBatchValidationRequestDto request, CancellationToken ct = default);\n        Task<List<CsvBatchListItemDto>> ListBatchesAsync(Guid businessId, int limit = 20, CancellationToken ct = default);\n        Task<CsvBatchRowsPageDto> GetRowsPageAsync(Guid businessId, Guid batchId, int skip, int take, CancellationToken ct = default);\n        Task<bool> DeleteBatchAsync(Guid businessId, Guid batchId, CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/IMappingSuggestionService.cs",
      "sha256": "010ea9f12699609fa3addd18141bfba7bcf3ec585a43200b86cf3a2f8f0ef038",
      "language": "csharp",
      "size": 641,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    /// <summary>\n    /// Suggests a token->source mapping (\"csv:Header\" or \"static:\") given a campaign and CSV batch.\n    /// Uses Campaign.TemplateParameters if present; otherwise derives tokens from CSV headers.\n    /// </summary>\n    public interface IMappingSuggestionService\n    {\n        Task<Dictionary<string, string>> SuggestAsync(\n            Guid businessId,\n            Guid campaignId,\n            Guid batchId,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/Interface.cs",
      "sha256": "b499bed78d394052736ab9f463d1f5737462a52f755329e27050b2f72a1b846c",
      "language": "csharp",
      "size": 104,
      "content": "namespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface Interface\n    {\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/IOutboundCampaignQueueService.cs",
      "sha256": "a085fb2166af4a18a8f3499aa61280313e0c0dbd358fbaa54eb9562e8337fc80",
      "language": "csharp",
      "size": 1044,
      "content": "using System;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.Queueing.DTOs;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public interface IOutboundCampaignQueueService\n    {\n        Task<Guid> EnqueueAsync(Guid businessId, Guid campaignId, bool forceDuplicate = false);\n        Task<bool> MarkSucceededAsync(Guid jobId);\n        Task<bool> MarkFailedAsync(Guid jobId, string error, bool scheduleRetry = true);\n\n        Task<List<OutboundCampaignJob>> GetJobsForCampaignAsync(Guid businessId, Guid campaignId);\n        Task<OutboundCampaignJob?> GetActiveJobForCampaignAsync(Guid businessId, Guid campaignId);\n        Task<bool> CancelAsync(Guid businessId, Guid jobId);     // set to \"canceled\" (if queued/running)\n        Task<bool> ForceRetryNowAsync(Guid businessId, Guid jobId); // set to \"queued\", NextAttemptAt=now (no attempt++)\n        Task<int> EnqueueBulkAsync(IEnumerable<OutboundCampaignJobCreateDto> jobs, CancellationToken ct = default);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/IVariableMappingService.cs",
      "sha256": "dcf57112809de6e4dc9c3b7957cc9d591c65cace2d51cd24fc0795b6b12b8c5a",
      "language": "csharp",
      "size": 992,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    /// <summary>\n    /// Loads saved variable mappings for a campaign (e.g., token -> CSV header or \"constant:...\").\n    /// Current project does not require this to complete 2.4; this is a seam for future use.\n    /// </summary>\n    public interface IVariableMappingService\n    {\n        /// <returns>\n        /// Dictionary mapping variable token -> source (CSV header name or \"constant:Value\").\n        /// Return an empty dictionary when nothing is saved.\n        /// </returns>\n        Task<Dictionary<string, string>> GetForCampaignAsync(\n            Guid businessId,\n            Guid campaignId,\n            CancellationToken ct = default);\n        Task SaveAsync(\n           Guid businessId,\n           Guid campaignId,\n           Dictionary<string, string> mappings,\n           CancellationToken ct = default);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/MappingSuggestionService.cs",
      "sha256": "e6a82a860c5406f0e22ef3c89577a8c06081e49d21add5f9bc6682c0dc974dd3",
      "language": "csharp",
      "size": 5965,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.Json;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    /// <summary>\n    /// Heuristics:\n    /// - If Campaign.TemplateParameters is a JSON array of tokens, suggest for those tokens.\n    /// - Else, derive tokens by normalizing CSV headers (lowercase, alnum only, '_' joined).\n    /// - Match by normalized equality/contains; special-case phone names.\n    /// - Unmatched tokens get \"static:\" so UI shows a clear placeholder.\n    /// </summary>\n    public sealed class MappingSuggestionService : IMappingSuggestionService\n    {\n        private readonly AppDbContext _db;\n\n        private static readonly string[] PhoneHeaderCandidates =\n        {\n            \"phone\", \"mobile\", \"whatsapp\", \"msisdn\", \"whatsapp_number\", \"contact\", \"contact_number\"\n        };\n\n        public MappingSuggestionService(AppDbContext db) => _db = db;\n\n        public async Task<Dictionary<string, string>> SuggestAsync(\n            Guid businessId,\n            Guid campaignId,\n            Guid batchId,\n            CancellationToken ct = default)\n        {\n            // Load campaign to read TemplateParameters (if present)\n            var campaign = await _db.Campaigns.AsNoTracking()\n                .Where(c => c.Id == campaignId && c.BusinessId == businessId)\n                .Select(c => new { c.Id, c.BusinessId, c.TemplateParameters })\n                .FirstOrDefaultAsync(ct);\n\n            if (campaign == null) throw new KeyNotFoundException(\"Campaign not found.\");\n\n            // Load batch headers\n            var batch = await _db.CsvBatches.AsNoTracking()\n                .Where(b => b.Id == batchId && b.BusinessId == businessId)\n                .Select(b => new { b.HeadersJson })\n                .FirstOrDefaultAsync(ct);\n\n            if (batch == null) throw new KeyNotFoundException(\"CSV batch not found.\");\n\n            var headers = ParseHeaders(batch.HeadersJson);\n            var normHeaders = headers.ToDictionary(h => Normalize(h), h => h, StringComparer.OrdinalIgnoreCase);\n\n            // Determine tokens\n            var tokens = ParseTemplateTokens(campaign.TemplateParameters);\n            if (tokens.Count == 0)\n            {\n                // Fall back: derive tokens directly from headers\n                tokens = headers.Select(Normalize).Where(s => !string.IsNullOrWhiteSpace(s)).Distinct(StringComparer.OrdinalIgnoreCase).ToList();\n            }\n\n            // Suggestion: token -> source\n            var suggestions = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);\n\n            foreach (var token in tokens)\n            {\n                var normToken = Normalize(token);\n\n                // 1) direct equality with header\n                if (normHeaders.TryGetValue(normToken, out var exactHeader))\n                {\n                    suggestions[token] = $\"csv:{exactHeader}\";\n                    continue;\n                }\n\n                // 2) phone special-case\n                if (IsPhoneToken(normToken))\n                {\n                    var headerPick = headers.FirstOrDefault(h => PhoneHeaderCandidates.Contains(Normalize(h)));\n                    if (!string.IsNullOrEmpty(headerPick))\n                    {\n                        suggestions[token] = $\"csv:{headerPick}\";\n                        continue;\n                    }\n                }\n\n                // 3) contains / fuzzy-lite\n                var contains = headers.FirstOrDefault(h => Normalize(h).Contains(normToken, StringComparison.OrdinalIgnoreCase));\n                if (!string.IsNullOrEmpty(contains))\n                {\n                    suggestions[token] = $\"csv:{contains}\";\n                    continue;\n                }\n\n                // 4) default: static placeholder (UI can highlight to user)\n                suggestions[token] = \"static:\";\n            }\n\n            return suggestions;\n        }\n\n        private static List<string> ParseHeaders(string? headersJson)\n        {\n            if (string.IsNullOrWhiteSpace(headersJson)) return new List<string>();\n            try\n            {\n                var arr = JsonSerializer.Deserialize<List<string>>(headersJson);\n                return arr?.Where(h => !string.IsNullOrWhiteSpace(h)).ToList() ?? new List<string>();\n            }\n            catch\n            {\n                // Fallback: maybe comma-separated\n                return headersJson.Split(',').Select(s => s.Trim()).Where(s => s.Length > 0).ToList();\n            }\n        }\n\n        private static List<string> ParseTemplateTokens(string? templateParametersJson)\n        {\n            if (string.IsNullOrWhiteSpace(templateParametersJson)) return new List<string>();\n            try\n            {\n                var arr = JsonSerializer.Deserialize<List<string>>(templateParametersJson);\n                return arr?.Where(t => !string.IsNullOrWhiteSpace(t)).ToList() ?? new List<string>();\n            }\n            catch\n            {\n                return new List<string>();\n            }\n        }\n\n        private static bool IsPhoneToken(string normToken)\n        {\n            if (string.IsNullOrWhiteSpace(normToken)) return false;\n            if (PhoneHeaderCandidates.Contains(normToken)) return true;\n            return normToken.Contains(\"phone\") || normToken.Contains(\"mobile\") || normToken.Contains(\"whatsapp\");\n        }\n\n        private static string Normalize(string s)\n        {\n            var lowered = (s ?? \"\").Trim().ToLowerInvariant();\n            if (lowered.Length == 0) return lowered;\n            var alnum = Regex.Replace(lowered, @\"[^a-z0-9]+\", \"_\");\n            alnum = Regex.Replace(alnum, \"_{2,}\", \"_\").Trim('_');\n            return alnum;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/NoopVariableMappingService.cs",
      "sha256": "24a343d03f2ab867121a8ebfe09ebcf7672fb7a3261095b6dc2322633e1ae722",
      "language": "csharp",
      "size": 984,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    /// <summary>\n    /// Default stub: returns no saved mappings.\n    /// Swap this out later with a DB-backed implementation that reads CampaignVariableMap.\n    /// </summary>\n    public sealed class NoopVariableMappingService : IVariableMappingService\n    {\n        public Task<Dictionary<string, string>> GetForCampaignAsync(\n            Guid businessId,\n            Guid campaignId,\n            CancellationToken ct = default)\n        {\n            return Task.FromResult(new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase));\n        }\n\n        public Task SaveAsync(\n           Guid businessId,\n           Guid campaignId,\n           Dictionary<string, string> mappings,\n           CancellationToken ct = default)\n        {\n            // no-op\n            return Task.CompletedTask;\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/OutboundCampaignQueueService.cs",
      "sha256": "b81f57bff9d0409d1f72e2347814800b56d2a94f6696ce7a5ae1500b38c9648b",
      "language": "csharp",
      "size": 8110,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;                       // <-- add\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.Queueing.DTOs;    // <-- add for OutboundCampaignJobCreateDto\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    public class OutboundCampaignQueueService : IOutboundCampaignQueueService\n    {\n        private readonly AppDbContext _db;\n        private readonly ILogger<OutboundCampaignQueueService> _log;\n\n        public OutboundCampaignQueueService(AppDbContext db, ILogger<OutboundCampaignQueueService> log)\n        {\n            _db = db; _log = log;\n        }\n\n        public async Task<Guid> EnqueueAsync(Guid businessId, Guid campaignId, bool forceDuplicate = false)\n        {\n            if (!forceDuplicate)\n            {\n                var existing = await _db.OutboundCampaignJobs\n                    .Where(j => j.CampaignId == campaignId && (j.Status == \"queued\" || j.Status == \"running\"))\n                    .OrderByDescending(j => j.CreatedAt)\n                    .FirstOrDefaultAsync();\n\n                if (existing != null)\n                {\n                    var found = await _db.Campaigns\n                        .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n\n                    if (found != null && found.Status != \"Queued\")\n                    {\n                        found.Status = \"Queued\";\n                        found.UpdatedAt = DateTime.UtcNow;\n                        await _db.SaveChangesAsync();\n                    }\n\n                    _log.LogInformation(\"Campaign {CampaignId} already queued/running. Job={JobId}\", campaignId, existing.Id);\n                    return existing.Id;\n                }\n            }\n\n            var job = new OutboundCampaignJob\n            {\n                BusinessId = businessId,\n                CampaignId = campaignId,\n                Status = \"queued\",\n                Attempt = 0,\n                MaxAttempts = 5,\n                NextAttemptAt = DateTimeOffset.UtcNow\n            };\n\n            _db.OutboundCampaignJobs.Add(job);\n\n            var row = await _db.Campaigns\n                .FirstOrDefaultAsync(c => c.Id == campaignId && c.BusinessId == businessId);\n\n            if (row != null)\n            {\n                row.Status = \"Queued\";\n                row.UpdatedAt = DateTime.UtcNow;\n            }\n\n            await _db.SaveChangesAsync();\n            return job.Id;\n        }\n\n        public async Task<bool> MarkSucceededAsync(Guid jobId)\n        {\n            var j = await _db.OutboundCampaignJobs.FindAsync(jobId);\n            if (j == null) return false;\n\n            j.Attempt += 1;\n            j.Status = \"succeeded\";\n            j.UpdatedAt = DateTime.UtcNow;\n\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> MarkFailedAsync(Guid jobId, string error, bool scheduleRetry = true)\n        {\n            var j = await _db.OutboundCampaignJobs.FindAsync(jobId);\n            if (j == null) return false;\n\n            j.Attempt += 1;\n            j.LastError = Truncate(error, 3900);\n            j.UpdatedAt = DateTime.UtcNow;\n\n            if (!scheduleRetry || j.Attempt >= j.MaxAttempts)\n            {\n                j.Status = \"failed\";\n            }\n            else\n            {\n                var backoff = j.Attempt switch\n                {\n                    1 => TimeSpan.FromMinutes(1),\n                    2 => TimeSpan.FromMinutes(5),\n                    3 => TimeSpan.FromMinutes(15),\n                    4 => TimeSpan.FromMinutes(60),\n                    _ => TimeSpan.FromMinutes(180)\n                };\n                j.Status = \"queued\";\n                j.NextAttemptAt = DateTimeOffset.UtcNow.Add(backoff);\n            }\n\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<List<OutboundCampaignJob>> GetJobsForCampaignAsync(Guid businessId, Guid campaignId)\n        {\n            return await _db.OutboundCampaignJobs\n                .Where(j => j.BusinessId == businessId && j.CampaignId == campaignId)\n                .OrderByDescending(j => j.CreatedAt)\n                .ToListAsync();\n        }\n\n        public async Task<OutboundCampaignJob?> GetActiveJobForCampaignAsync(Guid businessId, Guid campaignId)\n        {\n            return await _db.OutboundCampaignJobs\n                .Where(j => j.BusinessId == businessId && j.CampaignId == campaignId &&\n                            (j.Status == \"queued\" || j.Status == \"running\"))\n                .OrderBy(j => j.CreatedAt)\n                .FirstOrDefaultAsync();\n        }\n\n        public async Task<bool> CancelAsync(Guid businessId, Guid jobId)\n        {\n            var j = await _db.OutboundCampaignJobs.FirstOrDefaultAsync(x => x.Id == jobId && x.BusinessId == businessId);\n            if (j == null) return false;\n\n            if (j.Status == \"queued\" || j.Status == \"running\")\n            {\n                j.Status = \"canceled\";\n                j.UpdatedAt = DateTime.UtcNow;\n                await _db.SaveChangesAsync();\n\n                var campaign = await _db.Campaigns.FirstOrDefaultAsync(c => c.Id == j.CampaignId && c.BusinessId == businessId);\n                if (campaign != null)\n                {\n                    var hasActive = await _db.OutboundCampaignJobs.AnyAsync(x =>\n                        x.CampaignId == j.CampaignId &&\n                        x.BusinessId == businessId &&\n                        (x.Status == \"queued\" || x.Status == \"running\"));\n\n                    if (!hasActive && (campaign.Status == \"Queued\" || campaign.Status == \"Sending\"))\n                    {\n                        campaign.Status = \"Draft\";\n                        campaign.UpdatedAt = DateTime.UtcNow;\n                        await _db.SaveChangesAsync();\n                    }\n                }\n                return true;\n            }\n            return false;\n        }\n\n        public async Task<bool> ForceRetryNowAsync(Guid businessId, Guid jobId)\n        {\n            var j = await _db.OutboundCampaignJobs.FirstOrDefaultAsync(x => x.Id == jobId && x.BusinessId == businessId);\n            if (j == null) return false;\n\n            j.Status = \"queued\";\n            j.NextAttemptAt = DateTimeOffset.UtcNow;\n            j.UpdatedAt = DateTime.UtcNow;\n\n            var campaign = await _db.Campaigns.FirstOrDefaultAsync(c => c.Id == j.CampaignId && c.BusinessId == businessId);\n            if (campaign != null && campaign.Status != \"Queued\")\n            {\n                campaign.Status = \"Queued\";\n                campaign.UpdatedAt = DateTime.UtcNow;\n            }\n\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        // NEW: bulk enqueue used by CampaignDispatcher\n        public Task<int> EnqueueBulkAsync(IEnumerable<OutboundCampaignJobCreateDto> jobs, CancellationToken ct = default)\n        {\n            // For now, just log & return a deduped count. Replace with real queue later.\n            var list = (jobs ?? Enumerable.Empty<OutboundCampaignJobCreateDto>()).ToList();\n\n            // Deduplicate by provided IdempotencyKey (or fallback to a stable composite)\n            var enqueuedCount = list\n                .GroupBy(j => string.IsNullOrWhiteSpace(j.IdempotencyKey)\n                                ? $\"{j.CampaignId}:{j.CampaignRecipientId}\"\n                                : j.IdempotencyKey)\n                .Count();\n\n            _log.LogInformation(\"Bulk enqueue requested: {Requested} jobs, deduped to {Enqueued}\",\n                list.Count, enqueuedCount);\n\n            // TODO: push to a real queue/bus and persist queue records as needed.\n            return Task.FromResult(enqueuedCount);\n        }\n\n        private static string Truncate(string s, int max) =>\n            string.IsNullOrEmpty(s) ? s : (s.Length <= max ? s : s.Substring(0, max));\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Services/OutboundCampaignSendWorker.cs",
      "sha256": "87b84f4ac6b994c6b307f46968b63be7090fa022a3681ae696e01ae348432261",
      "language": "csharp",
      "size": 13092,
      "content": "using System;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.DependencyInjection;\nusing Microsoft.Extensions.Hosting;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.Services;\n\nnamespace xbytechat.api.Features.CampaignModule.Services\n{\n    /// <summary>\n    /// Claims due OutboundCampaignJobs and invokes the campaign sender.\n    /// Uses ExecuteUpdateAsync to flip Campaign.Status without tracking entities,\n    /// eliminating \"already being tracked\" conflicts.\n    /// </summary>\n    public class OutboundCampaignSendWorker : BackgroundService\n    {\n        private readonly IServiceProvider _sp;\n        private readonly ILogger<OutboundCampaignSendWorker> _log;\n\n        // Global cap & polling cadence\n        private const int MaxParallel = 3;\n        private static readonly TimeSpan SweepEvery = TimeSpan.FromSeconds(10);\n\n        public OutboundCampaignSendWorker(IServiceProvider sp, ILogger<OutboundCampaignSendWorker> log)\n        {\n            _sp = sp;\n            _log = log;\n        }\n\n        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n        {\n            // small warm-up delay\n            await Task.Delay(TimeSpan.FromSeconds(5), stoppingToken);\n\n            while (!stoppingToken.IsCancellationRequested)\n            {\n                try\n                {\n                    using var scope = _sp.CreateScope();\n                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n\n                    var now = DateTime.UtcNow;\n\n                    // Find up to MaxParallel due jobs\n                    var due = await db.OutboundCampaignJobs\n                        .Where(j => j.Status == \"queued\" && j.NextAttemptAt <= now)\n                        .OrderBy(j => j.NextAttemptAt)\n                        .ThenBy(j => j.CreatedAt)\n                        .Take(MaxParallel)\n                        .ToListAsync(stoppingToken);\n\n                    // Claim jobs (do NOT increment Attempt here)\n                    foreach (var job in due)\n                    {\n                        job.Status = \"running\";\n                        job.UpdatedAt = DateTime.UtcNow;\n                    }\n\n                    if (due.Count > 0)\n                        await db.SaveChangesAsync(stoppingToken);\n\n                    // Process in parallel within this sweep\n                    var tasks = due.Select(job => ProcessJobAsync(job.Id, stoppingToken)).ToArray();\n                    await Task.WhenAll(tasks);\n                }\n                catch (Exception ex)\n                {\n                    _log.LogWarning(ex, \"Send queue sweep failed\");\n                }\n\n                await Task.Delay(SweepEvery, stoppingToken);\n            }\n        }\n\n        private async Task ProcessJobAsync(Guid jobId, CancellationToken ct)\n        {\n            using var scope = _sp.CreateScope();\n            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n            var queue = scope.ServiceProvider.GetRequiredService<IOutboundCampaignQueueService>();\n            var campaignService = scope.ServiceProvider.GetRequiredService<ICampaignService>();\n            var log = scope.ServiceProvider.GetRequiredService<ILogger<OutboundCampaignSendWorker>>();\n\n            var job = await db.OutboundCampaignJobs.FirstOrDefaultAsync(j => j.Id == jobId, ct);\n            if (job == null) return;\n\n            // Flip to \"Sending\" (no entity tracked)\n            await db.Campaigns\n                .Where(c => c.Id == job.CampaignId && c.BusinessId == job.BusinessId && c.Status != \"Sending\")\n                .ExecuteUpdateAsync(s => s\n                    .SetProperty(c => c.Status, _ => \"Sending\")\n                    .SetProperty(c => c.UpdatedAt, _ => DateTime.UtcNow),\n                    ct);\n\n            try\n            {\n                // Call by ID only – service manages its own DbContext/queries\n                var result = await campaignService.SendTemplateCampaignWithTypeDetectionAsync(job.CampaignId);\n\n                if (result.Success)\n                {\n                    await db.Campaigns\n                        .Where(c => c.Id == job.CampaignId && c.BusinessId == job.BusinessId)\n                        .ExecuteUpdateAsync(s => s\n                            .SetProperty(c => c.Status, _ => \"Sent\")\n                            .SetProperty(c => c.UpdatedAt, _ => DateTime.UtcNow),\n                            ct);\n\n                    await queue.MarkSucceededAsync(job.Id);\n                    log.LogInformation(\"Job {Job} succeeded for campaign {Campaign}\", jobId, job.CampaignId);\n                }\n                else\n                {\n                    var willRetry = job.Attempt + 1 < job.MaxAttempts;\n                    var nextStatus = willRetry ? \"Queued\" : \"Failed\";\n\n                    await db.Campaigns\n                        .Where(c => c.Id == job.CampaignId && c.BusinessId == job.BusinessId)\n                        .ExecuteUpdateAsync(s => s\n                            .SetProperty(c => c.Status, _ => nextStatus)\n                            .SetProperty(c => c.UpdatedAt, _ => DateTime.UtcNow),\n                            ct);\n\n                    await queue.MarkFailedAsync(job.Id, result.Message ?? \"Unknown send error\", scheduleRetry: true);\n                    log.LogWarning(\"Job {Job} failed for campaign {Campaign}: {Msg}\", jobId, job.CampaignId, result.Message);\n                }\n            }\n            catch (Exception ex)\n            {\n                var willRetry = job.Attempt + 1 < job.MaxAttempts;\n                var nextStatus = willRetry ? \"Queued\" : \"Failed\";\n\n                await db.Campaigns\n                    .Where(c => c.Id == job.CampaignId && c.BusinessId == job.BusinessId)\n                    .ExecuteUpdateAsync(s => s\n                        .SetProperty(c => c.Status, _ => nextStatus)\n                        .SetProperty(c => c.UpdatedAt, _ => DateTime.UtcNow),\n                        ct);\n\n                await queue.MarkFailedAsync(job.Id, ex.ToString(), scheduleRetry: true);\n                log.LogWarning(ex, \"Job {Job} exception for campaign {Campaign}\", jobId, job.CampaignId);\n            }\n        }\n    }\n}\n\n\n//////using System;\n//////using System.Linq;\n//////using System.Threading;\n//////using System.Threading.Tasks;\n//////using Microsoft.EntityFrameworkCore;\n//////using Microsoft.Extensions.DependencyInjection;\n//////using Microsoft.Extensions.Hosting;\n//////using Microsoft.Extensions.Logging;\n//////using xbytechat.api;\n//////using xbytechat.api.Features.CampaignModule.Services;\n\n//////namespace xbytechat.api.Features.CampaignModule.Services\n//////{\n//////    /// <summary>\n//////    /// Background worker that claims due jobs and invokes CampaignService to send.\n//////    /// Flips Campaign.Status for truthful UI: Queued -> Sending -> Sent / Queued / Failed\n//////    /// </summary>\n//////    public class OutboundCampaignSendWorker : BackgroundService\n//////    {\n//////        private readonly IServiceProvider _sp;\n//////        private readonly ILogger<OutboundCampaignSendWorker> _log;\n\n//////        // Simple global concurrency cap & polling cadence\n//////        private const int MaxParallel = 3;\n//////        private static readonly TimeSpan SweepEvery = TimeSpan.FromSeconds(10);\n//////        private readonly IDbContextFactory<AppDbContext> _dbFactory;\n\n//////        public OutboundCampaignSendWorker(IServiceProvider sp, ILogger<OutboundCampaignSendWorker> log, IDbContextFactory<AppDbContext> dbFactory)\n//////        {\n//////            _sp = sp; _log = log;\n//////            _dbFactory = dbFactory;\n//////        }\n\n//////        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n//////        {\n//////            await Task.Delay(TimeSpan.FromSeconds(5), stoppingToken);\n\n//////            while (!stoppingToken.IsCancellationRequested)\n//////            {\n//////                try\n//////                {\n//////                    using var scope = _sp.CreateScope();\n//////                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n\n//////                    var now = DateTimeOffset.UtcNow;\n\n//////                    // Find up to MaxParallel due jobs\n//////                    var due = await db.OutboundCampaignJobs\n//////                        .Where(j => j.Status == \"queued\" && j.NextAttemptAt <= now)\n//////                        .OrderBy(j => j.NextAttemptAt)\n//////                        .ThenBy(j => j.CreatedAt)\n//////                        .Take(MaxParallel)\n//////                        .ToListAsync(stoppingToken);\n\n//////                    // Claim jobs (do NOT increment Attempt here)\n//////                    foreach (var job in due)\n//////                    {\n//////                        job.Status = \"running\";\n//////                        job.UpdatedAt = DateTime.UtcNow;\n//////                    }\n//////                    if (due.Count > 0)\n//////                        await db.SaveChangesAsync(stoppingToken);\n\n//////                    var tasks = due.Select(job => ProcessJobAsync(job.Id, stoppingToken)).ToArray();\n//////                    await Task.WhenAll(tasks);\n//////                }\n//////                catch (Exception ex)\n//////                {\n//////                    _log.LogWarning(ex, \"Send queue sweep failed\");\n//////                }\n\n//////                await Task.Delay(SweepEvery, stoppingToken);\n//////            }\n//////        }\n\n//////        private async Task ProcessJobAsync(Guid jobId, CancellationToken ct)\n//////        {\n//////            using var scope = _sp.CreateScope();\n//////            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n//////            var queue = scope.ServiceProvider.GetRequiredService<IOutboundCampaignQueueService>();\n//////            var campaignService = scope.ServiceProvider.GetRequiredService<ICampaignService>();\n//////            var log = scope.ServiceProvider.GetRequiredService<ILogger<OutboundCampaignSendWorker>>();\n\n//////            var job = await db.OutboundCampaignJobs.FirstOrDefaultAsync(j => j.Id == jobId, ct);\n//////            if (job == null) return;\n\n//////            // Mark Campaign -> Sending\n//////            var campaign = await db.Campaigns\n//////                .FirstOrDefaultAsync(c => c.Id == job.CampaignId && c.BusinessId == job.BusinessId, ct);\n\n//////            if (campaign != null && campaign.Status != \"Sending\")\n//////            {\n//////                campaign.Status = \"Sending\";\n//////                campaign.UpdatedAt = DateTime.UtcNow;\n//////                await db.SaveChangesAsync(ct);\n//////            }\n\n//////            try\n//////            {\n//////                var result = await campaignService.SendTemplateCampaignWithTypeDetectionAsync(job.CampaignId);\n\n//////                if (result.Success)\n//////                {\n//////                    if (campaign != null)\n//////                    {\n//////                        campaign.Status = \"Sent\";\n//////                        campaign.UpdatedAt = DateTime.UtcNow;\n//////                        await db.SaveChangesAsync(ct);\n//////                    }\n\n//////                    await queue.MarkSucceededAsync(job.Id);\n//////                    log.LogInformation(\"Job {Job} succeeded for campaign {Campaign}\", jobId, job.CampaignId);\n//////                }\n//////                else\n//////                {\n//////                    // Compute whether we will retry BEFORE calling MarkFailed (Attempt not yet incremented)\n//////                    var willRetry = job.Attempt + 1 < job.MaxAttempts;\n\n//////                    if (campaign != null)\n//////                    {\n//////                        campaign.Status = willRetry ? \"Queued\" : \"Failed\";\n//////                        campaign.UpdatedAt = DateTime.UtcNow;\n//////                        await db.SaveChangesAsync(ct);\n//////                    }\n\n//////                    await queue.MarkFailedAsync(job.Id, result.Message ?? \"Unknown send error\", scheduleRetry: true);\n//////                    log.LogWarning(\"Job {Job} failed for campaign {Campaign}: {Msg}\", jobId, job.CampaignId, result.Message);\n//////                }\n//////            }\n//////            catch (Exception ex)\n//////            {\n//////                var willRetry = job.Attempt + 1 < job.MaxAttempts;\n\n//////                if (campaign != null)\n//////                {\n//////                    campaign.Status = willRetry ? \"Queued\" : \"Failed\";\n//////                    campaign.UpdatedAt = DateTime.UtcNow;\n//////                    await db.SaveChangesAsync(ct);\n//////                }\n\n//////                await queue.MarkFailedAsync(job.Id, ex.ToString(), scheduleRetry: true);\n//////                log.LogWarning(ex, \"Job {Job} exception for campaign {Campaign}\", jobId, job.CampaignId);\n//////            }\n//////        }\n//////    }\n//////}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Workers/OutboundSenderWorker.cs",
      "sha256": "74e4df795d756850a50bdf962865fd3ff0b38fa2cd0e5ba71aa402aa94a6a6de",
      "language": "csharp",
      "size": 63230,
      "content": "// 📄 File: Features/CampaignModule/Workers/OutboundSenderWorker.cs\nusing System;\nusing System.Collections.Concurrent;\nusing System.Collections.Generic;\nusing System.Diagnostics;\nusing System.Linq;\nusing System.Text.Json;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Channels;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.DependencyInjection;\nusing Microsoft.Extensions.Hosting;\nusing Microsoft.Extensions.Logging;\nusing Npgsql;\n\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CampaignTracking.Logging;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.MessageLogging.Services;\nusing xbytechat.api.Features.MessagesEngine.Abstractions;\nusing xbytechat.api.Features.CampaignModule.SendEngine;\nusing xbytechat_api.Features.Billing.Services;\nusing xbytechat.api.Infrastructure.Observability;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.WhatsAppSettings.Helpers;\nusing xbytechat.api.AuthModule.Models;\n\nnamespace xbytechat.api.Features.CampaignModule.Workers\n{\n    public class OutboundSenderWorker : BackgroundService\n    {\n        private readonly IServiceProvider _sp;\n        private readonly ILogger<OutboundSenderWorker> _log;\n        private readonly Channel<OutboundMessageJob> _channel;\n        private const int DEFAULT_MAX_ATTEMPTS = 3;\n\n        // Concurrency caps\n        private readonly int _globalDop = 32;   // total parallel consumers\n        private readonly int _perNumberDop = 8; // per (provider, PhoneNumberId)\n\n        private readonly TimeSpan _pollInterval = TimeSpan.FromMilliseconds(250);\n        private static readonly TimeSpan _flightTimeout = TimeSpan.FromMinutes(5);\n\n        private int _inChannel;\n        private readonly Random _rand = new();\n\n        // =========================[ Template Button Cache + Parsers ]=========================\n        private static readonly ConcurrentDictionary<string, IReadOnlyList<ButtonMeta>> _btnCache =\n            new(StringComparer.Ordinal);\n\n        private static readonly Regex RxButtonTypeMeta = new(@\"^\\s*url\\s*$\", RegexOptions.IgnoreCase | RegexOptions.Compiled);\n        private static readonly Regex RxButtonTypePinn = new(@\"^\\s*url\\s*$\", RegexOptions.IgnoreCase | RegexOptions.Compiled);\n\n        private static string CacheKeyForTemplate(WhatsAppTemplate tpl)\n            => $\"{tpl.BusinessId}|{tpl.Provider}|{tpl.Name}|{tpl.LanguageCode}\".ToUpperInvariant();\n\n        private static IReadOnlyList<ButtonMeta> GetTemplateButtonsCached(WhatsAppTemplate tpl)\n            => _btnCache.GetOrAdd(CacheKeyForTemplate(tpl), _ => ParseButtonsFromTemplateRow(tpl));\n\n        private static IReadOnlyList<ButtonMeta> ParseButtonsFromTemplateRow(WhatsAppTemplate tpl)\n        {\n            if (!string.IsNullOrWhiteSpace(tpl.UrlButtons))\n            {\n                try\n                {\n                    using var doc = JsonDocument.Parse(tpl.UrlButtons);\n                    if (doc.RootElement.ValueKind == JsonValueKind.Array)\n                    {\n                        var list = new List<ButtonMeta>(capacity: 3);\n                        foreach (var el in doc.RootElement.EnumerateArray())\n                        {\n                            var text = el.TryGetProperty(\"ButtonText\", out var pText) ? pText.GetString() ?? \"\" :\n                                       el.TryGetProperty(\"Text\", out var pText2) ? pText2.GetString() ?? \"\" : \"\";\n                            var type = el.TryGetProperty(\"ButtonType\", out var pType) ? pType.GetString() ?? \"\" :\n                                       el.TryGetProperty(\"Type\", out var pType2) ? pType2.GetString() ?? \"\" : \"\";\n                            var url = el.TryGetProperty(\"TargetUrl\", out var pUrl) ? pUrl.GetString() : null;\n\n                            if (!string.IsNullOrWhiteSpace(text) && !string.IsNullOrWhiteSpace(type))\n                                list.Add(new ButtonMeta(text, type, url));\n                        }\n                        return list;\n                    }\n                }\n                catch { /* fallthrough */ }\n            }\n\n            if (!string.IsNullOrWhiteSpace(tpl.RawJson))\n            {\n                try\n                {\n                    using var doc = JsonDocument.Parse(tpl.RawJson);\n\n                    JsonElement comps = default;\n                    if (doc.RootElement.TryGetProperty(\"template\", out var tplNode) &&\n                        tplNode.TryGetProperty(\"components\", out var comps1))\n                    {\n                        comps = comps1;\n                    }\n                    else if (doc.RootElement.TryGetProperty(\"components\", out var comps2))\n                    {\n                        comps = comps2;\n                    }\n\n                    if (comps.ValueKind == JsonValueKind.Array)\n                    {\n                        var list = new List<ButtonMeta>(capacity: 3);\n\n                        foreach (var c in comps.EnumerateArray())\n                        {\n                            if (!c.TryGetProperty(\"type\", out var tProp)) continue;\n                            if (!string.Equals(tProp.GetString(), \"button\", StringComparison.OrdinalIgnoreCase)) continue;\n\n                            var isUrl =\n                                (c.TryGetProperty(\"sub_type\", out var st) && RxButtonTypeMeta.IsMatch(st.GetString() ?? \"\")) ||\n                                (c.TryGetProperty(\"subType\", out var st2) && RxButtonTypePinn.IsMatch(st2.GetString() ?? \"\"));\n\n                            if (!isUrl) continue;\n\n                            string text = \"Open\";\n                            string type = \"url\";\n                            string? url = null;\n\n                            if (c.TryGetProperty(\"parameters\", out var pars) && pars.ValueKind == JsonValueKind.Array)\n                            {\n                                foreach (var p in pars.EnumerateArray())\n                                {\n                                    if (p.TryGetProperty(\"text\", out var txtProp))\n                                    {\n                                        var v = txtProp.GetString();\n                                        if (!string.IsNullOrWhiteSpace(v)) { url = v; break; }\n                                    }\n                                }\n                            }\n\n                            list.Add(new ButtonMeta(text, type, url));\n                            if (list.Count >= 3) break;\n                        }\n\n                        return list;\n                    }\n                }\n                catch { /* ignore */ }\n            }\n\n            return Array.Empty<ButtonMeta>();\n        }\n        // =====================================================================================\n\n        public OutboundSenderWorker(IServiceProvider sp, ILogger<OutboundSenderWorker> log)\n        {\n            _sp = sp;\n            _log = log;\n\n            _channel = Channel.CreateBounded<OutboundMessageJob>(new BoundedChannelOptions(5000)\n            {\n                SingleReader = false,\n                SingleWriter = false,\n                FullMode = BoundedChannelFullMode.Wait\n            });\n        }\n\n\n\n        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n        {\n            using var cts = CancellationTokenSource.CreateLinkedTokenSource(stoppingToken);\n            var ct = cts.Token;\n\n            var consumers = Enumerable.Range(0, _globalDop)\n                .Select(_ => Task.Run(() => ConsumeAsync(ct), ct))\n                .ToArray();\n\n            var producer = Task.Run(() => ProduceAsync(ct), ct);\n\n            var all = consumers.Append(producer).ToArray();\n\n            try\n            {\n                await Task.WhenAll(all);\n            }\n            catch\n            {\n                try { cts.Cancel(); } catch { /* ignore */ }\n                throw;\n            }\n        }\n\n        private async Task ProduceAsync(CancellationToken ct)\n        {\n            const int ChannelCapacity = 5000;\n\n            var idleDelay = _pollInterval;\n            var maxIdleDelay = TimeSpan.FromSeconds(1);\n            var longIdleDelay = TimeSpan.FromSeconds(30);\n            int consecutiveEmpty = 0;\n\n            const string sql = @\"\nWITH cte AS (\n    SELECT \"\"Id\"\"\n    FROM \"\"OutboundMessageJobs\"\"\n    WHERE \"\"Status\"\" = 'Pending'\n      AND (\"\"NextAttemptAt\"\" IS NULL OR \"\"NextAttemptAt\"\" <= NOW())\n    ORDER BY \"\"NextAttemptAt\"\" NULLS FIRST, \"\"CreatedAt\"\"\n    FOR UPDATE SKIP LOCKED\n    LIMIT @take\n)\nUPDATE \"\"OutboundMessageJobs\"\" j\nSET \"\"Status\"\" = 'InFlight',\n    \"\"NextAttemptAt\"\" = NOW() + make_interval(secs => @flight),\n    \"\"LastError\"\" = NULL\nWHERE j.\"\"Id\"\" IN (SELECT \"\"Id\"\" FROM cte)\nRETURNING j.*;\";\n\n            try { await Task.Delay(_rand.Next(100, 500), ct); } catch { /* ignore */ }\n\n            while (!ct.IsCancellationRequested)\n            {\n                try\n                {\n                    using var scope = _sp.CreateScope();\n                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n\n                    var approxCount = Volatile.Read(ref _inChannel);\n                    var budget = Math.Max(0, ChannelCapacity - approxCount);\n\n                    if (budget <= 0)\n                    {\n                        await Task.Delay(idleDelay, ct);\n                        idleDelay = TimeSpan.FromMilliseconds(\n                            Math.Min(maxIdleDelay.TotalMilliseconds, idleDelay.TotalMilliseconds * 1.25)\n                        );\n                        continue;\n                    }\n\n                    idleDelay = _pollInterval;\n\n                    var take = Math.Min(budget, 2000);\n                    var flightSecs = (int)Math.Ceiling(_flightTimeout.TotalSeconds);\n\n                    var takeParam = new NpgsqlParameter<int>(\"take\", take);\n                    var flightParam = new NpgsqlParameter<int>(\"flight\", flightSecs);\n\n                    var prevTimeout = db.Database.GetCommandTimeout();\n                    db.Database.SetCommandTimeout(5);\n\n                    List<OutboundMessageJob> jobs;\n                    try\n                    {\n                        jobs = await db.OutboundMessageJobs\n                            .FromSqlRaw(sql, takeParam, flightParam)\n                            .AsNoTracking()\n                            .ToListAsync(ct);\n                    }\n                    finally\n                    {\n                        db.Database.SetCommandTimeout(prevTimeout);\n                    }\n\n                    foreach (var job in jobs)\n                    {\n                        await _channel.Writer.WriteAsync(job, ct);\n                        Interlocked.Increment(ref _inChannel);\n                    }\n\n                    if (jobs.Count == 0)\n                    {\n                        consecutiveEmpty++;\n                        var jitterMs = _rand.Next(0, 200);\n                        var delay = idleDelay + TimeSpan.FromMilliseconds(jitterMs);\n\n                        if (consecutiveEmpty >= 8 && idleDelay >= maxIdleDelay)\n                            delay = longIdleDelay + TimeSpan.FromMilliseconds(jitterMs);\n\n                        await Task.Delay(delay, ct);\n\n                        if (idleDelay < maxIdleDelay)\n                        {\n                            idleDelay = TimeSpan.FromMilliseconds(\n                                Math.Min(maxIdleDelay.TotalMilliseconds, idleDelay.TotalMilliseconds * 2)\n                            );\n                        }\n                    }\n                    else\n                    {\n                        consecutiveEmpty = 0;\n                        idleDelay = _pollInterval;\n                    }\n                }\n                catch (TaskCanceledException)\n                {\n                }\n                catch (Exception ex)\n                {\n                    _log.LogError(ex, \"[Outbox] Producer loop error\");\n                    try { await Task.Delay(TimeSpan.FromSeconds(2), ct); } catch { /* ignore */ }\n                }\n            }\n        }\n\n        // ---- keyed concurrency gate (per sender) ---------------------------------------\n        private sealed class KeyedSemaphore\n        {\n            private readonly ConcurrentDictionary<string, SemaphoreSlim> _map = new();\n            public async Task<IDisposable> AcquireAsync(string key, int dop, CancellationToken ct)\n            {\n                var sem = _map.GetOrAdd(key, _ => new SemaphoreSlim(dop));\n                await sem.WaitAsync(ct);\n                return new Releaser(sem);\n            }\n            private sealed class Releaser : IDisposable\n            {\n                private readonly SemaphoreSlim _s;\n                public Releaser(SemaphoreSlim s) => _s = s;\n                public void Dispose() => _s.Release();\n            }\n        }\n        private static readonly KeyedSemaphore _perSenderGate = new();\n        // -------------------------------------------------------------------------------\n\n        // Best-effort extraction of provider message id from a Meta success body\n        private static string? TryExtractProviderMessageId(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return null;\n            try\n            {\n                using var doc = JsonDocument.Parse(raw);\n                if (doc.RootElement.TryGetProperty(\"messages\", out var msgs) &&\n                    msgs.ValueKind == JsonValueKind.Array &&\n                    msgs.GetArrayLength() > 0 &&\n                    msgs[0].TryGetProperty(\"id\", out var idProp))\n                {\n                    return idProp.GetString();\n                }\n            }\n            catch { /* ignore */ }\n            return null;\n        }\n\n        private async Task ConsumeAsync(CancellationToken ct)\n        {\n            static async Task<string> ResolveRecipientPhoneAsync(AppDbContext db, Guid recipientId, CancellationToken ct2)\n            {\n                var phone = await db.CampaignRecipients\n                    .AsNoTracking()\n                    .Where(r => r.Id == recipientId)\n                    .Select(r =>\n                        r.Contact != null\n                            ? r.Contact.PhoneNumber\n                            : (r.AudienceMember != null\n                                ? (r.AudienceMember.PhoneE164 ?? r.AudienceMember.PhoneRaw)\n                                : null))\n                    .FirstOrDefaultAsync(ct2);\n\n                return phone ?? string.Empty;\n            }\n\n            while (await _channel.Reader.WaitToReadAsync(ct))\n            {\n                if (!_channel.Reader.TryRead(out var job))\n                    continue;\n\n                Interlocked.Decrement(ref _inChannel);\n\n                try\n                {\n                    using var scope = _sp.CreateScope();\n                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n                    var engine = scope.ServiceProvider.GetRequiredService<IMessageEngineService>();\n                    var billing = scope.ServiceProvider.GetRequiredService<IBillingIngestService>();\n                    var logger = scope.ServiceProvider.GetRequiredService<ILogger<OutboundSenderWorker>>();\n                    var logSink = scope.ServiceProvider.GetRequiredService<ICampaignLogSink>();\n                    var limiter = scope.ServiceProvider.GetRequiredService<xbytechat.api.Infrastructure.RateLimiting.IPhoneNumberRateLimiter>();\n                    var messageLogSink = scope.ServiceProvider.GetRequiredService<IMessageLogSink>();\n                    var builder = scope.ServiceProvider.GetRequiredService<ITemplatePayloadBuilder>();\n                    var validator = scope.ServiceProvider.GetRequiredService<ICampaignSendValidator>();\n\n                    var senderKey = $\"{job.Provider}|{job.PhoneNumberId}\";\n\n                    using (await _perSenderGate.AcquireAsync(senderKey, _perNumberDop, ct))\n                    {\n                        var lease = await limiter.AcquireAsync(senderKey, ct);\n                        if (!lease.IsAcquired)\n                        {\n                            await Task.Delay(50, ct);\n                            continue;\n                        }\n\n                        var recipientPhone = await ResolveRecipientPhoneAsync(db, job.RecipientId, ct);\n                        if (string.IsNullOrWhiteSpace(recipientPhone))\n                        {\n                            job.Status = \"Failed\";\n                            job.Attempt += 1;\n                            job.LastError = \"Recipient phone not found.\";\n                            var backoff1 = (int)Math.Min(60, Math.Pow(2, job.Attempt) * 2);\n                            job.NextAttemptAt = DateTime.UtcNow.AddSeconds(backoff1);\n                            db.Update(job);\n                            await db.SaveChangesAsync(ct);\n\n                            logger.LogWarning(\"[Outbox] Recipient phone not found. job={JobId} recipient={RecipientId}\", job.Id, job.RecipientId);\n                            MetricsRegistry.MessagesFailed.Add(1);\n                            continue;\n                        }\n\n                        var lang = job.LanguageCode ?? \"en_US\";\n                        var tmplRow = await db.WhatsAppTemplates\n                            .AsNoTracking()\n                            .FirstOrDefaultAsync(t =>\n                                t.BusinessId == job.BusinessId &&\n                                t.Provider == job.Provider &&\n                                t.Name == job.TemplateName &&\n                                t.LanguageCode == lang,\n                                ct);\n\n                        if (tmplRow == null)\n                        {\n                            job.Status = \"Failed\";\n                            job.Attempt += 1;\n                            job.LastError = $\"Template not found: {job.TemplateName} ({lang}) for {job.Provider}.\";\n                            var backoff = (int)Math.Min(60, Math.Pow(2, job.Attempt) * 2);\n                            job.NextAttemptAt = DateTime.UtcNow.AddSeconds(backoff);\n                            db.Update(job);\n                            await db.SaveChangesAsync(ct);\n\n                            logger.LogWarning(\"[Outbox] Template not found. job={JobId} template={Template} lang={Lang} provider={Provider}\",\n                                job.Id, job.TemplateName, lang, job.Provider);\n                            MetricsRegistry.MessagesFailed.Add(1);\n                            continue;\n                        }\n\n                        HeaderKind headerKind = tmplRow.HeaderKind?.ToLowerInvariant() switch\n                        {\n                            \"text\" => HeaderKind.Text,\n                            \"image\" => HeaderKind.Image,\n                            \"video\" => HeaderKind.Video,\n                            \"document\" => HeaderKind.Document,\n                            \"none\" or null => HeaderKind.None,\n                            _ => HeaderKind.None\n                        };\n                        if (headerKind == HeaderKind.None && !string.IsNullOrWhiteSpace(job.MediaType))\n                        {\n                            headerKind = job.MediaType.ToLowerInvariant() switch\n                            {\n                                \"text\" => HeaderKind.Text,\n                                \"image\" => HeaderKind.Image,\n                                \"video\" => HeaderKind.Video,\n                                \"document\" => HeaderKind.Document,\n                                _ => HeaderKind.None\n                            };\n                        }\n\n                        var providerEnum = ProviderUtil.Parse(job.Provider);\n                        var buttonsFromTemplate = GetTemplateButtonsCached(tmplRow);\n\n                        var plan = new SendPlan(\n                            BusinessId: job.BusinessId,\n                            Provider: providerEnum,\n                            PhoneNumberId: job.PhoneNumberId!,\n                            TemplateName: job.TemplateName!,\n                            LanguageCode: lang,\n                            HeaderKind: headerKind,\n                            HeaderUrl: job.HeaderMediaUrl,\n                            Buttons: buttonsFromTemplate\n                        );\n\n                        var recipient = new RecipientPlan(\n                            RecipientId: job.RecipientId,\n                            ToPhoneE164: recipientPhone,\n                            ParametersJson: job.ResolvedParamsJson ?? \"[]\",\n                            ButtonParamsJson: job.ResolvedButtonUrlsJson,\n                            IdempotencyKey: job.IdempotencyKey ?? $\"{job.CampaignId}:{recipientPhone}:{job.TemplateName}\"\n                        );\n\n                        var envelope = builder.Build(plan, recipient);\n\n                        var (ok, error) = validator.Validate(plan, recipient, envelope, tmplRow);\n                        if (!ok)\n                        {\n                            job.Status = \"Failed\";\n                            job.Attempt += 1;\n                            job.LastError = error ?? \"Validation failed.\";\n                            var backoff = (int)Math.Min(60, Math.Pow(2, job.Attempt) * 2);\n                            job.NextAttemptAt = DateTime.UtcNow.AddSeconds(backoff);\n                            db.Update(job);\n                            await db.SaveChangesAsync(ct);\n\n                            logger.LogWarning(\"[Outbox] Validation failed job={JobId} error={Error}\", job.Id, job.LastError);\n                            MetricsRegistry.MessagesFailed.Add(1);\n                            continue;\n                        }\n\n                        object payload = providerEnum switch\n                        {\n                            Provider.MetaCloud =>\n                                scope.ServiceProvider.GetRequiredService<MetaCloudPayloadMapper>()\n                                    .BuildPayload(plan, recipient, envelope),\n\n                            Provider.Pinnacle =>\n                                scope.ServiceProvider.GetRequiredService<PinnaclePayloadMapper>()\n                                    .BuildPayload(plan, recipient, envelope),\n\n                            _ => throw new InvalidOperationException(\"Unknown provider\")\n                        };\n\n                        var sw = Stopwatch.StartNew();\n                        var engineResult = await engine.SendPayloadAsync(job.BusinessId, job.Provider, payload, job.PhoneNumberId);\n                        sw.Stop();\n                        MetricsRegistry.SendLatencyMs.Record(sw.Elapsed.TotalMilliseconds);\n\n                        if (!engineResult.Success)\n                        {\n                            var err = engineResult.ErrorMessage ?? string.Empty;\n                            if (err.Contains(\"429\", StringComparison.Ordinal) ||\n                                err.Contains(\"Too Many Requests\", StringComparison.OrdinalIgnoreCase))\n                            {\n                                limiter.UpdateLimits(senderKey, permitsPerSecond: 5, burst: 5);\n                                MetricsRegistry.RateLimited429s.Add(1);\n                            }\n                        }\n\n                        // ✅ Surface provider ID and raw body for visibility\n                        var providerMsgId = !string.IsNullOrWhiteSpace(engineResult.MessageId)\n                            ? engineResult.MessageId\n                            : TryExtractProviderMessageId(engineResult.RawResponse);\n\n                        if (engineResult.Success)\n                        {\n                            logger.LogInformation(\"Provider send OK | providerMessageId={ProviderId} job={JobId} to={To}\",\n                                providerMsgId, job.Id, recipientPhone);\n                        }\n                        else\n                        {\n                            logger.LogWarning(\"Provider send FAILED | job={JobId} to={To} error={Error} body={Body}\",\n                                job.Id, recipientPhone, engineResult.ErrorMessage, engineResult.RawResponse);\n                        }\n\n                        // Persist MessageLogs (COPY sink)\n                        var now = DateTime.UtcNow;\n                        var runId = Guid.NewGuid();\n                        var logId = Guid.NewGuid();\n\n                        logger.LogInformation(\n                            \"[OutboundSenderWorker] Enqueue MessageLog id={LogId} recipient={RecipientId} job={JobId}\",\n                            logId, job.RecipientId, job.Id);\n\n                        messageLogSink.Enqueue(new MessageLog\n                        {\n                            Id = logId,\n                            BusinessId = job.BusinessId,\n                            CampaignId = job.CampaignId,\n                            RecipientNumber = recipientPhone,\n                            MessageContent = job.TemplateName,\n                            MediaUrl = job.HeaderMediaUrl,\n                            Status = engineResult.Success ? \"Sent\" : \"Failed\",\n                            MessageId = providerMsgId,\n                            ErrorMessage = engineResult.ErrorMessage,\n                            RawResponse = engineResult.RawResponse,\n                            CreatedAt = now,\n                            SentAt = engineResult.Success ? now : (DateTime?)null,\n                            Source = \"campaign\",\n                            RunId = runId,\n                            Provider = job.Provider,\n                            ProviderMessageId = providerMsgId,\n                            IsIncoming = false,\n                            IsChargeable = false\n                        });\n\n                        // Batched CampaignSendLog (COPY via sink)\n                        logSink.Enqueue(new CampaignLogRecord(\n                            Id: Guid.NewGuid(),\n                            RunId: runId,\n                            MessageId: providerMsgId,\n                            CampaignId: job.CampaignId,\n                            ContactId: null,\n                            RecipientId: job.RecipientId,\n                            MessageBody: job.MessageBody ?? job.TemplateName,\n                            TemplateId: job.TemplateName,\n                            SendStatus: engineResult.Success ? \"Sent\" : \"Failed\",\n                            ErrorMessage: engineResult.ErrorMessage,\n                            CreatedAt: now,\n                            CreatedBy: \"system\",\n                            SentAt: engineResult.Success ? now : (DateTime?)null,\n                            DeliveredAt: null,\n                            ReadAt: null,\n                            IpAddress: null,\n                            DeviceInfo: null,\n                            MacAddress: null,\n                            SourceChannel: \"campaign\",\n                            DeviceType: null,\n                            Browser: null,\n                            Country: null,\n                            City: null,\n                            IsClicked: false,\n                            ClickedAt: null,\n                            ClickType: null,\n                            RetryCount: job.Attempt,\n                            LastRetryAt: now,\n                            LastRetryStatus: engineResult.Success ? \"Success\" : \"Failed\",\n                            AllowRetry: job.Attempt < DEFAULT_MAX_ATTEMPTS,\n                            MessageLogId: logId,\n                            BusinessId: job.BusinessId,\n                            CTAFlowConfigId: null,\n                            CTAFlowStepId: null,\n                            ButtonBundleJson: null\n                        ));\n\n                        // Update job (retry/backoff if needed)\n                        job.Status = engineResult.Success ? \"Sent\" : \"Failed\";\n                        job.Attempt += 1;\n                        job.LastError = engineResult.ErrorMessage;\n\n                        if (!engineResult.Success)\n                        {\n                            var backoffSecs = (int)Math.Min(60, Math.Pow(2, job.Attempt) * 2);\n                            job.NextAttemptAt = DateTime.UtcNow.AddSeconds(backoffSecs);\n                            MetricsRegistry.MessagesFailed.Add(1);\n                        }\n                        else\n                        {\n                            job.NextAttemptAt = null;\n                            MetricsRegistry.MessagesSent.Add(1);\n                        }\n\n                        db.Update(job);\n                        await db.SaveChangesAsync(ct);\n\n                        await billing.IngestFromSendResponseAsync(\n                            job.BusinessId,\n                            logId,\n                            job.Provider,\n                            engineResult.RawResponse ?? \"{}\"\n                        );\n                    }\n                }\n                catch (TaskCanceledException)\n                {\n                }\n                catch (Exception ex)\n                {\n                    try\n                    {\n                        using var scope = _sp.CreateScope();\n                        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n                        job.Status = \"Failed\";\n                        job.Attempt += 1;\n                        job.LastError = ex.Message;\n                        var backoffSecs = (int)Math.Min(60, Math.Pow(2, job.Attempt) * 2);\n                        job.NextAttemptAt = DateTime.UtcNow.AddSeconds(backoffSecs);\n                        db.Update(job);\n                        await db.SaveChangesAsync(ct);\n                    }\n                    catch { /* swallow */ }\n\n                    MetricsRegistry.MessagesFailed.Add(1);\n                    _log.LogError(ex, \"[Outbox] Consume error job={JobId}\", job.Id);\n                }\n            }\n        }\n    }\n}\n\n\n//// 📄 File: Features/CampaignModule/Workers/OutboundSenderWorker.cs\n//using System;\n//using System.Collections.Concurrent;\n//using System.Collections.Generic;   // NEW\n//using System.Diagnostics;\n//using System.Linq;\n//using System.Text.Json;            // NEW\n//using System.Text.RegularExpressions; // NEW\n//using System.Threading;\n//using System.Threading.Channels;\n//using System.Threading.Tasks;\n//using Microsoft.EntityFrameworkCore;\n//using Microsoft.Extensions.DependencyInjection;\n//using Microsoft.Extensions.Hosting;\n//using Microsoft.Extensions.Logging;\n//using Npgsql;\n\n//using xbytechat.api;\n//using xbytechat.api.Features.CampaignModule.Models;\n//using xbytechat.api.Features.CampaignTracking.Logging;\n//using xbytechat.api.Features.CampaignTracking.Models;\n//using xbytechat.api.Features.MessageLogging.Services;\n//using xbytechat.api.Features.MessagesEngine.Abstractions;\n//using xbytechat.api.Features.CampaignModule.SendEngine;\n//using xbytechat_api.Features.Billing.Services;\n//using xbytechat.api.Infrastructure.Observability;\n//using xbytechat.api.Features.MessagesEngine.Services;\n//using xbytechat.api.WhatsAppSettings.Helpers;\n//using xbytechat.api.AuthModule.Models;\n\n//namespace xbytechat.api.Features.CampaignModule.Workers\n//{\n//    public class OutboundSenderWorker : BackgroundService\n//    {\n//        private readonly IServiceProvider _sp;\n//        private readonly ILogger<OutboundSenderWorker> _log;\n//        private readonly Channel<OutboundMessageJob> _channel;\n//        private const int DEFAULT_MAX_ATTEMPTS = 3;\n\n//        // Concurrency caps (override via appsettings if you expose options)\n//        private readonly int _globalDop = 32;   // total parallel consumers\n//        private readonly int _perNumberDop = 8; // per (provider, PhoneNumberId)\n\n//        private readonly TimeSpan _pollInterval = TimeSpan.FromMilliseconds(250);\n//        private static readonly TimeSpan _flightTimeout = TimeSpan.FromMinutes(5);\n\n//        private int _inChannel;\n//        private readonly Random _rand = new();\n\n//        // =========================[ NEW: Template Button Cache + Parsers ]=========================\n//        // Cache key = BusinessId|Provider|TemplateName|Language (upper-invariant)\n//        private static readonly ConcurrentDictionary<string, IReadOnlyList<ButtonMeta>> _btnCache =\n//            new(StringComparer.Ordinal);\n\n//        // Precompiled regexes for any legacy/raw variations (cheap + fast on hot path)\n//        private static readonly Regex RxButtonTypeMeta = new(@\"^\\s*url\\s*$\", RegexOptions.IgnoreCase | RegexOptions.Compiled);\n//        private static readonly Regex RxButtonTypePinn = new(@\"^\\s*url\\s*$\", RegexOptions.IgnoreCase | RegexOptions.Compiled);\n\n//        private static string CacheKeyForTemplate(WhatsAppTemplate tpl)\n//            => $\"{tpl.BusinessId}|{tpl.Provider}|{tpl.Name}|{tpl.LanguageCode}\".ToUpperInvariant();\n\n//        private static IReadOnlyList<ButtonMeta> GetTemplateButtonsCached(WhatsAppTemplate tpl)\n//            => _btnCache.GetOrAdd(CacheKeyForTemplate(tpl), _ => ParseButtonsFromTemplateRow(tpl));\n\n//        private static IReadOnlyList<ButtonMeta> ParseButtonsFromTemplateRow(WhatsAppTemplate tpl)\n//        {\n//            // 1) Preferred: light-weight ButtonsJson (DTO-style) if available\n//            if (!string.IsNullOrWhiteSpace(tpl.UrlButtons))\n//            {\n//                try\n//                {\n//                    using var doc = JsonDocument.Parse(tpl.UrlButtons);\n//                    if (doc.RootElement.ValueKind == JsonValueKind.Array)\n//                    {\n//                        var list = new List<ButtonMeta>(capacity: 3);\n//                        foreach (var el in doc.RootElement.EnumerateArray())\n//                        {\n//                            // Support both historical shapes:\n//                            // { \"ButtonText\",\"ButtonType\",\"TargetUrl\" }  OR  { \"Text\",\"Type\",\"TargetUrl\" }\n//                            var text = el.TryGetProperty(\"ButtonText\", out var pText) ? pText.GetString() ?? \"\" :\n//                                       el.TryGetProperty(\"Text\", out var pText2) ? pText2.GetString() ?? \"\" : \"\";\n//                            var type = el.TryGetProperty(\"ButtonType\", out var pType) ? pType.GetString() ?? \"\" :\n//                                       el.TryGetProperty(\"Type\", out var pType2) ? pType2.GetString() ?? \"\" : \"\";\n//                            var url = el.TryGetProperty(\"TargetUrl\", out var pUrl) ? pUrl.GetString() : null;\n\n//                            if (!string.IsNullOrWhiteSpace(text) && !string.IsNullOrWhiteSpace(type))\n//                                list.Add(new ButtonMeta(text, type, url));\n//                        }\n//                        return list;\n//                    }\n//                }\n//                catch\n//                {\n//                    // Fallthrough to RawJson parser\n//                }\n//            }\n\n//            // 2) Fallback: parse RawJson (provider-native). Look for button components with url subtype.\n//            if (!string.IsNullOrWhiteSpace(tpl.RawJson))\n//            {\n//                try\n//                {\n//                    using var doc = JsonDocument.Parse(tpl.RawJson);\n\n//                    // Try to locate \"components\" either under \"template\" or at root\n//                    JsonElement comps = default;\n//                    if (doc.RootElement.TryGetProperty(\"template\", out var tplNode) &&\n//                        tplNode.TryGetProperty(\"components\", out var comps1))\n//                    {\n//                        comps = comps1;\n//                    }\n//                    else if (doc.RootElement.TryGetProperty(\"components\", out var comps2))\n//                    {\n//                        comps = comps2;\n//                    }\n\n//                    if (comps.ValueKind == JsonValueKind.Array)\n//                    {\n//                        var list = new List<ButtonMeta>(capacity: 3);\n\n//                        foreach (var c in comps.EnumerateArray())\n//                        {\n//                            // Meta:   { \"type\":\"button\", \"sub_type\":\"url\", \"index\":\"0\", ... }\n//                            // Pinn.:  { \"type\":\"button\", \"subType\":\"url\", \"index\": 0, ... }\n//                            if (!c.TryGetProperty(\"type\", out var tProp)) continue;\n//                            if (!string.Equals(tProp.GetString(), \"button\", StringComparison.OrdinalIgnoreCase)) continue;\n\n//                            var isUrl =\n//                                (c.TryGetProperty(\"sub_type\", out var st) && RxButtonTypeMeta.IsMatch(st.GetString() ?? \"\")) ||\n//                                (c.TryGetProperty(\"subType\", out var st2) && RxButtonTypePinn.IsMatch(st2.GetString() ?? \"\"));\n\n//                            if (!isUrl) continue;\n\n//                            // Text label may not be present in raw; use a neutral label\n//                            string text = \"Open\";\n//                            string type = \"url\";\n//                            string? url = null;\n\n//                            // If static url parameter is present, try to read it\n//                            if (c.TryGetProperty(\"parameters\", out var pars) && pars.ValueKind == JsonValueKind.Array)\n//                            {\n//                                foreach (var p in pars.EnumerateArray())\n//                                {\n//                                    if (p.TryGetProperty(\"text\", out var txtProp))\n//                                    {\n//                                        var v = txtProp.GetString();\n//                                        if (!string.IsNullOrWhiteSpace(v)) { url = v; break; }\n//                                    }\n//                                }\n//                            }\n\n//                            list.Add(new ButtonMeta(text, type, url));\n//                            if (list.Count >= 3) break; // WhatsApp UI supports up to 3 buttons\n//                        }\n\n//                        return list;\n//                    }\n//                }\n//                catch\n//                {\n//                    // ignore, fallthrough\n//                }\n//            }\n\n//            return Array.Empty<ButtonMeta>();\n//        }\n//        // ==========================================================================================\n\n//        public OutboundSenderWorker(IServiceProvider sp, ILogger<OutboundSenderWorker> log)\n//        {\n//            _sp = sp;\n//            _log = log;\n\n//            _channel = Channel.CreateBounded<OutboundMessageJob>(new BoundedChannelOptions(5000)\n//            {\n//                SingleReader = false,\n//                SingleWriter = false,\n//                FullMode = BoundedChannelFullMode.Wait\n//            });\n//        }\n\n//        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n//        {\n//            using var cts = CancellationTokenSource.CreateLinkedTokenSource(stoppingToken);\n//            var ct = cts.Token;\n\n//            var consumers = Enumerable.Range(0, _globalDop)\n//                .Select(_ => Task.Run(() => ConsumeAsync(ct), ct))\n//                .ToArray();\n\n//            var producer = Task.Run(() => ProduceAsync(ct), ct);\n\n//            var all = consumers.Append(producer).ToArray();\n\n//            try\n//            {\n//                await Task.WhenAll(all);\n//            }\n//            catch\n//            {\n//                try { cts.Cancel(); } catch { /* ignore */ }\n//                throw;\n//            }\n//        }\n\n//        private async Task ProduceAsync(CancellationToken ct)\n//        {\n//            const int ChannelCapacity = 5000;\n\n//            // Backoff controls\n//            var idleDelay = _pollInterval;                 // starts small\n//            var maxIdleDelay = TimeSpan.FromSeconds(1);    // back off up to 1s\n//            var longIdleDelay = TimeSpan.FromSeconds(30);  // after many empties\n//            int consecutiveEmpty = 0;\n\n//            // Prioritize due items; then FIFO by CreatedAt\n//            const string sql = @\"\n//WITH cte AS (\n//    SELECT \"\"Id\"\"\n//    FROM \"\"OutboundMessageJobs\"\"\n//    WHERE \"\"Status\"\" = 'Pending'\n//      AND (\"\"NextAttemptAt\"\" IS NULL OR \"\"NextAttemptAt\"\" <= NOW())\n//    ORDER BY \"\"NextAttemptAt\"\" NULLS FIRST, \"\"CreatedAt\"\"\n//    FOR UPDATE SKIP LOCKED\n//    LIMIT @take\n//)\n//UPDATE \"\"OutboundMessageJobs\"\" j\n//SET \"\"Status\"\" = 'InFlight',\n//    \"\"NextAttemptAt\"\" = NOW() + make_interval(secs => @flight),\n//    \"\"LastError\"\" = NULL\n//WHERE j.\"\"Id\"\" IN (SELECT \"\"Id\"\" FROM cte)\n//RETURNING j.*;\";\n\n//            // Small jittered pause on startup to avoid log bursts on app boot\n//            try { await Task.Delay(_rand.Next(100, 500), ct); } catch { /* ignore */ }\n\n//            while (!ct.IsCancellationRequested)\n//            {\n//                try\n//                {\n//                    using var scope = _sp.CreateScope();\n//                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n\n//                    // Channel budget\n//                    var approxCount = Volatile.Read(ref _inChannel);\n//                    var budget = Math.Max(0, ChannelCapacity - approxCount);\n\n//                    if (budget <= 0)\n//                    {\n//                        await Task.Delay(idleDelay, ct);\n//                        idleDelay = TimeSpan.FromMilliseconds(\n//                            Math.Min(maxIdleDelay.TotalMilliseconds, idleDelay.TotalMilliseconds * 1.25)\n//                        );\n//                        continue;\n//                    }\n\n//                    // We have budget; don’t carry a long backoff into a fresh poll cycle\n//                    idleDelay = _pollInterval;\n\n//                    var take = Math.Min(budget, 2000);\n//                    var flightSecs = (int)Math.Ceiling(_flightTimeout.TotalSeconds);\n\n//                    var takeParam = new NpgsqlParameter<int>(\"take\", take);\n//                    var flightParam = new NpgsqlParameter<int>(\"flight\", flightSecs);\n\n//                    var prevTimeout = db.Database.GetCommandTimeout();\n//                    db.Database.SetCommandTimeout(5);\n\n//                    List<OutboundMessageJob> jobs;\n//                    try\n//                    {\n//                        jobs = await db.OutboundMessageJobs\n//                            .FromSqlRaw(sql, takeParam, flightParam)\n//                            .AsNoTracking()\n//                            .ToListAsync(ct);\n//                    }\n//                    finally\n//                    {\n//                        db.Database.SetCommandTimeout(prevTimeout);\n//                    }\n\n//                    // Push to channel; track occupancy\n//                    foreach (var job in jobs)\n//                    {\n//                        await _channel.Writer.WriteAsync(job, ct);\n//                        Interlocked.Increment(ref _inChannel);\n//                    }\n\n//                    if (jobs.Count == 0)\n//                    {\n//                        consecutiveEmpty++;\n\n//                        // No work → exponential backoff, then step up to a longer 30s sleep\n//                        var jitterMs = _rand.Next(0, 200);\n//                        var delay = idleDelay + TimeSpan.FromMilliseconds(jitterMs);\n\n//                        // After several empty loops, cut DB chatter significantly\n//                        if (consecutiveEmpty >= 8 && idleDelay >= maxIdleDelay)\n//                            delay = longIdleDelay + TimeSpan.FromMilliseconds(jitterMs);\n\n//                        await Task.Delay(delay, ct);\n\n//                        if (idleDelay < maxIdleDelay)\n//                        {\n//                            idleDelay = TimeSpan.FromMilliseconds(\n//                                Math.Min(maxIdleDelay.TotalMilliseconds, idleDelay.TotalMilliseconds * 2)\n//                            );\n//                        }\n//                    }\n//                    else\n//                    {\n//                        consecutiveEmpty = 0;\n//                        idleDelay = _pollInterval;\n//                    }\n//                }\n//                catch (TaskCanceledException)\n//                {\n//                    // normal shutdown\n//                }\n//                catch (Exception ex)\n//                {\n//                    _log.LogError(ex, \"[Outbox] Producer loop error\");\n//                    try { await Task.Delay(TimeSpan.FromSeconds(2), ct); } catch { /* ignore */ }\n//                }\n//            }\n//        }\n\n//        // ---- keyed concurrency gate (per sender) ---------------------------------------\n//        private sealed class KeyedSemaphore\n//        {\n//            private readonly ConcurrentDictionary<string, SemaphoreSlim> _map = new();\n//            public async Task<IDisposable> AcquireAsync(string key, int dop, CancellationToken ct)\n//            {\n//                var sem = _map.GetOrAdd(key, _ => new SemaphoreSlim(dop));\n//                await sem.WaitAsync(ct);\n//                return new Releaser(sem);\n//            }\n//            private sealed class Releaser : IDisposable\n//            {\n//                private readonly SemaphoreSlim _s;\n//                public Releaser(SemaphoreSlim s) => _s = s;\n//                public void Dispose() => _s.Release();\n//            }\n//        }\n//        private static readonly KeyedSemaphore _perSenderGate = new();\n//        // -------------------------------------------------------------------------------\n//        private async Task ConsumeAsync(CancellationToken ct)\n//        {\n//            // Resolve a phone number for a recipient (Contact.Phone or AudienceMember.PhoneE164/Raw)\n//            static async Task<string> ResolveRecipientPhoneAsync(AppDbContext db, Guid recipientId, CancellationToken ct2)\n//            {\n//                var phone = await db.CampaignRecipients\n//                    .AsNoTracking()\n//                    .Where(r => r.Id == recipientId)\n//                    .Select(r =>\n//                        r.Contact != null\n//                            ? r.Contact.PhoneNumber\n//                            : (r.AudienceMember != null\n//                                ? (r.AudienceMember.PhoneE164 ?? r.AudienceMember.PhoneRaw)\n//                                : null))\n//                    .FirstOrDefaultAsync(ct2);\n\n//                return phone ?? string.Empty;\n//            }\n\n//            while (await _channel.Reader.WaitToReadAsync(ct))\n//            {\n//                if (!_channel.Reader.TryRead(out var job))\n//                    continue;\n\n//                // decrement occupancy as soon as we pull from the channel\n//                Interlocked.Decrement(ref _inChannel);\n\n//                try\n//                {\n//                    using var scope = _sp.CreateScope();\n//                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n//                    var engine = scope.ServiceProvider.GetRequiredService<IMessageEngineService>();\n//                    var billing = scope.ServiceProvider.GetRequiredService<IBillingIngestService>();\n//                    var logger = scope.ServiceProvider.GetRequiredService<ILogger<OutboundSenderWorker>>();\n//                    var logSink = scope.ServiceProvider.GetRequiredService<ICampaignLogSink>();\n//                    var limiter = scope.ServiceProvider.GetRequiredService<xbytechat.api.Infrastructure.RateLimiting.IPhoneNumberRateLimiter>();\n//                    var messageLogSink = scope.ServiceProvider.GetRequiredService<IMessageLogSink>();\n//                    var builder = scope.ServiceProvider.GetRequiredService<ITemplatePayloadBuilder>();\n//                    var validator = scope.ServiceProvider.GetRequiredService<ICampaignSendValidator>(); // ✅\n\n//                    // Per-sender key = provider + phoneNumberId\n//                    var senderKey = $\"{job.Provider}|{job.PhoneNumberId}\";\n\n//                    using (await _perSenderGate.AcquireAsync(senderKey, _perNumberDop, ct))\n//                    {\n//                        // Rate limit per number (token bucket via your registered limiter)\n//                        var lease = await limiter.AcquireAsync(senderKey, ct);\n//                        if (!lease.IsAcquired)\n//                        {\n//                            await Task.Delay(50, ct);\n//                            continue;\n//                        }\n\n//                        // Resolve phone\n//                        var recipientPhone = await ResolveRecipientPhoneAsync(db, job.RecipientId, ct);\n//                        if (string.IsNullOrWhiteSpace(recipientPhone))\n//                        {\n//                            job.Status = \"Failed\";\n//                            job.Attempt += 1;\n//                            job.LastError = \"Recipient phone not found.\";\n//                            var backoff1 = (int)Math.Min(60, Math.Pow(2, job.Attempt) * 2);\n//                            job.NextAttemptAt = DateTime.UtcNow.AddSeconds(backoff1);\n//                            db.Update(job);\n//                            await db.SaveChangesAsync(ct);\n\n//                            logger.LogWarning(\"[Outbox] Recipient phone not found. job={JobId} recipient={RecipientId}\", job.Id, job.RecipientId);\n//                            MetricsRegistry.MessagesFailed.Add(1);\n//                            continue;\n//                        }\n\n//                        // ===== Load template row (cached metadata for validation)\n//                        var lang = job.LanguageCode ?? \"en_US\";\n//                        var tmplRow = await db.WhatsAppTemplates\n//                            .AsNoTracking()\n//                            .FirstOrDefaultAsync(t =>\n//                                t.BusinessId == job.BusinessId &&\n//                                t.Provider == job.Provider &&\n//                                t.Name == job.TemplateName &&\n//                                t.LanguageCode == lang,\n//                                ct);\n\n//                        if (tmplRow == null)\n//                        {\n//                            job.Status = \"Failed\";\n//                            job.Attempt += 1;\n//                            job.LastError = $\"Template not found: {job.TemplateName} ({lang}) for {job.Provider}.\";\n//                            var backoff = (int)Math.Min(60, Math.Pow(2, job.Attempt) * 2);\n//                            job.NextAttemptAt = DateTime.UtcNow.AddSeconds(backoff);\n//                            db.Update(job);\n//                            await db.SaveChangesAsync(ct);\n\n//                            logger.LogWarning(\"[Outbox] Template not found. job={JobId} template={Template} lang={Lang} provider={Provider}\",\n//                                job.Id, job.TemplateName, lang, job.Provider);\n//                            MetricsRegistry.MessagesFailed.Add(1);\n//                            continue;\n//                        }\n\n//                        // Prefer DB header kind (normalized), fallback to job.MediaType\n//                        HeaderKind headerKind = tmplRow.HeaderKind?.ToLowerInvariant() switch\n//                        {\n//                            \"text\" => HeaderKind.Text,\n//                            \"image\" => HeaderKind.Image,\n//                            \"video\" => HeaderKind.Video,\n//                            \"document\" => HeaderKind.Document,\n//                            \"none\" or null => HeaderKind.None,\n//                            _ => HeaderKind.None\n//                        };\n//                        if (headerKind == HeaderKind.None && !string.IsNullOrWhiteSpace(job.MediaType))\n//                        {\n//                            headerKind = job.MediaType.ToLowerInvariant() switch\n//                            {\n//                                \"text\" => HeaderKind.Text,\n//                                \"image\" => HeaderKind.Image,\n//                                \"video\" => HeaderKind.Video,\n//                                \"document\" => HeaderKind.Document,\n//                                _ => HeaderKind.None\n//                            };\n//                        }\n\n//                        // ===== Build plan & recipient\n//                        var providerEnum = ProviderUtil.Parse(job.Provider);\n\n//                        // NEW: hydrate ButtonMeta list from the template row (cached)\n//                        var buttonsFromTemplate = GetTemplateButtonsCached(tmplRow);\n\n//                        var plan = new SendPlan(\n//                            BusinessId: job.BusinessId,\n//                            Provider: providerEnum,\n//                            PhoneNumberId: job.PhoneNumberId!,\n//                            TemplateName: job.TemplateName!,\n//                            LanguageCode: lang,\n//                            HeaderKind: headerKind,\n//                            HeaderUrl: job.HeaderMediaUrl,\n//                            Buttons: buttonsFromTemplate // <-- previously Array.Empty<ButtonMeta>()\n//                        );\n\n//                        var recipient = new RecipientPlan(\n//                            RecipientId: job.RecipientId,\n//                            ToPhoneE164: recipientPhone,\n//                            ParametersJson: job.ResolvedParamsJson ?? \"[]\",\n//                            ButtonParamsJson: job.ResolvedButtonUrlsJson,\n//                            IdempotencyKey: job.IdempotencyKey ?? $\"{job.CampaignId}:{recipientPhone}:{job.TemplateName}\"\n//                        );\n\n//                        // ===== Build envelope (generic) then VALIDATE before provider mapping\n//                        var envelope = builder.Build(plan, recipient); // TemplateEnvelope\n\n//                        // ICampaignSendValidator.Validate(plan, recipient, envelope, tmplRow)\n//                        var (ok, error) = validator.Validate(plan, recipient, envelope, tmplRow);\n//                        if (!ok)\n//                        {\n//                            job.Status = \"Failed\";\n//                            job.Attempt += 1;\n//                            job.LastError = error ?? \"Validation failed.\";\n//                            var backoff = (int)Math.Min(60, Math.Pow(2, job.Attempt) * 2);\n//                            job.NextAttemptAt = DateTime.UtcNow.AddSeconds(backoff);\n//                            db.Update(job);\n//                            await db.SaveChangesAsync(ct);\n\n//                            logger.LogWarning(\"[Outbox] Validation failed job={JobId} error={Error}\", job.Id, job.LastError);\n//                            MetricsRegistry.MessagesFailed.Add(1);\n//                            continue;\n//                        }\n\n//                        // ===== Map to provider payload AFTER validation\n//                        object payload = providerEnum switch\n//                        {\n//                            Provider.MetaCloud =>\n//                                scope.ServiceProvider.GetRequiredService<MetaCloudPayloadMapper>()\n//                                    .BuildPayload(plan, recipient, envelope),\n\n//                            Provider.Pinnacle =>\n//                                scope.ServiceProvider.GetRequiredService<PinnaclePayloadMapper>()\n//                                    .BuildPayload(plan, recipient, envelope),\n\n//                            _ => throw new InvalidOperationException(\"Unknown provider\")\n//                        };\n//                        // ===== End unified build =====\n\n//                        // --- Send via engine + metrics timers ---\n//                        var sw = Stopwatch.StartNew();\n//                        var engineResult = await engine.SendPayloadAsync(job.BusinessId, job.Provider, payload, job.PhoneNumberId);\n//                        sw.Stop();\n//                        MetricsRegistry.SendLatencyMs.Record(sw.Elapsed.TotalMilliseconds);\n\n//                        // Adaptive nudge on 429 (based on error text)\n//                        if (!engineResult.Success)\n//                        {\n//                            var err = engineResult.ErrorMessage ?? string.Empty;\n//                            if (err.Contains(\"429\", StringComparison.Ordinal) ||\n//                                err.Contains(\"Too Many Requests\", StringComparison.OrdinalIgnoreCase))\n//                            {\n//                                limiter.UpdateLimits(senderKey, permitsPerSecond: 5, burst: 5);\n//                                MetricsRegistry.RateLimited429s.Add(1);\n//                            }\n//                        }\n\n//                        // Persist MessageLogs (COPY sink)\n//                        var now = DateTime.UtcNow;\n//                        var runId = Guid.NewGuid();\n//                        var logId = Guid.NewGuid();\n\n//                        messageLogSink.Enqueue(new MessageLog\n//                        {\n//                            Id = logId,\n//                            BusinessId = job.BusinessId,\n//                            CampaignId = job.CampaignId,\n//                            RecipientNumber = recipientPhone,\n//                            MessageContent = job.TemplateName,\n//                            MediaUrl = job.HeaderMediaUrl,\n//                            Status = engineResult.Success ? \"Sent\" : \"Failed\",\n//                            MessageId = engineResult.MessageId,\n//                            ErrorMessage = engineResult.ErrorMessage,\n//                            RawResponse = engineResult.RawResponse,\n//                            CreatedAt = now,\n//                            SentAt = engineResult.Success ? now : (DateTime?)null,\n//                            Source = \"campaign\",\n//                            RunId = runId,\n//                            Provider = job.Provider,\n//                            ProviderMessageId = engineResult.MessageId,\n//                            IsIncoming = false,\n//                            IsChargeable=false\n//                        });\n\n//                        // Batched CampaignSendLog (COPY via sink)\n//                        logSink.Enqueue(new CampaignLogRecord(\n//                            Id: Guid.NewGuid(),\n//                            RunId: runId,\n//                            MessageId: engineResult.MessageId,\n//                            CampaignId: job.CampaignId,\n//                            ContactId: null,\n//                            RecipientId: job.RecipientId,\n//                            MessageBody: job.MessageBody ?? job.TemplateName,\n//                            TemplateId: job.TemplateName,\n//                            SendStatus: engineResult.Success ? \"Sent\" : \"Failed\",\n//                            ErrorMessage: engineResult.ErrorMessage,\n//                            CreatedAt: now,\n//                            CreatedBy: \"system\",\n//                            SentAt: engineResult.Success ? now : (DateTime?)null,\n//                            DeliveredAt: null,\n//                            ReadAt: null,\n//                            IpAddress: null,\n//                            DeviceInfo: null,\n//                            MacAddress: null,\n//                            SourceChannel: \"campaign\",\n//                            DeviceType: null,\n//                            Browser: null,\n//                            Country: null,\n//                            City: null,\n//                            IsClicked: false,\n//                            ClickedAt: null,\n//                            ClickType: null,\n//                            RetryCount: job.Attempt,\n//                            LastRetryAt: now,\n//                            LastRetryStatus: engineResult.Success ? \"Success\" : \"Failed\",\n//                            AllowRetry: job.Attempt < DEFAULT_MAX_ATTEMPTS,\n//                            MessageLogId: logId,\n//                            BusinessId: job.BusinessId,\n//                            CTAFlowConfigId: null,\n//                            CTAFlowStepId: null,\n//                            ButtonBundleJson: null\n//                        ));\n\n//                        // Update job (retry/backoff if needed)\n//                        job.Status = engineResult.Success ? \"Sent\" : \"Failed\";\n//                        job.Attempt += 1;\n//                        job.LastError = engineResult.ErrorMessage;\n\n//                        if (!engineResult.Success)\n//                        {\n//                            var backoffSecs = (int)Math.Min(60, Math.Pow(2, job.Attempt) * 2);\n//                            job.NextAttemptAt = DateTime.UtcNow.AddSeconds(backoffSecs);\n//                            MetricsRegistry.MessagesFailed.Add(1);\n//                        }\n//                        else\n//                        {\n//                            job.NextAttemptAt = null;\n//                            MetricsRegistry.MessagesSent.Add(1);\n//                        }\n\n//                        db.Update(job);\n//                        await db.SaveChangesAsync(ct);\n\n//                        // Async billing ingest (complete before scope disposed)\n//                        await billing.IngestFromSendResponseAsync(\n//                            job.BusinessId,\n//                            logId,\n//                            job.Provider,\n//                            engineResult.RawResponse ?? \"{}\"\n//                        );\n//                    }\n//                }\n//                catch (TaskCanceledException)\n//                {\n//                    // graceful shutdown\n//                }\n//                catch (Exception ex)\n//                {\n//                    try\n//                    {\n//                        using var scope = _sp.CreateScope();\n//                        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n//                        job.Status = \"Failed\";\n//                        job.Attempt += 1;\n//                        job.LastError = ex.Message;\n//                        var backoffSecs = (int)Math.Min(60, Math.Pow(2, job.Attempt) * 2);\n//                        job.NextAttemptAt = DateTime.UtcNow.AddSeconds(backoffSecs);\n//                        db.Update(job);\n//                        await db.SaveChangesAsync(ct);\n//                    }\n//                    catch { /* swallow */ }\n\n//                    MetricsRegistry.MessagesFailed.Add(1);\n//                    _log.LogError(ex, \"[Outbox] Consume error job={JobId}\", job.Id);\n//                }\n//            }\n//        }\n//    }\n//}\n\n\n\n\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignModule/Workers/OutboxReaperWorker.cs",
      "sha256": "62e23d9733ccd68ae2166ca2bc11a9b2024183cf0b91163984e6d7e40e7d2f15",
      "language": "csharp",
      "size": 3194,
      "content": "using Microsoft.EntityFrameworkCore;\n\nnamespace xbytechat.api.Features.CampaignModule.Workers\n{\n    public sealed class OutboxReaperWorker : BackgroundService\n    {\n        private readonly IServiceProvider _sp;\n        private readonly ILogger<OutboxReaperWorker> _log;\n\n        // How often we sweep\n        private static readonly TimeSpan SweepEvery = TimeSpan.FromSeconds(30);\n\n        // Keep in sync with your sender logic / DEFAULT_MAX_ATTEMPTS\n        private const int MAX_ATTEMPTS = 3;\n\n        public OutboxReaperWorker(IServiceProvider sp, ILogger<OutboxReaperWorker> log)\n        {\n            _sp = sp;\n            _log = log;\n        }\n\n        // OutboxReaperWorker.cs\n        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n        {\n            while (!stoppingToken.IsCancellationRequested)\n            {\n                try\n                {\n                    using var scope = _sp.CreateScope();\n                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n                    var now = DateTime.UtcNow;\n\n                    // ---- Recover stale InFlight jobs (no Random in the expression) ----\n                    var jitterSeconds = 2 + (int)((ulong)DateTime.UtcNow.Ticks % 3); // 2..4s\n                    var backoffAt = now.AddSeconds(jitterSeconds);\n\n                    var recovered = await db.OutboundMessageJobs\n                        .Where(j => j.Status == \"InFlight\" &&\n                                    j.NextAttemptAt != null &&\n                                    j.NextAttemptAt < now)\n                        .ExecuteUpdateAsync(s => s\n                            .SetProperty(j => j.Status, _ => \"Pending\")\n                            .SetProperty(j => j.NextAttemptAt, _ => backoffAt)\n                            .SetProperty(j => j.LastError, _ => \"Recovered from stale in-flight\"),\n                            stoppingToken);\n\n                    // ---- Kill over-retried jobs ----\n                    const int MAX_ATTEMPTS = 3;\n                    var killed = await db.OutboundMessageJobs\n                        .Where(j => (j.Status == \"Pending\" || j.Status == \"Failed\" || j.Status == \"InFlight\") &&\n                                    j.Attempt >= MAX_ATTEMPTS)\n                        .ExecuteUpdateAsync(s => s\n                            .SetProperty(j => j.Status, _ => \"Dead\")\n                            .SetProperty(j => j.NextAttemptAt, _ => (DateTime?)null)\n                            .SetProperty(j => j.LastError, _ => \"Max attempts exceeded\"),\n                            stoppingToken);\n\n                    if (recovered > 0 || killed > 0)\n                        _log.LogInformation(\"[OutboxReaper] recovered={Recovered} killed={Killed}\", recovered, killed);\n                }\n                catch (TaskCanceledException) { /* shutdown */ }\n                catch (Exception ex)\n                {\n                    _log.LogError(ex, \"[OutboxReaper] sweep failed\");\n                }\n\n                try { await Task.Delay(TimeSpan.FromSeconds(30), stoppingToken); }\n                catch (TaskCanceledException) { /* shutdown */ }\n            }\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Config/TrackingOptions.cs",
      "sha256": "76b42450eeb28f2d73ad6fc86ec956bc6e278f17ee17f5e517e0689e8a247483",
      "language": "csharp",
      "size": 337,
      "content": "// 📄 Features/CampaignTracking/Config/TrackingOptions.cs\nnamespace xbytechat.api.Features.CampaignTracking.Config\n{\n    public class TrackingOptions\n    {\n        public string BaseUrl { get; set; } = \"\";\n        public string Secret { get; set; } = \"\";\n        public TimeSpan TokenTtl { get; set; } = TimeSpan.FromDays(30);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Controllers/CampaignAnalyticsController.cs",
      "sha256": "7542c47e6bbe6d8117004542788bb0f078570eeae04c8045b385fc3b7eb5dde4",
      "language": "csharp",
      "size": 2494,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.Features.CampaignTracking.Services;\nusing xbytechat.api.Shared;\n\nnamespace xbytechat.api.Features.CampaignTracking.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    [Authorize]\n    public class CampaignAnalyticsController : BusinessControllerBase\n    {\n        private readonly ICampaignAnalyticsService _campaignAnalyticsService;\n        public CampaignAnalyticsController(ICampaignAnalyticsService svc) => _campaignAnalyticsService = svc;\n\n        [HttpGet(\"top-campaigns\")]\n        public async Task<IActionResult> GetTopCampaigns([FromQuery] int count = 5)\n            => Ok(await _campaignAnalyticsService.GetTopCampaignsAsync(BusinessId, count));\n    }\n}\n\n\n//using Microsoft.AspNetCore.Authorization;\n//using Microsoft.AspNetCore.Mvc;\n//using System.Security.Claims;\n//using xbytechat.api.Features.CampaignTracking.Services;\n\n//namespace xbytechat.api.Features.CampaignTracking.Controllers\n//{\n//    [ApiController]\n//    [Route(\"api/[controller]\")]\n//    [Authorize]\n//    public class CampaignAnalyticsController : ControllerBase\n//    {\n//        private readonly ICampaignAnalyticsService _campaignAnalyticsService;\n\n//        public CampaignAnalyticsController(ICampaignAnalyticsService campaignAnalyticsService)\n//        {\n//            _campaignAnalyticsService = campaignAnalyticsService;\n//        }\n\n//        [HttpGet(\"status-dashboard\")]\n//        //public async Task<IActionResult> GetStatusDashboard()\n//        //{\n//        //    var businessIdString = User.FindFirstValue(\"BusinessId\");\n//        //    if (!Guid.TryParse(businessIdString, out var businessId))\n//        //    {\n//        //        return Unauthorized(\"Invalid business identifier.\");\n//        //    }\n//        //    var result = await _campaignAnalyticsService.GetStatusDashboardAsync(businessId);\n//        //    return Ok(result);\n//        //}\n\n//        [HttpGet(\"top-campaigns\")]\n//        public async Task<IActionResult> GetTopCampaigns([FromQuery] int count = 5)\n//        {\n//            var businessIdString = User.FindFirstValue(\"BusinessId\");\n//            if (!Guid.TryParse(businessIdString, out var businessId))\n//            {\n//                return Unauthorized(\"Invalid business identifier.\");\n//            }\n//            var result = await _campaignAnalyticsService.GetTopCampaignsAsync(businessId, count);\n//            return Ok(result);\n//        }\n//    }\n//}"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Controllers/CampaignRetryController.cs",
      "sha256": "7fb4bd32c18410353886a39bebaf5c0c6e24ea48ce01a75d6bb0c553613438f8",
      "language": "csharp",
      "size": 1241,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing System;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignTracking.Services;\n\nnamespace xbytechat.api.Features.CampaignTracking.Controllers\n{\n    [ApiController]\n    [Authorize] // ✅ add this\n    [Route(\"api/campaign-retry\")]\n    public class CampaignRetryController : ControllerBase\n    {\n        private readonly ICampaignTrackingRetryService _retryService;\n\n        public CampaignRetryController(ICampaignTrackingRetryService retryService)\n        {\n            _retryService = retryService;\n        }\n\n        [HttpPost(\"{logId}/retry\")]\n        public async Task<IActionResult> RetrySingle(Guid logId)\n        {\n            var success = await _retryService.RetrySingleAsync(logId);\n            if (!success) return BadRequest(new { message = \"Retry failed or not allowed for this log.\" });\n            return Ok(new { success = true, message = \"Retry completed.\" });\n        }\n\n        [HttpPost(\"campaign/{campaignId}/retry-all\")]\n        public async Task<IActionResult> RetryAllInCampaign(Guid campaignId)\n            => Ok(new { success = true, retriedCount = await _retryService.RetryFailedInCampaignAsync(campaignId) });\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Controllers/CampaignSendLogController.cs",
      "sha256": "95a189e3fdcff8f648aef7e688a3e3ee83fb7147e59f77d78259862f9b99d84b",
      "language": "csharp",
      "size": 4499,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing System;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignTracking.DTOs;\nusing xbytechat.api.Features.CampaignTracking.Services;\n\nnamespace xbytechat.api.Features.CampaignTracking.Controllers\n{\n    [ApiController]\n    [Route(\"api/campaign-logs\")]\n    public class CampaignSendLogController : ControllerBase\n    {\n        private readonly ICampaignSendLogService _logService;\n        private readonly ICampaignTrackingRetryService _retryService;\n\n        public CampaignSendLogController(\n            ICampaignSendLogService logService,\n            ICampaignTrackingRetryService retryService\n        )\n        {\n            _logService = logService;\n            _retryService = retryService;\n        }\n\n        //[HttpGet(\"campaign/{campaignId}\")]\n        //public async Task<IActionResult> GetLogsByCampaign(Guid campaignId)\n        //{\n        //    var logs = await _logService.GetLogsByCampaignIdAsync(campaignId);\n        //    return Ok(logs);\n        //}\n        [HttpGet(\"campaign/{campaignId}\")]\n        public async Task<IActionResult> GetLogsByCampaign(\n         Guid campaignId,\n         [FromQuery] string? status,\n         [FromQuery] string? search,\n         [FromQuery] int page = 1,\n         [FromQuery] int pageSize = 10)\n        {\n            var result = await _logService.GetLogsByCampaignIdAsync(campaignId, status, search, page, pageSize);\n            return Ok(result);\n        }\n        [HttpGet(\"campaign/{campaignId}/contact/{contactId}\")]\n        public async Task<IActionResult> GetLogsForContact(Guid campaignId, Guid contactId)\n        {\n            var logs = await _logService.GetLogsForContactAsync(campaignId, contactId);\n            return Ok(logs);\n        }\n\n        [HttpPost]\n        public async Task<IActionResult> AddSendLog([FromBody] CampaignSendLogDto dto)\n        {\n            var ipAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? \"unknown\";\n            var userAgent = Request.Headers[\"User-Agent\"].ToString() ?? \"unknown\";\n\n            var result = await _logService.AddSendLogAsync(dto, ipAddress, userAgent);\n            if (!result)\n                return BadRequest(new { message = \"Failed to add send log\" });\n\n            return Ok(new { success = true });\n        }\n\n        [HttpPut(\"{logId}/status\")]\n        public async Task<IActionResult> UpdateDeliveryStatus(Guid logId, [FromBody] DeliveryStatusUpdateDto dto)\n        {\n            var result = await _logService.UpdateDeliveryStatusAsync(logId, dto.Status, dto.DeliveredAt, dto.ReadAt);\n            if (!result)\n                return NotFound(new { message = \"Log not found\" });\n\n            return Ok(new { success = true });\n        }\n\n        [HttpPut(\"{logId}/track-click\")]\n        public async Task<IActionResult> TrackClick(Guid logId, [FromBody] ClickTrackDto dto)\n        {\n            var result = await _logService.TrackClickAsync(logId, dto.ClickType);\n            if (!result)\n                return NotFound(new { message = \"Log not found\" });\n\n            return Ok(new { success = true });\n        }\n\n        // ✅ FIXED: Retry a single log using correct interface method\n        [HttpPost(\"{logId}/retry\")]\n        public async Task<IActionResult> RetrySingle(Guid logId)\n        {\n            var result = await _retryService.RetrySingleAsync(logId);\n            if (!result)\n                return BadRequest(new { message = \"Retry failed\" });\n\n            return Ok(new { success = true });\n        }\n\n        // ✅ FIXED: Retry all failed logs using correct interface method\n        [HttpPost(\"campaign/{campaignId}/retry-all\")]\n        public async Task<IActionResult> RetryAll(Guid campaignId)\n        {\n            var result = await _retryService.RetryFailedInCampaignAsync(campaignId);\n            return Ok(new { success = true, retried = result });\n        }\n        // ✅ FIXED: Get summary of campaign logs as per Campaign ID\n        [HttpGet(\"campaign/{campaignId}/summary\")]\n        public async Task<IActionResult> GetCampaignSummary(Guid campaignId)\n        {\n            var summary = await _logService.GetCampaignSummaryAsync(campaignId);\n            return Ok(summary);\n        }\n\n    }\n\n    public class DeliveryStatusUpdateDto\n    {\n        public string Status { get; set; }\n        public DateTime? DeliveredAt { get; set; }\n        public DateTime? ReadAt { get; set; }\n    }\n\n    public class ClickTrackDto\n    {\n        public string ClickType { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Controllers/CampaignTrackingController.cs",
      "sha256": "1e3e2b1e60144ec933cafdb53414ae6fad20463810533d32b90327dba457fde6",
      "language": "csharp",
      "size": 25258,
      "content": "// 📄 Features/CampaignTracking/Controllers/CampaignTrackingController.cs\nusing System.Text.Encodings.Web;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignTracking.Services;\nusing xbytechat.api.Features.CampaignTracking.Worker;\n\nnamespace xbytechat.api.Features.CampaignTracking.Controllers\n{\n    [ApiController]\n    [Route(\"r\")] // /r/{token}\n    public class CampaignTrackingController : ControllerBase\n    {\n        private static readonly HtmlEncoder HtmlEnc = HtmlEncoder.Default;\n\n        private readonly ILogger<CampaignTrackingController> _log;\n        private readonly IClickTokenService _token;\n        private readonly IClickEventQueue _queue;\n        private readonly AppDbContext _db;\n\n        public CampaignTrackingController(\n            ILogger<CampaignTrackingController> log,\n            IClickTokenService token,\n            IClickEventQueue queue,\n            AppDbContext db)\n        {\n            _log = log;\n            _token = token;\n            _queue = queue;\n            _db = db;\n        }\n\n        //[HttpGet(\"{token}\")]\n        //[AllowAnonymous]\n        //public async Task<IActionResult> RedirectByToken([FromRoute] string token, CancellationToken ct)\n        //{\n        //    // 1) Validate token\n        //    if (!_token.TryValidate(token, out var p, out var reason))\n        //    {\n        //        _log.LogWarning(\"Tracking token rejected. reason={Reason}\", reason);\n        //        return BadRequest(\"Invalid token.\");\n        //    }\n\n        //    // 2) Normalize + classify destination\n        //    if (!TryNormalizeAllowedDestination(p!.to, out var safeDest, out var scheme))\n        //    {\n        //        _log.LogWarning(\"Rejected destination for cid {Cid}: {Dest}\", p.cid, p.to);\n        //        return BadRequest(\"Invalid destination.\");\n        //    }\n\n        //    // 3) Capture client info\n        //    var ip = HttpContext.Connection.RemoteIpAddress?.ToString() ?? \"0.0.0.0\";\n        //    var ua = Request.Headers.UserAgent.ToString();\n        //    var now = DateTime.UtcNow;\n\n        //    // 4) Determine click type (web | call | whatsapp)\n        //    var clickType = ClassifyClickType(safeDest, scheme);\n\n        //    // 4.1) Fetch related ids from the send log (for ContactId & CampaignId)\n        //    Guid? contactId = null;\n        //    Guid campaignId = Guid.Empty;\n        //    try\n        //    {\n        //        var sendLog = await _db.CampaignSendLogs\n        //            .AsNoTracking()\n        //            .Where(x => x.Id == p.cid)\n        //            .Select(x => new { x.ContactId, x.CampaignId })\n        //            .FirstOrDefaultAsync(ct);\n\n        //        if (sendLog is not null)\n        //        {\n        //            contactId = sendLog.ContactId;\n        //            campaignId = sendLog.CampaignId;\n        //        }\n        //        else\n        //        {\n        //            _log.LogWarning(\"SendLog not found for click cid={Cid}\", p.cid);\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogError(ex, \"Failed to fetch ContactId/CampaignId for cid={Cid}\", p.cid);\n        //    }\n\n        //    // 5) Write-through (guaranteed persistence)\n        //    try\n        //    {\n        //        await _db.CampaignClickLogs.AddAsync(new CampaignClickLog\n        //        {\n        //            Id = Guid.NewGuid(),\n        //            CampaignSendLogId = p.cid,\n        //            CampaignId = campaignId,        // <-- populated if available (else Guid.Empty)\n        //            ContactId = contactId,          // <-- populated if available (nullable)\n        //            ButtonIndex = p.bi,\n        //            ButtonTitle = p.bt,\n        //            Destination = safeDest,\n        //            ClickedAt = now,\n        //            Ip = ip,\n        //            UserAgent = ua,\n        //            ClickType = clickType,\n        //            RunId = csl?.RunId\n        //        }, ct);\n\n        //        await _db.SaveChangesAsync(ct);\n\n        //        _log.LogInformation(\n        //            \"CLICK WRITE-THROUGH cid={Cid} idx={Idx} type={Type} dest={Dest}\",\n        //            p.cid, p.bi, clickType, safeDest);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogError(ex, \"Write-through insert failed. cid={Cid}\", p.cid);\n        //    }\n\n        //    // 6) Enqueue for async worker (best effort) — keeps existing ClickEvent signature\n        //    try\n        //    {\n        //        var enq = _queue.TryWrite(new ClickEvent(\n        //            CampaignSendLogId: p.cid,\n        //            ButtonIndex: p.bi,\n        //            ButtonTitle: p.bt,\n        //            Destination: safeDest,\n        //            ClickedAtUtc: now,\n        //            Ip: ip,\n        //            UserAgent: ua,\n        //            ClickType: clickType\n        //        ));\n        //        _log.LogInformation(\"CLICK ENQUEUE cid={Cid} idx={Idx} enqueued={Enqueued}\", p.cid, p.bi, enq);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogError(ex, \"Queue write threw. cid={Cid}\", p.cid);\n        //    }\n\n        //    // 7) First-click fast path\n        //    try\n        //    {\n        //        await _db.Database.ExecuteSqlRawAsync(\n        //            @\"update \"\"CampaignSendLogs\"\"\n        //                set \"\"IsClicked\"\"=TRUE, \"\"ClickedAt\"\"=NOW() at time zone 'utc'\n        //              where \"\"Id\"\"={0} and \"\"IsClicked\"\"=FALSE;\",\n        //            p.cid);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogDebug(ex, \"First-click update skipped.\");\n        //    }\n\n        //    // 8) Redirect handling\n        //    if (clickType is \"call\" or \"whatsapp\")\n        //    {\n        //        // Deep link → return an HTML/JS shim to trigger immediately, with a safe fallback link.\n        //        var destHtml = HtmlEnc.Encode(safeDest);\n        //        var destJs = JsEscape(safeDest);\n\n        //        var html = $@\"<!doctype html>\n        //        <html lang=\"\"en\"\">\n        //        <head>\n        //          <meta charset=\"\"utf-8\"\">\n        //          <meta http-equiv=\"\"x-ua-compatible\"\" content=\"\"ie=edge\"\">\n        //          <meta name=\"\"viewport\"\" content=\"\"width=device-width, initial-scale=1\"\">\n        //          <meta http-equiv=\"\"refresh\"\" content=\"\"0;url={destHtml}\"\">\n        //          <title>Redirecting…</title>\n        //          <style>\n        //            body{{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px;}}\n        //            a{{color:#2563eb;text-decoration:underline;}}\n        //          </style>\n        //          <script>\n        //            // Trigger deep link immediately; reveal fallback if blocked by the browser.\n        //            window.addEventListener('load', function() {{\n        //              try {{ window.location.replace('{destJs}'); }} catch (e) {{}}\n        //              setTimeout(function() {{\n        //                var f = document.getElementById('fallback');\n        //                if (f) f.style.display = 'inline';\n        //              }}, 1200);\n        //            }});\n        //          </script>\n        //        </head>\n        //        <body>\n        //          <p>Redirecting… If you are not redirected automatically, <a id=\"\"fallback\"\" style=\"\"display:none\"\" href=\"\"{destHtml}\"\">tap here</a>.</p>\n        //        </body>\n        //        </html>\";\n\n        //        Response.Headers[\"Cache-Control\"] = \"no-store, max-age=0\";\n        //        Response.Headers[\"Pragma\"] = \"no-cache\";\n        //        Response.Headers[\"X-Content-Type-Options\"] = \"nosniff\";\n        //        Response.Headers[\"Referrer-Policy\"] = \"no-referrer\";\n        //        Response.Headers[\"X-Frame-Options\"] = \"DENY\";\n        //        Response.Headers[\"Permissions-Policy\"] = \"geolocation=(), microphone=(), camera=()\";\n        //        Response.Headers[\"Content-Security-Policy\"] =\n        //            \"default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline'; base-uri 'none'; frame-ancestors 'none'\";\n\n        //        return new ContentResult\n        //        {\n        //            Content = html,\n        //            ContentType = \"text/html; charset=utf-8\",\n        //            StatusCode = 200\n        //        };\n        //    }\n\n        //    // Regular web links → normal 302\n        //    return Redirect(safeDest);\n        //}\n\n        // --- helpers ---\n\n\n        //[HttpGet(\"{token}\")]\n        //[AllowAnonymous]\n\n\n        //[HttpGet(\"{token}\")]\n        //[AllowAnonymous]\n\n        [HttpGet(\"{token}\")]\n        [AllowAnonymous]\n        public async Task<IActionResult> RedirectByToken([FromRoute] string token, CancellationToken ct)\n        {\n            // 1) Validate token\n            if (!_token.TryValidate(token, out var p, out var reason))\n            {\n                _log.LogWarning(\"Tracking token rejected. reason={Reason}\", reason);\n                return BadRequest(\"Invalid token.\");\n            }\n\n            // 2) Normalize + classify destination\n            if (!TryNormalizeAllowedDestination(p!.to, out var safeDest, out var scheme))\n            {\n                _log.LogWarning(\"Rejected destination for cid {Cid}: {Dest}\", p.cid, p.to);\n                return BadRequest(\"Invalid destination.\");\n            }\n\n            // 3) Capture client info\n            var ip = HttpContext.Connection.RemoteIpAddress?.ToString() ?? \"0.0.0.0\";\n            var ua = Request.Headers.UserAgent.ToString();\n            var now = DateTime.UtcNow;\n\n            // 4) Determine click type (web | call | whatsapp)\n            var clickType = ClassifyClickType(safeDest, scheme);\n\n            // 4.1) Fetch related ids from the send log (ContactId, CampaignId, RunId)\n            Guid? contactId = null;\n            Guid? campaignId = null;   // <- make this nullable\n            Guid? runId = null;\n\n            try\n            {\n                var sendLog = await _db.CampaignSendLogs\n                    .AsNoTracking()\n                    .Where(x => x.Id == p.cid)\n                    .Select(x => new { x.ContactId, x.CampaignId, x.RunId })\n                    .FirstOrDefaultAsync(ct);\n\n                if (sendLog is not null)\n                {\n                    contactId = sendLog.ContactId;   // Guid?\n                    campaignId = sendLog.CampaignId;  // Guid?\n                    runId = sendLog.RunId;       // Guid?\n                }\n                else\n                {\n                    _log.LogWarning(\"SendLog not found for click cid={Cid}\", p.cid);\n                }\n            }\n            catch (Exception ex)\n            {\n                _log.LogError(ex, \"Failed to fetch ContactId/CampaignId/RunId for cid={Cid}\", p.cid);\n            }\n\n            // 5) Write-through (guaranteed persistence)\n            try\n            {\n                await _db.CampaignClickLogs.AddAsync(new CampaignClickLog\n                {\n                    Id = Guid.NewGuid(),\n                    CampaignSendLogId = p.cid,\n                    // If the column is NON-nullable, coalesce to Guid.Empty; if you've made it nullable, assign campaignId directly.\n                    CampaignId = campaignId ?? Guid.Empty,\n                    ContactId = contactId,    // nullable OK\n                    ButtonIndex = p.bi,\n                    ButtonTitle = p.bt,\n                    Destination = safeDest,\n                    ClickedAt = now,\n                    Ip = ip,\n                    UserAgent = ua,\n                    ClickType = clickType,\n                    RunId = runId\n                }, ct);\n\n                await _db.SaveChangesAsync(ct);\n\n                _log.LogInformation(\"CLICK WRITE-THROUGH cid={Cid} idx={Idx} type={Type} dest={Dest}\",\n                    p.cid, p.bi, clickType, safeDest);\n            }\n            catch (Exception ex)\n            {\n                _log.LogError(ex, \"Write-through insert failed. cid={Cid}\", p.cid);\n            }\n\n            // 6) Enqueue for async worker (best effort)\n            try\n            {\n                var enq = _queue.TryWrite(new ClickEvent(\n                    CampaignSendLogId: p.cid,\n                    ButtonIndex: p.bi,\n                    ButtonTitle: p.bt,\n                    Destination: safeDest,\n                    ClickedAtUtc: now,\n                    Ip: ip,\n                    UserAgent: ua,\n                    ClickType: clickType\n                ));\n                _log.LogInformation(\"CLICK ENQUEUE cid={Cid} idx={Idx} enqueued={Enqueued}\", p.cid, p.bi, enq);\n            }\n            catch (Exception ex)\n            {\n                _log.LogError(ex, \"Queue write threw. cid={Cid}\", p.cid);\n            }\n\n            // 7) First-click fast path\n            try\n            {\n                await _db.Database.ExecuteSqlRawAsync(\n                    @\"update \"\"CampaignSendLogs\"\"\n              set \"\"IsClicked\"\"=TRUE,\n                  \"\"ClickedAt\"\"=NOW() at time zone 'utc',\n                  \"\"ClickType\"\"={1}\n              where \"\"Id\"\"={0} and \"\"IsClicked\"\"=FALSE;\",\n                    p.cid, clickType);\n            }\n            catch (Exception ex)\n            {\n                _log.LogDebug(ex, \"First-click update skipped.\");\n            }\n\n            // 8) Redirect handling\n            if (clickType is \"call\" or \"whatsapp\")\n            {\n                // ... (unchanged deep-link HTML)\n            }\n\n            return Redirect(safeDest);\n        }\n\n        //public async Task<IActionResult> RedirectByToken([FromRoute] string token, CancellationToken ct)\n        //{\n        //    // 1) Validate token\n        //    if (!_token.TryValidate(token, out var p, out var reason))\n        //    {\n        //        _log.LogWarning(\"Tracking token rejected. reason={Reason}\", reason);\n        //        return BadRequest(\"Invalid token.\");\n        //    }\n\n        //    // 2) Normalize + classify destination\n        //    if (!TryNormalizeAllowedDestination(p!.to, out var safeDest, out var scheme))\n        //    {\n        //        _log.LogWarning(\"Rejected destination for cid {Cid}: {Dest}\", p.cid, p.to);\n        //        return BadRequest(\"Invalid destination.\");\n        //    }\n\n        //    // 3) Capture client info\n        //    var ip = HttpContext.Connection.RemoteIpAddress?.ToString() ?? \"0.0.0.0\";\n        //    var ua = Request.Headers.UserAgent.ToString();\n        //    var now = DateTime.UtcNow;\n\n        //    // 4) Determine click type (web | call | whatsapp)\n        //    var clickType = ClassifyClickType(safeDest, scheme);\n\n        //    // 4.1) Fetch related ids from the send log (ContactId, CampaignId, **RunId**)\n        //    Guid? contactId = null;\n        //    Guid campaignId = Guid.Empty;\n        //    Guid? runId = null; // 👈 NEW\n\n        //    try\n        //    {\n        //        var sendLog = await _db.CampaignSendLogs\n        //            .AsNoTracking()\n        //            .Where(x => x.Id == p.cid)\n        //            .Select(x => new { x.ContactId, x.CampaignId, x.RunId })\n        //            .FirstOrDefaultAsync(ct);\n\n        //        if (sendLog is not null)\n        //        {\n        //            contactId = sendLog.ContactId;\n        //            campaignId = sendLog.CampaignId;\n        //            runId = sendLog.RunId; // 👈 carry through to click log\n        //        }\n        //        else\n        //        {\n        //            _log.LogWarning(\"SendLog not found for click cid={Cid}\", p.cid);\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogError(ex, \"Failed to fetch ContactId/CampaignId/RunId for cid={Cid}\", p.cid);\n        //    }\n\n        //    // 5) Write-through (guaranteed persistence)\n        //    try\n        //    {\n        //        await _db.CampaignClickLogs.AddAsync(new CampaignClickLog\n        //        {\n        //            Id = Guid.NewGuid(),\n        //            CampaignSendLogId = p.cid,\n        //            CampaignId = campaignId,   // populated if available (else Guid.Empty)\n        //            ContactId = contactId,     // nullable\n        //            ButtonIndex = p.bi,\n        //            ButtonTitle = p.bt,\n        //            Destination = safeDest,\n        //            ClickedAt = now,\n        //            Ip = ip,\n        //            UserAgent = ua,\n        //            ClickType = clickType,\n        //            RunId = runId              // 👈 bind click to the same run/session\n        //        }, ct);\n\n        //        await _db.SaveChangesAsync(ct);\n\n        //        _log.LogInformation(\n        //            \"CLICK WRITE-THROUGH cid={Cid} idx={Idx} type={Type} dest={Dest}\",\n        //            p.cid, p.bi, clickType, safeDest);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogError(ex, \"Write-through insert failed. cid={Cid}\", p.cid);\n        //    }\n\n        //    // 6) Enqueue for async worker (best effort) — keeps existing ClickEvent signature\n        //    try\n        //    {\n        //        var enq = _queue.TryWrite(new ClickEvent(\n        //            CampaignSendLogId: p.cid,\n        //            ButtonIndex: p.bi,\n        //            ButtonTitle: p.bt,\n        //            Destination: safeDest,\n        //            ClickedAtUtc: now,\n        //            Ip: ip,\n        //            UserAgent: ua,\n        //            ClickType: clickType\n        //        ));\n        //        _log.LogInformation(\"CLICK ENQUEUE cid={Cid} idx={Idx} enqueued={Enqueued}\", p.cid, p.bi, enq);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogError(ex, \"Queue write threw. cid={Cid}\", p.cid);\n        //    }\n\n        //    // 7) First-click fast path (also writes ClickType)\n        //    try\n        //    {\n        //        await _db.Database.ExecuteSqlRawAsync(\n        //            @\"update \"\"CampaignSendLogs\"\"\n        //        set \"\"IsClicked\"\"=TRUE,\n        //            \"\"ClickedAt\"\"=NOW() at time zone 'utc',\n        //            \"\"ClickType\"\"={1}\n        //      where \"\"Id\"\"={0} and \"\"IsClicked\"\"=FALSE;\",\n        //            p.cid, clickType);\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _log.LogDebug(ex, \"First-click update skipped.\");\n        //    }\n\n        //    // 8) Redirect handling\n        //    if (clickType is \"call\" or \"whatsapp\")\n        //    {\n        //        // Deep link → return an HTML/JS shim to trigger immediately, with a safe fallback link.\n        //        var destHtml = HtmlEnc.Encode(safeDest);\n        //        var destJs = JsEscape(safeDest);\n\n        //        var html = $@\"<!doctype html>\n        //                <html lang=\"\"en\"\">\n        //                <head>\n        //                  <meta charset=\"\"utf-8\"\">\n        //                  <meta http-equiv=\"\"x-ua-compatible\"\" content=\"\"ie=edge\"\">\n        //                  <meta name=\"\"viewport\"\" content=\"\"width=device-width, initial-scale=1\"\">\n        //                  <meta http-equiv=\"\"refresh\"\" content=\"\"0;url={destHtml}\"\">\n        //                  <title>Redirecting…</title>\n        //                  <style>\n        //                    body{{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px;}}\n        //                    a{{color:#2563eb;text-decoration:underline;}}\n        //                  </style>\n        //                  <script>\n        //                    // Trigger deep link immediately; reveal fallback if blocked by the browser.\n        //                    window.addEventListener('load', function() {{\n        //                      try {{ window.location.replace('{destJs}'); }} catch (e) {{}}\n        //                      setTimeout(function() {{\n        //                        var f = document.getElementById('fallback');\n        //                        if (f) f.style.display = 'inline';\n        //                      }}, 1200);\n        //                    }});\n        //                  </script>\n        //                </head>\n        //                <body>\n        //                  <p>Redirecting… If you are not redirected automatically, <a id=\"\"fallback\"\" style=\"\"display:none\"\" href=\"\"{destHtml}\"\">tap here</a>.</p>\n        //                </body>\n        //                </html>\";\n\n        //        Response.Headers[\"Cache-Control\"] = \"no-store, max-age=0\";\n        //        Response.Headers[\"Pragma\"] = \"no-cache\";\n        //        Response.Headers[\"X-Content-Type-Options\"] = \"nosniff\";\n        //        Response.Headers[\"Referrer-Policy\"] = \"no-referrer\";\n        //        Response.Headers[\"X-Frame-Options\"] = \"DENY\";\n        //        Response.Headers[\"Permissions-Policy\"] = \"geolocation=(), microphone=(), camera=()\";\n        //        Response.Headers[\"Content-Security-Policy\"] =\n        //            \"default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline'; base-uri 'none'; frame-ancestors 'none'\";\n\n        //        return new ContentResult\n        //        {\n        //            Content = html,\n        //            ContentType = \"text/html; charset=utf-8\",\n        //            StatusCode = 200\n        //        };\n        //    }\n\n        //    // Regular web links → normal 302\n        //    return Redirect(safeDest);\n        //}\n\n\n        private static string ClassifyClickType(string normalizedDest, string scheme)\n        {\n            // scheme is pre-normalized by TryNormalizeAllowedDestination\n            if (string.Equals(scheme, \"tel\", StringComparison.OrdinalIgnoreCase)) return \"call\";\n            if (string.Equals(scheme, \"wa\", StringComparison.OrdinalIgnoreCase)) return \"whatsapp\";\n            if (string.Equals(scheme, \"whatsapp\", StringComparison.OrdinalIgnoreCase)) return \"whatsapp\";\n\n            // http/https → still treat WhatsApp hosts as whatsapp\n            if (normalizedDest.StartsWith(\"https://wa.me/\", StringComparison.OrdinalIgnoreCase)) return \"whatsapp\";\n            if (normalizedDest.StartsWith(\"https://api.whatsapp.com/\", StringComparison.OrdinalIgnoreCase)) return \"whatsapp\";\n\n            return \"web\";\n        }\n\n        private static string JsEscape(string s) =>\n            s.Replace(\"\\\\\", \"\\\\\\\\\").Replace(\"'\", \"\\\\'\").Replace(\"\\r\", \"\").Replace(\"\\n\", \"\");\n\n        /// <summary>\n        /// Accepts: http/https/tel/wa/whatsapp, plus shorthand wa.me/... and api.whatsapp.com/...\n        /// Returns normalized absolute string and a normalized scheme hint (\"http\",\"https\",\"tel\",\"wa\",\"whatsapp\").\n        /// </summary>\n        private static bool TryNormalizeAllowedDestination(string? input, out string normalized, out string scheme)\n        {\n            normalized = string.Empty;\n            scheme = string.Empty;\n            if (string.IsNullOrWhiteSpace(input)) return false;\n\n            var cleaned = new string(input.Trim().Where(c => !char.IsControl(c)).ToArray());\n\n            // Shorthand WhatsApp hosts without scheme → prefix https://\n            if (!cleaned.Contains(\"://\", StringComparison.Ordinal))\n            {\n                if (cleaned.StartsWith(\"wa.me/\", StringComparison.OrdinalIgnoreCase) ||\n                    cleaned.StartsWith(\"api.whatsapp.com/\", StringComparison.OrdinalIgnoreCase))\n                {\n                    var guess = \"https://\" + cleaned;\n                    if (Uri.TryCreate(guess, UriKind.Absolute, out var waAbs))\n                    {\n                        normalized = waAbs.AbsoluteUri;\n                        scheme = \"https\";\n                        return true;\n                    }\n                }\n            }\n\n            // WhatsApp custom schemes (wa:, whatsapp:)\n            if (cleaned.StartsWith(\"wa:\", StringComparison.OrdinalIgnoreCase))\n            {\n                normalized = cleaned; scheme = \"wa\"; return true;\n            }\n            if (cleaned.StartsWith(\"whatsapp:\", StringComparison.OrdinalIgnoreCase))\n            {\n                normalized = cleaned; scheme = \"whatsapp\"; return true;\n            }\n\n            // Absolute URIs\n            if (Uri.TryCreate(cleaned, UriKind.Absolute, out var uri))\n            {\n                // tel:\n                if (uri.Scheme.Equals(\"tel\", StringComparison.OrdinalIgnoreCase))\n                {\n                    normalized = uri.ToString(); scheme = \"tel\"; return true;\n                }\n\n                // http/https (including WhatsApp hosts)\n                if (uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase) ||\n                    uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase))\n                {\n                    normalized = uri.AbsoluteUri;\n                    scheme = uri.Scheme; // \"http\" or \"https\"\n                    return true;\n                }\n            }\n\n            return false;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/DTOs/CampaignLogSummaryDto.cs",
      "sha256": "57aa29e375f6dda32b73602de1a84e9d5e89e3f8bf103914b21bfa14f0b786a9",
      "language": "csharp",
      "size": 415,
      "content": "namespace xbytechat.api.Features.CampaignTracking.DTOs\n{\n    public class CampaignLogSummaryDto\n    {\n        public int TotalSent { get; set; }\n        public int FailedCount { get; set; }\n        public int ClickedCount { get; set; }\n        public DateTime? LastSentAt { get; set; }\n\n        public int Delivered { get; set; }\n        public int Read { get; set; }\n        public int Sent { get; set; }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/DTOs/CampaignSendLogDto.cs",
      "sha256": "e4401d635c37b8b9990e5b0b8137ffe065550330c45ccf4638e336b803e6c5cf",
      "language": "csharp",
      "size": 1730,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignTracking.DTOs\n{\n    public class CampaignSendLogDto\n    {\n        public Guid Id { get; set; }\n\n        // 🔗 Relationships\n        public Guid CampaignId { get; set; }\n        public Guid? ContactId { get; set; }\n        public string ContactName { get; set; }\n        public string ContactPhone { get; set; }\n\n        public string? RecipientNumber { get; set; }\n        // 📤 Message Info\n        public Guid RecipientId { get; set; }\n        public string MessageBody { get; set; }\n        public string? TemplateId { get; set; }\n        public string? SendStatus { get; set; }\n        public string? ErrorMessage { get; set; }\n\n        // 🕒 Timestamps\n        public DateTime CreatedAt { get; set; }\n        public DateTime? SentAt { get; set; }\n        public DateTime? DeliveredAt { get; set; }\n        public DateTime? ReadAt { get; set; }\n\n        // 🌐 Metadata\n        public string? SourceChannel { get; set; }\n        public string? IpAddress { get; set; }\n        public string? DeviceInfo { get; set; }\n        public string? MacAddress { get; set; }\n\n        // ✅ Enriched metadata\n        public string? DeviceType { get; set; }\n        public string? Browser { get; set; }\n        public string? Country { get; set; }\n        public string? City { get; set; }\n\n        // 📈 Click Tracking\n        public bool IsClicked { get; set; }\n        public DateTime? ClickedAt { get; set; }\n        public string? ClickType { get; set; }\n\n        // 🔁 Retry Info\n        public string? RetryStatus { get; set; }     // Pending, Retried, Skipped\n        public int RetryCount { get; set; }\n        public DateTime? LastRetryAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/DTOs/CampaignStatusDashboardDto.cs",
      "sha256": "21979b3b1de98ab2567e6485c9c0e4684b848735d36743226caaca66504e9b7b",
      "language": "csharp",
      "size": 1038,
      "content": "namespace xbytechat.api.Features.CampaignTracking.DTOs\n{\n    public class CampaignStatusDashboardDto\n    {\n        public Guid CampaignId { get; set; }\n\n        // 📊 Overall Stats\n        public int TotalRecipients { get; set; }\n        public int SentCount { get; set; }\n        public int DeliveredCount { get; set; }\n        public int ReadCount { get; set; }\n        public int FailedCount { get; set; }\n\n        // 🕒 Delivery Timing (optional but insightful)\n        public DateTime? FirstSentAt { get; set; }\n        public DateTime? LastSentAt { get; set; }\n        public DateTime? FirstReadAt { get; set; }\n        public DateTime? LastReadAt { get; set; }\n\n        // 📉 Delivery Rates\n        public double DeliveryRate => TotalRecipients == 0 ? 0 : (double)DeliveredCount / TotalRecipients * 100;\n        public double ReadRate => TotalRecipients == 0 ? 0 : (double)ReadCount / TotalRecipients * 100;\n        public double FailureRate => TotalRecipients == 0 ? 0 : (double)FailedCount / TotalRecipients * 100;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/DTOs/TopCampaignDto.cs",
      "sha256": "deebf224725de4a79f8363405623b0761fed9b776ec86cc8d6a9b05c5f79940e",
      "language": "csharp",
      "size": 295,
      "content": "namespace xbytechat.api.Features.CampaignTracking.DTOs\n{\n    public class TopCampaignDto\n    {\n        public Guid CampaignId { get; set; }\n        public string CampaignName { get; set; }\n        public double ReadRate { get; set; }\n        public double ClickThroughRate { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/EntityTypeConfigs/CampaignSendLogConfig.cs",
      "sha256": "cf880a46e9114af3187c8c4cd1f11e526a5b0c83fc9894ebc8dc39075e937247",
      "language": "csharp",
      "size": 1967,
      "content": "using Microsoft.EntityFrameworkCore;\nusing Microsoft.EntityFrameworkCore.Metadata.Builders;\nusing xbytechat.api.Features.CampaignTracking.Models;\n\nnamespace xbytechat.api.Features.CampaignTracking.EntityTypeConfigs\n{\n    public class CampaignSendLogConfig : IEntityTypeConfiguration<CampaignSendLog>\n    {\n        public void Configure(EntityTypeBuilder<CampaignSendLog> e)\n        {\n            e.ToTable(\"CampaignSendLogs\"); // your table name\n            e.HasKey(x => x.Id);\n\n            // common lengths to keep COPY happy (adjust if you already have constraints)\n            e.Property(x => x.MessageId).HasMaxLength(128);\n            e.Property(x => x.TemplateId).HasMaxLength(128);\n            e.Property(x => x.SendStatus).HasMaxLength(32);\n            e.Property(x => x.ErrorMessage).HasMaxLength(1024);\n            e.Property(x => x.CreatedBy).HasMaxLength(128);\n            e.Property(x => x.IpAddress).HasMaxLength(64);\n            e.Property(x => x.DeviceInfo).HasMaxLength(256);\n            e.Property(x => x.MacAddress).HasMaxLength(64);\n            e.Property(x => x.SourceChannel).HasMaxLength(64);\n            e.Property(x => x.DeviceType).HasMaxLength(64);\n            e.Property(x => x.Browser).HasMaxLength(64);\n            e.Property(x => x.Country).HasMaxLength(64);\n            e.Property(x => x.City).HasMaxLength(64);\n            e.Property(x => x.ClickType).HasMaxLength(64);\n            e.Property(x => x.LastRetryStatus).HasMaxLength(32);\n\n            // CreatedAt default (UTC) if not set by code\n            e.Property(x => x.CreatedAt).HasDefaultValueSql(\"timezone('utc', now())\");\n\n            // helpful indexes\n            e.HasIndex(x => new { x.BusinessId, x.CampaignId, x.CreatedAt });\n            e.HasIndex(x => new { x.CampaignId, x.SendStatus, x.CreatedAt });\n            e.HasIndex(x => new { x.RecipientId, x.CreatedAt });\n            e.HasIndex(x => x.MessageId);\n            e.HasIndex(x => x.RunId);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Logging/CampaignLogFlushWorker.cs",
      "sha256": "b00af09909773fe5a42fec957467b0749da9ef01e66ee094928dde050277ac59",
      "language": "csharp",
      "size": 1106,
      "content": "using Microsoft.Extensions.Hosting;\nusing Microsoft.Extensions.Logging;\nusing Microsoft.Extensions.Options;\n\nnamespace xbytechat.api.Features.CampaignTracking.Logging\n{\n    public class CampaignLogFlushWorker : BackgroundService\n    {\n        private readonly ICampaignLogSink _sink;\n        private readonly ILogger<CampaignLogFlushWorker> _log;\n        private readonly IOptionsMonitor<BatchingOptions> _opts;\n\n        public CampaignLogFlushWorker(ICampaignLogSink sink, ILogger<CampaignLogFlushWorker> log, IOptionsMonitor<BatchingOptions> opts)\n        {\n            _sink = sink; _log = log; _opts = opts;\n        }\n\n        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n        {\n            while (!stoppingToken.IsCancellationRequested)\n            {\n                try { await _sink.FlushAsync(stoppingToken); }\n                catch (Exception ex) { _log.LogError(ex, \"[CampaignLogFlushWorker] flush error\"); }\n                await Task.Delay(TimeSpan.FromMilliseconds(_opts.CurrentValue.CampaignLog.FlushEveryMs), stoppingToken);\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Logging/CampaignLogRecord.cs",
      "sha256": "777772c74a122cabcaf3c59ae1aac8fd43c7b97b6d562d5c239921ed24c47be5",
      "language": "csharp",
      "size": 1067,
      "content": "using System;\n\nnamespace xbytechat.api.Features.CampaignTracking.Logging\n{\n    public record CampaignLogRecord(\n        Guid Id,\n        Guid? RunId,\n        string? MessageId,\n        Guid CampaignId,\n        Guid? ContactId,\n        Guid RecipientId,\n        string MessageBody,\n        string? TemplateId,\n        string? SendStatus,\n        string? ErrorMessage,\n        DateTime CreatedAt,\n        string? CreatedBy,\n        DateTime? SentAt,\n        DateTime? DeliveredAt,\n        DateTime? ReadAt,\n        string? IpAddress,\n        string? DeviceInfo,\n        string? MacAddress,\n        string? SourceChannel,\n        string? DeviceType,\n        string? Browser,\n        string? Country,\n        string? City,\n        bool IsClicked,\n        DateTime? ClickedAt,\n        string? ClickType,\n        int RetryCount,\n        DateTime? LastRetryAt,\n        string? LastRetryStatus,\n        bool AllowRetry,\n        Guid? MessageLogId,\n        Guid BusinessId,\n        Guid? CTAFlowConfigId,\n        Guid? CTAFlowStepId,\n        string? ButtonBundleJson\n    );\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Logging/CampaignLogSink.cs",
      "sha256": "1cb036d202b67bf8fdaa1e5f217c0c8c728b1ec98ec090f4bfbcfd40e46f3bc7",
      "language": "csharp",
      "size": 12526,
      "content": "using System.Collections.Concurrent;\nusing Microsoft.EntityFrameworkCore;\nusing System.Linq;\nusing Microsoft.Extensions.Logging;\nusing Microsoft.Extensions.Options;\nusing Npgsql;\nusing NpgsqlTypes;\nusing xbytechat.api.Features.CampaignTracking.Models; // CampaignSendLog\nusing xbytechat.api.AuthModule.Models;               // AppDbContext\n\nnamespace xbytechat.api.Features.CampaignTracking.Logging\n{\n    public class CampaignLogSink : ICampaignLogSink\n    {\n        private readonly ConcurrentQueue<CampaignLogRecord> _queue = new();\n        private readonly ConcurrentDictionary<Guid, int> _attempts = new();\n        private readonly ILogger<CampaignLogSink> _log;\n        private readonly IServiceProvider _sp;\n        private readonly IOptionsMonitor<BatchingOptions> _opts;\n\n        private const int MaxAttempts = 3;\n\n        public CampaignLogSink(ILogger<CampaignLogSink> log, IServiceProvider sp, IOptionsMonitor<BatchingOptions> opts)\n        {\n            _log = log; _sp = sp; _opts = opts;\n        }\n\n        public void Enqueue(CampaignLogRecord rec) => _queue.Enqueue(rec);\n        public int PendingCount => _queue.Count;\n\n        public async Task FlushAsync(CancellationToken ct = default)\n        {\n            var max = _opts.CurrentValue.CampaignLog.MaxBatchSize;\n            var list = new List<CampaignLogRecord>(Math.Min(_queue.Count, max));\n            while (list.Count < max && _queue.TryDequeue(out var r)) list.Add(r);\n            if (list.Count == 0) return;\n\n            try\n            {\n                // Ensure all referenced MessageLogs exist before inserting send logs\n                var messageLogIds = list\n                    .Select(x => x.MessageLogId)\n                    .Where(id => id.HasValue && id.Value != Guid.Empty)\n                    .Select(id => id!.Value)\n                    .Distinct()\n                    .ToList();\n\n                _log.LogInformation(\n                    \"[CampaignLogSink] Batch size = {BatchCount}, messageLogIds = {IdCount}\",\n                    list.Count, messageLogIds.Count);\n\n                if (messageLogIds.Count > 0)\n                {\n                    using var scope = _sp.CreateScope();\n                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n                    var existingIds = await db.MessageLogs\n                        .AsNoTracking()\n                        .Where(m => messageLogIds.Contains(m.Id))\n                        .Select(m => m.Id)\n                        .ToListAsync(ct);\n\n                    var missing = messageLogIds.Except(existingIds).ToList();\n                    if (missing.Count > 0)\n                    {\n                        // Use first record Id as batch key\n                        var batchKey = list[0].Id;\n                        var attempt = _attempts.AddOrUpdate(batchKey, 1, (_, prev) => prev + 1);\n\n                        if (attempt <= MaxAttempts)\n                        {\n                            _log.LogWarning(\n                                \"[CampaignLogSink] Deferring batch (attempt {Attempt}/{Max}) – messageLogIds={Ids} missingCount={MissingCount}\",\n                                attempt, MaxAttempts, string.Join(\",\", messageLogIds), missing.Count);\n                            foreach (var item in list) _queue.Enqueue(item);\n                            return;\n                        }\n\n                        _log.LogError(\n                            \"[CampaignLogSink] Dropping batch after {MaxAttempts} attempts – still missing messageLogIds={Ids}\",\n                            MaxAttempts, string.Join(\",\", messageLogIds));\n                        _attempts.TryRemove(batchKey, out _);\n                        return; // drop to avoid FK violations / infinite loop\n                    }\n\n                    // All required MessageLogs exist; clear attempts for this batch key\n                    _attempts.TryRemove(list[0].Id, out _);\n                }\n\n                if (_opts.CurrentValue.CampaignLog.UseCopy)\n                    await CopyInsertAsync(list, ct);\n                else\n                    await EfInsertAsync(list, ct);\n            }\n            catch (Exception ex)\n            {\n                _log.LogError(ex, \"[CampaignLogSink] COPY failed; falling back to EF\");\n                try { await EfInsertAsync(list, ct); }\n                catch (Exception ex2)\n                {\n                    _log.LogError(ex2, \"[CampaignLogSink] EF fallback failed; requeueing {Count}\", list.Count);\n                    foreach (var rr in list) _queue.Enqueue(rr);\n                }\n            }\n        }\n\n        private static void WriteNullable<T>(NpgsqlBinaryImporter w, T? value, NpgsqlDbType type) where T : struct\n        {\n            if (value.HasValue) w.Write(value.Value, type);\n            else w.WriteNull();\n        }\n\n        private static void WriteNullableText(NpgsqlBinaryImporter w, string? value)\n        {\n            if (string.IsNullOrWhiteSpace(value)) w.WriteNull();\n            else w.Write(value, NpgsqlDbType.Text);\n        }\n\n        private static void WriteNullableVarchar(NpgsqlBinaryImporter w, string? value)\n        {\n            if (string.IsNullOrWhiteSpace(value)) w.WriteNull();\n            else w.Write(value, NpgsqlDbType.Varchar);\n        }\n\n        private static void WriteNullableUuid(NpgsqlBinaryImporter w, Guid? value)\n        {\n            if (value.HasValue && value.Value != Guid.Empty) w.Write(value.Value, NpgsqlDbType.Uuid);\n            else w.WriteNull();\n        }\n\n        private async Task CopyInsertAsync(List<CampaignLogRecord> batch, CancellationToken ct)\n        {\n            using var scope = _sp.CreateScope();\n            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n            var connString = db.Database.GetDbConnection().ConnectionString;\n\n            await using var conn = new NpgsqlConnection(connString);\n            await conn.OpenAsync(ct);\n\n            const string sql = @\"\nCOPY \"\"CampaignSendLogs\"\" (\n    \"\"Id\"\",\n    \"\"RunId\"\",\n    \"\"MessageId\"\",\n    \"\"CampaignId\"\",\n    \"\"ContactId\"\",\n    \"\"RecipientId\"\",\n    \"\"MessageBody\"\",\n    \"\"TemplateId\"\",\n    \"\"SendStatus\"\",\n    \"\"ErrorMessage\"\",\n    \"\"CreatedAt\"\",\n    \"\"CreatedBy\"\",\n    \"\"SentAt\"\",\n    \"\"DeliveredAt\"\",\n    \"\"ReadAt\"\",\n    \"\"IpAddress\"\",\n    \"\"DeviceInfo\"\",\n    \"\"MacAddress\"\",\n    \"\"SourceChannel\"\",\n    \"\"DeviceType\"\",\n    \"\"Browser\"\",\n    \"\"Country\"\",\n    \"\"City\"\",\n    \"\"IsClicked\"\",\n    \"\"ClickedAt\"\",\n    \"\"ClickType\"\",\n    \"\"RetryCount\"\",\n    \"\"LastRetryAt\"\",\n    \"\"LastRetryStatus\"\",\n    \"\"AllowRetry\"\",\n    \"\"MessageLogId\"\",\n    \"\"BusinessId\"\",\n    \"\"CTAFlowConfigId\"\",\n    \"\"CTAFlowStepId\"\",\n    \"\"ButtonBundleJson\"\"\n) FROM STDIN (FORMAT BINARY);\";\n\n            try\n            {\n                await using var writer = await conn.BeginBinaryImportAsync(sql, ct);\n\n                foreach (var r in batch)\n                {\n                    await writer.StartRowAsync(ct);\n\n                    // Required IDs\n                    writer.Write(r.Id, NpgsqlDbType.Uuid);\n                    writer.Write(r.RunId, NpgsqlDbType.Uuid);\n\n                    // Strings / nullable fields\n                    WriteNullableVarchar(writer, r.MessageId);\n                    writer.Write(r.CampaignId, NpgsqlDbType.Uuid);\n                    WriteNullableUuid(writer, r.ContactId);\n                    WriteNullableUuid(writer, r.RecipientId);\n\n                    WriteNullableText(writer, r.MessageBody);\n                    WriteNullableVarchar(writer, r.TemplateId);\n                    WriteNullableVarchar(writer, r.SendStatus);\n                    WriteNullableVarchar(writer, r.ErrorMessage);\n\n                    // Timestamps\n                    writer.Write(r.CreatedAt, NpgsqlDbType.TimestampTz);\n                    WriteNullableVarchar(writer, r.CreatedBy);\n                    WriteNullable(writer, r.SentAt, NpgsqlDbType.TimestampTz);\n                    WriteNullable(writer, r.DeliveredAt, NpgsqlDbType.TimestampTz);\n                    WriteNullable(writer, r.ReadAt, NpgsqlDbType.TimestampTz);\n\n                    // Device / network\n                    WriteNullableVarchar(writer, r.IpAddress);\n                    WriteNullableVarchar(writer, r.DeviceInfo);\n                    WriteNullableVarchar(writer, r.MacAddress);\n                    WriteNullableVarchar(writer, r.SourceChannel);\n                    WriteNullableVarchar(writer, r.DeviceType);\n                    WriteNullableVarchar(writer, r.Browser);\n                    WriteNullableVarchar(writer, r.Country);\n                    WriteNullableVarchar(writer, r.City);\n\n                    // Click info\n                    writer.Write(r.IsClicked, NpgsqlDbType.Boolean);\n                    WriteNullable(writer, r.ClickedAt, NpgsqlDbType.TimestampTz);\n                    WriteNullableVarchar(writer, r.ClickType);\n\n                    // Retry info — RetryCount is non-nullable int in your model\n                    writer.Write(r.RetryCount, NpgsqlDbType.Integer);\n                    WriteNullable(writer, r.LastRetryAt, NpgsqlDbType.TimestampTz);\n                    WriteNullableVarchar(writer, r.LastRetryStatus);\n                    writer.Write(r.AllowRetry, NpgsqlDbType.Boolean);\n\n                    // FK to MessageLogs may be null initially\n                    WriteNullableUuid(writer, r.MessageLogId);\n\n                    // Remaining Ids\n                    writer.Write(r.BusinessId, NpgsqlDbType.Uuid);\n                    WriteNullableUuid(writer, r.CTAFlowConfigId);\n                    WriteNullableUuid(writer, r.CTAFlowStepId);\n\n                    // Bundle (text/json)\n                    WriteNullableText(writer, r.ButtonBundleJson);\n                }\n\n                await writer.CompleteAsync(ct);\n                _log.LogDebug(\"[CampaignLogSink] COPY inserted {Count} rows\", batch.Count);\n            }\n            catch\n            {\n                throw; // let FlushAsync() handle fallback/requeue\n            }\n        }\n\n        private async Task EfInsertAsync(List<CampaignLogRecord> batch, CancellationToken ct)\n        {\n            using var scope = _sp.CreateScope();\n            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n\n            var entities = batch.Select(r => new CampaignSendLog\n            {\n                Id = r.Id,\n                RunId = r.RunId,\n                MessageId = r.MessageId,\n                CampaignId = r.CampaignId,\n                ContactId = r.ContactId,\n                RecipientId = r.RecipientId,\n                MessageBody = r.MessageBody,\n                TemplateId = r.TemplateId,\n                SendStatus = r.SendStatus,\n                ErrorMessage = r.ErrorMessage,\n                CreatedAt = r.CreatedAt,\n                CreatedBy = r.CreatedBy,\n                SentAt = r.SentAt,\n                DeliveredAt = r.DeliveredAt,\n                ReadAt = r.ReadAt,\n                IpAddress = r.IpAddress,\n                DeviceInfo = r.DeviceInfo,\n                MacAddress = r.MacAddress,\n                SourceChannel = r.SourceChannel,\n                DeviceType = r.DeviceType,\n                Browser = r.Browser,\n                Country = r.Country,\n                City = r.City,\n                IsClicked = r.IsClicked,\n                ClickedAt = r.ClickedAt,\n                ClickType = r.ClickType,\n                RetryCount = r.RetryCount,\n                LastRetryAt = r.LastRetryAt,\n                LastRetryStatus = r.LastRetryStatus,\n                AllowRetry = r.AllowRetry,\n                MessageLogId = r.MessageLogId,\n                BusinessId = r.BusinessId,\n                CTAFlowConfigId = r.CTAFlowConfigId,\n                CTAFlowStepId = r.CTAFlowStepId,\n                ButtonBundleJson = r.ButtonBundleJson\n            }).ToList();\n\n            var prev = db.ChangeTracker.AutoDetectChangesEnabled;\n            db.ChangeTracker.AutoDetectChangesEnabled = false;\n            await db.CampaignSendLogs.AddRangeAsync(entities, ct);\n            await db.SaveChangesAsync(ct);\n            db.ChangeTracker.AutoDetectChangesEnabled = prev;\n        }\n    }\n\n    public class BatchingOptions\n    {\n        public CampaignLogOptions CampaignLog { get; set; } = new();\n        public class CampaignLogOptions\n        {\n            public int FlushEveryMs { get; set; } = 500;\n            public int MaxBatchSize { get; set; } = 500;\n            public bool UseCopy { get; set; } = true;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Logging/ICampaignLogSink.cs",
      "sha256": "2bb93f46e441543c54cae578d67d0768ae0a459d621727f54c8eb390ec2cdf38",
      "language": "csharp",
      "size": 303,
      "content": "using System.Threading;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.CampaignTracking.Logging\n{\n    public interface ICampaignLogSink\n    {\n        void Enqueue(CampaignLogRecord rec);\n        int PendingCount { get; }\n        Task FlushAsync(CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Models/CampaignClickDailyAgg.cs",
      "sha256": "f73f8e07824860d62b98ba1112933870fd6c223a3a75ca759bccf5899d9e9ffd",
      "language": "csharp",
      "size": 571,
      "content": "// 📄 Features/CampaignTracking/Models/CampaignClickDailyAgg.cs\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace xbytechat.api.Features.CampaignTracking.Worker\n{\n    [Table(\"CampaignClickDailyAgg\")]\n    public class CampaignClickDailyAgg\n    {\n        [Key] public Guid Id { get; set; }\n        public Guid CampaignId { get; set; }\n        public DateTime Day { get; set; } // date-only (store as date in migration)\n        public int ButtonIndex { get; set; }\n        public long Clicks { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Models/CampaignClickLog.cs",
      "sha256": "c955c29fed1ef4d960a247c80426a21493ab53a3b657a4a21083d2f617d309cb",
      "language": "csharp",
      "size": 1205,
      "content": "// 📄 Features/CampaignTracking/Models/CampaignClickLog.cs\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\n\nnamespace xbytechat.api.Features.CampaignTracking.Worker\n{\n    [Table(\"CampaignClickLogs\")]\n    public class CampaignClickLog\n    {\n        [Key] public Guid Id { get; set; }\n\n        public Guid? RunId { get; set; }\n        // FK through CampaignSendLog to CampaignId & ContactId\n        public Guid CampaignSendLogId { get; set; }\n\n        public Guid CampaignId { get; set; }      // denormalized for fast filtering\n        public Guid? ContactId { get; set; }      // denormalized if available\n\n        public int ButtonIndex { get; set; }\n\n        [MaxLength(120)]\n        public string ButtonTitle { get; set; } = \"\";\n\n        // NEW: \"web\" | \"call\" | \"whatsapp\" (lowercase)\n        [MaxLength(16)]\n        public string ClickType { get; set; } = \"web\";\n\n        [MaxLength(2048)]\n        public string Destination { get; set; } = \"\";\n\n        [MaxLength(64)]\n        public string Ip { get; set; } = \"\";\n\n        [MaxLength(512)]\n        public string UserAgent { get; set; } = \"\";\n\n        public DateTime ClickedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Models/CampaignSendLog.cs",
      "sha256": "a2e627b90aaaa87979a7551588cc2fd8150978b69ff34e6abeddd2d3ab58e1cd",
      "language": "csharp",
      "size": 2937,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing System.ComponentModel.DataAnnotations.Schema;\nusing xbytechat.api.Features.CampaignModule.Models;\nusing xbytechat.api.Features.CRM.Models;\n\nnamespace xbytechat.api.Features.CampaignTracking.Models\n{\n    public class CampaignSendLog\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        public Guid? RunId { get; set; }\n        public string? MessageId { get; set; } // Unique WAMID from WhatsApp\n        // 🔗 Foreign Keys\n    \n        public Guid CampaignId { get; set; }\n        public Campaign? Campaign { get; set; }\n\n \n        public Guid? ContactId { get; set; }\n\n        [Required]\n        public Guid RecipientId { get; set; }\n\n        // 📩 Message Info\n        [Required]\n        public string MessageBody { get; set; } = \"\";\n\n        public string? TemplateId { get; set; }\n        public string? SendStatus { get; set; }\n        public string? ErrorMessage { get; set; }\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        public string? CreatedBy { get; set; }\n\n        public DateTime? SentAt { get; set; }\n        public DateTime? DeliveredAt { get; set; }\n        public DateTime? ReadAt { get; set; }\n\n        // 🌐 Metadata\n        public string? IpAddress { get; set; }\n        public string? DeviceInfo { get; set; }\n        public string? MacAddress { get; set; }\n        public string? SourceChannel { get; set; }\n\n        // ✅ UX-Derived\n        public string? DeviceType { get; set; }\n        public string? Browser { get; set; }\n        public string? Country { get; set; }\n        public string? City { get; set; }\n\n        // 📊 Click Tracking\n        public bool IsClicked { get; set; } = false;\n        public DateTime? ClickedAt { get; set; }\n        public string? ClickType { get; set; }\n\n        // 🔁 Retry Tracking (💡 New)\n        public int RetryCount { get; set; } = 0;                 // Number of retry attempts\n        public DateTime? LastRetryAt { get; set; }               // When retry last happened\n        public string? LastRetryStatus { get; set; }             // Success / Failed\n        public bool AllowRetry { get; set; } = true;             // Flag to enable/disable retry\n\n        // 👁 Navigation\n      \n        public Contact? Contact { get; set; }\n        public CampaignRecipient? Recipient { get; set; }\n\n\n        // 🔗 MessageLog reference (optional)\n        public Guid? MessageLogId { get; set; }\n        public MessageLog? MessageLog { get; set; }\n\n        public Guid BusinessId { get; set; }\n\n        // 🆕 Flow context snapshot for deterministic click resolution\n        public Guid? CTAFlowConfigId { get; set; }   // which flow this send belongs to (optional)\n        public Guid? CTAFlowStepId { get; set; }     // the entry step id (optional)\n\n        [Column(TypeName = \"text\")]\n        public string? ButtonBundleJson { get; set; }\n\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Services/CampaignAnalyticsService.cs",
      "sha256": "ee9163439146987bfeebca642b380b914f7a0d5dae6fc4b2468b798b06840b3e",
      "language": "csharp",
      "size": 5226,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.CampaignTracking.DTOs;\nusing xbytechat.api.Features.CampaignTracking.Models;\n\nnamespace xbytechat.api.Features.CampaignTracking.Services\n{\n\n\n    public class CampaignAnalyticsService : ICampaignAnalyticsService\n    {\n        private readonly AppDbContext _context;\n\n        public CampaignAnalyticsService(AppDbContext context)\n        {\n            _context = context;\n            //_context = context;\n        }\n\n        public async Task<CampaignStatusDashboardDto?> GetCampaignStatsAsync(Guid campaignId)\n        {\n            var logs = await _context.CampaignSendLogs\n                .Where(l => l.CampaignId == campaignId)\n                .ToListAsync();\n\n            if (!logs.Any()) return null;\n\n            return new CampaignStatusDashboardDto\n            {\n                CampaignId = campaignId,\n                TotalRecipients = logs.Count,\n                SentCount = logs.Count(l => l.SendStatus == \"Sent\"),\n                DeliveredCount = logs.Count(l => l.SendStatus == \"Delivered\"),\n                ReadCount = logs.Count(l => l.SendStatus == \"Read\"),\n                FailedCount = logs.Count(l => l.SendStatus == \"Failed\"),\n                FirstSentAt = logs.Min(l => l.SentAt),\n                LastSentAt = logs.Max(l => l.SentAt),\n                FirstReadAt = logs.Min(l => l.ReadAt),\n                LastReadAt = logs.Max(l => l.ReadAt)\n            };\n        }\n\n        //public async Task<IEnumerable<TopCampaignDto>> GetTopCampaignsAsync(Guid businessId, int count = 5)\n        //{\n        //    var campaignStats = await _context.CampaignSendLogs\n        //        .Where(log => log.BusinessId == businessId)\n        //        .GroupBy(log => log.CampaignId)\n        //        .Select(group => new\n        //        {\n        //            CampaignId = group.Key,\n        //            TotalSent = group.Count(),\n        //            TotalRead = group.Count(l => l.ReadAt != null),\n        //            TotalClicked = group.Count(l => l.ClickedAt != null)\n        //        })\n        //        .Where(s => s.TotalSent > 0)\n        //        .OrderByDescending(s => (double)s.TotalClicked / s.TotalSent)\n        //        .Take(count)\n        //        .ToListAsync();\n\n        //    if (!campaignStats.Any())\n        //    {\n        //        return new List<TopCampaignDto>();\n        //    }\n\n        //    var campaignIds = campaignStats.Select(s => s.CampaignId).ToList();\n        //    var campaigns = await _context.Campaigns\n        //        .Where(c => campaignIds.Contains(c.Id))\n        //        .ToDictionaryAsync(c => c.Id, c => c.Name);\n\n        //    return campaignStats.Select(s => new TopCampaignDto\n        //    {\n        //        CampaignId = s.CampaignId,\n        //        CampaignName = campaigns.GetValueOrDefault(s.CampaignId, \"Unnamed Campaign\"),\n        //        ReadRate = s.TotalSent > 0 ? Math.Round(((double)s.TotalRead / s.TotalSent) * 100, 2) : 0,\n        //        ClickThroughRate = s.TotalSent > 0 ? Math.Round(((double)s.TotalClicked / s.TotalSent) * 100, 2) : 0\n        //    });\n        //}\n\n\n\n        public async Task<IEnumerable<TopCampaignDto>> GetTopCampaignsAsync(Guid businessId, int count = 5)\n        {\n            if (count <= 0) count = 5;\n\n            // If you suspect legacy rows with Guid.Empty, keep the extra filter; otherwise you can drop it.\n            var campaignStats = await _context.CampaignSendLogs\n                .AsNoTracking()\n                .Where(log => log.BusinessId == businessId /* && log.CampaignId != Guid.Empty */)\n                .GroupBy(log => log.CampaignId) // CampaignId is non-nullable Guid\n                .Select(group => new\n                {\n                    CampaignId = group.Key,\n                    TotalSent = group.Count(),\n                    TotalRead = group.Count(l => l.ReadAt != null),\n                    TotalClicked = group.Count(l => l.ClickedAt != null)\n                })\n                .Where(s => s.TotalSent > 0)\n                .OrderByDescending(s => (double)s.TotalClicked / s.TotalSent) // CTR first\n                .ThenByDescending(s => s.TotalSent)                           // tie-breaker: volume\n                .Take(count)\n                .ToListAsync();\n\n            if (campaignStats.Count == 0)\n                return Array.Empty<TopCampaignDto>();\n\n            var ids = campaignStats.Select(s => s.CampaignId).ToList();\n\n            var names = await _context.Campaigns\n                .AsNoTracking()\n                .Where(c => ids.Contains(c.Id))\n                .ToDictionaryAsync(c => c.Id, c => c.Name);\n\n            var result = campaignStats.Select(s => new TopCampaignDto\n            {\n                CampaignId = s.CampaignId,\n                CampaignName = names.TryGetValue(s.CampaignId, out var n) && !string.IsNullOrWhiteSpace(n)\n                                        ? n\n                                        : \"Unnamed Campaign\",\n                ReadRate = Math.Round((double)s.TotalRead / s.TotalSent * 100, 2),\n                ClickThroughRate = Math.Round((double)s.TotalClicked / s.TotalSent * 100, 2)\n            });\n\n            return result;\n        }\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Services/CampaignSendLogEnricher.cs",
      "sha256": "6d1155127869663e221b9c1a80e5dce49dd32c3d57d218d8157691ed3bc8edeb",
      "language": "csharp",
      "size": 872,
      "content": "using System.Threading.Tasks;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing System;\n\nnamespace xbytechat.api.Features.CampaignTracking.Services\n{\n    public class CampaignSendLogEnricher : ICampaignSendLogEnricher\n    {\n        public async Task EnrichAsync(CampaignSendLog log, string userAgent, string ipAddress)\n        {\n            // 🧠 Device Detection (simplified for now)\n            log.DeviceInfo = userAgent;\n\n            // 🌍 IP Lookup - Mocked for now\n            if (!string.IsNullOrWhiteSpace(ipAddress))\n            {\n                log.IpAddress = ipAddress;\n                log.SourceChannel = \"API\"; // Example: mark origin\n                // Future: Use IPinfo or GeoLite2 for full location enrichment\n            }\n\n            // ⌛ Simulate async task for compatibility\n            await Task.CompletedTask;\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Services/CampaignSendLogService.cs",
      "sha256": "719776d788525701507db765a8a42a52f25b080ac4faa6be437690ce774e6345",
      "language": "csharp",
      "size": 13351,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Serilog;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignTracking.DTOs;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.CampaignTracking.Services;\nusing xbytechat.api.Features.CRM.Dtos;\n\nnamespace xbytechat.api.Features.CampaignTracking.Services\n{\n    public class CampaignSendLogService : ICampaignSendLogService\n    {\n        private readonly AppDbContext _context;\n        private readonly ICampaignSendLogEnricher _enricher;\n\n\n        public CampaignSendLogService(AppDbContext context, ICampaignSendLogEnricher enricher)\n        {\n            _context = context;\n            _enricher = enricher;\n        }\n\n        //public async Task<PagedResult<CampaignSendLogDto>> GetLogsByCampaignIdAsync(\n        //Guid campaignId, string? status, string? search, int page, int pageSize)\n        //{\n        //    // Base query as IQueryable (not IIncludableQueryable)\n        //    IQueryable<CampaignSendLog> query = _context.CampaignSendLogs\n        //        .AsNoTracking()\n        //        .Where(log => log.CampaignId.HasValue && log.CampaignId.Value == campaignId);\n\n        //    if (!string.IsNullOrEmpty(status))\n        //        query = query.Where(log => log.SendStatus == status);\n\n        //    if (!string.IsNullOrEmpty(search))\n        //    {\n        //        var keyword = search.ToLower();\n\n        //        // Safe null checks + server-side case-insensitive matching\n        //        // If you're on PostgreSQL, EF.Functions.ILike is nicer; otherwise use ToLower().\n        //        query = query.Where(log =>\n        //            log.Contact != null &&\n        //           (log.Contact.Name.ToLower().Contains(keyword)\n        //         || log.Contact.PhoneNumber.Contains(keyword)));\n        //    }\n\n        //    // Add Include after filters to keep it IQueryable\n        //    query = query.Include(log => log.Contact);\n\n        //    var totalCount = await query.CountAsync();\n\n        //    var logs = await query\n        //        .OrderByDescending(log => log.CreatedAt)\n        //        .Skip((page - 1) * pageSize)\n        //        .Take(pageSize)\n        //        .Select(log => new CampaignSendLogDto\n        //        {\n        //            Id = log.Id,\n        //            CampaignId = log.CampaignId!.Value,       // unwrap once for DTO Guid\n        //            ContactId = log.ContactId,               // keep Guid? in DTO if CSV-only is allowed\n        //            ContactName = log.Contact != null ? log.Contact.Name : \"N/A\",\n        //            ContactPhone = log.Contact != null ? log.Contact.PhoneNumber : \"-\",\n        //            MessageBody = log.MessageBody,\n        //            TemplateId = log.TemplateId,\n        //            SendStatus = log.SendStatus,\n        //            ErrorMessage = log.ErrorMessage,\n        //            CreatedAt = log.CreatedAt,\n        //            SentAt = log.SentAt,\n        //            DeliveredAt = log.DeliveredAt,\n        //            ReadAt = log.ReadAt,\n        //            SourceChannel = log.SourceChannel,\n        //            IsClicked = log.IsClicked,\n        //            ClickedAt = log.ClickedAt,\n        //            ClickType = log.ClickType\n        //        })\n        //        .ToListAsync();\n\n        //    return new PagedResult<CampaignSendLogDto>\n        //    {\n        //        Items = logs,\n        //        TotalCount = totalCount,\n        //        Page = page,\n        //        PageSize = pageSize\n        //    };\n        //}\n\n\n        //public async Task<List<CampaignSendLogDto>> GetLogsForContactAsync(Guid campaignId, Guid contactId)\n        //{\n        //    return await _context.CampaignSendLogs\n        //        .Where(log => log.CampaignId == campaignId && log.ContactId == contactId)\n        //        .Select(log => new CampaignSendLogDto\n        //        {\n        //            Id = log.Id,\n        //            CampaignId = log.CampaignId,\n        //            ContactId = log.ContactId,\n        //            MessageBody = log.MessageBody,\n        //            TemplateId = log.TemplateId,\n        //            SendStatus = log.SendStatus,\n        //            ErrorMessage = log.ErrorMessage,\n        //            CreatedAt = log.CreatedAt,\n        //            SentAt = log.SentAt,\n        //            DeliveredAt = log.DeliveredAt,\n        //            ReadAt = log.ReadAt,\n        //            IpAddress = log.IpAddress,\n        //            DeviceInfo = log.DeviceInfo,\n        //            MacAddress = log.MacAddress,\n        //            SourceChannel = log.SourceChannel,\n        //            IsClicked = log.IsClicked,\n        //            ClickedAt = log.ClickedAt,\n        //            ClickType = log.ClickType\n        //        })\n        //        .ToListAsync();\n        //}\n\n        // 🆕 Create a new send log (with enrichment)\n\n        public async Task<PagedResult<CampaignSendLogDto>> GetLogsByCampaignIdAsync(\n       Guid campaignId, string? status, string? search, int page, int pageSize)\n        {\n            if (page <= 0) page = 1;\n            if (pageSize <= 0) pageSize = 10;\n\n            // Base (scoped to the campaign)\n            var q =\n                from log in _context.CampaignSendLogs.AsNoTracking()\n                where log.CampaignId == campaignId\n                join ml in _context.MessageLogs.AsNoTracking()\n                     on log.MessageLogId equals ml.Id into g\n                from ml in g.DefaultIfEmpty() // LEFT JOIN\n                select new { log, ml };\n\n            if (!string.IsNullOrWhiteSpace(status))\n                q = q.Where(x => x.log.SendStatus == status);\n\n            if (!string.IsNullOrWhiteSpace(search))\n            {\n                var kw = search.Trim();\n                var kwLike = $\"%{kw}%\";\n\n                q = q.Where(x =>\n                    // match CRM contact name/phone if present\n                    (x.log.Contact != null &&\n                        (EF.Functions.ILike(x.log.Contact.Name!, kwLike) ||\n                         x.log.Contact.PhoneNumber!.Contains(kw)))\n                    ||\n                    // match raw recipient number from message log (CSV-only etc.)\n                    (x.ml.RecipientNumber != null && x.ml.RecipientNumber.Contains(kw))\n                );\n            }\n\n            var total = await q.CountAsync();\n\n            var items = await q\n                .OrderByDescending(x => x.log.CreatedAt)\n                .Skip((page - 1) * pageSize)\n                .Take(pageSize)\n                .Select(x => new CampaignSendLogDto\n                {\n                    Id = x.log.Id,\n                    // CampaignId = x.log.CampaignId ?? campaignId,\n                    CampaignId = x.log.CampaignId,// ✅ fix\n                    ContactId = x.log.ContactId,\n                    ContactName = x.log.Contact != null ? x.log.Contact.Name : \"N/A\",\n                    ContactPhone = x.log.Contact != null ? x.log.Contact.PhoneNumber : \"-\",\n                    RecipientNumber = x.ml.RecipientNumber,\n                    RecipientId = x.log.RecipientId,\n                    MessageBody = x.log.MessageBody,\n                    TemplateId = x.log.TemplateId,\n                    SendStatus = x.log.SendStatus,\n                    ErrorMessage = x.log.ErrorMessage,\n                    CreatedAt = x.log.CreatedAt,\n                    SentAt = x.log.SentAt,\n                    DeliveredAt = x.log.DeliveredAt,\n                    ReadAt = x.log.ReadAt,\n                    SourceChannel = x.log.SourceChannel,\n                    IsClicked = x.log.IsClicked,\n                    ClickedAt = x.log.ClickedAt,\n                    ClickType = x.log.ClickType\n                })\n                .ToListAsync();\n\n            return new PagedResult<CampaignSendLogDto>\n            {\n                Items = items,\n                TotalCount = total,\n                Page = page,\n                PageSize = pageSize\n            };\n        }\n\n        public async Task<List<CampaignSendLogDto>> GetLogsForContactAsync(Guid campaignId, Guid contactId)\n        {\n            return await _context.CampaignSendLogs\n                .AsNoTracking()\n               .Where(log =>\n    log.CampaignId == campaignId &&\n    log.ContactId == contactId)\n                .Select(log => new CampaignSendLogDto\n                {\n                    Id = log.Id,\n                    CampaignId = log.CampaignId,\n                    ContactId = log.ContactId,  // unwrap after HasValue guard\n                    MessageBody = log.MessageBody,\n                    TemplateId = log.TemplateId,\n                    SendStatus = log.SendStatus,\n                    ErrorMessage = log.ErrorMessage,\n                    CreatedAt = log.CreatedAt,\n                    SentAt = log.SentAt,\n                    DeliveredAt = log.DeliveredAt,\n                    ReadAt = log.ReadAt,\n                    IpAddress = log.IpAddress,\n                    DeviceInfo = log.DeviceInfo,\n                    MacAddress = log.MacAddress,\n                    SourceChannel = log.SourceChannel,\n                    IsClicked = log.IsClicked,\n                    ClickedAt = log.ClickedAt,\n                    ClickType = log.ClickType\n                })\n                .ToListAsync();\n        }\n\n\n        public async Task<bool> AddSendLogAsync(CampaignSendLogDto dto, string ipAddress, string userAgent)\n        {\n            var log = new CampaignSendLog\n            {\n                Id = Guid.NewGuid(),\n                CampaignId = dto.CampaignId,\n                ContactId = dto.ContactId,\n                MessageBody = dto.MessageBody,\n                TemplateId = dto.TemplateId,\n                SendStatus = dto.SendStatus,\n                ErrorMessage = dto.ErrorMessage,\n                CreatedAt = DateTime.UtcNow,\n                SentAt = dto.SentAt,\n                DeliveredAt = dto.DeliveredAt,\n                ReadAt = dto.ReadAt,\n                SourceChannel = dto.SourceChannel,\n                IsClicked = dto.IsClicked,\n                ClickedAt = dto.ClickedAt,\n                ClickType = dto.ClickType,\n                RecipientId = dto.RecipientId\n            };\n\n            // ✅ Use enrichment service\n            await _enricher.EnrichAsync(log, userAgent, ipAddress);\n\n            _context.CampaignSendLogs.Add(log);\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        // 📨 Update delivery or read status\n        public async Task<bool> UpdateDeliveryStatusAsync(Guid logId, string status, DateTime? deliveredAt, DateTime? readAt)\n        {\n            var log = await _context.CampaignSendLogs.FirstOrDefaultAsync(l => l.Id == logId);\n            if (log == null) return false;\n\n            log.SendStatus = status;\n            log.DeliveredAt = deliveredAt ?? log.DeliveredAt;\n            log.ReadAt = readAt ?? log.ReadAt;\n\n            await _context.SaveChangesAsync();\n            return true;\n        }\n\n        // 📈 Track click (CTA)\n        public async Task<bool> TrackClickAsync(Guid logId, string clickType)\n        {\n            var log = await _context.CampaignSendLogs.FirstOrDefaultAsync(l => l.Id == logId);\n            if (log == null) return false;\n\n            log.IsClicked = true;\n            log.ClickedAt = DateTime.UtcNow;\n            log.ClickType = clickType;\n\n            await _context.SaveChangesAsync();\n            return true;\n        }\n        public async Task<CampaignLogSummaryDto> GetCampaignSummaryAsync(Guid campaignId)\n        {\n            // This single, efficient query calculates all stats directly in the database.\n            var summary = await _context.CampaignSendLogs\n                .Where(l => l.CampaignId == campaignId)\n                .GroupBy(l => 1) // Group by a constant to aggregate all results\n                .Select(g => new\n                {\n                    TotalRecipients = g.Count(),\n\n                    // CORRECTED LOGIC: A message is \"Sent\" if its status is NOT \"Failed\".\n                    // This correctly includes messages that are \"Sent\", \"Delivered\", or \"Read\".\n                    SentCount = g.Count(l => l.SendStatus != \"Failed\"),\n\n                    FailedCount = g.Count(l => l.SendStatus == \"Failed\"),\n                    ClickedCount = g.Count(l => l.IsClicked),\n                    DeliveredCount = g.Count(l => l.DeliveredAt != null),\n                    ReadCount = g.Count(l => l.ReadAt != null),\n                    LastSentAt = g.Max(l => l.SentAt)\n                })\n                .FirstOrDefaultAsync();\n\n            if (summary == null)\n            {\n                // Return an empty DTO if no logs are found for the campaign\n                return new CampaignLogSummaryDto();\n            }\n\n            return new CampaignLogSummaryDto\n            {\n                TotalSent = summary.TotalRecipients,\n                Sent = summary.SentCount,\n                FailedCount = summary.FailedCount,\n                ClickedCount = summary.ClickedCount,\n                Delivered = summary.DeliveredCount,\n                Read = summary.ReadCount,\n                LastSentAt = summary.LastSentAt\n            };\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/CampaignTracking/Services/CampaignTrackingRetryService.cs",
      "sha256": "7b60dddd6aceae08b86da9813190186180881e6fc9efd8dc1190e497b51f9af1",
      "language": "csharp",
      "size": 2935,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat.api.Features.CampaignTracking.Models;\n\nnamespace xbytechat.api.Features.CampaignTracking.Services\n{\n    public class CampaignTrackingRetryService : ICampaignTrackingRetryService\n    {\n        private readonly AppDbContext _context;\n\n        public CampaignTrackingRetryService(AppDbContext context)\n        {\n            _context = context;\n        }\n\n        // ✅ Public method: Retry a single failed log\n        public async Task<bool> RetrySingleAsync(Guid logId)\n        {\n            return await RetrySendLogAsync(logId);\n        }\n\n        // ✅ Public method: Retry all failed logs in a campaign\n        public async Task<int> RetryFailedInCampaignAsync(Guid campaignId)\n        {\n            return await RetryAllFailedInCampaignAsync(campaignId);\n        }\n\n        // 🔁 Private: Retry a specific log\n        private async Task<bool> RetrySendLogAsync(Guid logId)\n        {\n            var log = await _context.CampaignSendLogs.FirstOrDefaultAsync(x => x.Id == logId);\n\n            if (log == null || log.SendStatus != \"Failed\" || !log.AllowRetry)\n                return false;\n\n            // 🔄 Simulate re-send (replace with actual IMessageService.SendAsync later)\n            bool sent = SimulateSendMessage(log);\n\n            log.RetryCount += 1;\n            log.LastRetryAt = DateTime.UtcNow;\n            log.LastRetryStatus = sent ? \"Sent\" : \"Failed\";\n            log.SendStatus = sent ? \"Sent\" : \"Failed\";\n            log.ErrorMessage = sent ? null : \"Mock failure on retry\";\n\n            await _context.SaveChangesAsync();\n            return sent;\n        }\n\n        // 🔁 Private: Retry all failed logs in a given campaign\n        private async Task<int> RetryAllFailedInCampaignAsync(Guid campaignId)\n        {\n            var failedLogs = await _context.CampaignSendLogs\n                .Where(log => log.CampaignId == campaignId && log.SendStatus == \"Failed\" && log.AllowRetry)\n                .ToListAsync();\n\n            int successCount = 0;\n\n            foreach (var log in failedLogs)\n            {\n                bool sent = SimulateSendMessage(log);\n\n                log.RetryCount += 1;\n                log.LastRetryAt = DateTime.UtcNow;\n                log.LastRetryStatus = sent ? \"Sent\" : \"Failed\";\n                log.SendStatus = sent ? \"Sent\" : \"Failed\";\n                log.ErrorMessage = sent ? null : \"Mock failure on retry\";\n\n                if (sent) successCount++;\n            }\n\n            await _context.SaveChangesAsync();\n            return successCount;\n        }\n\n        // 🔧 Simulated send (replace with actual WhatsApp message logic)\n        private bool SimulateSendMessage(CampaignSendLog log)\n        {\n            return new Random().NextDouble() < 0.9; // 90% success rate\n        }\n    }\n}\n"
    }
  ]
}
