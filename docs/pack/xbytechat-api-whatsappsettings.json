{
  "name": "xbytechat-api/WhatsAppSettings",
  "generatedAt": "2025-12-10 08:27:07 +00:00",
  "files": [
    {
      "path": "xbytechat-api/WhatsAppSettings/Abstractions/IMetaTemplateCatalogProvider.cs",
      "sha256": "86349422826b2dc4082100f836645a12e3ceea4ff94f60ce89ca253f1083e818",
      "language": "csharp",
      "size": 626,
      "content": "using System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.WhatsAppSettings.Abstractions\n{\n    public interface IMetaTemplateCatalogProvider\n    {\n        Task<IReadOnlyList<TemplateCatalogItem>> ListMetaAsync(\n            WhatsAppSettingEntity setting,\n            CancellationToken ct = default);\n\n        Task<TemplateCatalogItem?> GetByNameMetaAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Abstractions/IPinnacleTemplateCatalogProvider.cs",
      "sha256": "2b217b52f24e7214b9794295352839f4472418921d0d17a57bf4f5e8ce9aaeff",
      "language": "csharp",
      "size": 638,
      "content": "using System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.WhatsAppSettings.Abstractions\n{\n    public interface IPinnacleTemplateCatalogProvider\n    {\n        Task<IReadOnlyList<TemplateCatalogItem>> ListPinnacleAsync(\n            WhatsAppSettingEntity setting,\n            CancellationToken ct = default);\n\n        Task<TemplateCatalogItem?> GetByNamePinnacleAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Abstractions/ITemplateCatalogProvider.cs",
      "sha256": "c20ebfc19a7f6f0a37a9d5d1f0458ac22c9ea6c66f3a0b08d6f4132c0f90b513",
      "language": "csharp",
      "size": 670,
      "content": "using System.Collections.Generic;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;      // TemplateCatalogItem\nusing xbytechat_api.WhatsAppSettings.Models;    // WhatsAppSettingEntity\n\nnamespace xbytechat.api.WhatsAppSettings.Abstractions\n{\n    public interface ITemplateCatalogProvider\n    {\n        Task<IReadOnlyList<TemplateCatalogItem>> ListAsync(\n            WhatsAppSettingEntity setting,\n            CancellationToken ct = default);\n\n        Task<TemplateCatalogItem?> GetByNameAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Abstractions/TemplateCatalogItem.cs",
      "sha256": "66c3b015d5dea2cf216f9b23fbcb1e7074d22d7850a79401cfbae44bf9a3677c",
      "language": "csharp",
      "size": 450,
      "content": "using xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat.api.WhatsAppSettings.Abstractions\n{\n    public record TemplateCatalogItem(\n       string Name,\n       string Language,\n       string Body,\n       int PlaceholderCount,\n       bool HasImageHeader,\n       IReadOnlyList<ButtonMetadataDto> Buttons,\n       string Status,\n       string? Category,\n       string? ExternalId,\n       string RawJson,\n        string? SubCategory = null\n   );\n}\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Common/Providers.cs",
      "sha256": "f28418126b45e299564664005d25a4c33d566f9deeb455d10358c28c54ccc6bc",
      "language": "csharp",
      "size": 801,
      "content": "namespace xbytechat.api.WhatsAppSettings.Common\n{\n    public static class Providers\n    {\n        public const string PINNACLE = \"PINNACLE\";\n        public const string META_CLOUD = \"META_CLOUD\";\n\n        public static string NormalizeToUpper(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return PINNACLE;\n            var s = raw.Trim().ToUpperInvariant();\n            return s switch\n            {\n                \"META\" => META_CLOUD,\n                \"META_CLOUD\" => META_CLOUD,\n                \"PINNACLE\" => PINNACLE,\n                _ => s // future providers just uppercase\n            };\n        }\n        public static bool IsValid(string? raw)\n        {\n            var s = NormalizeToUpper(raw);\n            return s == PINNACLE || s == META_CLOUD;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/TemplateMetaController.cs",
      "sha256": "989605668ac2858b4f7cd8064a8c8eeeafa800c2561df9484854f7c8f6923846",
      "language": "csharp",
      "size": 1630,
      "content": "using System;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/templates/meta\")]\n    [Authorize]\n    public sealed class TemplateMetaController : ControllerBase\n    {\n        private readonly IWhatsAppTemplateFetcherService _fetcher;\n\n        public TemplateMetaController(IWhatsAppTemplateFetcherService fetcher)\n        {\n            _fetcher = fetcher;\n        }\n\n        \n        [HttpGet(\"list/{businessId:guid}\")]\n        public async Task<IActionResult> List(Guid businessId, [FromQuery] string? provider = null)\n        {\n            if (businessId == Guid.Empty) return BadRequest(new { message = \"Invalid businessId\" });\n            var list = await _fetcher.GetTemplatesMetaAsync(businessId, provider);\n            return Ok(list);\n        }\n\n        // GET /api/templates/meta/{businessId}/{templateName}?language=en_US&provider=META_CLOUD\n        [HttpGet(\"{businessId:guid}/{templateName}\")]\n        public async Task<IActionResult> One(Guid businessId, string templateName, [FromQuery] string? language = null, [FromQuery] string? provider = null)\n        {\n            if (businessId == Guid.Empty || string.IsNullOrWhiteSpace(templateName))\n                return BadRequest(new { message = \"Invalid parameters\" });\n\n            var meta = await _fetcher.GetTemplateMetaAsync(businessId, templateName, language, provider);\n            if (meta is null) return NotFound();\n            return Ok(meta);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/TemplatePreviewController.cs",
      "sha256": "d8b530f953ecd1e5448fa763ad12dc25bbcf061b8cb7d599d4cad9a5da7f060f",
      "language": "csharp",
      "size": 1212,
      "content": "using System;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.Features.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/templates/preview\")]\n    [Authorize]\n    public sealed class TemplatePreviewController : ControllerBase\n    {\n        private readonly ITemplatePreviewService _svc;\n\n        public TemplatePreviewController(ITemplatePreviewService svc)\n        {\n            _svc = svc;\n        }\n\n        // POST /api/templates/preview/{businessId}\n        [HttpPost(\"{businessId:guid}\")]\n        public async Task<IActionResult> TemplatePreview([FromRoute] Guid businessId, [FromBody] TemplatePreviewRequestDto request)\n        {\n            if (businessId == Guid.Empty) return BadRequest(new { message = \"Invalid businessId\" });\n            if (request == null || string.IsNullOrWhiteSpace(request.TemplateName))\n                return BadRequest(new { message = \"TemplateName is required.\" });\n\n            var result = await _svc.PreviewAsync(businessId, request);\n            return Ok(result);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/TemplatesController.cs",
      "sha256": "cd8759fcc64db63cd8014f3329b58ca30deaf70f88104d874646d6612ecdbf2e",
      "language": "csharp",
      "size": 11494,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.FileSystemGlobbing;\nusing xbytechat.api.WhatsAppSettings.Services;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing xbytechat_api.WhatsAppSettings.Services;\nnamespace xbytechat.api.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/templates\")]\n    public class TemplatesController : ControllerBase\n    {\n        private readonly AppDbContext _db;\n        private readonly ITemplateSyncService _sync;\n        private readonly IWhatsAppTemplateFetcherService _fetcher;\n\n        public TemplatesController(AppDbContext db, ITemplateSyncService sync, IWhatsAppTemplateFetcherService fetcher)\n        { _db = db; _sync = sync; _fetcher = fetcher; }\n\n\n        // Sync Templates\n        ////[HttpPost(\"sync/{businessId:guid}\")]\n        ////[Authorize]\n        ////public async Task<IActionResult> Sync(Guid businessId, [FromQuery] bool force = false)\n        ////{\n        ////    if (businessId == Guid.Empty) return BadRequest(new { success = false, message = \"Invalid businessId\" });\n        ////    var result = await _sync.SyncBusinessTemplatesAsync(businessId, force);\n        ////    return Ok(new { success = true, result });\n        ////}\n        [HttpPost(\"sync/{businessId:guid}\")]\n        [Authorize]\n        public async Task<IActionResult> Sync(Guid businessId)\n        {\n            if (businessId == Guid.Empty)\n                return BadRequest(new { success = false, message = \"Invalid businessId\" });\n\n            // Button = always fetch and upsert (ignore TTL; do not deactivate)\n            var result = await _sync.SyncBusinessTemplatesAsync(\n                businessId,\n                force: true,onlyUpsert: true);\n\n            return Ok(new { success = true, result });\n        }\n\n        [HttpGet(\"{businessId:guid}\")]\n        [Authorize]\n        public async Task<IActionResult> List(\n      Guid businessId,\n      [FromQuery] string? q = null,\n      [FromQuery] string? status = \"APPROVED\",\n      [FromQuery] string? language = null,\n      [FromQuery] string? provider = null)\n        {\n            var query = _db.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(x => x.BusinessId == businessId && x.IsActive);\n\n            if (!string.IsNullOrWhiteSpace(status))\n            {\n                var s = status.Trim().ToUpperInvariant();     // stored uppercase\n                query = query.Where(x => x.Status == s);\n            }\n\n            if (!string.IsNullOrWhiteSpace(language))\n            {\n                var lang = language.Trim();\n                query = query.Where(x => x.LanguageCode == lang);\n            }\n\n            if (!string.IsNullOrWhiteSpace(provider))\n            {\n                var prov = provider.Trim().ToUpperInvariant(); // stored uppercase\n                query = query.Where(x => x.Provider == prov);\n            }\n\n            if (!string.IsNullOrWhiteSpace(q))\n            {\n                var term = q.Trim();\n                query = query.Where(x =>\n                    x.Name.Contains(term) ||\n                    (x.Body != null && x.Body.Contains(term)));\n            }\n\n            var items = await query\n                .OrderBy(x => x.Name)\n                .Select(x => new\n                {\n                    x.Name,\n                    x.LanguageCode,\n                    x.Status,\n                    x.Category,\n                    BodyVarCount = x.BodyVarCount, // <-- replaces PlaceholderCount\n                    x.UrlButtons\n                })\n                .ToListAsync();\n\n            return Ok(new { success = true, templates = items });\n        }\n\n\n        //[HttpGet(\"{businessId:guid}/{name}\")]\n        //[Authorize]\n\n\n        //public async Task<IActionResult> GetOne(Guid businessId, string name, [FromQuery] string? language = null)\n        //{\n        //    var tpl = await _db.WhatsAppTemplates\n        //        .AsNoTracking()\n        //        .FirstOrDefaultAsync(x =>\n        //            x.BusinessId == businessId\n        //            && x.Name == name\n        //            && (language == null || x.LanguageCode == language));\n\n        //    if (tpl == null) return NotFound();\n\n        //    // Prefer stored values; optionally refine via meta fetcher\n        //    string headerKind = (tpl.HeaderKind ?? \"none\").Trim().ToLowerInvariant();\n        //    bool requiresHeaderMediaUrl = tpl.RequiresMediaHeader\n        //                                  || headerKind is \"image\" or \"video\" or \"document\";\n\n        //    try\n        //    {\n        //        // If you still want live verification, keep this; otherwise you can remove the try/catch block\n        //        var meta = await _fetcher.GetTemplateMetaAsync(\n        //            businessId: businessId,\n        //            templateName: tpl.Name,\n        //            language: tpl.LanguageCode,\n        //            provider: null);\n\n        //        var ht = meta?.HeaderType?.Trim().ToUpperInvariant();\n        //        if (!string.IsNullOrEmpty(ht))\n        //        {\n        //            headerKind = ht switch\n        //            {\n        //                \"IMAGE\" => \"image\",\n        //                \"VIDEO\" => \"video\",\n        //                \"DOCUMENT\" => \"document\",\n        //                \"TEXT\" => \"text\",\n        //                _ => headerKind\n        //            };\n        //            requiresHeaderMediaUrl = headerKind is \"image\" or \"video\" or \"document\";\n        //        }\n        //    }\n        //    catch\n        //    {\n        //        // fall back to stored fields (already set above)\n        //    }\n\n        //    return Ok(new\n        //    {\n        //        tpl.Name,\n        //        tpl.LanguageCode,\n        //        tpl.Status,\n        //        tpl.Category,\n        //        tpl.Body,\n        //        BodyVarCount = tpl.BodyVarCount,   // <- replaces old PlaceholderCount\n        //        tpl.UrlButtons,\n        //        headerKind,\n        //        requiresHeaderMediaUrl\n        //    });\n        //}\n        [HttpGet(\"{businessId:guid}/{name}\")]\n        [Authorize]\n        public async Task<IActionResult> GetOne(Guid businessId, string name, [FromQuery] string? language = null)\n        {\n            var tpl = await _db.WhatsAppTemplates\n                .AsNoTracking()\n                .FirstOrDefaultAsync(x =>\n                    x.BusinessId == businessId &&\n                    x.Name == name &&\n                    (language == null || x.LanguageCode == language));\n\n            if (tpl == null) return NotFound();\n\n            // ‚Äî‚Äî‚Äî‚Äî‚Äî header info (keep your current behavior)\n            string headerKind = (tpl.HeaderKind ?? \"none\").Trim().ToLowerInvariant();\n            bool requiresHeaderMediaUrl = tpl.RequiresMediaHeader\n                                          || headerKind is \"image\" or \"video\" or \"document\";\n            try\n            {\n                var meta = await _fetcher.GetTemplateMetaAsync(\n                    businessId: businessId,\n                    templateName: tpl.Name,\n                    language: tpl.LanguageCode,\n                    provider: null);\n\n                var ht = meta?.HeaderType?.Trim().ToUpperInvariant();\n                if (!string.IsNullOrEmpty(ht))\n                {\n                    headerKind = ht switch\n                    {\n                        \"IMAGE\" => \"image\",\n                        \"VIDEO\" => \"video\",\n                        \"DOCUMENT\" => \"document\",\n                        \"TEXT\" => \"text\",\n                        _ => headerKind\n                    };\n                    requiresHeaderMediaUrl = headerKind is \"image\" or \"video\" or \"document\";\n                }\n            }\n            catch { /* fall back to stored */ }\n\n            // ‚Äî‚Äî‚Äî‚Äî‚Äî build a normalized buttons array from RawJson\n            var buttons = new List<object>();\n            try\n            {\n                // RawJson was saved during sync; shape matches provider response.\n                // We'll look for components[].type == \"BUTTONS\".\n                var root = Newtonsoft.Json.Linq.JObject.Parse(string.IsNullOrWhiteSpace(tpl.RawJson) ? \"{}\" : tpl.RawJson);\n                var components = root.SelectToken(\"components\") ?? root.SelectToken(\"data.components\") ?? root.SelectToken(\"template.components\");\n\n                if (components is Newtonsoft.Json.Linq.JArray arr)\n                {\n                    foreach (var c in arr)\n                    {\n                        var type = c?[\"type\"]?.ToString()?.ToUpperInvariant();\n                        if (type != \"BUTTONS\") continue;\n\n                        var btns = c[\"buttons\"] as Newtonsoft.Json.Linq.JArray;\n                        if (btns == null) continue;\n\n                        int idx = 0;\n                        foreach (var b in btns)\n                        {\n                            var btnType = b?[\"type\"]?.ToString()?.ToUpperInvariant() ?? \"\";\n                            var text = b?[\"text\"]?.ToString() ?? \"\";\n                            // default fields\n                            string subType = btnType switch\n                            {\n                                \"URL\" => \"url\",\n                                \"PHONE_NUMBER\" => \"voice_call\",\n                                \"QUICK_REPLY\" => \"quick_reply\",\n                                \"COPY_CODE\" => \"copy_code\",\n                                \"CATALOG\" => \"catalog\",\n                                \"FLOW\" => \"flow\",\n                                \"REMINDER\" => \"reminder\",\n                                \"ORDER_DETAILS\" => \"order_details\",\n                                _ => \"unknown\"\n                            };\n\n                            // capture param (for dynamic URL / phone / coupon / flow)\n                            string? param =\n                                b?[\"url\"]?.ToString()\n                                ?? b?[\"phone_number\"]?.ToString()\n                                ?? b?[\"coupon_code\"]?.ToString()\n                                ?? b?[\"flow_id\"]?.ToString();\n\n                            buttons.Add(new\n                            {\n                                text = text,\n                                type = btnType,        // original provider type (UPPERCASE)\n                                subType = subType,     // normalized (lowercase)\n                                index = (int?)(b?[\"index\"]?.ToObject<int?>() ?? idx),\n                                parameterValue = param // may be null for quick replies\n                            });\n\n                            idx++;\n                        }\n                    }\n                }\n            }\n            catch\n            {\n                // ignore parse errors; just return other fields\n            }\n\n            return Ok(new\n            {\n                tpl.Name,\n                LanguageCode = tpl.LanguageCode,\n                tpl.Status,\n                tpl.Category,\n                Body = tpl.Body,\n                BodyVarCount = tpl.BodyVarCount, // new field you already use in List\n                UrlButtons = tpl.UrlButtons,     // keep legacy field (indexes of URL buttons)\n                headerKind,\n                requiresHeaderMediaUrl,\n                buttons                           // üëà NEW: full set including quick replies\n            });\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/WhatsAppNumbersController.cs",
      "sha256": "81acd60e9331bc4c7b0fb8b3cfdaea4dc1c4932811338b70e0f2fd174b2dca1f",
      "language": "csharp",
      "size": 6041,
      "content": "using System;\nusing System.Linq;\nusing System.Security.Claims;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.WhatsAppSettings.Services;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\nusing xbytechat.api.Shared;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat.api.Features.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/whatsappsettings/{provider}/numbers\")]\n    public class WhatsAppNumbersController : ControllerBase\n    {\n        private readonly IWhatsAppPhoneNumberService _svc;\n        private readonly ILogger<WhatsAppNumbersController> _logger;\n\n        public WhatsAppNumbersController(\n            IWhatsAppPhoneNumberService svc,\n            ILogger<WhatsAppNumbersController> logger)\n        {\n            _svc = svc;\n            _logger = logger;\n        }\n\n        // Helper to resolve BusinessId from claims/header/query (adjust to your auth)\n        private bool TryGetBusinessId(out Guid businessId)\n        {\n            businessId = Guid.Empty;\n\n            // 1) Claim (preferred)\n            var claim = User?.FindFirst(\"BusinessId\") ?? User?.FindFirst(\"businessId\");\n            if (claim != null && Guid.TryParse(claim.Value, out businessId))\n                return true;\n\n            // 2) Header fallback\n            if (Request.Headers.TryGetValue(\"X-Business-Id\", out var h)\n                && Guid.TryParse(h.ToString(), out businessId))\n                return true;\n\n            // 3) Query fallback\n            if (Guid.TryParse(HttpContext.Request.Query[\"businessId\"], out businessId))\n                return true;\n\n            return false;\n        }\n\n        // GET /api/whatsappsettings/{provider}/numbers\n        [HttpGet]\n        [ProducesResponseType(StatusCodes.Status200OK)]\n        [ProducesResponseType(StatusCodes.Status400BadRequest)]\n        public async Task<IActionResult> List([FromRoute] string provider)\n        {\n            if (!TryGetBusinessId(out var businessId))\n                return BadRequest(\"BusinessId is required (claim/header/query).\");\n\n            var items = await _svc.ListAsync(businessId, provider);\n            return Ok(items);\n        }\n\n        public sealed class UpsertRequest\n        {\n            public string PhoneNumberId { get; set; } = null!;\n            public string WhatsAppBusinessNumber { get; set; } = null!;\n            public string? SenderDisplayName { get; set; }\n            public bool? IsActive { get; set; }\n            public bool? IsDefault { get; set; }\n        }\n\n        // POST /api/whatsappsettings/{provider}/numbers\n        [HttpPost(\"\")]\n        [ProducesResponseType(typeof(WhatsAppPhoneNumber), StatusCodes.Status200OK)]\n        [ProducesResponseType(StatusCodes.Status400BadRequest)]\n       // [HttpPost(\"\")]\n        public async Task<IActionResult> Upsert([FromRoute] string provider, [FromBody] UpsertRequest req)\n        {\n            if (!TryGetBusinessId(out var businessId))\n                return BadRequest(\"BusinessId is required (claim/header/query).\");\n\n            if (string.IsNullOrWhiteSpace(req.PhoneNumberId))\n                return BadRequest(\"phoneNumberId is required.\");\n            if (string.IsNullOrWhiteSpace(req.WhatsAppBusinessNumber))\n                return BadRequest(\"whatsAppBusinessNumber is required.\");\n\n            try\n            {\n                var saved = await _svc.UpsertAsync(\n                    businessId,\n                    provider, // service normalizes\n                    req.PhoneNumberId,\n                    req.WhatsAppBusinessNumber,\n                    req.SenderDisplayName,\n                    req.IsActive,\n                    req.IsDefault\n                );\n                return Ok(saved);\n            }\n            catch (InvalidOperationException ex) when (ex.InnerException is Npgsql.NpgsqlException npg)\n            {\n                // Bubble up constraint codes if useful\n                // 23505 unique_violation, 23503 foreign_key_violation, 23502 not_null_violation\n                return StatusCode(StatusCodes.Status409Conflict, new\n                {\n                    statusCode = 409,\n                    code = npg.SqlState,\n                    message = ex.Message\n                });\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(StatusCodes.Status500InternalServerError, new\n                {\n                    statusCode = 500,\n                    message = ex.Message\n                });\n            }\n        }\n\n        // DELETE /api/whatsappsettings/{provider}/numbers/{id}\n        [HttpDelete(\"{id:guid}\")]\n        [ProducesResponseType(StatusCodes.Status204NoContent)]\n        [ProducesResponseType(StatusCodes.Status404NotFound)]\n        [ProducesResponseType(StatusCodes.Status400BadRequest)]\n        public async Task<IActionResult> Delete([FromRoute] string provider, [FromRoute] Guid id)\n        {\n            if (!TryGetBusinessId(out var businessId))\n                return BadRequest(\"BusinessId is required (claim/header/query).\");\n\n            var ok = await _svc.DeleteAsync(businessId, provider, id);\n            if (!ok) return NotFound();\n\n            return NoContent();\n        }\n\n        // PATCH /api/whatsappsettings/{provider}/numbers/{id}/default\n        [HttpPatch(\"{id:guid}/default\")]\n        [ProducesResponseType(StatusCodes.Status204NoContent)]\n        [ProducesResponseType(StatusCodes.Status404NotFound)]\n        [ProducesResponseType(StatusCodes.Status400BadRequest)]\n        public async Task<IActionResult> SetDefault([FromRoute] string provider, [FromRoute] Guid id)\n        {\n            if (!TryGetBusinessId(out var businessId))\n                return BadRequest(\"BusinessId is required (claim/header/query).\");\n\n            var ok = await _svc.SetDefaultAsync(businessId, provider, id);\n            if (!ok) return NotFound();\n\n            return NoContent();\n        }\n\n       \n   \n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/WhatsAppSettingsController.cs",
      "sha256": "6b6de192548e37ead96a0668c85cf9e3f11af021e1fefe4084442cdf359f5e49",
      "language": "csharp",
      "size": 18057,
      "content": "// üìÑ File: WhatsAppSettings/Controllers/WhatsAppSettingsController.cs\nusing Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing System;\nusing System.Linq;\nusing System.Security.Claims;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.WhatsAppSettings.Services;\nusing xbytechat.api.Shared; // for User.GetBusinessId()\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat.api.WhatsAppSettings.Services;\nusing xbytechat_api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat_api.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    [Authorize]\n    public class WhatsAppSettingsController : ControllerBase\n    {\n        private readonly IWhatsAppSettingsService _svc;\n        private readonly ILogger<WhatsAppSettingsController> _logger;\n        private readonly IWhatsAppSenderService _whatsAppSenderService;\n       \n        public WhatsAppSettingsController(\n            IWhatsAppSettingsService svc,\n            ILogger<WhatsAppSettingsController> logger, IWhatsAppSenderService whatsAppSenderService)\n        {\n            _svc = svc;\n            _logger = logger;\n            _whatsAppSenderService = whatsAppSenderService;\n\n        }\n\n \n        [HttpPut(\"update\")]\n        public async Task<IActionResult> UpdateSetting([FromBody] SaveWhatsAppSettingDto dto)\n        {\n            if (!ModelState.IsValid)\n                return BadRequest(new { message = \"Invalid input.\", errors = ModelState });\n\n            Guid businessId;\n            try { businessId = User.GetBusinessId(); dto.BusinessId = businessId; }\n            catch { return Unauthorized(new { message = \"BusinessId missing or invalid in token.\" }); }\n\n            await _svc.SaveOrUpdateSettingAsync(dto);\n            return Ok(new { message = \"Settings saved/updated.\" });\n        }\n\n        // ----------------------------\n        // Get the current user's saved settings\n        // ----------------------------\n        //[HttpGet(\"me\")]\n        //public async Task<IActionResult> GetMySettings()\n        //{\n        //    var businessId = User.GetBusinessId();\n        //    var setting = await _svc.GetSettingsByBusinessIdAsync(businessId);\n        //    if (setting == null)\n        //        return NotFound(new { message = \"‚ùå WhatsApp settings not found.\" });\n\n        //    return Ok(setting);\n        //}\n        [HttpGet(\"me\")]\n        public async Task<IActionResult> GetMySettings()\n        {\n            var businessId = User.GetBusinessId();\n            var setting = await _svc.GetSettingsByBusinessIdAsync(businessId);\n\n            if (setting == null)\n            {\n                // Expected: user simply hasn't configured settings yet\n                return Ok(new\n                {\n                    ok = true,\n                    hasSettings = false,\n                    data = (object?)null\n                });\n            }\n\n            return Ok(new\n            {\n                ok = true,\n                hasSettings = true,\n                data = setting\n            });\n        }\n\n        // ----------------------------\n        // Test connection using values sent in the body (not necessarily saved)\n        // Accepts Provider = \"Pinnacle\" or \"Meta_cloud\"\n        // ----------------------------\n        [HttpPost(\"test-connection\")]\n        public async Task<IActionResult> TestConnection([FromBody] SaveWhatsAppSettingDto dto)\n        {\n            if (dto is null)\n                return BadRequest(new { message = \"‚ùå Missing request body.\" });\n\n            var provider = NormalizeProvider(dto.Provider);\n            if (provider is null)\n                return BadRequest(new { message = \"‚ùå Provider is required (Pinnacle | Meta_cloud).\" });\n\n            dto.Provider = provider; // use canonical\n\n            // Minimal provider-specific validation (service will validate again)\n            if (provider == \"META_CLOUD\")\n            {\n                if (string.IsNullOrWhiteSpace(dto.ApiUrl) ||\n                    string.IsNullOrWhiteSpace(dto.ApiKey) ||\n                    string.IsNullOrWhiteSpace(dto.PhoneNumberId))\n                {\n                    return BadRequest(new { message = \"‚ùå API URL, Token and Phone Number ID are required for Meta Cloud test.\" });\n                }\n            }\n            else if (provider == \"PINNACLE\")\n            {\n                if (string.IsNullOrWhiteSpace(dto.ApiUrl) ||\n                    string.IsNullOrWhiteSpace(dto.ApiKey) ||\n                    (string.IsNullOrWhiteSpace(dto.WabaId) && string.IsNullOrWhiteSpace(dto.PhoneNumberId)) ||\n                    string.IsNullOrWhiteSpace(dto.WhatsAppBusinessNumber))\n                {\n                    return BadRequest(new\n                    {\n                        message = \"‚ùå API URL, API Key, (WABA ID or Phone Number ID), and Business Number are required for Pinnacle test.\"\n                    });\n                }\n            }\n\n            try\n            {\n                var message = await _svc.TestConnectionAsync(dto);\n\n                // Convention: service returns a human string; we 200 on success (starts with ‚úÖ), 400 otherwise\n                if (!string.IsNullOrEmpty(message) && message.StartsWith(\"‚úÖ\"))\n                    return Ok(new { message });\n\n                return BadRequest(new { message = string.IsNullOrEmpty(message) ? \"‚ùå Test failed.\" : message });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"‚ùå [TestConnection] Failed\");\n                return StatusCode(500, new { message = \"‚ùå Test connection failed.\", details = ex.Message });\n            }\n        }\n\n\n        [HttpPost(\"test-connection/current\")]\n        public async Task<IActionResult> TestConnectionCurrent()\n        {\n            // ---- local helpers (scoped only to this action) ----\n            static string? NormalizeProvider(string? raw)\n            {\n                if (string.IsNullOrWhiteSpace(raw)) return null;\n                var s = raw.Trim().ToLowerInvariant().Replace(\"-\", \"_\").Replace(\" \", \"_\");\n                if (s is \"meta_cloud\" or \"meta\" or \"wa_cloud\" or \"facebook\" or \"whatsapp_cloud\")\n                    return \"META_CLOUD\";\n                if (s is \"pinnacle\" or \"pinnacle_official\" or \"pinbot\")\n                    return \"PINNACLE\";\n                return null; // unknown ‚Üí keep original\n            }\n\n            static string NormalizeApiUrl(string? apiUrl, string? provider)\n            {\n                if (string.Equals(provider, \"META_CLOUD\", StringComparison.Ordinal))\n                    return string.IsNullOrWhiteSpace(apiUrl) ? \"https://graph.facebook.com/v22.0\" : apiUrl.Trim();\n                return string.IsNullOrWhiteSpace(apiUrl) ? string.Empty : apiUrl.Trim();\n            }\n\n            static string? T(string? s) => string.IsNullOrWhiteSpace(s) ? null : s.Trim();\n            // ---- /helpers ----\n\n            var businessId = User.GetBusinessId();\n\n            // Pulls merged settings + number from WhatsAppPhoneNumbers via your service\n            var saved = await _svc.GetSettingsByBusinessIdAsync(businessId); // returns WhatsAppSettingsDto\n            if (saved is null)\n                return NotFound(new { message = \"‚ùå No saved WhatsApp settings found.\" });\n\n            // defensive normalization (safe even if FE already sends uppercase)\n            var provider = NormalizeProvider(saved.Provider) ?? saved.Provider?.Trim().ToUpperInvariant();\n            var apiUrl = NormalizeApiUrl(saved.ApiUrl, provider);\n            var apiKey = T(saved.ApiKey);\n            var phoneId = T(saved.PhoneNumberId);\n            var wabaId = T(saved.WabaId);\n\n            var dto = new SaveWhatsAppSettingDto\n            {\n                BusinessId = businessId,\n                Provider = provider ?? saved.Provider, // keep original if we couldn't map\n                ApiUrl = apiUrl,\n                ApiKey = apiKey,\n                PhoneNumberId = phoneId, // comes from WhatsAppPhoneNumbers via DTO\n                WabaId = wabaId,\n                WhatsAppBusinessNumber = T(saved.WhatsAppBusinessNumber), // from WhatsAppPhoneNumbers\n                SenderDisplayName = null, // not used in test; include if your DTO needs it\n                WebhookSecret = null,     // ^\n                WebhookVerifyToken = null,\n                IsActive = true           // test against the active config\n            };\n\n            // Provider-specific guardrails (fail early with clear messages)\n            if (dto.Provider == \"META_CLOUD\")\n            {\n                if (string.IsNullOrEmpty(dto.ApiKey))\n                    return BadRequest(new { message = \"‚ùå Missing Meta access token (ApiKey).\" });\n                if (string.IsNullOrEmpty(dto.PhoneNumberId))\n                    return BadRequest(new { message = \"‚ùå Missing Meta PhoneNumberId (required for messaging endpoint tests).\" });\n                // apiUrl defaulted above if empty\n            }\n            else if (dto.Provider == \"PINNACLE\")\n            {\n                if (string.IsNullOrEmpty(dto.ApiKey))\n                    return BadRequest(new { message = \"‚ùå Missing Pinnacle API key.\" });\n                if (string.IsNullOrEmpty(dto.ApiUrl))\n                    return BadRequest(new { message = \"‚ùå Missing Pinnacle API URL.\" });\n                // WABA/PhoneNumberId may be optional for some Pinnacle routes; your _svc.TestConnectionAsync knows best.\n            }\n            else\n            {\n                return BadRequest(new { message = $\"‚ùå Unsupported provider: {dto.Provider}\" });\n            }\n\n            try\n            {\n                var message = await _svc.TestConnectionAsync(dto);\n\n                if (!string.IsNullOrEmpty(message) && message.StartsWith(\"‚úÖ\"))\n                    return Ok(new { message });\n\n                return BadRequest(new { message = string.IsNullOrEmpty(message) ? \"‚ùå Test failed.\" : message });\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"‚ùå [TestConnectionCurrent] Failed\");\n                return StatusCode(500, new { message = \"‚ùå Test connection failed.\", details = ex.Message });\n            }\n        }\n\n        [HttpDelete(\"delete\")]\n        public async Task<IActionResult> DeleteSetting()\n        {\n            var businessId = User.GetBusinessId();\n            var deleted = await _svc.DeleteSettingsAsync(businessId);\n            if (!deleted) return NotFound(new { message = \"‚ùå No WhatsApp settings found to delete.\" });\n            return Ok(new { message = \"üóëÔ∏è WhatsApp settings deleted successfully.\" });\n        }\n\n        // Optional alias for FE routes that call /delete-current\n        [HttpDelete(\"delete-current\")]\n        public Task<IActionResult> DeleteSettingAlias() => DeleteSetting();\n\n        private static string? NormalizeProvider(string? providerRaw)\n        {\n            if (string.IsNullOrWhiteSpace(providerRaw)) return null;\n\n            var p = providerRaw.Trim();\n\n            // Accept canonical values exactly and a few common variants\n            if (string.Equals(p, \"Pinnacle\", StringComparison.Ordinal)) return \"Pinnacle\";\n            if (string.Equals(p, \"Meta_cloud\", StringComparison.Ordinal)) return \"Meta_cloud\";\n\n            // tolerate some user/legacy variants from older UIs\n            var lower = p.ToLowerInvariant();\n            if (lower is \"pinbot\" or \"pinnacle (official)\" or \"pinnacle (pinnacle)\" or \"pinnacle official\")\n                return \"Pinnacle\";\n            if (lower is \"meta cloud\" or \"meta\" or \"meta-cloud\")\n                return \"Meta_cloud\";\n\n            return null;\n        }\n\n        [HttpGet(\"callback-url\")]\n        public async Task<IActionResult> GetMyCallbackUrl([FromServices] IConfiguration cfg)\n        {\n            var businessId = User.GetBusinessId();\n            var baseUrl = cfg[\"App:PublicBaseUrl\"] ?? string.Empty;\n            var url = await _svc.GetCallbackUrlAsync(businessId, baseUrl);\n            return Ok(new { callbackUrl = url });\n        }\n\n        [HttpGet(\"all\")]\n        public async Task<IActionResult> GetAllForBusinessAsync([FromServices] IWhatsAppSettingsService settingsService)\n        {\n            // Resolve BusinessId from claim/header/query (same pattern used elsewhere)\n            if (!TryResolveBusinessId(HttpContext, User, out var businessId))\n                return BadRequest(\"BusinessId is required (claim/header/query).\");\n\n            var items = await settingsService.GetAllForBusinessAsync(businessId);\n            return Ok(items);\n        }\n\n        // local helper (add once in this controller if you don‚Äôt already have it)\n        private static bool TryResolveBusinessId(HttpContext ctx, ClaimsPrincipal user, out Guid businessId)\n        {\n            businessId = Guid.Empty;\n\n            var claim = user?.FindFirst(\"BusinessId\") ?? user?.FindFirst(\"businessId\");\n            if (claim != null && Guid.TryParse(claim.Value, out businessId))\n                return true;\n\n            if (ctx.Request.Headers.TryGetValue(\"X-Business-Id\", out var h)\n                && Guid.TryParse(h.ToString(), out businessId))\n                return true;\n\n            if (Guid.TryParse(ctx.Request.Query[\"businessId\"], out businessId))\n                return true;\n\n            return false;\n        }\n\n        // GET /api/whatsapp/senders/{businessId}\n        [HttpGet(\"senders/{businessId:guid}\")]     // <-- align action path\n        public async Task<IActionResult> GetSenders(Guid businessId)\n        {\n            if (businessId == Guid.Empty)\n                return BadRequest(new { message = \"Invalid businessId.\" });\n\n            var items = await _whatsAppSenderService.GetBusinessSendersAsync(businessId);\n            return Ok(items);\n        }\n\n\n       \n        [HttpPost(\"fetch-numbers\")]\n        public async Task<IActionResult> FetchNumbers([FromServices] IWhatsAppPhoneNumberService phoneSvc,\n           [FromServices] IWhatsAppSettingsService settingsSvc,\n              CancellationToken ct = default)\n        {\n            // --- helpers ---\n            static string? NormalizeProvider(string? raw)\n            {\n                if (string.IsNullOrWhiteSpace(raw)) return null;\n                var s = raw.Trim().ToLowerInvariant().Replace(\"-\", \"_\").Replace(\" \", \"_\");\n                if (s is \"meta_cloud\" or \"meta\" or \"wa_cloud\" or \"facebook\" or \"whatsapp_cloud\")\n                    return \"META_CLOUD\";\n                if (s is \"pinnacle\" or \"pinnacle_official\" or \"pinbot\")\n                    return \"PINNACLE\";\n                return null;\n            }\n            static string NormalizeApiUrl(string? apiUrl, string? provider)\n            {\n                if (string.Equals(provider, \"META_CLOUD\", StringComparison.Ordinal))\n                    return string.IsNullOrWhiteSpace(apiUrl) ? \"https://graph.facebook.com/v22.0\" : apiUrl.Trim();\n                return string.IsNullOrWhiteSpace(apiUrl) ? string.Empty : apiUrl.Trim();\n            }\n            static string? T(string? s) => string.IsNullOrWhiteSpace(s) ? null : s.Trim();\n            // ---------------\n\n            var businessId = User.GetBusinessId();\n\n            // Pull merged settings (includes PhoneNumberId/WhatsAppBusinessNumber from WhatsAppPhoneNumbers)\n            var saved = await settingsSvc.GetSettingsByBusinessIdAsync(businessId); // returns WhatsAppSettingsDto\n            if (saved is null)\n                return BadRequest(new { message = \"‚ùå No saved WhatsApp settings found.\" });\n\n            // Normalize provider/apiUrl defensively\n            var provider = NormalizeProvider(saved.Provider) ?? saved.Provider?.Trim().ToUpperInvariant();\n            if (provider != \"PINNACLE\" && provider != \"META_CLOUD\")\n                return BadRequest(new { message = $\"‚ùå Unsupported provider: {saved.Provider}\" });\n\n            var normalized = new WhatsAppSettingsDto\n            {\n                BusinessId = saved.BusinessId,\n                Provider = provider!,\n                ApiUrl = NormalizeApiUrl(saved.ApiUrl, provider),\n                ApiKey = T(saved.ApiKey),\n                WabaId = T(saved.WabaId),\n                PhoneNumberId = T(saved.PhoneNumberId),                 // current default (may be null)\n                WhatsAppBusinessNumber = T(saved.WhatsAppBusinessNumber)\n            };\n\n            // Guardrails (clear, early, provider-specific)\n            if (provider == \"META_CLOUD\")\n            {\n                if (string.IsNullOrWhiteSpace(normalized.ApiKey))\n                    return BadRequest(new { message = \"‚ùå Missing Meta access token (ApiKey).\" });\n                if (string.IsNullOrWhiteSpace(normalized.WabaId))\n                    return BadRequest(new { message = \"‚ùå WABA ID is required to fetch numbers from Meta Cloud.\" });\n            }\n            else // PINNACLE\n            {\n                if (string.IsNullOrWhiteSpace(normalized.ApiKey))\n                    return BadRequest(new { message = \"‚ùå Missing Pinnacle API key.\" });\n                if (string.IsNullOrWhiteSpace(normalized.ApiUrl))\n                    return BadRequest(new { message = \"‚ùå Missing Pinnacle API URL.\" });\n                if (string.IsNullOrWhiteSpace(normalized.WabaId) && string.IsNullOrWhiteSpace(normalized.PhoneNumberId))\n                    return BadRequest(new { message = \"‚ùå WABA ID or PhoneNumberId required to fetch numbers from Pinnacle.\" });\n            }\n\n            // Sync/ingest numbers from the provider into WhatsAppPhoneNumbers table\n            var result = await phoneSvc.SyncFromProviderAsync(businessId, normalized, provider!, ct);\n\n            return Ok(new\n            {\n                success = true,\n                added = result.Added,\n                updated = result.Updated,\n                total = result.Total,\n                provider = provider\n            });\n        }\n\n\n\n    }\n\n}\n\n\n\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Controllers/WhatsAppTemplateFetcherController.cs",
      "sha256": "423175eb5cd31766ee4c3fe215cb17108c3cf6bc44948fc0f52a88e8a000ad39",
      "language": "csharp",
      "size": 3072,
      "content": "using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Mvc;\nusing xbytechat_api.WhatsAppSettings.Services;\n\nnamespace xbytechat_api.WhatsAppSettings.Controllers\n{\n    [ApiController]\n    [Route(\"api/[controller]\")]\n    public class WhatsAppTemplateFetcherController : ControllerBase\n    {\n        private readonly IWhatsAppTemplateFetcherService _templateFetcherService;\n\n        public WhatsAppTemplateFetcherController(IWhatsAppTemplateFetcherService templateFetcherService)\n        {\n            _templateFetcherService = templateFetcherService;\n        }\n\n        [HttpGet(\"get-template/{businessId}\")]\n        [Authorize] // ‚úÖ Optional: Require authentication if your project uses JWT auth\n        public async Task<IActionResult> FetchTemplates(Guid businessId)\n        {\n            if (businessId == Guid.Empty)\n                return BadRequest(new { message = \"‚ùå Invalid BusinessId.\" });\n\n            var templates = await _templateFetcherService.FetchTemplatesAsync(businessId); // comment this line to stop fetch template as per businessid\n            //var templates = await _templateFetcherService.FetchAllTemplatesAsync(); // comment this line to stop fetch template as per businessid\n\n            return Ok(new\n            {\n                success = true,\n                templates = templates\n            });\n        }\n\n      \n\n        [HttpGet(\"get-template-all\")]\n        public async Task<IActionResult> GetAllTemplatesAsync()\n        {\n            try\n            {\n                var templates = await _templateFetcherService.FetchAllTemplatesAsync();\n                return Ok(new { success = true, templates });\n            }\n            catch (Exception ex)\n            {\n                return StatusCode(500, new\n                {\n                    success = false,\n                    message = \"Error fetching templates\",\n                    detail = ex.Message\n                });\n            }\n        }\n\n        [HttpGet(\"get-template-by-name\")]\n        public async Task<IActionResult> GetTemplateByName([FromQuery] string name)\n        {\n            var businessId = Guid.Parse(User.FindFirst(\"businessId\")?.Value);\n            var template = await _templateFetcherService.GetTemplateByNameAsync(businessId, name, true);\n            return template == null ? NotFound() : Ok(template);\n        }\n        [HttpGet(\"get-by-name/{businessId}/{templateName}\")]\n        public async Task<IActionResult> GetByName(Guid businessId, string templateName, [FromQuery] bool includeButtons = true)\n        {\n            if (businessId == Guid.Empty || string.IsNullOrWhiteSpace(templateName))\n                return BadRequest(new { success = false, message = \"‚ùå Missing or invalid parameters.\" });\n\n            var template = await _templateFetcherService.GetTemplateByNameAsync(businessId, templateName, includeButtons);\n\n            if (template == null)\n                return NotFound();\n\n            return Ok(new\n            {\n                success = true,\n                template\n            });\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/ButtonMetadataDto.cs",
      "sha256": "55b2b89dbf3f8b8f16bb134711c23334c37a60c9543a1ea34325fb89506a6dce",
      "language": "csharp",
      "size": 536,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public class ButtonMetadataDto\n    {\n        public string Type { get; set; } // Example: \"URL\" or \"PHONE_NUMBER\"\n        public string Text { get; set; } // Button Text\n        public string SubType { get; set; } // (optional) for URL, Phone Number etc\n        public int Index { get; set; } // Index like 0, 1\n                                       // Optional: dynamic parameter value for validation\n        public string? ParameterValue { get; set; } // e.g. coupon_code\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/SaveWhatsAppSettingDto.cs",
      "sha256": "9c7ba8be0ccb6695a19a15e08fa4ef3542ae0978f21c1129b75fb4975cf74a32",
      "language": "csharp",
      "size": 1324,
      "content": "// üìÑ File: WhatsAppSettings/DTOs/SaveWhatsAppSettingDto.cs\nusing System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace xbytechat_api.WhatsAppSettings.DTOs\n{\n    public class SaveWhatsAppSettingDto\n    {\n        public Guid BusinessId { get; set; }\n\n        // Which provider: \"pinnacle\" | \"meta_cloud\"\n        [Required, MaxLength(50)]\n        public string Provider { get; set; } = string.Empty;\n\n        [Required, MaxLength(500)]\n        public string ApiUrl { get; set; } = string.Empty;\n\n        [MaxLength(1000)]\n        public string? ApiKey { get; set; } // Pinnacle\n\n      \n        [MaxLength(100)]\n        public string? PhoneNumberId { get; set; } // Meta Cloud\n\n        [MaxLength(100)]\n        public string? WabaId { get; set; } // Optional (Pinnacle/Meta)\n\n        [MaxLength(50)]\n        public string? WhatsAppBusinessNumber { get; set; }\n\n        [MaxLength(100)]\n        public string? SenderDisplayName { get; set; }\n\n        [MaxLength(200)]\n        public string? WebhookSecret { get; set; }\n\n        [MaxLength(200)]\n        public string? WebhookVerifyToken { get; set; }\n\n        // üëá NEW: per-provider callback URL (optional, stored in DB)\n        [MaxLength(1000)]\n        public string? WebhookCallbackUrl { get; set; }\n\n        public bool IsActive { get; set; } = true;\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateCatalogItem.cs",
      "sha256": "54c972f09c8bcba9a6e5138aa436898303927539032d8fe46cab52a7f283f3b4",
      "language": "csharp",
      "size": 567,
      "content": "// xbytechat.api/WhatsAppSettings/DTOs/TemplateCatalogItem.cs\nnamespace xbytechat.api.WhatsAppSettings.DTOs\n{\n   \n\n \n    public sealed record TemplateButtonMetadataDto\n    {\n        public string Text { get; init; } = \"\";\n        public string Type { get; init; } = \"\";     // META raw: URL / QUICK_REPLY / PHONE_NUMBER / ...\n        public string SubType { get; init; } = \"\";  // url / quick_reply / voice_call / ...\n        public int Index { get; init; }             // position in the button list\n        public string ParameterValue { get; init; } = \"\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateForUIResponseDto.cs",
      "sha256": "954d4bddaa8450da19f714aec8f819d5affa5edcee6a6e078759e3bcb04b47be",
      "language": "csharp",
      "size": 427,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public class TemplateForUIResponseDto\n    {\n        public string Name { get; set; } = \"\";\n        public string Language { get; set; } = \"en_US\";\n        public string Body { get; set; } = \"\";\n        public int ParametersCount { get; set; }\n        public bool HasImageHeader { get; set; }\n        public List<ButtonMetadataDto> ButtonParams { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateMetadataDto.cs",
      "sha256": "154918abf3d7b2efa65ebcef2084ae33404f5eab44188b98d9e05a554462a4d6",
      "language": "csharp",
      "size": 968,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    /// <summary>\n    /// DTO representing a simplified view of WhatsApp template metadata.\n    /// </summary>\n    public class TemplateMetadataDto\n    {\n        /// Unique name of the template.\n        public string Name { get; set; } = string.Empty;\n\n        /// Language code used when creating the template (e.g., en_US, hi_IN).\n        public string Language { get; set; } = \"en_US\";\n\n        /// The message body content with placeholders (e.g., \"Hi {{1}}, your order is ready\").\n        public string Body { get; set; } = string.Empty;\n\n        /// Number of dynamic parameters required (e.g., 2 for {{1}} and {{2}}).\n        public int PlaceholderCount { get; set; }\n\n        public List<ButtonMetadataDto> ButtonParams { get; set; } = new List<ButtonMetadataDto>(); // ‚úÖ Added Buttons\n        public bool HasImageHeader { get; set; } = true;\n\n        public string HeaderKind { get; set; } = \"none\";\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateMetaDto.cs",
      "sha256": "2806aa041b83e7e1ef645c67f18f7d455aac9bdd1fcce9c4538b76786132c9ff",
      "language": "csharp",
      "size": 1516,
      "content": "using System.Collections.Generic;\n\nnamespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    // Normalized snapshot of a provider template for FE + snapshots\n    public sealed class TemplateMetaDto\n    {\n        public string Provider { get; set; } = \"\";     // \"META_CLOUD\" | \"PINNACLE\"\n        public string TemplateId { get; set; } = \"\";   // provider‚Äôs id if you store it\n        public string TemplateName { get; set; } = \"\";\n        public string Language { get; set; } = \"\";     // e.g., \"en_US\"\n\n        public bool HasHeaderMedia { get; set; }\n        public string? HeaderType { get; set; }        // \"IMAGE\" | \"VIDEO\" | \"DOCUMENT\" (future)\n\n        // 1-based placeholder slots for BODY\n        public List<PlaceholderSlot> BodyPlaceholders { get; set; } = new();\n\n        // Up to 3 buttons in template order\n        public List<TemplateButtonMeta> Buttons { get; set; } = new();\n\n    }\n\n    public sealed class TemplateButtonMeta\n    {\n        // Provider-level type (e.g., \"URL\", \"PHONE_NUMBER\", \"QUICK_REPLY\")\n        public string Type { get; set; } = \"\";\n        public string Text { get; set; } = \"\";         // label\n        public string? Value { get; set; }             // ParameterValue from provider (may contain \"{{1}}\")\n        public int Order { get; set; }                 // 0..2\n    }\n\n    public sealed class PlaceholderSlot\n    {\n        public int Index { get; set; }                 // 1..N\n        public string? Label { get; set; }\n        public string? Example { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplatePreviewDto.cs",
      "sha256": "ea9fe018139bee52670ef4b1030e185040a735c6eb91257088e675e75a40e3e1",
      "language": "csharp",
      "size": 2223,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public sealed class TemplatePreviewRequestDto\n    {\n        public string TemplateName { get; set; } = \"\";\n        public string? Provider { get; set; }          // \"META_CLOUD\" | \"PINNACLE\" (optional)\n        public string? Language { get; set; }          // e.g., \"en_US\" (optional)\n        public string? HeaderImageUrl { get; set; }    // for image-header previews\n        public List<string> TemplateParameters { get; set; } = new();  // BODY params in order\n        public List<PreviewButtonInputDto> Buttons { get; set; } = new(); // up to 3\n    }\n\n    public sealed class PreviewButtonInputDto\n    {\n        public int Position { get; set; }              // 1..3 aligns with template button order\n        public string? Type { get; set; }              // e.g., \"URL\"\n        public string? Title { get; set; }             // label shown to user (optional)\n        public string? Value { get; set; }             // for dynamic URL value or tel/wa deep link\n    }\n\n    public sealed class TemplatePreviewResponseDto\n    {\n        public bool FoundTemplate { get; set; }\n        public string TemplateName { get; set; } = \"\";\n        public string? Language { get; set; }\n        public bool HasHeaderMedia { get; set; }\n        public string HeaderType { get; set; } = \"\";   // \"IMAGE\", \"VIDEO\", etc.\n\n        public int RequiredPlaceholderCount { get; set; }\n        public int ProvidedPlaceholderCount { get; set; }\n        public List<int> MissingPlaceholderIndices { get; set; } = new(); // 1-based\n        public List<string> Warnings { get; set; } = new();\n        public List<string> Errors { get; set; } = new();\n\n        // A provider-shaped preview of what we'd send (Meta/Pinnacle use the same component shape)\n        // Example:\n        // [\n        //   { type:\"header\", parameters:[{ type:\"image\", image:{ link:\"...\"}}]},\n        //   { type:\"body\", parameters:[{type:\"text\",text:\"..\"}, ...] },\n        //   { type:\"button\", sub_type:\"url\", index:\"0\", parameters:[{ type:\"text\", text:\"TOKEN_OR_URL\"}] }\n        // ]\n        public List<object> ProviderComponentsPreview { get; set; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateShape.cs",
      "sha256": "b09887fc7a92992bd71f628553412f5a86b5164c175bc94e37286378488ab975",
      "language": "csharp",
      "size": 93,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public class TemplateShape\n    {\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateSummaryDto.cs",
      "sha256": "fe362a273559fdfadca0d5c953779523b4c3312685fd4043802ac0c9453a2a8f",
      "language": "csharp",
      "size": 2996,
      "content": "using System;\nusing System.Collections.Generic;\n\nnamespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    /// <summary>\n    /// Section-aware summary of a provider template.\n    /// Distinct slots are tracked per section to avoid collisions (e.g., header {{1}} vs body {{1}}).\n    /// </summary>\n    public sealed class TemplateSummaryDto\n    {\n        // --- What users see in CSV/FE ---\n        public string HeaderKind { get; init; } = \"none\";           // none | text | image | video | document\n        public string? HeaderText { get; init; }                    // original header text if TEXT\n        public string? BodyText { get; init; }                      // original body text\n        public string CombinedPreviewBody { get; init; } = \"\";      // HeaderText + \"\\n\\n\" + BodyText (for FE/CSV)\n\n        // --- Distinct slot lists per section (order of appearance) ---\n        public List<int> HeaderParamIndices { get; init; } = new(); // e.g., [1,2]\n        public List<int> BodyParamIndices { get; init; } = new();   // e.g., [1,2,3]\n\n        // Per-button parameter templates (URL/tel/etc), each with their own local indices\n        public List<ButtonParamTemplate> Buttons { get; init; } = new(); // up to 3, in template order (1..3)\n\n        // Convenience total for CSV/validation (sum across sections, not union)\n        public int PlaceholderCount { get; init; }                  // HeaderParamIndices.Count + BodyParamIndices.Count + Œ£ Buttons[i].ParamIndices.Count\n    }\n\n    public sealed class ButtonParamTemplate\n    {\n        public int Order { get; init; }                 // 1..3 (template order)\n        public string Type { get; init; } = \"\";         // URL | PHONE_NUMBER | QUICK_REPLY | FLOW | ...\n        public string Text { get; init; } = \"\";         // Button label\n        public string? ParamTemplate { get; init; }     // e.g., \"https://x.example/{{1}}\", \"tel:+911234567890\"\n        public List<int> ParamIndices { get; init; } = new(); // e.g., [1]\n    }\n\n    /// <summary>\n    /// Result of filling values across all sections in the agreed order:\n    /// [ header slots... , body slots... , (btn1 slots...), (btn2 slots...), ... ]\n    /// </summary>\n    public sealed class TemplateFillResult\n    {\n        public string ResolvedHeaderText { get; init; } = \"\";\n        public string ResolvedBodyText { get; init; } = \"\";\n        public string ResolvedCombinedPreviewBody { get; init; } = \"\";\n        public List<ResolvedButtonParam> ResolvedButtons { get; init; } = new(); // aligned with TemplateSummaryDto.Buttons\n        public List<string> Warnings { get; init; } = new();\n        public List<string> Errors { get; init; } = new();\n    }\n\n    public sealed class ResolvedButtonParam\n    {\n        public int Order { get; init; }            // 1..3\n        public string Type { get; init; } = \"\";\n        public string Text { get; init; } = \"\";\n        public string? ResolvedValue { get; init; } // filled URL/tel/... or original if no placeholders\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/TemplateSummaryResponseDto.cs",
      "sha256": "70bdef8be64a16b303a2543426e521b694e039e2a4f0b1a403f0e8675ff9fb63",
      "language": "csharp",
      "size": 473,
      "content": "using System.Collections.Generic;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat.api.Features.WhatsAppSettings.DTOs\n{\n    public sealed class TemplateSummaryResponseDto\n    {\n        public string TemplateId { get; init; } = \"\";\n        public string Provider { get; init; } = \"\";\n        public string Name { get; init; } = \"\";\n        public string Language { get; init; } = \"\";\n\n        public TemplateSummaryDto Summary { get; init; } = new();\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/WhatsAppSenderDto.cs",
      "sha256": "8c113389ea7e922d92ef3a6f8538003ea60f8a62298e0622300bf845f290668c",
      "language": "csharp",
      "size": 869,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public class WhatsAppSenderDto\n    {\n        public Guid Id { get; set; }                         // row id in WhatsAppPhoneNumbers\n        public Guid BusinessId { get; set; }\n        public string Provider { get; set; } = string.Empty; // \"PINNACLE\" | \"META_CLOUD\"\n        public string PhoneNumberId { get; set; } = string.Empty;\n        public string WhatsAppBusinessNumber { get; set; } = string.Empty; // E.164 printable\n        public string? SenderDisplayName { get; set; }\n        public bool IsActive { get; set; }\n        public bool IsDefault { get; set; }\n        public string DisplayLabel =>\n            string.IsNullOrWhiteSpace(SenderDisplayName)\n                ? $\"{WhatsAppBusinessNumber} ‚Ä¢ {Provider}\"\n                : $\"{SenderDisplayName} ({WhatsAppBusinessNumber}) ‚Ä¢ {Provider}\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/DTOs/WhatsAppSettingsDto.cs",
      "sha256": "8f45c102277a57f946fd1bf84f0bbabf4986f0035b4dbbe9cbea8d98054fc998",
      "language": "csharp",
      "size": 539,
      "content": "namespace xbytechat.api.WhatsAppSettings.DTOs\n{\n    public sealed class WhatsAppSettingsDto\n    {\n        public Guid BusinessId { get; init; }\n        public string Provider { get; init; } = string.Empty;\n        public string ApiUrl { get; init; } = string.Empty;\n        public string? ApiKey { get; init; }\n        public string? WabaId { get; init; }\n\n        public string? PhoneNumberId { get; init; }  // from WhatsAppPhoneNumbers\n        public string? WhatsAppBusinessNumber { get; init; }  // from WhatsAppPhoneNumbers\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Helpers/TemplateJsonHelper.cs",
      "sha256": "aedaa16cd4ce9f6feff139747eee0211d6fb2fc2bf7aaef8492e2edb080a4bb3",
      "language": "csharp",
      "size": 13934,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text.RegularExpressions;\nusing Newtonsoft.Json.Linq;\n\nnamespace xbytechat.api.WhatsAppSettings.Helpers\n{\n    public static class TemplateJsonHelper\n    {\n        // Positional like {{1}}\n        private static readonly Regex PositionalRx = new(@\"\\{\\{\\s*(\\d+)\\s*\\}\\}\", RegexOptions.Compiled);\n        // Named like {{first_name}}  (letters, digits, _, -, starting with letter/_)\n        private static readonly Regex NamedRx = new(@\"\\{\\{\\s*([A-Za-z_][A-Za-z0-9_\\-]*)\\s*\\}\\}\", RegexOptions.Compiled);\n        // Any like {{...}} ‚Äî used for total counting / empty braces\n        private static readonly Regex AnyRx = new(@\"\\{\\{[^}]*\\}\\}\", RegexOptions.Compiled);\n\n        public static (string HeaderKind, string CombinedBody, int PlaceholderCount)\n            Summarize(string rawJson, string? bodyFallback = null)\n        {\n            var d = SummarizeDetailed(rawJson, bodyFallback);\n            return (d.HeaderKind ?? \"none\", d.CombinedPreviewBody ?? string.Empty, d.PlaceholderCount);\n        }\n\n        public static TemplateSummaryDto SummarizeDetailed(string rawJson, string? bodyFallback = null)\n        {\n            var doc = JToken.Parse(string.IsNullOrWhiteSpace(rawJson) ? \"{}\" : rawJson);\n            var components = doc[\"components\"] as JArray ?? new JArray();\n\n            // Provider hint (may be null/empty)\n            var parameterFormatHint = doc[\"parameter_format\"]?.ToString()?.ToUpperInvariant(); // \"POSITIONAL\" | \"NAMED\" | null\n\n            string headerKind = \"none\";\n            string? headerText = null;\n            string? bodyText = null;\n\n            var headerPosIdx = new List<int>();\n            var bodyPosIdx = new List<int>();\n            var buttons = new List<ButtonParamTemplate>();\n            var occurrences = new List<PlaceholderOccurrence>();\n\n            int order = 0;\n\n            foreach (var comp in components)\n            {\n                var type = comp?[\"type\"]?.ToString()?.ToUpperInvariant();\n                if (string.IsNullOrEmpty(type)) continue;\n\n                if (type == \"HEADER\")\n                {\n                    var format = comp?[\"format\"]?.ToString()?.ToUpperInvariant();\n                    headerKind = format switch\n                    {\n                        \"TEXT\" => \"text\",\n                        \"IMAGE\" => \"image\",\n                        \"VIDEO\" => \"video\",\n                        \"DOCUMENT\" => \"document\",\n                        _ => \"none\"\n                    };\n\n                    if (headerKind == \"text\")\n                    {\n                        headerText = comp?[\"text\"]?.ToString() ?? \"\";\n                        headerPosIdx = ExtractPositional(headerText);\n                        occurrences.AddRange(CollectOccurrences(headerText, PlaceholderLocation.Header));\n                    }\n                }\n                else if (type == \"BODY\")\n                {\n                    bodyText = comp?[\"text\"]?.ToString() ?? \"\";\n                    bodyPosIdx = ExtractPositional(bodyText);\n                    occurrences.AddRange(CollectOccurrences(bodyText, PlaceholderLocation.Body));\n                }\n                else if (type == \"BUTTONS\")\n                {\n                    var btns = comp?[\"buttons\"] as JArray ?? new JArray();\n                    foreach (var b in btns)\n                    {\n                        order++;\n                        var btnType = b?[\"type\"]?.ToString()?.ToUpperInvariant() ?? \"\";\n                        var text = b?[\"text\"]?.ToString() ?? \"\";\n\n                        string? urlLike =\n                            b?[\"url\"]?.ToString()\n                            ?? b?[\"phone_number\"]?.ToString()\n                            ?? b?[\"coupon_code\"]?.ToString()\n                            ?? b?[\"flow_id\"]?.ToString();\n\n                        // ‚Äúexample‚Äù can be string or array\n                        if (string.IsNullOrWhiteSpace(urlLike))\n                        {\n                            var ex = b?[\"example\"];\n                            if (ex is JArray arr) urlLike = arr.FirstOrDefault()?.ToString();\n                            else if (ex is JValue val) urlLike = val.ToString();\n                        }\n\n                        var tmpl = urlLike;\n                        var posIdx = string.IsNullOrEmpty(tmpl) ? new List<int>() : ExtractPositional(tmpl);\n\n                        buttons.Add(new ButtonParamTemplate\n                        {\n                            Order = order,\n                            Type = btnType,\n                            Text = text,\n                            ParamTemplate = tmpl,\n                            ParamIndices = posIdx\n                        });\n\n                        // collect occurrences for button text & param template separately\n                        if (!string.IsNullOrEmpty(text))\n                            occurrences.AddRange(CollectOccurrences(text, PlaceholderLocation.Button, order, \"text\"));\n\n                        if (!string.IsNullOrEmpty(tmpl))\n                            occurrences.AddRange(CollectOccurrences(tmpl!, PlaceholderLocation.Button, order, \"param\"));\n                    }\n                }\n            }\n\n            // fallback if no BODY block present in JSON\n            bodyText ??= bodyFallback ?? \"\";\n\n            var combined = CombinePreview(headerText, bodyText);\n\n            // Positional counting ‚Üí max index across header/body/buttons\n            var maxHeader = headerPosIdx.DefaultIfEmpty(0).Max();\n            var maxBody = bodyPosIdx.DefaultIfEmpty(0).Max();\n            var maxBtns = buttons.SelectMany(b => b.ParamIndices).DefaultIfEmpty(0).Max();\n            var maxPositional = Math.Max(maxHeader, Math.Max(maxBody, maxBtns));\n\n            int placeholderCount;\n            if (maxPositional > 0)\n            {\n                placeholderCount = maxPositional;\n            }\n            else\n            {\n                // Named/empty mode ‚Üí total {{...}} across header/body/buttons\n                placeholderCount =\n                    CountAny(headerText) +\n                    CountAny(bodyText) +\n                    buttons.Sum(b => CountAny(b.ParamTemplate)) +\n                    // button text may also contain placeholders\n                    buttons.Sum(b => CountAny(b.Text));\n            }\n\n            // ----- ParameterFormat resolution (hint ‚Üí inference) -----\n            string? parameterFormat = null;\n            if (parameterFormatHint == \"POSITIONAL\" || parameterFormatHint == \"NAMED\")\n            {\n                parameterFormat = parameterFormatHint;\n            }\n            else\n            {\n                // Infer from content\n                var hasPositional = maxPositional > 0;\n                var hasNamed = occurrences.Any(o => o.Type == PlaceholderType.Named);\n\n                if (hasPositional) parameterFormat = \"POSITIONAL\";\n                else if (hasNamed) parameterFormat = \"NAMED\";\n                else parameterFormat = null; // unknown / no placeholders\n            }\n\n            return new TemplateSummaryDto\n            {\n                HeaderKind = headerKind,\n                HeaderText = headerText,\n                BodyText = bodyText,\n                CombinedPreviewBody = combined,\n                HeaderParamIndices = headerPosIdx,\n                BodyParamIndices = bodyPosIdx,\n                Buttons = buttons,\n                PlaceholderCount = placeholderCount,\n                Placeholders = occurrences,\n\n                // NEW: summary flag so services don't have to re-derive this\n                ParameterFormat = parameterFormat\n            };\n        }\n\n\n        /// <summary>Render a text with positional placeholders ({{1}}, {{2}}, ‚Ä¶).</summary>\n        public static string RenderTextPositional(string? template, IReadOnlyDictionary<int, string> args)\n        {\n            if (string.IsNullOrEmpty(template)) return string.Empty;\n            // Replace highest-first to avoid {{1}} touching characters that form {{10}}\n            // Using Regex evaluator is safer:\n            return PositionalRx.Replace(template, m =>\n            {\n                var idx = int.Parse(m.Groups[1].Value);\n                return args.TryGetValue(idx, out var val) ? val ?? string.Empty : string.Empty;\n            });\n        }\n\n        /// <summary>Render a text with named placeholders ({{name}}, {{email}}). Empty {{}} treated as next positional index (1-based).</summary>\n        public static string RenderTextNamed(string? template, IReadOnlyDictionary<string, string> namedArgs, IReadOnlyDictionary<int, string>? positionalArgs = null)\n        {\n            if (string.IsNullOrEmpty(template)) return string.Empty;\n\n            // First replace named\n            var result = NamedRx.Replace(template, m =>\n            {\n                var key = m.Groups[1].Value;\n                return namedArgs.TryGetValue(key, out var val) ? val ?? string.Empty : string.Empty;\n            });\n\n            // Then positional if provided\n            if (positionalArgs != null && positionalArgs.Count > 0)\n            {\n                result = RenderTextPositional(result, positionalArgs);\n            }\n\n            // Finally convert empty {{}} ‚Üí empty string (or you could plug a policy here)\n            result = Regex.Replace(result, @\"\\{\\{\\s*\\}\\}\", string.Empty);\n\n            return result;\n        }\n\n        // ---------- internal helpers ----------\n\n        private static List<int> ExtractPositional(string text)\n            => PositionalRx.Matches(text).Select(m => int.Parse(m.Groups[1].Value)).Distinct().ToList();\n\n        private static int CountAny(string? text)\n            => string.IsNullOrEmpty(text) ? 0 : AnyRx.Matches(text).Count;\n\n        private static string CombinePreview(string? header, string? body)\n        {\n            var h = string.IsNullOrWhiteSpace(header) ? null : header!.Trim();\n            var b = string.IsNullOrWhiteSpace(body) ? null : body!.Trim();\n            if (h is null && b is null) return \"\";\n            if (h is null) return b!;\n            if (b is null) return h!;\n            return $\"{h}\\n\\n{b}\";\n        }\n\n        private static IEnumerable<PlaceholderOccurrence> CollectOccurrences(\n            string text,\n            PlaceholderLocation location,\n            int? buttonOrder = null,\n            string? buttonField = null)\n        {\n            // Positional\n            foreach (Match m in PositionalRx.Matches(text))\n            {\n                yield return new PlaceholderOccurrence\n                {\n                    Type = PlaceholderType.Positional,\n                    Index = int.Parse(m.Groups[1].Value),\n                    Raw = m.Value,\n                    Location = location,\n                    ButtonOrder = buttonOrder,\n                    ButtonField = buttonField\n                };\n            }\n            // Named\n            foreach (Match m in NamedRx.Matches(text))\n            {\n                yield return new PlaceholderOccurrence\n                {\n                    Type = PlaceholderType.Named,\n                    Name = m.Groups[1].Value,\n                    Raw = m.Value,\n                    Location = location,\n                    ButtonOrder = buttonOrder,\n                    ButtonField = buttonField\n                };\n            }\n            // Empty braces (that weren‚Äôt positional or named)\n            // We count them by subtracting positional+named from all-any.\n            var any = AnyRx.Matches(text).Cast<Match>().Select(mm => mm.Value).ToList();\n            var consumed = new HashSet<string>(PositionalRx.Matches(text).Cast<Match>().Select(mm => mm.Value)\n                .Concat(NamedRx.Matches(text).Cast<Match>().Select(mm => mm.Value)));\n            foreach (var token in any.Where(t => !consumed.Contains(t)))\n            {\n                yield return new PlaceholderOccurrence\n                {\n                    Type = PlaceholderType.Empty,\n                    Raw = token,\n                    Location = location,\n                    ButtonOrder = buttonOrder,\n                    ButtonField = buttonField\n                };\n            }\n        }\n    }\n\n    // ---------- DTOs ----------\n\n    public sealed class TemplateSummaryDto\n    {\n        public string HeaderKind { get; set; } = \"none\";\n        public string? HeaderText { get; set; }\n        public string? BodyText { get; set; }\n\n        public List<int> HeaderParamIndices { get; set; } = new();\n        public List<int> BodyParamIndices { get; set; } = new();\n\n        public List<ButtonParamTemplate> Buttons { get; set; } = new();\n\n        public string? CombinedPreviewBody { get; set; }\n\n        public int PlaceholderCount { get; set; }\n\n        public List<PlaceholderOccurrence> Placeholders { get; set; } = new();\n        public string ParameterFormat { get; set; } = \"UNKNOWN\"; // POSITIONAL | NAMED | MIXED | UNKNOWN\n\n    }\n\n    public sealed class ButtonParamTemplate\n    {\n        public int Order { get; set; }\n        public string Type { get; set; } = \"\";\n        public string Text { get; set; } = \"\";\n        public string? ParamTemplate { get; set; }\n        public List<int> ParamIndices { get; set; } = new();\n    }\n\n    public enum PlaceholderType { Positional, Named, Empty }\n\n    public enum PlaceholderLocation {\n\n        Header = 0, Body = 1, Button = 2\n    }\n\n    public sealed class PlaceholderOccurrence\n    {\n        public PlaceholderType Type { get; set; }\n        public int? Index { get; set; }     // for Positional\n        public string? Name { get; set; }   // for Named\n        public string Raw { get; set; } = \"{{}}\";\n        public PlaceholderLocation Location { get; set; }\n        public int? ButtonOrder { get; set; }     // when Location == Button\n        public string? ButtonField { get; set; }  // \"text\" or \"param\"\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Models/WhatsAppPhoneNumber.cs",
      "sha256": "fbcd435532eb4acfc7bf5ec1191078f2598e733541f44cd2a3b768e96436ce0c",
      "language": "csharp",
      "size": 827,
      "content": "using System;\n\nnamespace xbytechat.api.Features.WhatsAppSettings.Models\n{\n    public class WhatsAppPhoneNumber\n    {\n        public Guid Id { get; set; } = Guid.NewGuid();\n\n        public Guid BusinessId { get; set; }\n        public string Provider { get; set; } = null!;                 // \"Meta_cloud\" | \"Pinnacle\" | etc.\n\n        public string PhoneNumberId { get; set; } = null!;            // provider-specific id (e.g., Meta phone_number_id)\n        public string WhatsAppBusinessNumber { get; set; } = null!;   // e.g., \"+15551234567\"\n        public string? SenderDisplayName { get; set; }\n\n        public bool IsActive { get; set; } = true;\n        public bool IsDefault { get; set; } = false;\n\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n        public DateTime? UpdatedAt { get; set; }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Models/WhatsAppSettingEntity.cs",
      "sha256": "d4e6aff67b15f0a503cd217b7ed30bf58b63b5e508dcb5da128ac989a36c6b63",
      "language": "csharp",
      "size": 1835,
      "content": "using System;\nusing System.ComponentModel.DataAnnotations;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\n\nnamespace xbytechat_api.WhatsAppSettings.Models\n{\n    public class WhatsAppSettingEntity\n    {\n        [Key]\n        public Guid Id { get; set; }\n\n        [Required]\n        public Guid BusinessId { get; set; }\n\n        // NEW: which provider this row belongs to (\"pinnacle\", \"meta_cloud\", \"twilio\", etc.)\n        [Required]\n        [MaxLength(50)]\n        public string Provider { get; set; } //= \"pinnacle\";\n\n        [Required]\n        [MaxLength(500)]\n        public string ApiUrl { get; set; }  // e.g. https://partnersv1.pinbot.ai/v3\n\n        [MaxLength(1000)]\n        public string ApiKey { get; set; }\n\n        //[Required]\n        //[MaxLength(1000)]\n        //public string ApiToken { get; set; } // store encrypted\n\n        //[MaxLength(20)]\n       // public string? WhatsAppBusinessNumber { get; set; }\n\n        //public string? PhoneNumberId { get; set; } // used by Meta Cloud; Pinbot doesn't need it\n        public string? WabaId { get; set; } = string.Empty;\n\n        [MaxLength(100)]\n        public string? SenderDisplayName { get; set; }\n\n        // Optional: for webhook signature/verification if provider supports it\n        [MaxLength(200)]\n        public string? WebhookSecret { get; set; }\n\n        [MaxLength(200)]\n\n\n        public string? WebhookVerifyToken { get; set; }\n\n        [MaxLength(1000)]\n        public string? WebhookCallbackUrl { get; set; }\n\n\n        [Required]\n        public bool IsActive { get; set; } = true;\n\n        [Required]\n        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;\n\n        public DateTime? UpdatedAt { get; set; }\n\n        public ICollection<WhatsAppPhoneNumber> WhatsAppBusinessNumbers { get; set; } = new List<WhatsAppPhoneNumber>();\n\n    }\n}\n\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Providers/IMetaTemplateCatalogProvider.cs",
      "sha256": "73c5af3f63545a523d620b39d6c064a1264ba069f156e96dfd4538eba6a15848",
      "language": "csharp",
      "size": 541,
      "content": "using xbytechat.api.WhatsAppSettings.Abstractions;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.WhatsAppSettings.Providers\n{\n    public interface IMetaTemplateCatalogProvider\n    {\n        Task<IReadOnlyList<TemplateCatalogItem>> ListMetaAsync(\n           WhatsAppSettingEntity setting,\n           CancellationToken ct = default);\n\n        Task<TemplateCatalogItem?> GetByNameMetaAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Providers/IPinnacleTemplateCatalogProvider.cs",
      "sha256": "7cb6804a809e2848861752dcdc26f6031e20ed3584ffb9872844faecabd90b67",
      "language": "csharp",
      "size": 551,
      "content": "using xbytechat.api.WhatsAppSettings.Abstractions;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.WhatsAppSettings.Providers\n{\n    public interface IPinnacleTemplateCatalogProvider\n    {\n        Task<IReadOnlyList<TemplateCatalogItem>> ListPinnacleAsync(\n          WhatsAppSettingEntity setting,\n          CancellationToken ct = default);\n\n        Task<TemplateCatalogItem?> GetByNamePinnacleAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Providers/MetaTemplateCatalogProvider.cs",
      "sha256": "5db788f74106c14c8aeb9a145246ce07028eec573af21091ac12806d6d35d6ad",
      "language": "csharp",
      "size": 16844,
      "content": "using System.Globalization;\nusing System.Net.Http.Headers;\nusing System.Text.RegularExpressions;\nusing Microsoft.Extensions.Logging;\nusing Newtonsoft.Json;\nusing xbytechat.api.WhatsAppSettings.Abstractions;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.WhatsAppSettings.Providers\n{\n    public sealed class MetaTemplateCatalogProvider : IMetaTemplateCatalogProvider\n    {\n        private readonly HttpClient _http;\n        private readonly ILogger<MetaTemplateCatalogProvider> _log;\n\n        public MetaTemplateCatalogProvider(HttpClient http, ILogger<MetaTemplateCatalogProvider> log)\n        {\n            _http = http;\n            _log = log;\n        }\n\n        public async Task<IReadOnlyList<TemplateCatalogItem>> ListMetaAsync(\n            WhatsAppSettingEntity s, CancellationToken ct = default)\n        {\n            var items = new List<TemplateCatalogItem>();\n            if (string.IsNullOrWhiteSpace(s.ApiKey) || string.IsNullOrWhiteSpace(s.WabaId))\n                return items;\n\n            var baseUrl = s.ApiUrl?.TrimEnd('/') ?? \"https://graph.facebook.com/v22.0\";\n            var next = $\"{baseUrl}/{s.WabaId}/message_templates?limit=100\";\n\n            _http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", s.ApiKey);\n\n            while (!string.IsNullOrWhiteSpace(next))\n            {\n                ct.ThrowIfCancellationRequested();\n\n                using var req = new HttpRequestMessage(HttpMethod.Get, next);\n                var res = await _http.SendAsync(req, ct);\n                var json = await res.Content.ReadAsStringAsync(ct);\n                if (!res.IsSuccessStatusCode) break;\n\n                dynamic parsed = JsonConvert.DeserializeObject(json);\n                foreach (var tpl in parsed.data)\n                {\n                    try\n                    {\n                        // status filter\n                        string status = (tpl.status?.ToString() ?? \"\").ToUpperInvariant();\n                        if (status != \"APPROVED\" && status != \"ACTIVE\") continue;\n\n                        string name = tpl.name?.ToString() ?? \"\";\n                        string language = tpl.language?.ToString() ?? \"en_US\";\n                        string category = tpl.category?.ToString() ?? \"\";\n                        string externalId = tpl.id?.ToString() ?? \"\";\n\n                        string body = \"\";\n                        bool hasImageHeader = false;\n                        var buttons = new List<ButtonMetadataDto>();\n\n                        foreach (var comp in tpl.components)\n                        {\n                            string type = comp.type?.ToString()?.ToUpperInvariant() ?? \"\";\n\n                            if (type == \"BODY\")\n                            {\n                                body = comp.text?.ToString() ?? \"\";\n                            }\n                            else if (type == \"HEADER\")\n                            {\n                                if (comp.format?.ToString()?.ToUpperInvariant() == \"IMAGE\")\n                                    hasImageHeader = true;\n                            }\n                            else if (type == \"BUTTONS\")\n                            {\n                                if (comp.buttons == null) continue;\n\n                                foreach (var b in comp.buttons)\n                                {\n                                    try\n                                    {\n                                        string btnTypeRaw = b.type?.ToString() ?? \"\";\n                                        string btnType = btnTypeRaw.ToUpperInvariant();\n                                        string text = b.text?.ToString() ?? \"\";\n\n                                        // ---- robust index extraction (avoid RuntimeBinderException) ----\n                                        int index;\n                                        object? idxObj = null;\n                                        try { idxObj = b.index; } catch { /* some payloads omit index */ }\n                                        if (idxObj is int ii) index = ii;\n                                        else if (idxObj is long ll && ll <= int.MaxValue) index = (int)ll;\n                                        else if (idxObj != null && int.TryParse(idxObj.ToString(), NumberStyles.Integer, CultureInfo.InvariantCulture, out var parsedIdx))\n                                            index = parsedIdx;\n                                        else\n                                            index = buttons.Count; // fallback to current count\n\n                                        // normalize subtype & parameter value\n                                        string subType = btnType switch\n                                        {\n                                            \"URL\" => \"url\",\n                                            \"PHONE_NUMBER\" => \"voice_call\",\n                                            \"QUICK_REPLY\" => \"quick_reply\",\n                                            \"COPY_CODE\" => \"copy_code\",\n                                            \"CATALOG\" => \"catalog\",\n                                            \"FLOW\" => \"flow\",\n                                            \"REMINDER\" => \"reminder\",\n                                            \"ORDER_DETAILS\" => \"order_details\",\n                                            _ => \"unknown\"\n                                        };\n\n                                        // try to capture a useful value for URL-like buttons\n                                        string? param =\n                                            b.url != null ? b.url.ToString() :\n                                            b.phone_number != null ? b.phone_number.ToString() :\n                                            b.coupon_code != null ? b.coupon_code.ToString() :\n                                            b.flow_id != null ? b.flow_id.ToString() :\n                                            null;\n\n                                        // ‚Äúexample‚Äù can be array or scalar\n                                        if (string.IsNullOrWhiteSpace(param))\n                                        {\n                                            try\n                                            {\n                                                var ex = b.example;\n                                                if (ex != null)\n                                                {\n                                                    if (ex is string exStr) param = exStr;\n                                                    else\n                                                    {\n                                                        // attempt common shapes: { \"example\": { \"url\": [\"...\"] } } or [\"...\"]\n                                                        var exStr2 = ex.ToString();\n                                                        if (!string.IsNullOrWhiteSpace(exStr2))\n                                                            param = exStr2;\n                                                    }\n                                                }\n                                            }\n                                            catch { /* ignore */ }\n                                        }\n\n                                        // some subtypes require a value; skip if not available\n                                        bool requiresParam = subType is \"url\" or \"flow\" or \"copy_code\" or \"catalog\" or \"reminder\";\n                                        if (subType == \"unknown\" || (requiresParam && string.IsNullOrWhiteSpace(param)))\n                                            continue;\n\n                                        buttons.Add(new ButtonMetadataDto\n                                        {\n                                            Text = text,\n                                            Type = btnType,\n                                            SubType = subType,\n                                            Index = index,\n                                            ParameterValue = param ?? \"\"\n                                        });\n                                    }\n                                    catch (Exception exBtn)\n                                    {\n                                        _log.LogWarning(exBtn, \"[MetaTpl] Button parse failed for template {Name}\", name);\n                                    }\n                                }\n                            }\n                        }\n\n                        int placeholders = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n                        var raw = JsonConvert.SerializeObject(tpl);\n\n                        items.Add(new TemplateCatalogItem(\n                            Name: name,\n                            Language: language,\n                            Body: body,\n                            PlaceholderCount: placeholders,\n                            HasImageHeader: hasImageHeader,\n                            Buttons: buttons,\n                            Status: status,\n                            Category: category,\n                            ExternalId: externalId,\n                            RawJson: raw\n                        ));\n                    }\n                    catch (Exception exItem)\n                    {\n                        _log.LogWarning(exItem, \"[MetaTpl] Skipped bad template item\");\n                    }\n                }\n\n                // paging\n                try { next = parsed?.paging?.next?.ToString(); }\n                catch { next = null; }\n            }\n\n            return items;\n        }\n\n        public async Task<TemplateCatalogItem?> GetByNameMetaAsync(\n            WhatsAppSettingEntity s, string templateName, CancellationToken ct = default)\n        {\n            var all = await ListMetaAsync(s, ct);\n            return all.FirstOrDefault(t => t.Name.Equals(templateName, StringComparison.OrdinalIgnoreCase));\n        }\n    }\n}\n\n//using Newtonsoft.Json;\n//using System.Net.Http.Headers;\n//using System.Text.RegularExpressions;\n//using xbytechat.api.WhatsAppSettings.Abstractions;\n//using xbytechat.api.WhatsAppSettings.DTOs;\n//using xbytechat_api.WhatsAppSettings.Models;\n\n//namespace xbytechat.api.WhatsAppSettings.Providers\n//{\n//    public sealed class MetaTemplateCatalogProvider : ITemplateCatalogProvider\n//    {\n//        private readonly HttpClient _http;\n//        private readonly ILogger<MetaTemplateCatalogProvider> _log;\n\n//        public MetaTemplateCatalogProvider(HttpClient http, ILogger<MetaTemplateCatalogProvider> log)\n//        { _http = http; _log = log; }\n\n//        public async Task<IReadOnlyList<TemplateCatalogItem>> ListAsync(WhatsAppSettingEntity s, CancellationToken ct = default)\n//        {\n//            var items = new List<TemplateCatalogItem>();\n//            if (string.IsNullOrWhiteSpace(s.ApiKey) || string.IsNullOrWhiteSpace(s.WabaId))\n//                return items;\n\n//            var baseUrl = s.ApiUrl?.TrimEnd('/') ?? \"https://graph.facebook.com/v22.0\";\n//            var next = $\"{baseUrl}/{s.WabaId}/message_templates?limit=100\";\n\n//            _http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", s.ApiKey);\n\n//            while (!string.IsNullOrWhiteSpace(next))\n//            {\n//                var res = await _http.GetAsync(next, ct);\n//                var json = await res.Content.ReadAsStringAsync(ct);\n//                if (!res.IsSuccessStatusCode) break;\n\n//                dynamic parsed = JsonConvert.DeserializeObject(json);\n\n//                foreach (var tpl in parsed.data)\n//                {\n//                    // Filter APPROVED/ACTIVE\n//                    string status = (tpl.status?.ToString() ?? \"\").ToUpperInvariant();\n//                    if (status != \"APPROVED\" && status != \"ACTIVE\") continue;\n\n//                    string name = tpl.name;\n//                    string language = tpl.language ?? \"en_US\";\n//                    string body = \"\";\n//                    bool hasImageHeader = false;\n//                    var buttons = new List<ButtonMetadataDto>();\n\n//                    foreach (var comp in tpl.components)\n//                    {\n//                        string type = comp.type?.ToString()?.ToUpperInvariant();\n\n//                        if (type == \"BODY\")\n//                            body = comp.text?.ToString() ?? \"\";\n\n//                        if (type == \"HEADER\" && (comp.format?.ToString()?.ToUpperInvariant() == \"IMAGE\"))\n//                            hasImageHeader = true;\n\n//                        if (type == \"BUTTONS\")\n//                        {\n//                            foreach (var b in comp.buttons)\n//                            {\n//                                try\n//                                {\n//                                    string btnType = b.type?.ToString()?.ToUpperInvariant() ?? \"\";\n//                                    string text = b.text?.ToString() ?? \"\";\n//                                    int index = buttons.Count;\n\n//                                    string subType = btnType switch\n//                                    {\n//                                        \"URL\" => \"url\",\n//                                        \"PHONE_NUMBER\" => \"voice_call\",\n//                                        \"QUICK_REPLY\" => \"quick_reply\",\n//                                        \"COPY_CODE\" => \"copy_code\",\n//                                        \"CATALOG\" => \"catalog\",\n//                                        \"FLOW\" => \"flow\",\n//                                        \"REMINDER\" => \"reminder\",\n//                                        \"ORDER_DETAILS\" => \"order_details\",\n//                                        _ => \"unknown\"\n//                                    };\n\n//                                    string? param = b.url != null ? b.url.ToString()\n//                                                 : b.phone_number != null ? b.phone_number.ToString()\n//                                                 : b.coupon_code != null ? b.coupon_code.ToString()\n//                                                 : b.flow_id != null ? b.flow_id.ToString()\n//                                                 : null;\n\n//                                    bool hasExample = b.example != null;\n//                                    bool isDynamic = hasExample && Regex.IsMatch(b.example.ToString(), @\"\\{\\{[0-9]+\\}\\}\");\n//                                    bool requiresParam = new[] { \"url\", \"flow\", \"copy_code\", \"catalog\", \"reminder\" }.Contains(subType);\n//                                    bool needsRuntimeValue = requiresParam && isDynamic;\n//                                    if (subType == \"unknown\" || (param == null && needsRuntimeValue)) continue;\n\n//                                    buttons.Add(new ButtonMetadataDto\n//                                    {\n//                                        Text = text,\n//                                        Type = btnType,\n//                                        SubType = subType,\n//                                        Index = index,\n//                                        ParameterValue = param ?? \"\"\n//                                    });\n//                                }\n//                                catch (Exception ex)\n//                                { _log.LogWarning(ex, \"Button parse failed for template {Name}\", (string)name); }\n//                            }\n//                        }\n//                    }\n\n//                    int placeholders = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n//                    var raw = JsonConvert.SerializeObject(tpl);\n\n//                    items.Add(new TemplateCatalogItem(\n//                        Name: name,\n//                        Language: language,\n//                        Body: body,\n//                        PlaceholderCount: placeholders,\n//                        HasImageHeader: hasImageHeader,\n//                        Buttons: buttons,\n//                        Status: status,\n//                        Category: tpl.category?.ToString(),\n//                        ExternalId: tpl.id?.ToString(),\n//                        RawJson: raw\n//                    ));\n//                }\n\n//                next = parsed?.paging?.next?.ToString();\n//            }\n\n//            return items;\n//        }\n\n//        public async Task<TemplateCatalogItem?> GetByNameAsync(WhatsAppSettingEntity s, string templateName, CancellationToken ct = default)\n//            => (await ListAsync(s, ct)).FirstOrDefault(t => t.Name.Equals(templateName, StringComparison.OrdinalIgnoreCase));\n//    }\n//}"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Providers/PinnacleTemplateCatalogProvider.cs",
      "sha256": "5bde2b8ac067b986ad6c7b929b798255af1cfad1c304e3023d34792ba7c0eee6",
      "language": "csharp",
      "size": 11298,
      "content": "// xbytechat.api/WhatsAppSettings/Providers/PinnacleTemplateCatalogProvider.cs\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Text.RegularExpressions;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing Newtonsoft.Json;\nusing xbytechat.api.WhatsAppSettings.Abstractions;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing TemplateCatalogItem = xbytechat.api.WhatsAppSettings.Abstractions.TemplateCatalogItem;\n\nnamespace xbytechat.api.WhatsAppSettings.Providers\n{\n    // Make sure your DI registers this as IPinnacleTemplateCatalogProvider *and* ITemplateCatalogProvider if needed.\n    public sealed class PinnacleTemplateCatalogProvider : IPinnacleTemplateCatalogProvider\n    {\n        private readonly HttpClient _http;\n        private readonly ILogger<PinnacleTemplateCatalogProvider> _log;\n        private readonly AppDbContext _context;\n\n        public PinnacleTemplateCatalogProvider(\n            HttpClient http,\n            ILogger<PinnacleTemplateCatalogProvider> log,\n            AppDbContext context)\n        {\n            _http = http;\n            _log = log;\n            _context = context;\n        }\n\n        // === Interface method used by TemplateSyncService ===\n        // TemplateSyncService expects _pinnacle.ListAsync(setting, ct). We delegate to the concrete method below.\n        public Task<IReadOnlyList<TemplateCatalogItem>> ListAsync(\n            WhatsAppSettingEntity setting,\n            CancellationToken ct = default)\n            => ListPinnacleAsync(setting, ct);\n\n        // === Concrete implementation ===\n        public async Task<IReadOnlyList<TemplateCatalogItem>> ListPinnacleAsync(\n            WhatsAppSettingEntity setting,\n            CancellationToken ct = default)\n        {\n            var items = new List<TemplateCatalogItem>();\n\n            if (string.IsNullOrWhiteSpace(setting.ApiKey))\n            {\n                _log.LogWarning(\"Pinnacle: missing ApiKey for BusinessId {BusinessId}\", setting.BusinessId);\n                return items;\n            }\n\n            var baseUrl = (setting.ApiUrl ?? \"https://partnersv1.pinbot.ai\").TrimEnd('/');\n            if (!baseUrl.EndsWith(\"/v3\", System.StringComparison.OrdinalIgnoreCase))\n                baseUrl += \"/v3\";\n\n            var prov = (setting.Provider ?? \"\")\n                .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\")\n                .ToUpperInvariant();\n\n            var pathId = !string.IsNullOrWhiteSpace(setting.WabaId)\n                ? setting.WabaId!.Trim()\n                : await _context.WhatsAppPhoneNumbers\n                    .AsNoTracking()\n                    .Where(p => p.BusinessId == setting.BusinessId\n                                && p.IsActive\n                                && p.Provider.ToUpper() == prov)\n                    .OrderByDescending(p => p.IsDefault)\n                    .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                    .Select(p => p.PhoneNumberId)\n                    .FirstOrDefaultAsync(ct);\n\n            if (string.IsNullOrWhiteSpace(pathId))\n            {\n                _log.LogWarning(\"Pinnacle: missing WabaId/PhoneNumberId for BusinessId {BusinessId}\", setting.BusinessId);\n                return items;\n            }\n\n            _http.DefaultRequestHeaders.Remove(\"apikey\");\n            _http.DefaultRequestHeaders.Remove(\"x-api-key\");\n            _http.DefaultRequestHeaders.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n            _http.DefaultRequestHeaders.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n\n            string? nextUrl = $\"{baseUrl}/{pathId}/message_templates?limit=100\";\n\n            while (!string.IsNullOrWhiteSpace(nextUrl))\n            {\n                ct.ThrowIfCancellationRequested();\n\n                HttpResponseMessage res;\n                string json;\n                try\n                {\n                    using var req = new HttpRequestMessage(HttpMethod.Get, nextUrl);\n                    res = await _http.SendAsync(req, ct);\n                    json = await res.Content.ReadAsStringAsync(ct);\n                }\n                catch (System.Exception ex)\n                {\n                    _log.LogError(ex, \"‚ùå Pinnacle HTTP error for {Url}\", nextUrl);\n                    break;\n                }\n\n                if (!res.IsSuccessStatusCode)\n                {\n                    _log.LogError(\"‚ùå Pinnacle list failed ({Status}): {Body}\", (int)res.StatusCode, json);\n                    break;\n                }\n\n                dynamic parsed;\n                try { parsed = JsonConvert.DeserializeObject(json)!; }\n                catch (System.Exception ex)\n                {\n                    _log.LogError(ex, \"‚ùå Pinnacle JSON parse error\");\n                    break;\n                }\n\n                var collection = parsed?.data ?? parsed?.templates;\n                if (collection == null)\n                {\n                    _log.LogInformation(\"Pinnacle: no data/templates array.\");\n                    break;\n                }\n\n                foreach (var tpl in collection)\n                {\n                    try\n                    {\n                        ct.ThrowIfCancellationRequested();\n\n                        string name = tpl?.name?.ToString() ?? \"\";\n                        string language = tpl?.language?.ToString() ?? \"\";\n                        string status = (tpl?.status?.ToString() ?? \"APPROVED\").Trim().ToUpperInvariant();\n                        string category = tpl?.category?.ToString() ?? \"\";\n                        string? subCat = tpl?.sub_category?.ToString();\n                        string externalId = tpl?.id?.ToString() ?? \"\";\n\n                        if (status != \"APPROVED\" && status != \"ACTIVE\")\n                            continue;\n\n                        string body = \"\";\n                        string headerKind = \"none\"; // text/image/video/document/none\n                        var buttons = new List<ButtonMetadataDto>();\n\n                        var components = tpl?.components;\n                        if (components != null)\n                        {\n                            foreach (var c in components)\n                            {\n                                var type = c?.type?.ToString()?.ToUpperInvariant();\n\n                                if (type == \"BODY\")\n                                {\n                                    body = c?.text?.ToString() ?? \"\";\n                                }\n                                else if (type == \"HEADER\")\n                                {\n                                    var fmt = c?.format?.ToString()?.ToUpperInvariant();\n                                    headerKind = fmt switch\n                                    {\n                                        \"TEXT\" => \"text\",\n                                        \"IMAGE\" => \"image\",\n                                        \"VIDEO\" => \"video\",\n                                        \"DOCUMENT\" => \"document\",\n                                        _ => \"none\"\n                                    };\n                                }\n                                else if (type == \"BUTTONS\" && c?.buttons != null)\n                                {\n                                    foreach (var b in c.buttons)\n                                    {\n                                        string btnType = b?.type?.ToString()?.ToUpperInvariant() ?? \"\";\n                                        string text = b?.text?.ToString() ?? \"\";\n\n                                        // Prefer provider index if present; fallback to list order.\n                                        int index = 0;\n                                        if (!int.TryParse(b?.index?.ToString(), out index))\n                                            index = buttons.Count;\n\n                                        string subType = btnType switch\n                                        {\n                                            \"URL\" => \"url\",\n                                            \"PHONE_NUMBER\" => \"voice_call\",\n                                            \"QUICK_REPLY\" => \"quick_reply\",\n                                            \"COPY_CODE\" => \"copy_code\",\n                                            \"CATALOG\" => \"catalog\",\n                                            \"FLOW\" => \"flow\",\n                                            \"REMINDER\" => \"reminder\",\n                                            \"ORDER_DETAILS\" => \"order_details\",\n                                            _ => \"unknown\"\n                                        };\n                                        if (subType == \"unknown\") continue;\n\n                                        string? param =\n                                            b?.url?.ToString()\n                                            ?? b?.phone_number?.ToString()\n                                            ?? b?.coupon_code?.ToString()\n                                            ?? b?.flow_id?.ToString();\n\n                                        buttons.Add(new ButtonMetadataDto\n                                        {\n                                            Text = text,\n                                            Type = btnType,\n                                            SubType = subType,\n                                            Index = index,\n                                            ParameterValue = param ?? \"\"\n                                        });\n                                    }\n                                }\n                            }\n                        }\n\n                        // PlaceholderCount is not used by sync; it recomputes from RawJson.\n                        var raw = JsonConvert.SerializeObject(tpl);\n\n                        items.Add(new TemplateCatalogItem(\n                            Name: name,\n                            Language: language,\n                            Body: body,\n                            PlaceholderCount: 0,                 // sync derives counts from RawJson\n                            HasImageHeader: headerKind == \"image\",\n                            Buttons: buttons,\n                            Status: status,\n                            Category: category,\n                            ExternalId: externalId,\n                            RawJson: raw,\n                            SubCategory: subCat\n                        ));\n                    }\n                    catch\n                    {\n                        // swallow a bad item and continue\n                    }\n                }\n\n                // safe paging read\n                try { nextUrl = parsed?.paging?.next?.ToString(); }\n                catch { nextUrl = null; }\n                if (string.IsNullOrWhiteSpace(nextUrl)) break;\n            }\n\n            return items;\n        }\n\n        public Task<TemplateCatalogItem?> GetByNamePinnacleAsync(\n            WhatsAppSettingEntity setting,\n            string templateName,\n            CancellationToken ct = default)\n            => Task.FromResult<TemplateCatalogItem?>(null); // not used in sync path\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/ITemplatePreviewService.cs",
      "sha256": "a3a93cd8e29af752b16c49daadd82a6a419069bc5933177e663d030e47304f4e",
      "language": "csharp",
      "size": 306,
      "content": "using System;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public interface ITemplatePreviewService\n    {\n        Task<TemplatePreviewResponseDto> PreviewAsync(Guid businessId, TemplatePreviewRequestDto request);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/ITemplateSyncService.cs",
      "sha256": "4f3db9b43981973f160e937b9d1c3581dec0398d14d1fad47dd9151132b8725e",
      "language": "csharp",
      "size": 407,
      "content": "namespace xbytechat.api.WhatsAppSettings.Services\n{\n    public interface ITemplateSyncService\n    {\n        Task<TemplateSyncResult>\n            SyncBusinessTemplatesAsync(Guid businessId, \n            bool force = false,\n            bool onlyUpsert = false,\n            CancellationToken ct = default);\n    }\n    public record TemplateSyncResult(int Added, int Updated, int Skipped, DateTime SyncedAt);\n\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/IWhatsAppPhoneNumberService.cs",
      "sha256": "c9bc6548dcd7992936780ef305a214e46e641f096d252bbda87cc42ed32cbfe9",
      "language": "csharp",
      "size": 1614,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat.api.Features.WhatsAppSettings.Services\n{\n    public interface IWhatsAppPhoneNumberService\n    {\n        Task<IReadOnlyList<WhatsAppPhoneNumber>> ListAsync(Guid businessId, string provider, CancellationToken ct = default);\n\n        Task<WhatsAppPhoneNumber> UpsertAsync(\n            Guid businessId,\n            string provider,\n            string phoneNumberId,\n            string whatsAppBusinessNumber,\n            string? senderDisplayName,\n            bool? isActive = null,\n            bool? isDefault = null);\n\n        // Delete by entity Id (GUID)\n        Task<bool> DeleteAsync(Guid businessId, string provider, Guid id);\n\n        // Set one number as default (enforces ‚Äúone default per (business, provider)‚Äù)\n        Task<bool> SetDefaultAsync(Guid businessId, string provider, Guid id);\n\n        // Find a specific number by PhoneNumberId\n        Task<WhatsAppPhoneNumber?> FindAsync(Guid businessId, string provider, string phoneNumberId);\n\n        // Get the default number for a provider (or null if not set)\n        Task<WhatsAppPhoneNumber?> GetDefaultAsync(Guid businessId, string provider);\n\n        // in IWhatsAppPhoneNumberService\n        Task<(int Added, int Updated, int Total)> SyncFromProviderAsync(\n        Guid businessId,\n        WhatsAppSettingsDto setting,   // DTO\n        string provider,\n        CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/IWhatsAppSenderService.cs",
      "sha256": "b6780029b1436d346fc9f57aca94684bdc620076e88e7df8711805cc3edc3b02",
      "language": "csharp",
      "size": 425,
      "content": "using xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat.api.WhatsAppSettings.Services\n{\n    public interface IWhatsAppSenderService\n    {\n        Task<IReadOnlyList<WhatsAppSenderDto>> GetBusinessSendersAsync(Guid businessId, CancellationToken ct = default);\n        Task<(string Provider, string PhoneNumberId)?> ResolveSenderPairAsync(Guid businessId, string phoneNumberId, CancellationToken ct = default);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/IWhatsAppSettingsService.cs",
      "sha256": "92b4186c4b6aca80883ae90759b1ed3e8cabe2d2953a5954169221f857f6597e",
      "language": "csharp",
      "size": 913,
      "content": "using System;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public interface IWhatsAppSettingsService\n    {\n        Task SaveOrUpdateSettingAsync(SaveWhatsAppSettingDto dto);\n        Task<WhatsAppSettingsDto> GetSettingsByBusinessIdAsync(Guid businessId);\n        Task<bool> DeleteSettingsAsync(Guid businessId);\n        Task<string> TestConnectionAsync(SaveWhatsAppSettingDto dto);\n        Task<string?> GetSenderNumberAsync(Guid businessId);\n        Task<string> GetCallbackUrlAsync(Guid businessId, string appBaseUrl);\n        Task<IReadOnlyList<WhatsAppSettingEntity>> GetAllForBusinessAsync(Guid businessId);\n        Task<WhatsAppSettingEntity?> GetSettingsByBusinessIdAndProviderAsync(Guid businessId, string provider);\n      \n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/IWhatsAppTemplateFetcherService.cs",
      "sha256": "14a7a41486ab4e78dc848576af52394b66a21a256d1edbf8e85f605c2e31e119",
      "language": "csharp",
      "size": 762,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Threading.Tasks;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public interface IWhatsAppTemplateFetcherService\n    {\n        Task<List<TemplateMetadataDto>> FetchTemplatesAsync(Guid businessId);\n        Task<List<TemplateForUIResponseDto>> FetchAllTemplatesAsync();\n        Task<TemplateMetadataDto?> GetTemplateByNameAsync(Guid businessId, string templateName, bool includeButtons);\n\n        Task<IReadOnlyList<TemplateMetaDto>> GetTemplatesMetaAsync(Guid businessId, string? provider = null);\n        Task<TemplateMetaDto?> GetTemplateMetaAsync(Guid businessId, string templateName, string? language = null, string? provider = null);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/TemplatePreviewService.cs",
      "sha256": "bce7179ab5e46fe57fcab9220023da307250676d0f27bb999748ad11fc05179c",
      "language": "csharp",
      "size": 7248,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public sealed class TemplatePreviewService : ITemplatePreviewService\n    {\n        private readonly IWhatsAppTemplateFetcherService _fetcher;\n        private readonly ILogger<TemplatePreviewService> _log;\n\n        public TemplatePreviewService(IWhatsAppTemplateFetcherService fetcher, ILogger<TemplatePreviewService> log)\n        {\n            _fetcher = fetcher;\n            _log = log;\n        }\n\n        public async Task<TemplatePreviewResponseDto> PreviewAsync(Guid businessId, TemplatePreviewRequestDto request)\n        {\n            var resp = new TemplatePreviewResponseDto\n            {\n                TemplateName = request.TemplateName,\n                Language = request.Language\n            };\n\n            // 1) Fetch meta (from our catalog)\n            var meta = await _fetcher.GetTemplateMetaAsync(\n                businessId,\n                request.TemplateName,\n                language: request.Language,\n                provider: request.Provider\n            );\n\n            if (meta == null)\n            {\n                resp.FoundTemplate = false;\n                resp.Errors.Add(\"Template not found for this business/provider/language.\");\n                return resp;\n            }\n\n            resp.FoundTemplate = true;\n            resp.Language = meta.Language;\n            resp.HasHeaderMedia = meta.HasHeaderMedia;\n            resp.HeaderType = meta.HeaderType ?? \"\";\n\n            // 2) Placeholder validation\n            var required = Math.Max(0, meta.BodyPlaceholders?.Count ?? 0);\n            var provided = request.TemplateParameters?.Count ?? 0;\n\n            resp.RequiredPlaceholderCount = required;\n            resp.ProvidedPlaceholderCount = provided;\n\n            if (provided < required)\n            {\n                for (int i = provided + 1; i <= required; i++) resp.MissingPlaceholderIndices.Add(i);\n                resp.Errors.Add($\"Missing {required - provided} body parameter(s).\");\n            }\n            else if (provided > required)\n            {\n                resp.Warnings.Add($\"Ignored {provided - required} extra body parameter(s).\");\n            }\n\n            // 3) Build provider-like components preview\n            var comps = new List<object>();\n\n            // Header (image) preview only when template supports it and caller provided a URL\n            if (meta.HasHeaderMedia && !string.IsNullOrWhiteSpace(request.HeaderImageUrl))\n            {\n                comps.Add(new\n                {\n                    type = \"header\",\n                    parameters = new object[]\n                    {\n                        new { type = \"image\", image = new { link = request.HeaderImageUrl } }\n                    }\n                });\n            }\n\n            // Body parameters: trim/pad to 'required'\n            if (required > 0)\n            {\n                var src = (request.TemplateParameters ?? new List<string>()).Select(s => s ?? string.Empty).ToList();\n                if (src.Count > required) src = src.Take(required).ToList();\n                while (src.Count < required) src.Add(string.Empty);\n\n                var bodyParams = src.Select(p => (object)new { type = \"text\", text = p }).ToArray();\n                comps.Add(new { type = \"body\", parameters = bodyParams });\n            }\n\n            // 4) Buttons validation (only dynamic URL buttons require parameters in payload)\n            // Template order is authoritative. We'll check at most 3.\n            var inputByPos = (request.Buttons ?? new List<PreviewButtonInputDto>())\n                             .Where(b => b.Position >= 1 && b.Position <= 3)\n                             .ToDictionary(b => b.Position, b => b);\n\n            var templateButtons = (meta.Buttons ?? new List<TemplateButtonMeta>())\n                                  .OrderBy(b => b.Order)\n                                  .Take(3)\n                                  .ToList();\n\n            for (int i = 0; i < templateButtons.Count; i++)\n            {\n                var tb = templateButtons[i];\n                var subType = (tb.Type ?? tb.Text ?? \"\").ToUpperInvariant(); // tb.Type from Step 2.1 mapper; sub-type is treated as URL family\n                var paramPattern = tb.Value ?? \"\"; // came from ButtonsJson ParameterValue (may contain \"{{1}}\")\n                var isUrlFamily = (tb.Type ?? \"\").Equals(\"URL\", StringComparison.OrdinalIgnoreCase);\n                var isDynamic = isUrlFamily && paramPattern.Contains(\"{{\");\n\n                if (!isUrlFamily || !isDynamic)\n                {\n                    // For static buttons (or non-URL), we preview a button component without parameters\n                    comps.Add(new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"button\",\n                        [\"sub_type\"] = \"url\",\n                        [\"index\"] = i.ToString()\n                    });\n                    continue;\n                }\n\n                // Dynamic URL ‚Üí expect input at this position\n                if (!inputByPos.TryGetValue(i + 1, out var userBtn) || string.IsNullOrWhiteSpace(userBtn.Value))\n                {\n                    resp.Errors.Add($\"Dynamic URL required for button position {i + 1} but no value was provided.\");\n                    continue;\n                }\n\n                var value = userBtn.Value.Trim();\n\n                // Accept absolute http/https and tel/wa deep links in preview\n                var ok = LooksValidDestination(value);\n                if (!ok)\n                {\n                    resp.Errors.Add($\"Button {i + 1} destination must be absolute http/https or tel/wa link.\");\n                    continue;\n                }\n\n                // NOTE: In live send we tokenise tracked URLs. For preview we show the **value** directly.\n                var parameters = new[] { new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = value } };\n\n                comps.Add(new Dictionary<string, object>\n                {\n                    [\"type\"] = \"button\",\n                    [\"sub_type\"] = \"url\",\n                    [\"index\"] = i.ToString(),\n                    [\"parameters\"] = parameters\n                });\n            }\n\n            resp.ProviderComponentsPreview = comps;\n            return resp;\n        }\n\n        private static bool LooksValidDestination(string input)\n        {\n            if (string.IsNullOrWhiteSpace(input)) return false;\n            var s = input.Trim();\n            if (s.StartsWith(\"tel:\", StringComparison.OrdinalIgnoreCase)) return true;\n            if (s.StartsWith(\"wa:\", StringComparison.OrdinalIgnoreCase)) return true;\n            if (s.StartsWith(\"https://wa.me/\", StringComparison.OrdinalIgnoreCase)) return true;\n\n            if (Uri.TryCreate(s, UriKind.Absolute, out var uri))\n                return uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase)\n                    || uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase);\n\n            return false;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/TemplateSyncService.cs",
      "sha256": "380b47e260fe05324abaf4250ec585d6e9bcb93c47eec90f76d817cc9b75ce02",
      "language": "csharp",
      "size": 34894,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing xbytechat.api.WhatsAppSettings.Providers;\nusing xbytechat.api.WhatsAppSettings.Abstractions;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.WhatsAppSettings.Helpers; // canonical parser\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.WhatsAppSettings.Services;\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Newtonsoft.Json;\nusing Polly.Caching;\nusing Serilog;\nusing System.Buffers;\nusing System.Text.RegularExpressions;\n\npublic sealed class TemplateSyncService : ITemplateSyncService\n{\n    private readonly AppDbContext _db;\n    private readonly MetaTemplateCatalogProvider _meta;\n    private readonly PinnacleTemplateCatalogProvider _pinnacle;\n    private readonly ILogger<TemplateSyncService> _log;\n\n    private static readonly TimeSpan TTL = TimeSpan.FromHours(12);\n\n    public TemplateSyncService(\n        AppDbContext db,\n        MetaTemplateCatalogProvider meta,\n        PinnacleTemplateCatalogProvider pinnacle,\n        ILogger<TemplateSyncService> log)\n    {\n        _db = db; _meta = meta; _pinnacle = pinnacle; _log = log;\n    }\n\n    //public async Task<TemplateSyncResult> SyncBusinessTemplatesAsync(Guid businessId, bool force = false, CancellationToken ct = default)\n    //{\n    //    var setting = await _db.WhatsAppSettings\n    //        .AsNoTracking()\n    //        .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive, ct)\n    //        ?? throw new InvalidOperationException(\"Active WhatsApp settings not found.\");\n\n    //    var now = DateTime.UtcNow;\n\n    //    if (!force)\n    //    {\n    //        var recent = await _db.WhatsAppTemplates\n    //            .AsNoTracking()\n    //            .Where(t => t.BusinessId == businessId)\n    //            .OrderByDescending(t => t.LastSyncedAt)\n    //            .Select(t => t.LastSyncedAt)\n    //            .FirstOrDefaultAsync(ct);\n\n    //        if (recent != default && now - recent < TTL)\n    //        {\n    //            _log.LogInformation(\"‚è≠Ô∏è Skipping sync for {BusinessId}; TTL not expired.\", businessId);\n    //            return new TemplateSyncResult(0, 0, 0, recent);\n    //        }\n    //    }\n\n    //    // Canonical provider (UPPER)\n    //    var providerKey = ((setting.Provider ?? \"META_CLOUD\").Trim()).ToUpperInvariant();\n\n    //    IReadOnlyList<TemplateCatalogItem> incoming = providerKey switch\n    //    {\n    //        \"META_CLOUD\" => await _meta.ListMetaAsync(setting, ct),\n    //        \"PINNACLE\" => await _pinnacle.ListPinnacleAsync(setting, ct),\n    //        _ => Array.Empty<TemplateCatalogItem>()\n    //    };\n    //    incoming ??= Array.Empty<TemplateCatalogItem>();\n\n    //    // Preload existing provider rows for this business\n    //    var existing = await _db.WhatsAppTemplates\n    //        .Where(t => t.BusinessId == businessId && t.Provider == providerKey)\n    //        .ToListAsync(ct);\n\n    //    // Fast lookup maps\n    //    var byTemplateId = existing\n    //        .Where(e => !string.IsNullOrWhiteSpace(e.TemplateId))\n    //        .ToDictionary(e => e.TemplateId!, e => e, StringComparer.Ordinal);\n\n    //    //static string NLKey(string name, string? lang) => $\"{name}::{(lang ?? \"\").Trim().ToLowerInvariant()}\";\n    //    static string NLKey(string? name, string? lang)\n    //=> $\"{(name ?? \"\").Trim().ToLowerInvariant()}::{(lang ?? \"\").Trim().ToLowerInvariant()}\";\n    //    var byNameLang = existing.ToDictionary(\n    //        e => NLKey(e.Name, e.LanguageCode),\n    //        e => e,\n    //        StringComparer.Ordinal);\n\n    //    int added = 0, updated = 0, unchanged = 0;\n\n    //    var seenTemplateIds = new HashSet<string>(StringComparer.Ordinal);\n    //    var seenNLKeys = new HashSet<string>(StringComparer.Ordinal);\n\n    //    // Helpers\n    //    static string NK(string? k) => string.IsNullOrWhiteSpace(k) ? \"none\" : k.Trim().ToLowerInvariant();\n    //    static bool IsIdentifier(string? s) => !string.IsNullOrWhiteSpace(s) && Regex.IsMatch(s!, @\"^[A-Za-z_][A-Za-z0-9_]*$\");\n\n    //    foreach (var it in incoming)\n    //    {\n    //        ct.ThrowIfCancellationRequested();\n\n    //        var extId = it.ExternalId?.Trim();\n    //        var lang = string.IsNullOrWhiteSpace(it.Language) ? \"en_US\" : it.Language.Trim();\n    //        var nlKey = NLKey(it.Name, lang);\n\n    //        seenNLKeys.Add(nlKey);\n    //        if (!string.IsNullOrWhiteSpace(extId)) seenTemplateIds.Add(extId!);\n\n    //        // ‚Äî‚Äî Parse/summarize JSON into our canonical fields\n    //        var dto = TemplateJsonHelper.SummarizeDetailed(it.RawJson, it.Body);\n\n    //        var headerKindNorm = NK(dto.HeaderKind);\n    //        var headerTextToPersist = headerKindNorm == \"text\"\n    //            ? (string.IsNullOrWhiteSpace(dto.HeaderText) ? null : dto.HeaderText!.Trim())\n    //            : null;\n\n    //        var paramFormat = (dto.ParameterFormat ?? \"UNKNOWN\").Trim().ToUpperInvariant();\n\n    //        // Keep only real placeholders (drop \"{{}}\"). Count by location.\n    //        var occAll = (dto.Placeholders ?? new List<PlaceholderOccurrence>()).ToList();\n    //        var occFiltered = occAll.Where(o =>\n    //        {\n    //            var raw = o.Raw?.Trim();\n    //            if (string.Equals(raw, \"{{}}\", StringComparison.Ordinal)) return false;\n\n    //            if (paramFormat == \"POSITIONAL\") return o.Index is >= 1;\n    //            if (paramFormat == \"NAMED\") return IsIdentifier(o.Name);\n\n    //            return false;\n    //        }).ToList();\n\n    //        int headerVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Header);\n    //        int bodyVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Body);\n    //        int totalVars = occFiltered.Count; // header + body + buttons (filtered)\n\n    //        var combinedBody = dto.CombinedPreviewBody ?? string.Empty;\n    //        var bodyPreview = combinedBody.Length > 240 ? combinedBody[..240] : combinedBody;\n\n    //        bool requiresMediaHeader = headerKindNorm is \"image\" or \"video\" or \"document\";\n\n    //        // Named parameter keys (for NAMED format)\n    //        var namedKeys = occFiltered\n    //            .Where(p => !string.IsNullOrWhiteSpace(p.Name))\n    //            .Select(p => p.Name!.Trim())\n    //            .Where(IsIdentifier)\n    //            .Distinct(StringComparer.OrdinalIgnoreCase)\n    //            .ToArray();\n    //        string? namedKeysJson = namedKeys.Length > 0 ? JsonConvert.SerializeObject(namedKeys) : null;\n\n    //        // Placeholder map (provider-specific): keep null unless you compute elsewhere\n    //        string? placeholderMapJson = null;\n\n    //        // Buttons summary (prefer explicit from provider)\n    //        // Buttons summary (prefer explicit from provider)\n    //        string? urlButtonsJson = null;\n    //        int quickReplyCount = 0;\n    //        bool hasPhoneButton = false;\n\n    //        if (it.Buttons is { Count: > 0 })\n    //        {\n    //            // Persist only what's needed downstream: the URL button positions.\n    //            // Shape: [{ \"index\": 0 }, { \"index\": 1 }, ...]\n    //            var urlButtons = new List<object>(capacity: it.Buttons.Count);\n\n    //            foreach (var b in it.Buttons)\n    //            {\n    //                var sub = (b.SubType ?? \"\").Trim().ToLowerInvariant();\n\n    //                if (sub == \"quick_reply\") quickReplyCount++;\n    //                if (sub == \"phone_number\") hasPhoneButton = true;\n\n    //                if (sub == \"url\")\n    //                {\n    //                    urlButtons.Add(new\n    //                    {\n    //                        index = b.Index\n    //                        // no b.Parameters; not present on ButtonMetadataDto\n    //                    });\n    //                }\n    //            }\n\n    //            urlButtonsJson = urlButtons.Count > 0 ? JsonConvert.SerializeObject(urlButtons) : null;\n    //        }\n\n\n    //        var status = string.IsNullOrWhiteSpace(it.Status) ? \"APPROVED\" : it.Status!.Trim().ToUpperInvariant();\n\n    //        // ‚Äî‚Äî Locate existing row (by TemplateId first, else Name+Lang)\n    //        WhatsAppTemplate? row = null;\n\n    //        if (!string.IsNullOrWhiteSpace(extId) && byTemplateId.TryGetValue(extId!, out var foundById))\n    //        {\n    //            row = foundById;\n    //        }\n    //        else if (byNameLang.TryGetValue(nlKey, out var foundByNL))\n    //        {\n    //            row = foundByNL;\n\n    //            // backfill TemplateId if we now have it\n    //            if (!string.IsNullOrWhiteSpace(extId) && string.IsNullOrWhiteSpace(row.TemplateId))\n    //            {\n    //                row.TemplateId = extId;\n    //                updated++;\n    //            }\n    //        }\n\n    //        if (row is null)\n    //        {\n    //            // INSERT\n    //            var newRow = new WhatsAppTemplate\n    //            {\n    //                Id = Guid.NewGuid(),\n    //                BusinessId = businessId,\n    //                Provider = providerKey,\n    //                TemplateId = extId,\n    //                Name = it.Name,\n    //                LanguageCode = lang,\n    //                Status = status,\n    //                Category = it.Category,\n    //                SubCategory = null,\n\n    //                RawJson = it.RawJson ?? \"{}\",\n\n    //                ParameterFormat = paramFormat,\n    //                HeaderKind = headerKindNorm,\n    //                HeaderText = headerTextToPersist,\n    //                Body = combinedBody,\n    //                BodyPreview = bodyPreview,\n\n    //                RequiresMediaHeader = requiresMediaHeader,\n\n    //                BodyVarCount = bodyVars,\n    //                HeaderTextVarCount = headerVars,\n    //                TotalTextParamCount = totalVars,\n\n    //                UrlButtons = urlButtonsJson,\n    //                QuickReplyCount = quickReplyCount,\n    //                HasPhoneButton = hasPhoneButton,\n\n    //                NamedParamKeys = namedKeysJson,\n    //                PlaceholderMap = placeholderMapJson,\n\n    //                IsActive = true,\n    //                CreatedAt = now,\n    //                UpdatedAt = now,\n    //                LastSyncedAt = now\n    //            };\n\n    //            _db.WhatsAppTemplates.Add(newRow);\n    //            added++;\n\n    //            if (!string.IsNullOrWhiteSpace(extId)) byTemplateId[extId!] = newRow;\n    //            byNameLang[nlKey] = newRow;\n    //        }\n    //        else\n    //        {\n    //            // UPDATE (branch-predicated, no ref locals)\n    //            bool changed = false;\n\n    //            if (!string.Equals(row.Status, status, StringComparison.Ordinal))\n    //            { row.Status = status; changed = true; }\n\n    //            if (!string.Equals(row.Category, it.Category, StringComparison.Ordinal))\n    //            { row.Category = it.Category; changed = true; }\n\n    //            var newRaw = it.RawJson ?? \"{}\";\n    //            if (!string.Equals(row.RawJson, newRaw, StringComparison.Ordinal))\n    //            { row.RawJson = newRaw; changed = true; }\n\n    //            if (!string.Equals(row.ParameterFormat, paramFormat, StringComparison.Ordinal))\n    //            { row.ParameterFormat = paramFormat; changed = true; }\n\n    //            if (!string.Equals(row.HeaderKind, headerKindNorm, StringComparison.Ordinal))\n    //            { row.HeaderKind = headerKindNorm; changed = true; }\n\n    //            var existingHeaderText = string.IsNullOrWhiteSpace(row.HeaderText) ? null : row.HeaderText!.Trim();\n    //            if (!string.Equals(existingHeaderText, headerTextToPersist, StringComparison.Ordinal))\n    //            { row.HeaderText = headerTextToPersist; changed = true; }\n\n    //            if (!string.Equals(row.Body ?? string.Empty, combinedBody, StringComparison.Ordinal))\n    //            { row.Body = combinedBody; changed = true; }\n\n    //            if (!string.Equals(row.BodyPreview ?? string.Empty, bodyPreview ?? string.Empty, StringComparison.Ordinal))\n    //            { row.BodyPreview = bodyPreview; changed = true; }\n\n    //            if (row.RequiresMediaHeader != requiresMediaHeader)\n    //            { row.RequiresMediaHeader = requiresMediaHeader; changed = true; }\n\n    //            if (row.BodyVarCount != bodyVars) { row.BodyVarCount = bodyVars; changed = true; }\n    //            if (row.HeaderTextVarCount != headerVars) { row.HeaderTextVarCount = headerVars; changed = true; }\n    //            if (row.TotalTextParamCount != totalVars) { row.TotalTextParamCount = totalVars; changed = true; }\n\n    //            if (!string.Equals(row.UrlButtons ?? \"\", urlButtonsJson ?? \"\", StringComparison.Ordinal))\n    //            { row.UrlButtons = urlButtonsJson; changed = true; }\n\n    //            if (row.QuickReplyCount != quickReplyCount) { row.QuickReplyCount = quickReplyCount; changed = true; }\n    //            if (row.HasPhoneButton != hasPhoneButton) { row.HasPhoneButton = hasPhoneButton; changed = true; }\n\n    //            if (!string.Equals(row.NamedParamKeys ?? \"\", namedKeysJson ?? \"\", StringComparison.Ordinal))\n    //            { row.NamedParamKeys = namedKeysJson; changed = true; }\n\n    //            if (!string.Equals(row.PlaceholderMap ?? \"\", placeholderMapJson ?? \"\", StringComparison.Ordinal))\n    //            { row.PlaceholderMap = placeholderMapJson; changed = true; }\n\n    //            row.IsActive = true;\n    //            row.LastSyncedAt = now;\n\n    //            if (changed) { row.UpdatedAt = now; updated++; } else { unchanged++; }\n    //        }\n    //    }\n\n    //    // Deactivate templates that disappeared from provider (cheap set membership)\n    //    if (incoming.Count > 0)\n    //    {\n    //        foreach (var e in existing)\n    //        {\n    //            bool stillThere =\n    //                (!string.IsNullOrWhiteSpace(e.TemplateId) && seenTemplateIds.Contains(e.TemplateId)) ||\n    //                seenNLKeys.Contains(NLKey(e.Name, e.LanguageCode));\n\n    //            if (!stillThere && e.IsActive)\n    //            {\n    //                e.IsActive = false;\n    //                e.LastSyncedAt = now;\n    //                e.UpdatedAt = now;\n    //                updated++;\n    //            }\n    //        }\n    //    }\n\n    //    await _db.SaveChangesAsync(ct);\n    //    return new TemplateSyncResult(added, updated, unchanged, now);\n    //}\n\n    // NOTE: expects fields/services available in your class:\n    // _db (AppDbContext), _log (ILogger), _meta, _pinnacle, TTL (TimeSpan)\n\n    public async Task<TemplateSyncResult> SyncBusinessTemplatesAsync(\n     Guid businessId,\n     bool force = false,\n     bool onlyUpsert = false, // NEW: when true, do not deactivate missing rows\n     CancellationToken ct = default)\n    {\n        var setting = await _db.WhatsAppSettings\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive, ct)\n            ?? throw new InvalidOperationException(\"Active WhatsApp settings not found.\");\n\n        var now = DateTime.UtcNow;\n\n        // Canonical provider key (UPPER)\n        var providerKey = ((setting.Provider ?? \"META_CLOUD\").Trim()).ToUpperInvariant();\n\n        // TTL check is provider-scoped; will be bypassed by force:true from the button\n        if (!force)\n        {\n            var recent = await _db.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.Provider.ToUpper() == providerKey)\n                .OrderByDescending(t => t.LastSyncedAt)\n                .Select(t => t.LastSyncedAt)\n                .FirstOrDefaultAsync(ct);\n\n            if (recent != default && now - recent < TTL)\n            {\n                _log.LogInformation(\"‚è≠Ô∏è Skipping template sync (business={BusinessId}, provider={Provider}) ‚Äî TTL not expired. Last={Last}, TTL={TTLmins}m\",\n                    businessId, providerKey, recent, TTL.TotalMinutes);\n                return new TemplateSyncResult(0, 0, 0, recent);\n            }\n        }\n\n        // Fetch from provider\n        IReadOnlyList<TemplateCatalogItem> incoming = providerKey switch\n        {\n            \"META_CLOUD\" => await _meta.ListMetaAsync(setting, ct),\n            \"PINNACLE\" => await _pinnacle.ListPinnacleAsync(setting, ct),\n            _ => Array.Empty<TemplateCatalogItem>()\n        };\n        incoming ??= Array.Empty<TemplateCatalogItem>();\n\n        _log.LogInformation(\"[TplSync] Provider={Provider} fetched={Count}\", providerKey, incoming.Count);\n\n        // Load existing rows for this provider (normalize Provider case)\n        var existing = await _db.WhatsAppTemplates\n            .Where(t => t.BusinessId == businessId && t.Provider.ToUpper() == providerKey)\n            .ToListAsync(ct);\n\n        // Fast lookup maps\n        var byTemplateId = existing\n            .Where(e => !string.IsNullOrWhiteSpace(e.TemplateId))\n            .ToDictionary(e => e.TemplateId!, e => e, StringComparer.Ordinal);\n\n        static string NLKey(string? name, string? lang)\n            => $\"{(name ?? \"\").Trim().ToLowerInvariant()}::{(lang ?? \"\").Trim().ToLowerInvariant()}\";\n\n        var byNameLang = existing.ToDictionary(\n            e => NLKey(e.Name, e.LanguageCode),\n            e => e,\n            StringComparer.Ordinal);\n\n        int added = 0, updated = 0, unchanged = 0;\n\n        var seenTemplateIds = new HashSet<string>(StringComparer.Ordinal);\n        var seenNLKeys = new HashSet<string>(StringComparer.Ordinal);\n\n        // Helpers\n        static string NK(string? k) => string.IsNullOrWhiteSpace(k) ? \"none\" : k.Trim().ToLowerInvariant();\n        static bool IsIdentifier(string? s) => !string.IsNullOrWhiteSpace(s) && Regex.IsMatch(s!, @\"^[A-Za-z_][A-Za-z0-9_]*$\");\n\n        foreach (var it in incoming)\n        {\n            ct.ThrowIfCancellationRequested();\n\n            var extId = it.ExternalId?.Trim();\n            var lang = string.IsNullOrWhiteSpace(it.Language) ? \"en_US\" : it.Language.Trim();\n            var nlKey = NLKey(it.Name, lang);\n\n            seenNLKeys.Add(nlKey);\n            if (!string.IsNullOrWhiteSpace(extId)) seenTemplateIds.Add(extId!);\n\n            // Parse & summarize provider JSON\n            var dto = TemplateJsonHelper.SummarizeDetailed(it.RawJson, it.Body);\n\n            var headerKindNorm = NK(dto.HeaderKind);\n            var headerTextToPersist = headerKindNorm == \"text\"\n                ? (string.IsNullOrWhiteSpace(dto.HeaderText) ? null : dto.HeaderText!.Trim())\n                : null;\n\n            var paramFormat = (dto.ParameterFormat ?? \"UNKNOWN\").Trim().ToUpperInvariant();\n\n            // Real placeholders only\n            var occAll = (dto.Placeholders ?? new List<PlaceholderOccurrence>()).ToList();\n            var occFiltered = occAll.Where(o =>\n            {\n                var raw = o.Raw?.Trim();\n                if (string.Equals(raw, \"{{}}\", StringComparison.Ordinal)) return false;\n\n                if (paramFormat == \"POSITIONAL\") return o.Index is >= 1;\n                if (paramFormat == \"NAMED\") return IsIdentifier(o.Name);\n                return false;\n            }).ToList();\n\n            int headerVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Header);\n            int bodyVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Body);\n            int totalVars = occFiltered.Count;\n\n            var combinedBody = dto.CombinedPreviewBody ?? string.Empty;\n            var bodyPreview = combinedBody.Length > 240 ? combinedBody[..240] : combinedBody;\n\n            bool requiresMediaHeader = headerKindNorm is \"image\" or \"video\" or \"document\";\n\n            // Named param keys\n            var namedKeys = occFiltered\n                .Where(p => !string.IsNullOrWhiteSpace(p.Name))\n                .Select(p => p.Name!.Trim())\n                .Where(IsIdentifier)\n                .Distinct(StringComparer.OrdinalIgnoreCase)\n                .ToArray();\n            string? namedKeysJson = namedKeys.Length > 0 ? JsonConvert.SerializeObject(namedKeys) : null;\n\n            // Buttons summary\n            string? urlButtonsJson = null;\n            int quickReplyCount = 0;\n            bool hasPhoneButton = false;\n\n            if (it.Buttons is { Count: > 0 })\n            {\n                var urlButtons = new List<object>(capacity: it.Buttons.Count);\n\n                foreach (var b in it.Buttons)\n                {\n                    var sub = (b.SubType ?? \"\").Trim().ToLowerInvariant();\n\n                    if (sub == \"quick_reply\") quickReplyCount++;\n                    if (sub == \"voice_call\") hasPhoneButton = true;\n\n                    if (sub == \"url\")\n                    {\n                        urlButtons.Add(new { index = b.Index });\n                    }\n                }\n\n                urlButtonsJson = urlButtons.Count > 0 ? JsonConvert.SerializeObject(urlButtons) : null;\n            }\n\n            var status = string.IsNullOrWhiteSpace(it.Status) ? \"APPROVED\" : it.Status!.Trim().ToUpperInvariant();\n\n            // Locate existing (TemplateId first, else Name+Lang)\n            WhatsAppTemplate? row = null;\n\n            if (!string.IsNullOrWhiteSpace(extId) && byTemplateId.TryGetValue(extId!, out var foundById))\n            {\n                row = foundById;\n            }\n            else if (byNameLang.TryGetValue(nlKey, out var foundByNL))\n            {\n                row = foundByNL;\n\n                // backfill TemplateId if present now\n                if (!string.IsNullOrWhiteSpace(extId) && string.IsNullOrWhiteSpace(row.TemplateId))\n                {\n                    row.TemplateId = extId;\n                    updated++;\n                }\n            }\n\n            if (row is null)\n            {\n                // INSERT\n                var newRow = new WhatsAppTemplate\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Provider = providerKey,\n                    TemplateId = extId,\n                    Name = it.Name,\n                    LanguageCode = lang,\n                    Status = status,\n                    Category = it.Category,\n                    SubCategory = null,\n\n                    RawJson = it.RawJson ?? \"{}\",\n\n                    ParameterFormat = paramFormat,\n                    HeaderKind = headerKindNorm,\n                    HeaderText = headerTextToPersist,\n                    Body = combinedBody,\n                    BodyPreview = bodyPreview,\n\n                    RequiresMediaHeader = requiresMediaHeader,\n\n                    BodyVarCount = bodyVars,\n                    HeaderTextVarCount = headerVars,\n                    TotalTextParamCount = totalVars,\n\n                    UrlButtons = urlButtonsJson,\n                    QuickReplyCount = quickReplyCount,\n                    HasPhoneButton = hasPhoneButton,\n\n                    NamedParamKeys = namedKeysJson,\n                    PlaceholderMap = null,\n\n                    IsActive = true,\n                    CreatedAt = now,\n                    UpdatedAt = now,\n                    LastSyncedAt = now\n                };\n\n                _db.WhatsAppTemplates.Add(newRow);\n                added++;\n\n                if (!string.IsNullOrWhiteSpace(extId)) byTemplateId[extId!] = newRow;\n                byNameLang[nlKey] = newRow;\n            }\n            else\n            {\n                // UPDATE\n                bool changed = false;\n\n                if (!string.Equals(row.Status, status, StringComparison.Ordinal))\n                { row.Status = status; changed = true; }\n\n                if (!string.Equals(row.Category, it.Category, StringComparison.Ordinal))\n                { row.Category = it.Category; changed = true; }\n\n                var newRaw = it.RawJson ?? \"{}\";\n                if (!string.Equals(row.RawJson, newRaw, StringComparison.Ordinal))\n                { row.RawJson = newRaw; changed = true; }\n\n                if (!string.Equals(row.ParameterFormat, paramFormat, StringComparison.Ordinal))\n                { row.ParameterFormat = paramFormat; changed = true; }\n\n                if (!string.Equals(row.HeaderKind, headerKindNorm, StringComparison.Ordinal))\n                { row.HeaderKind = headerKindNorm; changed = true; }\n\n                var existingHeaderText = string.IsNullOrWhiteSpace(row.HeaderText) ? null : row.HeaderText!.Trim();\n                if (!string.Equals(existingHeaderText, headerTextToPersist, StringComparison.Ordinal))\n                { row.HeaderText = headerTextToPersist; changed = true; }\n\n                if (!string.Equals(row.Body ?? string.Empty, combinedBody, StringComparison.Ordinal))\n                { row.Body = combinedBody; changed = true; }\n\n                if (!string.Equals(row.BodyPreview ?? string.Empty, bodyPreview ?? string.Empty, StringComparison.Ordinal))\n                { row.BodyPreview = bodyPreview; changed = true; }\n\n                if (row.RequiresMediaHeader != requiresMediaHeader)\n                { row.RequiresMediaHeader = requiresMediaHeader; changed = true; }\n\n                if (row.BodyVarCount != bodyVars) { row.BodyVarCount = bodyVars; changed = true; }\n                if (row.HeaderTextVarCount != headerVars) { row.HeaderTextVarCount = headerVars; changed = true; }\n                if (row.TotalTextParamCount != totalVars) { row.TotalTextParamCount = totalVars; changed = true; }\n\n                if (!string.Equals(row.UrlButtons ?? \"\", urlButtonsJson ?? \"\", StringComparison.Ordinal))\n                { row.UrlButtons = urlButtonsJson; changed = true; }\n\n                if (row.QuickReplyCount != quickReplyCount) { row.QuickReplyCount = quickReplyCount; changed = true; }\n                if (row.HasPhoneButton != hasPhoneButton) { row.HasPhoneButton = hasPhoneButton; changed = true; }\n\n                if (!string.Equals(row.NamedParamKeys ?? \"\", namedKeysJson ?? \"\", StringComparison.Ordinal))\n                { row.NamedParamKeys = namedKeysJson; changed = true; }\n\n                // PlaceholderMap remains as-is unless you compute it elsewhere\n\n                row.IsActive = true;\n                row.LastSyncedAt = now;\n\n                if (changed) { row.UpdatedAt = now; updated++; } else { unchanged++; }\n            }\n        }\n\n        // ‚õîÔ∏è Deactivation is skipped when onlyUpsert == true\n        if (!onlyUpsert && incoming.Count > 0)\n        {\n            foreach (var e in existing)\n            {\n                bool stillThere =\n                    (!string.IsNullOrWhiteSpace(e.TemplateId) && seenTemplateIds.Contains(e.TemplateId)) ||\n                    seenNLKeys.Contains(NLKey(e.Name, e.LanguageCode));\n\n                if (!stillThere && e.IsActive)\n                {\n                    e.IsActive = false;\n                    e.LastSyncedAt = now;\n                    e.UpdatedAt = now;\n                    updated++;\n                }\n            }\n        }\n\n        await _db.SaveChangesAsync(ct);\n\n        _log.LogInformation(\"[TplSync] Done (business={BusinessId}, provider={Provider}) added={Added} updated={Updated} unchanged={Unchanged} onlyUpsert={OnlyUpsert}\",\n            businessId, providerKey, added, updated, unchanged, onlyUpsert);\n\n        return new TemplateSyncResult(added, updated, unchanged, now);\n    }\n\n\n    private static (string HeaderKind, string CombinedBody, int PlaceholderCount)\n                    ComputeFromRawOrFallback(TemplateCatalogItem it)\n    {\n        var (headerKind, combinedBody, placeholderCount) =\n            TemplateJsonHelper.Summarize(it.RawJson, it.Body);\n\n        return (string.IsNullOrWhiteSpace(headerKind) ? \"none\" : headerKind,\n                combinedBody ?? string.Empty,\n                placeholderCount);\n    }\n\n    ///\n    // Add inside TemplateSyncService class\n    private static (string headerKind, bool requiresMedia, string? headerText,\n                   string parameterFormat, int bodyVars, int headerVars, int totalVars,\n                   string? namedKeysJson, string? placeholderMapJson,\n                   string? body, string? bodyPreview,\n                   string? urlButtonsJson, int quickReplyCount, bool hasPhoneButton)\n    SummarizeFromRawJson(string rawJson, string? bodyFallback)\n    {\n        // Uses your existing canonical JSON helper if present; otherwise lightweight parse.\n        // Prefer TemplateJsonHelper if it exists in your project.\n        try\n        {\n            // TemplateJsonHelper.Summarize should already compute combined details in your repo.\n            // Replace this block with that call if available to keep logic single-sourced.\n            // var s = TemplateJsonHelper.Summarize(rawJson, bodyFallback);\n            // return (... map from s ...);\n\n            var jo = Newtonsoft.Json.Linq.JObject.Parse(string.IsNullOrWhiteSpace(rawJson) ? \"{}\" : rawJson);\n            var components = (Newtonsoft.Json.Linq.JArray?)jo[\"components\"] ?? new();\n            string headerKind = \"none\";\n            string? headerText = null;\n            string parameterFormat = \"UNKNOWN\";\n\n            // HEADER detection\n            var header = components.FirstOrDefault(c =>\n                string.Equals((string?)c?[\"type\"], \"HEADER\", StringComparison.OrdinalIgnoreCase)) as Newtonsoft.Json.Linq.JObject;\n\n            var headerFormat = ((string?)header?[\"format\"])?.ToLowerInvariant();\n            headerKind = headerFormat switch\n            {\n                \"image\" => \"image\",\n                \"video\" => \"video\",\n                \"document\" => \"document\",\n                \"text\" => \"text\",\n                \"location\" => \"location\",\n                _ => \"none\"\n            };\n            if (string.Equals(headerKind, \"text\", StringComparison.OrdinalIgnoreCase))\n                headerText = (string?)header?[\"text\"];\n\n            bool requiresMedia = headerKind is \"image\" or \"video\" or \"document\";\n\n            // BODY\n            var body = (string?)components.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"BODY\", StringComparison.OrdinalIgnoreCase))?[\"text\"]\n                       ?? bodyFallback ?? string.Empty;\n            var bodyPreview = body?.Length > 240 ? body.Substring(0, 240) : body;\n\n            // NAMED vs POSITIONAL slots (rough heuristic: if there are explicit named keys, mark NAMED)\n            // Count positional: {{1}}, {{ 2 }}, etc. Count named blank tokens: {{}} as a slot marker.\n            var positional = System.Text.RegularExpressions.Regex.Matches(body ?? \"\", @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count;\n            var namedBlank = System.Text.RegularExpressions.Regex.Matches(body ?? \"\", @\"\\{\\{\\s*\\}\\}\").Count;\n\n            // Collect named param keys if present in RAW JSON (Meta has examples under example/parameters/name)\n            var namedKeys = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n            foreach (var comp in components.OfType<Newtonsoft.Json.Linq.JObject>())\n            {\n                var paramsArr = comp[\"example\"]?[\"parameters\"] as Newtonsoft.Json.Linq.JArray;\n                if (paramsArr != null)\n                {\n                    foreach (var p in paramsArr.OfType<Newtonsoft.Json.Linq.JObject>())\n                    {\n                        var name = (string?)p[\"key\"] ?? (string?)p[\"name\"];\n                        if (!string.IsNullOrWhiteSpace(name)) namedKeys.Add(name!);\n                    }\n                }\n            }\n            parameterFormat = namedKeys.Count > 0 ? \"NAMED\" : (positional > 0 ? \"POSITIONAL\" : \"UNKNOWN\");\n\n            // Header text variable count (rough: treat {{}}/positional in headerText)\n            var headerVars = 0;\n            if (!string.IsNullOrEmpty(headerText))\n            {\n                headerVars += System.Text.RegularExpressions.Regex.Matches(headerText, @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count;\n                headerVars += System.Text.RegularExpressions.Regex.Matches(headerText, @\"\\{\\{\\s*\\}\\}\").Count;\n            }\n\n            var bodyVars = positional + namedBlank;\n            var totalVars = bodyVars + headerVars;\n\n            // Buttons ‚Üí collect url buttons + quick replies + phone button presence\n            var buttons = components.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"BUTTONS\", StringComparison.OrdinalIgnoreCase)) as Newtonsoft.Json.Linq.JObject;\n            var btnArr = buttons?[\"buttons\"] as Newtonsoft.Json.Linq.JArray ?? new();\n\n            var quickReplyCount = 0;\n            var hasPhoneButton = false;\n            var urlButtonsList = new List<Newtonsoft.Json.Linq.JObject>();\n\n            foreach (var b in btnArr.OfType<Newtonsoft.Json.Linq.JObject>())\n            {\n                var sub = ((string?)b[\"sub_type\"])?.ToLowerInvariant();\n                if (sub == \"quick_reply\") quickReplyCount++;\n                if (sub == \"phone_number\") hasPhoneButton = true;\n                if (sub == \"url\")\n                {\n                    // retain minimal facsimile for UrlButtons (index + parameter template if any)\n                    var index = (string?)b[\"index\"] ?? \"0\";\n                    var parameters = b[\"parameters\"] as Newtonsoft.Json.Linq.JArray;\n                    urlButtonsList.Add(new Newtonsoft.Json.Linq.JObject\n                    {\n                        [\"index\"] = index,\n                        [\"parameters\"] = parameters ?? new Newtonsoft.Json.Linq.JArray()\n                    });\n                }\n            }\n\n            var urlButtonsJson = urlButtonsList.Count > 0\n                ? Newtonsoft.Json.JsonConvert.SerializeObject(urlButtonsList)\n                : null;\n\n            var namedKeysJson = namedKeys.Count > 0\n                ? Newtonsoft.Json.JsonConvert.SerializeObject(namedKeys.ToArray())\n                : null;\n\n            // Placeholder map is provider-specific; keep null unless you compute it elsewhere\n            string? placeholderMapJson = null;\n\n            return (headerKind, requiresMedia, headerText,\n                    parameterFormat, bodyVars, headerVars, totalVars,\n                    namedKeysJson, placeholderMapJson,\n                    body, bodyPreview,\n                    urlButtonsJson, quickReplyCount, hasPhoneButton);\n        }\n        catch\n        {\n            // very defensive fallback\n            var body = bodyFallback ?? string.Empty;\n            var bodyVars = System.Text.RegularExpressions.Regex.Matches(body, @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count\n                         + System.Text.RegularExpressions.Regex.Matches(body, @\"\\{\\{\\s*\\}\\}\").Count;\n            var preview = body.Length > 240 ? body.Substring(0, 240) : body;\n            return (\"none\", false, null, \"UNKNOWN\", bodyVars, 0, bodyVars, null, null, body, preview, null, 0, false);\n        }\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/TemplateSyncWorker.cs",
      "sha256": "70427556d8ed5f1c68348a414a166b4bcdd07911b8f9f8d63bb05f3897d30a04",
      "language": "csharp",
      "size": 8915,
      "content": "using System;\nusing System.Diagnostics;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Configuration;\nusing Microsoft.Extensions.DependencyInjection;\nusing Microsoft.Extensions.Hosting;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api; // AppDbContext\n\nnamespace xbytechat.api.WhatsAppSettings.Services\n{\n    /// <summary>\n    /// Periodically refreshes WhatsApp template catalogs for all businesses\n    /// that have an active WhatsAppSettings row. Uses ITemplateSyncService\n    /// which is TTL-aware to avoid unnecessary work.\n    /// </summary>\n    public sealed class TemplateSyncWorker : BackgroundService\n    {\n        private readonly IServiceProvider _sp;\n        private readonly ILogger<TemplateSyncWorker> _log;\n        private readonly TimeSpan _interval;\n        private readonly int _maxParallel;\n        private readonly int _jitterSeconds;\n\n        public TemplateSyncWorker(IServiceProvider sp, ILogger<TemplateSyncWorker> log, IConfiguration cfg)\n        {\n            _sp = sp;\n            _log = log;\n\n            // Defaults chosen to be light on the system.\n            // appsettings.json example:\n            // \"WhatsApp\": {\n            //   \"Templates\": {\n            //     \"SyncIntervalMinutes\": 360,\n            //     \"MaxParallel\": 1,\n            //     \"JitterSeconds\": 60\n            //   }\n            // }\n            var minutes = Math.Max(15, cfg.GetValue<int?>(\"WhatsApp:Templates:SyncIntervalMinutes\") ?? 360);\n            _interval = TimeSpan.FromMinutes(minutes);\n\n            _maxParallel = Math.Clamp(cfg.GetValue<int?>(\"WhatsApp:Templates:MaxParallel\") ?? 1, 1, 8);\n            _jitterSeconds = Math.Clamp(cfg.GetValue<int?>(\"WhatsApp:Templates:JitterSeconds\") ?? 60, 0, 300);\n        }\n\n        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n        {\n            // small delay after startup\n            await Task.Delay(TimeSpan.FromSeconds(10), stoppingToken);\n\n            var rnd = new Random();\n\n            while (!stoppingToken.IsCancellationRequested)\n            {\n                var sweepStart = DateTime.UtcNow;\n                var sw = Stopwatch.StartNew();\n                int processed = 0;\n\n                try\n                {\n                    using var scope = _sp.CreateScope();\n                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n\n                    // Get active business IDs once per sweep\n                    var bizIds = await db.WhatsAppSettings\n                        .AsNoTracking()\n                        .Where(s => s.IsActive)\n                        .Select(s => s.BusinessId)\n                        .Distinct()\n                        .ToListAsync(stoppingToken);\n\n                    if (bizIds.Count == 0)\n                    {\n                        _log.LogInformation(\"TemplateSyncWorker: no active WhatsApp settings found.\");\n                    }\n                    else\n                    {\n                        var sem = new SemaphoreSlim(_maxParallel);\n                        var tasks = bizIds.Select(async biz =>\n                        {\n                            await sem.WaitAsync(stoppingToken);\n                            try\n                            {\n                                // New scope per business to keep DbContexts short-lived\n                                using var inner = _sp.CreateScope();\n                                var sync = inner.ServiceProvider.GetRequiredService<ITemplateSyncService>();\n\n                                // TTL-aware; manual button should call force:true instead\n                                var res = await sync.SyncBusinessTemplatesAsync(biz, force: false, ct: stoppingToken);\n                                Interlocked.Increment(ref processed);\n\n                                _log.LogInformation(\n                                    \"TemplateSyncWorker: biz={Biz} added={A} updated={U} skipped={S} syncedAt={At}\",\n                                    biz, res.Added, res.Updated, res.Skipped, res.SyncedAt);\n                            }\n                            catch (OperationCanceledException) { /* shutting down */ }\n                            catch (Exception exBiz)\n                            {\n                                _log.LogWarning(exBiz, \"TemplateSyncWorker: sync failed for biz {Biz}\", biz);\n                            }\n                            finally\n                            {\n                                sem.Release();\n                            }\n                        });\n\n                        await Task.WhenAll(tasks);\n                    }\n                }\n                catch (OperationCanceledException) { /* shutting down */ }\n                catch (Exception ex)\n                {\n                    _log.LogWarning(ex, \"TemplateSyncWorker sweep failed\");\n                }\n                finally\n                {\n                    sw.Stop();\n                    _log.LogInformation(\"TemplateSyncWorker: sweep finished in {ElapsedMs} ms; processed={Processed}; next run ~{NextRun}\",\n                        sw.ElapsedMilliseconds, processed, sweepStart.Add(_interval));\n                }\n\n                // Add small jitter to avoid multiple instances syncing at the exact same time\n                var jitter = _jitterSeconds > 0 ? TimeSpan.FromSeconds(rnd.Next(0, _jitterSeconds + 1)) : TimeSpan.Zero;\n                var delay = _interval + jitter;\n\n                await Task.Delay(delay, stoppingToken);\n            }\n        }\n    }\n}\n\n\n//using System;\n//using System.Linq;\n//using System.Threading;\n//using System.Threading.Tasks;\n//using Microsoft.EntityFrameworkCore;\n//using Microsoft.Extensions.Configuration;\n//using Microsoft.Extensions.DependencyInjection;\n//using Microsoft.Extensions.Hosting;\n//using Microsoft.Extensions.Logging;\n//using xbytechat.api; // AppDbContext\n\n//namespace xbytechat.api.WhatsAppSettings.Services\n//{\n//    /// <summary>\n//    /// Periodically refreshes WhatsApp template catalogs for all businesses\n//    /// that have an active WhatsAppSettings row. Uses your existing\n//    /// ITemplateSyncService (TTL-aware) so this is safe to run frequently.\n//    /// </summary>\n//    public sealed class TemplateSyncWorker : BackgroundService\n//    {\n//        private readonly IServiceProvider _sp;\n//        private readonly ILogger<TemplateSyncWorker> _log;\n//        private readonly TimeSpan _interval;\n\n//        public TemplateSyncWorker(IServiceProvider sp, ILogger<TemplateSyncWorker> log, IConfiguration cfg)\n//        {\n//            _sp = sp;\n//            _log = log;\n\n//            // Default: every 6 hours; override in appsettings:\n//            // \"WhatsApp\": { \"Templates\": { \"SyncIntervalMinutes\": 360 } }\n//            var minutes = Math.Max(15, cfg.GetValue<int?>(\"WhatsApp:Templates:SyncIntervalMinutes\") ?? 360);\n//            _interval = TimeSpan.FromMinutes(minutes);\n//        }\n\n//        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n//        {\n//            // small delay after startup\n//            await Task.Delay(TimeSpan.FromSeconds(10), stoppingToken);\n\n//            while (!stoppingToken.IsCancellationRequested)\n//            {\n//                try\n//                {\n//                    using var scope = _sp.CreateScope();\n//                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n//                    var sync = scope.ServiceProvider.GetRequiredService<ITemplateSyncService>();\n\n//                    var bizIds = await db.WhatsAppSettings\n//                        .AsNoTracking()\n//                        .Where(s => s.IsActive)\n//                        .Select(s => s.BusinessId)\n//                        .Distinct()\n//                        .ToListAsync(stoppingToken);\n\n//                    foreach (var biz in bizIds)\n//                    {\n//                        try\n//                        {\n//                            var res = await sync.SyncBusinessTemplatesAsync(biz, force: false, ct: stoppingToken);\n//                            _log.LogInformation(\"TemplateSyncWorker: biz={Biz} added={A} updated={U} syncedAt={At}\",\n//                                biz, res.Added, res.Updated, res.SyncedAt);\n//                        }\n//                        catch (Exception exBiz)\n//                        {\n//                            _log.LogWarning(exBiz, \"TemplateSyncWorker: sync failed for biz {Biz}\", biz);\n//                        }\n//                    }\n//                }\n//                catch (Exception ex)\n//                {\n//                    _log.LogWarning(ex, \"TemplateSyncWorker sweep failed\");\n//                }\n\n//                await Task.Delay(_interval, stoppingToken);\n//            }\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppPhoneNumberService.cs",
      "sha256": "62b5db83cceae1415fd74b21b6b0060da4e300fb3d10cb9fc1f573bd92c104cc",
      "language": "csharp",
      "size": 19167,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http.Headers;\nusing System.Net;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\nusing xbytechat.api.Features.WhatsAppSettings.Services;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\n\nnamespace xbytechat.api.Features.WhatsAppSettings.Services\n{\n    public sealed class WhatsAppPhoneNumberService : IWhatsAppPhoneNumberService\n    {\n        private readonly AppDbContext _db;\n\n        public WhatsAppPhoneNumberService(AppDbContext db)\n        {\n            _db = db;\n        }\n\n        public async Task<IReadOnlyList<WhatsAppPhoneNumber>> ListAsync(\n           Guid businessId,\n           string provider,\n            CancellationToken ct = default)\n        {\n            if (string.IsNullOrWhiteSpace(provider))\n                throw new ArgumentException(\"Provider is required.\", nameof(provider));\n\n            // Enforce your uppercase-only contract (no normalization here)\n            if (provider is not \"PINNACLE\" and not \"META_CLOUD\")\n                throw new ArgumentOutOfRangeException(nameof(provider),\n                    \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n\n            var list = await _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(x => x.BusinessId == businessId && x.Provider == provider) // exact, case-sensitive\n                .OrderByDescending(x => x.IsDefault)\n                .ThenBy(x => x.WhatsAppBusinessNumber)\n                .ToListAsync(ct);\n\n            return list; // List<T> implements IReadOnlyList<T>\n        }\n\n        private static string NormalizeProvider(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return \"Pinnacle\";\n            var s = raw.Trim();\n            if (string.Equals(s, \"Pinnacle\", StringComparison.OrdinalIgnoreCase)) return \"Pinnacle\";\n            if (string.Equals(s, \"Meta_cloud\", StringComparison.OrdinalIgnoreCase) ||\n                string.Equals(s, \"meta_cloud\", StringComparison.OrdinalIgnoreCase) ||\n                string.Equals(s, \"meta\", StringComparison.OrdinalIgnoreCase))\n                return \"Meta_cloud\";\n            return s;\n        }\n\n        public async Task<(int Added, int Updated, int Total)> SyncFromProviderAsync(\n            Guid businessId,\n            WhatsAppSettingsDto s,                 // DTO\n            string provider,\n            CancellationToken ct = default)\n        {\n            // Always honor the provider saved in DB (CAPS), fall back to the arg if needed\n            var providerCanon = (s.Provider ?? provider ?? string.Empty)\n                .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n\n            List<(string PhoneId, string Number, string? Label)> list = providerCanon switch\n            {\n                \"META_CLOUD\" => await FetchFromMetaAsync(s, ct),\n                \"PINNACLE\" => await FetchFromPinnacleAsync(s, ct),\n                _ => new List<(string PhoneId, string Number, string? Label)>()\n            };\n\n            var added = 0;\n            var updated = 0;\n\n            foreach (var (phoneId, number, label) in list)\n            {\n                var existing = await _db.WhatsAppPhoneNumbers\n                    .FirstOrDefaultAsync(x =>\n                        x.BusinessId == businessId &&\n                        x.Provider == providerCanon &&\n                        x.PhoneNumberId == phoneId, ct);\n\n                if (existing is null)\n                {\n                    _db.WhatsAppPhoneNumbers.Add(new WhatsAppPhoneNumber\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        Provider = providerCanon,                 // segregate by provider\n                        PhoneNumberId = phoneId,\n                        WhatsAppBusinessNumber = number,\n                        SenderDisplayName = string.IsNullOrWhiteSpace(label) ? null : label,\n                        IsActive = true,\n                        IsDefault = false\n                    });\n                    added++;\n                }\n                else\n                {\n                    existing.WhatsAppBusinessNumber = number;\n                    if (!string.IsNullOrWhiteSpace(label))\n                        existing.SenderDisplayName = label;\n                    existing.IsActive = true;\n                    updated++;\n                }\n            }\n\n            await _db.SaveChangesAsync(ct);\n            return (added, updated, list.Count);\n        }\n\n        private async Task<List<(string PhoneId, string Number, string? Label)>> FetchFromMetaAsync(\n            WhatsAppSettingsDto s,\n            CancellationToken ct)\n        {\n            var list = new List<(string, string, string?)>();\n\n            if (string.IsNullOrWhiteSpace(s.ApiKey) || string.IsNullOrWhiteSpace(s.WabaId))\n                return list;\n\n            var baseUrl = string.IsNullOrWhiteSpace(s.ApiUrl)\n                ? \"https://graph.facebook.com/v22.0\"\n                : s.ApiUrl.TrimEnd('/');\n\n            var url = $\"{baseUrl}/{s.WabaId}/phone_numbers?limit=100\";\n\n            using var http = new HttpClient();\n            http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", s.ApiKey);\n\n            var res = await http.GetAsync(url, ct);\n            var body = await res.Content.ReadAsStringAsync(ct);\n            if (!res.IsSuccessStatusCode) return list;\n\n            using var doc = JsonDocument.Parse(body);\n            var root = doc.RootElement;\n\n            var data = root.ValueKind == JsonValueKind.Array\n                ? root\n                : root.TryGetProperty(\"data\", out var d) && d.ValueKind == JsonValueKind.Array ? d\n                : default;\n\n            if (data.ValueKind == JsonValueKind.Array)\n            {\n                foreach (var e in data.EnumerateArray())\n                {\n                    var id = e.TryGetProperty(\"id\", out var idEl) ? idEl.GetString()\n                             : e.TryGetProperty(\"phone_number_id\", out var pid) ? pid.GetString()\n                             : null;\n\n                    var num = e.TryGetProperty(\"display_phone_number\", out var dnum) ? dnum.GetString()\n                             : e.TryGetProperty(\"number\", out var numEl) ? numEl.GetString()\n                             : null;\n\n                    var name = e.TryGetProperty(\"verified_name\", out var vn) ? vn.GetString()\n                             : e.TryGetProperty(\"name\", out var nm) ? nm.GetString()\n                             : null;\n\n                    if (!string.IsNullOrWhiteSpace(id) && !string.IsNullOrWhiteSpace(num))\n                        list.Add((id!, num!, name));\n                }\n            }\n\n            return list;\n        }\n\n        private async Task<List<(string PhoneId, string Number, string? Label)>> FetchFromPinnacleAsync(\n            WhatsAppSettingsDto s,\n            CancellationToken ct)\n        {\n            var list = new List<(string, string, string?)>();\n\n            if (string.IsNullOrWhiteSpace(s.ApiKey))\n                return list;\n\n            // Base URL and /v3 suffix\n            var baseUrl = string.IsNullOrWhiteSpace(s.ApiUrl)\n                ? \"https://partnersv1.pinbot.ai\"\n                : s.ApiUrl.TrimEnd('/');\n\n            if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase))\n                baseUrl += \"/v3\";\n\n            // Prefer WABA, fall back to PhoneNumberId\n            var pathId = !string.IsNullOrWhiteSpace(s.WabaId) ? s.WabaId!.Trim()\n                       : !string.IsNullOrWhiteSpace(s.PhoneNumberId) ? s.PhoneNumberId!.Trim()\n                       : null;\n\n            if (string.IsNullOrWhiteSpace(pathId))\n                return list;\n\n            var url = $\"{baseUrl}/{pathId}/phone_numbers\";\n\n            using var http = new HttpClient();\n            using var req = new HttpRequestMessage(HttpMethod.Get, url);\n            req.Headers.TryAddWithoutValidation(\"apikey\", s.ApiKey);\n\n            var res = await http.SendAsync(req, ct);\n            var body = await res.Content.ReadAsStringAsync(ct);\n            if (!res.IsSuccessStatusCode) return list;\n\n            using var doc = JsonDocument.Parse(body);\n            var root = doc.RootElement;\n\n            var data = root.ValueKind == JsonValueKind.Array\n                ? root\n                : root.TryGetProperty(\"data\", out var d) && d.ValueKind == JsonValueKind.Array ? d\n                : default;\n\n            if (data.ValueKind == JsonValueKind.Array)\n            {\n                foreach (var e in data.EnumerateArray())\n                {\n                    var id = e.TryGetProperty(\"id\", out var idEl) ? idEl.GetString()\n                             : e.TryGetProperty(\"phone_number_id\", out var pid) ? pid.GetString()\n                             : null;\n\n                    var num = e.TryGetProperty(\"display_phone_number\", out var dnum) ? dnum.GetString()\n                             : e.TryGetProperty(\"msisdn\", out var msisdn) ? msisdn.GetString()\n                             : e.TryGetProperty(\"number\", out var numEl) ? numEl.GetString()\n                             : null;\n\n                    var name = e.TryGetProperty(\"verified_name\", out var vn) ? vn.GetString()\n                             : e.TryGetProperty(\"name\", out var nm) ? nm.GetString()\n                             : null;\n\n                    if (!string.IsNullOrWhiteSpace(id) && !string.IsNullOrWhiteSpace(num))\n                        list.Add((id!, num!, name));\n                }\n            }\n\n            return list;\n        }\n\n\n        private static string NormalizeMetaBase(string? apiUrl)\n                        => string.IsNullOrWhiteSpace(apiUrl) ? \"https://graph.facebook.com/v22.0\" : apiUrl.Trim();\n\n        private async Task<List<(string PhoneId, string Number, string? Label)>> FetchFromMetaAsync(\n            WhatsAppSettingEntity s, CancellationToken ct)\n        {\n            var baseUrl = NormalizeMetaBase(s.ApiUrl);\n            using var http = new HttpClient();\n            http.DefaultRequestHeaders.Authorization =\n                new AuthenticationHeaderValue(\"Bearer\", s.ApiKey!.Trim());\n\n            var list = new List<(string, string, string?)>();\n            string? after = null;\n\n            do\n            {\n                var url = $\"{baseUrl}/{s.WabaId}/phone_numbers?fields=id,display_phone_number,verified_name\";\n                if (!string.IsNullOrEmpty(after)) url += $\"&after={WebUtility.UrlEncode(after)}\";\n\n                var json = await http.GetStringAsync(url, ct);\n                using var doc = JsonDocument.Parse(json);\n                var root = doc.RootElement;\n\n                if (root.TryGetProperty(\"data\", out var data) && data.ValueKind == JsonValueKind.Array)\n                {\n                    foreach (var e in data.EnumerateArray())\n                    {\n                        var id = e.TryGetProperty(\"id\", out var idEl) ? idEl.GetString() : null;\n                        var num = e.TryGetProperty(\"display_phone_number\", out var nEl) ? nEl.GetString() : null;\n                        var name = e.TryGetProperty(\"verified_name\", out var lEl) ? lEl.GetString() : null;\n                        if (!string.IsNullOrWhiteSpace(id) && !string.IsNullOrWhiteSpace(num))\n                            list.Add((id!, num!, name));\n                    }\n                }\n\n                after = root.TryGetProperty(\"paging\", out var p)\n                     && p.TryGetProperty(\"cursors\", out var c)\n                     && c.TryGetProperty(\"after\", out var a)\n                     && a.ValueKind == JsonValueKind.String ? a.GetString() : null;\n\n            } while (!string.IsNullOrEmpty(after));\n\n            return list;\n        }\n\n\n        public async Task<WhatsAppPhoneNumber> UpsertAsync(\n              Guid businessId,\n              string provider, string phoneNumberId,\n              string whatsAppBusinessNumber, string? senderDisplayName,\n              bool? isActive = null,\n         bool? isDefault = null)\n        {\n            if (string.IsNullOrWhiteSpace(provider)) throw new ArgumentException(\"provider is required\");\n            if (string.IsNullOrWhiteSpace(phoneNumberId)) throw new ArgumentException(\"phoneNumberId is required\");\n            if (string.IsNullOrWhiteSpace(whatsAppBusinessNumber)) throw new ArgumentException(\"whatsAppBusinessNumber is required\");\n\n            // Canonical provider: \"PINNACLE\" | \"META_CLOUD\"\n            var prov = provider.Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n            var pnid = phoneNumberId.Trim();\n            var waNum = whatsAppBusinessNumber.Trim();\n            var disp = string.IsNullOrWhiteSpace(senderDisplayName) ? null : senderDisplayName!.Trim();\n\n            var now = DateTime.UtcNow;\n\n            await using var tx = await _db.Database.BeginTransactionAsync();\n\n            // 1) Ensure parent settings row exists for (BusinessId, Provider) [case-insensitive]\n            var setting = await _db.WhatsAppSettings\n                .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.Provider.ToLower() == prov.ToLower());\n\n            if (setting == null)\n            {\n                setting = new WhatsAppSettingEntity\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Provider = prov,\n                    ApiUrl = string.Empty,\n                    ApiKey = string.Empty,\n                    IsActive = true,\n                    CreatedAt = now\n                };\n                _db.WhatsAppSettings.Add(setting);\n                await _db.SaveChangesAsync();\n            }\n            else if (!string.Equals(setting.Provider, prov, StringComparison.Ordinal))\n            {\n                // normalize stored provider casing\n                setting.Provider = prov;\n                setting.UpdatedAt = now;\n                await _db.SaveChangesAsync();\n            }\n\n            var providerForChild = setting.Provider; // exact value used for children\n\n            // 2) Upsert phone number in WhatsAppPhoneNumbers\n            var entity = await _db.WhatsAppPhoneNumbers.FirstOrDefaultAsync(x =>\n                x.BusinessId == businessId &&\n                x.Provider.ToLower() == providerForChild.ToLower() &&\n                x.PhoneNumberId == pnid);\n\n            if (entity == null)\n            {\n                entity = new WhatsAppPhoneNumber\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Provider = providerForChild,\n                    PhoneNumberId = pnid,\n                    WhatsAppBusinessNumber = waNum,\n                    SenderDisplayName = disp,\n                    IsActive = isActive ?? true,\n                    IsDefault = isDefault ?? false,\n                    CreatedAt = now\n                };\n                _db.WhatsAppPhoneNumbers.Add(entity);\n            }\n            else\n            {\n                entity.WhatsAppBusinessNumber = waNum;\n                entity.SenderDisplayName = disp;\n                if (isActive.HasValue) entity.IsActive = isActive.Value;\n                if (isDefault.HasValue) entity.IsDefault = isDefault.Value;\n                entity.UpdatedAt = now;\n            }\n\n            await _db.SaveChangesAsync();\n\n            // 3) Enforce a single default per (BusinessId, Provider)\n            if (isDefault == true || entity.IsDefault)\n            {\n                await _db.WhatsAppPhoneNumbers\n                    .Where(x => x.BusinessId == businessId &&\n                                x.Provider.ToLower() == providerForChild.ToLower() &&\n                                x.Id != entity.Id)\n                    .ExecuteUpdateAsync(up => up.SetProperty(p => p.IsDefault, false));\n\n                // We no longer mirror to WhatsAppSettings because those columns were removed.\n                // If you ever re-introduce them, you can set:\n                // setting.PhoneNumberId = entity.PhoneNumberId;\n                // setting.WhatsAppBusinessNumber = entity.WhatsAppBusinessNumber;\n                setting.UpdatedAt = now;\n                await _db.SaveChangesAsync();\n            }\n\n            await tx.CommitAsync();\n            return entity;\n        }\n\n        public async Task<bool> DeleteAsync(Guid businessId, string provider, Guid id)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            var entity = await _db.WhatsAppPhoneNumbers\n                .FirstOrDefaultAsync(x => x.Id == id && x.BusinessId == businessId && x.Provider.ToLower() == prov.ToLower());\n\n            if (entity == null) return false;\n\n            _db.WhatsAppPhoneNumbers.Remove(entity);\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> SetDefaultAsync(Guid businessId, string provider, Guid id)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            await _db.Database.BeginTransactionAsync();\n            try\n            {\n                // ensure target exists and belongs to (business, provider)\n                var target = await _db.WhatsAppPhoneNumbers\n                    .FirstOrDefaultAsync(x => x.Id == id && x.BusinessId == businessId && x.Provider.ToLower() == prov.ToLower());\n                if (target == null) return false;\n\n                await _db.WhatsAppPhoneNumbers\n                    .Where(x => x.BusinessId == businessId && x.Provider.ToLower() == prov.ToLower())\n                    .ExecuteUpdateAsync(s => s.SetProperty(p => p.IsDefault, false));\n\n                target.IsDefault = true;\n                target.UpdatedAt = DateTime.UtcNow;\n                await _db.SaveChangesAsync();\n\n                await _db.Database.CommitTransactionAsync();\n                return true;\n            }\n            catch\n            {\n                await _db.Database.RollbackTransactionAsync();\n                throw;\n            }\n        }\n\n        public async Task<WhatsAppPhoneNumber?> FindAsync(Guid businessId, string provider, string phoneNumberId)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            return await _db.WhatsAppPhoneNumbers\n                .FirstOrDefaultAsync(x =>\n                    x.BusinessId == businessId &&\n                    x.Provider.ToLower() == prov.ToLower() &&\n                    x.PhoneNumberId == phoneNumberId);\n        }\n\n        public async Task<WhatsAppPhoneNumber?> GetDefaultAsync(Guid businessId, string provider)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            // covered by partial unique index: at most one IsDefault per (biz, provider)\n            return await _db.WhatsAppPhoneNumbers\n                .FirstOrDefaultAsync(x =>\n                    x.BusinessId == businessId &&\n                    x.Provider.ToLower() == prov.ToLower() &&\n                    x.IsDefault);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppSenderService.cs",
      "sha256": "fd33c4751a0f50ea7a6b0898303851a6f0d007bf2cd22708e0787b6ac1c57a1d",
      "language": "csharp",
      "size": 2691,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.WhatsAppSettings.DTOs;               \nnamespace xbytechat.api.WhatsAppSettings.Services\n{\n    public sealed class WhatsAppSenderService : IWhatsAppSenderService\n    {\n        private readonly AppDbContext _db;\n        public WhatsAppSenderService(AppDbContext db) => _db = db;\n\n        public async Task<IReadOnlyList<WhatsAppSenderDto>> GetBusinessSendersAsync(\n            Guid businessId,\n            CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) return Array.Empty<WhatsAppSenderDto>();\n\n            var rows = await _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(x => x.BusinessId == businessId && x.IsActive)\n                .OrderByDescending(x => x.IsDefault)\n                .ThenBy(x => x.WhatsAppBusinessNumber)\n                .ToListAsync(ct);\n\n            return rows.Select(x =>\n            {\n                // inline normalize: uppercase; map META -> META_CLOUD\n                var prov = (x.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                if (prov == \"META\") prov = \"META_CLOUD\";\n\n                return new WhatsAppSenderDto\n                {\n                    Id = x.Id,\n                    BusinessId = x.BusinessId,\n                    Provider = prov, // \"PINNACLE\" | \"META_CLOUD\" (ideally)\n                    PhoneNumberId = x.PhoneNumberId,\n                    WhatsAppBusinessNumber = x.WhatsAppBusinessNumber,\n                    SenderDisplayName = x.SenderDisplayName,\n                    IsActive = x.IsActive,\n                    IsDefault = x.IsDefault\n                };\n            }).ToList();\n        }\n        public async Task<(string Provider, string PhoneNumberId)?> ResolveSenderPairAsync(\n            Guid businessId,\n            string phoneNumberId,\n            CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty || string.IsNullOrWhiteSpace(phoneNumberId))\n                return null;\n\n            var row = await _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .FirstOrDefaultAsync(x =>\n                    x.BusinessId == businessId &&\n                    x.PhoneNumberId == phoneNumberId &&\n                    x.IsActive, ct);\n\n            if (row == null) return null;\n\n            // inline normalize here too\n            var prov = (row.Provider ?? string.Empty).Trim().ToUpperInvariant();\n            if (prov == \"META\") prov = \"META_CLOUD\";\n\n            return (prov, row.PhoneNumberId);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppSettingsService.cs",
      "sha256": "41e361db63ad387fd14d1af22a96a6fc8353a849d174fdbeaf2e032c09ebe1c4",
      "language": "csharp",
      "size": 16686,
      "content": "// üìÑ xbytechat_api/WhatsAppSettings/Services/WhatsAppSettingsService.cs\nusing Microsoft.EntityFrameworkCore;\nusing System;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing xbytechat.api;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public class WhatsAppSettingsService : IWhatsAppSettingsService\n    {\n        private readonly AppDbContext _dbContext;\n        private readonly HttpClient _http;                    \n        private readonly IHttpClientFactory _httpClientFactory;\n\n        public WhatsAppSettingsService(\n            AppDbContext dbContext,\n            HttpClient http,\n            IHttpClientFactory httpClientFactory)\n        {\n            _dbContext = dbContext;\n            _http = http;\n            _httpClientFactory = httpClientFactory;\n        }\n\n        public async Task SaveOrUpdateSettingAsync(SaveWhatsAppSettingDto dto)\n        {\n            if (dto.BusinessId == Guid.Empty) throw new ArgumentException(\"BusinessId required\");\n\n            // Canonical provider: PINNACLE | META_CLOUD\n            var providerCanon = (dto.Provider ?? \"PINNACLE\")\n                .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n            if (providerCanon is not (\"PINNACLE\" or \"META_CLOUD\")) providerCanon = \"PINNACLE\";\n\n            var now = DateTime.UtcNow;\n\n            await using var tx = await _dbContext.Database.BeginTransactionAsync();\n\n            // Exact business + provider row\n            var existing = await _dbContext.WhatsAppSettings\n                .FirstOrDefaultAsync(x => x.BusinessId == dto.BusinessId &&\n                                          x.Provider.ToLower() == providerCanon.ToLower());\n\n            if (existing != null)\n            {\n                if (!string.Equals(existing.Provider, providerCanon, StringComparison.Ordinal))\n                    existing.Provider = providerCanon;\n\n                if (!string.IsNullOrWhiteSpace(dto.ApiUrl)) existing.ApiUrl = dto.ApiUrl.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.ApiKey)) existing.ApiKey = dto.ApiKey.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WabaId)) existing.WabaId = dto.WabaId.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.SenderDisplayName)) existing.SenderDisplayName = dto.SenderDisplayName.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WebhookSecret)) existing.WebhookSecret = dto.WebhookSecret.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WebhookVerifyToken)) existing.WebhookVerifyToken = dto.WebhookVerifyToken.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WebhookCallbackUrl)) existing.WebhookCallbackUrl = dto.WebhookCallbackUrl.Trim();\n\n                existing.IsActive = dto.IsActive;\n                existing.UpdatedAt = now;\n\n                // Ensure single active row per business\n                await _dbContext.WhatsAppSettings\n                    .Where(x => x.BusinessId == dto.BusinessId && x.Id != existing.Id)\n                    .ExecuteUpdateAsync(s => s.SetProperty(p => p.IsActive, false));\n            }\n            else\n            {\n                var s = new WhatsAppSettingEntity\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    Provider = providerCanon,\n                    ApiUrl = (dto.ApiUrl ?? string.Empty).Trim(),\n                    ApiKey = (dto.ApiKey ?? string.Empty).Trim(),\n                    // Numbers are not stored here anymore\n                    SenderDisplayName = string.IsNullOrWhiteSpace(dto.SenderDisplayName) ? null : dto.SenderDisplayName.Trim(),\n                    WabaId = string.IsNullOrWhiteSpace(dto.WabaId) ? null : dto.WabaId.Trim(),\n                    WebhookSecret = string.IsNullOrWhiteSpace(dto.WebhookSecret) ? null : dto.WebhookSecret.Trim(),\n                    WebhookVerifyToken = string.IsNullOrWhiteSpace(dto.WebhookVerifyToken) ? null : dto.WebhookVerifyToken.Trim(),\n                    WebhookCallbackUrl = string.IsNullOrWhiteSpace(dto.WebhookCallbackUrl) ? null : dto.WebhookCallbackUrl.Trim(),\n                    IsActive = dto.IsActive,\n                    CreatedAt = now\n                };\n                await _dbContext.WhatsAppSettings.AddAsync(s);\n            }\n\n            await _dbContext.SaveChangesAsync();\n\n            // ‚îÄ‚îÄ Numbers live in WhatsAppPhoneNumbers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n            if (!string.IsNullOrWhiteSpace(dto.PhoneNumberId) &&\n                !string.IsNullOrWhiteSpace(dto.WhatsAppBusinessNumber))\n            {\n                var pnid = dto.PhoneNumberId.Trim();\n                var waNum = dto.WhatsAppBusinessNumber.Trim();\n                var display = string.IsNullOrWhiteSpace(dto.SenderDisplayName) ? null : dto.SenderDisplayName!.Trim();\n\n                // Upsert by business+provider+phoneId\n                var numberRow = await _dbContext.WhatsAppPhoneNumbers.FirstOrDefaultAsync(x =>\n                    x.BusinessId == dto.BusinessId &&\n                    x.Provider.ToLower() == providerCanon.ToLower() &&\n                    x.PhoneNumberId == pnid);\n\n                if (numberRow == null)\n                {\n                    numberRow = new WhatsAppPhoneNumber\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = dto.BusinessId,\n                        Provider = providerCanon,\n                        PhoneNumberId = pnid,\n                        WhatsAppBusinessNumber = waNum,\n                        SenderDisplayName = display,\n                        IsActive = true,\n                        IsDefault = true,\n                        CreatedAt = now\n                    };\n                    _dbContext.WhatsAppPhoneNumbers.Add(numberRow);\n                }\n                else\n                {\n                    numberRow.WhatsAppBusinessNumber = waNum;\n                    numberRow.SenderDisplayName = display;\n                    numberRow.IsActive = true;\n                    numberRow.IsDefault = true;\n                    numberRow.UpdatedAt = now;\n                }\n\n                await _dbContext.SaveChangesAsync();\n\n                // Ensure single default per business+provider\n                await _dbContext.WhatsAppPhoneNumbers\n                    .Where(x => x.BusinessId == dto.BusinessId &&\n                                x.Provider.ToLower() == providerCanon.ToLower() &&\n                                x.Id != numberRow.Id)\n                    .ExecuteUpdateAsync(s => s.SetProperty(p => p.IsDefault, false));\n            }\n            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n            await tx.CommitAsync();\n        }\n\n        public async Task<WhatsAppSettingsDto> GetSettingsByBusinessIdAsync(Guid businessId)\n        {\n            var row = await (\n                from s in _dbContext.WhatsAppSettings.AsNoTracking()\n                where s.BusinessId == businessId && s.IsActive\n                orderby (s.UpdatedAt ?? s.CreatedAt) descending\n                select new\n                {\n                    s.BusinessId,\n                    s.Provider,\n                    s.ApiUrl,\n                    s.ApiKey,\n                    s.WabaId,\n                    Phone = _dbContext.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(p => p.BusinessId == s.BusinessId\n                                    && p.IsActive\n                                    && p.Provider.ToLower() == s.Provider.ToLower())\n                        .OrderByDescending(p => p.IsDefault)\n                        .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                        .Select(p => new { p.PhoneNumberId, p.WhatsAppBusinessNumber })\n                        .FirstOrDefault()\n                }\n            ).FirstOrDefaultAsync();\n\n            if (row == null) return null;\n\n            return new WhatsAppSettingsDto\n            {\n                BusinessId = row.BusinessId,\n                Provider = row.Provider,\n                ApiUrl = row.ApiUrl,\n                ApiKey = row.ApiKey,\n                WabaId = row.WabaId,\n                PhoneNumberId = row.Phone?.PhoneNumberId,\n                WhatsAppBusinessNumber = row.Phone?.WhatsAppBusinessNumber\n            };\n        }\n\n        public async Task<bool> DeleteSettingsAsync(Guid businessId)\n        {\n            var setting = await _dbContext.WhatsAppSettings\n                .FirstOrDefaultAsync(x => x.BusinessId == businessId);\n\n            if (setting == null) return false;\n\n            _dbContext.WhatsAppSettings.Remove(setting);\n            await _dbContext.SaveChangesAsync();\n            return true;\n        }\n\n        /// <summary>\n        /// Provider-aware test connection. Returns a short message (‚úÖ/‚ùå ‚Ä¶).\n        /// The controller may convert non-‚úÖ messages to 400, etc.\n        /// </summary>\n        public async Task<string> TestConnectionAsync(SaveWhatsAppSettingDto dto)\n        {\n            if (string.IsNullOrWhiteSpace(dto.Provider))\n                throw new ArgumentException(\"Provider is required.\");\n\n            // normalize provider and baseUrl\n            var provider = dto.Provider.Trim();\n            var lower = provider.ToLowerInvariant();\n            var baseUrl = (dto.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n\n            if (string.IsNullOrWhiteSpace(baseUrl))\n                throw new ArgumentException(\"ApiUrl is required.\");\n\n            var http = _httpClientFactory.CreateClient();\n\n            // ----- Meta Cloud -----\n            if (lower == \"meta_cloud\")\n            {\n                if (string.IsNullOrWhiteSpace(dto.ApiKey))\n                    throw new ArgumentException(\"ApiKey is required for Meta Cloud.\");\n                if (string.IsNullOrWhiteSpace(dto.PhoneNumberId))\n                    throw new ArgumentException(\"PhoneNumberId is required for Meta Cloud.\");\n\n                http.DefaultRequestHeaders.Authorization =\n                    new AuthenticationHeaderValue(\"Bearer\", dto.ApiKey);\n\n                var url = $\"{baseUrl}/{dto.PhoneNumberId}\";\n                var res = await http.GetAsync(url);\n                var body = await res.Content.ReadAsStringAsync();\n\n                if (!res.IsSuccessStatusCode)\n                    return $\"‚ùå Meta Cloud test failed ({(int)res.StatusCode}). Body: {body}\";\n\n                return \"‚úÖ Meta Cloud token & phone number ID are valid.\";\n            }\n\n            // ----- Pinnacle (formerly Pinbot) -----\n            if (lower == \"pinnacle\")\n            {\n                if (string.IsNullOrWhiteSpace(dto.ApiKey))\n                    return \"‚ùå API Key is required for Pinnacle.\";\n\n                // Pinnacle requires either phone number id OR WABA id in the path\n                var pathId =\n                    !string.IsNullOrWhiteSpace(dto.PhoneNumberId) ? dto.PhoneNumberId!.Trim() :\n                    !string.IsNullOrWhiteSpace(dto.WabaId) ? dto.WabaId!.Trim() :\n                    null;\n\n                if (string.IsNullOrWhiteSpace(pathId))\n                    return \"‚ùå Provide PhoneNumberId or WabaId for Pinnacle.\";\n\n                if (string.IsNullOrWhiteSpace(dto.WhatsAppBusinessNumber))\n                    return \"‚ùå WhatsApp Business Number is required for Pinnacle test.\";\n\n                var url = $\"{baseUrl}/{pathId}/messages\";\n                var payload = new\n                {\n                    to = dto.WhatsAppBusinessNumber,\n                    type = \"text\",\n                    text = new { body = \"Test message\" },\n                    messaging_product = \"whatsapp\"\n                };\n\n                using var req = new HttpRequestMessage(HttpMethod.Post, url);\n                req.Headers.TryAddWithoutValidation(\"apikey\", dto.ApiKey);\n                req.Content = new StringContent(JsonSerializer.Serialize(payload), Encoding.UTF8, \"application/json\");\n\n                var res = await http.SendAsync(req);\n                var body = await res.Content.ReadAsStringAsync();\n\n                if (!res.IsSuccessStatusCode)\n                {\n                    if ((int)res.StatusCode == 401 || (int)res.StatusCode == 403)\n                        return $\"‚ùå Pinnacle rejected the API key for id '{pathId}'. Verify the key and id. Body: {body}\";\n\n                    return $\"‚ùå Pinnacle test failed ({(int)res.StatusCode}). Body: {body}\";\n                }\n\n                return \"‚úÖ Pinnacle API key and endpoint are reachable.\";\n            }\n\n            return $\"‚ùå Unsupported provider: {dto.Provider}\";\n        }\n\n        // ‚úÖ UPDATED: read from WhatsAppPhoneNumbers (default by provider), fallback to mirrored settings value\n        public async Task<string?> GetSenderNumberAsync(Guid businessId)\n        {\n            // 1) Find this business's active provider\n            var providerRaw = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .Where(s => s.BusinessId == businessId && s.IsActive)\n                .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                .Select(s => s.Provider)\n                .FirstOrDefaultAsync();\n\n            if (string.IsNullOrWhiteSpace(providerRaw))\n                return null;\n\n            // Canonical provider (\"META_CLOUD\" | \"PINNACLE\")\n            var provider = providerRaw.Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n            var providerLc = provider.ToLowerInvariant();\n\n            // 2) Prefer the default active number for THAT provider\n            var number = await _dbContext.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == businessId &&\n                            n.IsActive &&\n                            n.Provider.ToLower() == providerLc)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .Select(n => n.WhatsAppBusinessNumber)\n                .FirstOrDefaultAsync();\n\n            if (!string.IsNullOrWhiteSpace(number))\n                return number;\n\n            // 3) Fallback: any active number for this business (regardless of provider)\n            number = await _dbContext.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == businessId && n.IsActive)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .Select(n => n.WhatsAppBusinessNumber)\n                .FirstOrDefaultAsync();\n\n            return string.IsNullOrWhiteSpace(number) ? null : number;\n        }\n\n        public async Task<string> GetCallbackUrlAsync(Guid businessId, string appBaseUrl)\n        {\n            var s = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive);\n\n            if (!string.IsNullOrWhiteSpace(s?.WebhookCallbackUrl))\n                return s!.WebhookCallbackUrl!;\n\n            return $\"{appBaseUrl.TrimEnd('/')}/api/webhookcallback\";\n        }\n\n        public async Task<IReadOnlyList<WhatsAppSettingEntity>> GetAllForBusinessAsync(Guid businessId)\n        {\n            // Return all rows (one per provider) for this business + include numbers collection\n            var items = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .Where(s => s.BusinessId == businessId)\n                .Include(s => s.WhatsAppBusinessNumbers) // ‚úÖ correct navigation include\n                .OrderBy(s => s.Provider)\n                .ToListAsync();\n\n            return items.AsReadOnly();\n        }\n\n        public async Task<WhatsAppSettingEntity?> GetSettingsByBusinessIdAndProviderAsync(Guid businessId, string provider)\n        {\n            if (string.IsNullOrWhiteSpace(provider)) return null;\n            var prov = provider.Trim();\n\n            // case-insensitive provider match\n            return await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.Provider.ToLower() == prov.ToLower());\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppTemplateFetcherService.cs",
      "sha256": "fc3b6d2edf876703dc48a9e8cc52bf0ad59e76c10c894460b33d15c0b82e9d1c",
      "language": "csharp",
      "size": 62589,
      "content": "using Microsoft.EntityFrameworkCore;\nusing Newtonsoft.Json;\nusing Newtonsoft.Json.Linq;\nusing System.Net.Http.Headers;\nusing System.Security.Claims;\nusing System.Text.Json;\nusing System.Text.RegularExpressions;\nusing xbytechat.api;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Shared;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat.api.WhatsAppSettings.Helpers;\nusing DTO = xbytechat.api.WhatsAppSettings.DTOs;\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n\n    public class WhatsAppTemplateFetcherService : IWhatsAppTemplateFetcherService\n    {\n        private readonly AppDbContext _dbContext;\n        private readonly HttpClient _httpClient;\n        private readonly ILogger<WhatsAppTemplateFetcherService> _logger;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n        public WhatsAppTemplateFetcherService(AppDbContext dbContext, HttpClient httpClient, ILogger<WhatsAppTemplateFetcherService> logger, IHttpContextAccessor httpContextAccessor)\n        {\n            _dbContext = dbContext;\n            _httpClient = httpClient;\n            _logger = logger;\n            _httpContextAccessor = httpContextAccessor;\n        }\n        public async Task<List<TemplateMetadataDto>> FetchTemplatesAsync(Guid businessId)\n        {\n            var templates = new List<TemplateMetadataDto>();\n\n            var setting = await _dbContext.WhatsAppSettings\n                .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive);\n\n            if (setting == null)\n            {\n                _logger.LogWarning(\"WhatsApp Settings not found for BusinessId: {BusinessId}\", businessId);\n                return templates;\n            }\n\n            // Canonical provider\n            var provider = (setting.Provider ?? string.Empty)\n                .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n\n            // Common base url normalization\n            var rawBase = (setting.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n\n            try\n            {\n                // ==================== META_CLOUD ====================\n                if (provider == \"META_CLOUD\")\n                {\n                    var baseUrl = string.IsNullOrWhiteSpace(rawBase)\n                        ? \"https://graph.facebook.com/v22.0\"\n                        : rawBase;\n\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey) || string.IsNullOrWhiteSpace(setting.WabaId))\n                    {\n                        _logger.LogWarning(\"Missing Meta ApiKey or WABA ID for BusinessId: {BusinessId}\", businessId);\n                        return templates;\n                    }\n\n                    _httpClient.DefaultRequestHeaders.Authorization =\n                        new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n\n                    var nextUrl = $\"{baseUrl}/{setting.WabaId!.Trim()}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        var response = await _httpClient.GetAsync(nextUrl);\n                        var json = await response.Content.ReadAsStringAsync();\n                        _logger.LogInformation(\"üì¶ Meta Template API Raw JSON for {BusinessId}:\\n{Json}\", setting.BusinessId, json);\n\n                        if (!response.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"‚ùå Failed to fetch templates from Meta: {Response}\", json);\n                            break;\n                        }\n\n                        dynamic parsed = JsonConvert.DeserializeObject(json);\n                        templates.AddRange(ParseTemplatesFromMetaLikePayload(parsed));\n                        nextUrl = parsed?.paging?.next?.ToString();\n                    }\n\n                    return templates;\n                }\n\n                // ==================== PINNACLE ====================\n                if (provider == \"PINNACLE\")\n                {\n                    // Ensure base has /v3\n                    var baseUrl = string.IsNullOrWhiteSpace(rawBase) ? \"https://partnersv1.pinbot.ai\" : rawBase;\n                    if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase)) baseUrl += \"/v3\";\n\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                    {\n                        _logger.LogWarning(\"Pinnacle ApiKey missing for BusinessId: {BusinessId}\", businessId);\n                        return templates;\n                    }\n\n                    // Prefer WABA; otherwise use the DEFAULT phoneNumberId for this business+provider\n                    var pathId = !string.IsNullOrWhiteSpace(setting.WabaId)\n                        ? setting.WabaId!.Trim()\n                        : await _dbContext.WhatsAppPhoneNumbers\n                            .AsNoTracking()\n                            .Where(p => p.BusinessId == businessId\n                                        && p.IsActive\n                                        && p.Provider.ToUpper() == \"PINNACLE\")\n                            .OrderByDescending(p => p.IsDefault)\n                            .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                            .Select(p => p.PhoneNumberId)\n                            .FirstOrDefaultAsync();\n\n                    if (string.IsNullOrWhiteSpace(pathId))\n                    {\n                        _logger.LogWarning(\"Pinnacle path id missing (WabaId or default PhoneNumberId) for BusinessId: {BusinessId}\", businessId);\n                        return templates;\n                    }\n\n                    // Headers Pinnacle commonly accepts\n                    _httpClient.DefaultRequestHeaders.Remove(\"apikey\");\n                    _httpClient.DefaultRequestHeaders.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n\n                    var nextUrl = $\"{baseUrl}/{pathId}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        var response = await _httpClient.GetAsync(nextUrl);\n                        var json = await response.Content.ReadAsStringAsync();\n                        _logger.LogInformation(\"üì¶ Pinnacle Template API Raw JSON for {BusinessId}:\\n{Json}\", setting.BusinessId, json);\n\n                        if (!response.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"‚ùå Failed to fetch templates from Pinnacle: {Response}\", json);\n                            break;\n                        }\n\n                        // Many BSPs mirror Meta‚Äôs shape; also accept { data: [...] }\n                        dynamic parsed = JsonConvert.DeserializeObject(json);\n                        templates.AddRange(ParseTemplatesFromMetaLikePayload(parsed));\n                        nextUrl = parsed?.paging?.next?.ToString();\n                        if (nextUrl == null) break; // if their API doesn‚Äôt paginate\n                    }\n\n                    return templates;\n                }\n\n                // ==================== UNKNOWN ====================\n                _logger.LogInformation(\"Provider {Provider} does not support listing via API in this build.\", provider);\n                return templates;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Exception while fetching WhatsApp templates for provider {Provider}.\", provider);\n                return templates;\n            }\n        }\n\n        private static IEnumerable<TemplateMetadataDto> ParseTemplatesFromMetaLikePayload(dynamic parsed)\n        {\n            var list = new List<TemplateMetadataDto>();\n            if (parsed == null) return list;\n\n            // Prefer parsed.data; fall back to parsed.templates\n            var collection = parsed.data ?? parsed.templates;\n            if (collection == null) return list;\n\n            foreach (var tpl in collection)\n            {\n                string name = tpl.name?.ToString() ?? \"\";\n                string language = tpl.language?.ToString() ?? \"en_US\";\n                string body = \"\";\n                bool hasImageHeader = false;\n                var buttons = new List<ButtonMetadataDto>();\n\n                // components may be null for some BSPs\n                var components = tpl.components;\n                if (components != null)\n                {\n                    foreach (var component in components)\n                    {\n                        string type = component.type?.ToString()?.ToUpperInvariant();\n\n                        if (type == \"BODY\")\n                            body = component.text?.ToString() ?? \"\";\n\n                        if (type == \"HEADER\" && (component.format?.ToString()?.ToUpperInvariant() == \"IMAGE\"))\n                            hasImageHeader = true;\n\n                        if (type == \"BUTTONS\" && component.buttons != null)\n                        {\n                            foreach (var button in component.buttons)\n                            {\n                                try\n                                {\n                                    string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n                                    string text = button.text?.ToString() ?? \"\";\n                                    int index = buttons.Count;\n\n                                    string subType = btnType switch\n                                    {\n                                        \"URL\" => \"url\",\n                                        \"PHONE_NUMBER\" => \"voice_call\",\n                                        \"QUICK_REPLY\" => \"quick_reply\",\n                                        \"COPY_CODE\" => \"copy_code\",\n                                        \"CATALOG\" => \"catalog\",\n                                        \"FLOW\" => \"flow\",\n                                        \"REMINDER\" => \"reminder\",\n                                        \"ORDER_DETAILS\" => \"order_details\",\n                                        _ => \"unknown\"\n                                    };\n\n                                    string? paramValue =\n                                        button.url != null ? button.url.ToString() :\n                                        button.phone_number != null ? button.phone_number.ToString() :\n                                        button.coupon_code != null ? button.coupon_code.ToString() :\n                                        button.flow_id != null ? button.flow_id.ToString() :\n                                        null;\n\n                                    // If BSP marks dynamic examples like Meta, respect them; otherwise be lenient\n                                    buttons.Add(new ButtonMetadataDto\n                                    {\n                                        Text = text,\n                                        Type = btnType,\n                                        SubType = subType,\n                                        Index = index,\n                                        ParameterValue = paramValue ?? \"\"\n                                    });\n                                }\n                                catch { /* ignore per-button parsing issues */ }\n                            }\n                        }\n                    }\n                }\n\n                int placeholderCount = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n\n                list.Add(new TemplateMetadataDto\n                {\n                    Name = name,\n                    Language = language,\n                    Body = body,\n                    PlaceholderCount = placeholderCount,\n                    HasImageHeader = hasImageHeader,\n                    ButtonParams = buttons\n                });\n            }\n\n            return list;\n        }\n\n        public async Task<List<TemplateForUIResponseDto>> FetchAllTemplatesAsync()\n        {\n            var result = new List<TemplateForUIResponseDto>();\n\n            var user = _httpContextAccessor.HttpContext.User;\n            var businessId = user.GetBusinessId();\n            _logger.LogInformation(\"üîé Fetching templates for BusinessId {BusinessId}\", businessId);\n\n            var setting = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .FirstOrDefaultAsync(s => s.IsActive && s.BusinessId == businessId);\n\n            if (setting == null)\n            {\n                _logger.LogWarning(\"‚ö†Ô∏è No active WhatsApp setting for BusinessId {BusinessId}\", businessId);\n                return result;\n            }\n\n            try\n            {\n                // Canonical provider\n                var provider = (setting.Provider ?? string.Empty)\n                    .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n\n                // Normalize base URL once\n                var baseRaw = (setting.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n\n                if (provider == \"META_CLOUD\")\n                {\n                    // Meta requires ApiKey + WABA\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey) || string.IsNullOrWhiteSpace(setting.WabaId))\n                    {\n                        _logger.LogWarning(\"‚ö†Ô∏è Missing ApiKey or WabaId for Meta Cloud (Biz {BusinessId})\", businessId);\n                        return result;\n                    }\n\n                    var baseUrl = string.IsNullOrWhiteSpace(baseRaw) ? \"https://graph.facebook.com/v22.0\" : baseRaw;\n                    var nextUrl = $\"{baseUrl}/{setting.WabaId!.Trim()}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        using var req = new HttpRequestMessage(HttpMethod.Get, nextUrl);\n                        req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n\n                        using var res = await _httpClient.SendAsync(req);\n                        var json = await res.Content.ReadAsStringAsync();\n\n                        _logger.LogInformation(\"üì¶ Meta Template API (Biz {BusinessId}) payload:\\n{Json}\", businessId, json);\n\n                        if (!res.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"‚ùå Meta template fetch failed (Biz {BusinessId}): {Json}\", businessId, json);\n                            break;\n                        }\n\n                        result.AddRange(ParseMetaTemplates(json));\n                        nextUrl = JsonConvert.DeserializeObject<dynamic>(json)?.paging?.next?.ToString();\n                    }\n                }\n                else if (provider == \"PINNACLE\")\n                {\n                    // Pinnacle requires ApiKey and pathId (WABA or default PhoneNumberId)\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                    {\n                        _logger.LogWarning(\"‚ö†Ô∏è Missing ApiKey for Pinnacle (Biz {BusinessId})\", businessId);\n                        return result;\n                    }\n\n                    // Prefer WABA; otherwise pull DEFAULT phoneNumberId from WhatsAppPhoneNumbers\n                    string? pathId = !string.IsNullOrWhiteSpace(setting.WabaId)\n                        ? setting.WabaId!.Trim()\n                        : await _dbContext.WhatsAppPhoneNumbers\n                            .AsNoTracking()\n                            .Where(p => p.BusinessId == businessId\n                                        && p.IsActive\n                                        && p.Provider.ToUpper() == \"PINNACLE\")\n                            .OrderByDescending(p => p.IsDefault)\n                            .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                            .Select(p => p.PhoneNumberId)\n                            .FirstOrDefaultAsync();\n\n                    if (string.IsNullOrWhiteSpace(pathId))\n                    {\n                        _logger.LogWarning(\"‚ö†Ô∏è Missing WabaId or default PhoneNumberId for Pinnacle (Biz {BusinessId})\", businessId);\n                        return result;\n                    }\n\n                    var baseUrl = string.IsNullOrWhiteSpace(baseRaw) ? \"https://partnersv1.pinbot.ai\" : baseRaw;\n                    if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase)) baseUrl += \"/v3\";\n\n                    var nextUrl = $\"{baseUrl}/{pathId}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        using var req = new HttpRequestMessage(HttpMethod.Get, nextUrl);\n                        // Common header names Pinnacle accepts\n                        req.Headers.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n                        req.Headers.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n\n                        using var res = await _httpClient.SendAsync(req);\n                        var json = await res.Content.ReadAsStringAsync();\n\n                        _logger.LogInformation(\"üì¶ Pinnacle Template API (Biz {BusinessId}) payload:\\n{Json}\", businessId, json);\n\n                        if (!res.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"‚ùå Pinnacle template fetch failed (Biz {BusinessId}): {Json}\", businessId, json);\n                            break;\n                        }\n\n                        // Your existing mapper handles Pinnacle/Meta-like shapes\n                        result.AddRange(ParsePinnacleTemplates(json));\n\n                        // If their API paginates like Meta, follow it; otherwise we‚Äôre done\n                        nextUrl = JsonConvert.DeserializeObject<dynamic>(json)?.paging?.next?.ToString();\n                        if (nextUrl == null) break;\n                    }\n                }\n                else\n                {\n                    _logger.LogWarning(\"‚ö†Ô∏è Unknown provider '{Provider}' for Biz {BusinessId}\", provider, businessId);\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"‚ùå Exception while fetching templates for BusinessId {BusinessId}\", businessId);\n            }\n\n            return result;\n        }\n\n        private List<TemplateForUIResponseDto> ParseMetaTemplates(string json)\n        {\n            var list = new List<TemplateForUIResponseDto>();\n            dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n\n            foreach (var tpl in parsed.data)\n            {\n                string status = (tpl.status?.ToString() ?? \"\").ToUpperInvariant();\n                if (status != \"APPROVED\" && status != \"ACTIVE\") continue;\n\n                list.Add(BuildTemplateDtoFromComponents(tpl));\n            }\n\n            return list;\n        }\n\n        private List<TemplateForUIResponseDto> ParsePinnacleTemplates(string json)\n        {\n            var list = new List<TemplateForUIResponseDto>();\n            dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n\n            if (parsed?.data == null) return list;\n\n            foreach (var tpl in parsed.data)\n            {\n                // Pinnacle may not use status like Meta, adjust filter if needed\n                list.Add(BuildTemplateDtoFromComponents(tpl));\n            }\n\n            return list;\n        }\n\n        private TemplateForUIResponseDto BuildTemplateDtoFromComponents(dynamic tpl)\n        {\n            string name = tpl.name;\n            string language = tpl.language ?? \"en_US\";\n            string body = \"\";\n            bool hasImageHeader = false;\n            var buttons = new List<ButtonMetadataDto>();\n\n            foreach (var component in tpl.components)\n            {\n                string type = component.type?.ToString()?.ToUpperInvariant();\n\n                if (type == \"BODY\")\n                    body = component.text?.ToString() ?? \"\";\n\n                if (type == \"HEADER\" && (component.format?.ToString()?.ToUpperInvariant() == \"IMAGE\"))\n                    hasImageHeader = true;\n\n                if (type == \"BUTTONS\")\n                {\n                    foreach (var button in component.buttons)\n                    {\n                        string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n                        string text = button.text?.ToString() ?? \"\";\n                        int index = buttons.Count;\n\n                        string subType = btnType switch\n                        {\n                            \"URL\" => \"url\",\n                            \"PHONE_NUMBER\" => \"voice_call\",\n                            \"QUICK_REPLY\" => \"quick_reply\",\n                            \"COPY_CODE\" => \"copy_code\",\n                            \"CATALOG\" => \"catalog\",\n                            \"FLOW\" => \"flow\",\n                            \"REMINDER\" => \"reminder\",\n                            \"ORDER_DETAILS\" => \"order_details\",\n                            _ => \"unknown\"\n                        };\n\n                        string? paramValue = button.url?.ToString() ?? button.phone_number?.ToString();\n\n                        if (subType == \"unknown\") continue;\n\n                        buttons.Add(new ButtonMetadataDto\n                        {\n                            Text = text,\n                            Type = btnType,\n                            SubType = subType,\n                            Index = index,\n                            ParameterValue = paramValue ?? \"\"\n                        });\n                    }\n                }\n            }\n\n            int placeholderCount = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n\n            return new TemplateForUIResponseDto\n            {\n                Name = name,\n                Language = language,\n                Body = body,\n                ParametersCount = placeholderCount,\n                HasImageHeader = hasImageHeader,\n                ButtonParams = buttons\n            };\n        }\n\n        //public async Task<TemplateMetadataDto?> GetTemplateByNameAsync(Guid businessId, string templateName, bool includeButtons)\n        //{\n        //    var setting = await _dbContext.WhatsAppSettings\n        //        .FirstOrDefaultAsync(x => x.IsActive && x.BusinessId == businessId);\n\n        //    if (setting == null)\n        //    {\n        //        _logger.LogWarning(\"‚ùå WhatsApp settings not found for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    var provider = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n        //    var wabaId = setting.WabaId?.Trim();\n        //    if (string.IsNullOrWhiteSpace(wabaId))\n        //    {\n        //        _logger.LogWarning(\"‚ùå Missing WABA ID for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    // Build URL + request with per-request headers\n        //    string url;\n        //    using var req = new HttpRequestMessage(HttpMethod.Get, \"\");\n\n        //    if (provider == \"pinnacle\")\n        //    {\n        //        // Pinnacle: require ApiKey; use WabaId for template listing\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"‚ùå ApiKey missing for Pinnacle provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://partnersv1.pinbot.ai/v3\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        // add header variants\n        //        req.Headers.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n        //        req.Headers.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n        //        // safety: also append as query (some edges require it)\n        //        url = url.Contains(\"apikey=\") ? url : $\"{url}&apikey={Uri.EscapeDataString(setting.ApiKey)}\";\n        //    }\n        //    else // meta_cloud\n        //    {\n        //        // Meta Cloud: require ApiKey; use WabaId for template listing\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"‚ùå ApiKey missing for Meta provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://graph.facebook.com/v22.0\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n        //    }\n\n        //    req.RequestUri = new Uri(url);\n        //    var response = await _httpClient.SendAsync(req);\n        //    var json = await response.Content.ReadAsStringAsync();\n\n        //    if (!response.IsSuccessStatusCode)\n        //    {\n        //        _logger.LogError(\"‚ùå Failed to fetch templates (provider={Provider}) for BusinessId {BusinessId}: HTTP {Status} Body: {Body}\",\n        //            provider, businessId, (int)response.StatusCode, json);\n        //        return null;\n        //    }\n\n        //    try\n        //    {\n        //        dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n        //        var data = parsed?.data;\n        //        if (data == null)\n        //        {\n        //            _logger.LogWarning(\"‚ö†Ô∏è No 'data' array in template response (provider={Provider})\", provider);\n        //            return null;\n        //        }\n\n        //        foreach (var tpl in data)\n        //        {\n        //            string name = tpl.name;\n        //            if (!name.Equals(templateName, StringComparison.OrdinalIgnoreCase))\n        //                continue;\n\n        //            string language = tpl.language != null ? (string)tpl.language : \"en_US\";\n        //            string body = \"\";\n        //            var buttons = new List<ButtonMetadataDto>();\n        //            bool hasImageHeader = false;\n\n        //            // components loop\n        //            foreach (var component in tpl.components)\n        //            {\n        //                string type = component.type?.ToString()?.ToUpperInvariant();\n\n        //                if (type == \"BODY\")\n        //                {\n        //                    try { body = component.text?.ToString() ?? \"\"; }\n        //                    catch { body = \"\"; }\n        //                }\n\n        //                if (type == \"HEADER\")\n        //                {\n        //                    string format = component.format?.ToString()?.ToUpperInvariant();\n        //                    if (format == \"IMAGE\") hasImageHeader = true;\n        //                }\n\n        //                if (includeButtons && type == \"BUTTONS\")\n        //                {\n        //                    foreach (var button in component.buttons)\n        //                    {\n        //                        try\n        //                        {\n        //                            string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n        //                            string text = button.text?.ToString() ?? \"\";\n        //                            int index = buttons.Count;\n\n        //                            // normalize sub-type for our app\n        //                            string subType = btnType switch\n        //                            {\n        //                                \"URL\" => \"url\",\n        //                                \"PHONE_NUMBER\" => \"voice_call\",\n        //                                \"QUICK_REPLY\" => \"quick_reply\",\n        //                                \"COPY_CODE\" => \"copy_code\",\n        //                                \"CATALOG\" => \"catalog\",\n        //                                \"FLOW\" => \"flow\",\n        //                                \"REMINDER\" => \"reminder\",\n        //                                \"ORDER_DETAILS\" => \"order_details\",\n        //                                _ => \"unknown\"\n        //                            };\n\n        //                            // Known dynamic param extraction\n        //                            string? paramValue = null;\n        //                            if (button.url != null)\n        //                                paramValue = button.url.ToString();\n        //                            else if (button.phone_number != null)\n        //                                paramValue = button.phone_number.ToString();\n        //                            else if (button.coupon_code != null)\n        //                                paramValue = button.coupon_code.ToString();\n        //                            else if (button.flow_id != null)\n        //                                paramValue = button.flow_id.ToString();\n\n        //                            // Skip truly invalid\n        //                            if (subType == \"unknown\" ||\n        //                                (paramValue == null && new[] { \"url\", \"flow\", \"copy_code\" }.Contains(subType)))\n        //                            {\n        //                                _logger.LogWarning(\"‚ö†Ô∏è Skipping button '{Text}' due to unknown type or missing required param.\", text);\n        //                                continue;\n        //                            }\n\n        //                            buttons.Add(new ButtonMetadataDto\n        //                            {\n        //                                Text = text,\n        //                                Type = btnType,\n        //                                SubType = subType,\n        //                                Index = index,\n        //                                ParameterValue = paramValue ?? \"\" // empty for static buttons\n        //                            });\n        //                        }\n        //                        catch (Exception exBtn)\n        //                        {\n        //                            _logger.LogWarning(exBtn, \"‚ö†Ô∏è Failed to parse button in template {TemplateName}\", name);\n        //                        }\n        //                    }\n        //                }\n        //            }\n\n        //            // Count {{n}} placeholders in body\n        //            int paramCount = Regex.Matches(body ?? \"\", \"{{\\\\s*\\\\d+\\\\s*}}\").Count;\n\n        //            return new TemplateMetadataDto\n        //            {\n        //                Name = name,\n        //                Language = language,\n        //                Body = body,\n        //                PlaceholderCount = paramCount,\n        //                HasImageHeader = hasImageHeader,\n        //                ButtonParams = includeButtons ? buttons : new List<ButtonMetadataDto>()\n        //            };\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"‚ùå Exception while parsing template response\");\n        //    }\n\n        //    return null;\n        //}\n        //public async Task<TemplateMetadataDto?> GetTemplateByNameAsync(Guid businessId, string templateName, bool includeButtons)\n        //{\n        //    var setting = await _dbContext.WhatsAppSettings\n        //        .FirstOrDefaultAsync(x => x.IsActive && x.BusinessId == businessId);\n\n        //    if (setting == null)\n        //    {\n        //        _logger.LogWarning(\"‚ùå WhatsApp settings not found for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    var provider = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n        //    var wabaId = setting.WabaId?.Trim();\n        //    if (string.IsNullOrWhiteSpace(wabaId))\n        //    {\n        //        _logger.LogWarning(\"‚ùå Missing WABA ID for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    // Build URL + request with per-request headers\n        //    string url;\n        //    using var req = new HttpRequestMessage(HttpMethod.Get, \"\");\n\n        //    if (provider == \"pinnacle\")\n        //    {\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"‚ùå ApiKey missing for Pinnacle provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://partnersv1.pinbot.ai/v3\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        req.Headers.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n        //        req.Headers.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n        //        url = url.Contains(\"apikey=\") ? url : $\"{url}&apikey={Uri.EscapeDataString(setting.ApiKey)}\";\n        //    }\n        //    else // meta_cloud\n        //    {\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"‚ùå ApiKey missing for Meta provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://graph.facebook.com/v22.0\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n        //    }\n\n        //    req.RequestUri = new Uri(url);\n        //    var response = await _httpClient.SendAsync(req);\n        //    var json = await response.Content.ReadAsStringAsync();\n\n        //    if (!response.IsSuccessStatusCode)\n        //    {\n        //        _logger.LogError(\"‚ùå Failed to fetch templates (provider={Provider}) for BusinessId {BusinessId}: HTTP {Status} Body: {Body}\",\n        //            provider, businessId, (int)response.StatusCode, json);\n        //        return null;\n        //    }\n\n        //    try\n        //    {\n        //        dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n        //        var data = parsed?.data;\n        //        if (data == null)\n        //        {\n        //            _logger.LogWarning(\"‚ö†Ô∏è No 'data' array in template response (provider={Provider})\", provider);\n        //            return null;\n        //        }\n\n        //        foreach (var tpl in data)\n        //        {\n        //            string name = tpl.name;\n        //            if (!name.Equals(templateName, StringComparison.OrdinalIgnoreCase))\n        //                continue;\n\n        //            string language = tpl.language != null ? (string)tpl.language : \"en_US\";\n\n        //            // ---- CHANGES START ----\n        //            string body = \"\";\n        //            string headerText = \"\";                    // collect TEXT header\n        //            bool hasImageHeader = false;\n        //            var buttons = new List<ButtonMetadataDto>();\n\n        //            foreach (var component in tpl.components)\n        //            {\n        //                string type = component.type?.ToString()?.ToUpperInvariant();\n\n        //                if (type == \"HEADER\")\n        //                {\n        //                    string format = component.format?.ToString()?.ToUpperInvariant();\n        //                    if (format == \"IMAGE\")\n        //                        hasImageHeader = true;\n\n        //                    // capture header text (can include {{n}})\n        //                    if (format == \"TEXT\")\n        //                    {\n        //                        try { headerText = component.text?.ToString() ?? \"\"; }\n        //                        catch { headerText = \"\"; }\n        //                    }\n        //                }\n\n        //                if (type == \"BODY\")\n        //                {\n        //                    try { body = component.text?.ToString() ?? \"\"; }\n        //                    catch { body = \"\"; }\n        //                }\n\n        //                if (includeButtons && type == \"BUTTONS\")\n        //                {\n        //                    foreach (var button in component.buttons)\n        //                    {\n        //                        try\n        //                        {\n        //                            string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n        //                            string text = button.text?.ToString() ?? \"\";\n        //                            int index = buttons.Count;\n\n        //                            string subType = btnType switch\n        //                            {\n        //                                \"URL\" => \"url\",\n        //                                \"PHONE_NUMBER\" => \"voice_call\",\n        //                                \"QUICK_REPLY\" => \"quick_reply\",\n        //                                \"COPY_CODE\" => \"copy_code\",\n        //                                \"CATALOG\" => \"catalog\",\n        //                                \"FLOW\" => \"flow\",\n        //                                \"REMINDER\" => \"reminder\",\n        //                                \"ORDER_DETAILS\" => \"order_details\",\n        //                                _ => \"unknown\"\n        //                            };\n\n        //                            string? paramValue = null;\n        //                            if (button.url != null) paramValue = button.url.ToString();\n        //                            else if (button.phone_number != null) paramValue = button.phone_number.ToString();\n        //                            else if (button.coupon_code != null) paramValue = button.coupon_code.ToString();\n        //                            else if (button.flow_id != null) paramValue = button.flow_id.ToString();\n\n        //                            if (subType == \"unknown\" ||\n        //                                (paramValue == null && new[] { \"url\", \"flow\", \"copy_code\" }.Contains(subType)))\n        //                            {\n        //                                _logger.LogWarning(\"‚ö†Ô∏è Skipping button '{Text}' due to unknown type or missing required param.\", text);\n        //                                continue;\n        //                            }\n\n        //                            buttons.Add(new ButtonMetadataDto\n        //                            {\n        //                                Text = text,\n        //                                Type = btnType,\n        //                                SubType = subType,\n        //                                Index = index,\n        //                                ParameterValue = paramValue ?? \"\"\n        //                            });\n        //                        }\n        //                        catch (Exception exBtn)\n        //                        {\n        //                            _logger.LogWarning(exBtn, \"‚ö†Ô∏è Failed to parse button in template {TemplateName}\", name);\n        //                        }\n        //                    }\n        //                }\n        //            }\n\n        //            // Combine header + body so your DB stores what users actually see\n        //            var combined = string.IsNullOrWhiteSpace(headerText)\n        //                ? body\n        //                : (string.IsNullOrWhiteSpace(body) ? headerText : $\"{headerText}\\n{body}\");\n\n        //            // Count {{n}} across header+body\n        //            int paramCount = Regex.Matches(combined ?? \"\", \"{{\\\\s*\\\\d+\\\\s*}}\").Count;\n        //            // ---- CHANGES END ----\n\n        //            return new TemplateMetadataDto\n        //            {\n        //                Name = name,\n        //                Language = language,\n        //                Body = combined,                         // return combined text\n        //                PlaceholderCount = paramCount,\n        //                HasImageHeader = hasImageHeader,\n        //                ButtonParams = includeButtons ? buttons : new List<ButtonMetadataDto>()\n        //            };\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"‚ùå Exception while parsing template response\");\n        //    }\n\n        //    return null;\n        //}\n        // Features/CampaignModule/Services/TemplateFetcherService.cs\n\n\n\n        public async Task<TemplateMetadataDto?> GetTemplateByNameAsync(\n            Guid businessId,\n            string templateName,\n            bool includeButtons)\n        {\n            var row = await _dbContext.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.IsActive && t.Name == templateName)\n                .OrderByDescending(t => t.UpdatedAt) // or LastSyncedAt if you prefer\n                .FirstOrDefaultAsync();\n\n            if (row == null) return null;\n\n            string headerKind = \"none\";\n            string combinedBody = row.Body ?? string.Empty;\n            int placeholderCount = 0;\n\n            if (!string.IsNullOrWhiteSpace(row.RawJson))\n            {\n                // Use canonical computation from provider JSON (handles header/body/buttons & NAMED/POSITIONAL)\n                var s = TemplateJsonHelper.Summarize(row.RawJson, row.Body);\n                headerKind = s.HeaderKind ?? \"none\";\n                combinedBody = s.CombinedBody ?? string.Empty;\n                placeholderCount = s.PlaceholderCount;\n            }\n            else\n            {\n                // No RawJson: fall back to counting tokens in body and buttons JSON\n                placeholderCount =\n                    CountTokensFlexible(combinedBody) +\n                    CountButtonTokensFromButtonsJson(row.UrlButtons);\n            }\n\n            var buttons = includeButtons ? ParseButtons(row.UrlButtons) : new List<ButtonMetadataDto>();\n\n            return new TemplateMetadataDto\n            {\n                Name = row.Name,\n                Language = row.LanguageCode ?? \"en_US\",\n                Body = combinedBody,\n                PlaceholderCount = placeholderCount,\n                HeaderKind = headerKind,\n                HasImageHeader = string.Equals(headerKind, \"image\", StringComparison.OrdinalIgnoreCase), // back-compat\n                ButtonParams = buttons\n            };\n        }\n\n        // -------- helpers (keep inside the same class) --------\n\n        private static readonly Regex PositionalToken =\n            new(@\"\\{\\{\\s*\\d+\\s*\\}\\}\", RegexOptions.Compiled); // {{1}}, {{ 2 }}, etc.\n\n        private static readonly Regex NamedToken =\n            new(@\"\\{\\{\\s*\\}\\}\", RegexOptions.Compiled);        // {{}} (NAMED format slot)\n\n        private static int CountTokensFlexible(string? text)\n        {\n            if (string.IsNullOrEmpty(text)) return 0;\n            return PositionalToken.Matches(text).Count + NamedToken.Matches(text).Count;\n        }\n\n        private static int CountButtonTokensFromButtonsJson(string? buttonsJson)\n        {\n            if (string.IsNullOrWhiteSpace(buttonsJson)) return 0;\n\n            try\n            {\n                var arr = JArray.Parse(buttonsJson);\n                int total = 0;\n                foreach (var b in arr)\n                {\n                    // Your ButtonsJson comes from ButtonMetadataDto serialization and includes \"ParameterValue\"\n                    var val = b?[\"ParameterValue\"]?.ToString();\n                    total += CountTokensFlexible(val);\n                }\n                return total;\n            }\n            catch\n            {\n                // If ButtonsJson is malformed, don't block reads‚Äîjust report 0 extras.\n                return 0;\n            }\n        }\n\n\n\n\n        private static string DetectHeaderKind(string? rawJson)\n        {\n            try\n            {\n                var comps = (JToken.Parse(rawJson ?? \"{}\")[\"components\"] as JArray) ?? new JArray();\n                var header = comps.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"HEADER\", StringComparison.OrdinalIgnoreCase));\n                var fmt = ((string?)header?[\"format\"] ?? \"\").ToLowerInvariant(); // \"\", \"text\", \"image\", \"video\", \"document\", \"location\"\n                return string.IsNullOrWhiteSpace(fmt) ? \"none\" : fmt;\n            }\n            catch { return \"none\"; }\n        }\n\n        private static string CombineTextHeaderAndBody(string? rawJson, string? fallbackBody)\n        {\n            var headerText = ExtractTextHeader(rawJson);\n            var bodyText = ExtractBodyText(rawJson);\n            if (string.IsNullOrWhiteSpace(bodyText)) bodyText = fallbackBody ?? \"\";\n            if (!string.IsNullOrWhiteSpace(headerText))\n                return headerText.TrimEnd() + \"\\n\" + (bodyText ?? \"\");\n            return bodyText ?? \"\";\n        }\n\n        private static string ExtractTextHeader(string? rawJson)\n        {\n            try\n            {\n                var comps = (JToken.Parse(rawJson ?? \"{}\")[\"components\"] as JArray) ?? new JArray();\n                var header = comps.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"HEADER\", StringComparison.OrdinalIgnoreCase));\n                if (header == null) return \"\";\n                if (!string.Equals((string?)header[\"format\"], \"TEXT\", StringComparison.OrdinalIgnoreCase)) return \"\";\n                return header[\"text\"]?.ToString() ?? \"\";\n            }\n            catch { return \"\"; }\n        }\n\n        private static string ExtractBodyText(string? rawJson)\n        {\n            try\n            {\n                var comps = (JToken.Parse(rawJson ?? \"{}\")[\"components\"] as JArray) ?? new JArray();\n                var body = comps.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"BODY\", StringComparison.OrdinalIgnoreCase));\n                return body?[\"text\"]?.ToString() ?? \"\";\n            }\n            catch { return \"\"; }\n        }\n\n        private static List<ButtonMetadataDto> ParseButtons(string? buttonsJson)\n        {\n            try\n            {\n                var arr = JArray.Parse(string.IsNullOrWhiteSpace(buttonsJson) ? \"[]\" : buttonsJson);\n                return arr.Select(j => new ButtonMetadataDto\n                {\n                    Text = (string?)j[\"Text\"] ?? \"\",\n                    Type = (string?)j[\"Type\"] ?? \"URL\",\n                    SubType = ((string?)j[\"SubType\"] ?? \"url\").ToLowerInvariant(),\n                    Index = (int?)j[\"Index\"] ?? 0,\n                    ParameterValue = (string?)j[\"ParameterValue\"] ?? \"\"\n                }).ToList();\n            }\n            catch { return new List<ButtonMetadataDto>(); }\n        }\n\n\n        private static TemplateMetadataDto? ExtractTemplateFromListJson(string json, string templateName, bool includeButtons)\n        {\n            var root = JObject.Parse(json);\n            var data = root[\"data\"] as JArray;\n            if (data == null) return null;\n\n            foreach (var tplToken in data.OfType<JObject>())\n            {\n                var name = tplToken.Value<string>(\"name\") ?? \"\";\n                if (!name.Equals(templateName, StringComparison.OrdinalIgnoreCase))\n                    continue;\n\n                var language = tplToken.Value<string>(\"language\") ?? \"en_US\";\n                var components = tplToken[\"components\"] as JArray;\n\n                string body = \"\";\n                bool hasImageHeader = false;\n                var buttons = new List<ButtonMetadataDto>();\n\n                if (components != null)\n                {\n                    foreach (var comp in components.OfType<JObject>())\n                    {\n                        var type = (comp.Value<string>(\"type\") ?? \"\").ToUpperInvariant();\n\n                        if (type == \"BODY\")\n                        {\n                            body = comp.Value<string>(\"text\") ?? body;\n                        }\n                        else if (type == \"HEADER\")\n                        {\n                            var fmt = (comp.Value<string>(\"format\") ?? \"\").ToUpperInvariant();\n                            if (fmt == \"IMAGE\") hasImageHeader = true;\n                        }\n                        else if (includeButtons && type == \"BUTTONS\")\n                        {\n                            var btns = comp[\"buttons\"] as JArray;\n                            if (btns == null) continue;\n\n                            var idx = 0;\n                            foreach (var b in btns.OfType<JObject>())\n                            {\n                                var btnTypeRaw = (b.Value<string>(\"type\") ?? \"\").ToUpperInvariant();\n                                var text = b.Value<string>(\"text\") ?? \"\";\n\n                                var subType = btnTypeRaw switch\n                                {\n                                    \"URL\" => \"url\",\n                                    \"PHONE_NUMBER\" => \"voice_call\",\n                                    \"QUICK_REPLY\" => \"quick_reply\",\n                                    \"COPY_CODE\" => \"copy_code\",\n                                    \"CATALOG\" => \"catalog\",\n                                    \"FLOW\" => \"flow\",\n                                    \"REMINDER\" => \"reminder\",\n                                    \"ORDER_DETAILS\" => \"order_details\",\n                                    _ => \"unknown\"\n                                };\n\n                                string? paramValue =\n                                    b.Value<string>(\"url\") ??\n                                    b.Value<string>(\"phone_number\") ??\n                                    b.Value<string>(\"coupon_code\") ??\n                                    b.Value<string>(\"flow_id\");\n\n                                // Skip unknown or missing required dynamic values\n                                if (subType == \"unknown\") continue;\n                                if ((subType is \"url\" or \"flow\" or \"copy_code\") && string.IsNullOrWhiteSpace(paramValue))\n                                    continue;\n\n                                buttons.Add(new ButtonMetadataDto\n                                {\n                                    Text = text,\n                                    Type = btnTypeRaw,\n                                    SubType = subType,\n                                    Index = idx++,\n                                    ParameterValue = paramValue ?? \"\"\n                                });\n                            }\n                        }\n                    }\n                }\n\n                var paramCount = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n\n                return new TemplateMetadataDto\n                {\n                    Name = name,\n                    Language = language,\n                    Body = body ?? \"\",\n                    PlaceholderCount = paramCount,\n                    HasImageHeader = hasImageHeader,\n                    ButtonParams = includeButtons ? buttons : new List<ButtonMetadataDto>()\n                };\n            }\n\n            return null;\n        }\n\n        // --- NEW: DB-backed meta projection methods ---\n        // List all template meta for a business (optionally filter by provider)\n        public async Task<IReadOnlyList<TemplateMetaDto>> GetTemplatesMetaAsync(Guid businessId, string? provider = null)\n        {\n            var q = _dbContext.WhatsAppTemplates\n                              .AsNoTracking()\n                              .Where(t => t.BusinessId == businessId && t.IsActive);\n\n            if (!string.IsNullOrWhiteSpace(provider))\n                q = q.Where(t => t.Provider == provider);\n\n            // Pull only what we need, then map (keeps allocations low on hot paths)\n            var rows = await q.ToListAsync();\n            var result = new List<TemplateMetaDto>(rows.Count);\n            foreach (var row in rows)\n                result.Add(MapRowToMeta(row));\n            return result;\n        }\n\n        // Get a single template meta by name (+ optional language/provider)\n        public async Task<TemplateMetaDto?> GetTemplateMetaAsync(\n    Guid businessId,\n    string templateName,\n    string? language = null,\n    string? provider = null)\n        {\n            if (string.IsNullOrWhiteSpace(templateName))\n                return null;\n\n            var lang = language?.Trim();\n            var prov = string.IsNullOrWhiteSpace(provider) ? null : provider!.Trim().ToUpperInvariant();\n\n            // Base: active rows for this business\n            var q = _dbContext.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.IsActive);\n\n            // First try: treat templateName as provider TemplateId (exact match)\n            var byIdQ = q.Where(t => t.TemplateId == templateName);\n            if (prov != null) byIdQ = byIdQ.Where(t => t.Provider == prov);\n            if (lang != null) byIdQ = byIdQ.Where(t => t.LanguageCode == lang);\n\n            var pick = await byIdQ\n                .OrderByDescending(t => t.UpdatedAt)\n                .ThenByDescending(t => t.LastSyncedAt)\n                .ThenByDescending(t => t.CreatedAt)\n                .FirstOrDefaultAsync();\n\n            if (pick == null)\n            {\n                // Second try: match by logical Name (+provider/lang if provided)\n                var byNameQ = q.Where(t => t.Name == templateName);\n                if (prov != null) byNameQ = byNameQ.Where(t => t.Provider == prov);\n\n                // Prefer an exact language match if provided; then fall back to newest any-language\n                if (!string.IsNullOrWhiteSpace(lang))\n                {\n                    pick = await byNameQ\n                        .OrderByDescending(t => t.LanguageCode == lang) // exact lang first\n                        .ThenByDescending(t => t.UpdatedAt)\n                        .ThenByDescending(t => t.LastSyncedAt)\n                        .ThenByDescending(t => t.CreatedAt)\n                        .FirstOrDefaultAsync();\n                }\n                else\n                {\n                    pick = await byNameQ\n                        .OrderByDescending(t => t.UpdatedAt)\n                        .ThenByDescending(t => t.LastSyncedAt)\n                        .ThenByDescending(t => t.CreatedAt)\n                        .FirstOrDefaultAsync();\n                }\n            }\n\n            return pick == null ? null : MapRowToMeta(pick);\n        }\n\n\n        // Map persisted catalog row ‚Üí TemplateMetaDto\n        //private DTO.TemplateMetaDto MapRowToMeta(dynamic row)\n        //{\n        //    var meta = new DTO.TemplateMetaDto\n        //    {\n        //        Provider = row.Provider ?? \"\",\n        //        TemplateId = row.ExternalId ?? row.TemplateId ?? \"\",\n        //        TemplateName = row.Name ?? \"\",\n        //        Language = row.Language ?? \"\",\n        //        HasHeaderMedia = row.HasImageHeader ?? false,\n        //        HeaderType = (row.HasImageHeader ?? false) ? \"IMAGE\" : \"\"\n        //    };\n\n        //    int count = 0;\n        //    try { count = Convert.ToInt32(row.PlaceholderCount ?? 0); } catch { count = 0; }\n\n        //    meta.BodyPlaceholders = Enumerable.Range(1, Math.Max(0, count))\n        //                                      .Select(i => new DTO.PlaceholderSlot { Index = i })\n        //                                      .ToList();\n\n        //    // ButtonsJson ‚Üí TemplateButtonMeta[]\n        //    meta.Buttons = new List<DTO.TemplateButtonMeta>();\n        //    try\n        //    {\n        //        string buttonsJson = row.ButtonsJson ?? \"\";\n        //        if (!string.IsNullOrWhiteSpace(buttonsJson))\n        //        {\n        //            using var doc = JsonDocument.Parse(buttonsJson);\n        //            if (doc.RootElement.ValueKind == JsonValueKind.Array)\n        //            {\n        //                int i = 0;\n        //                foreach (var el in doc.RootElement.EnumerateArray())\n        //                {\n        //                    var type = el.TryGetProperty(\"Type\", out var p1) ? p1.GetString() ?? \"\"\n        //                              : el.TryGetProperty(\"type\", out var p1b) ? p1b.GetString() ?? \"\" : \"\";\n        //                    var text = el.TryGetProperty(\"Text\", out var p2) ? p2.GetString() ?? \"\"\n        //                              : el.TryGetProperty(\"text\", out var p2b) ? p2b.GetString() ?? \"\" : \"\";\n        //                    var value = el.TryGetProperty(\"ParameterValue\", out var p3) ? p3.GetString()\n        //                              : el.TryGetProperty(\"value\", out var p3b) ? p3b.GetString() : null;\n        //                    var order = el.TryGetProperty(\"Index\", out var p4) && p4.ValueKind == JsonValueKind.Number\n        //                              ? p4.GetInt32()\n        //                              : i;\n\n        //                    meta.Buttons.Add(new DTO.TemplateButtonMeta\n        //                    {\n        //                        Type = type,\n        //                        Text = text,\n        //                        Value = value,\n        //                        Order = order\n        //                    });\n        //                    i++;\n        //                }\n        //            }\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogWarning(ex, \"Failed to parse ButtonsJson for template {TemplateName}\", (string)(row.Name ?? \"(unknown)\"));\n        //    }\n\n        //    return meta;\n        //}\n        // add near the class top (once)\n        // helpers (place near the class top)\n        private static readonly Regex _phRx = new(@\"\\{\\{\\s*(\\d+)\\s*\\}\\}\", RegexOptions.Compiled);\n\n        private static int DistinctMaxPlaceholderIndex(string? text)\n        {\n            if (string.IsNullOrWhiteSpace(text)) return 0;\n            var m = _phRx.Matches(text);\n            int max = 0;\n            var seen = new HashSet<int>();\n            foreach (Match x in m)\n            {\n                if (int.TryParse(x.Groups[1].Value, out var i) && seen.Add(i) && i > max)\n                    max = i;\n            }\n            return max;\n        }\n\n        private static bool TryGetPropCI(JsonElement obj, string name, out JsonElement value)\n        {\n            foreach (var p in obj.EnumerateObject())\n            {\n                if (string.Equals(p.Name, name, StringComparison.OrdinalIgnoreCase))\n                {\n                    value = p.Value;\n                    return true;\n                }\n            }\n            value = default;\n            return false;\n        }\n\n        // Minimal allocations; assumes DTO types live in xbytechat.api.WhatsAppSettings.DTOs\n        private static TemplateMetaDto MapRowToMeta(WhatsAppTemplate row)\n        {\n            // Provider + IDs\n            var dto = new TemplateMetaDto\n            {\n                Provider = row.Provider,                   // \"META_CLOUD\" | \"PINNACLE\"\n                TemplateId = row.TemplateId ?? \"\",\n                TemplateName = row.Name,\n                Language = row.LanguageCode,               // <- final field\n            };\n\n            // Header/media\n            var hk = (row.HeaderKind ?? \"none\").Trim().ToLowerInvariant();\n            dto.HasHeaderMedia = row.RequiresMediaHeader || hk is \"image\" or \"video\" or \"document\";\n            dto.HeaderType = hk switch\n            {\n                \"image\" => \"IMAGE\",\n                \"video\" => \"VIDEO\",\n                \"document\" => \"DOCUMENT\",\n                _ => null\n            };\n\n            // BODY placeholders: we only store counts now, so synthesize 1..BodyVarCount\n            // (TemplateMetaDto consumers only need index order for preview/validation)\n            dto.BodyPlaceholders = new List<PlaceholderSlot>(row.BodyVarCount);\n            for (int i = 1; i <= row.BodyVarCount; i++)\n                dto.BodyPlaceholders.Add(new PlaceholderSlot { Index = i });\n\n            // Buttons (up to 3): reconstruct from UrlButtons (+ quick-replies + phone)\n            // UrlButtons json shape we persisted: [{ index, parameters:[...] }, ...]\n            var buttons = new List<TemplateButtonMeta>(3);\n\n            // URL buttons first (keep template order if present)\n            if (!string.IsNullOrWhiteSpace(row.UrlButtons))\n            {\n                try\n                {\n                    var arr = Newtonsoft.Json.Linq.JArray.Parse(row.UrlButtons);\n                    foreach (var j in arr)\n                    {\n                        if (buttons.Count >= 3) break;\n                        var order = (int?)j?[\"index\"] ?? buttons.Count; // fallback order\n                        buttons.Add(new TemplateButtonMeta\n                        {\n                            Type = \"URL\",\n                            Text = \"\",     // label not stored; UI doesn‚Äôt require it for preview send\n                            Value = null,   // value may contain \"{{1}}\" at send-time\n                            Order = order\n                        });\n                    }\n                }\n                catch { /* ignore malformed json */ }\n            }\n\n            // Phone button (at most one)\n            if (buttons.Count < 3 && row.HasPhoneButton)\n            {\n                buttons.Add(new TemplateButtonMeta\n                {\n                    Type = \"PHONE_NUMBER\",\n                    Text = \"\",\n                    Value = null,\n                    Order = buttons.Count\n                });\n            }\n\n            // Quick replies (add as many as persisted, up to remaining slots)\n            var toAdd = Math.Min(row.QuickReplyCount, Math.Max(0, 3 - buttons.Count));\n            for (int i = 0; i < toAdd; i++)\n            {\n                buttons.Add(new TemplateButtonMeta\n                {\n                    Type = \"QUICK_REPLY\",\n                    Text = \"\",\n                    Value = null,\n                    Order = buttons.Count\n                });\n            }\n\n            dto.Buttons = buttons;\n            return dto;\n        }\n\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Validators/SaveWhatsAppSettingValidator.cs",
      "sha256": "c62f496266c20b4463c4b43923cd1c1a3bedc5ac2141f1ab4c946716cc5c1bf3",
      "language": "csharp",
      "size": 2715,
      "content": "// üìÑ WhatsAppSettings/Validators/SaveWhatsAppSettingValidator.cs\n#nullable enable\nusing FluentValidation;\nusing xbytechat_api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat_api.WhatsAppSettings.Validators\n{\n    public sealed class SaveWhatsAppSettingValidator : AbstractValidator<SaveWhatsAppSettingDto>\n    {\n        public SaveWhatsAppSettingValidator()\n        {\n            // Provider\n            RuleFor(x => x.Provider)\n                .NotEmpty()\n                .Must(p => IsMeta(p) || IsPinnacle(p))\n                .WithMessage(\"Provider must be PINNACLE or META_CLOUD.\");\n\n            // ApiUrl: ONLY required when active.\n            When(x => x.IsActive, () =>\n            {\n                RuleFor(x => x.ApiUrl)\n                    .NotEmpty()\n                    .WithMessage(\"ApiUrl is required when settings are active.\");\n            });\n\n            // META_CLOUD rules\n            When(x => IsMeta(x.Provider), () =>\n            {\n                RuleFor(x => x.ApiKey)\n                    .NotEmpty()\n                    .WithMessage(\"Meta access token (ApiKey) is required for Meta Cloud.\");\n\n                // No PhoneNumberId requirement here.\n                // WabaId is allowed but not mandatory (can be filled via ESU discovery/sync).\n            });\n\n            // PINNACLE rules\n            When(x => IsPinnacle(x.Provider), () =>\n            {\n                RuleFor(x => x.ApiKey)\n                    .NotEmpty()\n                    .WithMessage(\"API Key is required for Pinnacle.\");\n\n                RuleFor(x => x)\n                    .Must(d =>\n                        !string.IsNullOrWhiteSpace(d.WabaId)\n                        || !string.IsNullOrWhiteSpace(d.PhoneNumberId))\n                    .WithMessage(\"WABA ID or PhoneNumberId required for Pinnacle.\");\n            });\n        }\n\n        // ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n        private static string Canon(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return string.Empty;\n            return raw.Trim().ToUpperInvariant()\n                .Replace(\"-\", \"_\")\n                .Replace(\" \", \"_\");\n        }\n\n        private static bool IsMeta(string? raw)\n            => Canon(raw) == \"META_CLOUD\"\n               || Canon(raw) == \"META\"\n               || Canon(raw) == \"WA_CLOUD\"\n               || Canon(raw) == \"WHATSAPP_CLOUD\"\n               || Canon(raw) == \"FACEBOOK\";\n\n        private static bool IsPinnacle(string? raw)\n            => Canon(raw) == \"PINNACLE\"\n               || Canon(raw) == \"PINBOT\"\n               || Canon(raw) == \"PINNACLE_OFFICIAL\";\n    }\n}\n"
    }
  ]
}
