{
  "name": "xbytechat-api",
  "part": 25,
  "of": 25,
  "generatedAt": "2025-12-10 08:27:07 +00:00",
  "files": [
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/TemplatePreviewService.cs",
      "sha256": "bce7179ab5e46fe57fcab9220023da307250676d0f27bb999748ad11fc05179c",
      "language": "csharp",
      "size": 7248,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading.Tasks;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public sealed class TemplatePreviewService : ITemplatePreviewService\n    {\n        private readonly IWhatsAppTemplateFetcherService _fetcher;\n        private readonly ILogger<TemplatePreviewService> _log;\n\n        public TemplatePreviewService(IWhatsAppTemplateFetcherService fetcher, ILogger<TemplatePreviewService> log)\n        {\n            _fetcher = fetcher;\n            _log = log;\n        }\n\n        public async Task<TemplatePreviewResponseDto> PreviewAsync(Guid businessId, TemplatePreviewRequestDto request)\n        {\n            var resp = new TemplatePreviewResponseDto\n            {\n                TemplateName = request.TemplateName,\n                Language = request.Language\n            };\n\n            // 1) Fetch meta (from our catalog)\n            var meta = await _fetcher.GetTemplateMetaAsync(\n                businessId,\n                request.TemplateName,\n                language: request.Language,\n                provider: request.Provider\n            );\n\n            if (meta == null)\n            {\n                resp.FoundTemplate = false;\n                resp.Errors.Add(\"Template not found for this business/provider/language.\");\n                return resp;\n            }\n\n            resp.FoundTemplate = true;\n            resp.Language = meta.Language;\n            resp.HasHeaderMedia = meta.HasHeaderMedia;\n            resp.HeaderType = meta.HeaderType ?? \"\";\n\n            // 2) Placeholder validation\n            var required = Math.Max(0, meta.BodyPlaceholders?.Count ?? 0);\n            var provided = request.TemplateParameters?.Count ?? 0;\n\n            resp.RequiredPlaceholderCount = required;\n            resp.ProvidedPlaceholderCount = provided;\n\n            if (provided < required)\n            {\n                for (int i = provided + 1; i <= required; i++) resp.MissingPlaceholderIndices.Add(i);\n                resp.Errors.Add($\"Missing {required - provided} body parameter(s).\");\n            }\n            else if (provided > required)\n            {\n                resp.Warnings.Add($\"Ignored {provided - required} extra body parameter(s).\");\n            }\n\n            // 3) Build provider-like components preview\n            var comps = new List<object>();\n\n            // Header (image) preview only when template supports it and caller provided a URL\n            if (meta.HasHeaderMedia && !string.IsNullOrWhiteSpace(request.HeaderImageUrl))\n            {\n                comps.Add(new\n                {\n                    type = \"header\",\n                    parameters = new object[]\n                    {\n                        new { type = \"image\", image = new { link = request.HeaderImageUrl } }\n                    }\n                });\n            }\n\n            // Body parameters: trim/pad to 'required'\n            if (required > 0)\n            {\n                var src = (request.TemplateParameters ?? new List<string>()).Select(s => s ?? string.Empty).ToList();\n                if (src.Count > required) src = src.Take(required).ToList();\n                while (src.Count < required) src.Add(string.Empty);\n\n                var bodyParams = src.Select(p => (object)new { type = \"text\", text = p }).ToArray();\n                comps.Add(new { type = \"body\", parameters = bodyParams });\n            }\n\n            // 4) Buttons validation (only dynamic URL buttons require parameters in payload)\n            // Template order is authoritative. We'll check at most 3.\n            var inputByPos = (request.Buttons ?? new List<PreviewButtonInputDto>())\n                             .Where(b => b.Position >= 1 && b.Position <= 3)\n                             .ToDictionary(b => b.Position, b => b);\n\n            var templateButtons = (meta.Buttons ?? new List<TemplateButtonMeta>())\n                                  .OrderBy(b => b.Order)\n                                  .Take(3)\n                                  .ToList();\n\n            for (int i = 0; i < templateButtons.Count; i++)\n            {\n                var tb = templateButtons[i];\n                var subType = (tb.Type ?? tb.Text ?? \"\").ToUpperInvariant(); // tb.Type from Step 2.1 mapper; sub-type is treated as URL family\n                var paramPattern = tb.Value ?? \"\"; // came from ButtonsJson ParameterValue (may contain \"{{1}}\")\n                var isUrlFamily = (tb.Type ?? \"\").Equals(\"URL\", StringComparison.OrdinalIgnoreCase);\n                var isDynamic = isUrlFamily && paramPattern.Contains(\"{{\");\n\n                if (!isUrlFamily || !isDynamic)\n                {\n                    // For static buttons (or non-URL), we preview a button component without parameters\n                    comps.Add(new Dictionary<string, object>\n                    {\n                        [\"type\"] = \"button\",\n                        [\"sub_type\"] = \"url\",\n                        [\"index\"] = i.ToString()\n                    });\n                    continue;\n                }\n\n                // Dynamic URL → expect input at this position\n                if (!inputByPos.TryGetValue(i + 1, out var userBtn) || string.IsNullOrWhiteSpace(userBtn.Value))\n                {\n                    resp.Errors.Add($\"Dynamic URL required for button position {i + 1} but no value was provided.\");\n                    continue;\n                }\n\n                var value = userBtn.Value.Trim();\n\n                // Accept absolute http/https and tel/wa deep links in preview\n                var ok = LooksValidDestination(value);\n                if (!ok)\n                {\n                    resp.Errors.Add($\"Button {i + 1} destination must be absolute http/https or tel/wa link.\");\n                    continue;\n                }\n\n                // NOTE: In live send we tokenise tracked URLs. For preview we show the **value** directly.\n                var parameters = new[] { new Dictionary<string, object> { [\"type\"] = \"text\", [\"text\"] = value } };\n\n                comps.Add(new Dictionary<string, object>\n                {\n                    [\"type\"] = \"button\",\n                    [\"sub_type\"] = \"url\",\n                    [\"index\"] = i.ToString(),\n                    [\"parameters\"] = parameters\n                });\n            }\n\n            resp.ProviderComponentsPreview = comps;\n            return resp;\n        }\n\n        private static bool LooksValidDestination(string input)\n        {\n            if (string.IsNullOrWhiteSpace(input)) return false;\n            var s = input.Trim();\n            if (s.StartsWith(\"tel:\", StringComparison.OrdinalIgnoreCase)) return true;\n            if (s.StartsWith(\"wa:\", StringComparison.OrdinalIgnoreCase)) return true;\n            if (s.StartsWith(\"https://wa.me/\", StringComparison.OrdinalIgnoreCase)) return true;\n\n            if (Uri.TryCreate(s, UriKind.Absolute, out var uri))\n                return uri.Scheme.Equals(Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase)\n                    || uri.Scheme.Equals(Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase);\n\n            return false;\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/TemplateSyncService.cs",
      "sha256": "380b47e260fe05324abaf4250ec585d6e9bcb93c47eec90f76d817cc9b75ce02",
      "language": "csharp",
      "size": 34894,
      "content": "using Microsoft.EntityFrameworkCore;\nusing xbytechat.api;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing xbytechat.api.WhatsAppSettings.Providers;\nusing xbytechat.api.WhatsAppSettings.Abstractions;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.WhatsAppSettings.Helpers; // canonical parser\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.WhatsAppSettings.Services;\nusing System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Newtonsoft.Json;\nusing Polly.Caching;\nusing Serilog;\nusing System.Buffers;\nusing System.Text.RegularExpressions;\n\npublic sealed class TemplateSyncService : ITemplateSyncService\n{\n    private readonly AppDbContext _db;\n    private readonly MetaTemplateCatalogProvider _meta;\n    private readonly PinnacleTemplateCatalogProvider _pinnacle;\n    private readonly ILogger<TemplateSyncService> _log;\n\n    private static readonly TimeSpan TTL = TimeSpan.FromHours(12);\n\n    public TemplateSyncService(\n        AppDbContext db,\n        MetaTemplateCatalogProvider meta,\n        PinnacleTemplateCatalogProvider pinnacle,\n        ILogger<TemplateSyncService> log)\n    {\n        _db = db; _meta = meta; _pinnacle = pinnacle; _log = log;\n    }\n\n    //public async Task<TemplateSyncResult> SyncBusinessTemplatesAsync(Guid businessId, bool force = false, CancellationToken ct = default)\n    //{\n    //    var setting = await _db.WhatsAppSettings\n    //        .AsNoTracking()\n    //        .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive, ct)\n    //        ?? throw new InvalidOperationException(\"Active WhatsApp settings not found.\");\n\n    //    var now = DateTime.UtcNow;\n\n    //    if (!force)\n    //    {\n    //        var recent = await _db.WhatsAppTemplates\n    //            .AsNoTracking()\n    //            .Where(t => t.BusinessId == businessId)\n    //            .OrderByDescending(t => t.LastSyncedAt)\n    //            .Select(t => t.LastSyncedAt)\n    //            .FirstOrDefaultAsync(ct);\n\n    //        if (recent != default && now - recent < TTL)\n    //        {\n    //            _log.LogInformation(\"⏭️ Skipping sync for {BusinessId}; TTL not expired.\", businessId);\n    //            return new TemplateSyncResult(0, 0, 0, recent);\n    //        }\n    //    }\n\n    //    // Canonical provider (UPPER)\n    //    var providerKey = ((setting.Provider ?? \"META_CLOUD\").Trim()).ToUpperInvariant();\n\n    //    IReadOnlyList<TemplateCatalogItem> incoming = providerKey switch\n    //    {\n    //        \"META_CLOUD\" => await _meta.ListMetaAsync(setting, ct),\n    //        \"PINNACLE\" => await _pinnacle.ListPinnacleAsync(setting, ct),\n    //        _ => Array.Empty<TemplateCatalogItem>()\n    //    };\n    //    incoming ??= Array.Empty<TemplateCatalogItem>();\n\n    //    // Preload existing provider rows for this business\n    //    var existing = await _db.WhatsAppTemplates\n    //        .Where(t => t.BusinessId == businessId && t.Provider == providerKey)\n    //        .ToListAsync(ct);\n\n    //    // Fast lookup maps\n    //    var byTemplateId = existing\n    //        .Where(e => !string.IsNullOrWhiteSpace(e.TemplateId))\n    //        .ToDictionary(e => e.TemplateId!, e => e, StringComparer.Ordinal);\n\n    //    //static string NLKey(string name, string? lang) => $\"{name}::{(lang ?? \"\").Trim().ToLowerInvariant()}\";\n    //    static string NLKey(string? name, string? lang)\n    //=> $\"{(name ?? \"\").Trim().ToLowerInvariant()}::{(lang ?? \"\").Trim().ToLowerInvariant()}\";\n    //    var byNameLang = existing.ToDictionary(\n    //        e => NLKey(e.Name, e.LanguageCode),\n    //        e => e,\n    //        StringComparer.Ordinal);\n\n    //    int added = 0, updated = 0, unchanged = 0;\n\n    //    var seenTemplateIds = new HashSet<string>(StringComparer.Ordinal);\n    //    var seenNLKeys = new HashSet<string>(StringComparer.Ordinal);\n\n    //    // Helpers\n    //    static string NK(string? k) => string.IsNullOrWhiteSpace(k) ? \"none\" : k.Trim().ToLowerInvariant();\n    //    static bool IsIdentifier(string? s) => !string.IsNullOrWhiteSpace(s) && Regex.IsMatch(s!, @\"^[A-Za-z_][A-Za-z0-9_]*$\");\n\n    //    foreach (var it in incoming)\n    //    {\n    //        ct.ThrowIfCancellationRequested();\n\n    //        var extId = it.ExternalId?.Trim();\n    //        var lang = string.IsNullOrWhiteSpace(it.Language) ? \"en_US\" : it.Language.Trim();\n    //        var nlKey = NLKey(it.Name, lang);\n\n    //        seenNLKeys.Add(nlKey);\n    //        if (!string.IsNullOrWhiteSpace(extId)) seenTemplateIds.Add(extId!);\n\n    //        // —— Parse/summarize JSON into our canonical fields\n    //        var dto = TemplateJsonHelper.SummarizeDetailed(it.RawJson, it.Body);\n\n    //        var headerKindNorm = NK(dto.HeaderKind);\n    //        var headerTextToPersist = headerKindNorm == \"text\"\n    //            ? (string.IsNullOrWhiteSpace(dto.HeaderText) ? null : dto.HeaderText!.Trim())\n    //            : null;\n\n    //        var paramFormat = (dto.ParameterFormat ?? \"UNKNOWN\").Trim().ToUpperInvariant();\n\n    //        // Keep only real placeholders (drop \"{{}}\"). Count by location.\n    //        var occAll = (dto.Placeholders ?? new List<PlaceholderOccurrence>()).ToList();\n    //        var occFiltered = occAll.Where(o =>\n    //        {\n    //            var raw = o.Raw?.Trim();\n    //            if (string.Equals(raw, \"{{}}\", StringComparison.Ordinal)) return false;\n\n    //            if (paramFormat == \"POSITIONAL\") return o.Index is >= 1;\n    //            if (paramFormat == \"NAMED\") return IsIdentifier(o.Name);\n\n    //            return false;\n    //        }).ToList();\n\n    //        int headerVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Header);\n    //        int bodyVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Body);\n    //        int totalVars = occFiltered.Count; // header + body + buttons (filtered)\n\n    //        var combinedBody = dto.CombinedPreviewBody ?? string.Empty;\n    //        var bodyPreview = combinedBody.Length > 240 ? combinedBody[..240] : combinedBody;\n\n    //        bool requiresMediaHeader = headerKindNorm is \"image\" or \"video\" or \"document\";\n\n    //        // Named parameter keys (for NAMED format)\n    //        var namedKeys = occFiltered\n    //            .Where(p => !string.IsNullOrWhiteSpace(p.Name))\n    //            .Select(p => p.Name!.Trim())\n    //            .Where(IsIdentifier)\n    //            .Distinct(StringComparer.OrdinalIgnoreCase)\n    //            .ToArray();\n    //        string? namedKeysJson = namedKeys.Length > 0 ? JsonConvert.SerializeObject(namedKeys) : null;\n\n    //        // Placeholder map (provider-specific): keep null unless you compute elsewhere\n    //        string? placeholderMapJson = null;\n\n    //        // Buttons summary (prefer explicit from provider)\n    //        // Buttons summary (prefer explicit from provider)\n    //        string? urlButtonsJson = null;\n    //        int quickReplyCount = 0;\n    //        bool hasPhoneButton = false;\n\n    //        if (it.Buttons is { Count: > 0 })\n    //        {\n    //            // Persist only what's needed downstream: the URL button positions.\n    //            // Shape: [{ \"index\": 0 }, { \"index\": 1 }, ...]\n    //            var urlButtons = new List<object>(capacity: it.Buttons.Count);\n\n    //            foreach (var b in it.Buttons)\n    //            {\n    //                var sub = (b.SubType ?? \"\").Trim().ToLowerInvariant();\n\n    //                if (sub == \"quick_reply\") quickReplyCount++;\n    //                if (sub == \"phone_number\") hasPhoneButton = true;\n\n    //                if (sub == \"url\")\n    //                {\n    //                    urlButtons.Add(new\n    //                    {\n    //                        index = b.Index\n    //                        // no b.Parameters; not present on ButtonMetadataDto\n    //                    });\n    //                }\n    //            }\n\n    //            urlButtonsJson = urlButtons.Count > 0 ? JsonConvert.SerializeObject(urlButtons) : null;\n    //        }\n\n\n    //        var status = string.IsNullOrWhiteSpace(it.Status) ? \"APPROVED\" : it.Status!.Trim().ToUpperInvariant();\n\n    //        // —— Locate existing row (by TemplateId first, else Name+Lang)\n    //        WhatsAppTemplate? row = null;\n\n    //        if (!string.IsNullOrWhiteSpace(extId) && byTemplateId.TryGetValue(extId!, out var foundById))\n    //        {\n    //            row = foundById;\n    //        }\n    //        else if (byNameLang.TryGetValue(nlKey, out var foundByNL))\n    //        {\n    //            row = foundByNL;\n\n    //            // backfill TemplateId if we now have it\n    //            if (!string.IsNullOrWhiteSpace(extId) && string.IsNullOrWhiteSpace(row.TemplateId))\n    //            {\n    //                row.TemplateId = extId;\n    //                updated++;\n    //            }\n    //        }\n\n    //        if (row is null)\n    //        {\n    //            // INSERT\n    //            var newRow = new WhatsAppTemplate\n    //            {\n    //                Id = Guid.NewGuid(),\n    //                BusinessId = businessId,\n    //                Provider = providerKey,\n    //                TemplateId = extId,\n    //                Name = it.Name,\n    //                LanguageCode = lang,\n    //                Status = status,\n    //                Category = it.Category,\n    //                SubCategory = null,\n\n    //                RawJson = it.RawJson ?? \"{}\",\n\n    //                ParameterFormat = paramFormat,\n    //                HeaderKind = headerKindNorm,\n    //                HeaderText = headerTextToPersist,\n    //                Body = combinedBody,\n    //                BodyPreview = bodyPreview,\n\n    //                RequiresMediaHeader = requiresMediaHeader,\n\n    //                BodyVarCount = bodyVars,\n    //                HeaderTextVarCount = headerVars,\n    //                TotalTextParamCount = totalVars,\n\n    //                UrlButtons = urlButtonsJson,\n    //                QuickReplyCount = quickReplyCount,\n    //                HasPhoneButton = hasPhoneButton,\n\n    //                NamedParamKeys = namedKeysJson,\n    //                PlaceholderMap = placeholderMapJson,\n\n    //                IsActive = true,\n    //                CreatedAt = now,\n    //                UpdatedAt = now,\n    //                LastSyncedAt = now\n    //            };\n\n    //            _db.WhatsAppTemplates.Add(newRow);\n    //            added++;\n\n    //            if (!string.IsNullOrWhiteSpace(extId)) byTemplateId[extId!] = newRow;\n    //            byNameLang[nlKey] = newRow;\n    //        }\n    //        else\n    //        {\n    //            // UPDATE (branch-predicated, no ref locals)\n    //            bool changed = false;\n\n    //            if (!string.Equals(row.Status, status, StringComparison.Ordinal))\n    //            { row.Status = status; changed = true; }\n\n    //            if (!string.Equals(row.Category, it.Category, StringComparison.Ordinal))\n    //            { row.Category = it.Category; changed = true; }\n\n    //            var newRaw = it.RawJson ?? \"{}\";\n    //            if (!string.Equals(row.RawJson, newRaw, StringComparison.Ordinal))\n    //            { row.RawJson = newRaw; changed = true; }\n\n    //            if (!string.Equals(row.ParameterFormat, paramFormat, StringComparison.Ordinal))\n    //            { row.ParameterFormat = paramFormat; changed = true; }\n\n    //            if (!string.Equals(row.HeaderKind, headerKindNorm, StringComparison.Ordinal))\n    //            { row.HeaderKind = headerKindNorm; changed = true; }\n\n    //            var existingHeaderText = string.IsNullOrWhiteSpace(row.HeaderText) ? null : row.HeaderText!.Trim();\n    //            if (!string.Equals(existingHeaderText, headerTextToPersist, StringComparison.Ordinal))\n    //            { row.HeaderText = headerTextToPersist; changed = true; }\n\n    //            if (!string.Equals(row.Body ?? string.Empty, combinedBody, StringComparison.Ordinal))\n    //            { row.Body = combinedBody; changed = true; }\n\n    //            if (!string.Equals(row.BodyPreview ?? string.Empty, bodyPreview ?? string.Empty, StringComparison.Ordinal))\n    //            { row.BodyPreview = bodyPreview; changed = true; }\n\n    //            if (row.RequiresMediaHeader != requiresMediaHeader)\n    //            { row.RequiresMediaHeader = requiresMediaHeader; changed = true; }\n\n    //            if (row.BodyVarCount != bodyVars) { row.BodyVarCount = bodyVars; changed = true; }\n    //            if (row.HeaderTextVarCount != headerVars) { row.HeaderTextVarCount = headerVars; changed = true; }\n    //            if (row.TotalTextParamCount != totalVars) { row.TotalTextParamCount = totalVars; changed = true; }\n\n    //            if (!string.Equals(row.UrlButtons ?? \"\", urlButtonsJson ?? \"\", StringComparison.Ordinal))\n    //            { row.UrlButtons = urlButtonsJson; changed = true; }\n\n    //            if (row.QuickReplyCount != quickReplyCount) { row.QuickReplyCount = quickReplyCount; changed = true; }\n    //            if (row.HasPhoneButton != hasPhoneButton) { row.HasPhoneButton = hasPhoneButton; changed = true; }\n\n    //            if (!string.Equals(row.NamedParamKeys ?? \"\", namedKeysJson ?? \"\", StringComparison.Ordinal))\n    //            { row.NamedParamKeys = namedKeysJson; changed = true; }\n\n    //            if (!string.Equals(row.PlaceholderMap ?? \"\", placeholderMapJson ?? \"\", StringComparison.Ordinal))\n    //            { row.PlaceholderMap = placeholderMapJson; changed = true; }\n\n    //            row.IsActive = true;\n    //            row.LastSyncedAt = now;\n\n    //            if (changed) { row.UpdatedAt = now; updated++; } else { unchanged++; }\n    //        }\n    //    }\n\n    //    // Deactivate templates that disappeared from provider (cheap set membership)\n    //    if (incoming.Count > 0)\n    //    {\n    //        foreach (var e in existing)\n    //        {\n    //            bool stillThere =\n    //                (!string.IsNullOrWhiteSpace(e.TemplateId) && seenTemplateIds.Contains(e.TemplateId)) ||\n    //                seenNLKeys.Contains(NLKey(e.Name, e.LanguageCode));\n\n    //            if (!stillThere && e.IsActive)\n    //            {\n    //                e.IsActive = false;\n    //                e.LastSyncedAt = now;\n    //                e.UpdatedAt = now;\n    //                updated++;\n    //            }\n    //        }\n    //    }\n\n    //    await _db.SaveChangesAsync(ct);\n    //    return new TemplateSyncResult(added, updated, unchanged, now);\n    //}\n\n    // NOTE: expects fields/services available in your class:\n    // _db (AppDbContext), _log (ILogger), _meta, _pinnacle, TTL (TimeSpan)\n\n    public async Task<TemplateSyncResult> SyncBusinessTemplatesAsync(\n     Guid businessId,\n     bool force = false,\n     bool onlyUpsert = false, // NEW: when true, do not deactivate missing rows\n     CancellationToken ct = default)\n    {\n        var setting = await _db.WhatsAppSettings\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive, ct)\n            ?? throw new InvalidOperationException(\"Active WhatsApp settings not found.\");\n\n        var now = DateTime.UtcNow;\n\n        // Canonical provider key (UPPER)\n        var providerKey = ((setting.Provider ?? \"META_CLOUD\").Trim()).ToUpperInvariant();\n\n        // TTL check is provider-scoped; will be bypassed by force:true from the button\n        if (!force)\n        {\n            var recent = await _db.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.Provider.ToUpper() == providerKey)\n                .OrderByDescending(t => t.LastSyncedAt)\n                .Select(t => t.LastSyncedAt)\n                .FirstOrDefaultAsync(ct);\n\n            if (recent != default && now - recent < TTL)\n            {\n                _log.LogInformation(\"⏭️ Skipping template sync (business={BusinessId}, provider={Provider}) — TTL not expired. Last={Last}, TTL={TTLmins}m\",\n                    businessId, providerKey, recent, TTL.TotalMinutes);\n                return new TemplateSyncResult(0, 0, 0, recent);\n            }\n        }\n\n        // Fetch from provider\n        IReadOnlyList<TemplateCatalogItem> incoming = providerKey switch\n        {\n            \"META_CLOUD\" => await _meta.ListMetaAsync(setting, ct),\n            \"PINNACLE\" => await _pinnacle.ListPinnacleAsync(setting, ct),\n            _ => Array.Empty<TemplateCatalogItem>()\n        };\n        incoming ??= Array.Empty<TemplateCatalogItem>();\n\n        _log.LogInformation(\"[TplSync] Provider={Provider} fetched={Count}\", providerKey, incoming.Count);\n\n        // Load existing rows for this provider (normalize Provider case)\n        var existing = await _db.WhatsAppTemplates\n            .Where(t => t.BusinessId == businessId && t.Provider.ToUpper() == providerKey)\n            .ToListAsync(ct);\n\n        // Fast lookup maps\n        var byTemplateId = existing\n            .Where(e => !string.IsNullOrWhiteSpace(e.TemplateId))\n            .ToDictionary(e => e.TemplateId!, e => e, StringComparer.Ordinal);\n\n        static string NLKey(string? name, string? lang)\n            => $\"{(name ?? \"\").Trim().ToLowerInvariant()}::{(lang ?? \"\").Trim().ToLowerInvariant()}\";\n\n        var byNameLang = existing.ToDictionary(\n            e => NLKey(e.Name, e.LanguageCode),\n            e => e,\n            StringComparer.Ordinal);\n\n        int added = 0, updated = 0, unchanged = 0;\n\n        var seenTemplateIds = new HashSet<string>(StringComparer.Ordinal);\n        var seenNLKeys = new HashSet<string>(StringComparer.Ordinal);\n\n        // Helpers\n        static string NK(string? k) => string.IsNullOrWhiteSpace(k) ? \"none\" : k.Trim().ToLowerInvariant();\n        static bool IsIdentifier(string? s) => !string.IsNullOrWhiteSpace(s) && Regex.IsMatch(s!, @\"^[A-Za-z_][A-Za-z0-9_]*$\");\n\n        foreach (var it in incoming)\n        {\n            ct.ThrowIfCancellationRequested();\n\n            var extId = it.ExternalId?.Trim();\n            var lang = string.IsNullOrWhiteSpace(it.Language) ? \"en_US\" : it.Language.Trim();\n            var nlKey = NLKey(it.Name, lang);\n\n            seenNLKeys.Add(nlKey);\n            if (!string.IsNullOrWhiteSpace(extId)) seenTemplateIds.Add(extId!);\n\n            // Parse & summarize provider JSON\n            var dto = TemplateJsonHelper.SummarizeDetailed(it.RawJson, it.Body);\n\n            var headerKindNorm = NK(dto.HeaderKind);\n            var headerTextToPersist = headerKindNorm == \"text\"\n                ? (string.IsNullOrWhiteSpace(dto.HeaderText) ? null : dto.HeaderText!.Trim())\n                : null;\n\n            var paramFormat = (dto.ParameterFormat ?? \"UNKNOWN\").Trim().ToUpperInvariant();\n\n            // Real placeholders only\n            var occAll = (dto.Placeholders ?? new List<PlaceholderOccurrence>()).ToList();\n            var occFiltered = occAll.Where(o =>\n            {\n                var raw = o.Raw?.Trim();\n                if (string.Equals(raw, \"{{}}\", StringComparison.Ordinal)) return false;\n\n                if (paramFormat == \"POSITIONAL\") return o.Index is >= 1;\n                if (paramFormat == \"NAMED\") return IsIdentifier(o.Name);\n                return false;\n            }).ToList();\n\n            int headerVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Header);\n            int bodyVars = occFiltered.Count(p => p.Location == PlaceholderLocation.Body);\n            int totalVars = occFiltered.Count;\n\n            var combinedBody = dto.CombinedPreviewBody ?? string.Empty;\n            var bodyPreview = combinedBody.Length > 240 ? combinedBody[..240] : combinedBody;\n\n            bool requiresMediaHeader = headerKindNorm is \"image\" or \"video\" or \"document\";\n\n            // Named param keys\n            var namedKeys = occFiltered\n                .Where(p => !string.IsNullOrWhiteSpace(p.Name))\n                .Select(p => p.Name!.Trim())\n                .Where(IsIdentifier)\n                .Distinct(StringComparer.OrdinalIgnoreCase)\n                .ToArray();\n            string? namedKeysJson = namedKeys.Length > 0 ? JsonConvert.SerializeObject(namedKeys) : null;\n\n            // Buttons summary\n            string? urlButtonsJson = null;\n            int quickReplyCount = 0;\n            bool hasPhoneButton = false;\n\n            if (it.Buttons is { Count: > 0 })\n            {\n                var urlButtons = new List<object>(capacity: it.Buttons.Count);\n\n                foreach (var b in it.Buttons)\n                {\n                    var sub = (b.SubType ?? \"\").Trim().ToLowerInvariant();\n\n                    if (sub == \"quick_reply\") quickReplyCount++;\n                    if (sub == \"voice_call\") hasPhoneButton = true;\n\n                    if (sub == \"url\")\n                    {\n                        urlButtons.Add(new { index = b.Index });\n                    }\n                }\n\n                urlButtonsJson = urlButtons.Count > 0 ? JsonConvert.SerializeObject(urlButtons) : null;\n            }\n\n            var status = string.IsNullOrWhiteSpace(it.Status) ? \"APPROVED\" : it.Status!.Trim().ToUpperInvariant();\n\n            // Locate existing (TemplateId first, else Name+Lang)\n            WhatsAppTemplate? row = null;\n\n            if (!string.IsNullOrWhiteSpace(extId) && byTemplateId.TryGetValue(extId!, out var foundById))\n            {\n                row = foundById;\n            }\n            else if (byNameLang.TryGetValue(nlKey, out var foundByNL))\n            {\n                row = foundByNL;\n\n                // backfill TemplateId if present now\n                if (!string.IsNullOrWhiteSpace(extId) && string.IsNullOrWhiteSpace(row.TemplateId))\n                {\n                    row.TemplateId = extId;\n                    updated++;\n                }\n            }\n\n            if (row is null)\n            {\n                // INSERT\n                var newRow = new WhatsAppTemplate\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Provider = providerKey,\n                    TemplateId = extId,\n                    Name = it.Name,\n                    LanguageCode = lang,\n                    Status = status,\n                    Category = it.Category,\n                    SubCategory = null,\n\n                    RawJson = it.RawJson ?? \"{}\",\n\n                    ParameterFormat = paramFormat,\n                    HeaderKind = headerKindNorm,\n                    HeaderText = headerTextToPersist,\n                    Body = combinedBody,\n                    BodyPreview = bodyPreview,\n\n                    RequiresMediaHeader = requiresMediaHeader,\n\n                    BodyVarCount = bodyVars,\n                    HeaderTextVarCount = headerVars,\n                    TotalTextParamCount = totalVars,\n\n                    UrlButtons = urlButtonsJson,\n                    QuickReplyCount = quickReplyCount,\n                    HasPhoneButton = hasPhoneButton,\n\n                    NamedParamKeys = namedKeysJson,\n                    PlaceholderMap = null,\n\n                    IsActive = true,\n                    CreatedAt = now,\n                    UpdatedAt = now,\n                    LastSyncedAt = now\n                };\n\n                _db.WhatsAppTemplates.Add(newRow);\n                added++;\n\n                if (!string.IsNullOrWhiteSpace(extId)) byTemplateId[extId!] = newRow;\n                byNameLang[nlKey] = newRow;\n            }\n            else\n            {\n                // UPDATE\n                bool changed = false;\n\n                if (!string.Equals(row.Status, status, StringComparison.Ordinal))\n                { row.Status = status; changed = true; }\n\n                if (!string.Equals(row.Category, it.Category, StringComparison.Ordinal))\n                { row.Category = it.Category; changed = true; }\n\n                var newRaw = it.RawJson ?? \"{}\";\n                if (!string.Equals(row.RawJson, newRaw, StringComparison.Ordinal))\n                { row.RawJson = newRaw; changed = true; }\n\n                if (!string.Equals(row.ParameterFormat, paramFormat, StringComparison.Ordinal))\n                { row.ParameterFormat = paramFormat; changed = true; }\n\n                if (!string.Equals(row.HeaderKind, headerKindNorm, StringComparison.Ordinal))\n                { row.HeaderKind = headerKindNorm; changed = true; }\n\n                var existingHeaderText = string.IsNullOrWhiteSpace(row.HeaderText) ? null : row.HeaderText!.Trim();\n                if (!string.Equals(existingHeaderText, headerTextToPersist, StringComparison.Ordinal))\n                { row.HeaderText = headerTextToPersist; changed = true; }\n\n                if (!string.Equals(row.Body ?? string.Empty, combinedBody, StringComparison.Ordinal))\n                { row.Body = combinedBody; changed = true; }\n\n                if (!string.Equals(row.BodyPreview ?? string.Empty, bodyPreview ?? string.Empty, StringComparison.Ordinal))\n                { row.BodyPreview = bodyPreview; changed = true; }\n\n                if (row.RequiresMediaHeader != requiresMediaHeader)\n                { row.RequiresMediaHeader = requiresMediaHeader; changed = true; }\n\n                if (row.BodyVarCount != bodyVars) { row.BodyVarCount = bodyVars; changed = true; }\n                if (row.HeaderTextVarCount != headerVars) { row.HeaderTextVarCount = headerVars; changed = true; }\n                if (row.TotalTextParamCount != totalVars) { row.TotalTextParamCount = totalVars; changed = true; }\n\n                if (!string.Equals(row.UrlButtons ?? \"\", urlButtonsJson ?? \"\", StringComparison.Ordinal))\n                { row.UrlButtons = urlButtonsJson; changed = true; }\n\n                if (row.QuickReplyCount != quickReplyCount) { row.QuickReplyCount = quickReplyCount; changed = true; }\n                if (row.HasPhoneButton != hasPhoneButton) { row.HasPhoneButton = hasPhoneButton; changed = true; }\n\n                if (!string.Equals(row.NamedParamKeys ?? \"\", namedKeysJson ?? \"\", StringComparison.Ordinal))\n                { row.NamedParamKeys = namedKeysJson; changed = true; }\n\n                // PlaceholderMap remains as-is unless you compute it elsewhere\n\n                row.IsActive = true;\n                row.LastSyncedAt = now;\n\n                if (changed) { row.UpdatedAt = now; updated++; } else { unchanged++; }\n            }\n        }\n\n        // ⛔️ Deactivation is skipped when onlyUpsert == true\n        if (!onlyUpsert && incoming.Count > 0)\n        {\n            foreach (var e in existing)\n            {\n                bool stillThere =\n                    (!string.IsNullOrWhiteSpace(e.TemplateId) && seenTemplateIds.Contains(e.TemplateId)) ||\n                    seenNLKeys.Contains(NLKey(e.Name, e.LanguageCode));\n\n                if (!stillThere && e.IsActive)\n                {\n                    e.IsActive = false;\n                    e.LastSyncedAt = now;\n                    e.UpdatedAt = now;\n                    updated++;\n                }\n            }\n        }\n\n        await _db.SaveChangesAsync(ct);\n\n        _log.LogInformation(\"[TplSync] Done (business={BusinessId}, provider={Provider}) added={Added} updated={Updated} unchanged={Unchanged} onlyUpsert={OnlyUpsert}\",\n            businessId, providerKey, added, updated, unchanged, onlyUpsert);\n\n        return new TemplateSyncResult(added, updated, unchanged, now);\n    }\n\n\n    private static (string HeaderKind, string CombinedBody, int PlaceholderCount)\n                    ComputeFromRawOrFallback(TemplateCatalogItem it)\n    {\n        var (headerKind, combinedBody, placeholderCount) =\n            TemplateJsonHelper.Summarize(it.RawJson, it.Body);\n\n        return (string.IsNullOrWhiteSpace(headerKind) ? \"none\" : headerKind,\n                combinedBody ?? string.Empty,\n                placeholderCount);\n    }\n\n    ///\n    // Add inside TemplateSyncService class\n    private static (string headerKind, bool requiresMedia, string? headerText,\n                   string parameterFormat, int bodyVars, int headerVars, int totalVars,\n                   string? namedKeysJson, string? placeholderMapJson,\n                   string? body, string? bodyPreview,\n                   string? urlButtonsJson, int quickReplyCount, bool hasPhoneButton)\n    SummarizeFromRawJson(string rawJson, string? bodyFallback)\n    {\n        // Uses your existing canonical JSON helper if present; otherwise lightweight parse.\n        // Prefer TemplateJsonHelper if it exists in your project.\n        try\n        {\n            // TemplateJsonHelper.Summarize should already compute combined details in your repo.\n            // Replace this block with that call if available to keep logic single-sourced.\n            // var s = TemplateJsonHelper.Summarize(rawJson, bodyFallback);\n            // return (... map from s ...);\n\n            var jo = Newtonsoft.Json.Linq.JObject.Parse(string.IsNullOrWhiteSpace(rawJson) ? \"{}\" : rawJson);\n            var components = (Newtonsoft.Json.Linq.JArray?)jo[\"components\"] ?? new();\n            string headerKind = \"none\";\n            string? headerText = null;\n            string parameterFormat = \"UNKNOWN\";\n\n            // HEADER detection\n            var header = components.FirstOrDefault(c =>\n                string.Equals((string?)c?[\"type\"], \"HEADER\", StringComparison.OrdinalIgnoreCase)) as Newtonsoft.Json.Linq.JObject;\n\n            var headerFormat = ((string?)header?[\"format\"])?.ToLowerInvariant();\n            headerKind = headerFormat switch\n            {\n                \"image\" => \"image\",\n                \"video\" => \"video\",\n                \"document\" => \"document\",\n                \"text\" => \"text\",\n                \"location\" => \"location\",\n                _ => \"none\"\n            };\n            if (string.Equals(headerKind, \"text\", StringComparison.OrdinalIgnoreCase))\n                headerText = (string?)header?[\"text\"];\n\n            bool requiresMedia = headerKind is \"image\" or \"video\" or \"document\";\n\n            // BODY\n            var body = (string?)components.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"BODY\", StringComparison.OrdinalIgnoreCase))?[\"text\"]\n                       ?? bodyFallback ?? string.Empty;\n            var bodyPreview = body?.Length > 240 ? body.Substring(0, 240) : body;\n\n            // NAMED vs POSITIONAL slots (rough heuristic: if there are explicit named keys, mark NAMED)\n            // Count positional: {{1}}, {{ 2 }}, etc. Count named blank tokens: {{}} as a slot marker.\n            var positional = System.Text.RegularExpressions.Regex.Matches(body ?? \"\", @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count;\n            var namedBlank = System.Text.RegularExpressions.Regex.Matches(body ?? \"\", @\"\\{\\{\\s*\\}\\}\").Count;\n\n            // Collect named param keys if present in RAW JSON (Meta has examples under example/parameters/name)\n            var namedKeys = new HashSet<string>(StringComparer.OrdinalIgnoreCase);\n            foreach (var comp in components.OfType<Newtonsoft.Json.Linq.JObject>())\n            {\n                var paramsArr = comp[\"example\"]?[\"parameters\"] as Newtonsoft.Json.Linq.JArray;\n                if (paramsArr != null)\n                {\n                    foreach (var p in paramsArr.OfType<Newtonsoft.Json.Linq.JObject>())\n                    {\n                        var name = (string?)p[\"key\"] ?? (string?)p[\"name\"];\n                        if (!string.IsNullOrWhiteSpace(name)) namedKeys.Add(name!);\n                    }\n                }\n            }\n            parameterFormat = namedKeys.Count > 0 ? \"NAMED\" : (positional > 0 ? \"POSITIONAL\" : \"UNKNOWN\");\n\n            // Header text variable count (rough: treat {{}}/positional in headerText)\n            var headerVars = 0;\n            if (!string.IsNullOrEmpty(headerText))\n            {\n                headerVars += System.Text.RegularExpressions.Regex.Matches(headerText, @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count;\n                headerVars += System.Text.RegularExpressions.Regex.Matches(headerText, @\"\\{\\{\\s*\\}\\}\").Count;\n            }\n\n            var bodyVars = positional + namedBlank;\n            var totalVars = bodyVars + headerVars;\n\n            // Buttons → collect url buttons + quick replies + phone button presence\n            var buttons = components.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"BUTTONS\", StringComparison.OrdinalIgnoreCase)) as Newtonsoft.Json.Linq.JObject;\n            var btnArr = buttons?[\"buttons\"] as Newtonsoft.Json.Linq.JArray ?? new();\n\n            var quickReplyCount = 0;\n            var hasPhoneButton = false;\n            var urlButtonsList = new List<Newtonsoft.Json.Linq.JObject>();\n\n            foreach (var b in btnArr.OfType<Newtonsoft.Json.Linq.JObject>())\n            {\n                var sub = ((string?)b[\"sub_type\"])?.ToLowerInvariant();\n                if (sub == \"quick_reply\") quickReplyCount++;\n                if (sub == \"phone_number\") hasPhoneButton = true;\n                if (sub == \"url\")\n                {\n                    // retain minimal facsimile for UrlButtons (index + parameter template if any)\n                    var index = (string?)b[\"index\"] ?? \"0\";\n                    var parameters = b[\"parameters\"] as Newtonsoft.Json.Linq.JArray;\n                    urlButtonsList.Add(new Newtonsoft.Json.Linq.JObject\n                    {\n                        [\"index\"] = index,\n                        [\"parameters\"] = parameters ?? new Newtonsoft.Json.Linq.JArray()\n                    });\n                }\n            }\n\n            var urlButtonsJson = urlButtonsList.Count > 0\n                ? Newtonsoft.Json.JsonConvert.SerializeObject(urlButtonsList)\n                : null;\n\n            var namedKeysJson = namedKeys.Count > 0\n                ? Newtonsoft.Json.JsonConvert.SerializeObject(namedKeys.ToArray())\n                : null;\n\n            // Placeholder map is provider-specific; keep null unless you compute it elsewhere\n            string? placeholderMapJson = null;\n\n            return (headerKind, requiresMedia, headerText,\n                    parameterFormat, bodyVars, headerVars, totalVars,\n                    namedKeysJson, placeholderMapJson,\n                    body, bodyPreview,\n                    urlButtonsJson, quickReplyCount, hasPhoneButton);\n        }\n        catch\n        {\n            // very defensive fallback\n            var body = bodyFallback ?? string.Empty;\n            var bodyVars = System.Text.RegularExpressions.Regex.Matches(body, @\"\\{\\{\\s*\\d+\\s*\\}\\}\").Count\n                         + System.Text.RegularExpressions.Regex.Matches(body, @\"\\{\\{\\s*\\}\\}\").Count;\n            var preview = body.Length > 240 ? body.Substring(0, 240) : body;\n            return (\"none\", false, null, \"UNKNOWN\", bodyVars, 0, bodyVars, null, null, body, preview, null, 0, false);\n        }\n    }\n\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/TemplateSyncWorker.cs",
      "sha256": "70427556d8ed5f1c68348a414a166b4bcdd07911b8f9f8d63bb05f3897d30a04",
      "language": "csharp",
      "size": 8915,
      "content": "using System;\nusing System.Diagnostics;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Configuration;\nusing Microsoft.Extensions.DependencyInjection;\nusing Microsoft.Extensions.Hosting;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api; // AppDbContext\n\nnamespace xbytechat.api.WhatsAppSettings.Services\n{\n    /// <summary>\n    /// Periodically refreshes WhatsApp template catalogs for all businesses\n    /// that have an active WhatsAppSettings row. Uses ITemplateSyncService\n    /// which is TTL-aware to avoid unnecessary work.\n    /// </summary>\n    public sealed class TemplateSyncWorker : BackgroundService\n    {\n        private readonly IServiceProvider _sp;\n        private readonly ILogger<TemplateSyncWorker> _log;\n        private readonly TimeSpan _interval;\n        private readonly int _maxParallel;\n        private readonly int _jitterSeconds;\n\n        public TemplateSyncWorker(IServiceProvider sp, ILogger<TemplateSyncWorker> log, IConfiguration cfg)\n        {\n            _sp = sp;\n            _log = log;\n\n            // Defaults chosen to be light on the system.\n            // appsettings.json example:\n            // \"WhatsApp\": {\n            //   \"Templates\": {\n            //     \"SyncIntervalMinutes\": 360,\n            //     \"MaxParallel\": 1,\n            //     \"JitterSeconds\": 60\n            //   }\n            // }\n            var minutes = Math.Max(15, cfg.GetValue<int?>(\"WhatsApp:Templates:SyncIntervalMinutes\") ?? 360);\n            _interval = TimeSpan.FromMinutes(minutes);\n\n            _maxParallel = Math.Clamp(cfg.GetValue<int?>(\"WhatsApp:Templates:MaxParallel\") ?? 1, 1, 8);\n            _jitterSeconds = Math.Clamp(cfg.GetValue<int?>(\"WhatsApp:Templates:JitterSeconds\") ?? 60, 0, 300);\n        }\n\n        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n        {\n            // small delay after startup\n            await Task.Delay(TimeSpan.FromSeconds(10), stoppingToken);\n\n            var rnd = new Random();\n\n            while (!stoppingToken.IsCancellationRequested)\n            {\n                var sweepStart = DateTime.UtcNow;\n                var sw = Stopwatch.StartNew();\n                int processed = 0;\n\n                try\n                {\n                    using var scope = _sp.CreateScope();\n                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n\n                    // Get active business IDs once per sweep\n                    var bizIds = await db.WhatsAppSettings\n                        .AsNoTracking()\n                        .Where(s => s.IsActive)\n                        .Select(s => s.BusinessId)\n                        .Distinct()\n                        .ToListAsync(stoppingToken);\n\n                    if (bizIds.Count == 0)\n                    {\n                        _log.LogInformation(\"TemplateSyncWorker: no active WhatsApp settings found.\");\n                    }\n                    else\n                    {\n                        var sem = new SemaphoreSlim(_maxParallel);\n                        var tasks = bizIds.Select(async biz =>\n                        {\n                            await sem.WaitAsync(stoppingToken);\n                            try\n                            {\n                                // New scope per business to keep DbContexts short-lived\n                                using var inner = _sp.CreateScope();\n                                var sync = inner.ServiceProvider.GetRequiredService<ITemplateSyncService>();\n\n                                // TTL-aware; manual button should call force:true instead\n                                var res = await sync.SyncBusinessTemplatesAsync(biz, force: false, ct: stoppingToken);\n                                Interlocked.Increment(ref processed);\n\n                                _log.LogInformation(\n                                    \"TemplateSyncWorker: biz={Biz} added={A} updated={U} skipped={S} syncedAt={At}\",\n                                    biz, res.Added, res.Updated, res.Skipped, res.SyncedAt);\n                            }\n                            catch (OperationCanceledException) { /* shutting down */ }\n                            catch (Exception exBiz)\n                            {\n                                _log.LogWarning(exBiz, \"TemplateSyncWorker: sync failed for biz {Biz}\", biz);\n                            }\n                            finally\n                            {\n                                sem.Release();\n                            }\n                        });\n\n                        await Task.WhenAll(tasks);\n                    }\n                }\n                catch (OperationCanceledException) { /* shutting down */ }\n                catch (Exception ex)\n                {\n                    _log.LogWarning(ex, \"TemplateSyncWorker sweep failed\");\n                }\n                finally\n                {\n                    sw.Stop();\n                    _log.LogInformation(\"TemplateSyncWorker: sweep finished in {ElapsedMs} ms; processed={Processed}; next run ~{NextRun}\",\n                        sw.ElapsedMilliseconds, processed, sweepStart.Add(_interval));\n                }\n\n                // Add small jitter to avoid multiple instances syncing at the exact same time\n                var jitter = _jitterSeconds > 0 ? TimeSpan.FromSeconds(rnd.Next(0, _jitterSeconds + 1)) : TimeSpan.Zero;\n                var delay = _interval + jitter;\n\n                await Task.Delay(delay, stoppingToken);\n            }\n        }\n    }\n}\n\n\n//using System;\n//using System.Linq;\n//using System.Threading;\n//using System.Threading.Tasks;\n//using Microsoft.EntityFrameworkCore;\n//using Microsoft.Extensions.Configuration;\n//using Microsoft.Extensions.DependencyInjection;\n//using Microsoft.Extensions.Hosting;\n//using Microsoft.Extensions.Logging;\n//using xbytechat.api; // AppDbContext\n\n//namespace xbytechat.api.WhatsAppSettings.Services\n//{\n//    /// <summary>\n//    /// Periodically refreshes WhatsApp template catalogs for all businesses\n//    /// that have an active WhatsAppSettings row. Uses your existing\n//    /// ITemplateSyncService (TTL-aware) so this is safe to run frequently.\n//    /// </summary>\n//    public sealed class TemplateSyncWorker : BackgroundService\n//    {\n//        private readonly IServiceProvider _sp;\n//        private readonly ILogger<TemplateSyncWorker> _log;\n//        private readonly TimeSpan _interval;\n\n//        public TemplateSyncWorker(IServiceProvider sp, ILogger<TemplateSyncWorker> log, IConfiguration cfg)\n//        {\n//            _sp = sp;\n//            _log = log;\n\n//            // Default: every 6 hours; override in appsettings:\n//            // \"WhatsApp\": { \"Templates\": { \"SyncIntervalMinutes\": 360 } }\n//            var minutes = Math.Max(15, cfg.GetValue<int?>(\"WhatsApp:Templates:SyncIntervalMinutes\") ?? 360);\n//            _interval = TimeSpan.FromMinutes(minutes);\n//        }\n\n//        protected override async Task ExecuteAsync(CancellationToken stoppingToken)\n//        {\n//            // small delay after startup\n//            await Task.Delay(TimeSpan.FromSeconds(10), stoppingToken);\n\n//            while (!stoppingToken.IsCancellationRequested)\n//            {\n//                try\n//                {\n//                    using var scope = _sp.CreateScope();\n//                    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n//                    var sync = scope.ServiceProvider.GetRequiredService<ITemplateSyncService>();\n\n//                    var bizIds = await db.WhatsAppSettings\n//                        .AsNoTracking()\n//                        .Where(s => s.IsActive)\n//                        .Select(s => s.BusinessId)\n//                        .Distinct()\n//                        .ToListAsync(stoppingToken);\n\n//                    foreach (var biz in bizIds)\n//                    {\n//                        try\n//                        {\n//                            var res = await sync.SyncBusinessTemplatesAsync(biz, force: false, ct: stoppingToken);\n//                            _log.LogInformation(\"TemplateSyncWorker: biz={Biz} added={A} updated={U} syncedAt={At}\",\n//                                biz, res.Added, res.Updated, res.SyncedAt);\n//                        }\n//                        catch (Exception exBiz)\n//                        {\n//                            _log.LogWarning(exBiz, \"TemplateSyncWorker: sync failed for biz {Biz}\", biz);\n//                        }\n//                    }\n//                }\n//                catch (Exception ex)\n//                {\n//                    _log.LogWarning(ex, \"TemplateSyncWorker sweep failed\");\n//                }\n\n//                await Task.Delay(_interval, stoppingToken);\n//            }\n//        }\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppPhoneNumberService.cs",
      "sha256": "62b5db83cceae1415fd74b21b6b0060da4e300fb3d10cb9fc1f573bd92c104cc",
      "language": "csharp",
      "size": 19167,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Net.Http.Headers;\nusing System.Net;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\nusing xbytechat.api.Features.WhatsAppSettings.Services;\nusing xbytechat_api.WhatsAppSettings.Models;\nusing xbytechat.api.WhatsAppSettings.DTOs;\n\n\nnamespace xbytechat.api.Features.WhatsAppSettings.Services\n{\n    public sealed class WhatsAppPhoneNumberService : IWhatsAppPhoneNumberService\n    {\n        private readonly AppDbContext _db;\n\n        public WhatsAppPhoneNumberService(AppDbContext db)\n        {\n            _db = db;\n        }\n\n        public async Task<IReadOnlyList<WhatsAppPhoneNumber>> ListAsync(\n           Guid businessId,\n           string provider,\n            CancellationToken ct = default)\n        {\n            if (string.IsNullOrWhiteSpace(provider))\n                throw new ArgumentException(\"Provider is required.\", nameof(provider));\n\n            // Enforce your uppercase-only contract (no normalization here)\n            if (provider is not \"PINNACLE\" and not \"META_CLOUD\")\n                throw new ArgumentOutOfRangeException(nameof(provider),\n                    \"Provider must be exactly 'PINNACLE' or 'META_CLOUD'.\");\n\n            var list = await _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(x => x.BusinessId == businessId && x.Provider == provider) // exact, case-sensitive\n                .OrderByDescending(x => x.IsDefault)\n                .ThenBy(x => x.WhatsAppBusinessNumber)\n                .ToListAsync(ct);\n\n            return list; // List<T> implements IReadOnlyList<T>\n        }\n\n        private static string NormalizeProvider(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return \"Pinnacle\";\n            var s = raw.Trim();\n            if (string.Equals(s, \"Pinnacle\", StringComparison.OrdinalIgnoreCase)) return \"Pinnacle\";\n            if (string.Equals(s, \"Meta_cloud\", StringComparison.OrdinalIgnoreCase) ||\n                string.Equals(s, \"meta_cloud\", StringComparison.OrdinalIgnoreCase) ||\n                string.Equals(s, \"meta\", StringComparison.OrdinalIgnoreCase))\n                return \"Meta_cloud\";\n            return s;\n        }\n\n        public async Task<(int Added, int Updated, int Total)> SyncFromProviderAsync(\n            Guid businessId,\n            WhatsAppSettingsDto s,                 // DTO\n            string provider,\n            CancellationToken ct = default)\n        {\n            // Always honor the provider saved in DB (CAPS), fall back to the arg if needed\n            var providerCanon = (s.Provider ?? provider ?? string.Empty)\n                .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n\n            List<(string PhoneId, string Number, string? Label)> list = providerCanon switch\n            {\n                \"META_CLOUD\" => await FetchFromMetaAsync(s, ct),\n                \"PINNACLE\" => await FetchFromPinnacleAsync(s, ct),\n                _ => new List<(string PhoneId, string Number, string? Label)>()\n            };\n\n            var added = 0;\n            var updated = 0;\n\n            foreach (var (phoneId, number, label) in list)\n            {\n                var existing = await _db.WhatsAppPhoneNumbers\n                    .FirstOrDefaultAsync(x =>\n                        x.BusinessId == businessId &&\n                        x.Provider == providerCanon &&\n                        x.PhoneNumberId == phoneId, ct);\n\n                if (existing is null)\n                {\n                    _db.WhatsAppPhoneNumbers.Add(new WhatsAppPhoneNumber\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = businessId,\n                        Provider = providerCanon,                 // segregate by provider\n                        PhoneNumberId = phoneId,\n                        WhatsAppBusinessNumber = number,\n                        SenderDisplayName = string.IsNullOrWhiteSpace(label) ? null : label,\n                        IsActive = true,\n                        IsDefault = false\n                    });\n                    added++;\n                }\n                else\n                {\n                    existing.WhatsAppBusinessNumber = number;\n                    if (!string.IsNullOrWhiteSpace(label))\n                        existing.SenderDisplayName = label;\n                    existing.IsActive = true;\n                    updated++;\n                }\n            }\n\n            await _db.SaveChangesAsync(ct);\n            return (added, updated, list.Count);\n        }\n\n        private async Task<List<(string PhoneId, string Number, string? Label)>> FetchFromMetaAsync(\n            WhatsAppSettingsDto s,\n            CancellationToken ct)\n        {\n            var list = new List<(string, string, string?)>();\n\n            if (string.IsNullOrWhiteSpace(s.ApiKey) || string.IsNullOrWhiteSpace(s.WabaId))\n                return list;\n\n            var baseUrl = string.IsNullOrWhiteSpace(s.ApiUrl)\n                ? \"https://graph.facebook.com/v22.0\"\n                : s.ApiUrl.TrimEnd('/');\n\n            var url = $\"{baseUrl}/{s.WabaId}/phone_numbers?limit=100\";\n\n            using var http = new HttpClient();\n            http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue(\"Bearer\", s.ApiKey);\n\n            var res = await http.GetAsync(url, ct);\n            var body = await res.Content.ReadAsStringAsync(ct);\n            if (!res.IsSuccessStatusCode) return list;\n\n            using var doc = JsonDocument.Parse(body);\n            var root = doc.RootElement;\n\n            var data = root.ValueKind == JsonValueKind.Array\n                ? root\n                : root.TryGetProperty(\"data\", out var d) && d.ValueKind == JsonValueKind.Array ? d\n                : default;\n\n            if (data.ValueKind == JsonValueKind.Array)\n            {\n                foreach (var e in data.EnumerateArray())\n                {\n                    var id = e.TryGetProperty(\"id\", out var idEl) ? idEl.GetString()\n                             : e.TryGetProperty(\"phone_number_id\", out var pid) ? pid.GetString()\n                             : null;\n\n                    var num = e.TryGetProperty(\"display_phone_number\", out var dnum) ? dnum.GetString()\n                             : e.TryGetProperty(\"number\", out var numEl) ? numEl.GetString()\n                             : null;\n\n                    var name = e.TryGetProperty(\"verified_name\", out var vn) ? vn.GetString()\n                             : e.TryGetProperty(\"name\", out var nm) ? nm.GetString()\n                             : null;\n\n                    if (!string.IsNullOrWhiteSpace(id) && !string.IsNullOrWhiteSpace(num))\n                        list.Add((id!, num!, name));\n                }\n            }\n\n            return list;\n        }\n\n        private async Task<List<(string PhoneId, string Number, string? Label)>> FetchFromPinnacleAsync(\n            WhatsAppSettingsDto s,\n            CancellationToken ct)\n        {\n            var list = new List<(string, string, string?)>();\n\n            if (string.IsNullOrWhiteSpace(s.ApiKey))\n                return list;\n\n            // Base URL and /v3 suffix\n            var baseUrl = string.IsNullOrWhiteSpace(s.ApiUrl)\n                ? \"https://partnersv1.pinbot.ai\"\n                : s.ApiUrl.TrimEnd('/');\n\n            if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase))\n                baseUrl += \"/v3\";\n\n            // Prefer WABA, fall back to PhoneNumberId\n            var pathId = !string.IsNullOrWhiteSpace(s.WabaId) ? s.WabaId!.Trim()\n                       : !string.IsNullOrWhiteSpace(s.PhoneNumberId) ? s.PhoneNumberId!.Trim()\n                       : null;\n\n            if (string.IsNullOrWhiteSpace(pathId))\n                return list;\n\n            var url = $\"{baseUrl}/{pathId}/phone_numbers\";\n\n            using var http = new HttpClient();\n            using var req = new HttpRequestMessage(HttpMethod.Get, url);\n            req.Headers.TryAddWithoutValidation(\"apikey\", s.ApiKey);\n\n            var res = await http.SendAsync(req, ct);\n            var body = await res.Content.ReadAsStringAsync(ct);\n            if (!res.IsSuccessStatusCode) return list;\n\n            using var doc = JsonDocument.Parse(body);\n            var root = doc.RootElement;\n\n            var data = root.ValueKind == JsonValueKind.Array\n                ? root\n                : root.TryGetProperty(\"data\", out var d) && d.ValueKind == JsonValueKind.Array ? d\n                : default;\n\n            if (data.ValueKind == JsonValueKind.Array)\n            {\n                foreach (var e in data.EnumerateArray())\n                {\n                    var id = e.TryGetProperty(\"id\", out var idEl) ? idEl.GetString()\n                             : e.TryGetProperty(\"phone_number_id\", out var pid) ? pid.GetString()\n                             : null;\n\n                    var num = e.TryGetProperty(\"display_phone_number\", out var dnum) ? dnum.GetString()\n                             : e.TryGetProperty(\"msisdn\", out var msisdn) ? msisdn.GetString()\n                             : e.TryGetProperty(\"number\", out var numEl) ? numEl.GetString()\n                             : null;\n\n                    var name = e.TryGetProperty(\"verified_name\", out var vn) ? vn.GetString()\n                             : e.TryGetProperty(\"name\", out var nm) ? nm.GetString()\n                             : null;\n\n                    if (!string.IsNullOrWhiteSpace(id) && !string.IsNullOrWhiteSpace(num))\n                        list.Add((id!, num!, name));\n                }\n            }\n\n            return list;\n        }\n\n\n        private static string NormalizeMetaBase(string? apiUrl)\n                        => string.IsNullOrWhiteSpace(apiUrl) ? \"https://graph.facebook.com/v22.0\" : apiUrl.Trim();\n\n        private async Task<List<(string PhoneId, string Number, string? Label)>> FetchFromMetaAsync(\n            WhatsAppSettingEntity s, CancellationToken ct)\n        {\n            var baseUrl = NormalizeMetaBase(s.ApiUrl);\n            using var http = new HttpClient();\n            http.DefaultRequestHeaders.Authorization =\n                new AuthenticationHeaderValue(\"Bearer\", s.ApiKey!.Trim());\n\n            var list = new List<(string, string, string?)>();\n            string? after = null;\n\n            do\n            {\n                var url = $\"{baseUrl}/{s.WabaId}/phone_numbers?fields=id,display_phone_number,verified_name\";\n                if (!string.IsNullOrEmpty(after)) url += $\"&after={WebUtility.UrlEncode(after)}\";\n\n                var json = await http.GetStringAsync(url, ct);\n                using var doc = JsonDocument.Parse(json);\n                var root = doc.RootElement;\n\n                if (root.TryGetProperty(\"data\", out var data) && data.ValueKind == JsonValueKind.Array)\n                {\n                    foreach (var e in data.EnumerateArray())\n                    {\n                        var id = e.TryGetProperty(\"id\", out var idEl) ? idEl.GetString() : null;\n                        var num = e.TryGetProperty(\"display_phone_number\", out var nEl) ? nEl.GetString() : null;\n                        var name = e.TryGetProperty(\"verified_name\", out var lEl) ? lEl.GetString() : null;\n                        if (!string.IsNullOrWhiteSpace(id) && !string.IsNullOrWhiteSpace(num))\n                            list.Add((id!, num!, name));\n                    }\n                }\n\n                after = root.TryGetProperty(\"paging\", out var p)\n                     && p.TryGetProperty(\"cursors\", out var c)\n                     && c.TryGetProperty(\"after\", out var a)\n                     && a.ValueKind == JsonValueKind.String ? a.GetString() : null;\n\n            } while (!string.IsNullOrEmpty(after));\n\n            return list;\n        }\n\n\n        public async Task<WhatsAppPhoneNumber> UpsertAsync(\n              Guid businessId,\n              string provider, string phoneNumberId,\n              string whatsAppBusinessNumber, string? senderDisplayName,\n              bool? isActive = null,\n         bool? isDefault = null)\n        {\n            if (string.IsNullOrWhiteSpace(provider)) throw new ArgumentException(\"provider is required\");\n            if (string.IsNullOrWhiteSpace(phoneNumberId)) throw new ArgumentException(\"phoneNumberId is required\");\n            if (string.IsNullOrWhiteSpace(whatsAppBusinessNumber)) throw new ArgumentException(\"whatsAppBusinessNumber is required\");\n\n            // Canonical provider: \"PINNACLE\" | \"META_CLOUD\"\n            var prov = provider.Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n            var pnid = phoneNumberId.Trim();\n            var waNum = whatsAppBusinessNumber.Trim();\n            var disp = string.IsNullOrWhiteSpace(senderDisplayName) ? null : senderDisplayName!.Trim();\n\n            var now = DateTime.UtcNow;\n\n            await using var tx = await _db.Database.BeginTransactionAsync();\n\n            // 1) Ensure parent settings row exists for (BusinessId, Provider) [case-insensitive]\n            var setting = await _db.WhatsAppSettings\n                .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.Provider.ToLower() == prov.ToLower());\n\n            if (setting == null)\n            {\n                setting = new WhatsAppSettingEntity\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Provider = prov,\n                    ApiUrl = string.Empty,\n                    ApiKey = string.Empty,\n                    IsActive = true,\n                    CreatedAt = now\n                };\n                _db.WhatsAppSettings.Add(setting);\n                await _db.SaveChangesAsync();\n            }\n            else if (!string.Equals(setting.Provider, prov, StringComparison.Ordinal))\n            {\n                // normalize stored provider casing\n                setting.Provider = prov;\n                setting.UpdatedAt = now;\n                await _db.SaveChangesAsync();\n            }\n\n            var providerForChild = setting.Provider; // exact value used for children\n\n            // 2) Upsert phone number in WhatsAppPhoneNumbers\n            var entity = await _db.WhatsAppPhoneNumbers.FirstOrDefaultAsync(x =>\n                x.BusinessId == businessId &&\n                x.Provider.ToLower() == providerForChild.ToLower() &&\n                x.PhoneNumberId == pnid);\n\n            if (entity == null)\n            {\n                entity = new WhatsAppPhoneNumber\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = businessId,\n                    Provider = providerForChild,\n                    PhoneNumberId = pnid,\n                    WhatsAppBusinessNumber = waNum,\n                    SenderDisplayName = disp,\n                    IsActive = isActive ?? true,\n                    IsDefault = isDefault ?? false,\n                    CreatedAt = now\n                };\n                _db.WhatsAppPhoneNumbers.Add(entity);\n            }\n            else\n            {\n                entity.WhatsAppBusinessNumber = waNum;\n                entity.SenderDisplayName = disp;\n                if (isActive.HasValue) entity.IsActive = isActive.Value;\n                if (isDefault.HasValue) entity.IsDefault = isDefault.Value;\n                entity.UpdatedAt = now;\n            }\n\n            await _db.SaveChangesAsync();\n\n            // 3) Enforce a single default per (BusinessId, Provider)\n            if (isDefault == true || entity.IsDefault)\n            {\n                await _db.WhatsAppPhoneNumbers\n                    .Where(x => x.BusinessId == businessId &&\n                                x.Provider.ToLower() == providerForChild.ToLower() &&\n                                x.Id != entity.Id)\n                    .ExecuteUpdateAsync(up => up.SetProperty(p => p.IsDefault, false));\n\n                // We no longer mirror to WhatsAppSettings because those columns were removed.\n                // If you ever re-introduce them, you can set:\n                // setting.PhoneNumberId = entity.PhoneNumberId;\n                // setting.WhatsAppBusinessNumber = entity.WhatsAppBusinessNumber;\n                setting.UpdatedAt = now;\n                await _db.SaveChangesAsync();\n            }\n\n            await tx.CommitAsync();\n            return entity;\n        }\n\n        public async Task<bool> DeleteAsync(Guid businessId, string provider, Guid id)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            var entity = await _db.WhatsAppPhoneNumbers\n                .FirstOrDefaultAsync(x => x.Id == id && x.BusinessId == businessId && x.Provider.ToLower() == prov.ToLower());\n\n            if (entity == null) return false;\n\n            _db.WhatsAppPhoneNumbers.Remove(entity);\n            await _db.SaveChangesAsync();\n            return true;\n        }\n\n        public async Task<bool> SetDefaultAsync(Guid businessId, string provider, Guid id)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            await _db.Database.BeginTransactionAsync();\n            try\n            {\n                // ensure target exists and belongs to (business, provider)\n                var target = await _db.WhatsAppPhoneNumbers\n                    .FirstOrDefaultAsync(x => x.Id == id && x.BusinessId == businessId && x.Provider.ToLower() == prov.ToLower());\n                if (target == null) return false;\n\n                await _db.WhatsAppPhoneNumbers\n                    .Where(x => x.BusinessId == businessId && x.Provider.ToLower() == prov.ToLower())\n                    .ExecuteUpdateAsync(s => s.SetProperty(p => p.IsDefault, false));\n\n                target.IsDefault = true;\n                target.UpdatedAt = DateTime.UtcNow;\n                await _db.SaveChangesAsync();\n\n                await _db.Database.CommitTransactionAsync();\n                return true;\n            }\n            catch\n            {\n                await _db.Database.RollbackTransactionAsync();\n                throw;\n            }\n        }\n\n        public async Task<WhatsAppPhoneNumber?> FindAsync(Guid businessId, string provider, string phoneNumberId)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            return await _db.WhatsAppPhoneNumbers\n                .FirstOrDefaultAsync(x =>\n                    x.BusinessId == businessId &&\n                    x.Provider.ToLower() == prov.ToLower() &&\n                    x.PhoneNumberId == phoneNumberId);\n        }\n\n        public async Task<WhatsAppPhoneNumber?> GetDefaultAsync(Guid businessId, string provider)\n        {\n            var prov = provider?.Trim() ?? string.Empty;\n\n            // covered by partial unique index: at most one IsDefault per (biz, provider)\n            return await _db.WhatsAppPhoneNumbers\n                .FirstOrDefaultAsync(x =>\n                    x.BusinessId == businessId &&\n                    x.Provider.ToLower() == prov.ToLower() &&\n                    x.IsDefault);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppSenderService.cs",
      "sha256": "fd33c4751a0f50ea7a6b0898303851a6f0d007bf2cd22708e0787b6ac1c57a1d",
      "language": "csharp",
      "size": 2691,
      "content": "using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing xbytechat.api.WhatsAppSettings.DTOs;               \nnamespace xbytechat.api.WhatsAppSettings.Services\n{\n    public sealed class WhatsAppSenderService : IWhatsAppSenderService\n    {\n        private readonly AppDbContext _db;\n        public WhatsAppSenderService(AppDbContext db) => _db = db;\n\n        public async Task<IReadOnlyList<WhatsAppSenderDto>> GetBusinessSendersAsync(\n            Guid businessId,\n            CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty) return Array.Empty<WhatsAppSenderDto>();\n\n            var rows = await _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(x => x.BusinessId == businessId && x.IsActive)\n                .OrderByDescending(x => x.IsDefault)\n                .ThenBy(x => x.WhatsAppBusinessNumber)\n                .ToListAsync(ct);\n\n            return rows.Select(x =>\n            {\n                // inline normalize: uppercase; map META -> META_CLOUD\n                var prov = (x.Provider ?? string.Empty).Trim().ToUpperInvariant();\n                if (prov == \"META\") prov = \"META_CLOUD\";\n\n                return new WhatsAppSenderDto\n                {\n                    Id = x.Id,\n                    BusinessId = x.BusinessId,\n                    Provider = prov, // \"PINNACLE\" | \"META_CLOUD\" (ideally)\n                    PhoneNumberId = x.PhoneNumberId,\n                    WhatsAppBusinessNumber = x.WhatsAppBusinessNumber,\n                    SenderDisplayName = x.SenderDisplayName,\n                    IsActive = x.IsActive,\n                    IsDefault = x.IsDefault\n                };\n            }).ToList();\n        }\n        public async Task<(string Provider, string PhoneNumberId)?> ResolveSenderPairAsync(\n            Guid businessId,\n            string phoneNumberId,\n            CancellationToken ct = default)\n        {\n            if (businessId == Guid.Empty || string.IsNullOrWhiteSpace(phoneNumberId))\n                return null;\n\n            var row = await _db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .FirstOrDefaultAsync(x =>\n                    x.BusinessId == businessId &&\n                    x.PhoneNumberId == phoneNumberId &&\n                    x.IsActive, ct);\n\n            if (row == null) return null;\n\n            // inline normalize here too\n            var prov = (row.Provider ?? string.Empty).Trim().ToUpperInvariant();\n            if (prov == \"META\") prov = \"META_CLOUD\";\n\n            return (prov, row.PhoneNumberId);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppSettingsService.cs",
      "sha256": "41e361db63ad387fd14d1af22a96a6fc8353a849d174fdbeaf2e032c09ebe1c4",
      "language": "csharp",
      "size": 16686,
      "content": "// 📄 xbytechat_api/WhatsAppSettings/Services/WhatsAppSettingsService.cs\nusing Microsoft.EntityFrameworkCore;\nusing System;\nusing System.Linq;\nusing System.Net.Http;\nusing System.Net.Http.Headers;\nusing System.Text;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing xbytechat.api;\nusing xbytechat.api.Features.WhatsAppSettings.Models;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.DTOs;\nusing xbytechat_api.WhatsAppSettings.Models;\n\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n    public class WhatsAppSettingsService : IWhatsAppSettingsService\n    {\n        private readonly AppDbContext _dbContext;\n        private readonly HttpClient _http;                    \n        private readonly IHttpClientFactory _httpClientFactory;\n\n        public WhatsAppSettingsService(\n            AppDbContext dbContext,\n            HttpClient http,\n            IHttpClientFactory httpClientFactory)\n        {\n            _dbContext = dbContext;\n            _http = http;\n            _httpClientFactory = httpClientFactory;\n        }\n\n        public async Task SaveOrUpdateSettingAsync(SaveWhatsAppSettingDto dto)\n        {\n            if (dto.BusinessId == Guid.Empty) throw new ArgumentException(\"BusinessId required\");\n\n            // Canonical provider: PINNACLE | META_CLOUD\n            var providerCanon = (dto.Provider ?? \"PINNACLE\")\n                .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n            if (providerCanon is not (\"PINNACLE\" or \"META_CLOUD\")) providerCanon = \"PINNACLE\";\n\n            var now = DateTime.UtcNow;\n\n            await using var tx = await _dbContext.Database.BeginTransactionAsync();\n\n            // Exact business + provider row\n            var existing = await _dbContext.WhatsAppSettings\n                .FirstOrDefaultAsync(x => x.BusinessId == dto.BusinessId &&\n                                          x.Provider.ToLower() == providerCanon.ToLower());\n\n            if (existing != null)\n            {\n                if (!string.Equals(existing.Provider, providerCanon, StringComparison.Ordinal))\n                    existing.Provider = providerCanon;\n\n                if (!string.IsNullOrWhiteSpace(dto.ApiUrl)) existing.ApiUrl = dto.ApiUrl.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.ApiKey)) existing.ApiKey = dto.ApiKey.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WabaId)) existing.WabaId = dto.WabaId.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.SenderDisplayName)) existing.SenderDisplayName = dto.SenderDisplayName.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WebhookSecret)) existing.WebhookSecret = dto.WebhookSecret.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WebhookVerifyToken)) existing.WebhookVerifyToken = dto.WebhookVerifyToken.Trim();\n                if (!string.IsNullOrWhiteSpace(dto.WebhookCallbackUrl)) existing.WebhookCallbackUrl = dto.WebhookCallbackUrl.Trim();\n\n                existing.IsActive = dto.IsActive;\n                existing.UpdatedAt = now;\n\n                // Ensure single active row per business\n                await _dbContext.WhatsAppSettings\n                    .Where(x => x.BusinessId == dto.BusinessId && x.Id != existing.Id)\n                    .ExecuteUpdateAsync(s => s.SetProperty(p => p.IsActive, false));\n            }\n            else\n            {\n                var s = new WhatsAppSettingEntity\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = dto.BusinessId,\n                    Provider = providerCanon,\n                    ApiUrl = (dto.ApiUrl ?? string.Empty).Trim(),\n                    ApiKey = (dto.ApiKey ?? string.Empty).Trim(),\n                    // Numbers are not stored here anymore\n                    SenderDisplayName = string.IsNullOrWhiteSpace(dto.SenderDisplayName) ? null : dto.SenderDisplayName.Trim(),\n                    WabaId = string.IsNullOrWhiteSpace(dto.WabaId) ? null : dto.WabaId.Trim(),\n                    WebhookSecret = string.IsNullOrWhiteSpace(dto.WebhookSecret) ? null : dto.WebhookSecret.Trim(),\n                    WebhookVerifyToken = string.IsNullOrWhiteSpace(dto.WebhookVerifyToken) ? null : dto.WebhookVerifyToken.Trim(),\n                    WebhookCallbackUrl = string.IsNullOrWhiteSpace(dto.WebhookCallbackUrl) ? null : dto.WebhookCallbackUrl.Trim(),\n                    IsActive = dto.IsActive,\n                    CreatedAt = now\n                };\n                await _dbContext.WhatsAppSettings.AddAsync(s);\n            }\n\n            await _dbContext.SaveChangesAsync();\n\n            // ── Numbers live in WhatsAppPhoneNumbers ─────────────────────────────\n            if (!string.IsNullOrWhiteSpace(dto.PhoneNumberId) &&\n                !string.IsNullOrWhiteSpace(dto.WhatsAppBusinessNumber))\n            {\n                var pnid = dto.PhoneNumberId.Trim();\n                var waNum = dto.WhatsAppBusinessNumber.Trim();\n                var display = string.IsNullOrWhiteSpace(dto.SenderDisplayName) ? null : dto.SenderDisplayName!.Trim();\n\n                // Upsert by business+provider+phoneId\n                var numberRow = await _dbContext.WhatsAppPhoneNumbers.FirstOrDefaultAsync(x =>\n                    x.BusinessId == dto.BusinessId &&\n                    x.Provider.ToLower() == providerCanon.ToLower() &&\n                    x.PhoneNumberId == pnid);\n\n                if (numberRow == null)\n                {\n                    numberRow = new WhatsAppPhoneNumber\n                    {\n                        Id = Guid.NewGuid(),\n                        BusinessId = dto.BusinessId,\n                        Provider = providerCanon,\n                        PhoneNumberId = pnid,\n                        WhatsAppBusinessNumber = waNum,\n                        SenderDisplayName = display,\n                        IsActive = true,\n                        IsDefault = true,\n                        CreatedAt = now\n                    };\n                    _dbContext.WhatsAppPhoneNumbers.Add(numberRow);\n                }\n                else\n                {\n                    numberRow.WhatsAppBusinessNumber = waNum;\n                    numberRow.SenderDisplayName = display;\n                    numberRow.IsActive = true;\n                    numberRow.IsDefault = true;\n                    numberRow.UpdatedAt = now;\n                }\n\n                await _dbContext.SaveChangesAsync();\n\n                // Ensure single default per business+provider\n                await _dbContext.WhatsAppPhoneNumbers\n                    .Where(x => x.BusinessId == dto.BusinessId &&\n                                x.Provider.ToLower() == providerCanon.ToLower() &&\n                                x.Id != numberRow.Id)\n                    .ExecuteUpdateAsync(s => s.SetProperty(p => p.IsDefault, false));\n            }\n            // ─────────────────────────────────────────────────────────────────────\n\n            await tx.CommitAsync();\n        }\n\n        public async Task<WhatsAppSettingsDto> GetSettingsByBusinessIdAsync(Guid businessId)\n        {\n            var row = await (\n                from s in _dbContext.WhatsAppSettings.AsNoTracking()\n                where s.BusinessId == businessId && s.IsActive\n                orderby (s.UpdatedAt ?? s.CreatedAt) descending\n                select new\n                {\n                    s.BusinessId,\n                    s.Provider,\n                    s.ApiUrl,\n                    s.ApiKey,\n                    s.WabaId,\n                    Phone = _dbContext.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(p => p.BusinessId == s.BusinessId\n                                    && p.IsActive\n                                    && p.Provider.ToLower() == s.Provider.ToLower())\n                        .OrderByDescending(p => p.IsDefault)\n                        .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                        .Select(p => new { p.PhoneNumberId, p.WhatsAppBusinessNumber })\n                        .FirstOrDefault()\n                }\n            ).FirstOrDefaultAsync();\n\n            if (row == null) return null;\n\n            return new WhatsAppSettingsDto\n            {\n                BusinessId = row.BusinessId,\n                Provider = row.Provider,\n                ApiUrl = row.ApiUrl,\n                ApiKey = row.ApiKey,\n                WabaId = row.WabaId,\n                PhoneNumberId = row.Phone?.PhoneNumberId,\n                WhatsAppBusinessNumber = row.Phone?.WhatsAppBusinessNumber\n            };\n        }\n\n        public async Task<bool> DeleteSettingsAsync(Guid businessId)\n        {\n            var setting = await _dbContext.WhatsAppSettings\n                .FirstOrDefaultAsync(x => x.BusinessId == businessId);\n\n            if (setting == null) return false;\n\n            _dbContext.WhatsAppSettings.Remove(setting);\n            await _dbContext.SaveChangesAsync();\n            return true;\n        }\n\n        /// <summary>\n        /// Provider-aware test connection. Returns a short message (✅/❌ …).\n        /// The controller may convert non-✅ messages to 400, etc.\n        /// </summary>\n        public async Task<string> TestConnectionAsync(SaveWhatsAppSettingDto dto)\n        {\n            if (string.IsNullOrWhiteSpace(dto.Provider))\n                throw new ArgumentException(\"Provider is required.\");\n\n            // normalize provider and baseUrl\n            var provider = dto.Provider.Trim();\n            var lower = provider.ToLowerInvariant();\n            var baseUrl = (dto.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n\n            if (string.IsNullOrWhiteSpace(baseUrl))\n                throw new ArgumentException(\"ApiUrl is required.\");\n\n            var http = _httpClientFactory.CreateClient();\n\n            // ----- Meta Cloud -----\n            if (lower == \"meta_cloud\")\n            {\n                if (string.IsNullOrWhiteSpace(dto.ApiKey))\n                    throw new ArgumentException(\"ApiKey is required for Meta Cloud.\");\n                if (string.IsNullOrWhiteSpace(dto.PhoneNumberId))\n                    throw new ArgumentException(\"PhoneNumberId is required for Meta Cloud.\");\n\n                http.DefaultRequestHeaders.Authorization =\n                    new AuthenticationHeaderValue(\"Bearer\", dto.ApiKey);\n\n                var url = $\"{baseUrl}/{dto.PhoneNumberId}\";\n                var res = await http.GetAsync(url);\n                var body = await res.Content.ReadAsStringAsync();\n\n                if (!res.IsSuccessStatusCode)\n                    return $\"❌ Meta Cloud test failed ({(int)res.StatusCode}). Body: {body}\";\n\n                return \"✅ Meta Cloud token & phone number ID are valid.\";\n            }\n\n            // ----- Pinnacle (formerly Pinbot) -----\n            if (lower == \"pinnacle\")\n            {\n                if (string.IsNullOrWhiteSpace(dto.ApiKey))\n                    return \"❌ API Key is required for Pinnacle.\";\n\n                // Pinnacle requires either phone number id OR WABA id in the path\n                var pathId =\n                    !string.IsNullOrWhiteSpace(dto.PhoneNumberId) ? dto.PhoneNumberId!.Trim() :\n                    !string.IsNullOrWhiteSpace(dto.WabaId) ? dto.WabaId!.Trim() :\n                    null;\n\n                if (string.IsNullOrWhiteSpace(pathId))\n                    return \"❌ Provide PhoneNumberId or WabaId for Pinnacle.\";\n\n                if (string.IsNullOrWhiteSpace(dto.WhatsAppBusinessNumber))\n                    return \"❌ WhatsApp Business Number is required for Pinnacle test.\";\n\n                var url = $\"{baseUrl}/{pathId}/messages\";\n                var payload = new\n                {\n                    to = dto.WhatsAppBusinessNumber,\n                    type = \"text\",\n                    text = new { body = \"Test message\" },\n                    messaging_product = \"whatsapp\"\n                };\n\n                using var req = new HttpRequestMessage(HttpMethod.Post, url);\n                req.Headers.TryAddWithoutValidation(\"apikey\", dto.ApiKey);\n                req.Content = new StringContent(JsonSerializer.Serialize(payload), Encoding.UTF8, \"application/json\");\n\n                var res = await http.SendAsync(req);\n                var body = await res.Content.ReadAsStringAsync();\n\n                if (!res.IsSuccessStatusCode)\n                {\n                    if ((int)res.StatusCode == 401 || (int)res.StatusCode == 403)\n                        return $\"❌ Pinnacle rejected the API key for id '{pathId}'. Verify the key and id. Body: {body}\";\n\n                    return $\"❌ Pinnacle test failed ({(int)res.StatusCode}). Body: {body}\";\n                }\n\n                return \"✅ Pinnacle API key and endpoint are reachable.\";\n            }\n\n            return $\"❌ Unsupported provider: {dto.Provider}\";\n        }\n\n        // ✅ UPDATED: read from WhatsAppPhoneNumbers (default by provider), fallback to mirrored settings value\n        public async Task<string?> GetSenderNumberAsync(Guid businessId)\n        {\n            // 1) Find this business's active provider\n            var providerRaw = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .Where(s => s.BusinessId == businessId && s.IsActive)\n                .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n                .Select(s => s.Provider)\n                .FirstOrDefaultAsync();\n\n            if (string.IsNullOrWhiteSpace(providerRaw))\n                return null;\n\n            // Canonical provider (\"META_CLOUD\" | \"PINNACLE\")\n            var provider = providerRaw.Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n            var providerLc = provider.ToLowerInvariant();\n\n            // 2) Prefer the default active number for THAT provider\n            var number = await _dbContext.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == businessId &&\n                            n.IsActive &&\n                            n.Provider.ToLower() == providerLc)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .Select(n => n.WhatsAppBusinessNumber)\n                .FirstOrDefaultAsync();\n\n            if (!string.IsNullOrWhiteSpace(number))\n                return number;\n\n            // 3) Fallback: any active number for this business (regardless of provider)\n            number = await _dbContext.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.BusinessId == businessId && n.IsActive)\n                .OrderByDescending(n => n.IsDefault)\n                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                .Select(n => n.WhatsAppBusinessNumber)\n                .FirstOrDefaultAsync();\n\n            return string.IsNullOrWhiteSpace(number) ? null : number;\n        }\n\n        public async Task<string> GetCallbackUrlAsync(Guid businessId, string appBaseUrl)\n        {\n            var s = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive);\n\n            if (!string.IsNullOrWhiteSpace(s?.WebhookCallbackUrl))\n                return s!.WebhookCallbackUrl!;\n\n            return $\"{appBaseUrl.TrimEnd('/')}/api/webhookcallback\";\n        }\n\n        public async Task<IReadOnlyList<WhatsAppSettingEntity>> GetAllForBusinessAsync(Guid businessId)\n        {\n            // Return all rows (one per provider) for this business + include numbers collection\n            var items = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .Where(s => s.BusinessId == businessId)\n                .Include(s => s.WhatsAppBusinessNumbers) // ✅ correct navigation include\n                .OrderBy(s => s.Provider)\n                .ToListAsync();\n\n            return items.AsReadOnly();\n        }\n\n        public async Task<WhatsAppSettingEntity?> GetSettingsByBusinessIdAndProviderAsync(Guid businessId, string provider)\n        {\n            if (string.IsNullOrWhiteSpace(provider)) return null;\n            var prov = provider.Trim();\n\n            // case-insensitive provider match\n            return await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .FirstOrDefaultAsync(s => s.BusinessId == businessId && s.Provider.ToLower() == prov.ToLower());\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Services/WhatsAppTemplateFetcherService.cs",
      "sha256": "fc3b6d2edf876703dc48a9e8cc52bf0ad59e76c10c894460b33d15c0b82e9d1c",
      "language": "csharp",
      "size": 62589,
      "content": "using Microsoft.EntityFrameworkCore;\nusing Newtonsoft.Json;\nusing Newtonsoft.Json.Linq;\nusing System.Net.Http.Headers;\nusing System.Security.Claims;\nusing System.Text.Json;\nusing System.Text.RegularExpressions;\nusing xbytechat.api;\nusing xbytechat.api.AuthModule.Models;\nusing xbytechat.api.Shared;\nusing xbytechat.api.WhatsAppSettings.DTOs;\nusing xbytechat.api.WhatsAppSettings.Helpers;\nusing DTO = xbytechat.api.WhatsAppSettings.DTOs;\nnamespace xbytechat_api.WhatsAppSettings.Services\n{\n\n    public class WhatsAppTemplateFetcherService : IWhatsAppTemplateFetcherService\n    {\n        private readonly AppDbContext _dbContext;\n        private readonly HttpClient _httpClient;\n        private readonly ILogger<WhatsAppTemplateFetcherService> _logger;\n        private readonly IHttpContextAccessor _httpContextAccessor;\n        public WhatsAppTemplateFetcherService(AppDbContext dbContext, HttpClient httpClient, ILogger<WhatsAppTemplateFetcherService> logger, IHttpContextAccessor httpContextAccessor)\n        {\n            _dbContext = dbContext;\n            _httpClient = httpClient;\n            _logger = logger;\n            _httpContextAccessor = httpContextAccessor;\n        }\n        public async Task<List<TemplateMetadataDto>> FetchTemplatesAsync(Guid businessId)\n        {\n            var templates = new List<TemplateMetadataDto>();\n\n            var setting = await _dbContext.WhatsAppSettings\n                .FirstOrDefaultAsync(x => x.BusinessId == businessId && x.IsActive);\n\n            if (setting == null)\n            {\n                _logger.LogWarning(\"WhatsApp Settings not found for BusinessId: {BusinessId}\", businessId);\n                return templates;\n            }\n\n            // Canonical provider\n            var provider = (setting.Provider ?? string.Empty)\n                .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n\n            // Common base url normalization\n            var rawBase = (setting.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n\n            try\n            {\n                // ==================== META_CLOUD ====================\n                if (provider == \"META_CLOUD\")\n                {\n                    var baseUrl = string.IsNullOrWhiteSpace(rawBase)\n                        ? \"https://graph.facebook.com/v22.0\"\n                        : rawBase;\n\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey) || string.IsNullOrWhiteSpace(setting.WabaId))\n                    {\n                        _logger.LogWarning(\"Missing Meta ApiKey or WABA ID for BusinessId: {BusinessId}\", businessId);\n                        return templates;\n                    }\n\n                    _httpClient.DefaultRequestHeaders.Authorization =\n                        new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n\n                    var nextUrl = $\"{baseUrl}/{setting.WabaId!.Trim()}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        var response = await _httpClient.GetAsync(nextUrl);\n                        var json = await response.Content.ReadAsStringAsync();\n                        _logger.LogInformation(\"📦 Meta Template API Raw JSON for {BusinessId}:\\n{Json}\", setting.BusinessId, json);\n\n                        if (!response.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"❌ Failed to fetch templates from Meta: {Response}\", json);\n                            break;\n                        }\n\n                        dynamic parsed = JsonConvert.DeserializeObject(json);\n                        templates.AddRange(ParseTemplatesFromMetaLikePayload(parsed));\n                        nextUrl = parsed?.paging?.next?.ToString();\n                    }\n\n                    return templates;\n                }\n\n                // ==================== PINNACLE ====================\n                if (provider == \"PINNACLE\")\n                {\n                    // Ensure base has /v3\n                    var baseUrl = string.IsNullOrWhiteSpace(rawBase) ? \"https://partnersv1.pinbot.ai\" : rawBase;\n                    if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase)) baseUrl += \"/v3\";\n\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                    {\n                        _logger.LogWarning(\"Pinnacle ApiKey missing for BusinessId: {BusinessId}\", businessId);\n                        return templates;\n                    }\n\n                    // Prefer WABA; otherwise use the DEFAULT phoneNumberId for this business+provider\n                    var pathId = !string.IsNullOrWhiteSpace(setting.WabaId)\n                        ? setting.WabaId!.Trim()\n                        : await _dbContext.WhatsAppPhoneNumbers\n                            .AsNoTracking()\n                            .Where(p => p.BusinessId == businessId\n                                        && p.IsActive\n                                        && p.Provider.ToUpper() == \"PINNACLE\")\n                            .OrderByDescending(p => p.IsDefault)\n                            .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                            .Select(p => p.PhoneNumberId)\n                            .FirstOrDefaultAsync();\n\n                    if (string.IsNullOrWhiteSpace(pathId))\n                    {\n                        _logger.LogWarning(\"Pinnacle path id missing (WabaId or default PhoneNumberId) for BusinessId: {BusinessId}\", businessId);\n                        return templates;\n                    }\n\n                    // Headers Pinnacle commonly accepts\n                    _httpClient.DefaultRequestHeaders.Remove(\"apikey\");\n                    _httpClient.DefaultRequestHeaders.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n\n                    var nextUrl = $\"{baseUrl}/{pathId}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        var response = await _httpClient.GetAsync(nextUrl);\n                        var json = await response.Content.ReadAsStringAsync();\n                        _logger.LogInformation(\"📦 Pinnacle Template API Raw JSON for {BusinessId}:\\n{Json}\", setting.BusinessId, json);\n\n                        if (!response.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"❌ Failed to fetch templates from Pinnacle: {Response}\", json);\n                            break;\n                        }\n\n                        // Many BSPs mirror Meta’s shape; also accept { data: [...] }\n                        dynamic parsed = JsonConvert.DeserializeObject(json);\n                        templates.AddRange(ParseTemplatesFromMetaLikePayload(parsed));\n                        nextUrl = parsed?.paging?.next?.ToString();\n                        if (nextUrl == null) break; // if their API doesn’t paginate\n                    }\n\n                    return templates;\n                }\n\n                // ==================== UNKNOWN ====================\n                _logger.LogInformation(\"Provider {Provider} does not support listing via API in this build.\", provider);\n                return templates;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Exception while fetching WhatsApp templates for provider {Provider}.\", provider);\n                return templates;\n            }\n        }\n\n        private static IEnumerable<TemplateMetadataDto> ParseTemplatesFromMetaLikePayload(dynamic parsed)\n        {\n            var list = new List<TemplateMetadataDto>();\n            if (parsed == null) return list;\n\n            // Prefer parsed.data; fall back to parsed.templates\n            var collection = parsed.data ?? parsed.templates;\n            if (collection == null) return list;\n\n            foreach (var tpl in collection)\n            {\n                string name = tpl.name?.ToString() ?? \"\";\n                string language = tpl.language?.ToString() ?? \"en_US\";\n                string body = \"\";\n                bool hasImageHeader = false;\n                var buttons = new List<ButtonMetadataDto>();\n\n                // components may be null for some BSPs\n                var components = tpl.components;\n                if (components != null)\n                {\n                    foreach (var component in components)\n                    {\n                        string type = component.type?.ToString()?.ToUpperInvariant();\n\n                        if (type == \"BODY\")\n                            body = component.text?.ToString() ?? \"\";\n\n                        if (type == \"HEADER\" && (component.format?.ToString()?.ToUpperInvariant() == \"IMAGE\"))\n                            hasImageHeader = true;\n\n                        if (type == \"BUTTONS\" && component.buttons != null)\n                        {\n                            foreach (var button in component.buttons)\n                            {\n                                try\n                                {\n                                    string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n                                    string text = button.text?.ToString() ?? \"\";\n                                    int index = buttons.Count;\n\n                                    string subType = btnType switch\n                                    {\n                                        \"URL\" => \"url\",\n                                        \"PHONE_NUMBER\" => \"voice_call\",\n                                        \"QUICK_REPLY\" => \"quick_reply\",\n                                        \"COPY_CODE\" => \"copy_code\",\n                                        \"CATALOG\" => \"catalog\",\n                                        \"FLOW\" => \"flow\",\n                                        \"REMINDER\" => \"reminder\",\n                                        \"ORDER_DETAILS\" => \"order_details\",\n                                        _ => \"unknown\"\n                                    };\n\n                                    string? paramValue =\n                                        button.url != null ? button.url.ToString() :\n                                        button.phone_number != null ? button.phone_number.ToString() :\n                                        button.coupon_code != null ? button.coupon_code.ToString() :\n                                        button.flow_id != null ? button.flow_id.ToString() :\n                                        null;\n\n                                    // If BSP marks dynamic examples like Meta, respect them; otherwise be lenient\n                                    buttons.Add(new ButtonMetadataDto\n                                    {\n                                        Text = text,\n                                        Type = btnType,\n                                        SubType = subType,\n                                        Index = index,\n                                        ParameterValue = paramValue ?? \"\"\n                                    });\n                                }\n                                catch { /* ignore per-button parsing issues */ }\n                            }\n                        }\n                    }\n                }\n\n                int placeholderCount = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n\n                list.Add(new TemplateMetadataDto\n                {\n                    Name = name,\n                    Language = language,\n                    Body = body,\n                    PlaceholderCount = placeholderCount,\n                    HasImageHeader = hasImageHeader,\n                    ButtonParams = buttons\n                });\n            }\n\n            return list;\n        }\n\n        public async Task<List<TemplateForUIResponseDto>> FetchAllTemplatesAsync()\n        {\n            var result = new List<TemplateForUIResponseDto>();\n\n            var user = _httpContextAccessor.HttpContext.User;\n            var businessId = user.GetBusinessId();\n            _logger.LogInformation(\"🔎 Fetching templates for BusinessId {BusinessId}\", businessId);\n\n            var setting = await _dbContext.WhatsAppSettings\n                .AsNoTracking()\n                .FirstOrDefaultAsync(s => s.IsActive && s.BusinessId == businessId);\n\n            if (setting == null)\n            {\n                _logger.LogWarning(\"⚠️ No active WhatsApp setting for BusinessId {BusinessId}\", businessId);\n                return result;\n            }\n\n            try\n            {\n                // Canonical provider\n                var provider = (setting.Provider ?? string.Empty)\n                    .Trim().Replace(\"-\", \"_\").Replace(\" \", \"_\").ToUpperInvariant();\n\n                // Normalize base URL once\n                var baseRaw = (setting.ApiUrl ?? string.Empty).Trim().TrimEnd('/');\n\n                if (provider == \"META_CLOUD\")\n                {\n                    // Meta requires ApiKey + WABA\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey) || string.IsNullOrWhiteSpace(setting.WabaId))\n                    {\n                        _logger.LogWarning(\"⚠️ Missing ApiKey or WabaId for Meta Cloud (Biz {BusinessId})\", businessId);\n                        return result;\n                    }\n\n                    var baseUrl = string.IsNullOrWhiteSpace(baseRaw) ? \"https://graph.facebook.com/v22.0\" : baseRaw;\n                    var nextUrl = $\"{baseUrl}/{setting.WabaId!.Trim()}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        using var req = new HttpRequestMessage(HttpMethod.Get, nextUrl);\n                        req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n\n                        using var res = await _httpClient.SendAsync(req);\n                        var json = await res.Content.ReadAsStringAsync();\n\n                        _logger.LogInformation(\"📦 Meta Template API (Biz {BusinessId}) payload:\\n{Json}\", businessId, json);\n\n                        if (!res.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"❌ Meta template fetch failed (Biz {BusinessId}): {Json}\", businessId, json);\n                            break;\n                        }\n\n                        result.AddRange(ParseMetaTemplates(json));\n                        nextUrl = JsonConvert.DeserializeObject<dynamic>(json)?.paging?.next?.ToString();\n                    }\n                }\n                else if (provider == \"PINNACLE\")\n                {\n                    // Pinnacle requires ApiKey and pathId (WABA or default PhoneNumberId)\n                    if (string.IsNullOrWhiteSpace(setting.ApiKey))\n                    {\n                        _logger.LogWarning(\"⚠️ Missing ApiKey for Pinnacle (Biz {BusinessId})\", businessId);\n                        return result;\n                    }\n\n                    // Prefer WABA; otherwise pull DEFAULT phoneNumberId from WhatsAppPhoneNumbers\n                    string? pathId = !string.IsNullOrWhiteSpace(setting.WabaId)\n                        ? setting.WabaId!.Trim()\n                        : await _dbContext.WhatsAppPhoneNumbers\n                            .AsNoTracking()\n                            .Where(p => p.BusinessId == businessId\n                                        && p.IsActive\n                                        && p.Provider.ToUpper() == \"PINNACLE\")\n                            .OrderByDescending(p => p.IsDefault)\n                            .ThenByDescending(p => p.UpdatedAt ?? p.CreatedAt)\n                            .Select(p => p.PhoneNumberId)\n                            .FirstOrDefaultAsync();\n\n                    if (string.IsNullOrWhiteSpace(pathId))\n                    {\n                        _logger.LogWarning(\"⚠️ Missing WabaId or default PhoneNumberId for Pinnacle (Biz {BusinessId})\", businessId);\n                        return result;\n                    }\n\n                    var baseUrl = string.IsNullOrWhiteSpace(baseRaw) ? \"https://partnersv1.pinbot.ai\" : baseRaw;\n                    if (!baseUrl.EndsWith(\"/v3\", StringComparison.OrdinalIgnoreCase)) baseUrl += \"/v3\";\n\n                    var nextUrl = $\"{baseUrl}/{pathId}/message_templates?limit=100\";\n\n                    while (!string.IsNullOrWhiteSpace(nextUrl))\n                    {\n                        using var req = new HttpRequestMessage(HttpMethod.Get, nextUrl);\n                        // Common header names Pinnacle accepts\n                        req.Headers.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n                        req.Headers.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n\n                        using var res = await _httpClient.SendAsync(req);\n                        var json = await res.Content.ReadAsStringAsync();\n\n                        _logger.LogInformation(\"📦 Pinnacle Template API (Biz {BusinessId}) payload:\\n{Json}\", businessId, json);\n\n                        if (!res.IsSuccessStatusCode)\n                        {\n                            _logger.LogError(\"❌ Pinnacle template fetch failed (Biz {BusinessId}): {Json}\", businessId, json);\n                            break;\n                        }\n\n                        // Your existing mapper handles Pinnacle/Meta-like shapes\n                        result.AddRange(ParsePinnacleTemplates(json));\n\n                        // If their API paginates like Meta, follow it; otherwise we’re done\n                        nextUrl = JsonConvert.DeserializeObject<dynamic>(json)?.paging?.next?.ToString();\n                        if (nextUrl == null) break;\n                    }\n                }\n                else\n                {\n                    _logger.LogWarning(\"⚠️ Unknown provider '{Provider}' for Biz {BusinessId}\", provider, businessId);\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"❌ Exception while fetching templates for BusinessId {BusinessId}\", businessId);\n            }\n\n            return result;\n        }\n\n        private List<TemplateForUIResponseDto> ParseMetaTemplates(string json)\n        {\n            var list = new List<TemplateForUIResponseDto>();\n            dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n\n            foreach (var tpl in parsed.data)\n            {\n                string status = (tpl.status?.ToString() ?? \"\").ToUpperInvariant();\n                if (status != \"APPROVED\" && status != \"ACTIVE\") continue;\n\n                list.Add(BuildTemplateDtoFromComponents(tpl));\n            }\n\n            return list;\n        }\n\n        private List<TemplateForUIResponseDto> ParsePinnacleTemplates(string json)\n        {\n            var list = new List<TemplateForUIResponseDto>();\n            dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n\n            if (parsed?.data == null) return list;\n\n            foreach (var tpl in parsed.data)\n            {\n                // Pinnacle may not use status like Meta, adjust filter if needed\n                list.Add(BuildTemplateDtoFromComponents(tpl));\n            }\n\n            return list;\n        }\n\n        private TemplateForUIResponseDto BuildTemplateDtoFromComponents(dynamic tpl)\n        {\n            string name = tpl.name;\n            string language = tpl.language ?? \"en_US\";\n            string body = \"\";\n            bool hasImageHeader = false;\n            var buttons = new List<ButtonMetadataDto>();\n\n            foreach (var component in tpl.components)\n            {\n                string type = component.type?.ToString()?.ToUpperInvariant();\n\n                if (type == \"BODY\")\n                    body = component.text?.ToString() ?? \"\";\n\n                if (type == \"HEADER\" && (component.format?.ToString()?.ToUpperInvariant() == \"IMAGE\"))\n                    hasImageHeader = true;\n\n                if (type == \"BUTTONS\")\n                {\n                    foreach (var button in component.buttons)\n                    {\n                        string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n                        string text = button.text?.ToString() ?? \"\";\n                        int index = buttons.Count;\n\n                        string subType = btnType switch\n                        {\n                            \"URL\" => \"url\",\n                            \"PHONE_NUMBER\" => \"voice_call\",\n                            \"QUICK_REPLY\" => \"quick_reply\",\n                            \"COPY_CODE\" => \"copy_code\",\n                            \"CATALOG\" => \"catalog\",\n                            \"FLOW\" => \"flow\",\n                            \"REMINDER\" => \"reminder\",\n                            \"ORDER_DETAILS\" => \"order_details\",\n                            _ => \"unknown\"\n                        };\n\n                        string? paramValue = button.url?.ToString() ?? button.phone_number?.ToString();\n\n                        if (subType == \"unknown\") continue;\n\n                        buttons.Add(new ButtonMetadataDto\n                        {\n                            Text = text,\n                            Type = btnType,\n                            SubType = subType,\n                            Index = index,\n                            ParameterValue = paramValue ?? \"\"\n                        });\n                    }\n                }\n            }\n\n            int placeholderCount = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n\n            return new TemplateForUIResponseDto\n            {\n                Name = name,\n                Language = language,\n                Body = body,\n                ParametersCount = placeholderCount,\n                HasImageHeader = hasImageHeader,\n                ButtonParams = buttons\n            };\n        }\n\n        //public async Task<TemplateMetadataDto?> GetTemplateByNameAsync(Guid businessId, string templateName, bool includeButtons)\n        //{\n        //    var setting = await _dbContext.WhatsAppSettings\n        //        .FirstOrDefaultAsync(x => x.IsActive && x.BusinessId == businessId);\n\n        //    if (setting == null)\n        //    {\n        //        _logger.LogWarning(\"❌ WhatsApp settings not found for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    var provider = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n        //    var wabaId = setting.WabaId?.Trim();\n        //    if (string.IsNullOrWhiteSpace(wabaId))\n        //    {\n        //        _logger.LogWarning(\"❌ Missing WABA ID for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    // Build URL + request with per-request headers\n        //    string url;\n        //    using var req = new HttpRequestMessage(HttpMethod.Get, \"\");\n\n        //    if (provider == \"pinnacle\")\n        //    {\n        //        // Pinnacle: require ApiKey; use WabaId for template listing\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"❌ ApiKey missing for Pinnacle provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://partnersv1.pinbot.ai/v3\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        // add header variants\n        //        req.Headers.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n        //        req.Headers.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n        //        // safety: also append as query (some edges require it)\n        //        url = url.Contains(\"apikey=\") ? url : $\"{url}&apikey={Uri.EscapeDataString(setting.ApiKey)}\";\n        //    }\n        //    else // meta_cloud\n        //    {\n        //        // Meta Cloud: require ApiKey; use WabaId for template listing\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"❌ ApiKey missing for Meta provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://graph.facebook.com/v22.0\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n        //    }\n\n        //    req.RequestUri = new Uri(url);\n        //    var response = await _httpClient.SendAsync(req);\n        //    var json = await response.Content.ReadAsStringAsync();\n\n        //    if (!response.IsSuccessStatusCode)\n        //    {\n        //        _logger.LogError(\"❌ Failed to fetch templates (provider={Provider}) for BusinessId {BusinessId}: HTTP {Status} Body: {Body}\",\n        //            provider, businessId, (int)response.StatusCode, json);\n        //        return null;\n        //    }\n\n        //    try\n        //    {\n        //        dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n        //        var data = parsed?.data;\n        //        if (data == null)\n        //        {\n        //            _logger.LogWarning(\"⚠️ No 'data' array in template response (provider={Provider})\", provider);\n        //            return null;\n        //        }\n\n        //        foreach (var tpl in data)\n        //        {\n        //            string name = tpl.name;\n        //            if (!name.Equals(templateName, StringComparison.OrdinalIgnoreCase))\n        //                continue;\n\n        //            string language = tpl.language != null ? (string)tpl.language : \"en_US\";\n        //            string body = \"\";\n        //            var buttons = new List<ButtonMetadataDto>();\n        //            bool hasImageHeader = false;\n\n        //            // components loop\n        //            foreach (var component in tpl.components)\n        //            {\n        //                string type = component.type?.ToString()?.ToUpperInvariant();\n\n        //                if (type == \"BODY\")\n        //                {\n        //                    try { body = component.text?.ToString() ?? \"\"; }\n        //                    catch { body = \"\"; }\n        //                }\n\n        //                if (type == \"HEADER\")\n        //                {\n        //                    string format = component.format?.ToString()?.ToUpperInvariant();\n        //                    if (format == \"IMAGE\") hasImageHeader = true;\n        //                }\n\n        //                if (includeButtons && type == \"BUTTONS\")\n        //                {\n        //                    foreach (var button in component.buttons)\n        //                    {\n        //                        try\n        //                        {\n        //                            string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n        //                            string text = button.text?.ToString() ?? \"\";\n        //                            int index = buttons.Count;\n\n        //                            // normalize sub-type for our app\n        //                            string subType = btnType switch\n        //                            {\n        //                                \"URL\" => \"url\",\n        //                                \"PHONE_NUMBER\" => \"voice_call\",\n        //                                \"QUICK_REPLY\" => \"quick_reply\",\n        //                                \"COPY_CODE\" => \"copy_code\",\n        //                                \"CATALOG\" => \"catalog\",\n        //                                \"FLOW\" => \"flow\",\n        //                                \"REMINDER\" => \"reminder\",\n        //                                \"ORDER_DETAILS\" => \"order_details\",\n        //                                _ => \"unknown\"\n        //                            };\n\n        //                            // Known dynamic param extraction\n        //                            string? paramValue = null;\n        //                            if (button.url != null)\n        //                                paramValue = button.url.ToString();\n        //                            else if (button.phone_number != null)\n        //                                paramValue = button.phone_number.ToString();\n        //                            else if (button.coupon_code != null)\n        //                                paramValue = button.coupon_code.ToString();\n        //                            else if (button.flow_id != null)\n        //                                paramValue = button.flow_id.ToString();\n\n        //                            // Skip truly invalid\n        //                            if (subType == \"unknown\" ||\n        //                                (paramValue == null && new[] { \"url\", \"flow\", \"copy_code\" }.Contains(subType)))\n        //                            {\n        //                                _logger.LogWarning(\"⚠️ Skipping button '{Text}' due to unknown type or missing required param.\", text);\n        //                                continue;\n        //                            }\n\n        //                            buttons.Add(new ButtonMetadataDto\n        //                            {\n        //                                Text = text,\n        //                                Type = btnType,\n        //                                SubType = subType,\n        //                                Index = index,\n        //                                ParameterValue = paramValue ?? \"\" // empty for static buttons\n        //                            });\n        //                        }\n        //                        catch (Exception exBtn)\n        //                        {\n        //                            _logger.LogWarning(exBtn, \"⚠️ Failed to parse button in template {TemplateName}\", name);\n        //                        }\n        //                    }\n        //                }\n        //            }\n\n        //            // Count {{n}} placeholders in body\n        //            int paramCount = Regex.Matches(body ?? \"\", \"{{\\\\s*\\\\d+\\\\s*}}\").Count;\n\n        //            return new TemplateMetadataDto\n        //            {\n        //                Name = name,\n        //                Language = language,\n        //                Body = body,\n        //                PlaceholderCount = paramCount,\n        //                HasImageHeader = hasImageHeader,\n        //                ButtonParams = includeButtons ? buttons : new List<ButtonMetadataDto>()\n        //            };\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"❌ Exception while parsing template response\");\n        //    }\n\n        //    return null;\n        //}\n        //public async Task<TemplateMetadataDto?> GetTemplateByNameAsync(Guid businessId, string templateName, bool includeButtons)\n        //{\n        //    var setting = await _dbContext.WhatsAppSettings\n        //        .FirstOrDefaultAsync(x => x.IsActive && x.BusinessId == businessId);\n\n        //    if (setting == null)\n        //    {\n        //        _logger.LogWarning(\"❌ WhatsApp settings not found for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    var provider = (setting.Provider ?? \"meta_cloud\").Trim().ToLowerInvariant();\n        //    var wabaId = setting.WabaId?.Trim();\n        //    if (string.IsNullOrWhiteSpace(wabaId))\n        //    {\n        //        _logger.LogWarning(\"❌ Missing WABA ID for business: {BusinessId}\", businessId);\n        //        return null;\n        //    }\n\n        //    // Build URL + request with per-request headers\n        //    string url;\n        //    using var req = new HttpRequestMessage(HttpMethod.Get, \"\");\n\n        //    if (provider == \"pinnacle\")\n        //    {\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"❌ ApiKey missing for Pinnacle provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://partnersv1.pinbot.ai/v3\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        req.Headers.TryAddWithoutValidation(\"apikey\", setting.ApiKey);\n        //        req.Headers.TryAddWithoutValidation(\"x-api-key\", setting.ApiKey);\n        //        url = url.Contains(\"apikey=\") ? url : $\"{url}&apikey={Uri.EscapeDataString(setting.ApiKey)}\";\n        //    }\n        //    else // meta_cloud\n        //    {\n        //        if (string.IsNullOrWhiteSpace(setting.ApiKey))\n        //        {\n        //            _logger.LogWarning(\"❌ ApiKey missing for Meta provider (BusinessId {BusinessId})\", businessId);\n        //            return null;\n        //        }\n\n        //        var baseUrl = string.IsNullOrWhiteSpace(setting.ApiUrl)\n        //            ? \"https://graph.facebook.com/v22.0\"\n        //            : setting.ApiUrl.TrimEnd('/');\n\n        //        url = $\"{baseUrl}/{wabaId}/message_templates?limit=200\";\n        //        req.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", setting.ApiKey);\n        //    }\n\n        //    req.RequestUri = new Uri(url);\n        //    var response = await _httpClient.SendAsync(req);\n        //    var json = await response.Content.ReadAsStringAsync();\n\n        //    if (!response.IsSuccessStatusCode)\n        //    {\n        //        _logger.LogError(\"❌ Failed to fetch templates (provider={Provider}) for BusinessId {BusinessId}: HTTP {Status} Body: {Body}\",\n        //            provider, businessId, (int)response.StatusCode, json);\n        //        return null;\n        //    }\n\n        //    try\n        //    {\n        //        dynamic parsed = JsonConvert.DeserializeObject<dynamic>(json);\n        //        var data = parsed?.data;\n        //        if (data == null)\n        //        {\n        //            _logger.LogWarning(\"⚠️ No 'data' array in template response (provider={Provider})\", provider);\n        //            return null;\n        //        }\n\n        //        foreach (var tpl in data)\n        //        {\n        //            string name = tpl.name;\n        //            if (!name.Equals(templateName, StringComparison.OrdinalIgnoreCase))\n        //                continue;\n\n        //            string language = tpl.language != null ? (string)tpl.language : \"en_US\";\n\n        //            // ---- CHANGES START ----\n        //            string body = \"\";\n        //            string headerText = \"\";                    // collect TEXT header\n        //            bool hasImageHeader = false;\n        //            var buttons = new List<ButtonMetadataDto>();\n\n        //            foreach (var component in tpl.components)\n        //            {\n        //                string type = component.type?.ToString()?.ToUpperInvariant();\n\n        //                if (type == \"HEADER\")\n        //                {\n        //                    string format = component.format?.ToString()?.ToUpperInvariant();\n        //                    if (format == \"IMAGE\")\n        //                        hasImageHeader = true;\n\n        //                    // capture header text (can include {{n}})\n        //                    if (format == \"TEXT\")\n        //                    {\n        //                        try { headerText = component.text?.ToString() ?? \"\"; }\n        //                        catch { headerText = \"\"; }\n        //                    }\n        //                }\n\n        //                if (type == \"BODY\")\n        //                {\n        //                    try { body = component.text?.ToString() ?? \"\"; }\n        //                    catch { body = \"\"; }\n        //                }\n\n        //                if (includeButtons && type == \"BUTTONS\")\n        //                {\n        //                    foreach (var button in component.buttons)\n        //                    {\n        //                        try\n        //                        {\n        //                            string btnType = button.type?.ToString()?.ToUpperInvariant() ?? \"\";\n        //                            string text = button.text?.ToString() ?? \"\";\n        //                            int index = buttons.Count;\n\n        //                            string subType = btnType switch\n        //                            {\n        //                                \"URL\" => \"url\",\n        //                                \"PHONE_NUMBER\" => \"voice_call\",\n        //                                \"QUICK_REPLY\" => \"quick_reply\",\n        //                                \"COPY_CODE\" => \"copy_code\",\n        //                                \"CATALOG\" => \"catalog\",\n        //                                \"FLOW\" => \"flow\",\n        //                                \"REMINDER\" => \"reminder\",\n        //                                \"ORDER_DETAILS\" => \"order_details\",\n        //                                _ => \"unknown\"\n        //                            };\n\n        //                            string? paramValue = null;\n        //                            if (button.url != null) paramValue = button.url.ToString();\n        //                            else if (button.phone_number != null) paramValue = button.phone_number.ToString();\n        //                            else if (button.coupon_code != null) paramValue = button.coupon_code.ToString();\n        //                            else if (button.flow_id != null) paramValue = button.flow_id.ToString();\n\n        //                            if (subType == \"unknown\" ||\n        //                                (paramValue == null && new[] { \"url\", \"flow\", \"copy_code\" }.Contains(subType)))\n        //                            {\n        //                                _logger.LogWarning(\"⚠️ Skipping button '{Text}' due to unknown type or missing required param.\", text);\n        //                                continue;\n        //                            }\n\n        //                            buttons.Add(new ButtonMetadataDto\n        //                            {\n        //                                Text = text,\n        //                                Type = btnType,\n        //                                SubType = subType,\n        //                                Index = index,\n        //                                ParameterValue = paramValue ?? \"\"\n        //                            });\n        //                        }\n        //                        catch (Exception exBtn)\n        //                        {\n        //                            _logger.LogWarning(exBtn, \"⚠️ Failed to parse button in template {TemplateName}\", name);\n        //                        }\n        //                    }\n        //                }\n        //            }\n\n        //            // Combine header + body so your DB stores what users actually see\n        //            var combined = string.IsNullOrWhiteSpace(headerText)\n        //                ? body\n        //                : (string.IsNullOrWhiteSpace(body) ? headerText : $\"{headerText}\\n{body}\");\n\n        //            // Count {{n}} across header+body\n        //            int paramCount = Regex.Matches(combined ?? \"\", \"{{\\\\s*\\\\d+\\\\s*}}\").Count;\n        //            // ---- CHANGES END ----\n\n        //            return new TemplateMetadataDto\n        //            {\n        //                Name = name,\n        //                Language = language,\n        //                Body = combined,                         // return combined text\n        //                PlaceholderCount = paramCount,\n        //                HasImageHeader = hasImageHeader,\n        //                ButtonParams = includeButtons ? buttons : new List<ButtonMetadataDto>()\n        //            };\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"❌ Exception while parsing template response\");\n        //    }\n\n        //    return null;\n        //}\n        // Features/CampaignModule/Services/TemplateFetcherService.cs\n\n\n\n        public async Task<TemplateMetadataDto?> GetTemplateByNameAsync(\n            Guid businessId,\n            string templateName,\n            bool includeButtons)\n        {\n            var row = await _dbContext.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.IsActive && t.Name == templateName)\n                .OrderByDescending(t => t.UpdatedAt) // or LastSyncedAt if you prefer\n                .FirstOrDefaultAsync();\n\n            if (row == null) return null;\n\n            string headerKind = \"none\";\n            string combinedBody = row.Body ?? string.Empty;\n            int placeholderCount = 0;\n\n            if (!string.IsNullOrWhiteSpace(row.RawJson))\n            {\n                // Use canonical computation from provider JSON (handles header/body/buttons & NAMED/POSITIONAL)\n                var s = TemplateJsonHelper.Summarize(row.RawJson, row.Body);\n                headerKind = s.HeaderKind ?? \"none\";\n                combinedBody = s.CombinedBody ?? string.Empty;\n                placeholderCount = s.PlaceholderCount;\n            }\n            else\n            {\n                // No RawJson: fall back to counting tokens in body and buttons JSON\n                placeholderCount =\n                    CountTokensFlexible(combinedBody) +\n                    CountButtonTokensFromButtonsJson(row.UrlButtons);\n            }\n\n            var buttons = includeButtons ? ParseButtons(row.UrlButtons) : new List<ButtonMetadataDto>();\n\n            return new TemplateMetadataDto\n            {\n                Name = row.Name,\n                Language = row.LanguageCode ?? \"en_US\",\n                Body = combinedBody,\n                PlaceholderCount = placeholderCount,\n                HeaderKind = headerKind,\n                HasImageHeader = string.Equals(headerKind, \"image\", StringComparison.OrdinalIgnoreCase), // back-compat\n                ButtonParams = buttons\n            };\n        }\n\n        // -------- helpers (keep inside the same class) --------\n\n        private static readonly Regex PositionalToken =\n            new(@\"\\{\\{\\s*\\d+\\s*\\}\\}\", RegexOptions.Compiled); // {{1}}, {{ 2 }}, etc.\n\n        private static readonly Regex NamedToken =\n            new(@\"\\{\\{\\s*\\}\\}\", RegexOptions.Compiled);        // {{}} (NAMED format slot)\n\n        private static int CountTokensFlexible(string? text)\n        {\n            if (string.IsNullOrEmpty(text)) return 0;\n            return PositionalToken.Matches(text).Count + NamedToken.Matches(text).Count;\n        }\n\n        private static int CountButtonTokensFromButtonsJson(string? buttonsJson)\n        {\n            if (string.IsNullOrWhiteSpace(buttonsJson)) return 0;\n\n            try\n            {\n                var arr = JArray.Parse(buttonsJson);\n                int total = 0;\n                foreach (var b in arr)\n                {\n                    // Your ButtonsJson comes from ButtonMetadataDto serialization and includes \"ParameterValue\"\n                    var val = b?[\"ParameterValue\"]?.ToString();\n                    total += CountTokensFlexible(val);\n                }\n                return total;\n            }\n            catch\n            {\n                // If ButtonsJson is malformed, don't block reads—just report 0 extras.\n                return 0;\n            }\n        }\n\n\n\n\n        private static string DetectHeaderKind(string? rawJson)\n        {\n            try\n            {\n                var comps = (JToken.Parse(rawJson ?? \"{}\")[\"components\"] as JArray) ?? new JArray();\n                var header = comps.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"HEADER\", StringComparison.OrdinalIgnoreCase));\n                var fmt = ((string?)header?[\"format\"] ?? \"\").ToLowerInvariant(); // \"\", \"text\", \"image\", \"video\", \"document\", \"location\"\n                return string.IsNullOrWhiteSpace(fmt) ? \"none\" : fmt;\n            }\n            catch { return \"none\"; }\n        }\n\n        private static string CombineTextHeaderAndBody(string? rawJson, string? fallbackBody)\n        {\n            var headerText = ExtractTextHeader(rawJson);\n            var bodyText = ExtractBodyText(rawJson);\n            if (string.IsNullOrWhiteSpace(bodyText)) bodyText = fallbackBody ?? \"\";\n            if (!string.IsNullOrWhiteSpace(headerText))\n                return headerText.TrimEnd() + \"\\n\" + (bodyText ?? \"\");\n            return bodyText ?? \"\";\n        }\n\n        private static string ExtractTextHeader(string? rawJson)\n        {\n            try\n            {\n                var comps = (JToken.Parse(rawJson ?? \"{}\")[\"components\"] as JArray) ?? new JArray();\n                var header = comps.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"HEADER\", StringComparison.OrdinalIgnoreCase));\n                if (header == null) return \"\";\n                if (!string.Equals((string?)header[\"format\"], \"TEXT\", StringComparison.OrdinalIgnoreCase)) return \"\";\n                return header[\"text\"]?.ToString() ?? \"\";\n            }\n            catch { return \"\"; }\n        }\n\n        private static string ExtractBodyText(string? rawJson)\n        {\n            try\n            {\n                var comps = (JToken.Parse(rawJson ?? \"{}\")[\"components\"] as JArray) ?? new JArray();\n                var body = comps.FirstOrDefault(c => string.Equals((string?)c?[\"type\"], \"BODY\", StringComparison.OrdinalIgnoreCase));\n                return body?[\"text\"]?.ToString() ?? \"\";\n            }\n            catch { return \"\"; }\n        }\n\n        private static List<ButtonMetadataDto> ParseButtons(string? buttonsJson)\n        {\n            try\n            {\n                var arr = JArray.Parse(string.IsNullOrWhiteSpace(buttonsJson) ? \"[]\" : buttonsJson);\n                return arr.Select(j => new ButtonMetadataDto\n                {\n                    Text = (string?)j[\"Text\"] ?? \"\",\n                    Type = (string?)j[\"Type\"] ?? \"URL\",\n                    SubType = ((string?)j[\"SubType\"] ?? \"url\").ToLowerInvariant(),\n                    Index = (int?)j[\"Index\"] ?? 0,\n                    ParameterValue = (string?)j[\"ParameterValue\"] ?? \"\"\n                }).ToList();\n            }\n            catch { return new List<ButtonMetadataDto>(); }\n        }\n\n\n        private static TemplateMetadataDto? ExtractTemplateFromListJson(string json, string templateName, bool includeButtons)\n        {\n            var root = JObject.Parse(json);\n            var data = root[\"data\"] as JArray;\n            if (data == null) return null;\n\n            foreach (var tplToken in data.OfType<JObject>())\n            {\n                var name = tplToken.Value<string>(\"name\") ?? \"\";\n                if (!name.Equals(templateName, StringComparison.OrdinalIgnoreCase))\n                    continue;\n\n                var language = tplToken.Value<string>(\"language\") ?? \"en_US\";\n                var components = tplToken[\"components\"] as JArray;\n\n                string body = \"\";\n                bool hasImageHeader = false;\n                var buttons = new List<ButtonMetadataDto>();\n\n                if (components != null)\n                {\n                    foreach (var comp in components.OfType<JObject>())\n                    {\n                        var type = (comp.Value<string>(\"type\") ?? \"\").ToUpperInvariant();\n\n                        if (type == \"BODY\")\n                        {\n                            body = comp.Value<string>(\"text\") ?? body;\n                        }\n                        else if (type == \"HEADER\")\n                        {\n                            var fmt = (comp.Value<string>(\"format\") ?? \"\").ToUpperInvariant();\n                            if (fmt == \"IMAGE\") hasImageHeader = true;\n                        }\n                        else if (includeButtons && type == \"BUTTONS\")\n                        {\n                            var btns = comp[\"buttons\"] as JArray;\n                            if (btns == null) continue;\n\n                            var idx = 0;\n                            foreach (var b in btns.OfType<JObject>())\n                            {\n                                var btnTypeRaw = (b.Value<string>(\"type\") ?? \"\").ToUpperInvariant();\n                                var text = b.Value<string>(\"text\") ?? \"\";\n\n                                var subType = btnTypeRaw switch\n                                {\n                                    \"URL\" => \"url\",\n                                    \"PHONE_NUMBER\" => \"voice_call\",\n                                    \"QUICK_REPLY\" => \"quick_reply\",\n                                    \"COPY_CODE\" => \"copy_code\",\n                                    \"CATALOG\" => \"catalog\",\n                                    \"FLOW\" => \"flow\",\n                                    \"REMINDER\" => \"reminder\",\n                                    \"ORDER_DETAILS\" => \"order_details\",\n                                    _ => \"unknown\"\n                                };\n\n                                string? paramValue =\n                                    b.Value<string>(\"url\") ??\n                                    b.Value<string>(\"phone_number\") ??\n                                    b.Value<string>(\"coupon_code\") ??\n                                    b.Value<string>(\"flow_id\");\n\n                                // Skip unknown or missing required dynamic values\n                                if (subType == \"unknown\") continue;\n                                if ((subType is \"url\" or \"flow\" or \"copy_code\") && string.IsNullOrWhiteSpace(paramValue))\n                                    continue;\n\n                                buttons.Add(new ButtonMetadataDto\n                                {\n                                    Text = text,\n                                    Type = btnTypeRaw,\n                                    SubType = subType,\n                                    Index = idx++,\n                                    ParameterValue = paramValue ?? \"\"\n                                });\n                            }\n                        }\n                    }\n                }\n\n                var paramCount = Regex.Matches(body ?? \"\", \"{{(.*?)}}\").Count;\n\n                return new TemplateMetadataDto\n                {\n                    Name = name,\n                    Language = language,\n                    Body = body ?? \"\",\n                    PlaceholderCount = paramCount,\n                    HasImageHeader = hasImageHeader,\n                    ButtonParams = includeButtons ? buttons : new List<ButtonMetadataDto>()\n                };\n            }\n\n            return null;\n        }\n\n        // --- NEW: DB-backed meta projection methods ---\n        // List all template meta for a business (optionally filter by provider)\n        public async Task<IReadOnlyList<TemplateMetaDto>> GetTemplatesMetaAsync(Guid businessId, string? provider = null)\n        {\n            var q = _dbContext.WhatsAppTemplates\n                              .AsNoTracking()\n                              .Where(t => t.BusinessId == businessId && t.IsActive);\n\n            if (!string.IsNullOrWhiteSpace(provider))\n                q = q.Where(t => t.Provider == provider);\n\n            // Pull only what we need, then map (keeps allocations low on hot paths)\n            var rows = await q.ToListAsync();\n            var result = new List<TemplateMetaDto>(rows.Count);\n            foreach (var row in rows)\n                result.Add(MapRowToMeta(row));\n            return result;\n        }\n\n        // Get a single template meta by name (+ optional language/provider)\n        public async Task<TemplateMetaDto?> GetTemplateMetaAsync(\n    Guid businessId,\n    string templateName,\n    string? language = null,\n    string? provider = null)\n        {\n            if (string.IsNullOrWhiteSpace(templateName))\n                return null;\n\n            var lang = language?.Trim();\n            var prov = string.IsNullOrWhiteSpace(provider) ? null : provider!.Trim().ToUpperInvariant();\n\n            // Base: active rows for this business\n            var q = _dbContext.WhatsAppTemplates\n                .AsNoTracking()\n                .Where(t => t.BusinessId == businessId && t.IsActive);\n\n            // First try: treat templateName as provider TemplateId (exact match)\n            var byIdQ = q.Where(t => t.TemplateId == templateName);\n            if (prov != null) byIdQ = byIdQ.Where(t => t.Provider == prov);\n            if (lang != null) byIdQ = byIdQ.Where(t => t.LanguageCode == lang);\n\n            var pick = await byIdQ\n                .OrderByDescending(t => t.UpdatedAt)\n                .ThenByDescending(t => t.LastSyncedAt)\n                .ThenByDescending(t => t.CreatedAt)\n                .FirstOrDefaultAsync();\n\n            if (pick == null)\n            {\n                // Second try: match by logical Name (+provider/lang if provided)\n                var byNameQ = q.Where(t => t.Name == templateName);\n                if (prov != null) byNameQ = byNameQ.Where(t => t.Provider == prov);\n\n                // Prefer an exact language match if provided; then fall back to newest any-language\n                if (!string.IsNullOrWhiteSpace(lang))\n                {\n                    pick = await byNameQ\n                        .OrderByDescending(t => t.LanguageCode == lang) // exact lang first\n                        .ThenByDescending(t => t.UpdatedAt)\n                        .ThenByDescending(t => t.LastSyncedAt)\n                        .ThenByDescending(t => t.CreatedAt)\n                        .FirstOrDefaultAsync();\n                }\n                else\n                {\n                    pick = await byNameQ\n                        .OrderByDescending(t => t.UpdatedAt)\n                        .ThenByDescending(t => t.LastSyncedAt)\n                        .ThenByDescending(t => t.CreatedAt)\n                        .FirstOrDefaultAsync();\n                }\n            }\n\n            return pick == null ? null : MapRowToMeta(pick);\n        }\n\n\n        // Map persisted catalog row → TemplateMetaDto\n        //private DTO.TemplateMetaDto MapRowToMeta(dynamic row)\n        //{\n        //    var meta = new DTO.TemplateMetaDto\n        //    {\n        //        Provider = row.Provider ?? \"\",\n        //        TemplateId = row.ExternalId ?? row.TemplateId ?? \"\",\n        //        TemplateName = row.Name ?? \"\",\n        //        Language = row.Language ?? \"\",\n        //        HasHeaderMedia = row.HasImageHeader ?? false,\n        //        HeaderType = (row.HasImageHeader ?? false) ? \"IMAGE\" : \"\"\n        //    };\n\n        //    int count = 0;\n        //    try { count = Convert.ToInt32(row.PlaceholderCount ?? 0); } catch { count = 0; }\n\n        //    meta.BodyPlaceholders = Enumerable.Range(1, Math.Max(0, count))\n        //                                      .Select(i => new DTO.PlaceholderSlot { Index = i })\n        //                                      .ToList();\n\n        //    // ButtonsJson → TemplateButtonMeta[]\n        //    meta.Buttons = new List<DTO.TemplateButtonMeta>();\n        //    try\n        //    {\n        //        string buttonsJson = row.ButtonsJson ?? \"\";\n        //        if (!string.IsNullOrWhiteSpace(buttonsJson))\n        //        {\n        //            using var doc = JsonDocument.Parse(buttonsJson);\n        //            if (doc.RootElement.ValueKind == JsonValueKind.Array)\n        //            {\n        //                int i = 0;\n        //                foreach (var el in doc.RootElement.EnumerateArray())\n        //                {\n        //                    var type = el.TryGetProperty(\"Type\", out var p1) ? p1.GetString() ?? \"\"\n        //                              : el.TryGetProperty(\"type\", out var p1b) ? p1b.GetString() ?? \"\" : \"\";\n        //                    var text = el.TryGetProperty(\"Text\", out var p2) ? p2.GetString() ?? \"\"\n        //                              : el.TryGetProperty(\"text\", out var p2b) ? p2b.GetString() ?? \"\" : \"\";\n        //                    var value = el.TryGetProperty(\"ParameterValue\", out var p3) ? p3.GetString()\n        //                              : el.TryGetProperty(\"value\", out var p3b) ? p3b.GetString() : null;\n        //                    var order = el.TryGetProperty(\"Index\", out var p4) && p4.ValueKind == JsonValueKind.Number\n        //                              ? p4.GetInt32()\n        //                              : i;\n\n        //                    meta.Buttons.Add(new DTO.TemplateButtonMeta\n        //                    {\n        //                        Type = type,\n        //                        Text = text,\n        //                        Value = value,\n        //                        Order = order\n        //                    });\n        //                    i++;\n        //                }\n        //            }\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogWarning(ex, \"Failed to parse ButtonsJson for template {TemplateName}\", (string)(row.Name ?? \"(unknown)\"));\n        //    }\n\n        //    return meta;\n        //}\n        // add near the class top (once)\n        // helpers (place near the class top)\n        private static readonly Regex _phRx = new(@\"\\{\\{\\s*(\\d+)\\s*\\}\\}\", RegexOptions.Compiled);\n\n        private static int DistinctMaxPlaceholderIndex(string? text)\n        {\n            if (string.IsNullOrWhiteSpace(text)) return 0;\n            var m = _phRx.Matches(text);\n            int max = 0;\n            var seen = new HashSet<int>();\n            foreach (Match x in m)\n            {\n                if (int.TryParse(x.Groups[1].Value, out var i) && seen.Add(i) && i > max)\n                    max = i;\n            }\n            return max;\n        }\n\n        private static bool TryGetPropCI(JsonElement obj, string name, out JsonElement value)\n        {\n            foreach (var p in obj.EnumerateObject())\n            {\n                if (string.Equals(p.Name, name, StringComparison.OrdinalIgnoreCase))\n                {\n                    value = p.Value;\n                    return true;\n                }\n            }\n            value = default;\n            return false;\n        }\n\n        // Minimal allocations; assumes DTO types live in xbytechat.api.WhatsAppSettings.DTOs\n        private static TemplateMetaDto MapRowToMeta(WhatsAppTemplate row)\n        {\n            // Provider + IDs\n            var dto = new TemplateMetaDto\n            {\n                Provider = row.Provider,                   // \"META_CLOUD\" | \"PINNACLE\"\n                TemplateId = row.TemplateId ?? \"\",\n                TemplateName = row.Name,\n                Language = row.LanguageCode,               // <- final field\n            };\n\n            // Header/media\n            var hk = (row.HeaderKind ?? \"none\").Trim().ToLowerInvariant();\n            dto.HasHeaderMedia = row.RequiresMediaHeader || hk is \"image\" or \"video\" or \"document\";\n            dto.HeaderType = hk switch\n            {\n                \"image\" => \"IMAGE\",\n                \"video\" => \"VIDEO\",\n                \"document\" => \"DOCUMENT\",\n                _ => null\n            };\n\n            // BODY placeholders: we only store counts now, so synthesize 1..BodyVarCount\n            // (TemplateMetaDto consumers only need index order for preview/validation)\n            dto.BodyPlaceholders = new List<PlaceholderSlot>(row.BodyVarCount);\n            for (int i = 1; i <= row.BodyVarCount; i++)\n                dto.BodyPlaceholders.Add(new PlaceholderSlot { Index = i });\n\n            // Buttons (up to 3): reconstruct from UrlButtons (+ quick-replies + phone)\n            // UrlButtons json shape we persisted: [{ index, parameters:[...] }, ...]\n            var buttons = new List<TemplateButtonMeta>(3);\n\n            // URL buttons first (keep template order if present)\n            if (!string.IsNullOrWhiteSpace(row.UrlButtons))\n            {\n                try\n                {\n                    var arr = Newtonsoft.Json.Linq.JArray.Parse(row.UrlButtons);\n                    foreach (var j in arr)\n                    {\n                        if (buttons.Count >= 3) break;\n                        var order = (int?)j?[\"index\"] ?? buttons.Count; // fallback order\n                        buttons.Add(new TemplateButtonMeta\n                        {\n                            Type = \"URL\",\n                            Text = \"\",     // label not stored; UI doesn’t require it for preview send\n                            Value = null,   // value may contain \"{{1}}\" at send-time\n                            Order = order\n                        });\n                    }\n                }\n                catch { /* ignore malformed json */ }\n            }\n\n            // Phone button (at most one)\n            if (buttons.Count < 3 && row.HasPhoneButton)\n            {\n                buttons.Add(new TemplateButtonMeta\n                {\n                    Type = \"PHONE_NUMBER\",\n                    Text = \"\",\n                    Value = null,\n                    Order = buttons.Count\n                });\n            }\n\n            // Quick replies (add as many as persisted, up to remaining slots)\n            var toAdd = Math.Min(row.QuickReplyCount, Math.Max(0, 3 - buttons.Count));\n            for (int i = 0; i < toAdd; i++)\n            {\n                buttons.Add(new TemplateButtonMeta\n                {\n                    Type = \"QUICK_REPLY\",\n                    Text = \"\",\n                    Value = null,\n                    Order = buttons.Count\n                });\n            }\n\n            dto.Buttons = buttons;\n            return dto;\n        }\n\n\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/WhatsAppSettings/Validators/SaveWhatsAppSettingValidator.cs",
      "sha256": "c62f496266c20b4463c4b43923cd1c1a3bedc5ac2141f1ab4c946716cc5c1bf3",
      "language": "csharp",
      "size": 2715,
      "content": "// 📄 WhatsAppSettings/Validators/SaveWhatsAppSettingValidator.cs\n#nullable enable\nusing FluentValidation;\nusing xbytechat_api.WhatsAppSettings.DTOs;\n\nnamespace xbytechat_api.WhatsAppSettings.Validators\n{\n    public sealed class SaveWhatsAppSettingValidator : AbstractValidator<SaveWhatsAppSettingDto>\n    {\n        public SaveWhatsAppSettingValidator()\n        {\n            // Provider\n            RuleFor(x => x.Provider)\n                .NotEmpty()\n                .Must(p => IsMeta(p) || IsPinnacle(p))\n                .WithMessage(\"Provider must be PINNACLE or META_CLOUD.\");\n\n            // ApiUrl: ONLY required when active.\n            When(x => x.IsActive, () =>\n            {\n                RuleFor(x => x.ApiUrl)\n                    .NotEmpty()\n                    .WithMessage(\"ApiUrl is required when settings are active.\");\n            });\n\n            // META_CLOUD rules\n            When(x => IsMeta(x.Provider), () =>\n            {\n                RuleFor(x => x.ApiKey)\n                    .NotEmpty()\n                    .WithMessage(\"Meta access token (ApiKey) is required for Meta Cloud.\");\n\n                // No PhoneNumberId requirement here.\n                // WabaId is allowed but not mandatory (can be filled via ESU discovery/sync).\n            });\n\n            // PINNACLE rules\n            When(x => IsPinnacle(x.Provider), () =>\n            {\n                RuleFor(x => x.ApiKey)\n                    .NotEmpty()\n                    .WithMessage(\"API Key is required for Pinnacle.\");\n\n                RuleFor(x => x)\n                    .Must(d =>\n                        !string.IsNullOrWhiteSpace(d.WabaId)\n                        || !string.IsNullOrWhiteSpace(d.PhoneNumberId))\n                    .WithMessage(\"WABA ID or PhoneNumberId required for Pinnacle.\");\n            });\n        }\n\n        // ── helpers ──────────────────────────────────────────────\n\n        private static string Canon(string? raw)\n        {\n            if (string.IsNullOrWhiteSpace(raw)) return string.Empty;\n            return raw.Trim().ToUpperInvariant()\n                .Replace(\"-\", \"_\")\n                .Replace(\" \", \"_\");\n        }\n\n        private static bool IsMeta(string? raw)\n            => Canon(raw) == \"META_CLOUD\"\n               || Canon(raw) == \"META\"\n               || Canon(raw) == \"WA_CLOUD\"\n               || Canon(raw) == \"WHATSAPP_CLOUD\"\n               || Canon(raw) == \"FACEBOOK\";\n\n        private static bool IsPinnacle(string? raw)\n            => Canon(raw) == \"PINNACLE\"\n               || Canon(raw) == \"PINBOT\"\n               || Canon(raw) == \"PINNACLE_OFFICIAL\";\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api.http",
      "sha256": "1bbe81fafd8a4f5140ffd5c7e14b21f6d5537372ed3c3b6315b9db805b17f2a9",
      "language": "text",
      "size": 133,
      "content": "@xbytechat.api_HostAddress = http://localhost:5295\n\nGET {{xbytechat.api_HostAddress}}/weatherforecast/\nAccept: application/json\n\n###\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Common/Utils/Idempotency.cs",
      "sha256": "ead3c94c377e056a1bc9a00a7b1d1cb697a748828ba3a42e2d88231806788770",
      "language": "csharp",
      "size": 668,
      "content": "using System;\nusing System.Security.Cryptography;\nusing System.Text;\n\nnamespace xbytechat.api.Common.Utils\n{\n    public static class Idempotency\n    {\n        /// <summary>\n        /// SHA256 over a canonical string. Returns lowercase hex.\n        /// </summary>\n        public static string Sha256(string canonical)\n        {\n            using var sha = SHA256.Create();\n            var bytes = Encoding.UTF8.GetBytes(canonical ?? string.Empty);\n            var hash = sha.ComputeHash(bytes);\n            var sb = new StringBuilder(hash.Length * 2);\n            foreach (var b in hash) sb.Append(b.ToString(\"x2\"));\n            return sb.ToString();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Helpers/AuditLoggingHelper.cs",
      "sha256": "c5b311d19b5c69b6b78d7ca335b984e43795ef1e140c2239dea1ed7190e188c6",
      "language": "csharp",
      "size": 1690,
      "content": "using xbytechat.api.Features.AuditTrail.Models;\nusing xbytechat.api.Features.AuditTrail.Services;\n\npublic static class AuditLoggingHelper\n{\n    private static IServiceProvider? _serviceProvider;\n\n    public static void Configure(IServiceProvider serviceProvider)\n    {\n        _serviceProvider = serviceProvider;\n    }\n\n    public static void Log(\n        string actionType,\n        string? entityName,\n        string? entityId,\n        string? description,\n        IHttpContextAccessor contextAccessor)\n    {\n        if (_serviceProvider == null) return;\n\n        var scope = _serviceProvider.CreateScope();\n        var auditLogService = scope.ServiceProvider.GetRequiredService<IAuditLogService>();\n\n        var httpContext = contextAccessor.HttpContext;\n        var user = httpContext?.User;\n        var claims = user?.Identities?.FirstOrDefault();\n\n        var log = new AuditLog\n        {\n            Id = Guid.NewGuid(),\n            ActionType = actionType,\n            Description = description,\n            BusinessId = TryParseGuid(claims?.FindFirst(\"businessId\")?.Value),\n            PerformedByUserId = TryParseGuid(claims?.FindFirst(\"sub\")?.Value),\n            PerformedByUserName = claims?.FindFirst(\"email\")?.Value,\n            RoleAtTime = claims?.FindFirst(\"role\")?.Value,\n            IPAddress = httpContext?.Connection?.RemoteIpAddress?.ToString(),\n            UserAgent = httpContext?.Request?.Headers[\"User-Agent\"].ToString(),\n            CreatedAt = DateTime.UtcNow\n        };\n\n        _ = Task.Run(() => auditLogService.SaveLogAsync(log));\n    }\n\n    private static Guid TryParseGuid(string? input) =>\n        Guid.TryParse(input, out var guid) ? guid : Guid.Empty;\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Helpers/JwtCookieHelper.cs",
      "sha256": "50ed48ffead96168a429fe26398cbc9b3021ecfebafabcbba8dc8e59f9a12885",
      "language": "csharp",
      "size": 3279,
      "content": "// 📄 File: Helpers/JwtCookieHelper.cs\nusing Microsoft.AspNetCore.Http;\nusing System;\n\nnamespace xbytechat.api.Helpers\n{\n    public static class JwtCookieHelper\n    {\n        // ✅ Set Access Token (short-lived)\n        public static void SetJwtCookie(HttpContext httpContext, string cookieName, string token, int expiryHours = 12)\n        {\n            if (httpContext == null || httpContext.Response.HasStarted)\n            {\n                Console.WriteLine($\"⚠️ Cannot set JWT cookie '{cookieName}' — response already started.\");\n                return;\n            }\n\n            bool isProduction = Environment.GetEnvironmentVariable(\"ASPNETCORE_ENVIRONMENT\") == \"Production\";\n\n            httpContext.Response.Cookies.Append(cookieName, token, new CookieOptions\n            {\n                HttpOnly = true,\n                ///*Secure*/ = isProduction,\n                Secure = true,\n                SameSite = SameSiteMode.Strict,\n                Expires = DateTimeOffset.UtcNow.AddHours(expiryHours)\n            }); ;\n        }\n\n        // ✅ Clear Access Token cookie\n        public static void ClearJwtCookie(HttpContext httpContext, string cookieName)\n        {\n            if (httpContext == null || httpContext.Response.HasStarted)\n            {\n                Console.WriteLine($\"⚠️ Cannot clear JWT cookie '{cookieName}' — response already started.\");\n                return;\n            }\n\n            httpContext.Response.Cookies.Append(cookieName, \"\", new CookieOptions\n            {\n                HttpOnly = true,\n                Secure = true,\n                SameSite = SameSiteMode.Strict,\n                Expires = DateTimeOffset.UtcNow.AddDays(-1)\n            });\n        }\n\n        // ✅ Set Refresh Token (long-lived)\n        public static void SetRefreshTokenCookie(HttpContext httpContext, string cookieName, string refreshToken, int expiryDays = 30)\n        {\n            if (httpContext == null || httpContext.Response.HasStarted)\n            {\n                Console.WriteLine($\"⚠️ Cannot set refresh cookie '{cookieName}' — response already started.\");\n                return;\n            }\n\n            bool isProduction = Environment.GetEnvironmentVariable(\"ASPNETCORE_ENVIRONMENT\") == \"Production\";\n\n            httpContext.Response.Cookies.Append(cookieName, refreshToken, new CookieOptions\n            {\n                HttpOnly = true,\n                Secure = isProduction,\n                SameSite = SameSiteMode.Strict,\n                Expires = DateTimeOffset.UtcNow.AddDays(expiryDays)\n            });\n        }\n\n        // ✅ Clear Refresh Token cookie\n        public static void ClearRefreshTokenCookie(HttpContext httpContext, string cookieName)\n        {\n            if (httpContext == null || httpContext.Response.HasStarted)\n            {\n                Console.WriteLine($\"⚠️ Cannot clear refresh cookie '{cookieName}' — response already started.\");\n                return;\n            }\n\n            httpContext.Response.Cookies.Append(cookieName, \"\", new CookieOptions\n            {\n                HttpOnly = true,\n                Secure = true,\n                SameSite = SameSiteMode.Strict,\n                Expires = DateTimeOffset.UtcNow.AddDays(-1)\n            });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Helpers/ResponseResult.cs",
      "sha256": "7b5c50a2cdf8601d56a0e89eb3099fdcc2078674de55eb9fe3189d92a3977561",
      "language": "csharp",
      "size": 6436,
      "content": "//namespace xbytechat.api.Helpers\n//{\n//    /// <summary>\n//    /// Represents a standardized response structure for service layer results.\n//    /// </summary>\n//    public class ResponseResult\n//    {\n//        public bool Success { get; set; }                  // ✅ Whether operation succeeded\n//        public string Message { get; set; }                // ✅ User-friendly message\n//        public object? Data { get; set; }                  // Optional payload (if needed)\n\n//        // ✅ WhatsApp-specific diagnostics\n//        public string? ErrorMessage { get; set; }          // Error from API or exception\n//        public string? RawResponse { get; set; }           // Full API raw response\n\n//        public string? MessageId { get; set; } // 🌐 WhatsApp WAMID (Message ID)\n\n//        public Guid? LogId { get; set; } // ✅ Unique ID of MessageLog for tracking\n//                                         // ✅ Factory method for successful result\n\n//        public string? Token { get; set; }\n\n//        public string? RefreshToken { get; set; }\n//        public static ResponseResult SuccessInfo(string message, object? data = null, string? raw = null)\n//        {\n//            return new ResponseResult\n//            {\n//                Success = true,\n//                Message = message,\n//                Data = data,\n//                RawResponse = raw\n//            };\n//        }\n\n//        // ❌ Factory method for error result\n//        public static ResponseResult ErrorInfo(string message, string? error = null, string? raw = null)\n//        {\n//            return new ResponseResult\n//            {\n//                Success = false,\n//                Message = message,\n//                ErrorMessage = error,\n//                RawResponse = raw\n//            };\n//        }\n//    }\n//}\nusing System;\nusing System.Net;\n\nnamespace xbytechat.api.Helpers\n{\n    /// <summary>\n    /// Standard service-layer result with optional HTTP-like status code and payload.\n    /// Backward-compatible with existing callers that use SuccessInfo/ErrorInfo/Data.\n    /// </summary>\n    public class ResponseResult\n    {\n        // Primary flags\n        public bool Success { get; set; }                 // Whether operation succeeded\n        public string Message { get; set; } = string.Empty;\n\n        // Optional status code (HTTP-like, but not tied to ASP.NET)\n        public int Code { get; set; } = (int)HttpStatusCode.OK;\n\n        // Primary payload (prefer this going forward)\n        public object? Payload { get; set; }\n\n        // Back-compat data field (kept to avoid breaking callers)\n        public object? Data { get; set; }\n\n        // WhatsApp / diagnostics (retained)\n        public string? ErrorMessage { get; set; }\n        public string? RawResponse { get; set; }\n        public string? MessageId { get; set; }\n        public Guid? LogId { get; set; }\n        public string? Token { get; set; }\n        public string? RefreshToken { get; set; }\n\n        // ---- Factory helpers (preferred) ----\n        public static ResponseResult Ok(string message = \"OK\", object? payload = null)\n            => new()\n            {\n                Success = true,\n                Code = (int)HttpStatusCode.OK,\n                Message = message,\n                Payload = payload,\n                Data = payload // keep Data in sync for legacy consumers\n            };\n\n        public static ResponseResult Created(string message = \"Created\", object? payload = null)\n            => new()\n            {\n                Success = true,\n                Code = (int)HttpStatusCode.Created,\n                Message = message,\n                Payload = payload,\n                Data = payload\n            };\n\n        public static ResponseResult NotFound(string message = \"Not found\", object? payload = null)\n            => new()\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.NotFound,\n                Message = message,\n                Payload = payload\n            };\n\n        public static ResponseResult Conflict(string message = \"Conflict\", object? payload = null)\n            => new()\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.Conflict,\n                Message = message,\n                Payload = payload\n            };\n\n        public static ResponseResult BadRequest(string message = \"Bad request\", object? payload = null, string? error = null)\n            => new()\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.BadRequest,\n                Message = message,\n                Payload = payload,\n                ErrorMessage = error\n            };\n\n        public static ResponseResult Forbidden(string message = \"Forbidden\")\n            => new()\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.Forbidden,\n                Message = message\n            };\n\n        public static ResponseResult FromException(Exception ex, string message = \"Unexpected error\")\n            => new()\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.InternalServerError,\n                Message = message,\n                ErrorMessage = ex.Message,\n                RawResponse = ex.ToString()\n            };\n\n        // ---- Backward-compatible helpers (kept; route to new ones) ----\n\n        /// <summary>\n        /// Legacy success. Prefer Ok(...) going forward.\n        /// </summary>\n        public static ResponseResult SuccessInfo(string message, object? data = null, string? raw = null)\n        {\n            return new ResponseResult\n            {\n                Success = true,\n                Code = (int)HttpStatusCode.OK,\n                Message = message,\n                Payload = data,\n                Data = data,\n                RawResponse = raw\n            };\n        }\n\n        /// <summary>\n        /// Legacy error. Prefer BadRequest/Conflict/NotFound/... going forward.\n        /// </summary>\n        public static ResponseResult ErrorInfo(string message, string? error = null, string? raw = null)\n        {\n            return new ResponseResult\n            {\n                Success = false,\n                Code = (int)HttpStatusCode.BadRequest,\n                Message = message,\n                ErrorMessage = error,\n                RawResponse = raw\n            };\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Helpers/SendResultExtended.cs",
      "sha256": "d70ced23d36d879eb80982f4a2508398175f5a06bc3e524c5c426cfe59635a0a",
      "language": "csharp",
      "size": 252,
      "content": "using xbytechat.api.Helpers;\n\npublic class SendResultExtended : ResponseResult\n{\n   // public string? MessageId { get; set; }         // WAMID from WhatsApp\n    public Guid? MessageLogId { get; set; }        // Our DB log ID (from MessageLogs table)\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat-api/Helpers/UserContextHelper.cs",
      "sha256": "ebabfd85a8a344a40535bccbbdb67a5241b585ecca9f9688e3eb6201b71fda0d",
      "language": "csharp",
      "size": 1432,
      "content": "using System.Security.Claims;\n\nnamespace xbytechat.api.Helpers\n{\n    public static class UserContextHelper\n    {\n        /// <summary>\n        /// Returns the logged-in user's unique ID from JWT.\n        /// </summary>\n        public static Guid GetUserId(ClaimsPrincipal user)\n        {\n            return Guid.TryParse(user.FindFirst(\"sub\")?.Value, out var id) ? id : Guid.Empty;\n        }\n\n        /// <summary>\n        /// Returns the business ID (tenant) from JWT claims.\n        /// </summary>\n        public static Guid GetBusinessId(ClaimsPrincipal user)\n        {\n            return Guid.TryParse(user.FindFirst(\"businessId\")?.Value, out var id) ? id : Guid.Empty;\n        }\n\n        /// <summary>\n        /// Returns the role of the logged-in user.\n        /// </summary>\n        public static string GetRole(ClaimsPrincipal user)\n        {\n            return user.FindFirst(\"role\")?.Value ?? \"\";\n        }\n\n        /// <summary>\n        /// Returns company name for UI display (optional).\n        /// </summary>\n        public static string GetCompanyName(ClaimsPrincipal user)\n        {\n            return user.FindFirst(\"companyName\")?.Value ?? \"\";\n        }\n\n        /// <summary>\n        /// Returns plan info if needed for plan-based access control.\n        /// </summary>\n        public static string GetPlan(ClaimsPrincipal user)\n        {\n            return user.FindFirst(\"plan\")?.Value ?? \"\";\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/xbytechat.api.csproj",
      "sha256": "9d4f38514c78eda7e07cbefbffab8117ef326a26e9985bf5b503a4580c8dd229",
      "language": "text",
      "size": 4235,
      "content": "<Project Sdk=\"Microsoft.NET.Sdk.Web\">\n\n  <PropertyGroup>\n    <TargetFramework>net8.0</TargetFramework>\n    <Nullable>enable</Nullable>\n    <ImplicitUsings>enable</ImplicitUsings>\n    <RootNamespace>xbytechat.api</RootNamespace>\n    <UserSecretsId>54c16f50-f987-4162-a877-70088aa68997</UserSecretsId>\n    <EnableDefaultItems>true</EnableDefaultItems>\n  </PropertyGroup>\n\n  <!-- Intentional removals (keep as-is) -->\n  <ItemGroup>\n    <Compile Remove=\"Controllers\\BusinessLoginController.cs\" />\n    <Compile Remove=\"Controllers\\SendMessageController.cs\" />\n    <Compile Remove=\"Features\\Audiences\\DTOs\\CampaignVariableMapDtos.cs\" />\n    <Compile Remove=\"Features\\ESU\\Shared\\EsuFlagKeys.cs\" />\n    <Compile Remove=\"Models\\MessageLog.cs\" />\n    <Compile Remove=\"Shared\\TemplateParameterHelper.cs\" />\n  </ItemGroup>\n\n  <ItemGroup>\n    <PackageReference Include=\"AutoMapper.Extensions.Microsoft.DependencyInjection\" Version=\"12.0.0\" />\n    <PackageReference Include=\"BCrypt.Net-Next\" Version=\"4.0.3\" />\n    <PackageReference Include=\"ClosedXML\" Version=\"0.105.0\" />\n    <PackageReference Include=\"CsvHelper\" Version=\"33.0.1\" />\n    <PackageReference Include=\"EFCore.BulkExtensions\" Version=\"8.1.3\" />\n    <PackageReference Include=\"FluentValidation\" Version=\"11.11.0\" />\n    <PackageReference Include=\"FluentValidation.AspNetCore\" Version=\"11.3.0\" />\n    <PackageReference Include=\"Microsoft.AspNetCore.Authentication.JwtBearer\" Version=\"8.0.0\" />\n    <PackageReference Include=\"Microsoft.AspNetCore.OpenApi\" Version=\"8.0.15\" />\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore\" Version=\"8.0.18\" />\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Design\" Version=\"8.0.15\">\n      <PrivateAssets>all</PrivateAssets>\n      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>\n    </PackageReference>\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.InMemory\" Version=\"8.0.15\" />\n    <PackageReference Include=\"Microsoft.EntityFrameworkCore.Tools\" Version=\"8.0.15\">\n      <PrivateAssets>all</PrivateAssets>\n      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>\n    </PackageReference>\n    <PackageReference Include=\"Newtonsoft.Json\" Version=\"13.0.3\" />\n    <PackageReference Include=\"Npgsql.EntityFrameworkCore.PostgreSQL\" Version=\"8.0.11\" />\n    <PackageReference Include=\"Npgsql.EntityFrameworkCore.PostgreSQL.Design\" Version=\"1.1.0\" />\n    <PackageReference Include=\"Polly\" Version=\"8.6.4\" />\n    <PackageReference Include=\"Polly.Contrib.WaitAndRetry\" Version=\"1.1.1\" />\n    <PackageReference Include=\"Polly.Extensions.Http\" Version=\"3.0.0\" />\n    <PackageReference Include=\"Serilog\" Version=\"4.2.0\" />\n    <PackageReference Include=\"Serilog.AspNetCore\" Version=\"8.0.3\" />\n    <PackageReference Include=\"Serilog.Exceptions\" Version=\"8.4.0\" />\n    <PackageReference Include=\"Serilog.Sinks.Async\" Version=\"2.1.0\" />\n    <PackageReference Include=\"Serilog.Sinks.File\" Version=\"6.0.0\" />\n    <PackageReference Include=\"Swashbuckle.AspNetCore\" Version=\"6.6.2\" />\n    <PackageReference Include=\"System.IdentityModel.Tokens.Jwt\" Version=\"8.8.0\" />\n  </ItemGroup>\n\n  <!-- Folder placeholders (optional) -->\n  <ItemGroup>\n    <Folder Include=\"Features\\AuditTrail\\Controllers\\\" />\n    <Folder Include=\"Features\\AuditTrail\\Middleware\\\" />\n    <Folder Include=\"Features\\AuditTrail\\Background\\\" />\n    <Folder Include=\"Features\\Automation\\Enums\\\" />\n    <Folder Include=\"Features\\Automation\\Runtime\\\" />\n    <Folder Include=\"Features\\AutoReplyBuilder\\Helpers\\\" />\n    <Folder Include=\"Features\\AutoReplyTemplates\\Restaurant\\Templates\\\" />\n    <Folder Include=\"Features\\CampaignTracking\\Repositories\\\" />\n    <Folder Include=\"Features\\Catalog\\Repositories\\\" />\n    <Folder Include=\"Features\\CrmAnalytics\\Models\\\" />\n    <Folder Include=\"Features\\CTAFlowBuilder\\Mappers\\\" />\n    <Folder Include=\"Features\\MessagesEngine\\Helpers\\\" />\n    <Folder Include=\"Features\\PlanManagement\\DTOs\\\" />\n    <Folder Include=\"Features\\CRM\\Timelines\\Repositories\\\" />\n    <Folder Include=\"Models\\BusinessModel\\\" />\n    <Folder Include=\"Models\\UsersModel\\\" />\n    <Folder Include=\"WhatsAppSettings\\BackgroundService\\\" />\n  </ItemGroup>\n\n</Project>\n"
    }
  ]
}
