{
  "name": "xbytechat-api",
  "part": 6,
  "of": 25,
  "generatedAt": "2025-12-10 08:27:07 +00:00",
  "files": [
    {
      "path": "xbytechat-api/Features/Webhooks/Services/Processors/ClickWebhookProcessor.cs",
      "sha256": "d671d0c6e0db79b3904b2158458240996c68de79a8be159c0788011d48b1ddf3",
      "language": "csharp",
      "size": 76214,
      "content": "using Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing System;\nusing System.IO.Pipelines;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing xbytechat.api;\nusing xbytechat.api.DTOs.Messages;\nusing xbytechat.api.Features.CampaignTracking.Models;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.CRM.Services;\nusing xbytechat.api.Features.CTAFlowBuilder.Models;\nusing xbytechat.api.Features.CTAFlowBuilder.Services;\nusing xbytechat.api.Features.CustomeApi.Models;\nusing xbytechat.api.Features.CustomeApi.Services;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.Features.Tracking.DTOs;\nusing xbytechat.api.Features.Tracking.Models;\nusing xbytechat.api.Features.Tracking.Services;\nusing xbytechat.api.Features.Webhooks.Services.Resolvers;\nusing xbytechat.api.Helpers;\nusing xbytechat.api.Shared.TrackingUtils;\n\nnamespace xbytechat.api.Features.Webhooks.Services.Processors\n{\n    public class ClickWebhookProcessor : IClickWebhookProcessor\n    {\n        private readonly ILogger<ClickWebhookProcessor> _logger;\n        private readonly IMessageIdResolver _messageIdResolver;\n        private readonly ITrackingService _trackingService;\n        private readonly AppDbContext _context;\n        private readonly IMessageEngineService _messageEngine;\n        private readonly ICTAFlowService _flowService;\n        private readonly IFlowRuntimeService _flowRuntime;\n        private readonly IContactProfileService _contactProfile;\n        private readonly ICtaJourneyPublisher _journeyPublisher;\n        public ClickWebhookProcessor(\n            ILogger<ClickWebhookProcessor> logger,\n            IMessageIdResolver messageIdResolver,\n            ITrackingService trackingService,\n            AppDbContext context,\n            IMessageEngineService messageEngine,\n            ICTAFlowService flowService,\n                        IFlowRuntimeService flowRuntime,\n                         IContactProfileService contactProfile,\n                          ICtaJourneyPublisher journeyPublisher\n            )\n        {\n            _logger = logger;\n            _messageIdResolver = messageIdResolver;\n            _trackingService = trackingService;\n            _context = context;\n            _messageEngine = messageEngine;\n            _flowService = flowService;\n            _flowRuntime = flowRuntime;\n            _contactProfile = contactProfile;\n            _journeyPublisher = journeyPublisher;\n\n        }\n\n        // working code\n\n        //public async Task ProcessClickAsync(JsonElement value)\n        //{\n        //    _logger.LogWarning(\"ðŸ“¥ [ENTERED CLICK PROCESSOR]\");\n\n        //    try\n        //    {\n        //        if (!value.TryGetProperty(\"messages\", out var messages) || messages.GetArrayLength() == 0)\n        //            return;\n\n        //        static string Norm(string? s)\n        //        {\n        //            if (string.IsNullOrWhiteSpace(s)) return string.Empty;\n        //            return string.Join(' ', s.Split(new[] { ' ', '\\t', '\\r', '\\n' }, StringSplitOptions.RemoveEmptyEntries))\n        //                         .Trim()\n        //                         .ToLowerInvariant();\n        //        }\n\n        //        // âœ… Canonical phone: keep only digits (matches how we store & search contacts)\n        //        static string NormalizePhone(string? raw)\n        //            => new string((raw ?? string.Empty).Where(char.IsDigit).ToArray());\n\n        //        // âœ… contacts[0].profile.name (Meta shape)\n        //        static string? TryGetProfileName(JsonElement root)\n        //        {\n        //            if (root.TryGetProperty(\"contacts\", out var contactsEl) &&\n        //                contactsEl.ValueKind == JsonValueKind.Array &&\n        //                contactsEl.GetArrayLength() > 0)\n        //            {\n        //                var c0 = contactsEl[0];\n        //                if (c0.TryGetProperty(\"profile\", out var profEl) &&\n        //                    profEl.ValueKind == JsonValueKind.Object &&\n        //                    profEl.TryGetProperty(\"name\", out var nameEl) &&\n        //                    nameEl.ValueKind == JsonValueKind.String)\n        //                {\n        //                    var n = nameEl.GetString();\n        //                    return string.IsNullOrWhiteSpace(n) ? null : n!.Trim();\n        //                }\n        //            }\n        //            return null;\n        //        }\n\n        //        // >>> BEGIN MOD: helpers for CTAJourney key + botId extraction\n        //        static string ToKey(string? s)\n        //        {\n        //            if (string.IsNullOrWhiteSpace(s)) return \"unknown\";\n        //            var t = s.Trim().ToLowerInvariant();\n        //            var sb = new System.Text.StringBuilder(t.Length);\n        //            foreach (var ch in t)\n        //            {\n        //                if (char.IsLetterOrDigit(ch)) sb.Append(ch);\n        //                else if (char.IsWhiteSpace(ch) || ch == '-' || ch == '_' || ch == '.') sb.Append('_');\n        //            }\n        //            var k = sb.ToString().Trim('_');\n        //            return string.IsNullOrEmpty(k) ? \"unknown\" : k;\n        //        }\n\n        //        // read WA display number once (used as botId)\n        //        string botIdFromWebhook = \"\";\n        //        if (value.TryGetProperty(\"metadata\", out var md) &&\n        //            md.TryGetProperty(\"display_phone_number\", out var dpnEl) &&\n        //            dpnEl.ValueKind == JsonValueKind.String)\n        //        {\n        //            botIdFromWebhook = NormalizePhone(dpnEl.GetString());\n        //        }\n        //        // >>> END MOD\n\n        //        foreach (var msg in messages.EnumerateArray())\n        //        {\n        //            if (!msg.TryGetProperty(\"type\", out var typeProp))\n        //                continue;\n\n        //            var type = typeProp.GetString();\n\n        //            string? clickMessageId = msg.TryGetProperty(\"id\", out var idProp) ? idProp.GetString() : null;\n        //            string? originalMessageId = msg.TryGetProperty(\"context\", out var ctx) && ctx.TryGetProperty(\"id\", out var ctxId)\n        //                ? ctxId.GetString()\n        //                : null;\n        //            var fromRaw = msg.TryGetProperty(\"from\", out var fromProp) ? (fromProp.GetString() ?? \"\") : \"\";\n        //            var fromDigits = NormalizePhone(fromRaw);\n\n        //            // â€”â€”â€” button label extraction\n        //            string? buttonText = null;\n        //            if (string.Equals(type, \"button\", StringComparison.OrdinalIgnoreCase))\n        //            {\n        //                buttonText = msg.TryGetProperty(\"button\", out var btn) &&\n        //                             btn.TryGetProperty(\"text\", out var textProp)\n        //                               ? textProp.GetString()?.Trim()\n        //                               : null;\n        //            }\n        //            else if (string.Equals(type, \"interactive\", StringComparison.OrdinalIgnoreCase) &&\n        //                     msg.TryGetProperty(\"interactive\", out var interactive))\n        //            {\n        //                if (interactive.TryGetProperty(\"type\", out var intrType) &&\n        //                    string.Equals(intrType.GetString(), \"button_reply\", StringComparison.OrdinalIgnoreCase) &&\n        //                    interactive.TryGetProperty(\"button_reply\", out var br) &&\n        //                    br.TryGetProperty(\"title\", out var titleProp))\n        //                {\n        //                    buttonText = titleProp.GetString()?.Trim();\n        //                }\n        //                else if (interactive.TryGetProperty(\"list_reply\", out var lr) &&\n        //                         lr.TryGetProperty(\"title\", out var listTitleProp))\n        //                {\n        //                    buttonText = listTitleProp.GetString()?.Trim();\n        //                }\n        //            }\n\n        //            if (string.IsNullOrWhiteSpace(buttonText) || string.IsNullOrWhiteSpace(originalMessageId))\n        //            {\n        //                _logger.LogDebug(\"â„¹ï¸ Not a recognized click or missing context.id. type={Type}\", type);\n        //                continue;\n        //            }\n\n        //            _logger.LogInformation(\"ðŸ–±ï¸ Button Click â†’ From: {From}, ClickId: {ClickId}, OrigMsgId: {OrigId}, Text: {Text}\",\n        //                fromDigits, clickMessageId, originalMessageId, buttonText);\n\n        //            // â€”â€” Try 1: originating MessageLog (for flow-sent messages)\n        //            var origin = await _context.MessageLogs\n        //                .AsNoTracking()\n        //                .FirstOrDefaultAsync(m =>\n        //                    m.MessageId == originalMessageId &&\n        //                    m.CTAFlowConfigId != null &&\n        //                    m.CTAFlowStepId != null);\n\n        //            Guid businessId;\n        //            Guid flowId;\n        //            Guid stepId;\n        //            string? bundleJson = null;\n        //            int? flowVersion = null;\n\n        //            Guid? campaignSendLogId = null; // link the click to the shown message\n        //            Guid? runId = null;             // copy from parent CSL when available\n\n        //            if (origin != null)\n        //            {\n        //                businessId = origin.BusinessId;\n        //                flowId = origin.CTAFlowConfigId!.Value;\n        //                stepId = origin.CTAFlowStepId!.Value;\n        //                bundleJson = origin.ButtonBundleJson;\n        //                flowVersion = origin.FlowVersion;\n\n        //                // Map back to CSL via MessageLogId or WAMID and fetch RunId\n        //                var cslInfo = await _context.CampaignSendLogs\n        //                    .AsNoTracking()\n        //                    .Where(csl => (csl.MessageLogId == origin.Id) || (csl.MessageId == originalMessageId))\n        //                    .OrderByDescending(csl => csl.CreatedAt)\n        //                    .Select(csl => new { csl.Id, csl.RunId })\n        //                    .FirstOrDefaultAsync();\n\n        //                campaignSendLogId = cslInfo?.Id;\n        //                runId = cslInfo?.RunId;\n        //            }\n        //            else\n        //            {\n        //                // â€”â€” Try 2: first campaign message (CampaignSendLogs)\n        //                var sendLog = await _context.CampaignSendLogs\n        //                    .Include(sl => sl.Campaign)\n        //                    .AsNoTracking()\n        //                    .FirstOrDefaultAsync(sl => sl.MessageId == originalMessageId);\n\n        //                if (sendLog == null)\n        //                {\n        //                    _logger.LogWarning(\"âŒ No MessageLog or CampaignSendLog for original WAMID {Orig}\", originalMessageId);\n        //                    continue;\n        //                }\n\n        //                businessId = sendLog.BusinessId != Guid.Empty\n        //                    ? sendLog.BusinessId\n        //                    : (sendLog.Campaign?.BusinessId ?? Guid.Empty);\n\n        //                if (businessId == Guid.Empty)\n        //                {\n        //                    _logger.LogWarning(\"âŒ Could not resolve BusinessId for WAMID {Orig}\", originalMessageId);\n        //                    continue;\n        //                }\n\n        //                campaignSendLogId = sendLog.Id;\n        //                runId = sendLog.RunId;\n\n        //                if (sendLog.CTAFlowConfigId.HasValue && sendLog.CTAFlowStepId.HasValue)\n        //                {\n        //                    flowId = sendLog.CTAFlowConfigId.Value;\n        //                    stepId = sendLog.CTAFlowStepId.Value;\n        //                }\n        //                else if (sendLog.Campaign?.CTAFlowConfigId != null)\n        //                {\n        //                    flowId = sendLog.Campaign.CTAFlowConfigId.Value;\n\n        //                    var entry = await _context.CTAFlowSteps\n        //                        .Where(s => s.CTAFlowConfigId == flowId)\n        //                        .OrderBy(s => s.StepOrder)\n        //                        .Select(s => s.Id)\n        //                        .FirstOrDefaultAsync();\n\n        //                    if (entry == Guid.Empty)\n        //                    {\n        //                        _logger.LogWarning(\"âŒ No entry step found for flow {Flow}\", flowId);\n        //                        continue;\n        //                    }\n\n        //                    stepId = entry;\n        //                }\n        //                else\n        //                {\n        //                    _logger.LogWarning(\"âŒ No flow context on CampaignSendLog for WAMID {Orig}\", originalMessageId);\n        //                    continue;\n        //                }\n\n        //                bundleJson = sendLog.ButtonBundleJson;\n        //            }\n\n        //            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        //            // âœ… UPSERT PROFILE NAME (create-or-update) *before* next step\n        //            //    and make sure we look up by digits-only phone.\n        //            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n        //            try\n        //            {\n        //                var profileName = TryGetProfileName(value);\n        //                if (!string.IsNullOrWhiteSpace(profileName))\n        //                {\n        //                    var now = DateTime.UtcNow;\n        //                    var contact = await _context.Contacts\n        //                        .FirstOrDefaultAsync(c => c.BusinessId == businessId &&\n        //                                                  (c.PhoneNumber == fromDigits || c.PhoneNumber == fromRaw));\n\n        //                    if (contact == null)\n        //                    {\n        //                        profileName = profileName ?? \"User\";\n        //                        contact = new Contact\n        //                        {\n        //                            Id = Guid.NewGuid(),\n        //                            BusinessId = businessId,\n        //                            PhoneNumber = fromDigits, // store canonical\n        //                            Name = profileName,\n        //                            ProfileName = profileName,\n        //                            ProfileNameUpdatedAt = now,\n        //                            CreatedAt = now,\n        //                        };\n        //                        _context.Contacts.Add(contact);\n        //                        await _context.SaveChangesAsync();\n        //                        _logger.LogInformation(\"ðŸ‘¤ Created contact + stored WA profile '{Name}' for {Phone} (biz {Biz})\",\n        //                            profileName, fromDigits, businessId);\n        //                    }\n        //                    else\n        //                    {\n        //                        var changed = false;\n\n        //                        if (!string.Equals(contact.ProfileName, profileName, StringComparison.Ordinal))\n        //                        {\n        //                            contact.ProfileName = profileName;\n        //                            contact.ProfileNameUpdatedAt = now;\n        //                            changed = true;\n        //                        }\n\n        //                        if (string.IsNullOrWhiteSpace(contact.Name) ||\n        //                            contact.Name == \"WhatsApp User\" ||\n        //                            contact.Name == contact.PhoneNumber)\n        //                        {\n        //                            if (!string.Equals(contact.Name, profileName, StringComparison.Ordinal))\n        //                            {\n        //                                contact.Name = profileName;\n        //                                changed = true;\n        //                            }\n        //                        }\n\n        //                        if (changed)\n        //                        {\n        //                            contact.ProfileNameUpdatedAt = now;\n        //                            await _context.SaveChangesAsync();\n        //                            _logger.LogInformation(\"ðŸ‘¤ Updated WA profile name to '{Name}' for {Phone} (biz {Biz})\",\n        //                                profileName, fromDigits, businessId);\n        //                        }\n        //                    }\n        //                }\n        //            }\n        //            catch (Exception exProf)\n        //            {\n        //                _logger.LogWarning(exProf, \"âš ï¸ Failed to upsert WA profile name on click webhook.\");\n        //            }\n\n        //            // â€”â€” Map clicked text -> button index via the shown bundle\n        //            short? buttonIndex = null;\n        //            FlowBtnBundleNode? hit = null;\n\n        //            if (!string.IsNullOrWhiteSpace(bundleJson))\n        //            {\n        //                try\n        //                {\n        //                    var nodes = System.Text.Json.JsonSerializer\n        //                        .Deserialize<List<FlowBtnBundleNode>>(bundleJson) ?? new();\n\n        //                    hit = nodes.FirstOrDefault(n =>\n        //                              string.Equals(n.t ?? \"\", buttonText, StringComparison.OrdinalIgnoreCase))\n        //                          ?? nodes.FirstOrDefault(n => Norm(n.t) == Norm(buttonText));\n\n        //                    if (hit != null)\n        //                        buttonIndex = (short)hit.i;\n        //                }\n        //                catch (Exception ex)\n        //                {\n        //                    _logger.LogWarning(ex, \"âš ï¸ Failed to parse ButtonBundleJson\");\n        //                }\n        //            }\n\n        //            // â€”â€” Fallback: find link by TEXT for this step\n        //            FlowButtonLink? linkMatchedByText = null;\n        //            if (buttonIndex == null)\n        //            {\n        //                var stepLinks = await _context.FlowButtonLinks\n        //                    .Where(l => l.CTAFlowStepId == stepId)\n        //                    .OrderBy(l => l.ButtonIndex)\n        //                    .ToListAsync();\n\n        //                if (stepLinks.Count > 0)\n        //                {\n        //                    linkMatchedByText = stepLinks.FirstOrDefault(l =>\n        //                        string.Equals(l.ButtonText ?? \"\", buttonText, StringComparison.OrdinalIgnoreCase))\n        //                        ?? stepLinks.FirstOrDefault(l => Norm(l.ButtonText) == Norm(buttonText));\n\n        //                    if (linkMatchedByText == null && stepLinks.Count == 1)\n        //                    {\n        //                        linkMatchedByText = stepLinks[0];\n        //                        _logger.LogInformation(\"ðŸŸ¨ Falling back to single available link for step {Step}\", stepId);\n        //                    }\n\n        //                    if (linkMatchedByText != null)\n        //                    {\n        //                        buttonIndex = (short?)linkMatchedByText.ButtonIndex;\n        //                        _logger.LogInformation(\"âœ… Mapped click by TEXT to index {Idx} (flow={Flow}, step={Step})\",\n        //                            buttonIndex, flowId, stepId);\n        //                    }\n        //                }\n        //            }\n\n        //            if (buttonIndex == null)\n        //            {\n        //                _logger.LogInformation(\"ðŸŸ¡ Button text not found in bundle or flow links. Ref={Ref}, Text='{Text}'\",\n        //                    originalMessageId, buttonText);\n        //                continue;\n        //            }\n\n        //            // â€”â€” Prefer exact link by index; otherwise use the text-matched link\n        //            var link = await _flowService.GetLinkAsync(flowId, stepId, buttonIndex.Value)\n        //                       ?? linkMatchedByText;\n\n        //            if (link == null)\n        //            {\n        //                _logger.LogInformation(\"ðŸŸ¡ No button link for (flow={Flow}, step={Step}, idx={Idx})\",\n        //                    flowId, stepId, buttonIndex);\n        //                continue;\n        //            }\n\n        //            // â€”â€” Resolve index + step name (for logging)\n        //            short resolvedIndex = buttonIndex ?? Convert.ToInt16(link.ButtonIndex);\n        //            var stepName = await _context.CTAFlowSteps\n        //                .Where(s => s.Id == stepId)\n        //                .Select(s => s.TemplateToSend)\n        //                .FirstOrDefaultAsync() ?? string.Empty;\n\n        //            // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n        //            // ðŸ“ WRITE CLICK LOG (always, even if terminal)\n        //            // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n        //            try\n        //            {\n        //                var clickExec = new FlowExecutionLog\n        //                {\n        //                    Id = Guid.NewGuid(),\n        //                    BusinessId = businessId,\n        //                    FlowId = flowId,\n        //                    StepId = stepId,\n        //                    StepName = stepName,\n        //                    CampaignSendLogId = campaignSendLogId,\n        //                    MessageLogId = origin?.Id,\n        //                    ContactPhone = fromDigits,      // âœ… digits-only, consistent\n        //                    ButtonIndex = resolvedIndex,\n        //                    TriggeredByButton = buttonText,\n        //                    TemplateName = null,\n        //                    TemplateType = \"quick_reply\",\n        //                    Success = true,\n        //                    ExecutedAt = DateTime.UtcNow,\n        //                    RequestId = Guid.NewGuid(),\n        //                    RunId = runId\n        //                };\n\n        //                _context.FlowExecutionLogs.Add(clickExec);\n        //                await _context.SaveChangesAsync();\n        //            }\n        //            catch (Exception exSave)\n        //            {\n        //                _logger.LogWarning(exSave, \"âš ï¸ Failed to persist FlowExecutionLog (click). Continuingâ€¦\");\n        //            }\n        //            // ===== RUNNING CTA JOURNEY STATE UPSERT (ONLY IF THIS BIZ IS CONFIGURED) =====\n        //            string runningJourney;\n\n        //            // Check once if this business is configured to receive CTAJourney.\n        //            // If not, we won't touch ContactJourneyStates at all.\n        //            bool shouldTrackState = await _context.CustomerWebhookConfigs\n        //                .AsNoTracking()\n        //                .AnyAsync(x => x.BusinessId == businessId && x.IsActive);\n\n        //            if (shouldTrackState)\n        //            {\n        //                try\n        //                {\n        //                    // load current state for (business, flow, phone)\n        //                    var state = await _context.ContactJourneyStates\n        //                        .SingleOrDefaultAsync(s =>\n        //                            s.BusinessId == businessId &&\n        //                            s.FlowId == flowId &&\n        //                            s.ContactPhone == fromDigits);\n\n        //                    if (state == null)\n        //                    {\n        //                        // first click -> start with this button text (original casing)\n        //                        state = new ContactJourneyState\n        //                        {\n        //                            Id = Guid.NewGuid(),\n        //                            BusinessId = businessId,\n        //                            FlowId = flowId,\n        //                            ContactPhone = fromDigits,\n        //                            JourneyText = buttonText ?? string.Empty,\n        //                            ClickCount = 1,\n        //                            LastButtonText = buttonText,\n        //                            CreatedAt = DateTime.UtcNow,\n        //                            UpdatedAt = DateTime.UtcNow\n        //                        };\n        //                        _context.ContactJourneyStates.Add(state);\n        //                        await _context.SaveChangesAsync();\n        //                        runningJourney = state.JourneyText;\n        //                        _logger.LogInformation(\"ðŸ§µ Journey init: {Journey} (biz={Biz}, flow={Flow}, phone={Phone})\",\n        //                            runningJourney, businessId, flowId, fromDigits);\n        //                    }\n        //                    else\n        //                    {\n        //                        // append EVERY press (duplicates allowed), keep original casing\n        //                        var parts = (state.JourneyText ?? string.Empty)\n        //                            .Split('/', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)\n        //                            .ToList();\n\n        //                        if (!string.IsNullOrWhiteSpace(buttonText))\n        //                            parts.Add(buttonText!);\n\n        //                        // optional safety: cap growth\n        //                        const int cap = 15;\n        //                        if (parts.Count > cap) parts = parts.Skip(parts.Count - cap).ToList();\n\n        //                        state.JourneyText = string.Join('/', parts);\n        //                        state.ClickCount += 1;\n        //                        state.LastButtonText = buttonText;\n        //                        state.UpdatedAt = DateTime.UtcNow;\n\n        //                        await _context.SaveChangesAsync();\n        //                        runningJourney = state.JourneyText ?? string.Empty;\n\n        //                        _logger.LogInformation(\"ðŸ§µ Journey update: {Journey} (biz={Biz}, flow={Flow}, phone={Phone})\",\n        //                            runningJourney, businessId, flowId, fromDigits);\n        //                    }\n        //                }\n        //                catch (Exception exState)\n        //                {\n        //                    _logger.LogWarning(exState, \"âš ï¸ Failed to upsert ContactJourneyState.\");\n        //                    // fall back to this click only\n        //                    runningJourney = buttonText ?? string.Empty;\n        //                }\n        //            }\n        //            else\n        //            {\n        //                // Business not configured â†’ do NOT save any state. Just use the current button for emit.\n        //                runningJourney = buttonText ?? string.Empty;\n        //            }\n        //            // ===== END RUNNING CTA JOURNEY STATE UPSERT =====\n\n\n        //            // ===== CTAJourney EMIT (running journey) =====\n        //            try\n        //            {\n        //                // contact (for userName / userPhone)\n        //                var contact = await _context.Contacts\n        //                    .AsNoTracking()\n        //                    .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.PhoneNumber == fromDigits);\n\n        //                // prefer PhoneNumberId (botId) from the originating send; otherwise pick any active one\n        //                string? phoneNumberId = null;\n        //                if (campaignSendLogId.HasValue)\n        //                {\n        //                    phoneNumberId = await _context.CampaignSendLogs\n        //                        .AsNoTracking()\n        //                        .Where(s => s.Id == campaignSendLogId.Value)\n        //                        .Select(s => s.Campaign.PhoneNumberId)\n        //                        .FirstOrDefaultAsync();\n        //                }\n        //                if (string.IsNullOrWhiteSpace(phoneNumberId) && origin?.CampaignId != null)\n        //                {\n        //                    phoneNumberId = await _context.Campaigns\n        //                        .AsNoTracking()\n        //                        .Where(c => c.Id == origin.CampaignId.Value)\n        //                        .Select(c => c.PhoneNumberId)\n        //                        .FirstOrDefaultAsync();\n        //                }\n\n        //                //if (string.IsNullOrWhiteSpace(phoneNumberId))\n        //                //{\n        //                //    phoneNumberId = await _context.WhatsAppSettings\n        //                //        .AsNoTracking()\n        //                //        .Where(s => s.BusinessId == businessId && s.IsActive && s.PhoneNumberId != null)\n        //                //        .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n        //                //        .Select(s => s.PhoneNumberId)\n        //                //        .FirstOrDefaultAsync();\n        //                //}\n        //                // 2) Map PhoneNumberId -> WhatsAppBusinessNumber\n        //                string? botWaNumber = null;\n        //                if (!string.IsNullOrWhiteSpace(phoneNumberId))\n        //                {\n        //                    botWaNumber = await _context.WhatsAppPhoneNumbers\n        //                        .AsNoTracking()\n        //                        .Where(n => n.BusinessId == businessId && n.PhoneNumberId == phoneNumberId)\n        //                        .Select(n => n.WhatsAppBusinessNumber)\n        //                        .FirstOrDefaultAsync();\n        //                }\n        //                // business WA display number (fallback botId if no PhoneNumberId)\n        //                var displayProfilename = await _context.WhatsAppSettings\n        //                    .AsNoTracking()\n        //                    .Where(s => s.BusinessId == businessId && s.IsActive && s.WhatsAppBusinessNumber != null)\n        //                    .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n        //                    .Select(s => s.WhatsAppBusinessNumber)\n        //                    .FirstOrDefaultAsync();\n\n        //                // Build DTO and POST (CTAJourney = the running slash-joined string with original casing)\n        //                var dto = CtaJourneyMapper.Build(\n        //                    journeyKey: runningJourney,                    // <<â€”â€” use the running state\n        //                    contact: contact,\n        //                    profileName: contact?.ProfileName ?? contact?.Name,\n        //                    userId: null,\n        //                    phoneNumberId: botWaNumber,                  // preferred botId\n        //                    businessDisplayPhone: displayProfilename,               // fallback botId if above missing\n        //                    categoryBrowsed: null,\n        //                    productBrowsed: null\n        //                );\n\n        //                await _journeyPublisher.PublishAsync(businessId, dto, CancellationToken.None);\n        //                _logger.LogInformation(\"ðŸ“¤ CTAJourney posted (running): {Journey} (biz={Biz}, phone={Phone})\",\n        //                    dto.CTAJourney, businessId, dto.userPhone);\n        //            }\n        //            catch (Exception ex)\n        //            {\n        //                _logger.LogWarning(ex, \"âš ï¸ Failed to post CTAJourney (click). Continuingâ€¦\");\n        //            }\n\n        //            // ===== end CTAJourney EMIT =====\n\n\n        //            // ===== CTAJourney EMIT (button name) =====\n        //            //try\n        //            //{\n        //            //    CTAJourney must be the button name now\n        //            //   var journeyKey = ToKey(buttonText);\n        //            //    var journeyKey = buttonText?.Trim();\n        //            //    contact(for userName / userPhone)\n        //            //        var contact = await _context.Contacts\n        //            //            .AsNoTracking()\n        //            //            .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.PhoneNumber == fromDigits);\n\n        //            //    prefer PhoneNumberId(botId) from the originating send; otherwise pick any active one\n        //            //    string? phoneNumberId = null;\n        //            //    if (campaignSendLogId.HasValue)\n        //            //    {\n        //            //        phoneNumberId = await _context.CampaignSendLogs\n        //            //            .AsNoTracking()\n        //            //            .Where(s => s.Id == campaignSendLogId.Value)\n        //            //            .Select(s => s.Campaign.PhoneNumberId)\n        //            //            .FirstOrDefaultAsync();\n        //            //    }\n        //            //    if (string.IsNullOrWhiteSpace(phoneNumberId) && origin?.CampaignId != null)\n        //            //    {\n        //            //        phoneNumberId = await _context.Campaigns\n        //            //            .AsNoTracking()\n        //            //            .Where(c => c.Id == origin.CampaignId.Value)\n        //            //            .Select(c => c.PhoneNumberId)\n        //            //            .FirstOrDefaultAsync();\n        //            //    }\n        //            //    if (string.IsNullOrWhiteSpace(phoneNumberId))\n        //            //    {\n        //            //        phoneNumberId = await _context.WhatsAppSettings\n        //            //            .AsNoTracking()\n        //            //            .Where(s => s.BusinessId == businessId && s.IsActive && s.PhoneNumberId != null)\n        //            //            .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n        //            //            .Select(s => s.PhoneNumberId)\n        //            //            .FirstOrDefaultAsync();\n        //            //    }\n\n        //            //    business WA display number(fallback botId if no PhoneNumberId)\n        //            //    var displayWa = await _context.WhatsAppSettings\n        //            //        .AsNoTracking()\n        //            //        .Where(s => s.BusinessId == businessId && s.IsActive && s.WhatsAppBusinessNumber != null)\n        //            //        .OrderByDescending(s => s.UpdatedAt ?? s.CreatedAt)\n        //            //        .Select(s => s.WhatsAppBusinessNumber)\n        //            //        .FirstOrDefaultAsync();\n\n        //            //    build DTO and POST(maps to: userName / profileName, userPhone, botId, CTAJourney)\n        //            //    var dto = CtaJourneyMapper.Build(\n        //            //        journeyKey: journeyKey,                         // <<â€”â€” button name\n        //            //        contact: contact,\n        //            //        profileName: contact?.ProfileName ?? contact?.Name,\n        //            //        userId: null,                                   // we don't have external user id\n        //            //        phoneNumberId: phoneNumberId,                   // preferred botId\n        //            //        businessDisplayPhone: displayWa,                // fallback botId if above missing\n        //            //        categoryBrowsed: null,\n        //            //        productBrowsed: null\n        //            //    );\n\n        //            //    await _journeyPublisher.PublishAsync(businessId, dto, CancellationToken.None);\n        //            //    _logger.LogInformation(\"ðŸ“¤ CTAJourney posted (button): {Journey} (biz={Biz}, phone={Phone})\",\n        //            //        dto.CTAJourney, businessId, dto.userPhone);\n        //            //}\n        //            //catch (Exception ex)\n        //            //{\n        //            //    _logger.LogWarning(ex, \"âš ï¸ Failed to post CTAJourney (click). Continuingâ€¦\");\n        //            //}\n\n\n\n\n\n        //            // â€”â€” If terminal/URL button: already logged the click\n        //            if (link.NextStepId == null)\n        //            {\n        //                _logger.LogInformation(\"ðŸ”š Terminal/URL button: no NextStepId. flow={Flow}, step={Step}, idx={Idx}, text='{Text}'\",\n        //                    flowId, stepId, resolvedIndex, link.ButtonText);\n        //                continue;\n        //            }\n\n        //            if (_flowRuntime == null)\n        //            {\n        //                _logger.LogError(\"âŒ _flowRuntime is null. Cannot execute next step. flow={Flow}, step={Step}, idx={Idx}\", flowId, stepId, resolvedIndex);\n        //                continue;\n        //            }\n\n        //            // â€”â€” ðŸ”Ž Resolve sender from the originating campaign/send (use SAME WABA)\n        //            string? providerFromCampaign = null;\n        //            string? phoneNumberIdFromCampaign = null;\n\n        //            if (campaignSendLogId.HasValue)\n        //            {\n        //                var originSend = await _context.CampaignSendLogs\n        //                    .AsNoTracking()\n        //                    .Include(s => s.Campaign)\n        //                    .Where(s => s.Id == campaignSendLogId.Value)\n        //                    .Select(s => new\n        //                    {\n        //                        s.Campaign.Provider,\n        //                        s.Campaign.PhoneNumberId\n        //                    })\n        //                    .FirstOrDefaultAsync();\n\n        //                providerFromCampaign = originSend?.Provider;\n        //                phoneNumberIdFromCampaign = originSend?.PhoneNumberId;\n        //            }\n        //            else if (origin != null && origin.CampaignId.HasValue)\n        //            {\n        //                var originCamp = await _context.Campaigns\n        //                    .AsNoTracking()\n        //                    .Where(c => c.Id == origin.CampaignId.Value)\n        //                    .Select(c => new { c.Provider, c.PhoneNumberId })\n        //                    .FirstOrDefaultAsync();\n\n        //                providerFromCampaign = originCamp?.Provider;\n        //                phoneNumberIdFromCampaign = originCamp?.PhoneNumberId;\n        //            }\n\n        //            // â€”â€” Execute next (carry sender forward)\n        //            var ctxObj = new NextStepContext\n        //            {\n        //                BusinessId = businessId,\n        //                FlowId = flowId,\n        //                Version = flowVersion ?? 1,\n        //                SourceStepId = stepId,\n        //                TargetStepId = link.NextStepId!.Value,\n        //                ButtonIndex = resolvedIndex,\n        //                MessageLogId = origin?.Id ?? Guid.Empty,\n        //                ContactPhone = fromDigits,     // âœ… digits-only, so runtime finds the Contact\n        //                RequestId = Guid.NewGuid(),\n        //                ClickedButton = link,\n\n        //                // ðŸ§· Sender from campaign so runtime wonâ€™t guess or fail with â€œMissing PhoneNumberIdâ€\n        //                Provider = providerFromCampaign,\n        //                PhoneNumberId = phoneNumberIdFromCampaign,\n        //                AlwaysSend = true // ðŸ”¥ force runtime to send even if itâ€™s a loopback/same step\n        //            };\n\n        //            try\n        //            {\n        //                var result = await _flowRuntime.ExecuteNextAsync(ctxObj);\n\n        //                if (result.Success && !string.IsNullOrWhiteSpace(result.RedirectUrl))\n        //                {\n        //                    _logger.LogInformation(\"ðŸ”— URL button redirect (logical): {Url}\", result.RedirectUrl);\n        //                }\n        //            }\n        //            catch (Exception exRun)\n        //            {\n        //                _logger.LogError(exRun,\n        //                    \"âŒ ExecuteNextAsync failed. ctx: flow={Flow} step={Step} next={Next} idx={Idx} from={From} orig={Orig} text='{Text}'\",\n        //                    ctxObj.FlowId, ctxObj.SourceStepId, ctxObj.TargetStepId, ctxObj.ButtonIndex, fromDigits, originalMessageId, buttonText);\n        //            }\n        //        }\n        //    }\n        //    catch (Exception ex)\n        //    {\n        //        _logger.LogError(ex, \"âŒ Failed to process CTA button click.\");\n        //    }\n        //}\n\n        public async Task ProcessClickAsync(JsonElement value)\n        {\n            _logger.LogWarning(\"ðŸ“¥ [ENTERED CLICK PROCESSOR]\");\n\n            try\n            {\n                if (!value.TryGetProperty(\"messages\", out var messages) || messages.GetArrayLength() == 0)\n                    return;\n\n                // â”€â”€ local helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n                static string Norm(string? s)\n                {\n                    if (string.IsNullOrWhiteSpace(s)) return string.Empty;\n                    return string.Join(' ', s.Split(new[] { ' ', '\\t', '\\r', '\\n' }, StringSplitOptions.RemoveEmptyEntries))\n                                 .Trim()\n                                 .ToLowerInvariant();\n                }\n\n                // canonical phone: keep only digits (matches how we store & search contacts)\n                static string NormalizePhone(string? raw)\n                    => new string((raw ?? string.Empty).Where(char.IsDigit).ToArray());\n\n                // contacts[0].profile.name (Meta shape)\n                static string? TryGetProfileName(JsonElement root)\n                {\n                    if (root.TryGetProperty(\"contacts\", out var contactsEl) &&\n                        contactsEl.ValueKind == JsonValueKind.Array &&\n                        contactsEl.GetArrayLength() > 0)\n                    {\n                        var c0 = contactsEl[0];\n                        if (c0.TryGetProperty(\"profile\", out var profEl) &&\n                            profEl.ValueKind == JsonValueKind.Object &&\n                            profEl.TryGetProperty(\"name\", out var nameEl) &&\n                            nameEl.ValueKind == JsonValueKind.String)\n                        {\n                            var n = nameEl.GetString();\n                            return string.IsNullOrWhiteSpace(n) ? null : n!.Trim();\n                        }\n                    }\n                    return null;\n                }\n\n                // optional helper (kept for future use)\n                static string ToKey(string? s)\n                {\n                    if (string.IsNullOrWhiteSpace(s)) return \"unknown\";\n                    var t = s.Trim().ToLowerInvariant();\n                    var sb = new System.Text.StringBuilder(t.Length);\n                    foreach (var ch in t)\n                    {\n                        if (char.IsLetterOrDigit(ch)) sb.Append(ch);\n                        else if (char.IsWhiteSpace(ch) || ch == '-' || ch == '_' || ch == '.') sb.Append('_');\n                    }\n                    var k = sb.ToString().Trim('_');\n                    return string.IsNullOrEmpty(k) ? \"unknown\" : k;\n                }\n                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n                // read WA display number once (used as botId) â€“ optional, not strictly required\n                string botIdFromWebhook = \"\";\n                if (value.TryGetProperty(\"metadata\", out var md) &&\n                    md.TryGetProperty(\"display_phone_number\", out var dpnEl) &&\n                    dpnEl.ValueKind == JsonValueKind.String)\n                {\n                    botIdFromWebhook = NormalizePhone(dpnEl.GetString());\n                }\n\n                foreach (var msg in messages.EnumerateArray())\n                {\n                    if (!msg.TryGetProperty(\"type\", out var typeProp))\n                        continue;\n\n                    var type = typeProp.GetString();\n\n                    string? clickMessageId = msg.TryGetProperty(\"id\", out var idProp) ? idProp.GetString() : null;\n                    string? originalMessageId = msg.TryGetProperty(\"context\", out var ctx) && ctx.TryGetProperty(\"id\", out var ctxId)\n                        ? ctxId.GetString()\n                        : null;\n\n                    var fromRaw = msg.TryGetProperty(\"from\", out var fromProp) ? (fromProp.GetString() ?? \"\") : \"\";\n                    var fromDigits = NormalizePhone(fromRaw);\n\n                    // â€”â€”â€” button label extraction\n                    string? buttonText = null;\n                    if (string.Equals(type, \"button\", StringComparison.OrdinalIgnoreCase))\n                    {\n                        buttonText = msg.TryGetProperty(\"button\", out var btn) &&\n                                     btn.TryGetProperty(\"text\", out var textProp)\n                                       ? textProp.GetString()?.Trim()\n                                       : null;\n                    }\n                    else if (string.Equals(type, \"interactive\", StringComparison.OrdinalIgnoreCase) &&\n                             msg.TryGetProperty(\"interactive\", out var interactive))\n                    {\n                        if (interactive.TryGetProperty(\"type\", out var intrType) &&\n                            string.Equals(intrType.GetString(), \"button_reply\", StringComparison.OrdinalIgnoreCase) &&\n                            interactive.TryGetProperty(\"button_reply\", out var br) &&\n                            br.TryGetProperty(\"title\", out var titleProp))\n                        {\n                            buttonText = titleProp.GetString()?.Trim();\n                        }\n                        else if (interactive.TryGetProperty(\"list_reply\", out var lr) &&\n                                 lr.TryGetProperty(\"title\", out var listTitleProp))\n                        {\n                            buttonText = listTitleProp.GetString()?.Trim();\n                        }\n                    }\n\n                    if (string.IsNullOrWhiteSpace(buttonText) || string.IsNullOrWhiteSpace(originalMessageId))\n                    {\n                        _logger.LogDebug(\"â„¹ï¸ Not a recognized click or missing context.id. type={Type}\", type);\n                        continue;\n                    }\n\n                    _logger.LogInformation(\"ðŸ–±ï¸ Button Click â†’ From: {From}, ClickId: {ClickId}, OrigMsgId: {OrigId}, Text: {Text}\",\n                        fromDigits, clickMessageId, originalMessageId, buttonText);\n\n                    // â€”â€” Try 1: originating MessageLog (for flow-sent messages)\n                    var origin = await _context.MessageLogs\n                        .AsNoTracking()\n                        .FirstOrDefaultAsync(m =>\n                            m.MessageId == originalMessageId &&\n                            m.CTAFlowConfigId != null &&\n                            m.CTAFlowStepId != null);\n\n                    Guid businessId;\n                    Guid flowId;\n                    Guid stepId;\n                    string? bundleJson = null;\n                    int? flowVersion = null;\n\n                    Guid? campaignSendLogId = null; // link the click to the shown message\n                    Guid? runId = null;             // copy from parent CSL when available\n\n                    if (origin != null)\n                    {\n                        businessId = origin.BusinessId;\n                        flowId = origin.CTAFlowConfigId!.Value;\n                        stepId = origin.CTAFlowStepId!.Value;\n                        bundleJson = origin.ButtonBundleJson;\n                        flowVersion = origin.FlowVersion;\n\n                        // Map back to CSL via MessageLogId or WAMID and fetch RunId\n                        var cslInfo = await _context.CampaignSendLogs\n                            .AsNoTracking()\n                            .Where(csl => (csl.MessageLogId == origin.Id) || (csl.MessageId == originalMessageId))\n                            .OrderByDescending(csl => csl.CreatedAt)\n                            .Select(csl => new { csl.Id, csl.RunId })\n                            .FirstOrDefaultAsync();\n\n                        campaignSendLogId = cslInfo?.Id;\n                        runId = cslInfo?.RunId;\n                    }\n                    else\n                    {\n                        // â€”â€” Try 2: first campaign message (CampaignSendLogs)\n                        var sendLog = await _context.CampaignSendLogs\n                            .Include(sl => sl.Campaign)\n                            .AsNoTracking()\n                            .FirstOrDefaultAsync(sl => sl.MessageId == originalMessageId);\n\n                        if (sendLog == null)\n                        {\n                            _logger.LogWarning(\"âŒ No MessageLog or CampaignSendLog for original WAMID {Orig}\", originalMessageId);\n                            continue;\n                        }\n\n                        businessId = sendLog.BusinessId != Guid.Empty\n                            ? sendLog.BusinessId\n                            : (sendLog.Campaign?.BusinessId ?? Guid.Empty);\n\n                        if (businessId == Guid.Empty)\n                        {\n                            _logger.LogWarning(\"âŒ Could not resolve BusinessId for WAMID {Orig}\", originalMessageId);\n                            continue;\n                        }\n\n                        campaignSendLogId = sendLog.Id;\n                        runId = sendLog.RunId;\n\n                        if (sendLog.CTAFlowConfigId.HasValue && sendLog.CTAFlowStepId.HasValue)\n                        {\n                            flowId = sendLog.CTAFlowConfigId.Value;\n                            stepId = sendLog.CTAFlowStepId.Value;\n                        }\n                        else if (sendLog.Campaign?.CTAFlowConfigId != null)\n                        {\n                            flowId = sendLog.Campaign.CTAFlowConfigId.Value;\n\n                            var entry = await _context.CTAFlowSteps\n                                .Where(s => s.CTAFlowConfigId == flowId)\n                                .OrderBy(s => s.StepOrder)\n                                .Select(s => s.Id)\n                                .FirstOrDefaultAsync();\n\n                            if (entry == Guid.Empty)\n                            {\n                                _logger.LogWarning(\"âŒ No entry step found for flow {Flow}\", flowId);\n                                continue;\n                            }\n\n                            stepId = entry;\n                        }\n                        else\n                        {\n                            _logger.LogWarning(\"âŒ No flow context on CampaignSendLog for WAMID {Orig}\", originalMessageId);\n                            continue;\n                        }\n\n                        bundleJson = sendLog.ButtonBundleJson;\n                    }\n\n                    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n                    // âœ… UPSERT PROFILE NAME (create-or-update) *before* next step\n                    //    ensure we look up by digits-only phone.\n                    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n                    try\n                    {\n                        var profileName = TryGetProfileName(value);\n                        if (!string.IsNullOrWhiteSpace(profileName))\n                        {\n                            var now = DateTime.UtcNow;\n                            var contact = await _context.Contacts\n                                .FirstOrDefaultAsync(c => c.BusinessId == businessId &&\n                                                          (c.PhoneNumber == fromDigits || c.PhoneNumber == fromRaw));\n\n                            if (contact == null)\n                            {\n                                profileName = profileName ?? \"User\";\n                                contact = new Contact\n                                {\n                                    Id = Guid.NewGuid(),\n                                    BusinessId = businessId,\n                                    PhoneNumber = fromDigits, // store canonical\n                                    Name = profileName,\n                                    ProfileName = profileName,\n                                    ProfileNameUpdatedAt = now,\n                                    CreatedAt = now,\n                                };\n                                _context.Contacts.Add(contact);\n                                await _context.SaveChangesAsync();\n                                _logger.LogInformation(\"ðŸ‘¤ Created contact + stored WA profile '{Name}' for {Phone} (biz {Biz})\",\n                                    profileName, fromDigits, businessId);\n                            }\n                            else\n                            {\n                                var changed = false;\n\n                                if (!string.Equals(contact.ProfileName, profileName, StringComparison.Ordinal))\n                                {\n                                    contact.ProfileName = profileName;\n                                    contact.ProfileNameUpdatedAt = now;\n                                    changed = true;\n                                }\n\n                                if (string.IsNullOrWhiteSpace(contact.Name) ||\n                                    contact.Name == \"WhatsApp User\" ||\n                                    contact.Name == contact.PhoneNumber)\n                                {\n                                    if (!string.Equals(contact.Name, profileName, StringComparison.Ordinal))\n                                    {\n                                        contact.Name = profileName;\n                                        changed = true;\n                                    }\n                                }\n\n                                if (changed)\n                                {\n                                    contact.ProfileNameUpdatedAt = now;\n                                    await _context.SaveChangesAsync();\n                                    _logger.LogInformation(\"ðŸ‘¤ Updated WA profile name to '{Name}' for {Phone} (biz {Biz})\",\n                                        profileName, fromDigits, businessId);\n                                }\n                            }\n                        }\n                    }\n                    catch (Exception exProf)\n                    {\n                        _logger.LogWarning(exProf, \"âš ï¸ Failed to upsert WA profile name on click webhook.\");\n                    }\n\n                    // â€”â€” Map clicked text -> button index via the shown bundle\n                    short? buttonIndex = null;\n                    FlowBtnBundleNode? hit = null;\n\n                    if (!string.IsNullOrWhiteSpace(bundleJson))\n                    {\n                        try\n                        {\n                            var nodes = System.Text.Json.JsonSerializer\n                                .Deserialize<List<FlowBtnBundleNode>>(bundleJson) ?? new();\n\n                            hit = nodes.FirstOrDefault(n =>\n                                      string.Equals(n.t ?? \"\", buttonText, StringComparison.OrdinalIgnoreCase))\n                                  ?? nodes.FirstOrDefault(n => Norm(n.t) == Norm(buttonText));\n\n                            if (hit != null)\n                                buttonIndex = (short)hit.i;\n                        }\n                        catch (Exception ex)\n                        {\n                            _logger.LogWarning(ex, \"âš ï¸ Failed to parse ButtonBundleJson\");\n                        }\n                    }\n\n                    // â€”â€” Fallback: find link by TEXT for this step\n                    FlowButtonLink? linkMatchedByText = null;\n                    if (buttonIndex == null)\n                    {\n                        var stepLinks = await _context.FlowButtonLinks\n                            .Where(l => l.CTAFlowStepId == stepId)\n                            .OrderBy(l => l.ButtonIndex)\n                            .ToListAsync();\n\n                        if (stepLinks.Count > 0)\n                        {\n                            linkMatchedByText = stepLinks.FirstOrDefault(l =>\n                                string.Equals(l.ButtonText ?? \"\", buttonText, StringComparison.OrdinalIgnoreCase))\n                                ?? stepLinks.FirstOrDefault(l => Norm(l.ButtonText) == Norm(buttonText));\n\n                            if (linkMatchedByText == null && stepLinks.Count == 1)\n                            {\n                                linkMatchedByText = stepLinks[0];\n                                _logger.LogInformation(\"ðŸŸ¨ Falling back to single available link for step {Step}\", stepId);\n                            }\n\n                            if (linkMatchedByText != null)\n                            {\n                                buttonIndex = (short?)linkMatchedByText.ButtonIndex;\n                                _logger.LogInformation(\"âœ… Mapped click by TEXT to index {Idx} (flow={Flow}, step={Step})\",\n                                    buttonIndex, flowId, stepId);\n                            }\n                        }\n                    }\n\n                    if (buttonIndex == null)\n                    {\n                        _logger.LogInformation(\"ðŸŸ¡ Button text not found in bundle or flow links. Ref={Ref}, Text='{Text}'\",\n                            originalMessageId, buttonText);\n                        continue;\n                    }\n\n                    // â€”â€” Prefer exact link by index; otherwise use the text-matched link\n                    var link = await _flowService.GetLinkAsync(flowId, stepId, buttonIndex.Value)\n                               ?? linkMatchedByText;\n\n                    if (link == null)\n                    {\n                        _logger.LogInformation(\"ðŸŸ¡ No button link for (flow={Flow}, step={Step}, idx={Idx})\",\n                            flowId, stepId, buttonIndex);\n                        continue;\n                    }\n\n                    // â€”â€” Resolve index + step name (for logging)\n                    short resolvedIndex = buttonIndex ?? Convert.ToInt16(link.ButtonIndex);\n                    var stepName = await _context.CTAFlowSteps\n                        .Where(s => s.Id == stepId)\n                        .Select(s => s.TemplateToSend)\n                        .FirstOrDefaultAsync() ?? string.Empty;\n\n                    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n                    // ðŸ“ WRITE CLICK LOG (always, even if terminal)\n                    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n                    try\n                    {\n                        var clickExec = new FlowExecutionLog\n                        {\n                            Id = Guid.NewGuid(),\n                            BusinessId = businessId,\n                            FlowId = flowId,\n                            StepId = stepId,\n                            StepName = stepName,\n                            CampaignSendLogId = campaignSendLogId,\n                            MessageLogId = origin?.Id,\n                            ContactPhone = fromDigits,      // digits-only\n                            ButtonIndex = resolvedIndex,\n                            TriggeredByButton = buttonText,\n                            TemplateName = null,\n                            TemplateType = \"quick_reply\",\n                            Success = true,\n                            ExecutedAt = DateTime.UtcNow,\n                            RequestId = Guid.NewGuid(),\n                            RunId = runId\n                        };\n\n                        _context.FlowExecutionLogs.Add(clickExec);\n                        await _context.SaveChangesAsync();\n                    }\n                    catch (Exception exSave)\n                    {\n                        _logger.LogWarning(exSave, \"âš ï¸ Failed to persist FlowExecutionLog (click). Continuingâ€¦\");\n                    }\n\n                    // ===== RUNNING CTA JOURNEY STATE UPSERT (ONLY IF THIS BIZ IS CONFIGURED) =====\n                    string runningJourney;\n\n                    // Check once if this business is configured to receive CTAJourney.\n                    bool shouldTrackState = await _context.CustomerWebhookConfigs\n                        .AsNoTracking()\n                        .AnyAsync(x => x.BusinessId == businessId && x.IsActive);\n\n                    if (shouldTrackState)\n                    {\n                        try\n                        {\n                            // load current state for (business, flow, phone)\n                            var state = await _context.ContactJourneyStates\n                                .SingleOrDefaultAsync(s =>\n                                    s.BusinessId == businessId &&\n                                    s.FlowId == flowId &&\n                                    s.ContactPhone == fromDigits);\n\n                            if (state == null)\n                            {\n                                // first click -> start with this button text (original casing)\n                                state = new ContactJourneyState\n                                {\n                                    Id = Guid.NewGuid(),\n                                    BusinessId = businessId,\n                                    FlowId = flowId,\n                                    ContactPhone = fromDigits,\n                                    JourneyText = buttonText ?? string.Empty,\n                                    ClickCount = 1,\n                                    LastButtonText = buttonText,\n                                    CreatedAt = DateTime.UtcNow,\n                                    UpdatedAt = DateTime.UtcNow\n                                };\n                                _context.ContactJourneyStates.Add(state);\n                                await _context.SaveChangesAsync();\n                                runningJourney = state.JourneyText;\n                                _logger.LogInformation(\"ðŸ§µ Journey init: {Journey} (biz={Biz}, flow={Flow}, phone={Phone})\",\n                                    runningJourney, businessId, flowId, fromDigits);\n                            }\n                            else\n                            {\n                                // append EVERY press (duplicates allowed), keep original casing\n                                var parts = (state.JourneyText ?? string.Empty)\n                                    .Split('/', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)\n                                    .ToList();\n\n                                if (!string.IsNullOrWhiteSpace(buttonText))\n                                    parts.Add(buttonText!);\n\n                                // cap growth\n                                const int cap = 15;\n                                if (parts.Count > cap) parts = parts.Skip(parts.Count - cap).ToList();\n\n                                state.JourneyText = string.Join('/', parts);\n                                state.ClickCount += 1;\n                                state.LastButtonText = buttonText;\n                                state.UpdatedAt = DateTime.UtcNow;\n\n                                await _context.SaveChangesAsync();\n                                runningJourney = state.JourneyText ?? string.Empty;\n\n                                _logger.LogInformation(\"ðŸ§µ Journey update: {Journey} (biz={Biz}, flow={Flow}, phone={Phone})\",\n                                    runningJourney, businessId, flowId, fromDigits);\n                            }\n                        }\n                        catch (Exception exState)\n                        {\n                            _logger.LogWarning(exState, \"âš ï¸ Failed to upsert ContactJourneyState.\");\n                            // fall back to this click only\n                            runningJourney = buttonText ?? string.Empty;\n                        }\n                    }\n                    else\n                    {\n                        // Business not configured â†’ do NOT save any state. Just use the current button for emit.\n                        runningJourney = buttonText ?? string.Empty;\n                    }\n                    // ===== END RUNNING CTA JOURNEY STATE UPSERT =====\n\n                    // ===== CTAJourney EMIT (running journey) =====\n                    try\n                    {\n                        // contact (for userName / userPhone)\n                        var contact = await _context.Contacts\n                            .AsNoTracking()\n                            .FirstOrDefaultAsync(c => c.BusinessId == businessId && c.PhoneNumber == fromDigits);\n\n                        // Prefer sender from the originating send (keeps the same WABA)\n                        string? senderProvider = null;\n                        string? senderPhoneNumberId = null;\n\n                        if (campaignSendLogId.HasValue)\n                        {\n                            var originSend = await _context.CampaignSendLogs\n                                .AsNoTracking()\n                                .Include(s => s.Campaign)\n                                .Where(s => s.Id == campaignSendLogId.Value)\n                                .Select(s => new { s.Campaign.Provider, s.Campaign.PhoneNumberId })\n                                .FirstOrDefaultAsync();\n\n                            senderProvider = originSend?.Provider;\n                            senderPhoneNumberId = originSend?.PhoneNumberId;\n                        }\n                        if (string.IsNullOrWhiteSpace(senderPhoneNumberId) && origin?.CampaignId != null)\n                        {\n                            var originCamp = await _context.Campaigns\n                                .AsNoTracking()\n                                .Where(c => c.Id == origin.CampaignId.Value)\n                                .Select(c => new { c.Provider, c.PhoneNumberId })\n                                .FirstOrDefaultAsync();\n\n                            senderProvider ??= originCamp?.Provider;\n                            senderPhoneNumberId = originCamp?.PhoneNumberId;\n                        }\n\n                        // Map PhoneNumberId -> WhatsAppBusinessNumber, or choose a default for the same provider\n                        string? waBusinessNumber = null;\n\n                        if (!string.IsNullOrWhiteSpace(senderPhoneNumberId))\n                        {\n                            waBusinessNumber = await _context.WhatsAppPhoneNumbers\n                                .AsNoTracking()\n                                .Where(n => n.BusinessId == businessId && n.PhoneNumberId == senderPhoneNumberId)\n                                .Select(n => n.WhatsAppBusinessNumber)\n                                .FirstOrDefaultAsync();\n                        }\n\n                        if (string.IsNullOrWhiteSpace(waBusinessNumber))\n                        {\n                            var row = await _context.WhatsAppPhoneNumbers\n                                .AsNoTracking()\n                                .Where(n => n.BusinessId == businessId &&\n                                            n.IsActive &&\n                                            (string.IsNullOrEmpty(senderProvider) || n.Provider == senderProvider))\n                                .OrderByDescending(n => n.IsDefault)\n                                .ThenByDescending(n => n.UpdatedAt ?? n.CreatedAt)\n                                .Select(n => new { n.PhoneNumberId, n.WhatsAppBusinessNumber })\n                                .FirstOrDefaultAsync();\n\n                            senderPhoneNumberId ??= row?.PhoneNumberId;\n                            waBusinessNumber = row?.WhatsAppBusinessNumber;\n                        }\n\n                        var dto = CtaJourneyMapper.Build(\n                            journeyKey: runningJourney,                      // running state with original casing\n                            contact: contact,\n                            profileName: contact?.ProfileName ?? contact?.Name,\n                            userId: null,\n                            phoneNumberId: waBusinessNumber,                 // publish WA display number as bot id\n                            businessDisplayPhone: waBusinessNumber,          // same as above\n                            categoryBrowsed: null,\n                            productBrowsed: null\n                        );\n\n                        await _journeyPublisher.PublishAsync(businessId, dto, CancellationToken.None);\n                        _logger.LogInformation(\"ðŸ“¤ CTAJourney posted (running): {Journey} (biz={Biz}, phone={Phone})\",\n                            dto.CTAJourney, businessId, dto.userPhone);\n                    }\n                    catch (Exception ex)\n                    {\n                        _logger.LogWarning(ex, \"âš ï¸ Failed to post CTAJourney (click). Continuingâ€¦\");\n                    }\n                    // ===== end CTAJourney EMIT =====\n\n                    // â€”â€” If terminal/URL button: already logged the click\n                    if (link.NextStepId == null)\n                    {\n                        _logger.LogInformation(\"ðŸ”š Terminal/URL button: no NextStepId. flow={Flow}, step={Step}, idx={Idx}, text='{Text}'\",\n                            flowId, stepId, resolvedIndex, link.ButtonText);\n                        continue;\n                    }\n\n                    if (_flowRuntime == null)\n                    {\n                        _logger.LogError(\"âŒ _flowRuntime is null. Cannot execute next step. flow={Flow}, step={Step}, idx={Idx}\", flowId, stepId, resolvedIndex);\n                        continue;\n                    }\n\n                    // â€”â€” ðŸ”Ž Resolve sender from the originating campaign/send (use SAME WABA) for next step\n                    string? providerFromCampaign = null;\n                    string? phoneNumberIdFromCampaign = null;\n\n                    if (campaignSendLogId.HasValue)\n                    {\n                        var originSend = await _context.CampaignSendLogs\n                            .AsNoTracking()\n                            .Include(s => s.Campaign)\n                            .Where(s => s.Id == campaignSendLogId.Value)\n                            .Select(s => new\n                            {\n                                s.Campaign.Provider,\n                                s.Campaign.PhoneNumberId\n                            })\n                            .FirstOrDefaultAsync();\n\n                        providerFromCampaign = originSend?.Provider;\n                        phoneNumberIdFromCampaign = originSend?.PhoneNumberId;\n                    }\n                    else if (origin != null && origin.CampaignId.HasValue)\n                    {\n                        var originCamp = await _context.Campaigns\n                            .AsNoTracking()\n                            .Where(c => c.Id == origin.CampaignId.Value)\n                            .Select(c => new { c.Provider, c.PhoneNumberId })\n                            .FirstOrDefaultAsync();\n\n                        providerFromCampaign = originCamp?.Provider;\n                        phoneNumberIdFromCampaign = originCamp?.PhoneNumberId;\n                    }\n\n                    // â€”â€” Execute next (carry sender forward)\n                    var ctxObj = new NextStepContext\n                    {\n                        BusinessId = businessId,\n                        FlowId = flowId,\n                        Version = flowVersion ?? 1,\n                        SourceStepId = stepId,\n                        TargetStepId = link.NextStepId!.Value,\n                        ButtonIndex = resolvedIndex,\n                        MessageLogId = origin?.Id ?? Guid.Empty,\n                        ContactPhone = fromDigits,     // digits-only\n                        RequestId = Guid.NewGuid(),\n                        ClickedButton = link,\n\n                        // carry same sender into the next step\n                        Provider = providerFromCampaign,\n                        PhoneNumberId = phoneNumberIdFromCampaign,\n                        AlwaysSend = true // force runtime to send even if itâ€™s a loopback/same step\n                    };\n\n                    try\n                    {\n                        var result = await _flowRuntime.ExecuteNextAsync(ctxObj);\n\n                        if (result.Success && !string.IsNullOrWhiteSpace(result.RedirectUrl))\n                        {\n                            _logger.LogInformation(\"ðŸ”— URL button redirect (logical): {Url}\", result.RedirectUrl);\n                        }\n                    }\n                    catch (Exception exRun)\n                    {\n                        _logger.LogError(exRun,\n                            \"âŒ ExecuteNextAsync failed. ctx: flow={Flow} step={Step} next={Next} idx={Idx} from={From} orig={Orig} text='{Text}'\",\n                            ctxObj.FlowId, ctxObj.SourceStepId, ctxObj.TargetStepId, ctxObj.ButtonIndex, fromDigits, originalMessageId, buttonText);\n                    }\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"âŒ Failed to process CTA button click.\");\n            }\n        }\n\n        private sealed class FlowBtnBundleNode\n        {\n            public int i { get; init; }\n            public string? t { get; init; }   // button text/title\n            public string? ty { get; init; }  // button type (URL/QUICK_REPLY/FLOW)\n            public string? v { get; init; }   // value/payload (e.g., URL)\n            public Guid? ns { get; init; }    // next step id\n        }\n        private static string ToKey(string? s)\n        {\n            if (string.IsNullOrWhiteSpace(s)) return \"unknown\";\n            // letters/digits â†’ lower, spaces/._- â†’ underscore, strip the rest\n            var chars = s.Trim().ToLowerInvariant()\n                .Select(ch => char.IsLetterOrDigit(ch) ? ch : '_')\n                .ToArray();\n            var key = new string(chars);\n            // squeeze duplicate underscores\n            while (key.Contains(\"__\")) key = key.Replace(\"__\", \"_\");\n            return key.Trim('_');\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/Processors/IClickWebhookProcessor.cs",
      "sha256": "5c42427d1e6c36dd122b3a10412eb70d7c412baf00ce54a614491a5b1590afeb",
      "language": "csharp",
      "size": 228,
      "content": "using System.Text.Json;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.Webhooks.Services.Processors\n{\n    public interface IClickWebhookProcessor\n    {\n        Task ProcessClickAsync(JsonElement value);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/Processors/IInboundMessageProcessor.cs",
      "sha256": "ec5496c7810122c99affe09fa17861d6d0c371457d9284e0ba58be6a93ea60f2",
      "language": "csharp",
      "size": 229,
      "content": "using System.Text.Json;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.Webhooks.Services.Processors\n{\n    public interface IInboundMessageProcessor\n    {\n        Task ProcessChatAsync(JsonElement value);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/Processors/InboundMessageProcessor.cs",
      "sha256": "f3ffce0f6dbaf9f28400e14be41bb0622e4450b64a4c6eefddcb3bb0a2608310",
      "language": "csharp",
      "size": 54270,
      "content": "using System;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.SignalR;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api;\nusing xbytechat.api.Features.Inbox.DTOs;\nusing xbytechat.api.Features.CRM.Models;\nusing xbytechat.api.Features.Inbox.Hubs;\nusing Microsoft.Extensions.DependencyInjection;\nusing xbytechat.api.Features.AutoReplyBuilder.Services;\nusing xbytechat.api.Features.Inbox.Services;\nusing xbytechat.api.Features.MessagesEngine.DTOs;\nusing xbytechat.api.Features.MessagesEngine.Services;\nusing xbytechat.api.Features.CRM.Services;\nusing xbytechat.api.Features.Automation.Services;\nusing xbytechat.api.Features.Webhooks.Directory;\nusing xbytechat.api.Features.CRM.Interfaces;\nusing xbytechat.api.Features.CRM.Services; // ðŸ”¹ NEW: provider directory\n\nnamespace xbytechat.api.Features.Webhooks.Services.Processors\n{\n    public class InboundMessageProcessor : IInboundMessageProcessor\n    {\n        private readonly AppDbContext _context;\n        private readonly IHubContext<InboxHub> _hubContext;\n        private readonly ILogger<InboundMessageProcessor> _logger;\n        private readonly IInboxService _inboxService;\n        private readonly IServiceScopeFactory _serviceScopeFactory;\n        private readonly IHubContext<InboxHub> _hub;\n        private readonly IContactProfileService _contactProfile;\n        private readonly IProviderDirectory _providerDirectory; // ðŸ”¹ NEW\n\n        public InboundMessageProcessor(\n            AppDbContext context,\n            IHubContext<InboxHub> hubContext,\n            ILogger<InboundMessageProcessor> logger,\n            IInboxService inboxService,\n            IServiceScopeFactory serviceScopeFactory,\n            IHubContext<InboxHub> hub,\n            IContactProfileService contactProfile,\n            IProviderDirectory providerDirectory // ðŸ”¹ NEW\n        )\n        {\n            _context = context;\n            _hubContext = hubContext;\n            _logger = logger;\n            _inboxService = inboxService;\n            _serviceScopeFactory = serviceScopeFactory;\n            _hub = hub;\n            _contactProfile = contactProfile;\n            _providerDirectory = providerDirectory; // ðŸ”¹ NEW\n        }\n\n        public async Task ProcessChatAsync(JsonElement value)\n        {\n            try\n            {\n                using var scope = _serviceScopeFactory.CreateScope();\n                var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n                var contactService = scope.ServiceProvider.GetRequiredService<IContactService>();\n                var chatSessionStateService = scope.ServiceProvider.GetRequiredService<IChatSessionStateService>();\n                var automationService = scope.ServiceProvider.GetRequiredService<IAutomationService>();\n                var autoReplyRuntime = scope.ServiceProvider.GetRequiredService<IAutoReplyRuntimeService>();\n                var logger = scope.ServiceProvider.GetRequiredService<ILogger<InboundMessageProcessor>>();\n                var contactProfileService = scope.ServiceProvider.GetRequiredService<IContactProfileService>();\n\n                // digits-only normalizer (matches how we store/search phones)\n                static string Normalize(string? s) =>\n                    string.IsNullOrWhiteSpace(s) ? \"\" : new string(s.Where(char.IsDigit).ToArray());\n\n                // 1) Extract WA metadata + message (Meta Cloud shape)\n                if (!value.TryGetProperty(\"messages\", out var messages) || messages.GetArrayLength() == 0)\n                {\n                    logger.LogWarning(\"Inbound WA payload has no messages array.\");\n                    return;\n                }\n\n                var msg = messages[0];\n\n                var msgType = msg.TryGetProperty(\"type\", out var typeProp)\n                    ? typeProp.GetString()\n                    : \"unknown\";\n\n                var rawContactPhone = msg.GetProperty(\"from\").GetString() ?? \"\";\n                var contactPhone = Normalize(rawContactPhone);\n\n                string? content = msgType switch\n                {\n                    \"text\" when msg.TryGetProperty(\"text\", out var t) &&\n                                t.TryGetProperty(\"body\", out var b)\n                                => b.GetString(),\n\n                    \"image\" when msg.TryGetProperty(\"image\", out var img) &&\n                                 img.TryGetProperty(\"caption\", out var cap)\n                                 => cap.GetString(),\n\n                    _ => null\n                };\n\n                logger.LogInformation(\n                    \"ðŸ“¥ Inbound WA message: type={MsgType}, from={From}, preview={Preview}\",\n                    msgType,\n                    rawContactPhone,\n                    content?.Length > 50 ? content[..50] : content\n                );\n\n                // 2) Resolve business via ProviderDirectory first, then fallback to WhatsAppPhoneNumbers\n                if (!value.TryGetProperty(\"metadata\", out var metadata))\n                {\n                    logger.LogWarning(\"Inbound: metadata missing on webhook payload.\");\n                    return;\n                }\n\n                string? displayNumber = metadata.TryGetProperty(\"display_phone_number\", out var dn)\n                    ? dn.GetString()\n                    : null;\n\n                string? phoneNumberId = metadata.TryGetProperty(\"phone_number_id\", out var pn)\n                    ? pn.GetString()\n                    : null;\n\n                string? wabaId = metadata.TryGetProperty(\"waba_id\", out var we)\n                    ? we.GetString()\n                    : null;\n\n                // 2.1 Prefer provider directory (uses provider + phone_number_id + waba_id)\n                Guid? businessId = await _providerDirectory.ResolveBusinessIdAsync(\n                    provider: \"meta_cloud\",          // canonical provider key for Meta Cloud\n                    phoneNumberId: phoneNumberId,\n                    displayPhoneNumber: displayNumber,\n                    wabaId: wabaId,\n                    waId: rawContactPhone           // the WA user id (\"from\")\n                );\n\n                // 2.2 Fallback to legacy WhatsAppPhoneNumbers by display number if needed\n                if (businessId == null && !string.IsNullOrWhiteSpace(displayNumber))\n                {\n                    var cleanIncomingBiz = Normalize(displayNumber);\n\n                    var candidates = await db.WhatsAppPhoneNumbers\n                        .AsNoTracking()\n                        .Where(n => n.IsActive)\n                        .Select(n => new { n.BusinessId, n.WhatsAppBusinessNumber })\n                        .ToListAsync();\n\n                    var numHit = candidates.FirstOrDefault(n =>\n                        Normalize(n.WhatsAppBusinessNumber) == cleanIncomingBiz);\n\n                    if (numHit != null)\n                        businessId = numHit.BusinessId;\n                }\n\n                // 2.3 Still nothing â†’ log and bail\n                if (businessId == null || businessId == Guid.Empty)\n                {\n                    logger.LogWarning(\n                        \"âŒ Inbound: business not resolved. phone_number_id={PhoneId}, display={Display}, waba={Waba}, from={From}\",\n                        phoneNumberId,\n                        displayNumber,\n                        wabaId,\n                        rawContactPhone\n                    );\n                    return;\n                }\n\n                var resolvedBusinessId = businessId.Value;\n\n                // 3) Find or create contact\n                var contact = await contactService.FindOrCreateAsync(resolvedBusinessId, contactPhone);\n                if (contact == null)\n                {\n                    logger.LogWarning(\"âŒ Could not resolve contact for phone: {Phone}\", contactPhone);\n                    return;\n                }\n\n                // Extract profile name (contacts[0].profile.name) and upsert into Contacts\n                static string? TryGetProfileName(JsonElement root)\n                {\n                    if (root.TryGetProperty(\"contacts\", out var contactsEl) &&\n                        contactsEl.ValueKind == JsonValueKind.Array &&\n                        contactsEl.GetArrayLength() > 0)\n                    {\n                        var c0 = contactsEl[0];\n                        if (c0.TryGetProperty(\"profile\", out var prof) &&\n                            prof.ValueKind == JsonValueKind.Object &&\n                            prof.TryGetProperty(\"name\", out var nm) &&\n                            nm.ValueKind == JsonValueKind.String)\n                        {\n                            var n = nm.GetString();\n                            return string.IsNullOrWhiteSpace(n) ? null : n!.Trim();\n                        }\n                    }\n                    return null;\n                }\n\n                var profileName = TryGetProfileName(value);\n                if (!string.IsNullOrWhiteSpace(profileName))\n                {\n                    try\n                    {\n                        await contactProfileService.UpsertProfileNameAsync(\n                            resolvedBusinessId,\n                            contactPhone,\n                            profileName!,\n                            CancellationToken.None);\n                    }\n                    catch (Exception ex)\n                    {\n                        logger.LogWarning(ex, \"âš ï¸ Failed to upsert ProfileName for {Phone}\", contactPhone);\n                    }\n                }\n\n                // 4) Check chat modeâ€¦\n                var mode = await chatSessionStateService.GetChatModeAsync(resolvedBusinessId, contact.Id);\n                var isAgentMode = mode == \"agent\";\n\n                // 5) Log incoming message\n                var messageLog = new MessageLog\n                {\n                    Id = Guid.NewGuid(),\n                    BusinessId = resolvedBusinessId,\n                    ContactId = contact.Id,\n                    RecipientNumber = contactPhone,\n                    MessageContent = content,\n                    Status = \"received\",\n                    CreatedAt = DateTime.UtcNow,\n                    SentAt = DateTime.UtcNow,\n                    IsIncoming = true\n                };\n\n                db.MessageLogs.Add(messageLog);\n                await db.SaveChangesAsync();\n\n                await _hub.Clients\n                    .Group($\"business_{resolvedBusinessId}\")\n                    .SendAsync(\"ReceiveInboxMessage\", new\n                    {\n                        contactId = contact.Id,\n                        message = messageLog.MessageContent,\n                        isIncoming = true,\n                        senderId = (Guid?)null,\n                        sentAt = messageLog.CreatedAt\n                    });\n\n                // 6) Try AutoReply runtime first, then fall back to legacy automation\n                try\n                {\n                    var triggerRaw = (content ?? string.Empty).Trim();\n                    var triggerKeyword = triggerRaw.ToLowerInvariant();\n\n                    var autoHandled = false;\n\n                    // 6.1 â€“ New AutoReply runtime (keyword â†’ simple reply or CTA flow)\n                    if (!string.IsNullOrWhiteSpace(triggerRaw))\n                    {\n                        var autoResult = await autoReplyRuntime.TryHandleAsync(\n                            resolvedBusinessId,\n                            contact.Id,\n                            contact.PhoneNumber,\n                            triggerRaw,                // pass original text (not forced lowercase)\n                            CancellationToken.None     // you can thread a real ct later if you extend the method\n                        );\n\n                        autoHandled = autoResult.Handled;\n\n                        if (autoResult.Handled)\n                        {\n                            logger.LogInformation(\n                                \"ðŸ¤– AutoReply runtime handled inbound message. BusinessId={BusinessId}, ContactId={ContactId}, Keyword={Keyword}, SentSimpleReply={SentSimpleReply}, StartedCtaFlow={StartedCtaFlow}, AutoReplyFlowId={FlowId}, CtaFlowConfigId={CtaId}\",\n                                resolvedBusinessId,\n                                contact.Id,\n                                triggerKeyword,\n                                autoResult.SentSimpleReply,\n                                autoResult.StartedCtaFlow,\n                                autoResult.AutoReplyFlowId,\n                                autoResult.CtaFlowConfigId\n                            );\n                        }\n                        else\n                        {\n                            logger.LogInformation(\n                                \"ðŸ¤– AutoReply runtime did not handle message. Falling back to legacy automation. Keyword={Keyword}\",\n                                triggerKeyword\n                            );\n                        }\n                    }\n\n                    // 6.2 â€“ Legacy AutomationService fallback (only if AutoReply did NOT handle)\n                    if (!autoHandled)\n                    {\n                        var handledByLegacy = await automationService.TryRunFlowByKeywordAsync(\n                            resolvedBusinessId,\n                            triggerKeyword,\n                            contact.PhoneNumber,\n                            sourceChannel: \"whatsapp\",\n                            industryTag: \"default\");\n\n                        if (!handledByLegacy)\n                        {\n                            logger.LogInformation(\"ðŸ•µï¸ No automation flow matched keyword (legacy): {Keyword}\", triggerKeyword);\n                        }\n                    }\n                }\n                catch (Exception ex)\n                {\n                    logger.LogError(ex, \"âŒ AutoReply / Automation flow execution failed.\");\n                }\n\n\n                // 7) Sync to inbox only if agent mode\n                if (isAgentMode)\n                {\n                    try\n                    {\n                        var inboxService = scope.ServiceProvider.GetRequiredService<IInboxService>();\n\n                        logger.LogInformation(\n                            \"ðŸ“¥ Inbound: syncing message to inbox for BusinessId={BusinessId}, ContactId={ContactId}\",\n                            resolvedBusinessId,\n                            contact.Id);\n\n                        await inboxService.SaveIncomingMessageAsync(new InboxMessageDto\n                        {\n                            BusinessId = resolvedBusinessId,\n                            ContactId = contact.Id,\n                            RecipientPhone = contact.PhoneNumber,\n                            MessageBody = messageLog.MessageContent,\n                            IsIncoming = true,\n                            Status = messageLog.Status,\n                            SentAt = messageLog.CreatedAt\n                        });\n\n                        logger.LogInformation(\"âœ… Message synced to inbox for contact {Phone}\", contactPhone);\n                    }\n                    catch (Exception ex)\n                    {\n                        logger.LogError(ex, \"âŒ Failed to sync inbound message to inbox.\");\n                    }\n                }\n                else\n                {\n                    logger.LogInformation(\"ðŸš« Skipping inbox sync: chat mode is not 'agent'\");\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"âŒ Failed to process inbound WhatsApp chat.\");\n            }\n        }\n\n        public async Task ProcessInteractiveAsync(JsonElement value, CancellationToken ct = default)\n        {\n            using var scope = _serviceScopeFactory.CreateScope();\n            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n            var contactProfileService = scope.ServiceProvider.GetRequiredService<IContactProfileService>();\n            var logger = scope.ServiceProvider.GetRequiredService<ILogger<InboundMessageProcessor>>();\n\n            static string Normalize(string? number) =>\n                string.IsNullOrWhiteSpace(number) ? \"\" : new string(number.Where(char.IsDigit).ToArray());\n\n            // Safe extract of profile name (Meta Cloud shape)\n            static string? TryGetProfileName(JsonElement root)\n            {\n                if (root.TryGetProperty(\"contacts\", out var contactsEl) &&\n                    contactsEl.ValueKind == JsonValueKind.Array &&\n                    contactsEl.GetArrayLength() > 0)\n                {\n                    var c0 = contactsEl[0];\n                    if (c0.TryGetProperty(\"profile\", out var profileEl) &&\n                        profileEl.ValueKind == JsonValueKind.Object &&\n                        profileEl.TryGetProperty(\"name\", out var nameEl) &&\n                        nameEl.ValueKind == JsonValueKind.String)\n                    {\n                        var n = nameEl.GetString();\n                        return string.IsNullOrWhiteSpace(n) ? null : n!.Trim();\n                    }\n                }\n                return null;\n            }\n\n            // messages[0].from is always present for interactive/button\n            if (!value.TryGetProperty(\"messages\", out var msgs) || msgs.GetArrayLength() == 0)\n                return;\n\n            var msg0 = msgs[0];\n            var fromRaw = msg0.GetProperty(\"from\").GetString() ?? \"\";\n            var fromE164 = Normalize(fromRaw);\n\n            // Resolve Business via metadata.display_phone_number â†’ WhatsAppPhoneNumbers\n            var displayNumberRaw = value.GetProperty(\"metadata\").GetProperty(\"display_phone_number\").GetString() ?? \"\";\n            var displayNumber = Normalize(displayNumberRaw);\n\n            // Look up the business by matching the normalized number in WhatsAppPhoneNumbers\n            var candidates = await db.WhatsAppPhoneNumbers\n                .AsNoTracking()\n                .Where(n => n.IsActive)\n                .Select(n => new { n.BusinessId, n.WhatsAppBusinessNumber })\n                .ToListAsync(ct);\n\n            var numHit = candidates.FirstOrDefault(n => Normalize(n.WhatsAppBusinessNumber) == displayNumber);\n            if (numHit == null)\n            {\n                logger.LogWarning(\"âŒ Business not found for interactive webhook number: {Num}\", displayNumberRaw);\n                return;\n            }\n\n            var businessId = numHit.BusinessId;\n\n            // Upsert profile name if present\n            var profileName = TryGetProfileName(value);\n            if (!string.IsNullOrWhiteSpace(profileName))\n            {\n                try\n                {\n                    await contactProfileService.UpsertProfileNameAsync(businessId, fromE164, profileName!, ct);\n                }\n                catch (Exception ex)\n                {\n                    logger.LogWarning(ex, \"âš ï¸ Failed to upsert ProfileName on interactive webhook for {Phone}\", fromE164);\n                }\n            }\n\n            // â€¦ continue your existing interactive handling (routing to next step, etc.)\n        }\n    }\n}\n\n\n//using System;\n//using System.Text.Json;\n//using System.Threading.Tasks;\n//using Microsoft.AspNetCore.SignalR;\n//using Microsoft.EntityFrameworkCore;\n//using Microsoft.Extensions.Logging;\n//using xbytechat.api;\n//using xbytechat.api.Features.Inbox.DTOs;\n//using xbytechat.api.CRM.Models;\n//using xbytechat.api.Features.Inbox.Hubs;\n//using Microsoft.Extensions.DependencyInjection;\n//using xbytechat.api.CRM.Interfaces;\n//using xbytechat.api.Features.AutoReplyBuilder.Services;\n//using xbytechat.api.Features.Inbox.Services;\n//using xbytechat.api.Features.MessagesEngine.DTOs;\n//using xbytechat.api.Features.MessagesEngine.Services;\n//using xbytechat.api.CRM.Services;\n//using xbytechat.api.Features.Automation.Services;\n//using xbytechat.api.Features.Contacts.Services;\n\n//namespace xbytechat.api.Features.Webhooks.Services.Processors\n//{\n//    public class InboundMessageProcessor : IInboundMessageProcessor\n//    {\n//        private readonly AppDbContext _context;\n//        private readonly IHubContext<InboxHub> _hubContext;\n//        private readonly ILogger<InboundMessageProcessor> _logger;\n//        private readonly IInboxService _inboxService;\n//        private readonly IServiceScopeFactory _serviceScopeFactory;\n//        private readonly IHubContext<InboxHub> _hub;\n//        private readonly IContactProfileService _contactProfile;\n\n//        public InboundMessageProcessor(\n//            AppDbContext context,\n//            IHubContext<InboxHub> hubContext,\n//            ILogger<InboundMessageProcessor> logger,\n//            IInboxService inboxService,\n//            IServiceScopeFactory serviceScopeFactory,\n//            IHubContext<InboxHub> hub,\n//            IContactProfileService contactProfile)\n//        {\n//            _context = context;\n//            _hubContext = hubContext;\n//            _logger = logger;\n//            _inboxService = inboxService;\n//            _serviceScopeFactory = serviceScopeFactory;\n//            _hub = hub;\n//            _contactProfile = contactProfile;\n//        }\n\n//        //public async Task ProcessChatAsync(JsonElement value)\n//        //{\n//        //    // High-level trace for every inbound chat\n//        //    try\n//        //    {\n//        //        var rawText = value.GetRawText();\n//        //        _logger.LogInformation(\n//        //            \"ðŸ’¬ InboundMessageProcessor.ProcessChatAsync started. PayloadLength={Length}\",\n//        //            rawText?.Length ?? 0);\n//        //    }\n//        //    catch\n//        //    {\n//        //        // ignore any GetRawText failures â€“ not critical\n//        //    }\n\n//        //    try\n//        //    {\n//        //        using var scope = _serviceScopeFactory.CreateScope();\n//        //        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n//        //        var contactService = scope.ServiceProvider.GetRequiredService<IContactService>();\n//        //        var chatSessionStateService = scope.ServiceProvider.GetRequiredService<IChatSessionStateService>();\n//        //        var automationService = scope.ServiceProvider.GetRequiredService<IAutomationService>();\n//        //        var logger = scope.ServiceProvider.GetRequiredService<ILogger<InboundMessageProcessor>>();\n//        //        var contactProfileService = scope.ServiceProvider.GetRequiredService<IContactProfileService>();\n\n//        //        // digits-only normalizer (matches how we store/search phones)\n//        //        static string Normalize(string? s) =>\n//        //            string.IsNullOrWhiteSpace(s) ? \"\" : new string(s.Where(char.IsDigit).ToArray());\n\n//        //        // 1) Extract WA metadata + message (Meta Cloud shape)\n//        //        if (!value.TryGetProperty(\"messages\", out var msgs) || msgs.GetArrayLength() == 0)\n//        //        {\n//        //            logger.LogWarning(\"âŒ Inbound payload has no 'messages' array or it is empty.\");\n//        //            return;\n//        //        }\n\n//        //        var msg = msgs[0];\n\n//        //        var rawContactPhone = msg.GetProperty(\"from\").GetString() ?? \"\";\n//        //        var contactPhone = Normalize(rawContactPhone);\n//        //        var content = msg.TryGetProperty(\"text\", out var t) && t.TryGetProperty(\"body\", out var b)\n//        //            ? b.GetString()\n//        //            : null;\n\n//        //        if (!value.TryGetProperty(\"metadata\", out var metadata))\n//        //        {\n//        //            logger.LogWarning(\"âŒ Inbound payload missing 'metadata' field.\");\n//        //            return;\n//        //        }\n\n//        //        var rawBusinessNumber = metadata.GetProperty(\"display_phone_number\").GetString() ?? \"\";\n//        //        var cleanIncomingBiz = Normalize(rawBusinessNumber);\n\n//        //        logger.LogInformation(\n//        //            \"ðŸ”Ž Inbound extract: rawContactPhone={RawContact}, normalizedContact={Contact}, rawBusinessNumber={RawBiz}, normalizedBiz={Biz}\",\n//        //            rawContactPhone,\n//        //            contactPhone,\n//        //            rawBusinessNumber,\n//        //            cleanIncomingBiz);\n\n//        //        // 2) Resolve business  âœ… now via WhatsAppPhoneNumbers (NOT WhatsAppSettings)\n//        //        Guid? businessIdHit = null;\n\n//        //        // Pull active numbers (small table; client-side normalization for reliability)\n//        //        var candidates = await db.WhatsAppPhoneNumbers\n//        //            .AsNoTracking()\n//        //            .Where(n => n.IsActive)\n//        //            .Select(n => new { n.BusinessId, n.WhatsAppBusinessNumber })\n//        //            .ToListAsync();\n\n//        //        logger.LogDebug(\"ðŸ“Š Inbound: Loaded {Count} active WhatsAppPhoneNumbers candidates.\", candidates.Count);\n\n//        //        var numHit = candidates.FirstOrDefault(n => Normalize(n.WhatsAppBusinessNumber) == cleanIncomingBiz);\n//        //        if (numHit != null)\n//        //        {\n//        //            businessIdHit = numHit.BusinessId;\n//        //            logger.LogInformation(\n//        //                \"âœ… Inbound: resolved BusinessId={BusinessId} for display_phone_number={RawBiz}\",\n//        //                businessIdHit,\n//        //                rawBusinessNumber);\n//        //        }\n\n//        //        if (businessIdHit == null || businessIdHit == Guid.Empty)\n//        //        {\n//        //            logger.LogWarning(\n//        //                \"âŒ Business not found for WhatsApp number: {Number} (normalized={Norm})\",\n//        //                rawBusinessNumber,\n//        //                cleanIncomingBiz);\n//        //            return;\n//        //        }\n\n//        //        var businessId = businessIdHit.Value;\n\n//        //        // 3) Find or create contact\n//        //        logger.LogInformation(\n//        //            \"ðŸ‘¤ Inbound: resolving contact for BusinessId={BusinessId}, Phone={Phone}\",\n//        //            businessId,\n//        //            contactPhone);\n\n//        //        var contact = await contactService.FindOrCreateAsync(businessId, contactPhone);\n//        //        if (contact == null)\n//        //        {\n//        //            logger.LogWarning(\"âŒ Could not resolve contact for phone: {Phone}\", contactPhone);\n//        //            return;\n//        //        }\n\n//        //        logger.LogInformation(\"âœ… Inbound: contact resolved. ContactId={ContactId}\", contact.Id);\n\n//        //        // Extract profile name (contacts[0].profile.name) and upsert into Contacts\n//        //        static string? TryGetProfileName(JsonElement root)\n//        //        {\n//        //            if (root.TryGetProperty(\"contacts\", out var contactsEl) &&\n//        //                contactsEl.ValueKind == JsonValueKind.Array &&\n//        //                contactsEl.GetArrayLength() > 0)\n//        //            {\n//        //                var c0 = contactsEl[0];\n//        //                if (c0.TryGetProperty(\"profile\", out var prof) &&\n//        //                    prof.ValueKind == JsonValueKind.Object &&\n//        //                    prof.TryGetProperty(\"name\", out var nm) &&\n//        //                    nm.ValueKind == JsonValueKind.String)\n//        //                {\n//        //                    var n = nm.GetString();\n//        //                    return string.IsNullOrWhiteSpace(n) ? null : n!.Trim();\n//        //                }\n//        //            }\n//        //            return null;\n//        //        }\n\n//        //        var profileName = TryGetProfileName(value);\n//        //        if (!string.IsNullOrWhiteSpace(profileName))\n//        //        {\n//        //            try\n//        //            {\n//        //                logger.LogInformation(\n//        //                    \"ðŸ§¾ Inbound: upserting profile name for BusinessId={BusinessId}, Phone={Phone}, Name={Name}\",\n//        //                    businessId,\n//        //                    contactPhone,\n//        //                    profileName);\n\n//        //                await contactProfileService.UpsertProfileNameAsync(\n//        //                    businessId,\n//        //                    contactPhone,\n//        //                    profileName!,\n//        //                    CancellationToken.None);\n//        //            }\n//        //            catch (Exception ex)\n//        //            {\n//        //                logger.LogWarning(ex, \"âš ï¸ Failed to upsert ProfileName for {Phone}\", contactPhone);\n//        //            }\n//        //        }\n\n//        //        // 4) Check chat modeâ€¦\n//        //        var mode = await chatSessionStateService.GetChatModeAsync(businessId, contact.Id);\n//        //        var isAgentMode = mode == \"agent\";\n\n//        //        logger.LogInformation(\n//        //            \"ðŸ’¬ Inbound: chat mode for contact {ContactId} is '{Mode}' (isAgentMode={IsAgentMode})\",\n//        //            contact.Id,\n//        //            mode,\n//        //            isAgentMode);\n\n//        //        // 5) Log incoming message\n//        //        var messageLog = new MessageLog\n//        //        {\n//        //            Id = Guid.NewGuid(),\n//        //            BusinessId = businessId,\n//        //            ContactId = contact.Id,\n//        //            RecipientNumber = contactPhone,\n//        //            MessageContent = content,\n//        //            Status = \"received\",\n//        //            CreatedAt = DateTime.UtcNow,\n//        //            SentAt = DateTime.UtcNow,\n//        //            IsIncoming = true\n//        //        };\n\n//        //        db.MessageLogs.Add(messageLog);\n//        //        await db.SaveChangesAsync();\n\n//        //        logger.LogInformation(\n//        //            \"ðŸ“ Inbound: MessageLog saved. MessageLogId={MessageLogId}, BusinessId={BusinessId}, ContactId={ContactId}\",\n//        //            messageLog.Id,\n//        //            businessId,\n//        //            contact.Id);\n\n//        //        // 6) Notify Inbox clients via SignalR\n//        //        try\n//        //        {\n//        //            var groupName = $\"business_{businessId}\";\n//        //            logger.LogInformation(\n//        //                \"ðŸ“¡ Inbound: broadcasting ReceiveInboxMessage to SignalR group {GroupName} for ContactId={ContactId}\",\n//        //                groupName,\n//        //                contact.Id);\n\n//        //            await _hub.Clients\n//        //                .Group(groupName)\n//        //                .SendAsync(\"ReceiveInboxMessage\", new\n//        //                {\n//        //                    contactId = contact.Id,\n//        //                    message = messageLog.MessageContent,\n//        //                    isIncoming = true,\n//        //                    senderId = (Guid?)null,\n//        //                    sentAt = messageLog.CreatedAt\n//        //                });\n//        //        }\n//        //        catch (Exception ex)\n//        //        {\n//        //            logger.LogWarning(ex, \"âš ï¸ Inbound: failed to broadcast ReceiveInboxMessage to SignalR.\");\n//        //        }\n\n//        //        // 7) Try to trigger automation by keyword\n//        //        try\n//        //        {\n//        //            var triggerKeyword = (content ?? string.Empty).Trim().ToLowerInvariant();\n//        //            logger.LogInformation(\n//        //                \"âš™ï¸ Inbound: attempting automation flow match for keyword='{Keyword}'\",\n//        //                triggerKeyword);\n\n//        //            var handled = await automationService.TryRunFlowByKeywordAsync(\n//        //                businessId,\n//        //                triggerKeyword,\n//        //                contact.PhoneNumber,\n//        //                sourceChannel: \"whatsapp\",\n//        //                industryTag: \"default\");\n\n//        //            if (!handled)\n//        //                logger.LogInformation(\"ðŸ•µï¸ No automation flow matched keyword: {Keyword}\", triggerKeyword);\n//        //            else\n//        //                logger.LogInformation(\"âœ… Automation flow handled inbound keyword: {Keyword}\", triggerKeyword);\n//        //        }\n//        //        catch (Exception ex)\n//        //        {\n//        //            logger.LogError(ex, \"âŒ Automation flow execution failed.\");\n//        //        }\n\n//        //        // 8) Sync to inbox only if agent mode\n//        //        if (isAgentMode)\n//        //        {\n//        //            try\n//        //            {\n//        //                var inboxService = scope.ServiceProvider.GetRequiredService<IInboxService>();\n\n//        //                logger.LogInformation(\n//        //                    \"ðŸ“¥ Inbound: syncing message to inbox for BusinessId={BusinessId}, ContactId={ContactId}\",\n//        //                    businessId,\n//        //                    contact.Id);\n\n//        //                await inboxService.SaveIncomingMessageAsync(new InboxMessageDto\n//        //                {\n//        //                    BusinessId = businessId,\n//        //                    ContactId = contact.Id,\n//        //                    RecipientPhone = contact.PhoneNumber,\n//        //                    MessageBody = messageLog.MessageContent,\n//        //                    IsIncoming = true,\n//        //                    Status = messageLog.Status,\n//        //                    SentAt = messageLog.CreatedAt\n//        //                });\n\n//        //                logger.LogInformation(\"âœ… Message synced to inbox for contact {Phone}\", contactPhone);\n//        //            }\n//        //            catch (Exception ex)\n//        //            {\n//        //                logger.LogError(ex, \"âŒ Failed to sync inbound message to inbox.\");\n//        //            }\n//        //        }\n//        //        else\n//        //        {\n//        //            logger.LogInformation(\"ðŸš« Skipping inbox sync: chat mode is not 'agent'\");\n//        //        }\n//        //    }\n//        //    catch (Exception ex)\n//        //    {\n//        //        _logger.LogError(ex, \"âŒ Failed to process inbound WhatsApp chat.\");\n//        //    }\n//        //}\n\n//        public async Task ProcessInteractiveAsync(JsonElement value, CancellationToken ct = default)\n//        {\n//            _logger.LogInformation(\"ðŸ’¬ InboundMessageProcessor.ProcessInteractiveAsync started.\");\n\n//            using var scope = _serviceScopeFactory.CreateScope();\n//            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n//            var contactProfileService = scope.ServiceProvider.GetRequiredService<IContactProfileService>();\n//            var logger = scope.ServiceProvider.GetRequiredService<ILogger<InboundMessageProcessor>>();\n\n//            static string Normalize(string? number) =>\n//                string.IsNullOrWhiteSpace(number) ? \"\" : new string(number.Where(char.IsDigit).ToArray());\n\n//            // Safe extract of profile name (Meta Cloud shape)\n//            static string? TryGetProfileName(JsonElement root)\n//            {\n//                if (root.TryGetProperty(\"contacts\", out var contactsEl) &&\n//                    contactsEl.ValueKind == JsonValueKind.Array &&\n//                    contactsEl.GetArrayLength() > 0)\n//                {\n//                    var c0 = contactsEl[0];\n//                    if (c0.TryGetProperty(\"profile\", out var profileEl) &&\n//                        profileEl.ValueKind == JsonValueKind.Object &&\n//                        profileEl.TryGetProperty(\"name\", out var nameEl) &&\n//                        nameEl.ValueKind == JsonValueKind.String)\n//                    {\n//                        var n = nameEl.GetString();\n//                        return string.IsNullOrWhiteSpace(n) ? null : n!.Trim();\n//                    }\n//                }\n//                return null;\n//            }\n\n//            // messages[0].from is always present for interactive/button\n//            if (!value.TryGetProperty(\"messages\", out var msgs) || msgs.GetArrayLength() == 0)\n//            {\n//                logger.LogWarning(\"âŒ Interactive payload has no 'messages' array or it is empty.\");\n//                return;\n//            }\n\n//            var msg0 = msgs[0];\n//            var fromRaw = msg0.GetProperty(\"from\").GetString() ?? \"\";\n//            var fromE164 = Normalize(fromRaw);\n\n//            logger.LogInformation(\n//                \"ðŸ”Ž Interactive: fromRaw={FromRaw}, normalized={FromNorm}\",\n//                fromRaw,\n//                fromE164);\n\n//            // Resolve Business via metadata.display_phone_number â†’ WhatsAppPhoneNumbers\n//            if (!value.TryGetProperty(\"metadata\", out var metadata))\n//            {\n//                logger.LogWarning(\"âŒ Interactive payload missing 'metadata' field.\");\n//                return;\n//            }\n\n//            var displayNumberRaw = metadata.GetProperty(\"display_phone_number\").GetString() ?? \"\";\n//            var displayNumber = Normalize(displayNumberRaw);\n\n//            logger.LogInformation(\n//                \"ðŸ”Ž Interactive: display_phone_number raw={Raw}, normalized={Norm}\",\n//                displayNumberRaw,\n//                displayNumber);\n\n//            // Look up the business by matching the normalized number in WhatsAppPhoneNumbers\n//            var candidates = await db.WhatsAppPhoneNumbers\n//                .AsNoTracking()\n//                .Where(n => n.IsActive)\n//                .Select(n => new { n.BusinessId, n.WhatsAppBusinessNumber })\n//                .ToListAsync(ct);\n\n//            logger.LogDebug(\"ðŸ“Š Interactive: Loaded {Count} active WhatsAppPhoneNumbers candidates.\", candidates.Count);\n\n//            var numHit = candidates.FirstOrDefault(n => Normalize(n.WhatsAppBusinessNumber) == displayNumber);\n//            if (numHit == null)\n//            {\n//                logger.LogWarning(\n//                    \"âŒ Business not found for interactive webhook number: {NumRaw} (normalized={Norm})\",\n//                    displayNumberRaw,\n//                    displayNumber);\n//                return;\n//            }\n\n//            var businessId = numHit.BusinessId;\n//            logger.LogInformation(\n//                \"âœ… Interactive: resolved BusinessId={BusinessId} for number={NumRaw}\",\n//                businessId,\n//                displayNumberRaw);\n\n//            // Upsert profile name if present\n//            var profileName = TryGetProfileName(value);\n//            if (!string.IsNullOrWhiteSpace(profileName))\n//            {\n//                try\n//                {\n//                    logger.LogInformation(\n//                        \"ðŸ§¾ Interactive: upserting profile name for BusinessId={BusinessId}, Phone={Phone}, Name={Name}\",\n//                        businessId,\n//                        fromE164,\n//                        profileName);\n\n//                    await contactProfileService.UpsertProfileNameAsync(\n//                        businessId,\n//                        fromE164,\n//                        profileName!,\n//                        ct);\n//                }\n//                catch (Exception ex)\n//                {\n//                    logger.LogWarning(\n//                        ex,\n//                        \"âš ï¸ Failed to upsert ProfileName on interactive webhook for {Phone}\",\n//                        fromE164);\n//                }\n//            }\n\n//            // â€¦ your existing interactive handling continues (routing to next step, etc.)\n//        }\n//    }\n//}\n\n\n////using System;\n////using System.Text.Json;\n////using System.Threading.Tasks;\n////using Microsoft.AspNetCore.SignalR;\n////using Microsoft.EntityFrameworkCore;\n////using Microsoft.Extensions.Logging;\n////using xbytechat.api;\n////using xbytechat.api.Features.Inbox.DTOs;\n////using xbytechat.api.CRM.Models;\n////using xbytechat.api.Features.Inbox.Hubs;\n////using Microsoft.Extensions.DependencyInjection;\n////using xbytechat.api.CRM.Interfaces;\n////using xbytechat.api.Features.AutoReplyBuilder.Services;\n////using xbytechat.api.Features.Inbox.Services;\n////using xbytechat.api.Features.MessagesEngine.DTOs;\n////using xbytechat.api.Features.MessagesEngine.Services;\n////using xbytechat.api.CRM.Services;\n////using xbytechat.api.Features.Automation.Services;\n////using xbytechat.api.Features.Contacts.Services;\n\n\n////namespace xbytechat.api.Features.Webhooks.Services.Processors\n////{\n////    public class InboundMessageProcessor : IInboundMessageProcessor\n////    {\n////        private readonly AppDbContext _context;\n////        private readonly IHubContext<InboxHub> _hubContext;\n////        private readonly ILogger<InboundMessageProcessor> _logger;\n////        private readonly IInboxService _inboxService;\n////        private readonly IServiceScopeFactory _serviceScopeFactory;\n////        private readonly IHubContext<InboxHub> _hub;\n////        private readonly IContactProfileService _contactProfile;\n////        public InboundMessageProcessor(\n////            AppDbContext context,\n////            IHubContext<InboxHub> hubContext,\n////            ILogger<InboundMessageProcessor> logger,\n////            IInboxService inboxService,\n////            IServiceScopeFactory serviceScopeFactory,\n////            IHubContext<InboxHub> hub, IContactProfileService contactProfile)\n////        {\n////            _context = context;\n////            _hubContext = hubContext;\n////            _logger = logger;\n////            _inboxService = inboxService;\n////            _serviceScopeFactory = serviceScopeFactory;\n////            _hub = hub;\n////            _contactProfile = contactProfile;\n////        }\n\n////        public async Task ProcessChatAsync(JsonElement value)\n////        {\n////            try\n////            {\n////                using var scope = _serviceScopeFactory.CreateScope();\n////                var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n////                var contactService = scope.ServiceProvider.GetRequiredService<IContactService>();\n////                var chatSessionStateService = scope.ServiceProvider.GetRequiredService<IChatSessionStateService>();\n////                var automationService = scope.ServiceProvider.GetRequiredService<IAutomationService>();\n////                var logger = scope.ServiceProvider.GetRequiredService<ILogger<InboundMessageProcessor>>();\n////                var contactProfileService = scope.ServiceProvider.GetRequiredService<IContactProfileService>();\n\n////                // digits-only normalizer (matches how we store/search phones)\n////                static string Normalize(string? s) =>\n////                    string.IsNullOrWhiteSpace(s) ? \"\" : new string(s.Where(char.IsDigit).ToArray());\n\n////                // 1) Extract WA metadata + message (Meta Cloud shape)\n////                var msg = value.GetProperty(\"messages\")[0];\n////                var rawContactPhone = msg.GetProperty(\"from\").GetString() ?? \"\";\n////                var contactPhone = Normalize(rawContactPhone);\n////                var content = msg.TryGetProperty(\"text\", out var t) && t.TryGetProperty(\"body\", out var b) ? b.GetString() : null;\n\n////                var rawBusinessNumber = value.GetProperty(\"metadata\").GetProperty(\"display_phone_number\").GetString() ?? \"\";\n////                var cleanIncomingBiz = Normalize(rawBusinessNumber);\n\n////                // 2) Resolve business  âœ… now via WhatsAppPhoneNumbers (NOT WhatsAppSettings)\n////                Guid? businessIdHit = null;\n\n////                // Pull active numbers (small table; client-side normalization for reliability)\n////                var candidates = await db.WhatsAppPhoneNumbers\n////                    .AsNoTracking()\n////                    .Where(n => n.IsActive)\n////                    .Select(n => new { n.BusinessId, n.WhatsAppBusinessNumber })\n////                    .ToListAsync();\n\n////                var numHit = candidates.FirstOrDefault(n => Normalize(n.WhatsAppBusinessNumber) == cleanIncomingBiz);\n////                if (numHit != null) businessIdHit = numHit.BusinessId;\n\n////                if (businessIdHit == null || businessIdHit == Guid.Empty)\n////                {\n////                    logger.LogWarning(\"âŒ Business not found for WhatsApp number: {Number}\", rawBusinessNumber);\n////                    return;\n////                }\n\n////                var businessId = businessIdHit.Value;\n\n////                // 3) Find or create contact\n////                var contact = await contactService.FindOrCreateAsync(businessId, contactPhone);\n////                if (contact == null)\n////                {\n////                    logger.LogWarning(\"âŒ Could not resolve contact for phone: {Phone}\", contactPhone);\n////                    return;\n////                }\n\n////                // Extract profile name (contacts[0].profile.name) and upsert into Contacts\n////                static string? TryGetProfileName(JsonElement root)\n////                {\n////                    if (root.TryGetProperty(\"contacts\", out var contactsEl) &&\n////                        contactsEl.ValueKind == JsonValueKind.Array &&\n////                        contactsEl.GetArrayLength() > 0)\n////                    {\n////                        var c0 = contactsEl[0];\n////                        if (c0.TryGetProperty(\"profile\", out var prof) &&\n////                            prof.ValueKind == JsonValueKind.Object &&\n////                            prof.TryGetProperty(\"name\", out var nm) &&\n////                            nm.ValueKind == JsonValueKind.String)\n////                        {\n////                            var n = nm.GetString();\n////                            return string.IsNullOrWhiteSpace(n) ? null : n!.Trim();\n////                        }\n////                    }\n////                    return null;\n////                }\n\n////                var profileName = TryGetProfileName(value);\n////                if (!string.IsNullOrWhiteSpace(profileName))\n////                {\n////                    try\n////                    {\n////                        await contactProfileService.UpsertProfileNameAsync(businessId, contactPhone, profileName!, CancellationToken.None);\n////                    }\n////                    catch (Exception ex)\n////                    {\n////                        logger.LogWarning(ex, \"âš ï¸ Failed to upsert ProfileName for {Phone}\", contactPhone);\n////                    }\n////                }\n\n////                // 4) Check chat modeâ€¦\n////                var mode = await chatSessionStateService.GetChatModeAsync(businessId, contact.Id);\n////                var isAgentMode = mode == \"agent\";\n\n////                // 5) Log incoming message\n////                var messageLog = new MessageLog\n////                {\n////                    Id = Guid.NewGuid(),\n////                    BusinessId = businessId,\n////                    ContactId = contact.Id,\n////                    RecipientNumber = contactPhone,\n////                    MessageContent = content,\n////                    Status = \"received\",\n////                    CreatedAt = DateTime.UtcNow,\n////                    SentAt = DateTime.UtcNow,\n////                    IsIncoming = true\n////                };\n\n////                db.MessageLogs.Add(messageLog);\n////                await db.SaveChangesAsync();\n\n////                await _hub.Clients\n////                    .Group($\"business_{businessId}\")\n////                    .SendAsync(\"ReceiveInboxMessage\", new\n////                    {\n////                        contactId = contact.Id,\n////                        message = messageLog.MessageContent,\n////                        isIncoming = true,\n////                        senderId = (Guid?)null,\n////                        sentAt = messageLog.CreatedAt\n////                    });\n\n////                // 6) Try to trigger automation by keyword\n////                try\n////                {\n////                    var triggerKeyword = (content ?? string.Empty).Trim().ToLowerInvariant();\n////                    var handled = await automationService.TryRunFlowByKeywordAsync(\n////                        businessId,\n////                        triggerKeyword,\n////                        contact.PhoneNumber,\n////                        sourceChannel: \"whatsapp\",\n////                        industryTag: \"default\");\n\n////                    if (!handled)\n////                        logger.LogInformation(\"ðŸ•µï¸ No automation flow matched keyword: {Keyword}\", triggerKeyword);\n////                }\n////                catch (Exception ex)\n////                {\n////                    logger.LogError(ex, \"âŒ Automation flow execution failed.\");\n////                }\n\n////                // 7) Sync to inbox only if agent mode\n////                if (isAgentMode)\n////                {\n////                    var inboxService = scope.ServiceProvider.GetRequiredService<IInboxService>();\n////                    await inboxService.SaveIncomingMessageAsync(new InboxMessageDto\n////                    {\n////                        BusinessId = businessId,\n////                        ContactId = contact.Id,\n////                        RecipientPhone = contact.PhoneNumber,\n////                        MessageBody = messageLog.MessageContent,\n////                        IsIncoming = true,\n////                        Status = messageLog.Status,\n////                        SentAt = messageLog.CreatedAt\n////                    });\n\n////                    logger.LogInformation(\"ðŸ“¥ Message synced to inbox for contact {Phone}\", contactPhone);\n////                }\n////                else\n////                {\n////                    logger.LogInformation(\"ðŸš« Skipping inbox sync: chat mode is not 'agent'\");\n////                }\n////            }\n////            catch (Exception ex)\n////            {\n////                _logger.LogError(ex, \"âŒ Failed to process inbound WhatsApp chat.\");\n////            }\n////        }\n\n////        public async Task ProcessInteractiveAsync(JsonElement value, CancellationToken ct = default)\n////        {\n////            using var scope = _serviceScopeFactory.CreateScope();\n////            var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();\n////            var contactProfileService = scope.ServiceProvider.GetRequiredService<IContactProfileService>();\n////            var logger = scope.ServiceProvider.GetRequiredService<ILogger<InboundMessageProcessor>>();\n\n////            static string Normalize(string? number) =>\n////                string.IsNullOrWhiteSpace(number) ? \"\" : new string(number.Where(char.IsDigit).ToArray());\n\n////            // Safe extract of profile name (Meta Cloud shape)\n////            static string? TryGetProfileName(JsonElement root)\n////            {\n////                if (root.TryGetProperty(\"contacts\", out var contactsEl) &&\n////                    contactsEl.ValueKind == JsonValueKind.Array &&\n////                    contactsEl.GetArrayLength() > 0)\n////                {\n////                    var c0 = contactsEl[0];\n////                    if (c0.TryGetProperty(\"profile\", out var profileEl) &&\n////                        profileEl.ValueKind == JsonValueKind.Object &&\n////                        profileEl.TryGetProperty(\"name\", out var nameEl) &&\n////                        nameEl.ValueKind == JsonValueKind.String)\n////                    {\n////                        var n = nameEl.GetString();\n////                        return string.IsNullOrWhiteSpace(n) ? null : n!.Trim();\n////                    }\n////                }\n////                return null;\n////            }\n\n////            // messages[0].from is always present for interactive/button\n////            if (!value.TryGetProperty(\"messages\", out var msgs) || msgs.GetArrayLength() == 0)\n////                return;\n\n////            var msg0 = msgs[0];\n////            var fromRaw = msg0.GetProperty(\"from\").GetString() ?? \"\";\n////            var fromE164 = Normalize(fromRaw);\n\n////            // Resolve Business via metadata.display_phone_number â†’ WhatsAppPhoneNumbers\n////            var displayNumberRaw = value.GetProperty(\"metadata\").GetProperty(\"display_phone_number\").GetString() ?? \"\";\n////            var displayNumber = Normalize(displayNumberRaw);\n\n////            // Look up the business by matching the normalized number in WhatsAppPhoneNumbers\n////            var candidates = await db.WhatsAppPhoneNumbers\n////                .AsNoTracking()\n////                .Where(n => n.IsActive)\n////                .Select(n => new { n.BusinessId, n.WhatsAppBusinessNumber })\n////                .ToListAsync(ct);\n\n////            var numHit = candidates.FirstOrDefault(n => Normalize(n.WhatsAppBusinessNumber) == displayNumber);\n////            if (numHit == null)\n////            {\n////                logger.LogWarning(\"âŒ Business not found for interactive webhook number: {Num}\", displayNumberRaw);\n////                return;\n////            }\n\n////            var businessId = numHit.BusinessId;\n\n////            // Upsert profile name if present\n////            var profileName = TryGetProfileName(value);\n////            if (!string.IsNullOrWhiteSpace(profileName))\n////            {\n////                try\n////                {\n////                    await contactProfileService.UpsertProfileNameAsync(businessId, fromE164, profileName!, ct);\n////                }\n////                catch (Exception ex)\n////                {\n////                    logger.LogWarning(ex, \"âš ï¸ Failed to upsert ProfileName on interactive webhook for {Phone}\", fromE164);\n////                }\n////            }\n\n////            // â€¦ continue your existing interactive handling (routing to next step, etc.)\n////        }\n\n////    }\n////}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/Processors/IStatusWebhookProcessor.cs",
      "sha256": "4a20eff4b49cd6b4a448445b156c4cab5024becc931566b1cba6d9c5c4e4d89f",
      "language": "csharp",
      "size": 275,
      "content": "using System.Text.Json;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.Webhooks.Services.Processors\n{\n    public interface IStatusWebhookProcessor\n    {\n        Task ProcessStatusUpdateAsync(JsonElement payload, CancellationToken ct = default);\n    }\n    \n}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/Processors/ITemplateWebhookProcessor.cs",
      "sha256": "6f04b24d675a88073c59204ed241e4744205e80e8d488dd464550a6105c45b7a",
      "language": "csharp",
      "size": 242,
      "content": "using System.Text.Json;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.Webhooks.Services.Processors\n{\n    public interface ITemplateWebhookProcessor\n    {\n        Task ProcessTemplateUpdateAsync(JsonElement payload);\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/Processors/StatusWebhookProcessor.cs",
      "sha256": "8dbca3bd505a7a12bd18166688de1e4762c7c6ad5afdc5aa37cfb6789c8018f5",
      "language": "csharp",
      "size": 17950,
      "content": "using Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing System;\nusing System.Text.Json;\nusing System.Threading.Tasks;\n\n// ðŸ‘‡ where your AppDbContext lives\nusing xbytechat.api;\n\nusing xbytechat.api.Features.CampaignTracking.Models;   // CampaignSendLog\nusing xbytechat.api.Features.MessageManagement.DTOs;    // MessageLog\nusing xbytechat.api.Features.Webhooks.Services.Resolvers;\nusing xbytechat.api.Features.Webhooks.Status;\nusing xbytechat.api.Infrastructure.Observability;\n\nnamespace xbytechat.api.Features.Webhooks.Services.Processors\n{\n    /// <summary>\n    /// Legacy status processor (back-compat).\n    /// - Extracts statuses from the payload\n    /// - Resolves CampaignSendLog via IMessageIdResolver when possible\n    /// - Updates CampaignSendLog / MessageLog idempotently\n    /// New provider-aware flow should go through the dispatcher -> WhatsAppWebhookService.\n    /// </summary>\n    public class StatusWebhookProcessor : IStatusWebhookProcessor\n    {\n        private readonly AppDbContext _context;\n        private readonly ILogger<StatusWebhookProcessor> _logger;\n        private readonly IMessageIdResolver _messageIdResolver;\n        private readonly IMessageStatusUpdater _updater;\n        public StatusWebhookProcessor(\n            AppDbContext context,\n            ILogger<StatusWebhookProcessor> logger,\n            IMessageIdResolver messageIdResolver,\n            IMessageStatusUpdater updater)\n        {\n            _context = context;\n            _logger = logger;\n            _messageIdResolver = messageIdResolver;\n            _updater = updater;\n        }\n\n        /// <summary>\n        /// Entry point from dispatcher (legacy path).\n        /// Normalizes Meta envelope to a \"value\" object, then processes.\n        /// </summary>\n        public async Task ProcessStatusUpdateAsync(JsonElement payload, CancellationToken ct = default)\n        {\n            _logger.LogDebug(\"status_webhook_in (legacy)\\n{Payload}\", payload.ToString());\n\n            // 0) Batch payloads: recurse per item\n            if (payload.ValueKind == JsonValueKind.Array)\n            {\n                foreach (var item in payload.EnumerateArray())\n                    await ProcessStatusUpdateAsync(item, ct);\n                return;\n            }\n\n            // 1) Canonical Meta envelope: { entry:[{ changes:[{ value:{...} }]}] }\n            if (payload.ValueKind == JsonValueKind.Object &&\n                payload.TryGetProperty(\"entry\", out var entry) &&\n                entry.ValueKind == JsonValueKind.Array)\n            {\n                foreach (var e in entry.EnumerateArray())\n                {\n                    if (e.TryGetProperty(\"changes\", out var changes) && changes.ValueKind == JsonValueKind.Array)\n                    {\n                        foreach (var ch in changes.EnumerateArray())\n                        {\n                            if (ch.TryGetProperty(\"value\", out var v))\n                                await ProcessAsync(v.GetRawText(), ct); // <- pass string + ct\n                        }\n                    }\n                }\n                return;\n            }\n\n            // 2) Envelope â†’ value via helper (back-compat)\n            if (TryExtractValue(payload, out var value))\n            {\n                await ProcessAsync(value.GetRawText(), ct);            // <- pass string + ct\n                return;\n            }\n\n            // 3) Already value-like (adapter flattened)\n            if (payload.ValueKind == JsonValueKind.Object &&\n                (payload.TryGetProperty(\"statuses\", out _) || payload.TryGetProperty(\"messages\", out _)))\n            {\n                await ProcessAsync(payload.GetRawText(), ct);          // <- pass string + ct\n                return;\n            }\n\n            // 4) Minimal single-status object (id/status)\n            if (payload.ValueKind == JsonValueKind.Object &&\n                payload.TryGetProperty(\"id\", out _) &&\n                payload.TryGetProperty(\"status\", out _))\n            {\n                await ProcessAsync(payload.GetRawText(), ct);          // <- pass string + ct\n                return;\n            }\n\n            _logger.LogWarning(\"Unrecognized status payload shape (legacy path).\");\n            MetricsRegistry.MessagesFailed.Add(1);\n        }\n\n        /// <summary>\n        /// Extract statuses from a Meta-like \"value\" object and update DB.\n        /// </summary>\n        //public async Task ProcessAsync(JsonElement value)\n        //{\n        //    if (!value.TryGetProperty(\"statuses\", out var statuses) || statuses.ValueKind != JsonValueKind.Array)\n        //    {\n        //        _logger.LogWarning(\"âš ï¸ 'statuses' array missing in webhook payload (legacy path).\");\n        //        return;\n        //    }\n\n        //    foreach (var status in statuses.EnumerateArray())\n        //    {\n        //        if (status.ValueKind != JsonValueKind.Object) continue;\n\n        //        // message id (WAMID)\n        //        var messageId = status.TryGetProperty(\"id\", out var idEl) && idEl.ValueKind == JsonValueKind.String\n        //            ? idEl.GetString()\n        //            : null;\n\n        //        // status text\n        //        var statusText = status.TryGetProperty(\"status\", out var stEl) && stEl.ValueKind == JsonValueKind.String\n        //            ? stEl.GetString()\n        //            : null;\n\n        //        if (string.IsNullOrWhiteSpace(messageId) || string.IsNullOrWhiteSpace(statusText))\n        //        {\n        //            _logger.LogWarning(\"âš ï¸ Missing messageId or status in webhook payload (legacy path).\");\n        //            continue;\n        //        }\n\n        //        // timestamp (string or number)\n        //        DateTime? eventTime = null;\n        //        if (status.TryGetProperty(\"timestamp\", out var tsEl))\n        //        {\n        //            if (tsEl.ValueKind == JsonValueKind.String && long.TryParse(tsEl.GetString(), out var epochS))\n        //                eventTime = DateTimeOffset.FromUnixTimeSeconds(epochS).UtcDateTime;\n        //            else if (tsEl.ValueKind == JsonValueKind.Number && tsEl.TryGetInt64(out var epochN))\n        //                eventTime = DateTimeOffset.FromUnixTimeSeconds(epochN).UtcDateTime;\n        //        }\n\n        //        _logger.LogDebug(\"ðŸ•“ Parsed timestamp: {Time} (raw kind={Kind})\",\n        //            eventTime?.ToString(\"o\") ?? \"n/a\", status.TryGetProperty(\"timestamp\", out var tsDbg) ? tsDbg.ValueKind.ToString() : \"n/a\");\n\n        //        // âœ… First try resolving a CampaignSendLog row via resolver\n        //        Guid? sendLogId = null;\n        //        try\n        //        {\n        //            sendLogId = await _messageIdResolver.ResolveCampaignSendLogIdAsync(messageId);\n        //        }\n        //        catch (Exception ex)\n        //        {\n        //            _logger.LogWarning(ex, \"MessageId resolver failed for {MessageId}\", messageId);\n        //        }\n\n        //        if (sendLogId is Guid sid)\n        //        {\n        //            var log = await _context.Set<CampaignSendLog>()\n        //                                    .FirstOrDefaultAsync(l => l.Id == sid);\n\n        //            if (log != null)\n        //            {\n        //                bool changed = false;\n\n        //                var newStatus = MapMetaStatus(statusText);\n        //                if (!string.IsNullOrEmpty(newStatus) &&\n        //                    !string.Equals(log.SendStatus, newStatus, StringComparison.Ordinal))\n        //                {\n        //                    log.SendStatus = newStatus;\n        //                    changed = true;\n        //                }\n\n        //                if (statusText == \"sent\" && (log.SentAt == null || log.SentAt == default) && eventTime.HasValue)\n        //                {\n        //                    log.SentAt = eventTime.Value;\n        //                    changed = true;\n        //                }\n        //                if (statusText == \"delivered\" && (log.DeliveredAt == null || log.DeliveredAt == default) && eventTime.HasValue)\n        //                {\n        //                    log.DeliveredAt = eventTime.Value;\n        //                    changed = true;\n        //                }\n        //                if (statusText == \"read\" && (log.ReadAt == null || log.ReadAt == default) && eventTime.HasValue)\n        //                {\n        //                    log.ReadAt = eventTime.Value;\n        //                    changed = true;\n        //                }\n\n        //                if (changed)\n        //                {\n        //                    await _context.SaveChangesAsync();\n        //                    _logger.LogInformation(\"âœ… CampaignSendLog updated (legacy) for MessageId: {MessageId} â†’ {Status}\", messageId, newStatus ?? statusText);\n        //                }\n        //                else\n        //                {\n        //                    _logger.LogInformation(\"ðŸ” Duplicate status '{Status}' skipped for MessageId: {MessageId} (legacy)\", statusText, messageId);\n        //                }\n\n        //                continue; // done with this status item\n        //            }\n        //        }\n\n        //        // ðŸ” Fallback: update MessageLog when thereâ€™s no CampaignSendLog\n        //        var msg = await _context.Set<MessageLog>()\n        //                                .FirstOrDefaultAsync(m => m.MessageId == messageId);\n\n        //        if (msg != null)\n        //        {\n        //            bool changed = false;\n\n        //            switch (statusText)\n        //            {\n        //                case \"sent\":\n        //                    if (!EqualsIgnoreCase(msg.Status, \"Sent\"))\n        //                    {\n        //                        msg.Status = \"Sent\";\n        //                        changed = true;\n        //                    }\n        //                    if ((msg.SentAt == null || msg.SentAt == default) && eventTime.HasValue)\n        //                    {\n        //                        msg.SentAt = eventTime.Value;\n        //                        changed = true;\n        //                    }\n        //                    break;\n\n        //                case \"delivered\":\n        //                    // no DeliveredAt column on MessageLog; just progression\n        //                    if (!EqualsIgnoreCase(msg.Status, \"Read\") &&\n        //                        !EqualsIgnoreCase(msg.Status, \"Delivered\"))\n        //                    {\n        //                        msg.Status = \"Delivered\";\n        //                        changed = true;\n        //                    }\n        //                    if ((msg.SentAt == null || msg.SentAt == default) && eventTime.HasValue)\n        //                    {\n        //                        msg.SentAt = eventTime.Value; // ensure SentAt eventually set\n        //                        changed = true;\n        //                    }\n        //                    break;\n\n        //                case \"read\":\n        //                    if (!EqualsIgnoreCase(msg.Status, \"Read\"))\n        //                    {\n        //                        msg.Status = \"Read\";\n        //                        changed = true;\n        //                    }\n        //                    if ((msg.SentAt == null || msg.SentAt == default) && eventTime.HasValue)\n        //                    {\n        //                        msg.SentAt = eventTime.Value;\n        //                        changed = true;\n        //                    }\n        //                    break;\n\n        //                default:\n        //                    // leave as-is for unknown statuses\n        //                    break;\n        //            }\n\n        //            if (changed)\n        //            {\n        //                await _context.SaveChangesAsync();\n        //                _logger.LogInformation(\"â„¹ï¸ MessageLog updated (legacy) for MessageId: {MessageId} â†’ {Status}\", messageId, msg.Status);\n        //            }\n        //            else\n        //            {\n        //                _logger.LogInformation(\"ðŸ” Duplicate status '{Status}' skipped for MessageId: {MessageId} (legacy)\", statusText, messageId);\n        //            }\n        //        }\n        //        else\n        //        {\n        //            // lower severity; common when a send failed before obtaining a message id\n        //            _logger.LogInformation(\"â“˜ No matching CampaignSendLog/MessageLog for MessageId: {MessageId} (legacy)\", messageId);\n        //        }\n        //    }\n        //}\n        public sealed class MetaStatusEnvelope\n        {\n            public Entry[]? entry { get; set; }\n            public sealed class Entry { public Change[]? changes { get; set; } }\n            public sealed class Change { public Value? value { get; set; } }\n            public sealed class Value { public Status[]? statuses { get; set; } }\n            public sealed class Status\n            {\n                public string? id { get; set; }          // WAMID\n                public string? status { get; set; }      // sent|delivered|read|failed\n                public long? timestamp { get; set; }     // epoch seconds\n                public StatusError[]? errors { get; set; }\n            }\n            public sealed class StatusError { public string? message { get; set; } public string? code { get; set; } }\n        }\n\n        // Fallback \"simple\" event for manual tests/tools\n        public sealed class SimpleStatusEvent\n        {\n            public string? MessageId { get; set; }\n            public string? Status { get; set; }\n            public long? Timestamp { get; set; }\n            public string? ErrorMessage { get; set; }\n        }\n\n      \n                // make sure this is injected too\n\n        public async Task<int> ProcessAsync(string rawJson, CancellationToken ct)\n        {\n            // Try Meta-like envelope first\n            try\n            {\n                var env = System.Text.Json.JsonSerializer.Deserialize<MetaStatusEnvelope>(rawJson);\n                if (env?.entry is { Length: > 0 })\n                {\n                    var total = 0;\n                    foreach (var e in env.entry)\n                        foreach (var ch in e.changes ?? Array.Empty<MetaStatusEnvelope.Change>())\n                            foreach (var st in ch.value?.statuses ?? Array.Empty<MetaStatusEnvelope.Status>())\n                            {\n                                var providerMsgId = st.id ?? string.Empty;\n                                var wamid = await _messageIdResolver.ResolveAsync(providerMsgId, ct) ?? providerMsgId; // no-op if already WAMID\n                                var status = (st.status ?? \"\").Trim().ToLowerInvariant();\n                                var ts = st.timestamp.HasValue\n                                    ? DateTimeOffset.FromUnixTimeSeconds(st.timestamp.Value).UtcDateTime\n                                    : DateTime.UtcNow;\n                                var err = st.errors?.FirstOrDefault()?.message;\n\n                                if (!string.IsNullOrWhiteSpace(wamid) && !string.IsNullOrWhiteSpace(status))\n                                {\n                                    total += await _updater.UpdateAsync(wamid, status, ts, err, ct);\n                                }\n                            }\n                    return total;\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogWarning(ex, \"[StatusWebhookProcessor] Meta envelope parse failed; trying simple shape.\");\n            }\n\n            // Fallback: simple shape (handy for cURL testing)\n            try\n            {\n                var ev = System.Text.Json.JsonSerializer.Deserialize<SimpleStatusEvent>(rawJson);\n                if (ev?.MessageId is not null && ev.Status is not null)\n                {\n                    var ts = ev.Timestamp.HasValue\n                        ? DateTimeOffset.FromUnixTimeSeconds(ev.Timestamp.Value).UtcDateTime\n                        : DateTime.UtcNow;\n                    return await _updater.UpdateAsync(ev.MessageId, ev.Status, ts, ev.ErrorMessage, ct);\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"[StatusWebhookProcessor] Simple shape parse failed\");\n            }\n\n            _logger.LogWarning(\"[StatusWebhookProcessor] Unsupported payload\");\n            return 0;\n        }\n\n        // ----------------- helpers -----------------\n\n        private static bool TryExtractValue(JsonElement payload, out JsonElement value)\n        {\n            value = default;\n            if (payload.ValueKind != JsonValueKind.Object) return false;\n            if (!payload.TryGetProperty(\"entry\", out var entry) || entry.ValueKind != JsonValueKind.Array || entry.GetArrayLength() == 0) return false;\n\n            var e0 = entry[0];\n            if (!e0.TryGetProperty(\"changes\", out var changes) || changes.ValueKind != JsonValueKind.Array || changes.GetArrayLength() == 0) return false;\n\n            var c0 = changes[0];\n            if (!c0.TryGetProperty(\"value\", out var v) || v.ValueKind != JsonValueKind.Object) return false;\n\n            value = v;\n            return true;\n        }\n\n        private static string? MapMetaStatus(string? s) =>\n            (s ?? \"\").ToLowerInvariant() switch\n            {\n                \"sent\" => \"Sent\",\n                \"delivered\" => \"Delivered\",\n                \"read\" => \"Read\",\n                \"failed\" => \"Failed\",\n                \"deleted\" => \"Deleted\",\n                _ => null\n            };\n\n        private static bool EqualsIgnoreCase(string? a, string? b) =>\n            string.Equals(a, b, StringComparison.OrdinalIgnoreCase);\n    }\n}\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/Processors/TemplateWebhookProcessor.cs",
      "sha256": "0dbe7873fcf7b84d3a4fb9d78bda6689d86cbfd4d9fd50ce1d98029aaaef0558",
      "language": "csharp",
      "size": 1391,
      "content": "using System;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing Microsoft.Extensions.Logging;\n\nnamespace xbytechat.api.Features.Webhooks.Services.Processors\n{\n    public class TemplateWebhookProcessor : ITemplateWebhookProcessor\n    {\n        private readonly ILogger<TemplateWebhookProcessor> _logger;\n\n        public TemplateWebhookProcessor(ILogger<TemplateWebhookProcessor> logger)\n        {\n            _logger = logger;\n        }\n\n        public async Task ProcessTemplateUpdateAsync(JsonElement payload)\n        {\n            try\n            {\n                var entry = payload.GetProperty(\"entry\")[0];\n                var changes = entry.GetProperty(\"changes\")[0];\n                var value = changes.GetProperty(\"value\");\n\n                var eventType = value.GetProperty(\"event\").GetString();\n                var templateId = value.TryGetProperty(\"message_template_id\", out var idProp)\n                                 ? idProp.GetString() : \"(unknown)\";\n\n                _logger.LogInformation($\"ðŸ§¾ Template Event Received: {eventType} for ID: {templateId}\");\n\n                // ðŸ§  You can store in DB or show in admin logs in the future\n\n                await Task.CompletedTask;\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"âŒ Failed to process template webhook update.\");\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/Resolvers/IMessageIdResolver.cs",
      "sha256": "b7b826aacb41d60aaa63c0a5c7350a4384eeb07af18d899fb8199afe7e9ef3d9",
      "language": "csharp",
      "size": 463,
      "content": "using System;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.Webhooks.Services.Resolvers\n{\n    public interface IMessageIdResolver\n    {\n        Task<Guid?> ResolveCampaignSendLogIdAsync(string messageId);\n        Task<Guid?> ResolveMessageLogIdAsync(string messageId);\n        Task<Guid?> ResolveBusinessIdByMessageIdAsync(string messageId);\n        Task<string?> ResolveAsync(string providerMessageId, CancellationToken ct = default);\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/Resolvers/MessageIdResolver.cs",
      "sha256": "631816c0acf1e2bbc9d610ef2145f4ee80c89efd95d2abf8728ff32be09142e8",
      "language": "csharp",
      "size": 3838,
      "content": "using Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing Serilog;\nusing System;\nusing System.Threading.Tasks;\nusing xbytechat.api;\n\nnamespace xbytechat.api.Features.Webhooks.Services.Resolvers\n{\n    public class MessageIdResolver : IMessageIdResolver\n    {\n        private readonly AppDbContext _context;\n        private readonly ILogger<MessageIdResolver> _logger;\n\n        public MessageIdResolver(AppDbContext context, ILogger<MessageIdResolver> logger)\n        {\n            _context = context;\n            _logger = logger;\n        }\n        public async Task<string?> ResolveAsync(string providerMessageId, CancellationToken ct = default)\n        {\n            if (string.IsNullOrWhiteSpace(providerMessageId))\n                return null;\n\n            // 1) Already a WAMID? Return as-is.\n            if (providerMessageId.StartsWith(\"wamid.\", StringComparison.OrdinalIgnoreCase))\n                return providerMessageId;\n\n            // 2) Try MessageLogs mapping (most reliable)\n            //    We pick any field that looks like a WAMID if present; otherwise fall back to MessageId.\n            var mlHit = await _context.MessageLogs.AsNoTracking()\n                .Where(m => m.ProviderMessageId == providerMessageId || m.MessageId == providerMessageId)\n                .OrderByDescending(m => m.CreatedAt)\n                .Select(m =>\n                    m.ProviderMessageId.StartsWith(\"wamid.\", StringComparison.OrdinalIgnoreCase)\n                        ? m.ProviderMessageId\n                        : (m.MessageId ?? m.ProviderMessageId))\n                .FirstOrDefaultAsync(ct);\n\n            if (!string.IsNullOrEmpty(mlHit))\n                return mlHit;\n\n            // 3) Some paths write WAMID straight into CampaignSendLogs.MessageId (no mapping required)\n            var cslHit = await _context.CampaignSendLogs.AsNoTracking()\n                .Where(c => c.MessageId == providerMessageId)\n                .OrderByDescending(c => c.CreatedAt)\n                .Select(c => c.MessageId)\n                .FirstOrDefaultAsync(ct);\n\n            if (!string.IsNullOrEmpty(cslHit))\n                return cslHit;\n\n            // 4) Fallback: return original (keeps pipeline flowing even if we canâ€™t map)\n            _logger.LogDebug(\"MessageIdResolver: passthrough for provider id {ProviderMessageId}\", providerMessageId);\n            return providerMessageId;\n        }\n\n        public async Task<Guid?> ResolveCampaignSendLogIdAsync(string messageId)\n        {\n            var log = await _context.CampaignSendLogs\n                                .FirstOrDefaultAsync(l => l.MessageId == messageId);\n\n            if (log == null)\n            {\n                _logger.LogWarning(\"âš ï¸ CampaignSendLog not found for MessageId: {MessageId}\", messageId);\n                return null;\n            }\n\n            return log.Id;\n        }\n\n        public async Task<Guid?> ResolveMessageLogIdAsync(string messageId)\n        {\n            var log = await _context.MessageLogs\n                .AsNoTracking()\n                .FirstOrDefaultAsync(l => l.MessageId == messageId);\n\n            if (log == null)\n            {\n                _logger.LogWarning(\"âš ï¸ MessageLog not found for MessageId: {MessageId}\", messageId);\n                return null;\n            }\n\n            return log.Id;\n        }\n\n        public async Task<Guid?> ResolveBusinessIdByMessageIdAsync(string messageId)\n        {\n            var log = await _context.MessageLogs\n                .AsNoTracking()\n                .FirstOrDefaultAsync(l => l.MessageId == messageId);\n\n            if (log == null)\n            {\n                _logger.LogWarning(\"âš ï¸ MessageLog not found for MessageId: {MessageId}\", messageId);\n                return null;\n            }\n\n            return log.BusinessId;\n        }\n\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/WebhookQueueService.cs",
      "sha256": "2d311701b4dcbde69080bf38449fde5e42e9f1aeb9138ba1735af41c8971caee",
      "language": "csharp",
      "size": 3691,
      "content": "using System.Text.Json;\nusing System.Threading.Channels;\nusing Microsoft.Extensions.Logging;\n\nnamespace xbytechat.api.Features.Webhooks.Services\n{\n    public class WebhookQueueService : IWebhookQueueService\n    {\n        private readonly Channel<JsonElement> _queue;\n        private readonly ILogger<WebhookQueueService> _logger;\n\n        public WebhookQueueService(ILogger<WebhookQueueService> logger)\n        {\n            _logger = logger;\n\n            var options = new BoundedChannelOptions(5000)\n            {\n                FullMode = BoundedChannelFullMode.Wait,\n                SingleReader = true,\n                SingleWriter = false\n            };\n\n            _queue = Channel.CreateBounded<JsonElement>(options);\n\n            _logger.LogInformation(\n                \"âœ… WebhookQueueService initialized with capacity {Capacity}, FullMode={FullMode}, SingleReader={SingleReader}, SingleWriter={SingleWriter}.\",\n                5000,\n                options.FullMode,\n                options.SingleReader,\n                options.SingleWriter\n            );\n        }\n\n        public void Enqueue(JsonElement item)\n        {\n            // Optional: log size instead of full content to avoid noisy logs\n            var length = item.ToString()?.Length ?? 0;\n\n            if (!_queue.Writer.TryWrite(item))\n            {\n                _logger.LogError(\n                    \"âŒ Failed to enqueue webhook payload: queue is full. CurrentCount={Count}, PayloadLength={PayloadLength}.\",\n                    _queue.Reader.Count,\n                    length\n                );\n                throw new InvalidOperationException(\"âš ï¸ Webhook queue is full.\");\n            }\n\n            _logger.LogInformation(\n                \"ðŸ“¥ Enqueued webhook payload successfully. CurrentCount={Count}, PayloadLength={PayloadLength}.\",\n                _queue.Reader.Count,\n                length\n            );\n        }\n\n        public async ValueTask<JsonElement> DequeueAsync(CancellationToken cancellationToken)\n        {\n            var item = await _queue.Reader.ReadAsync(cancellationToken);\n\n            // Again, just log length, not the full JSON, to keep logs readable\n            var length = item.ToString()?.Length ?? 0;\n\n            _logger.LogInformation(\n                \"ðŸ“¤ Dequeued webhook payload for processing. RemainingCount={Count}, PayloadLength={PayloadLength}.\",\n                _queue.Reader.Count,\n                length\n            );\n\n            return item;\n        }\n\n        public int GetQueueLength() => _queue.Reader.Count;\n    }\n}\n\n\n//using System.Text.Json;\n//using System.Threading.Channels;\n\n//namespace xbytechat.api.Features.Webhooks.Services\n//{\n//    public class WebhookQueueService : IWebhookQueueService\n//    {\n//        private readonly Channel<JsonElement> _queue;\n\n//        public WebhookQueueService()\n//        {\n//            var options = new BoundedChannelOptions(5000)\n//            {\n//                FullMode = BoundedChannelFullMode.Wait,\n//                SingleReader = true,\n//                SingleWriter = false\n//            };\n\n//            _queue = Channel.CreateBounded<JsonElement>(options);\n//        }\n\n//        public void Enqueue(JsonElement item)\n//        {\n//            if (!_queue.Writer.TryWrite(item))\n//            {\n//                throw new InvalidOperationException(\"âš ï¸ Webhook queue is full.\");\n//            }\n//        }\n\n//        public async ValueTask<JsonElement> DequeueAsync(CancellationToken cancellationToken)\n//        {\n//            return await _queue.Reader.ReadAsync(cancellationToken);\n//        }\n\n//        public int GetQueueLength() => _queue.Reader.Count;\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/WhatsAppWebhookDispatcher.cs",
      "sha256": "e6fada25e39b363b0b7136d0997fba40cc2d1fd8347f8fb7a16f779172e7822b",
      "language": "csharp",
      "size": 34800,
      "content": "using System;\nusing System.Linq;\nusing System.Text.Json;\nusing System.Threading.Tasks;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.Webhooks.Directory;\nusing xbytechat.api.Features.Webhooks.Pinnacle.Services.Adapters;\nusing xbytechat.api.Features.Webhooks.Services.Processors;\nusing xbytechat_api.Features.Billing.Services;\n\nnamespace xbytechat.api.Features.Webhooks.Services\n{\n    public class WhatsAppWebhookDispatcher : IWhatsAppWebhookDispatcher\n    {\n        // Removed legacy _statusProcessor on purpose\n        private readonly ITemplateWebhookProcessor _templateProcessor;\n        private readonly IClickWebhookProcessor _clickProcessor;\n        private readonly IInboundMessageProcessor _inboundMessageProcessor;\n        private readonly IWhatsAppWebhookService _webhookService;\n        private readonly IProviderDirectory _directory;\n        private readonly ILogger<WhatsAppWebhookDispatcher> _logger;\n        private readonly IPinnacleToMetaAdapter _pinnacleToMetaAdapter;\n        private readonly IBillingIngestService _billingIngest;\n\n        public WhatsAppWebhookDispatcher(\n            ITemplateWebhookProcessor templateProcessor,\n            ILogger<WhatsAppWebhookDispatcher> logger,\n            IClickWebhookProcessor clickProcessor,\n            IInboundMessageProcessor inboundMessageProcessor,\n            IWhatsAppWebhookService webhookService,\n            IProviderDirectory directory,\n            IPinnacleToMetaAdapter pinnacleToMetaAdapter,\n            IBillingIngestService billingIngest)\n        {\n            _templateProcessor = templateProcessor;\n            _logger = logger;\n            _clickProcessor = clickProcessor;\n            _inboundMessageProcessor = inboundMessageProcessor;\n            _webhookService = webhookService;\n            _directory = directory;\n            _pinnacleToMetaAdapter = pinnacleToMetaAdapter;\n            _billingIngest = billingIngest;\n        }\n\n        public async Task DispatchAsync(JsonElement payload)\n        {\n            // Keep raw payload at Debug to avoid log spam in prod\n            _logger.LogDebug(\"ðŸ“¦ Dispatcher raw payload:\\n{Payload}\", payload.GetRawText());\n\n            try\n            {\n                // 0) Detect provider & normalize into a Meta-like \"entry[].changes[].value\" envelope\n                var provider = DetectProvider(payload); // \"meta\" | \"pinnacle\" | null\n                _logger.LogInformation(\"ðŸŒ Dispatcher: detected provider={Provider}\", provider ?? \"(auto/meta)\");\n\n                var envelope = provider == \"pinnacle\"\n                    ? _pinnacleToMetaAdapter.ToMetaEnvelope(payload)\n                    : payload;\n\n                if (!envelope.TryGetProperty(\"entry\", out var entries) || entries.ValueKind != JsonValueKind.Array)\n                {\n                    _logger.LogWarning(\"âš ï¸ Dispatcher: No 'entry' array found on envelope; skipping payload.\");\n                    return;\n                }\n\n                // Compute once per envelope (micro-optimization)\n                var isStatus = IsStatusPayload(envelope);\n                _logger.LogInformation(\"ðŸ”Ž Dispatcher: isStatusPayload={IsStatus}\", isStatus);\n\n                foreach (var entry in entries.EnumerateArray())\n                {\n                    if (!entry.TryGetProperty(\"changes\", out var changes) || changes.ValueKind != JsonValueKind.Array)\n                    {\n                        _logger.LogDebug(\"â„¹ï¸ Dispatcher: 'entry' without 'changes' array; skipping entry.\");\n                        continue;\n                    }\n\n                    foreach (var change in changes.EnumerateArray())\n                    {\n                        if (!change.TryGetProperty(\"value\", out var value) || value.ValueKind != JsonValueKind.Object)\n                        {\n                            _logger.LogDebug(\"â„¹ï¸ Dispatcher: 'change' without object 'value'; skipping change.\");\n                            continue;\n                        }\n\n                        // 1) STATUS UPDATES\n                        if (isStatus)\n                        {\n                            _logger.LogInformation(\"ðŸ“¦ Dispatcher: treating envelope as STATUS payload (provider={Provider}).\", provider ?? \"meta\");\n\n                            // Resolve BusinessId using *envelope* metadata (works for Meta and adapted Pinnacle)\n                            Guid resolvedBiz = Guid.Empty;\n                            try\n                            {\n                                var hints = ExtractNumberHints(envelope, provider);\n                                _logger.LogDebug(\n                                    \"ðŸ”¢ Dispatcher: Number hints extracted. PhoneNumberId={PhoneNumberId}, DisplayPhone={DisplayPhone}, WabaId={WabaId}, WaId={WaId}\",\n                                    hints.PhoneNumberId,\n                                    hints.DisplayPhoneNumber,\n                                    hints.WabaId,\n                                    hints.WaId);\n\n                                var bid = await _directory.ResolveBusinessIdAsync(\n                                    provider: provider,\n                                    phoneNumberId: hints.PhoneNumberId,\n                                    displayPhoneNumber: hints.DisplayPhoneNumber,\n                                    wabaId: hints.WabaId,\n                                    waId: hints.WaId\n                                );\n                                if (bid.HasValue) resolvedBiz = bid.Value;\n                            }\n                            catch (Exception ex)\n                            {\n                                _logger.LogWarning(ex, \"ProviderDirectory lookup failed; proceeding without BusinessId.\");\n                            }\n\n                            // Canonical provider label for billing\n                            var providerCanonical = string.Equals(provider, \"pinnacle\", StringComparison.OrdinalIgnoreCase)\n                                ? \"PINNACLE\"\n                                : \"META_CLOUD\";\n\n                            // Only call billing ingest when BusinessId was resolved\n                            if (resolvedBiz != Guid.Empty)\n                            {\n                                try\n                                {\n                                    _logger.LogInformation(\n                                        \"ðŸ’° Dispatcher: routing status payload to BillingIngest for BusinessId={BusinessId}, Provider={ProviderCanonical}\",\n                                        resolvedBiz,\n                                        providerCanonical);\n\n                                    await _billingIngest.IngestFromWebhookAsync(\n                                        resolvedBiz,\n                                        providerCanonical,\n                                        envelope.GetRawText());\n                                }\n                                catch (Exception ex)\n                                {\n                                    _logger.LogWarning(ex, \"Billing ingest from webhook failed (non-fatal).\");\n                                }\n                            }\n                            else\n                            {\n                                _logger.LogWarning(\n                                    \"âš ï¸ Dispatcher: status payload had no resolved BusinessId; billing ingest will be skipped.\");\n                            }\n\n                            // Unified status updater (no legacy fallback)\n                            _logger.LogInformation(\n                                \"ðŸ“¦ Dispatcher: routing to Unified Status Updater (provider={Provider}, businessId={BusinessId})\",\n                                provider,\n                                resolvedBiz == Guid.Empty ? \"(unknown)\" : resolvedBiz.ToString());\n\n                            await _webhookService.ProcessStatusUpdateAsync(\n                                resolvedBiz,\n                                provider ?? \"meta\",\n                                envelope);\n\n                            // Note: continue to next change â€” even if envelope is status-oriented,\n                            // other changes in the same webhook could be non-status in some providers.\n                            continue;\n                        }\n\n                        // 2) TEMPLATE EVENTS\n                        if (value.TryGetProperty(\"event\", out var eventType) &&\n                            eventType.GetString()?.StartsWith(\"template_\", StringComparison.Ordinal) == true)\n                        {\n                            _logger.LogInformation(\"ðŸ“¦ Dispatcher: routing to Template Processor (event={Event})\", eventType.GetString());\n                            await _templateProcessor.ProcessTemplateUpdateAsync(envelope);\n                            continue;\n                        }\n\n                        // 3) MESSAGES (clicks + inbound)\n                        if (!value.TryGetProperty(\"messages\", out var msgs) || msgs.GetArrayLength() == 0)\n                        {\n                            _logger.LogDebug(\"â„¹ï¸ Dispatcher: 'value' has no 'messages' array or it is empty; skipping.\");\n                            continue;\n                        }\n\n                        foreach (var m in msgs.EnumerateArray())\n                        {\n                            if (!m.TryGetProperty(\"type\", out var typeProp))\n                            {\n                                _logger.LogDebug(\"â„¹ï¸ Dispatcher: message without 'type' field; skipping message.\");\n                                continue;\n                            }\n\n                            var type = typeProp.GetString();\n                            _logger.LogDebug(\"ðŸ” Dispatcher: inspecting message of type '{Type}'.\", type);\n\n                            // (A) Legacy quick-reply button â†’ CLICK\n                            if (type == \"button\")\n                            {\n                                _logger.LogInformation(\"ðŸ‘‰ Dispatcher: routing to Click Processor (legacy 'button').\");\n                                await _clickProcessor.ProcessClickAsync(value);\n                                continue;\n                            }\n\n                            // (B) Interactive (button_reply / list_reply) â†’ CLICK\n                            if (type == \"interactive\" && m.TryGetProperty(\"interactive\", out var interactive))\n                            {\n                                if (interactive.TryGetProperty(\"type\", out var interactiveType) &&\n                                    interactiveType.GetString() == \"button_reply\")\n                                {\n                                    _logger.LogInformation(\"ðŸ‘‰ Dispatcher: routing to Click Processor (interactive/button_reply).\");\n                                    await _clickProcessor.ProcessClickAsync(value);\n                                    continue;\n                                }\n\n                                if (interactive.TryGetProperty(\"list_reply\", out _))\n                                {\n                                    _logger.LogInformation(\"ðŸ‘‰ Dispatcher: routing to Click Processor (interactive/list_reply).\");\n                                    await _clickProcessor.ProcessClickAsync(value);\n                                    continue;\n                                }\n                            }\n\n                            // (C) Inbound plain message types â†’ INBOUND\n                            if (type is \"text\" or \"image\" or \"audio\")\n                            {\n                                _logger.LogInformation(\n                                    \"ðŸ’¬ Dispatcher: routing to InboundMessageProcessor (message type: {Type}, provider={Provider}).\",\n                                    type,\n                                    provider ?? \"meta\");\n\n                                await _inboundMessageProcessor.ProcessChatAsync(value);\n                                continue;\n                            }\n\n                            _logger.LogDebug(\"â„¹ï¸ Dispatcher: message type '{Type}' not handled by dispatcher.\", type);\n                        }\n                    }\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"âŒ Dispatcher failed to process WhatsApp webhook.\");\n            }\n        }\n\n        private static bool IsStatusPayload(JsonElement root)\n        {\n            // Meta-like: entry[].changes[].value.statuses\n            if (TryGetMetaValue(root, out var val) && val.Value.TryGetProperty(\"statuses\", out _))\n                return true;\n\n            // Some providers mark with \"status\" or event containing \"status\"\n            if (root.TryGetProperty(\"status\", out _)) return true;\n            if (root.TryGetProperty(\"event\", out var ev) &&\n                (ev.GetString()?.Contains(\"status\", StringComparison.OrdinalIgnoreCase) ?? false))\n                return true;\n\n            return false;\n        }\n\n        private static string? DetectProvider(JsonElement root)\n        {\n            // Heuristics by envelope\n            if (root.TryGetProperty(\"object\", out var obj) && obj.GetString() == \"whatsapp_business_account\")\n                return \"meta\";\n            if (root.TryGetProperty(\"entry\", out _))\n                return \"meta\";\n            if (root.TryGetProperty(\"event\", out _))\n                return \"pinnacle\";\n            return null;\n        }\n\n        private static bool TryGetMetaValue(JsonElement root, out (JsonElement Value, JsonElement? Change, JsonElement? Entry) res)\n        {\n            res = default;\n            if (!root.TryGetProperty(\"entry\", out var entries) || entries.ValueKind != JsonValueKind.Array || entries.GetArrayLength() == 0)\n                return false;\n\n            var entry = entries[0];\n            if (!entry.TryGetProperty(\"changes\", out var changes) || changes.ValueKind != JsonValueKind.Array || changes.GetArrayLength() == 0)\n                return false;\n\n            var change = changes[0];\n            if (!change.TryGetProperty(\"value\", out var value))\n                return false;\n\n            res = (value, change, entry);\n            return true;\n        }\n\n        private static NumberHints ExtractNumberHints(JsonElement root, string? provider)\n        {\n            var hints = new NumberHints();\n\n            // Meta (or unknown â†’ treat as Meta envelope)\n            if (string.Equals(provider, \"meta\", StringComparison.OrdinalIgnoreCase) || provider is null)\n            {\n                if (TryGetMetaValue(root, out var v))\n                {\n                    if (v.Value.TryGetProperty(\"metadata\", out var md))\n                    {\n                        if (md.TryGetProperty(\"phone_number_id\", out var pnid))\n                            hints.PhoneNumberId = pnid.GetString();\n\n                        if (md.TryGetProperty(\"display_phone_number\", out var disp))\n                            hints.DisplayPhoneNumber = NormalizePhone(disp.GetString());\n\n                        if (md.TryGetProperty(\"waba_id\", out var wabaFromMeta))\n                            hints.WabaId = wabaFromMeta.GetString();\n                    }\n\n                    // Some adapters put waba_id at value-level\n                    if (string.IsNullOrWhiteSpace(hints.WabaId) &&\n                        v.Value.TryGetProperty(\"waba_id\", out var wabaTop))\n                    {\n                        hints.WabaId = wabaTop.GetString();\n                    }\n\n                    // First status often carries recipient_id (WA ID)\n                    if (v.Value.TryGetProperty(\"statuses\", out var statuses) &&\n                        statuses.ValueKind == JsonValueKind.Array && statuses.GetArrayLength() > 0)\n                    {\n                        var s0 = statuses[0];\n                        if (s0.TryGetProperty(\"recipient_id\", out var rid))\n                            hints.WaId = rid.GetString();\n                    }\n                }\n            }\n            // Pinnacle (raw or adapted)\n            else if (string.Equals(provider, \"pinnacle\", StringComparison.OrdinalIgnoreCase))\n            {\n                // If your adapter produced a Meta-like envelope, this will work too:\n                if (TryGetMetaValue(root, out var v2) && v2.Value.TryGetProperty(\"metadata\", out var md2))\n                {\n                    if (md2.TryGetProperty(\"phone_number_id\", out var pnid2))\n                        hints.PhoneNumberId = pnid2.GetString();\n\n                    if (md2.TryGetProperty(\"display_phone_number\", out var disp2))\n                        hints.DisplayPhoneNumber = NormalizePhone(disp2.GetString());\n                }\n\n                // Raw Pinnacle-style fields on the envelope\n                if (string.IsNullOrWhiteSpace(hints.PhoneNumberId) &&\n                    root.TryGetProperty(\"phone_number_id\", out var pn))\n                    hints.PhoneNumberId = pn.GetString();\n\n                if (string.IsNullOrWhiteSpace(hints.DisplayPhoneNumber))\n                {\n                    if (root.TryGetProperty(\"from\", out var from))\n                        hints.DisplayPhoneNumber = NormalizePhone(from.GetString());\n                    else if (root.TryGetProperty(\"msisdn\", out var msisdn))\n                        hints.DisplayPhoneNumber = NormalizePhone(msisdn.GetString());\n                }\n\n                if (root.TryGetProperty(\"wabaId\", out var waba))\n                    hints.WabaId = waba.GetString();\n            }\n\n            return hints;\n        }\n\n        private static string? NormalizePhone(string? v)\n        {\n            if (string.IsNullOrWhiteSpace(v)) return null;\n            var t = v.Trim();\n            var keepPlus = t.StartsWith(\"+\");\n            var digits = new string(t.Where(char.IsDigit).ToArray());\n            return keepPlus ? \"+\" + digits : digits;\n        }\n\n        private struct NumberHints\n        {\n            public string? PhoneNumberId { get; set; }\n            public string? DisplayPhoneNumber { get; set; }\n            public string? WabaId { get; set; }\n            public string? WaId { get; set; }\n        }\n    }\n}\n\n\n//using System;\n//using System.Linq;\n//using System.Text.Json;\n//using System.Threading.Tasks;\n//using Microsoft.Extensions.Logging;\n//using xbytechat.api.Features.Webhooks.Directory;\n//using xbytechat.api.Features.Webhooks.Pinnacle.Services.Adapters;\n//using xbytechat.api.Features.Webhooks.Services.Processors;\n//using xbytechat_api.Features.Billing.Services;\n\n//namespace xbytechat.api.Features.Webhooks.Services\n//{\n//    public class WhatsAppWebhookDispatcher : IWhatsAppWebhookDispatcher\n//    {\n//        // Removed legacy _statusProcessor on purpose\n//        private readonly ITemplateWebhookProcessor _templateProcessor;\n//        private readonly IClickWebhookProcessor _clickProcessor;\n//        private readonly IInboundMessageProcessor _inboundMessageProcessor;\n//        private readonly IWhatsAppWebhookService _webhookService;\n//        private readonly IProviderDirectory _directory;\n//        private readonly ILogger<WhatsAppWebhookDispatcher> _logger;\n//        private readonly IPinnacleToMetaAdapter _pinnacleToMetaAdapter;\n//        private readonly IBillingIngestService _billingIngest;\n\n//        public WhatsAppWebhookDispatcher(\n//            ITemplateWebhookProcessor templateProcessor,\n//            ILogger<WhatsAppWebhookDispatcher> logger,\n//            IClickWebhookProcessor clickProcessor,\n//            IInboundMessageProcessor inboundMessageProcessor,\n//            IWhatsAppWebhookService webhookService,\n//            IProviderDirectory directory,\n//            IPinnacleToMetaAdapter pinnacleToMetaAdapter,\n//            IBillingIngestService billingIngest)\n//        {\n//            _templateProcessor = templateProcessor;\n//            _logger = logger;\n//            _clickProcessor = clickProcessor;\n//            _inboundMessageProcessor = inboundMessageProcessor;\n//            _webhookService = webhookService;\n//            _directory = directory;\n//            _pinnacleToMetaAdapter = pinnacleToMetaAdapter;\n//            _billingIngest = billingIngest;\n//        }\n\n//        public async Task DispatchAsync(JsonElement payload)\n//        {\n//            // Keep raw payload at Debug to avoid log spam in prod\n//            _logger.LogDebug(\"ðŸ“¦ Dispatcher raw payload:\\n{Payload}\", payload.GetRawText());\n\n//            try\n//            {\n//                // 0) Detect provider & normalize into a Meta-like \"entry[].changes[].value\" envelope\n//                var provider = DetectProvider(payload); // \"meta\" | \"pinnacle\" | null\n\n//                var envelope = provider == \"pinnacle\"\n//                    ? _pinnacleToMetaAdapter.ToMetaEnvelope(payload)\n//                    : payload;\n\n//                if (!envelope.TryGetProperty(\"entry\", out var entries) || entries.ValueKind != JsonValueKind.Array)\n//                    return;\n\n//                // Compute once per envelope (micro-optimization)\n//                var isStatus = IsStatusPayload(envelope);\n\n//                foreach (var entry in entries.EnumerateArray())\n//                {\n//                    if (!entry.TryGetProperty(\"changes\", out var changes) || changes.ValueKind != JsonValueKind.Array)\n//                        continue;\n\n//                    foreach (var change in changes.EnumerateArray())\n//                    {\n//                        if (!change.TryGetProperty(\"value\", out var value) || value.ValueKind != JsonValueKind.Object)\n//                            continue;\n\n//                        // 1) STATUS UPDATES\n//                        if (isStatus)\n//                        {\n//                            // Resolve BusinessId using *envelope* metadata (works for Meta and adapted Pinnacle)\n//                            Guid resolvedBiz = Guid.Empty;\n//                            try\n//                            {\n//                                var hints = ExtractNumberHints(envelope, provider);\n//                                var bid = await _directory.ResolveBusinessIdAsync(\n//                                    provider: provider,\n//                                    phoneNumberId: hints.PhoneNumberId,\n//                                    displayPhoneNumber: hints.DisplayPhoneNumber,\n//                                    wabaId: hints.WabaId,\n//                                    waId: hints.WaId\n//                                );\n//                                if (bid.HasValue) resolvedBiz = bid.Value;\n//                            }\n//                            catch (Exception ex)\n//                            {\n//                                _logger.LogWarning(ex, \"ProviderDirectory lookup failed; proceeding without BusinessId.\");\n//                            }\n\n//                            // Canonical provider label for billing\n//                            var providerCanonical = string.Equals(provider, \"pinnacle\", StringComparison.OrdinalIgnoreCase)\n//                                ? \"PINNACLE\"\n//                                : \"META_CLOUD\";\n\n//                            // Only call billing ingest when BusinessId was resolved\n//                            if (resolvedBiz != Guid.Empty)\n//                            {\n//                                try\n//                                {\n//                                    await _billingIngest.IngestFromWebhookAsync(\n//                                        resolvedBiz,\n//                                        providerCanonical,\n//                                        envelope.GetRawText());\n//                                }\n//                                catch (Exception ex)\n//                                {\n//                                    _logger.LogWarning(ex, \"Billing ingest from webhook failed (non-fatal).\");\n//                                }\n//                            }\n\n//                            // Unified status updater (no legacy fallback)\n//                            _logger.LogInformation(\n//                                \"ðŸ“¦ Routing to Unified Status Updater (provider={Provider}, businessId={BusinessId})\",\n//                                provider, resolvedBiz == Guid.Empty ? \"(unknown)\" : resolvedBiz.ToString());\n\n//                            await _webhookService.ProcessStatusUpdateAsync(\n//                                resolvedBiz,\n//                                provider ?? \"meta\",\n//                                envelope);\n\n//                            // Note: continue to next change â€” even if envelope is status-oriented,\n//                            // other changes in the same webhook could be non-status in some providers.\n//                            continue;\n//                        }\n\n//                        // 2) TEMPLATE EVENTS\n//                        if (value.TryGetProperty(\"event\", out var eventType) &&\n//                            eventType.GetString()?.StartsWith(\"template_\", StringComparison.Ordinal) == true)\n//                        {\n//                            _logger.LogInformation(\"ðŸ“¦ Routing to Template Processor\");\n//                            await _templateProcessor.ProcessTemplateUpdateAsync(envelope);\n//                            continue;\n//                        }\n\n//                        // 3) MESSAGES (clicks + inbound)\n//                        if (!value.TryGetProperty(\"messages\", out var msgs) || msgs.GetArrayLength() == 0)\n//                        {\n//                            _logger.LogDebug(\"â„¹ï¸ No 'messages' array present.\");\n//                            continue;\n//                        }\n\n//                        foreach (var m in msgs.EnumerateArray())\n//                        {\n//                            if (!m.TryGetProperty(\"type\", out var typeProp))\n//                            {\n//                                _logger.LogDebug(\"â„¹ï¸ Message without 'type' field.\");\n//                                continue;\n//                            }\n\n//                            var type = typeProp.GetString();\n\n//                            // (A) Legacy quick-reply button â†’ CLICK\n//                            if (type == \"button\")\n//                            {\n//                                _logger.LogInformation(\"ðŸ‘‰ Routing to Click Processor (legacy 'button')\");\n//                                await _clickProcessor.ProcessClickAsync(value);\n//                                continue;\n//                            }\n\n//                            // (B) Interactive (button_reply / list_reply) â†’ CLICK\n//                            if (type == \"interactive\" && m.TryGetProperty(\"interactive\", out var interactive))\n//                            {\n//                                if (interactive.TryGetProperty(\"type\", out var interactiveType) &&\n//                                    interactiveType.GetString() == \"button_reply\")\n//                                {\n//                                    _logger.LogInformation(\"ðŸ‘‰ Routing to Click Processor (interactive/button_reply)\");\n//                                    await _clickProcessor.ProcessClickAsync(value);\n//                                    continue;\n//                                }\n\n//                                if (interactive.TryGetProperty(\"list_reply\", out _))\n//                                {\n//                                    _logger.LogInformation(\"ðŸ‘‰ Routing to Click Processor (interactive/list_reply)\");\n//                                    await _clickProcessor.ProcessClickAsync(value);\n//                                    continue;\n//                                }\n//                            }\n\n//                            // (C) Inbound plain message types â†’ INBOUND\n//                            if (type is \"text\" or \"image\" or \"audio\")\n//                            {\n//                                _logger.LogInformation(\"ðŸ’¬ Routing to InboundMessageProcessor (type: {Type})\", type);\n//                                await _inboundMessageProcessor.ProcessChatAsync(value);\n//                                continue;\n//                            }\n\n//                            _logger.LogDebug(\"â„¹ï¸ Message type '{Type}' not handled by dispatcher.\", type);\n//                        }\n//                    }\n//                }\n//            }\n//            catch (Exception ex)\n//            {\n//                _logger.LogError(ex, \"âŒ Dispatcher failed to process WhatsApp webhook.\");\n//            }\n//        }\n\n//        private static bool IsStatusPayload(JsonElement root)\n//        {\n//            // Meta-like: entry[].changes[].value.statuses\n//            if (TryGetMetaValue(root, out var val) && val.Value.TryGetProperty(\"statuses\", out _))\n//                return true;\n\n//            // Some providers mark with \"status\" or event containing \"status\"\n//            if (root.TryGetProperty(\"status\", out _)) return true;\n//            if (root.TryGetProperty(\"event\", out var ev) &&\n//                (ev.GetString()?.Contains(\"status\", StringComparison.OrdinalIgnoreCase) ?? false))\n//                return true;\n\n//            return false;\n//        }\n\n//        private static string? DetectProvider(JsonElement root)\n//        {\n//            // Heuristics by envelope\n//            if (root.TryGetProperty(\"object\", out var obj) && obj.GetString() == \"whatsapp_business_account\")\n//                return \"meta\";\n//            if (root.TryGetProperty(\"entry\", out _))\n//                return \"meta\";\n//            if (root.TryGetProperty(\"event\", out _))\n//                return \"pinnacle\";\n//            return null;\n//        }\n\n//        private static bool TryGetMetaValue(JsonElement root, out (JsonElement Value, JsonElement? Change, JsonElement? Entry) res)\n//        {\n//            res = default;\n//            if (!root.TryGetProperty(\"entry\", out var entries) || entries.ValueKind != JsonValueKind.Array || entries.GetArrayLength() == 0)\n//                return false;\n\n//            var entry = entries[0];\n//            if (!entry.TryGetProperty(\"changes\", out var changes) || changes.ValueKind != JsonValueKind.Array || changes.GetArrayLength() == 0)\n//                return false;\n\n//            var change = changes[0];\n//            if (!change.TryGetProperty(\"value\", out var value))\n//                return false;\n\n//            res = (value, change, entry);\n//            return true;\n//        }\n\n//        private static NumberHints ExtractNumberHints(JsonElement root, string? provider)\n//        {\n//            var hints = new NumberHints();\n\n//            // Meta (or unknown â†’ treat as Meta envelope)\n//            if (string.Equals(provider, \"meta\", StringComparison.OrdinalIgnoreCase) || provider is null)\n//            {\n//                if (TryGetMetaValue(root, out var v))\n//                {\n//                    if (v.Value.TryGetProperty(\"metadata\", out var md))\n//                    {\n//                        if (md.TryGetProperty(\"phone_number_id\", out var pnid))\n//                            hints.PhoneNumberId = pnid.GetString();\n\n//                        if (md.TryGetProperty(\"display_phone_number\", out var disp))\n//                            hints.DisplayPhoneNumber = NormalizePhone(disp.GetString());\n\n//                        if (md.TryGetProperty(\"waba_id\", out var wabaFromMeta))\n//                            hints.WabaId = wabaFromMeta.GetString();\n//                    }\n\n//                    // Some adapters put waba_id at value-level\n//                    if (string.IsNullOrWhiteSpace(hints.WabaId) &&\n//                        v.Value.TryGetProperty(\"waba_id\", out var wabaTop))\n//                    {\n//                        hints.WabaId = wabaTop.GetString();\n//                    }\n\n//                    // First status often carries recipient_id (WA ID)\n//                    if (v.Value.TryGetProperty(\"statuses\", out var statuses) &&\n//                        statuses.ValueKind == JsonValueKind.Array && statuses.GetArrayLength() > 0)\n//                    {\n//                        var s0 = statuses[0];\n//                        if (s0.TryGetProperty(\"recipient_id\", out var rid))\n//                            hints.WaId = rid.GetString();\n//                    }\n//                }\n//            }\n//            // Pinnacle (raw or adapted)\n//            else if (string.Equals(provider, \"pinnacle\", StringComparison.OrdinalIgnoreCase))\n//            {\n//                // If your adapter produced a Meta-like envelope, this will work too:\n//                if (TryGetMetaValue(root, out var v2) && v2.Value.TryGetProperty(\"metadata\", out var md2))\n//                {\n//                    if (md2.TryGetProperty(\"phone_number_id\", out var pnid2))\n//                        hints.PhoneNumberId = pnid2.GetString();\n\n//                    if (md2.TryGetProperty(\"display_phone_number\", out var disp2))\n//                        hints.DisplayPhoneNumber = NormalizePhone(disp2.GetString());\n//                }\n\n//                // Raw Pinnacle-style fields on the envelope\n//                if (string.IsNullOrWhiteSpace(hints.PhoneNumberId) &&\n//                    root.TryGetProperty(\"phone_number_id\", out var pn))\n//                    hints.PhoneNumberId = pn.GetString();\n\n//                if (string.IsNullOrWhiteSpace(hints.DisplayPhoneNumber))\n//                {\n//                    if (root.TryGetProperty(\"from\", out var from))\n//                        hints.DisplayPhoneNumber = NormalizePhone(from.GetString());\n//                    else if (root.TryGetProperty(\"msisdn\", out var msisdn))\n//                        hints.DisplayPhoneNumber = NormalizePhone(msisdn.GetString());\n//                }\n\n//                if (root.TryGetProperty(\"wabaId\", out var waba))\n//                    hints.WabaId = waba.GetString();\n//            }\n\n//            return hints;\n//        }\n\n//        private static string? NormalizePhone(string? v)\n//        {\n//            if (string.IsNullOrWhiteSpace(v)) return null;\n//            var t = v.Trim();\n//            var keepPlus = t.StartsWith(\"+\");\n//            var digits = new string(t.Where(char.IsDigit).ToArray());\n//            return keepPlus ? \"+\" + digits : digits;\n//        }\n\n//        private struct NumberHints\n//        {\n//            public string? PhoneNumberId { get; set; }\n//            public string? DisplayPhoneNumber { get; set; }\n//            public string? WabaId { get; set; }\n//            public string? WaId { get; set; }\n//        }\n//    }\n//}\n\n\n\n\n\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Services/WhatsAppWebhookService.cs",
      "sha256": "28a7cd652990f6303b6c0d8b76fb79b17aa8df36d79774e23c593d21a44df972",
      "language": "csharp",
      "size": 5929,
      "content": "using System.Text.Json;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\nusing xbytechat.api.Features.CampaignTracking.Models; // CampaignSendLog (optional if you keep only MessageLogs lookup)\nusing xbytechat.api.Features.MessageManagement.Services; // IMessageStatusUpdater\nusing xbytechat.api.Features.Webhooks.Status;\nusing xbytechat.api.Infrastructure; // your AppDbContext namespace (adjust if different)\nusing xbytechat.api.Infrastructure.Observability; // MetricsRegistry\n\nnamespace xbytechat.api.Features.Webhooks.Services\n{\n    \n\n    public sealed class WhatsAppWebhookService : IWhatsAppWebhookService\n    {\n        private readonly AppDbContext _context;\n        private readonly ILogger<WhatsAppWebhookService> _logger;\n        private readonly IMessageStatusUpdater _updater;\n\n        public WhatsAppWebhookService(\n            AppDbContext context,\n            ILogger<WhatsAppWebhookService> logger,\n            IMessageStatusUpdater updater)\n        {\n            _context = context;\n            _logger = logger;\n            _updater = updater;\n        }\n\n        /// <summary>\n        /// Single modern entrypoint. Assumes payload is Meta-shaped (entry[].changes[].value.statuses[]).\n        /// If you ingest other providers, adapt them to this shape before calling here.\n        /// </summary>\n        public async Task ProcessStatusUpdateAsync(Guid businessId, string provider, JsonElement payload, CancellationToken ct = default)\n        {\n            provider = (provider ?? \"\").Trim().ToLowerInvariant();\n\n            // Normalize status text to what the updater expects\n            static string NormalizeStatus(string? s)\n            {\n                s = (s ?? \"\").Trim().ToLowerInvariant();\n                return s switch\n                {\n                    \"sent\" => \"sent\",\n                    \"delivered\" => \"delivered\",\n                    \"read\" => \"read\",\n                    \"failed\" => \"failed\",\n                    _ => s\n                };\n            }\n\n            // Parse Meta-like envelope: entry[].changes[].value.statuses[]\n            if (!payload.TryGetProperty(\"entry\", out var entries) || entries.ValueKind != JsonValueKind.Array)\n            {\n                _logger.LogWarning(\"Status payload missing 'entry' array.\");\n                return;\n            }\n\n            foreach (var entry in entries.EnumerateArray())\n            {\n                if (!entry.TryGetProperty(\"changes\", out var changes) || changes.ValueKind != JsonValueKind.Array)\n                    continue;\n\n                foreach (var change in changes.EnumerateArray())\n                {\n                    if (!change.TryGetProperty(\"value\", out var value) || value.ValueKind != JsonValueKind.Object)\n                        continue;\n\n                    if (!value.TryGetProperty(\"statuses\", out var statuses) || statuses.ValueKind != JsonValueKind.Array)\n                        continue;\n\n                    foreach (var st in statuses.EnumerateArray())\n                    {\n                        // Fields: id (WAMID or provider id), status, timestamp\n                        string? providerOrWaId = st.TryGetProperty(\"id\", out var idProp) ? idProp.GetString() : null;\n                        string? statusText = st.TryGetProperty(\"status\", out var statusProp) ? statusProp.GetString() : null;\n\n                        long unixTs = 0;\n                        if (st.TryGetProperty(\"timestamp\", out var tsProp))\n                        {\n                            if (tsProp.ValueKind == JsonValueKind.String && long.TryParse(tsProp.GetString(), out var parsed))\n                                unixTs = parsed;\n                            else if (tsProp.ValueKind == JsonValueKind.Number)\n                                unixTs = tsProp.GetInt64();\n                        }\n\n                        if (string.IsNullOrWhiteSpace(providerOrWaId) || string.IsNullOrWhiteSpace(statusText))\n                        {\n                            _logger.LogWarning(\"Status item missing id or status: {Item}\", st.GetRawText());\n                            continue;\n                        }\n\n                        // Resolve canonical MessageId (WAMID) from DB; fallback to provider id if not found.\n                        // 1) Try MessageLogs\n                        string? messageId = await _context.MessageLogs.AsNoTracking()\n                            .Where(m => m.ProviderMessageId == providerOrWaId || m.MessageId == providerOrWaId)\n                            .OrderByDescending(m => m.CreatedAt)\n                            .Select(m => m.MessageId ?? m.ProviderMessageId)\n                            .FirstOrDefaultAsync(ct);\n\n                        // 2) Optional: also look in CampaignSendLogs if desired\n                        if (string.IsNullOrWhiteSpace(messageId))\n                        {\n                            messageId = await _context.CampaignSendLogs.AsNoTracking()\n                                .Where(c => c.MessageId == providerOrWaId)\n                                .OrderByDescending(c => c.CreatedAt)\n                                .Select(c => c.MessageId)\n                                .FirstOrDefaultAsync(ct);\n                        }\n\n                        messageId ??= providerOrWaId;\n\n                        var tsUtc = unixTs > 0\n                            ? DateTimeOffset.FromUnixTimeSeconds(unixTs).UtcDateTime\n                            : DateTime.UtcNow;\n\n                        var norm = NormalizeStatus(statusText);\n\n                        // Updater signature: (messageId, status, tsUtc, error, ct)\n                        await _updater.UpdateAsync(messageId, norm, tsUtc, null, ct);\n\n                        _logger.LogInformation(\"Status updated: msg={MessageId} status={Status} ts={Ts}\", messageId, norm, tsUtc);\n                    }\n                }\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Status/IMessageStatusUpdater.cs",
      "sha256": "38df9b6edc3c2706c404a79c6b9fa66e5065c9a4481e798e7f497e9e56c9c358",
      "language": "csharp",
      "size": 1365,
      "content": "using System;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace xbytechat.api.Features.Webhooks.Status\n{\n    public interface IMessageStatusUpdater\n    {\n       // Task UpdateAsync(StatusEvent ev, CancellationToken ct = default);\n        Task<int> UpdateAsync(string messageId, string status, DateTime tsUtc, string? error, CancellationToken ct);\n    }\n\n    public sealed class StatusEvent\n    {\n        public Guid BusinessId { get; init; }\n        public string Provider { get; init; } = \"\";          // \"meta\" | \"pinnacle\"\n\n        // Provider message id (Meta \"id\", Pinnacle equivalent) â†’ maps to MessageId in your DB\n        public string ProviderMessageId { get; init; } = \"\";\n\n        // Optional hints (not required in your current lookups)\n        public Guid? CampaignSendLogId { get; init; }\n        public string? RecipientWaId { get; init; }\n\n        public MessageDeliveryState State { get; init; }     // Sent/Delivered/Read/Failed/Deleted\n        public DateTimeOffset OccurredAt { get; init; }      // from provider timestamp when available\n\n        public string? ErrorCode { get; init; }\n        public string? ErrorMessage { get; init; }\n        public string? ConversationId { get; init; }\n    }\n\n    public enum MessageDeliveryState\n    {\n        Sent,\n        Delivered,\n        Read,\n        Failed,\n        Deleted\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Status/MessageStatusContracts.cs",
      "sha256": "37627bd0faaa1e9e438a5d7379dc5f5773a8f7553fe9e1b476e74ee20a66ce30",
      "language": "csharp",
      "size": 1443,
      "content": "namespace xbytechat.api.Features.Webhooks.Status\n{\n    public class MessageStatusContracts\n    {\n        public enum CanonicalMessageStatus\n        {\n            Unknown = 0,\n            Submitted,   // API accepted (optional)\n            Sent,        // provider accepted / sent\n            Delivered,\n            Read,\n            Failed\n        }\n        public sealed class UpdateMessageStatusRequest\n        {\n            public Guid BusinessId { get; set; }\n            public string Provider { get; set; } = \"\";              // \"meta_cloud\" | \"pinnacle\" | etc.\n            public string MessageId { get; set; } = \"\";             // provider message id (WAMID / id)\n            public string RawStatus { get; set; } = \"\";             // provider-specific (e.g., \"sent\", \"delivered\")\n            public DateTimeOffset? EventTime { get; set; }          // provider timestamp, if any\n\n            public string? RecipientNumber { get; set; }            // optional sanity context\n            public string? ErrorCode { get; set; }                  // optional error info\n            public string? ErrorMessage { get; set; }               // optional error info\n            public string? RawPayloadJson { get; set; }             // optional audit/debug\n        }\n\n        public interface IMessageStatusUpdater\n        {\n            Task<bool> UpdateAsync(UpdateMessageStatusRequest req, CancellationToken ct = default);\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Features/Webhooks/Status/MessageStatusUpdater.cs",
      "sha256": "9bbb3fb92f5443fc392f4ef65a69eef507c7139272044426334fc9d111e6a62c",
      "language": "csharp",
      "size": 25566,
      "content": "using System;\nusing System.Linq;\nusing System.Reflection;\nusing System.Text.Json;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Logging;\n\n// ðŸ‘‡ make sure this is where your AppDbContext lives\nusing xbytechat.api;\n\nusing xbytechat.api.Features.CampaignTracking.Models; // CampaignSendLog\nusing xbytechat.api.Features.CampaignModule.Models;   // Campaign (nav)\nusing xbytechat.api.Features.CRM.Models;                      // Contact (nav)\nusing xbytechat.api.Features.MessageManagement.DTOs;  // MessageLog\n\n// ðŸ‘‡ Billing ingest\nusing xbytechat_api.Features.Billing.Services;        // IBillingIngestService\nusing xbytechat.api.Infrastructure.Observability;\nusing Channel = System.Threading.Channels.Channel;\nusing System.Threading.RateLimiting;\nusing Serilog;\nnamespace xbytechat.api.Features.Webhooks.Status\n{\n    /// <summary>\n    /// Idempotent updater touching CampaignSendLogs and MessageLogs using your actual schema.\n    /// Also forwards raw Meta webhook payloads to Billing ingest for pricing/billing capture.\n    /// </summary>\n    public class MessageStatusUpdater : IMessageStatusUpdater\n    {\n        private readonly AppDbContext _db;\n        private readonly ILogger<MessageStatusUpdater> _log;\n        private readonly IBillingIngestService _billing;\n\n        public MessageStatusUpdater(AppDbContext db,\n                                    ILogger<MessageStatusUpdater> log,\n                                    IBillingIngestService billing)\n        {\n            _db = db;\n            _log = log;\n            _billing = billing;\n        }\n\n        //public async Task UpdateAsync(StatusEvent ev, CancellationToken ct = default)\n        //{\n        //    // ðŸ”Ž Guard: we need Business + ProviderMessageId (WAMID) to reconcile reliably\n        //    if (ev.BusinessId == Guid.Empty || string.IsNullOrWhiteSpace(ev.ProviderMessageId))\n        //    {\n        //        _log.LogWarning(\"Status update missing key fields (BusinessId or ProviderMessageId). Skip.\");\n        //        return;\n        //    }\n\n        //    // 1) Pull candidates (scoped to business + WAMID)\n        //    var sendLogQ = _db.Set<CampaignSendLog>()\n        //                      .AsTracking()\n        //                      .Where(s => s.BusinessId == ev.BusinessId && s.MessageId == ev.ProviderMessageId);\n\n        //    // NOTE: some rows set both MessageId and ProviderMessageId to the wamid; be flexible.\n        //    var msgLogQ = _db.Set<MessageLog>()\n        //                     .AsTracking()\n        //                     .Where(m => m.BusinessId == ev.BusinessId &&\n        //                                (m.ProviderMessageId == ev.ProviderMessageId ||\n        //                                 m.MessageId == ev.ProviderMessageId));\n\n        //    // If caller passed a specific CampaignSendLogId, narrow further\n        //    if (ev.CampaignSendLogId is Guid sid)\n        //        sendLogQ = sendLogQ.Where(s => s.Id == sid);\n\n        //    var sendLog = await sendLogQ.FirstOrDefaultAsync(ct);\n        //    var msgLog = await msgLogQ.FirstOrDefaultAsync(ct);\n\n        //    // 2) Apply transition (idempotent)\n        //    var changed = ApplyTransition(sendLog, msgLog, ev);\n\n        //    // 3) Persist only if something actually changed\n        //    if (changed > 0)\n        //        await _db.SaveChangesAsync(ct);\n\n        //    // 4) Always forward Meta status webhook payloads to Billing ingest (for pricing events).\n        //    await TryForwardToBillingAsync(ev, ct);\n        //}\n\n\n        public async Task<int> UpdateAsync(string messageId, string status, DateTime tsUtc, string? error, CancellationToken ct)\n        {\n            if (string.IsNullOrWhiteSpace(messageId)) return 0;\n\n            status = status.Trim().ToLowerInvariant();\n\n            // 1) Update CampaignSendLogs by MessageId (idempotent)\n            var cslQuery = _db.CampaignSendLogs.Where(x => x.MessageId == messageId);\n\n            int affected;\n            if (status == \"delivered\")\n            {\n                affected = await cslQuery.ExecuteUpdateAsync(s => s\n                    .SetProperty(x => x.ErrorMessage, error)\n                    .SetProperty(x => x.DeliveredAt, tsUtc)\n                    .SetProperty(x => x.SendStatus, \"Delivered\")\n                    .SetProperty(x => x.SentAt, x => x.SentAt ?? tsUtc), ct);\n            }\n            else if (status == \"read\")\n            {\n                affected = await cslQuery.ExecuteUpdateAsync(s => s\n                    .SetProperty(x => x.ErrorMessage, error)\n                    .SetProperty(x => x.ReadAt, tsUtc)\n                    .SetProperty(x => x.SendStatus, \"Read\")\n                    .SetProperty(x => x.SentAt, x => x.SentAt ?? tsUtc)\n                    .SetProperty(x => x.DeliveredAt, x => x.DeliveredAt ?? tsUtc), ct);\n            }\n            else if (status == \"failed\")\n            {\n                affected = await cslQuery.ExecuteUpdateAsync(s => s\n                    .SetProperty(x => x.ErrorMessage, error)\n                    .SetProperty(x => x.SendStatus, \"Failed\")\n                    .SetProperty(x => x.SentAt, x => x.SentAt ?? tsUtc), ct);\n            }\n            else if (status == \"sent\")\n            {\n                affected = await cslQuery.ExecuteUpdateAsync(s => s\n                    .SetProperty(x => x.ErrorMessage, error)\n                    .SetProperty(x => x.SentAt, x => x.SentAt ?? tsUtc)\n                    .SetProperty(x => x.SendStatus, \"Sent\"), ct);\n            }\n            else\n            {\n                // Unknown status: only persist the error text (harmless)\n                affected = await cslQuery.ExecuteUpdateAsync(s => s\n                    .SetProperty(x => x.ErrorMessage, error), ct);\n            }\n\n            // 2) Mirror onto MessageLogs (optional but useful for parity)\n            var mlQuery = _db.MessageLogs.Where(m => m.ProviderMessageId == messageId);\n\n            if (status == \"delivered\")\n            {\n                await mlQuery.ExecuteUpdateAsync(s => s\n                    .SetProperty(m => m.Status, \"Delivered\")\n                    .SetProperty(m => m.SentAt, m => m.SentAt ?? tsUtc), ct);\n            }\n            else if (status == \"read\")\n            {\n                await mlQuery.ExecuteUpdateAsync(s => s\n                    .SetProperty(m => m.Status, \"Read\")\n                    .SetProperty(m => m.SentAt, m => m.SentAt ?? tsUtc), ct);\n            }\n            else if (status == \"failed\")\n            {\n                await mlQuery.ExecuteUpdateAsync(s => s\n                    .SetProperty(m => m.Status, \"Failed\")\n                    .SetProperty(m => m.SentAt, m => m.SentAt ?? tsUtc), ct);\n            }\n            else if (status == \"sent\")\n            {\n                await mlQuery.ExecuteUpdateAsync(s => s\n                    .SetProperty(m => m.Status, \"Sent\")\n                    .SetProperty(m => m.SentAt, m => m.SentAt ?? tsUtc), ct);\n            }\n            // else: ignore unknown statuses for MessageLogs\n\n            // 3) Side-effects & metrics\n            if (affected == 0)\n            {\n                _log.LogWarning(\"[StatusUpdater] No CampaignSendLog row for messageId={MessageId}\", messageId);\n            }\n            else\n            {\n                if (status == \"failed\") MetricsRegistry.MessagesFailed.Add(1);\n                else if (status == \"sent\") MetricsRegistry.MessagesSent.Add(1);\n                // delivered/read are visible in analytics; counters optional\n            }\n\n            // Optional: billing for delivered/read goes here if required\n\n            return affected;\n        }\n\n        /// <summary>Returns number of entities modified.</summary>\n        private int ApplyTransition(CampaignSendLog? sendLog, MessageLog? msgLog, StatusEvent ev)\n        {\n            int modified = 0;\n\n            // --- CampaignSendLog updates ---\n            if (sendLog != null)\n            {\n                if (!string.Equals(sendLog.MessageId, ev.ProviderMessageId, StringComparison.Ordinal))\n                {\n                    sendLog.MessageId = ev.ProviderMessageId;\n                    modified++;\n                }\n\n                switch (ev.State)\n                {\n                    case MessageDeliveryState.Sent:\n                        if (!EqualsIgnoreCase(sendLog.SendStatus, \"Sent\"))\n                        {\n                            sendLog.SendStatus = \"Sent\";\n                            modified++;\n                        }\n                        if (sendLog.SentAt == null || sendLog.SentAt == default)\n                            sendLog.SentAt = ev.OccurredAt.UtcDateTime;\n                        break;\n\n                    case MessageDeliveryState.Delivered:\n                        if (!EqualsIgnoreCase(sendLog.SendStatus, \"Read\") &&\n                            !EqualsIgnoreCase(sendLog.SendStatus, \"Delivered\"))\n                        {\n                            sendLog.SendStatus = \"Delivered\";\n                            modified++;\n                        }\n                        if (sendLog.DeliveredAt == null || sendLog.DeliveredAt == default)\n                            sendLog.DeliveredAt = ev.OccurredAt.UtcDateTime;\n                        break;\n\n                    case MessageDeliveryState.Read:\n                        if (!EqualsIgnoreCase(sendLog.SendStatus, \"Read\"))\n                        {\n                            sendLog.SendStatus = \"Read\";\n                            modified++;\n                        }\n                        if (sendLog.ReadAt == null || sendLog.ReadAt == default)\n                            sendLog.ReadAt = ev.OccurredAt.UtcDateTime;\n                        break;\n\n                    case MessageDeliveryState.Failed:\n                        if (!EqualsIgnoreCase(sendLog.SendStatus, \"Failed\"))\n                        {\n                            sendLog.SendStatus = \"Failed\";\n                            modified++;\n                        }\n                        if (sendLog.ErrorMessage != ev.ErrorMessage)\n                        {\n                            sendLog.ErrorMessage = ev.ErrorMessage;\n                            modified++;\n                        }\n                        break;\n\n                    case MessageDeliveryState.Deleted:\n                        if (!EqualsIgnoreCase(sendLog.SendStatus, \"Deleted\"))\n                        {\n                            sendLog.SendStatus = \"Deleted\";\n                            modified++;\n                        }\n                        break;\n                }\n            }\n\n            // --- MessageLog updates ---\n            if (msgLog != null)\n            {\n                if (!string.Equals(msgLog.MessageId, ev.ProviderMessageId, StringComparison.Ordinal))\n                {\n                    msgLog.MessageId = ev.ProviderMessageId;\n                    modified++;\n                }\n\n                switch (ev.State)\n                {\n                    case MessageDeliveryState.Sent:\n                        if (!EqualsIgnoreCase(msgLog.Status, \"Sent\"))\n                        {\n                            msgLog.Status = \"Sent\";\n                            modified++;\n                        }\n                        if (msgLog.SentAt == null || msgLog.SentAt == default)\n                            msgLog.SentAt = ev.OccurredAt.UtcDateTime;\n                        break;\n\n                    case MessageDeliveryState.Delivered:\n                        if (!EqualsIgnoreCase(msgLog.Status, \"Read\") &&\n                            !EqualsIgnoreCase(msgLog.Status, \"Delivered\"))\n                        {\n                            msgLog.Status = \"Delivered\";\n                            modified++;\n                        }\n                        break;\n\n                    case MessageDeliveryState.Read:\n                        if (!EqualsIgnoreCase(msgLog.Status, \"Read\"))\n                        {\n                            msgLog.Status = \"Read\";\n                            modified++;\n                        }\n                        break;\n\n                    case MessageDeliveryState.Failed:\n                        if (!EqualsIgnoreCase(msgLog.Status, \"Failed\"))\n                        {\n                            msgLog.Status = \"Failed\";\n                            modified++;\n                        }\n                        if (msgLog.ErrorMessage != ev.ErrorMessage)\n                        {\n                            msgLog.ErrorMessage = ev.ErrorMessage;\n                            modified++;\n                        }\n                        break;\n\n                    case MessageDeliveryState.Deleted:\n                        if (!EqualsIgnoreCase(msgLog.Status, \"Deleted\"))\n                        {\n                            msgLog.Status = \"Deleted\";\n                            modified++;\n                        }\n                        break;\n                }\n            }\n\n            if (sendLog == null && msgLog == null)\n            {\n                _log.LogWarning(\"No matching rows for BusinessId={BusinessId}, MessageId={MessageId}, State={State}\",\n                    ev.BusinessId, ev.ProviderMessageId, ev.State);\n            }\n\n            return modified;\n        }\n\n        private static bool EqualsIgnoreCase(string? a, string? b) =>\n            string.Equals(a, b, StringComparison.OrdinalIgnoreCase);\n\n        // ---------------- Billing forwarder ----------------\n\n        private async Task TryForwardToBillingAsync(StatusEvent ev, CancellationToken ct)\n        {\n            try\n            {\n                if (ev.BusinessId == Guid.Empty) return;\n\n                // Pull Provider (via reflection to avoid changing your StatusEvent contract)\n                var provider = GetStringProp(ev, \"Provider\")\n                               ?? GetStringProp(ev, \"ChannelProvider\")\n                               ?? GetStringProp(ev, \"SourceProvider\")\n                               ?? GetStringProp(ev, \"ProviderNormalized\");\n\n                // Try to get raw JSON payload from common property names\n                string? rawJson =\n                    GetStringProp(ev, \"RawPayloadJson\") ??\n                    GetStringProp(ev, \"PayloadJson\") ??\n                    TryGetJsonElementText(ev, \"Body\") ??\n                    TryGetJsonElementText(ev, \"RawBody\");\n\n                // If provider missing, use a lightweight sniff (Meta sends \"whatsapp_business_account\")\n                if (string.IsNullOrWhiteSpace(provider) && !string.IsNullOrWhiteSpace(rawJson) &&\n                    rawJson.IndexOf(\"\\\"whatsapp_business_account\\\"\", StringComparison.OrdinalIgnoreCase) >= 0)\n                {\n                    provider = \"META_CLOUD\";\n                }\n\n                // Normalize provider for billing\n                var normalized = NormalizeProvider(provider);\n                if (normalized != \"META_CLOUD\") return; // only forward Meta to billing ingest for now\n\n                if (string.IsNullOrWhiteSpace(rawJson))\n                {\n                    _log.LogDebug(\"Billing forward skipped: no raw payload JSON available on StatusEvent.\");\n                    return;\n                }\n\n                await _billing.IngestFromWebhookAsync(ev.BusinessId, normalized, rawJson);\n            }\n            catch (Exception ex)\n            {\n                _log.LogWarning(ex, \"Billing ingest (status webhook) failed. businessId={BusinessId}\", ev.BusinessId);\n            }\n        }\n\n        private static string NormalizeProvider(string? provider)\n        {\n            if (string.IsNullOrWhiteSpace(provider)) return \"\";\n            var p = provider.Trim();\n            if (p.Equals(\"META_CLOUD\", StringComparison.OrdinalIgnoreCase)) return \"META_CLOUD\";\n            if (p.Equals(\"meta\", StringComparison.OrdinalIgnoreCase)) return \"META_CLOUD\";\n            if (p.Equals(\"meta_cloud\", StringComparison.OrdinalIgnoreCase)) return \"META_CLOUD\";\n            return p; // other providers unchanged\n        }\n\n        private static string? GetStringProp(object obj, string propName)\n        {\n            var pi = obj.GetType().GetProperty(propName, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);\n            if (pi == null) return null;\n            var val = pi.GetValue(obj);\n            return val as string;\n        }\n\n        private static string? TryGetJsonElementText(object obj, string propName)\n        {\n            var pi = obj.GetType().GetProperty(propName, BindingFlags.Public | BindingFlags.Instance | BindingFlags.IgnoreCase);\n            if (pi == null) return null;\n            var val = pi.GetValue(obj);\n            if (val is JsonElement je) return je.GetRawText();\n            return null;\n        }\n    }\n}\n\n\n//using System;\n//using System.Linq;\n//using System.Threading;\n//using System.Threading.Tasks;\n//using Microsoft.EntityFrameworkCore;\n//using Microsoft.Extensions.Logging;\n\n//// ðŸ‘‡ make sure this is where your AppDbContext lives\n//using xbytechat.api;\n\n//using xbytechat.api.Features.CampaignTracking.Models; // CampaignSendLog\n//using xbytechat.api.Features.CampaignModule.Models;   // Campaign (nav)\n//using xbytechat.api.CRM.Models;                       // Contact (nav)\n//using xbytechat.api.Features.MessageManagement.DTOs;  // MessageLog\n\n//namespace xbytechat.api.Features.Webhooks.Status\n//{\n//    /// <summary>\n//    /// Idempotent updater touching CampaignSendLogs and MessageLogs using your actual schema.\n//    /// </summary>\n//    public class MessageStatusUpdater : IMessageStatusUpdater\n//    {\n//        private readonly AppDbContext _db;\n//        private readonly ILogger<MessageStatusUpdater> _log;\n\n//        public MessageStatusUpdater(AppDbContext db, ILogger<MessageStatusUpdater> log)\n//        {\n//            _db = db;\n//            _log = log;\n//        }\n\n//        public async Task UpdateAsync(StatusEvent ev, CancellationToken ct = default)\n//        {\n//            // ðŸ”Ž Guard: we need Business + ProviderMessageId (WAMID) to reconcile reliably\n//            if (ev.BusinessId == Guid.Empty || string.IsNullOrWhiteSpace(ev.ProviderMessageId))\n//            {\n//                _log.LogWarning(\"Status update missing key fields (BusinessId or ProviderMessageId). Skip.\");\n//                return;\n//            }\n\n//            // 1) Pull candidates (scoped to business + WAMID)\n//            var sendLogQ = _db.Set<CampaignSendLog>()\n//                              .AsTracking()\n//                              .Where(s => s.BusinessId == ev.BusinessId && s.MessageId == ev.ProviderMessageId);\n\n//            var msgLogQ = _db.Set<MessageLog>()\n//                             .AsTracking()\n//                             .Where(m => m.BusinessId == ev.BusinessId && m.MessageId == ev.ProviderMessageId);\n\n//            // If caller passed a specific CampaignSendLogId, narrow further\n//            if (ev.CampaignSendLogId is Guid sid)\n//                sendLogQ = sendLogQ.Where(s => s.Id == sid);\n\n//            var sendLog = await sendLogQ.FirstOrDefaultAsync(ct);\n//            var msgLog = await msgLogQ.FirstOrDefaultAsync(ct);\n\n//            // 2) Apply transition (idempotent)\n//            var changed = ApplyTransition(sendLog, msgLog, ev);\n\n//            // 3) Persist only if something actually changed\n//            if (changed > 0)\n//                await _db.SaveChangesAsync(ct);\n//        }\n\n//        /// <summary>Returns number of entities modified.</summary>\n//        private int ApplyTransition(CampaignSendLog? sendLog, MessageLog? msgLog, StatusEvent ev)\n//        {\n//            int modified = 0;\n\n//            // --- CampaignSendLog updates ---\n//            if (sendLog != null)\n//            {\n//                if (!string.Equals(sendLog.MessageId, ev.ProviderMessageId, StringComparison.Ordinal))\n//                {\n//                    sendLog.MessageId = ev.ProviderMessageId;\n//                    modified++;\n//                }\n\n//                switch (ev.State)\n//                {\n//                    case MessageDeliveryState.Sent:\n//                        if (!EqualsIgnoreCase(sendLog.SendStatus, \"Sent\"))\n//                        {\n//                            sendLog.SendStatus = \"Sent\";\n//                            modified++;\n//                        }\n//                        if (sendLog.SentAt == null || sendLog.SentAt == default)\n//                            sendLog.SentAt = ev.OccurredAt.UtcDateTime;\n//                        break;\n\n//                    case MessageDeliveryState.Delivered:\n//                        if (!EqualsIgnoreCase(sendLog.SendStatus, \"Read\") &&\n//                            !EqualsIgnoreCase(sendLog.SendStatus, \"Delivered\"))\n//                        {\n//                            sendLog.SendStatus = \"Delivered\";\n//                            modified++;\n//                        }\n//                        if (sendLog.DeliveredAt == null || sendLog.DeliveredAt == default)\n//                            sendLog.DeliveredAt = ev.OccurredAt.UtcDateTime;\n//                        break;\n\n//                    case MessageDeliveryState.Read:\n//                        if (!EqualsIgnoreCase(sendLog.SendStatus, \"Read\"))\n//                        {\n//                            sendLog.SendStatus = \"Read\";\n//                            modified++;\n//                        }\n//                        if (sendLog.ReadAt == null || sendLog.ReadAt == default)\n//                            sendLog.ReadAt = ev.OccurredAt.UtcDateTime;\n//                        break;\n\n//                    case MessageDeliveryState.Failed:\n//                        if (!EqualsIgnoreCase(sendLog.SendStatus, \"Failed\"))\n//                        {\n//                            sendLog.SendStatus = \"Failed\";\n//                            modified++;\n//                        }\n//                        if (sendLog.ErrorMessage != ev.ErrorMessage)\n//                        {\n//                            sendLog.ErrorMessage = ev.ErrorMessage;\n//                            modified++;\n//                        }\n//                        break;\n\n//                    case MessageDeliveryState.Deleted:\n//                        if (!EqualsIgnoreCase(sendLog.SendStatus, \"Deleted\"))\n//                        {\n//                            sendLog.SendStatus = \"Deleted\";\n//                            modified++;\n//                        }\n//                        break;\n//                }\n//            }\n\n//            // --- MessageLog updates ---\n//            if (msgLog != null)\n//            {\n//                if (!string.Equals(msgLog.MessageId, ev.ProviderMessageId, StringComparison.Ordinal))\n//                {\n//                    msgLog.MessageId = ev.ProviderMessageId;\n//                    modified++;\n//                }\n\n//                switch (ev.State)\n//                {\n//                    case MessageDeliveryState.Sent:\n//                        if (!EqualsIgnoreCase(msgLog.Status, \"Sent\"))\n//                        {\n//                            msgLog.Status = \"Sent\";\n//                            modified++;\n//                        }\n//                        if (msgLog.SentAt == null || msgLog.SentAt == default)\n//                            msgLog.SentAt = ev.OccurredAt.UtcDateTime;\n//                        break;\n\n//                    case MessageDeliveryState.Delivered:\n//                        if (!EqualsIgnoreCase(msgLog.Status, \"Read\") &&\n//                            !EqualsIgnoreCase(msgLog.Status, \"Delivered\"))\n//                        {\n//                            msgLog.Status = \"Delivered\";\n//                            modified++;\n//                        }\n//                        break;\n\n//                    case MessageDeliveryState.Read:\n//                        if (!EqualsIgnoreCase(msgLog.Status, \"Read\"))\n//                        {\n//                            msgLog.Status = \"Read\";\n//                            modified++;\n//                        }\n//                        break;\n\n//                    case MessageDeliveryState.Failed:\n//                        if (!EqualsIgnoreCase(msgLog.Status, \"Failed\"))\n//                        {\n//                            msgLog.Status = \"Failed\";\n//                            modified++;\n//                        }\n//                        if (msgLog.ErrorMessage != ev.ErrorMessage)\n//                        {\n//                            msgLog.ErrorMessage = ev.ErrorMessage;\n//                            modified++;\n//                        }\n//                        break;\n\n//                    case MessageDeliveryState.Deleted:\n//                        if (!EqualsIgnoreCase(msgLog.Status, \"Deleted\"))\n//                        {\n//                            msgLog.Status = \"Deleted\";\n//                            modified++;\n//                        }\n//                        break;\n//                }\n//            }\n\n//            if (sendLog == null && msgLog == null)\n//            {\n//                _log.LogWarning(\"No matching rows for BusinessId={BusinessId}, MessageId={MessageId}, State={State}\",\n//                    ev.BusinessId, ev.ProviderMessageId, ev.State);\n//            }\n\n//            return modified;\n//        }\n\n//        private static bool EqualsIgnoreCase(string? a, string? b) =>\n//            string.Equals(a, b, StringComparison.OrdinalIgnoreCase);\n//    }\n//}\n"
    },
    {
      "path": "xbytechat-api/Infrastructure/Flows/FlowClickTokenOptions.cs",
      "sha256": "77072ad81d2853a2fd79e3d9e38138f6adfdf21eea5558d5771531d9dde4eb9d",
      "language": "csharp",
      "size": 421,
      "content": "// ðŸ“„ Infrastructure/Flows/FlowClickTokenOptions.cs\nnamespace xbytechat.api.Infrastructure.Flows\n{\n    public class FlowClickTokenOptions\n    {\n        public string Secret { get; set; } = \"\";   // long random string (256-bit recommended)\n        public string BaseUrl { get; set; } = \"\";  // e.g. https://app.yourdomain.com\n        public int TtlHours { get; set; } = 72;    // token lifetime (default 3 days)\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Infrastructure/Flows/FlowClickTokenService.cs",
      "sha256": "a259df299ffe015927cc0dfc8bf0818b0e45222cd93cfb2dfb5879f2658e0dfb",
      "language": "csharp",
      "size": 3570,
      "content": "// ðŸ“„ Infrastructure/Flows/FlowClickTokenService.cs\nusing System.IdentityModel.Tokens.Jwt;\nusing System.Security.Claims;\nusing System.Text;\nusing Microsoft.Extensions.Options;\nusing Microsoft.IdentityModel.Tokens;\n\nnamespace xbytechat.api.Infrastructure.Flows\n{\n    public record FlowClickPayload(\n        Guid biz, Guid fid, int ver, Guid sid, short bi,\n        Guid mlid, string cp, long iat, long exp\n    );\n\n    public interface IFlowClickTokenService\n    {\n        string Create(FlowClickPayload p);\n        FlowClickPayload Validate(string token);\n        string BuildUrl(FlowClickPayload p);\n    }\n\n    public class FlowClickTokenService : IFlowClickTokenService\n    {\n        private readonly FlowClickTokenOptions _opt;\n        private readonly JwtSecurityTokenHandler _handler = new();\n\n        public FlowClickTokenService(IOptions<FlowClickTokenOptions> opt)\n        {\n            _opt = opt.Value;\n        }\n\n        public string Create(FlowClickPayload p)\n        {\n            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_opt.Secret));\n            var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);\n\n            var claims = new[]\n            {\n                new Claim(\"biz\", p.biz.ToString()),\n                new Claim(\"fid\", p.fid.ToString()),\n                new Claim(\"ver\", p.ver.ToString()),\n                new Claim(\"sid\", p.sid.ToString()),\n                new Claim(\"bi\",  p.bi.ToString()),\n                new Claim(\"mlid\",p.mlid.ToString()),\n                new Claim(\"cp\",  p.cp),\n                new Claim(\"iat\", p.iat.ToString()),\n                new Claim(\"exp\", p.exp.ToString())\n            };\n\n            var token = new JwtSecurityToken(claims: claims, signingCredentials: creds);\n            return _handler.WriteToken(token);\n        }\n\n        public FlowClickPayload Validate(string token)\n        {\n            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_opt.Secret));\n\n            var parameters = new TokenValidationParameters\n            {\n                ValidateIssuer = false,\n                ValidateAudience = false,\n                ValidateLifetime = false, // weâ€™ll check manually\n                ValidateIssuerSigningKey = true,\n                IssuerSigningKey = key\n            };\n\n            _handler.ValidateToken(token, parameters, out var validated);\n            var jwt = (JwtSecurityToken)validated;\n\n            long iat = long.Parse(jwt.Claims.First(c => c.Type == \"iat\").Value);\n            long exp = long.Parse(jwt.Claims.First(c => c.Type == \"exp\").Value);\n            var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();\n            if (now > exp) throw new SecurityTokenExpiredException(\"Token expired\");\n\n            return new FlowClickPayload(\n                biz: Guid.Parse(jwt.Claims.First(c => c.Type == \"biz\").Value),\n                fid: Guid.Parse(jwt.Claims.First(c => c.Type == \"fid\").Value),\n                ver: int.Parse(jwt.Claims.First(c => c.Type == \"ver\").Value),\n                sid: Guid.Parse(jwt.Claims.First(c => c.Type == \"sid\").Value),\n                bi: short.Parse(jwt.Claims.First(c => c.Type == \"bi\").Value),\n                mlid: Guid.Parse(jwt.Claims.First(c => c.Type == \"mlid\").Value),\n                cp: jwt.Claims.First(c => c.Type == \"cp\").Value,\n                iat: iat,\n                exp: exp\n            );\n        }\n\n        public string BuildUrl(FlowClickPayload p)\n        {\n            var token = Create(p);\n            return $\"{_opt.BaseUrl.TrimEnd('/')}/r/flow/{token}\";\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Infrastructure/Json/JsonCtx.cs",
      "sha256": "7f0c06d894ea9cf97b6d1b536ebd48cf3862fab67c3138e0d91e84f9b3539e0d",
      "language": "csharp",
      "size": 779,
      "content": "using System.Text.Json.Serialization;\nusing xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Meta;\nusing xbytechat.api.Features.CampaignModule.SendEngine.PayloadModels.Pinnacle;\n\nnamespace xbytechat.api.Infrastructure.Json\n{\n    [JsonSourceGenerationOptions(\n        WriteIndented = false,\n        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull)]\n    [JsonSerializable(typeof(MetaTemplateMessage))]\n    [JsonSerializable(typeof(PinnacleTemplateMessage))]\n    // Ensure the generator knows about the polymorphic bases\n    [JsonSerializable(typeof(System.Collections.Generic.List<MetaComponentBase>))]\n    [JsonSerializable(typeof(System.Collections.Generic.List<PinnacleComponentBase>))]\n\n    public partial class JsonCtx : JsonSerializerContext { }\n}\n"
    },
    {
      "path": "xbytechat-api/Infrastructure/Observability/MetricsRegistry.cs",
      "sha256": "2cecd0e2963747c522622fa3aa8afe8f9e3afce029eb264c9870aa006ba39612",
      "language": "csharp",
      "size": 2835,
      "content": "using System.Diagnostics.Metrics;\nusing Microsoft.Extensions.Configuration;\n\nnamespace xbytechat.api.Infrastructure.Observability\n{\n    /// <summary>\n    /// Central metrics facade with a hard OFF switch.\n    /// When Observability:Metrics:Enabled=false, all calls no-op.\n    /// </summary>\n    public static class MetricsRegistry\n    {\n        private static bool _enabled;\n        private static Meter? _meter;\n        private static long _queueDepth;\n\n        // Proxies let existing call sites stay unchanged.\n        public static readonly CounterProxy MessagesSent = new();\n        public static readonly CounterProxy MessagesFailed = new();\n        public static readonly CounterProxy RateLimited429s = new();\n        public static readonly HistProxy SendLatencyMs = new();\n\n        /// <summary>Call once at startup from Program.cs.</summary>\n        public static void Configure(IConfiguration cfg)\n        {\n            _enabled = cfg.GetValue<bool>(\"Observability:Metrics:Enabled\", false);\n\n            if (!_enabled)\n            {\n                _meter = null; // proxies remain unbound => no-ops\n                return;\n            }\n\n            _meter = new Meter(\"xbytechat.api\", \"1.0.0\");\n\n            // Bind proxies to actual instruments\n            MessagesSent.Bind(_meter.CreateCounter<long>(\"campaign_messages_sent\", unit: \"msg\",\n                description: \"Accepted by provider\"));\n            MessagesFailed.Bind(_meter.CreateCounter<long>(\"campaign_messages_failed\", unit: \"msg\",\n                description: \"Failed sends\"));\n            RateLimited429s.Bind(_meter.CreateCounter<long>(\"campaign_http_429\", unit: \"hit\",\n                description: \"HTTP 429 responses\"));\n            SendLatencyMs.Bind(_meter.CreateHistogram<double>(\"campaign_send_latency_ms\", unit: \"ms\",\n                description: \"Provider send latency\"));\n\n            _meter.CreateObservableGauge(\"campaign_queue_depth\",\n                () => new Measurement<long>(_queueDepth),\n                unit: \"jobs\",\n                description: \"Outbound campaign jobs waiting in this process\");\n        }\n\n        public static void ReportQueueDepth(long depth)\n        {\n            if (_enabled) _queueDepth = depth;\n        }\n\n        // ---------- Proxies (no-ops when not bound / disabled) ----------\n\n        public sealed class CounterProxy\n        {\n            private Counter<long>? _inner;\n            internal void Bind(Counter<long> inner) => _inner = inner;\n            public void Add(long value) { if (_enabled) _inner?.Add(value); }\n        }\n\n        public sealed class HistProxy\n        {\n            private Histogram<double>? _inner;\n            internal void Bind(Histogram<double> inner) => _inner = inner;\n            public void Record(double value) { if (_enabled) _inner?.Record(value); }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Infrastructure/RateLimiting/PhoneNumberRateLimiter.cs",
      "sha256": "4d1af7bc0ea2e6b6497801cf8749cb1ab4f00fe2a6c85cf8935cb31758552bea",
      "language": "csharp",
      "size": 1851,
      "content": "using System.Collections.Concurrent;\nusing System.Threading.RateLimiting;\n\nnamespace xbytechat.api.Infrastructure.RateLimiting\n{\n    /// <summary>\n    /// Token-bucket limiter per senderKey (Provider|PhoneNumberId).\n    /// Default: 10 req/s with burst 10. You can tune dynamically.\n    /// </summary>\n    public interface IPhoneNumberRateLimiter\n    {\n        ValueTask<RateLimitLease> AcquireAsync(string senderKey, CancellationToken ct);\n        void UpdateLimits(string senderKey, int permitsPerSecond, int burst);\n    }\n\n    public sealed class PhoneNumberRateLimiter : IPhoneNumberRateLimiter\n    {\n        private readonly ConcurrentDictionary<string, TokenBucketRateLimiter> _buckets = new();\n\n        public ValueTask<RateLimitLease> AcquireAsync(string senderKey, CancellationToken ct)\n        {\n            var limiter = _buckets.GetOrAdd(senderKey, _ => Create(permitsPerSecond: 10, burst: 10));\n            return limiter.AcquireAsync(1, ct);\n        }\n\n        public void UpdateLimits(string senderKey, int permitsPerSecond, int burst)\n        {\n            _buckets.AddOrUpdate(senderKey,\n                _ => Create(permitsPerSecond, burst),\n                (_, __) => Create(permitsPerSecond, burst));\n        }\n\n        private static TokenBucketRateLimiter Create(int permitsPerSecond, int burst)\n        {\n            return new TokenBucketRateLimiter(new TokenBucketRateLimiterOptions\n            {\n                TokenLimit = Math.Max(1, burst),\n                TokensPerPeriod = Math.Max(1, permitsPerSecond),\n                ReplenishmentPeriod = TimeSpan.FromSeconds(1),   // â† correct property name\n                QueueProcessingOrder = QueueProcessingOrder.OldestFirst,\n                QueueLimit = 0                                    // no internal queue; your outbox already queues\n            });\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Infrastructure/Schema/SchemaPatchRunner.cs",
      "sha256": "579a0edb4a3292723951ebd710cd840415059aa16baf789ee313a26cb9c3af26",
      "language": "csharp",
      "size": 3388,
      "content": "using System;\nusing System.Data;\nusing System.IO;\nusing System.Threading.Tasks;\nusing Microsoft.EntityFrameworkCore;\n\nnamespace xbytechat.api.Infrastructure.Schema\n{\n    public static class SchemaPatchRunner\n    {\n        /// <summary>\n        /// Ensures a patch is applied exactly once. Creates the tracking table if needed.\n        /// </summary>\n        /// <param name=\"db\">AppDbContext</param>\n        /// <param name=\"patchId\">A unique string, e.g. \"20251003_campaign_cascade\"</param>\n        /// <param name=\"absoluteSqlPath\">Absolute path to the .sql file</param>\n        public static async Task EnsurePatchAsync(DbContext db, string patchId, string absoluteSqlPath)\n        {\n            if (!File.Exists(absoluteSqlPath))\n                throw new FileNotFoundException($\"Schema patch not found: {absoluteSqlPath}\");\n\n            var conn = db.Database.GetDbConnection();\n            await conn.OpenAsync();\n\n            await using var tx = await conn.BeginTransactionAsync();\n\n            try\n            {\n                // 1) Create tracking table if not exists\n                await using (var cmd = conn.CreateCommand())\n                {\n                    cmd.Transaction = tx;\n                    cmd.CommandText = @\"\nCREATE TABLE IF NOT EXISTS __schema_patches (\n    patch_id   text PRIMARY KEY,\n    applied_at timestamp with time zone NOT NULL DEFAULT now()\n);\";\n                    await cmd.ExecuteNonQueryAsync();\n                }\n\n                // 2) Check if already applied\n                bool alreadyApplied;\n                await using (var check = conn.CreateCommand())\n                {\n                    check.Transaction = tx;\n                    check.CommandText = \"SELECT 1 FROM __schema_patches WHERE patch_id = @p LIMIT 1;\";\n                    var p = check.CreateParameter();\n                    p.ParameterName = \"@p\";\n                    p.Value = patchId;\n                    check.Parameters.Add(p);\n\n                    await using var reader = await check.ExecuteReaderAsync();\n                    alreadyApplied = await reader.ReadAsync();\n                }\n\n                if (!alreadyApplied)\n                {\n                    // 3) Run SQL file\n                    var sql = await File.ReadAllTextAsync(absoluteSqlPath);\n\n                    await using (var exec = conn.CreateCommand())\n                    {\n                        exec.Transaction = tx;\n                        exec.CommandText = sql;\n                        await exec.ExecuteNonQueryAsync();\n                    }\n\n                    // 4) Record success\n                    await using (var ins = conn.CreateCommand())\n                    {\n                        ins.Transaction = tx;\n                        ins.CommandText = \"INSERT INTO __schema_patches (patch_id) VALUES (@p);\";\n                        var p = ins.CreateParameter();\n                        p.ParameterName = \"@p\";\n                        p.Value = patchId;\n                        ins.Parameters.Add(p);\n                        await ins.ExecuteNonQueryAsync();\n                    }\n                }\n\n                await tx.CommitAsync();\n            }\n            catch\n            {\n                await tx.RollbackAsync();\n                throw;\n            }\n            finally\n            {\n                await conn.CloseAsync();\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Middlewares/GlobalExceptionMiddleware.cs",
      "sha256": "382502b5d584e52221c27934aadd277ed3ee9bbf11af5d77dc5c7394d36fcd26",
      "language": "csharp",
      "size": 3499,
      "content": "using System.Net;\nusing Serilog;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.Extensions.Logging;\nusing Microsoft.AspNetCore.Hosting;\n\npublic class GlobalExceptionMiddleware\n{\n    private readonly RequestDelegate _next;\n    private readonly ILogger<GlobalExceptionMiddleware> _logger;\n    private readonly IWebHostEnvironment _env;\n\n    public GlobalExceptionMiddleware(RequestDelegate next, ILogger<GlobalExceptionMiddleware> logger, IWebHostEnvironment env)\n    {\n        _next = next;\n        _logger = logger;\n        _env = env;\n    }\n    public class ErrorResponse\n    {\n        public int StatusCode { get; set; }\n        public string? Message { get; set; }\n        public string? StackTrace { get; set; }\n        public string? Path { get; set; }\n    }\n\n    public async Task Invoke(HttpContext context)\n    {\n        try\n        {\n            await _next(context);\n        }\n        catch (Exception ex)\n        {\n            Log.Error(ex, \"âŒ An unhandled exception occurred\");\n\n            // ðŸš© Prevent double-write/headers-already-sent error!\n            if (context.Response.HasStarted)\n            {\n                _logger.LogError(\"Response has already started, unable to write error response for path: {Path}\", context.Request.Path);\n                return;\n            }\n\n            context.Response.ContentType = \"application/json\";\n            context.Response.StatusCode = (int)HttpStatusCode.InternalServerError;\n\n            var response = new ErrorResponse\n            {\n                StatusCode = context.Response.StatusCode,\n                Message = ex.Message,\n                StackTrace = _env.IsDevelopment() ? ex.StackTrace : null,\n                Path = context.Request.Path\n            };\n            await context.Response.WriteAsJsonAsync(response);\n        }\n    }\n}\n\n\n//using System.Net;\n//using Serilog;\n//using System.Net;\n//using System.Threading.Tasks;\n//using Microsoft.AspNetCore.Http;\n//using Microsoft.Extensions.Logging;\n//using Microsoft.AspNetCore.Hosting;\n\n//public class GlobalExceptionMiddleware\n//{\n//    private readonly RequestDelegate _next;\n//    private readonly ILogger<GlobalExceptionMiddleware> _logger;\n//    private readonly IWebHostEnvironment _env;\n\n//    public GlobalExceptionMiddleware(RequestDelegate next, ILogger<GlobalExceptionMiddleware> logger, IWebHostEnvironment env)\n//    {\n//        _next = next;\n//        _logger = logger;\n//        _env = env;\n//    }\n//    public class ErrorResponse\n//    {\n//        public int StatusCode { get; set; }\n//        public string Message { get; set; }\n//        public string? StackTrace { get; set; }\n//        public string Path { get; set; }\n//    }\n\n//    public async Task Invoke(HttpContext context)\n//    {\n//        try\n//        {\n//            await _next(context);\n//        }\n//        catch (Exception ex)\n//        {\n//            Log.Error(ex, \"âŒ An unhandled exception occurred\");\n\n//            context.Response.ContentType = \"application/json\";\n//            context.Response.StatusCode = (int)HttpStatusCode.InternalServerError;\n\n//            var response = new ErrorResponse\n//            {\n//                StatusCode = context.Response.StatusCode,\n//                Message = ex.Message,\n//                StackTrace = _env.IsDevelopment() ? ex.StackTrace : null,\n//                Path = context.Request.Path\n//            };\n//            await context.Response.WriteAsJsonAsync(response);\n//        }\n//    }\n\n//}\n"
    },
    {
      "path": "xbytechat-api/Middlewares/JwtErrorHandlingMiddleware.cs",
      "sha256": "d35104606ec5c8b08c106f2499d4962349d1c9c99465f0772fe1a92366cdcfac",
      "language": "csharp",
      "size": 2000,
      "content": "using Microsoft.AspNetCore.Http;\nusing System.Net;\nusing System.Text.Json;\nusing Microsoft.IdentityModel.Tokens;\n\nnamespace xbytechat.api.Middlewares\n{\n    public class JwtErrorHandlingMiddleware\n    {\n        private readonly RequestDelegate _next;\n\n        public JwtErrorHandlingMiddleware(RequestDelegate next)\n        {\n            _next = next;\n        }\n\n        public async Task Invoke(HttpContext context)\n        {\n            try\n            {\n                await _next(context); // Proceed to next middleware\n            }\n            catch (SecurityTokenExpiredException)\n            {\n                context.Response.StatusCode = (int)HttpStatusCode.Unauthorized;\n                context.Response.ContentType = \"application/json\";\n\n                var response = new\n                {\n                    success = false,\n                    message = \"âŒ Token expired. Please login again.\"\n                };\n\n                await context.Response.WriteAsync(JsonSerializer.Serialize(response));\n            }\n            catch (SecurityTokenException ex)\n            {\n                context.Response.StatusCode = (int)HttpStatusCode.Unauthorized;\n                context.Response.ContentType = \"application/json\";\n\n                var response = new\n                {\n                    success = false,\n                    message = $\"âŒ Token invalid: {ex.Message}\"\n                };\n\n                await context.Response.WriteAsync(JsonSerializer.Serialize(response));\n            }\n            catch (Exception)\n            {\n                // Pass unhandled exceptions to global exception middleware\n                throw;\n            }\n        }\n    }\n\n    // Extension method for clean registration\n    public static class JwtErrorHandlingMiddlewareExtensions\n    {\n        public static IApplicationBuilder UseJwtErrorHandling(this IApplicationBuilder builder)\n        {\n            return builder.UseMiddleware<JwtErrorHandlingMiddleware>();\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Middlewares/RequirePermissionAttribute.cs",
      "sha256": "a6d3aaceba78295b73d29b3f7b0c72837f08e7f8cb0004a15f1f77f1066dc3c2",
      "language": "csharp",
      "size": 1156,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing System;\nusing System.Linq;\nusing System.Security.Claims;\n\nnamespace xbytechat.api.Middleware.Attributes\n{\n    [AttributeUsage(AttributeTargets.Method | AttributeTargets.Class, AllowMultiple = true)]\n    public class RequirePermissionAttribute : Attribute, IAuthorizationFilter\n    {\n        private readonly string _requiredPermission;\n\n        public RequirePermissionAttribute(string requiredPermission)\n        {\n            _requiredPermission = requiredPermission;\n        }\n\n        public void OnAuthorization(AuthorizationFilterContext context)\n        {\n            var user = context.HttpContext.User;\n\n            if (!user.Identity.IsAuthenticated)\n            {\n                context.Result = new UnauthorizedResult();\n                return;\n            }\n\n            var permissionsClaim = user.Claims.FirstOrDefault(c => c.Type == \"permissions\")?.Value;\n\n            if (permissionsClaim == null || !permissionsClaim.Split(',').Contains(_requiredPermission))\n            {\n                context.Result = new ForbidResult();\n            }\n        }\n    }\n}\n\n"
    },
    {
      "path": "xbytechat-api/Middlewares/RequirePlanAttribute.cs",
      "sha256": "3e7d8fc23618708b9d4ae5351012eb53f013b2ab0f579426c3d4c9091ed06251",
      "language": "csharp",
      "size": 887,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing System;\nusing System.Linq;\n\nnamespace xbytechat.api.Middlewares\n{\n    [AttributeUsage(AttributeTargets.Method | AttributeTargets.Class, AllowMultiple = true)]\n    public class RequirePlanAttribute : Attribute, IAuthorizationFilter\n    {\n        private readonly string[] _allowedPlans;\n\n        public RequirePlanAttribute(params string[] allowedPlans)\n        {\n            _allowedPlans = allowedPlans;\n        }\n\n        public void OnAuthorization(AuthorizationFilterContext context)\n        {\n            var plan = context.HttpContext.User.FindFirst(\"plan\")?.Value?.ToLowerInvariant();\n            if (string.IsNullOrEmpty(plan) || !_allowedPlans.Any(p => p.ToLowerInvariant() == plan))\n            {\n                context.Result = new ForbidResult(); // 403 Forbidden\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Middlewares/RequireRoleAttribute.cs",
      "sha256": "b8ca70695e176a36191713cb6b179e1f5097d9077227a77b8658f86392b98b6b",
      "language": "csharp",
      "size": 852,
      "content": "using Microsoft.AspNetCore.Mvc;\nusing Microsoft.AspNetCore.Mvc.Filters;\nusing System;\nusing System.Linq;\n\nnamespace xbytechat.api.Middlewares\n{\n    [AttributeUsage(AttributeTargets.Method | AttributeTargets.Class, AllowMultiple = true)]\n    public class RequireRoleAttribute : Attribute, IAuthorizationFilter\n    {\n        private readonly string[] _roles;\n\n        public RequireRoleAttribute(params string[] roles)\n        {\n            _roles = roles;\n        }\n\n        public void OnAuthorization(AuthorizationFilterContext context)\n        {\n            var role = context.HttpContext.User.FindFirst(\"role\")?.Value?.ToLowerInvariant();\n            if (string.IsNullOrEmpty(role) || !_roles.Any(r => r.ToLowerInvariant() == role))\n            {\n                context.Result = new ForbidResult(); // 403 Forbidden\n            }\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Migrations/20250928044553_Initial.cs",
      "sha256": "93ea1eeec9c796d73321d4ff56e39be858c86221627b0a9bb454fc9b8e32328c",
      "language": "csharp",
      "size": 131127,
      "content": "using System;\nusing Microsoft.EntityFrameworkCore.Migrations;\nusing Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;\n\n#nullable disable\n\n#pragma warning disable CA1814 // Prefer jagged arrays over multidimensional\n\nnamespace xbytechat.api.Migrations\n{\n    /// <inheritdoc />\n    public partial class Initial : Migration\n    {\n        /// <inheritdoc />\n        protected override void Up(MigrationBuilder migrationBuilder)\n        {\n            migrationBuilder.CreateTable(\n                name: \"AuditLogs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    PerformedByUserId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    PerformedByUserName = table.Column<string>(type: \"text\", nullable: true),\n                    RoleAtTime = table.Column<string>(type: \"text\", nullable: true),\n                    ActionType = table.Column<string>(type: \"text\", nullable: false),\n                    Description = table.Column<string>(type: \"text\", nullable: true),\n                    IPAddress = table.Column<string>(type: \"text\", nullable: true),\n                    UserAgent = table.Column<string>(type: \"text\", nullable: true),\n                    Location = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_AuditLogs\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"AutomationFlows\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Name = table.Column<string>(type: \"text\", nullable: false),\n                    TriggerKeyword = table.Column<string>(type: \"text\", nullable: false),\n                    NodesJson = table.Column<string>(type: \"text\", nullable: false),\n                    EdgesJson = table.Column<string>(type: \"text\", nullable: false),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_AutomationFlows\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"AutoReplyFlows\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Name = table.Column<string>(type: \"text\", nullable: false),\n                    NodesJson = table.Column<string>(type: \"text\", nullable: false),\n                    EdgesJson = table.Column<string>(type: \"text\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    TriggerKeyword = table.Column<string>(type: \"text\", nullable: true),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    IndustryTag = table.Column<string>(type: \"text\", nullable: true),\n                    UseCase = table.Column<string>(type: \"text\", nullable: true),\n                    IsDefaultTemplate = table.Column<bool>(type: \"boolean\", nullable: false),\n                    Keyword = table.Column<string>(type: \"text\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_AutoReplyFlows\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"AutoReplyLogs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    TriggerKeyword = table.Column<string>(type: \"text\", nullable: false),\n                    TriggerType = table.Column<string>(type: \"text\", nullable: false),\n                    ReplyContent = table.Column<string>(type: \"text\", nullable: false),\n                    FlowName = table.Column<string>(type: \"text\", nullable: true),\n                    MessageLogId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    TriggeredAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_AutoReplyLogs\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CampaignClickDailyAgg\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Day = table.Column<DateTime>(type: \"date\", nullable: false),\n                    ButtonIndex = table.Column<int>(type: \"integer\", nullable: false),\n                    Clicks = table.Column<long>(type: \"bigint\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CampaignClickDailyAgg\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CampaignClickLogs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    RunId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CampaignSendLogId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ButtonIndex = table.Column<int>(type: \"integer\", nullable: false),\n                    ButtonTitle = table.Column<string>(type: \"character varying(120)\", maxLength: 120, nullable: false),\n                    ClickType = table.Column<string>(type: \"character varying(16)\", maxLength: 16, nullable: false),\n                    Destination = table.Column<string>(type: \"character varying(2048)\", maxLength: 2048, nullable: false),\n                    Ip = table.Column<string>(type: \"character varying(64)\", maxLength: 64, nullable: false),\n                    UserAgent = table.Column<string>(type: \"character varying(512)\", maxLength: 512, nullable: false),\n                    ClickedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CampaignClickLogs\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CatalogClickLogs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ProductId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    UserId = table.Column<string>(type: \"text\", nullable: true),\n                    UserName = table.Column<string>(type: \"text\", nullable: true),\n                    UserPhone = table.Column<string>(type: \"text\", nullable: true),\n                    BotId = table.Column<string>(type: \"text\", nullable: true),\n                    CategoryBrowsed = table.Column<string>(type: \"text\", nullable: true),\n                    ProductBrowsed = table.Column<string>(type: \"text\", nullable: true),\n                    CTAJourney = table.Column<string>(type: \"text\", nullable: true),\n                    TemplateId = table.Column<string>(type: \"text\", nullable: false),\n                    RefMessageId = table.Column<string>(type: \"text\", nullable: false),\n                    ButtonText = table.Column<string>(type: \"text\", nullable: false),\n                    ClickedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    CampaignSendLogId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    FollowUpSent = table.Column<bool>(type: \"boolean\", nullable: false),\n                    LastInteractionType = table.Column<string>(type: \"text\", nullable: true),\n                    MessageLogId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    PlanSnapshot = table.Column<string>(type: \"text\", nullable: true),\n                    CtaId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    Source = table.Column<string>(type: \"text\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CatalogClickLogs\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"ChatSessionStates\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Mode = table.Column<string>(type: \"text\", nullable: false),\n                    LastUpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedBy = table.Column<string>(type: \"text\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_ChatSessionStates\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"ContactReads\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    UserId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    LastReadAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_ContactReads\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CTADefinitions\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Title = table.Column<string>(type: \"text\", nullable: false),\n                    ButtonText = table.Column<string>(type: \"text\", nullable: false),\n                    ButtonType = table.Column<string>(type: \"text\", nullable: false),\n                    TargetUrl = table.Column<string>(type: \"text\", nullable: false),\n                    Description = table.Column<string>(type: \"text\", nullable: false),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CTADefinitions\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CTAFlowConfigs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    FlowName = table.Column<string>(type: \"character varying(100)\", maxLength: 100, nullable: false),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    IsPublished = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    CreatedBy = table.Column<string>(type: \"text\", nullable: true),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CTAFlowConfigs\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"FailedWebhookLogs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ErrorMessage = table.Column<string>(type: \"text\", nullable: true),\n                    SourceModule = table.Column<string>(type: \"text\", nullable: true),\n                    FailureType = table.Column<string>(type: \"text\", nullable: true),\n                    RawJson = table.Column<string>(type: \"text\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_FailedWebhookLogs\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"FeatureAccess\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    FeatureName = table.Column<string>(type: \"character varying(50)\", maxLength: 50, nullable: false),\n                    Description = table.Column<string>(type: \"character varying(200)\", maxLength: 200, nullable: false),\n                    IsEnabled = table.Column<bool>(type: \"boolean\", nullable: false),\n                    Notes = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    Group = table.Column<string>(type: \"character varying(50)\", maxLength: 50, nullable: false),\n                    Plan = table.Column<string>(type: \"text\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_FeatureAccess\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"FeatureMaster\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    FeatureCode = table.Column<string>(type: \"character varying(100)\", maxLength: 100, nullable: false),\n                    DisplayName = table.Column<string>(type: \"character varying(100)\", maxLength: 100, nullable: false),\n                    Description = table.Column<string>(type: \"character varying(250)\", maxLength: 250, nullable: false),\n                    Group = table.Column<string>(type: \"character varying(50)\", maxLength: 50, nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_FeatureMaster\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"FlowExecutionLogs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    RunId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    StepId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    StepName = table.Column<string>(type: \"text\", nullable: false),\n                    FlowId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CampaignSendLogId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    TrackingLogId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ContactPhone = table.Column<string>(type: \"text\", nullable: true),\n                    TriggeredByButton = table.Column<string>(type: \"text\", nullable: true),\n                    TemplateName = table.Column<string>(type: \"text\", nullable: true),\n                    TemplateType = table.Column<string>(type: \"text\", nullable: true),\n                    Success = table.Column<bool>(type: \"boolean\", nullable: false),\n                    ErrorMessage = table.Column<string>(type: \"text\", nullable: true),\n                    RawResponse = table.Column<string>(type: \"text\", nullable: true),\n                    ExecutedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    MessageLogId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ButtonIndex = table.Column<short>(type: \"smallint\", nullable: true),\n                    RequestId = table.Column<Guid>(type: \"uuid\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_FlowExecutionLogs\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Notes\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    Title = table.Column<string>(type: \"text\", nullable: false),\n                    Content = table.Column<string>(type: \"text\", nullable: false),\n                    Source = table.Column<string>(type: \"text\", nullable: false),\n                    CreatedBy = table.Column<string>(type: \"text\", nullable: false),\n                    IsPinned = table.Column<bool>(type: \"boolean\", nullable: false),\n                    IsInternal = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    EditedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Notes\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"OutboundCampaignJobs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Status = table.Column<string>(type: \"character varying(32)\", maxLength: 32, nullable: false),\n                    Attempt = table.Column<int>(type: \"integer\", nullable: false),\n                    MaxAttempts = table.Column<int>(type: \"integer\", nullable: false),\n                    NextAttemptAt = table.Column<DateTimeOffset>(type: \"timestamp with time zone\", nullable: false),\n                    LastError = table.Column<string>(type: \"character varying(4000)\", maxLength: 4000, nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_OutboundCampaignJobs\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Permissions\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Code = table.Column<string>(type: \"text\", nullable: false),\n                    Name = table.Column<string>(type: \"text\", nullable: false),\n                    Group = table.Column<string>(type: \"text\", nullable: true),\n                    Description = table.Column<string>(type: \"text\", nullable: true),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Permissions\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"PlanFeatureMatrix\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    PlanName = table.Column<string>(type: \"character varying(20)\", maxLength: 20, nullable: false),\n                    FeatureName = table.Column<string>(type: \"character varying(50)\", maxLength: 50, nullable: false),\n                    IsEnabled = table.Column<bool>(type: \"boolean\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_PlanFeatureMatrix\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Plans\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Code = table.Column<string>(type: \"text\", nullable: false),\n                    Name = table.Column<string>(type: \"text\", nullable: false),\n                    Description = table.Column<string>(type: \"text\", nullable: true),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Plans\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Products\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Name = table.Column<string>(type: \"text\", nullable: false),\n                    Description = table.Column<string>(type: \"text\", nullable: false),\n                    Price = table.Column<decimal>(type: \"numeric\", nullable: false),\n                    Currency = table.Column<string>(type: \"text\", nullable: false),\n                    ImageUrl = table.Column<string>(type: \"text\", nullable: false),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    TotalClicks = table.Column<int>(type: \"integer\", nullable: false),\n                    LastClickedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    MostClickedCTA = table.Column<string>(type: \"text\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Products\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"ProviderBillingEvents\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    MessageLogId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    Provider = table.Column<string>(type: \"text\", nullable: false),\n                    EventType = table.Column<string>(type: \"text\", nullable: false),\n                    ProviderMessageId = table.Column<string>(type: \"text\", nullable: true),\n                    ConversationId = table.Column<string>(type: \"text\", nullable: true),\n                    ConversationCategory = table.Column<string>(type: \"text\", nullable: true),\n                    IsChargeable = table.Column<bool>(type: \"boolean\", nullable: true),\n                    PriceAmount = table.Column<decimal>(type: \"numeric\", nullable: true),\n                    PriceCurrency = table.Column<string>(type: \"text\", nullable: true),\n                    PayloadJson = table.Column<string>(type: \"text\", nullable: false),\n                    OccurredAt = table.Column<DateTimeOffset>(type: \"timestamp with time zone\", nullable: false),\n                    CreatedAt = table.Column<DateTimeOffset>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_ProviderBillingEvents\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"QuickReplies\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    OwnerUserId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    Title = table.Column<string>(type: \"character varying(120)\", maxLength: 120, nullable: false),\n                    Body = table.Column<string>(type: \"text\", nullable: false),\n                    TagsCsv = table.Column<string>(type: \"character varying(240)\", maxLength: 240, nullable: true),\n                    Language = table.Column<string>(type: \"character varying(8)\", maxLength: 8, nullable: true),\n                    Scope = table.Column<int>(type: \"integer\", nullable: false),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    IsDeleted = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false, defaultValueSql: \"NOW()\"),\n                    CreatedBy = table.Column<string>(type: \"text\", nullable: true),\n                    UpdatedBy = table.Column<string>(type: \"text\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_QuickReplies\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Reminders\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Title = table.Column<string>(type: \"text\", nullable: false),\n                    Description = table.Column<string>(type: \"text\", nullable: true),\n                    DueAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    Status = table.Column<string>(type: \"text\", nullable: false),\n                    ReminderType = table.Column<string>(type: \"text\", nullable: true),\n                    Priority = table.Column<int>(type: \"integer\", nullable: true),\n                    IsRecurring = table.Column<bool>(type: \"boolean\", nullable: false),\n                    RecurrencePattern = table.Column<string>(type: \"text\", nullable: true),\n                    SendWhatsappNotification = table.Column<bool>(type: \"boolean\", nullable: false),\n                    LinkedCampaign = table.Column<string>(type: \"text\", nullable: true),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    CompletedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    LastCTAType = table.Column<string>(type: \"text\", nullable: true),\n                    LastClickedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    FollowUpSent = table.Column<bool>(type: \"boolean\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Reminders\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Roles\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Name = table.Column<string>(type: \"text\", nullable: false),\n                    Description = table.Column<string>(type: \"text\", nullable: true),\n                    IsSystemDefined = table.Column<bool>(type: \"boolean\", nullable: false),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Roles\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Tags\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Name = table.Column<string>(type: \"text\", nullable: false),\n                    ColorHex = table.Column<string>(type: \"text\", nullable: true),\n                    Category = table.Column<string>(type: \"text\", nullable: true),\n                    Notes = table.Column<string>(type: \"text\", nullable: true),\n                    IsSystemTag = table.Column<bool>(type: \"boolean\", nullable: false),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    LastUsedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Tags\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"UserFeatureAccess\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    UserId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    FeatureName = table.Column<string>(type: \"character varying(50)\", maxLength: 50, nullable: false),\n                    IsEnabled = table.Column<bool>(type: \"boolean\", nullable: false),\n                    Notes = table.Column<string>(type: \"text\", nullable: true),\n                    ModifiedByUserId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_UserFeatureAccess\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"WebhookSettings\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    AutoCleanupEnabled = table.Column<bool>(type: \"boolean\", nullable: false),\n                    LastCleanupAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_WebhookSettings\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"WhatsAppTemplates\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Provider = table.Column<string>(type: \"character varying(40)\", maxLength: 40, nullable: false),\n                    ExternalId = table.Column<string>(type: \"character varying(120)\", maxLength: 120, nullable: true),\n                    Name = table.Column<string>(type: \"character varying(160)\", maxLength: 160, nullable: false),\n                    Language = table.Column<string>(type: \"character varying(16)\", maxLength: 16, nullable: false),\n                    Status = table.Column<string>(type: \"character varying(32)\", maxLength: 32, nullable: false),\n                    Category = table.Column<string>(type: \"character varying(40)\", maxLength: 40, nullable: true),\n                    Body = table.Column<string>(type: \"text\", nullable: false),\n                    HasImageHeader = table.Column<bool>(type: \"boolean\", nullable: false),\n                    PlaceholderCount = table.Column<int>(type: \"integer\", nullable: false),\n                    ButtonsJson = table.Column<string>(type: \"text\", nullable: false),\n                    RawJson = table.Column<string>(type: \"text\", nullable: false),\n                    LastSyncedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_WhatsAppTemplates\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"AutoReplyFlowEdges\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    FlowId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    SourceNodeId = table.Column<string>(type: \"text\", nullable: false),\n                    TargetNodeId = table.Column<string>(type: \"text\", nullable: false),\n                    SourceHandle = table.Column<string>(type: \"text\", nullable: true),\n                    TargetHandle = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_AutoReplyFlowEdges\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_AutoReplyFlowEdges_AutoReplyFlows_FlowId\",\n                        column: x => x.FlowId,\n                        principalTable: \"AutoReplyFlows\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"AutoReplyFlowNodes\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    FlowId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    NodeType = table.Column<string>(type: \"text\", nullable: false),\n                    Label = table.Column<string>(type: \"text\", nullable: false),\n                    NodeName = table.Column<string>(type: \"text\", nullable: true),\n                    ConfigJson = table.Column<string>(type: \"text\", nullable: false),\n                    Position_X = table.Column<double>(type: \"double precision\", nullable: false),\n                    Position_Y = table.Column<double>(type: \"double precision\", nullable: false),\n                    Order = table.Column<int>(type: \"integer\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_AutoReplyFlowNodes\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_AutoReplyFlowNodes_AutoReplyFlows_FlowId\",\n                        column: x => x.FlowId,\n                        principalTable: \"AutoReplyFlows\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"AutoReplyRules\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    TriggerKeyword = table.Column<string>(type: \"text\", nullable: false),\n                    ReplyMessage = table.Column<string>(type: \"text\", nullable: false),\n                    MediaUrl = table.Column<string>(type: \"text\", nullable: true),\n                    Priority = table.Column<int>(type: \"integer\", nullable: false),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    FlowName = table.Column<string>(type: \"text\", nullable: true),\n                    FlowId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    IndustryTag = table.Column<string>(type: \"text\", nullable: true),\n                    SourceChannel = table.Column<string>(type: \"text\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_AutoReplyRules\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_AutoReplyRules_AutoReplyFlows_FlowId\",\n                        column: x => x.FlowId,\n                        principalTable: \"AutoReplyFlows\",\n                        principalColumn: \"Id\");\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CTAFlowSteps\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    CTAFlowConfigId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    TriggerButtonText = table.Column<string>(type: \"text\", nullable: false),\n                    TriggerButtonType = table.Column<string>(type: \"text\", nullable: false),\n                    TemplateToSend = table.Column<string>(type: \"text\", nullable: false),\n                    StepOrder = table.Column<int>(type: \"integer\", nullable: false),\n                    RequiredTag = table.Column<string>(type: \"text\", nullable: true),\n                    RequiredSource = table.Column<string>(type: \"text\", nullable: true),\n                    PositionX = table.Column<float>(type: \"real\", nullable: true),\n                    PositionY = table.Column<float>(type: \"real\", nullable: true),\n                    TemplateType = table.Column<string>(type: \"text\", nullable: true),\n                    UseProfileName = table.Column<bool>(type: \"boolean\", nullable: false),\n                    ProfileNameSlot = table.Column<int>(type: \"integer\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CTAFlowSteps\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_CTAFlowSteps_CTAFlowConfigs_CTAFlowConfigId\",\n                        column: x => x.CTAFlowConfigId,\n                        principalTable: \"CTAFlowConfigs\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Businesses\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    CompanyName = table.Column<string>(type: \"text\", nullable: true),\n                    BusinessName = table.Column<string>(type: \"text\", nullable: false),\n                    BusinessEmail = table.Column<string>(type: \"text\", nullable: false),\n                    RepresentativeName = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedByPartnerId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    Phone = table.Column<string>(type: \"text\", nullable: true),\n                    CompanyPhone = table.Column<string>(type: \"text\", nullable: true),\n                    Website = table.Column<string>(type: \"text\", nullable: true),\n                    Address = table.Column<string>(type: \"text\", nullable: true),\n                    Industry = table.Column<string>(type: \"text\", nullable: true),\n                    LogoUrl = table.Column<string>(type: \"text\", nullable: true),\n                    Status = table.Column<int>(type: \"integer\", nullable: false),\n                    Tags = table.Column<string>(type: \"text\", nullable: true),\n                    Source = table.Column<string>(type: \"text\", nullable: true),\n                    Notes = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    CreatedBy = table.Column<string>(type: \"text\", nullable: true),\n                    IsApproved = table.Column<bool>(type: \"boolean\", nullable: false),\n                    ApprovedBy = table.Column<string>(type: \"text\", nullable: true),\n                    ApprovedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    LastLoginAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    IsDeleted = table.Column<bool>(type: \"boolean\", nullable: false),\n                    DeletedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    DeletedBy = table.Column<string>(type: \"text\", nullable: true),\n                    PlanId = table.Column<Guid>(type: \"uuid\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Businesses\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_Businesses_Plans_PlanId\",\n                        column: x => x.PlanId,\n                        principalTable: \"Plans\",\n                        principalColumn: \"Id\");\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"PlanPermissions\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    PlanId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    PermissionId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    AssignedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    AssignedBy = table.Column<string>(type: \"text\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_PlanPermissions\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_PlanPermissions_Permissions_PermissionId\",\n                        column: x => x.PermissionId,\n                        principalTable: \"Permissions\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                    table.ForeignKey(\n                        name: \"FK_PlanPermissions_Plans_PlanId\",\n                        column: x => x.PlanId,\n                        principalTable: \"Plans\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"RolePermissions\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    RoleId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    PermissionId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    AssignedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    AssignedBy = table.Column<string>(type: \"text\", nullable: true),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    IsRevoked = table.Column<bool>(type: \"boolean\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_RolePermissions\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_RolePermissions_Permissions_PermissionId\",\n                        column: x => x.PermissionId,\n                        principalTable: \"Permissions\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                    table.ForeignKey(\n                        name: \"FK_RolePermissions_Roles_RoleId\",\n                        column: x => x.RoleId,\n                        principalTable: \"Roles\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"FlowButtonLinks\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ButtonText = table.Column<string>(type: \"text\", nullable: false),\n                    NextStepId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ButtonType = table.Column<string>(type: \"text\", nullable: false),\n                    ButtonSubType = table.Column<string>(type: \"text\", nullable: false),\n                    ButtonValue = table.Column<string>(type: \"text\", nullable: false),\n                    CTAFlowStepId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ButtonIndex = table.Column<short>(type: \"smallint\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_FlowButtonLinks\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_FlowButtonLinks_CTAFlowSteps_CTAFlowStepId\",\n                        column: x => x.CTAFlowStepId,\n                        principalTable: \"CTAFlowSteps\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"BusinessPlanInfos\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Plan = table.Column<int>(type: \"integer\", nullable: false),\n                    TotalMonthlyQuota = table.Column<int>(type: \"integer\", nullable: false),\n                    RemainingMessages = table.Column<int>(type: \"integer\", nullable: false),\n                    QuotaResetDate = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    WalletBalance = table.Column<decimal>(type: \"numeric\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_BusinessPlanInfos\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_BusinessPlanInfos_Businesses_BusinessId\",\n                        column: x => x.BusinessId,\n                        principalTable: \"Businesses\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Campaigns\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    SourceCampaignId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    Name = table.Column<string>(type: \"text\", nullable: false),\n                    MessageTemplate = table.Column<string>(type: \"text\", nullable: false),\n                    TemplateId = table.Column<string>(type: \"text\", nullable: true),\n                    MessageBody = table.Column<string>(type: \"text\", nullable: true),\n                    FollowUpTemplateId = table.Column<string>(type: \"text\", nullable: true),\n                    CampaignType = table.Column<string>(type: \"text\", nullable: true),\n                    CtaId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CTAFlowConfigId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ScheduledAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    Status = table.Column<string>(type: \"text\", nullable: false),\n                    CreatedBy = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    IsDeleted = table.Column<bool>(type: \"boolean\", nullable: false),\n                    DeletedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    DeletedBy = table.Column<string>(type: \"text\", nullable: true),\n                    ImageUrl = table.Column<string>(type: \"text\", nullable: true),\n                    ImageCaption = table.Column<string>(type: \"text\", nullable: true),\n                    TemplateParameters = table.Column<string>(type: \"text\", nullable: true),\n                    Provider = table.Column<string>(type: \"text\", nullable: true),\n                    PhoneNumberId = table.Column<string>(type: \"text\", nullable: true),\n                    TemplateSchemaSnapshot = table.Column<string>(type: \"jsonb\", nullable: true),\n                    AudienceId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    VideoUrl = table.Column<string>(type: \"text\", nullable: true),\n                    DocumentUrl = table.Column<string>(type: \"text\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Campaigns\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_Campaigns_Businesses_BusinessId\",\n                        column: x => x.BusinessId,\n                        principalTable: \"Businesses\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                    table.ForeignKey(\n                        name: \"FK_Campaigns_CTADefinitions_CtaId\",\n                        column: x => x.CtaId,\n                        principalTable: \"CTADefinitions\",\n                        principalColumn: \"Id\");\n                    table.ForeignKey(\n                        name: \"FK_Campaigns_CTAFlowConfigs_CTAFlowConfigId\",\n                        column: x => x.CTAFlowConfigId,\n                        principalTable: \"CTAFlowConfigs\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Restrict);\n                    table.ForeignKey(\n                        name: \"FK_Campaigns_Campaigns_SourceCampaignId\",\n                        column: x => x.SourceCampaignId,\n                        principalTable: \"Campaigns\",\n                        principalColumn: \"Id\");\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Contacts\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Name = table.Column<string>(type: \"character varying(100)\", maxLength: 100, nullable: false),\n                    PhoneNumber = table.Column<string>(type: \"character varying(20)\", maxLength: 20, nullable: false),\n                    Email = table.Column<string>(type: \"character varying(100)\", maxLength: 100, nullable: true),\n                    LeadSource = table.Column<string>(type: \"character varying(50)\", maxLength: 50, nullable: true),\n                    Tags = table.Column<string>(type: \"character varying(200)\", maxLength: 200, nullable: true),\n                    LastContactedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    NextFollowUpAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    Notes = table.Column<string>(type: \"character varying(500)\", maxLength: 500, nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    LastCTAInteraction = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    LastCTAType = table.Column<string>(type: \"text\", nullable: true),\n                    LastClickedProductId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    IsAutomationPaused = table.Column<bool>(type: \"boolean\", nullable: false),\n                    AssignedAgentId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    IsFavorite = table.Column<bool>(type: \"boolean\", nullable: false),\n                    IsArchived = table.Column<bool>(type: \"boolean\", nullable: false),\n                    Group = table.Column<string>(type: \"text\", nullable: true),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    ProfileName = table.Column<string>(type: \"text\", nullable: true),\n                    ProfileNameUpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Contacts\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_Contacts_Businesses_BusinessId\",\n                        column: x => x.BusinessId,\n                        principalTable: \"Businesses\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Users\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    Name = table.Column<string>(type: \"text\", nullable: false),\n                    Email = table.Column<string>(type: \"text\", nullable: false),\n                    PasswordHash = table.Column<string>(type: \"text\", nullable: false),\n                    RoleId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    Status = table.Column<string>(type: \"text\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    IsDeleted = table.Column<bool>(type: \"boolean\", nullable: false),\n                    DeletedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    RefreshToken = table.Column<string>(type: \"text\", nullable: true),\n                    RefreshTokenExpiry = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Users\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_Users_Businesses_BusinessId\",\n                        column: x => x.BusinessId,\n                        principalTable: \"Businesses\",\n                        principalColumn: \"Id\");\n                    table.ForeignKey(\n                        name: \"FK_Users_Roles_RoleId\",\n                        column: x => x.RoleId,\n                        principalTable: \"Roles\",\n                        principalColumn: \"Id\");\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"WhatsAppSettings\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Provider = table.Column<string>(type: \"character varying(50)\", maxLength: 50, nullable: false),\n                    ApiUrl = table.Column<string>(type: \"character varying(500)\", maxLength: 500, nullable: false),\n                    ApiKey = table.Column<string>(type: \"character varying(1000)\", maxLength: 1000, nullable: false),\n                    WhatsAppBusinessNumber = table.Column<string>(type: \"character varying(20)\", maxLength: 20, nullable: true),\n                    PhoneNumberId = table.Column<string>(type: \"text\", nullable: true),\n                    WabaId = table.Column<string>(type: \"text\", nullable: true),\n                    SenderDisplayName = table.Column<string>(type: \"character varying(100)\", maxLength: 100, nullable: true),\n                    WebhookSecret = table.Column<string>(type: \"character varying(200)\", maxLength: 200, nullable: true),\n                    WebhookVerifyToken = table.Column<string>(type: \"character varying(200)\", maxLength: 200, nullable: true),\n                    WebhookCallbackUrl = table.Column<string>(type: \"character varying(1000)\", maxLength: 1000, nullable: true),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_WhatsAppSettings\", x => x.Id);\n                    table.UniqueConstraint(\"AK_WhatsAppSettings_BusinessId_Provider\", x => new { x.BusinessId, x.Provider });\n                    table.ForeignKey(\n                        name: \"FK_WhatsAppSettings_Businesses_BusinessId\",\n                        column: x => x.BusinessId,\n                        principalTable: \"Businesses\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CampaignButtons\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Title = table.Column<string>(type: \"text\", nullable: false),\n                    Type = table.Column<string>(type: \"text\", nullable: false),\n                    Value = table.Column<string>(type: \"text\", nullable: false),\n                    Position = table.Column<int>(type: \"integer\", nullable: false),\n                    IsFromTemplate = table.Column<bool>(type: \"boolean\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CampaignButtons\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_CampaignButtons_Campaigns_CampaignId\",\n                        column: x => x.CampaignId,\n                        principalTable: \"Campaigns\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CampaignFlowOverrides\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    TemplateName = table.Column<string>(type: \"character varying(100)\", maxLength: 100, nullable: false),\n                    ButtonText = table.Column<string>(type: \"character varying(50)\", maxLength: 50, nullable: false),\n                    OverrideNextTemplate = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    CreatedBy = table.Column<string>(type: \"text\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CampaignFlowOverrides\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_CampaignFlowOverrides_Campaigns_CampaignId\",\n                        column: x => x.CampaignId,\n                        principalTable: \"Campaigns\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CampaignVariableMaps\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Component = table.Column<string>(type: \"character varying(64)\", maxLength: 64, nullable: false),\n                    Index = table.Column<int>(type: \"integer\", nullable: false),\n                    SourceType = table.Column<string>(type: \"character varying(32)\", maxLength: 32, nullable: false),\n                    SourceKey = table.Column<string>(type: \"character varying(128)\", maxLength: 128, nullable: true),\n                    StaticValue = table.Column<string>(type: \"text\", nullable: true),\n                    Expression = table.Column<string>(type: \"text\", nullable: true),\n                    DefaultValue = table.Column<string>(type: \"text\", nullable: true),\n                    IsRequired = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    CreatedByUserId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CampaignVariableMaps\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_CampaignVariableMaps_Campaigns_CampaignId\",\n                        column: x => x.CampaignId,\n                        principalTable: \"Campaigns\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"ContactTags\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    TagId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    AssignedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    AssignedBy = table.Column<string>(type: \"text\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_ContactTags\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_ContactTags_Contacts_ContactId\",\n                        column: x => x.ContactId,\n                        principalTable: \"Contacts\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                    table.ForeignKey(\n                        name: \"FK_ContactTags_Tags_TagId\",\n                        column: x => x.TagId,\n                        principalTable: \"Tags\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"LeadTimelines\",\n                columns: table => new\n                {\n                    Id = table.Column<int>(type: \"integer\", nullable: false)\n                        .Annotation(\"Npgsql:ValueGenerationStrategy\", NpgsqlValueGenerationStrategy.IdentityByDefaultColumn),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    EventType = table.Column<string>(type: \"text\", nullable: false),\n                    Description = table.Column<string>(type: \"text\", nullable: false),\n                    Data = table.Column<string>(type: \"text\", nullable: true),\n                    ReferenceId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    IsSystemGenerated = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedBy = table.Column<string>(type: \"text\", nullable: false),\n                    Source = table.Column<string>(type: \"text\", nullable: true),\n                    Category = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    CTAType = table.Column<string>(type: \"text\", nullable: true),\n                    CTASourceType = table.Column<string>(type: \"text\", nullable: true),\n                    CTASourceId = table.Column<Guid>(type: \"uuid\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_LeadTimelines\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_LeadTimelines_Businesses_BusinessId\",\n                        column: x => x.BusinessId,\n                        principalTable: \"Businesses\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                    table.ForeignKey(\n                        name: \"FK_LeadTimelines_Contacts_ContactId\",\n                        column: x => x.ContactId,\n                        principalTable: \"Contacts\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"MessageLogs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    MessageId = table.Column<string>(type: \"text\", nullable: true),\n                    RunId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    RecipientNumber = table.Column<string>(type: \"text\", nullable: false),\n                    MessageContent = table.Column<string>(type: \"text\", nullable: false),\n                    MediaUrl = table.Column<string>(type: \"text\", nullable: true),\n                    Status = table.Column<string>(type: \"text\", nullable: false),\n                    ErrorMessage = table.Column<string>(type: \"text\", nullable: true),\n                    RawResponse = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    SentAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CTAFlowConfigId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CTAFlowStepId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    FlowVersion = table.Column<int>(type: \"integer\", nullable: true),\n                    ButtonBundleJson = table.Column<string>(type: \"text\", nullable: true),\n                    IsIncoming = table.Column<bool>(type: \"boolean\", nullable: false),\n                    RenderedBody = table.Column<string>(type: \"text\", nullable: true),\n                    RefMessageId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    Source = table.Column<string>(type: \"text\", nullable: true),\n                    Provider = table.Column<string>(type: \"text\", nullable: true),\n                    ProviderMessageId = table.Column<string>(type: \"text\", nullable: true),\n                    IsChargeable = table.Column<bool>(type: \"boolean\", nullable: true),\n                    ConversationId = table.Column<string>(type: \"text\", nullable: true),\n                    ConversationCategory = table.Column<string>(type: \"text\", nullable: true),\n                    ConversationStartedAt = table.Column<DateTimeOffset>(type: \"timestamp with time zone\", nullable: true),\n                    PriceAmount = table.Column<decimal>(type: \"numeric\", nullable: true),\n                    PriceCurrency = table.Column<string>(type: \"text\", nullable: true),\n                    MessageTime = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true, computedColumnSql: \"COALESCE(\\\"SentAt\\\", \\\"CreatedAt\\\")\", stored: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_MessageLogs\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_MessageLogs_Businesses_BusinessId\",\n                        column: x => x.BusinessId,\n                        principalTable: \"Businesses\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                    table.ForeignKey(\n                        name: \"FK_MessageLogs_Campaigns_CampaignId\",\n                        column: x => x.CampaignId,\n                        principalTable: \"Campaigns\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Restrict);\n                    table.ForeignKey(\n                        name: \"FK_MessageLogs_Contacts_ContactId\",\n                        column: x => x.ContactId,\n                        principalTable: \"Contacts\",\n                        principalColumn: \"Id\");\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"MessageStatusLogs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    RecipientNumber = table.Column<string>(type: \"text\", nullable: false),\n                    CustomerProfileName = table.Column<string>(type: \"text\", nullable: true),\n                    MessageId = table.Column<string>(type: \"text\", nullable: true),\n                    Status = table.Column<string>(type: \"text\", nullable: false),\n                    MessageType = table.Column<string>(type: \"text\", nullable: false),\n                    TemplateName = table.Column<string>(type: \"text\", nullable: true),\n                    TemplateCategory = table.Column<string>(type: \"text\", nullable: true),\n                    Channel = table.Column<string>(type: \"text\", nullable: false),\n                    IsSessionOpen = table.Column<bool>(type: \"boolean\", nullable: false),\n                    MetaTimestamp = table.Column<long>(type: \"bigint\", nullable: true),\n                    SentAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    DeliveredAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    ReadAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    ErrorMessage = table.Column<string>(type: \"text\", nullable: true),\n                    ErrorCode = table.Column<int>(type: \"integer\", nullable: true),\n                    RawPayload = table.Column<string>(type: \"text\", nullable: true),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    UserId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_MessageStatusLogs\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_MessageStatusLogs_Businesses_BusinessId\",\n                        column: x => x.BusinessId,\n                        principalTable: \"Businesses\",\n                        principalColumn: \"Id\");\n                    table.ForeignKey(\n                        name: \"FK_MessageStatusLogs_Campaigns_CampaignId\",\n                        column: x => x.CampaignId,\n                        principalTable: \"Campaigns\",\n                        principalColumn: \"Id\");\n                    table.ForeignKey(\n                        name: \"FK_MessageStatusLogs_Users_UserId\",\n                        column: x => x.UserId,\n                        principalTable: \"Users\",\n                        principalColumn: \"Id\");\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"UserPermissions\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    UserId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    PermissionId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    IsGranted = table.Column<bool>(type: \"boolean\", nullable: false),\n                    AssignedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    AssignedBy = table.Column<string>(type: \"text\", nullable: true),\n                    IsRevoked = table.Column<bool>(type: \"boolean\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_UserPermissions\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_UserPermissions_Permissions_PermissionId\",\n                        column: x => x.PermissionId,\n                        principalTable: \"Permissions\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                    table.ForeignKey(\n                        name: \"FK_UserPermissions_Users_UserId\",\n                        column: x => x.UserId,\n                        principalTable: \"Users\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"WhatsAppPhoneNumbers\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Provider = table.Column<string>(type: \"character varying(50)\", nullable: false),\n                    PhoneNumberId = table.Column<string>(type: \"text\", nullable: false),\n                    WhatsAppBusinessNumber = table.Column<string>(type: \"text\", nullable: false),\n                    SenderDisplayName = table.Column<string>(type: \"text\", nullable: true),\n                    IsActive = table.Column<bool>(type: \"boolean\", nullable: false),\n                    IsDefault = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_WhatsAppPhoneNumbers\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_WhatsAppPhoneNumbers_WhatsAppSettings_BusinessId_Provider\",\n                        columns: x => new { x.BusinessId, x.Provider },\n                        principalTable: \"WhatsAppSettings\",\n                        principalColumns: new[] { \"BusinessId\", \"Provider\" },\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"AudienceMembers\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    AudienceId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    PhoneRaw = table.Column<string>(type: \"character varying(64)\", maxLength: 64, nullable: true),\n                    PhoneE164 = table.Column<string>(type: \"character varying(32)\", maxLength: 32, nullable: true),\n                    Name = table.Column<string>(type: \"character varying(160)\", maxLength: 160, nullable: true),\n                    Email = table.Column<string>(type: \"character varying(256)\", maxLength: 256, nullable: true),\n                    AttributesJson = table.Column<string>(type: \"jsonb\", nullable: true),\n                    IsTransientContact = table.Column<bool>(type: \"boolean\", nullable: false),\n                    IsDeleted = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    PromotedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    CreatedByUserId = table.Column<Guid>(type: \"uuid\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_AudienceMembers\", x => x.Id);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CampaignRecipients\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    Status = table.Column<string>(type: \"text\", nullable: false),\n                    SentAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    BotId = table.Column<string>(type: \"text\", nullable: true),\n                    MessagePreview = table.Column<string>(type: \"text\", nullable: true),\n                    ClickedCTA = table.Column<string>(type: \"text\", nullable: true),\n                    CategoryBrowsed = table.Column<string>(type: \"text\", nullable: true),\n                    ProductBrowsed = table.Column<string>(type: \"text\", nullable: true),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    IsAutoTagged = table.Column<bool>(type: \"boolean\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    AudienceMemberId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ResolvedParametersJson = table.Column<string>(type: \"jsonb\", nullable: true),\n                    ResolvedButtonUrlsJson = table.Column<string>(type: \"jsonb\", nullable: true),\n                    IdempotencyKey = table.Column<string>(type: \"text\", nullable: true),\n                    MaterializedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CampaignRecipients\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_CampaignRecipients_AudienceMembers_AudienceMemberId\",\n                        column: x => x.AudienceMemberId,\n                        principalTable: \"AudienceMembers\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.SetNull);\n                    table.ForeignKey(\n                        name: \"FK_CampaignRecipients_Businesses_BusinessId\",\n                        column: x => x.BusinessId,\n                        principalTable: \"Businesses\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Restrict);\n                    table.ForeignKey(\n                        name: \"FK_CampaignRecipients_Campaigns_CampaignId\",\n                        column: x => x.CampaignId,\n                        principalTable: \"Campaigns\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                    table.ForeignKey(\n                        name: \"FK_CampaignRecipients_Contacts_ContactId\",\n                        column: x => x.ContactId,\n                        principalTable: \"Contacts\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.SetNull);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CampaignSendLogs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    RunId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    MessageId = table.Column<string>(type: \"text\", nullable: true),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    RecipientId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    MessageBody = table.Column<string>(type: \"text\", nullable: false),\n                    TemplateId = table.Column<string>(type: \"text\", nullable: true),\n                    SendStatus = table.Column<string>(type: \"text\", nullable: true),\n                    ErrorMessage = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    CreatedBy = table.Column<string>(type: \"text\", nullable: true),\n                    SentAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    DeliveredAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    ReadAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    IpAddress = table.Column<string>(type: \"text\", nullable: true),\n                    DeviceInfo = table.Column<string>(type: \"text\", nullable: true),\n                    MacAddress = table.Column<string>(type: \"text\", nullable: true),\n                    SourceChannel = table.Column<string>(type: \"text\", nullable: true),\n                    DeviceType = table.Column<string>(type: \"text\", nullable: true),\n                    Browser = table.Column<string>(type: \"text\", nullable: true),\n                    Country = table.Column<string>(type: \"text\", nullable: true),\n                    City = table.Column<string>(type: \"text\", nullable: true),\n                    IsClicked = table.Column<bool>(type: \"boolean\", nullable: false),\n                    ClickedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    ClickType = table.Column<string>(type: \"text\", nullable: true),\n                    RetryCount = table.Column<int>(type: \"integer\", nullable: false),\n                    LastRetryAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true),\n                    LastRetryStatus = table.Column<string>(type: \"text\", nullable: true),\n                    AllowRetry = table.Column<bool>(type: \"boolean\", nullable: false),\n                    MessageLogId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    CTAFlowConfigId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CTAFlowStepId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ButtonBundleJson = table.Column<string>(type: \"text\", nullable: true),\n                    UserId = table.Column<Guid>(type: \"uuid\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CampaignSendLogs\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_CampaignSendLogs_CampaignRecipients_RecipientId\",\n                        column: x => x.RecipientId,\n                        principalTable: \"CampaignRecipients\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                    table.ForeignKey(\n                        name: \"FK_CampaignSendLogs_Campaigns_CampaignId\",\n                        column: x => x.CampaignId,\n                        principalTable: \"Campaigns\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                    table.ForeignKey(\n                        name: \"FK_CampaignSendLogs_Contacts_ContactId\",\n                        column: x => x.ContactId,\n                        principalTable: \"Contacts\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.SetNull);\n                    table.ForeignKey(\n                        name: \"FK_CampaignSendLogs_MessageLogs_MessageLogId\",\n                        column: x => x.MessageLogId,\n                        principalTable: \"MessageLogs\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Restrict);\n                    table.ForeignKey(\n                        name: \"FK_CampaignSendLogs_Users_UserId\",\n                        column: x => x.UserId,\n                        principalTable: \"Users\",\n                        principalColumn: \"Id\");\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"TrackingLogs\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    ContactId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ContactPhone = table.Column<string>(type: \"text\", nullable: true),\n                    SourceType = table.Column<string>(type: \"text\", nullable: false),\n                    SourceId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CampaignSendLogId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ButtonText = table.Column<string>(type: \"text\", nullable: true),\n                    CTAType = table.Column<string>(type: \"text\", nullable: true),\n                    MessageId = table.Column<string>(type: \"text\", nullable: true),\n                    TemplateId = table.Column<string>(type: \"text\", nullable: true),\n                    MessageLogId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ClickedVia = table.Column<string>(type: \"text\", nullable: true),\n                    Referrer = table.Column<string>(type: \"text\", nullable: true),\n                    ClickedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    IPAddress = table.Column<string>(type: \"text\", nullable: true),\n                    DeviceType = table.Column<string>(type: \"text\", nullable: true),\n                    Browser = table.Column<string>(type: \"text\", nullable: true),\n                    Country = table.Column<string>(type: \"text\", nullable: true),\n                    City = table.Column<string>(type: \"text\", nullable: true),\n                    FollowUpSent = table.Column<bool>(type: \"boolean\", nullable: false),\n                    LastInteractionType = table.Column<string>(type: \"text\", nullable: true),\n                    SessionId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    ThreadId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    StepId = table.Column<Guid>(type: \"uuid\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_TrackingLogs\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_TrackingLogs_CampaignSendLogs_CampaignSendLogId\",\n                        column: x => x.CampaignSendLogId,\n                        principalTable: \"CampaignSendLogs\",\n                        principalColumn: \"Id\");\n                    table.ForeignKey(\n                        name: \"FK_TrackingLogs_Campaigns_CampaignId\",\n                        column: x => x.CampaignId,\n                        principalTable: \"Campaigns\",\n                        principalColumn: \"Id\");\n                    table.ForeignKey(\n                        name: \"FK_TrackingLogs_Contacts_ContactId\",\n                        column: x => x.ContactId,\n                        principalTable: \"Contacts\",\n                        principalColumn: \"Id\");\n                    table.ForeignKey(\n                        name: \"FK_TrackingLogs_MessageLogs_MessageLogId\",\n                        column: x => x.MessageLogId,\n                        principalTable: \"MessageLogs\",\n                        principalColumn: \"Id\");\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"Audiences\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    Name = table.Column<string>(type: \"character varying(160)\", maxLength: 160, nullable: false),\n                    Description = table.Column<string>(type: \"character varying(512)\", maxLength: 512, nullable: true),\n                    CampaignId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CsvBatchId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    IsDeleted = table.Column<bool>(type: \"boolean\", nullable: false),\n                    CreatedByUserId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false),\n                    UpdatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: true)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_Audiences\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_Audiences_Campaigns_CampaignId\",\n                        column: x => x.CampaignId,\n                        principalTable: \"Campaigns\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.SetNull);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CsvBatches\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    AudienceId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    FileName = table.Column<string>(type: \"character varying(256)\", maxLength: 256, nullable: true),\n                    HeadersJson = table.Column<string>(type: \"jsonb\", nullable: true),\n                    Checksum = table.Column<string>(type: \"character varying(128)\", maxLength: 128, nullable: true),\n                    RowCount = table.Column<int>(type: \"integer\", nullable: false),\n                    SkippedCount = table.Column<int>(type: \"integer\", nullable: false),\n                    Status = table.Column<string>(type: \"character varying(32)\", maxLength: 32, nullable: false),\n                    ErrorMessage = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedByUserId = table.Column<Guid>(type: \"uuid\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CsvBatches\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_CsvBatches_Audiences_AudienceId\",\n                        column: x => x.AudienceId,\n                        principalTable: \"Audiences\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.SetNull);\n                });\n\n            migrationBuilder.CreateTable(\n                name: \"CsvRows\",\n                columns: table => new\n                {\n                    Id = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BusinessId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    BatchId = table.Column<Guid>(type: \"uuid\", nullable: false),\n                    RowIndex = table.Column<int>(type: \"integer\", nullable: false),\n                    PhoneRaw = table.Column<string>(type: \"character varying(64)\", maxLength: 64, nullable: true),\n                    PhoneE164 = table.Column<string>(type: \"character varying(32)\", maxLength: 32, nullable: true),\n                    RowJson = table.Column<string>(type: \"jsonb\", nullable: false),\n                    ValidationError = table.Column<string>(type: \"text\", nullable: true),\n                    CreatedAt = table.Column<DateTime>(type: \"timestamp with time zone\", nullable: false)\n                },\n                constraints: table =>\n                {\n                    table.PrimaryKey(\"PK_CsvRows\", x => x.Id);\n                    table.ForeignKey(\n                        name: \"FK_CsvRows_CsvBatches_BatchId\",\n                        column: x => x.BatchId,\n                        principalTable: \"CsvBatches\",\n                        principalColumn: \"Id\",\n                        onDelete: ReferentialAction.Cascade);\n                });\n\n            migrationBuilder.InsertData(\n                table: \"Permissions\",\n                columns: new[] { \"Id\", \"Code\", \"CreatedAt\", \"Description\", \"Group\", \"IsActive\", \"Name\" },\n                values: new object[,]\n                {\n                    { new Guid(\"0485154c-dde5-4732-a7aa-a379c77a5b27\"), \"messaging.send.template\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Messaging\", true, \"messaging.send.template\" },\n                    { new Guid(\"0dedac5b-81c8-44c3-8cfe-76c58e29c6db\"), \"automation_trigger_test\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Automation\", true, \"automation_trigger_test\" },\n                    { new Guid(\"205b87c7-b008-4e51-9fea-798c2dc4f9c2\"), \"admin.whatsappsettings.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Admin\", true, \"admin.whatsappsettings.view\" },\n                    { new Guid(\"29461562-ef9c-48c0-a606-482ff57b8f95\"), \"messaging.send\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Messaging\", true, \"messaging.send\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000000\"), \"dashboard.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Dashboard\", true, \"dashboard.view\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000001\"), \"campaign.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Campaign\", true, \"campaign.view\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000002\"), \"campaign.create\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Campaign\", true, \"campaign.create\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000003\"), \"campaign.delete\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Campaign\", true, \"campaign.delete\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000004\"), \"product.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Catalog\", true, \"product.view\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000005\"), \"product.create\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Catalog\", true, \"product.create\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000006\"), \"product.delete\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Catalog\", true, \"product.delete\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000007\"), \"contacts.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"CRM\", true, \"contacts.view\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000008\"), \"tags.edit\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, null, true, \"tags.edit\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000009\"), \"admin.business.approve\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Admin\", true, \"admin.business.approve\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000010\"), \"admin.logs.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, null, true, \"admin.logs.view\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000011\"), \"admin.plans.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Admin\", true, \"admin.plans.view\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000012\"), \"admin.plans.create\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Admin\", true, \"admin.plans.create\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000013\"), \"admin.plans.update\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Admin\", true, \"admin.plans.update\" },\n                    { new Guid(\"30000000-0000-0000-0000-000000000014\"), \"admin.plans.delete\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Admin\", true, \"admin.plans.delete\" },\n                    { new Guid(\"636b17f2-1c54-4e26-a8cd-dbf561dcb522\"), \"automation.View.Template.Flow_analytics\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Automation\", true, \"automation.View.Template.Flow_analytics\" },\n                    { new Guid(\"6e4d3a86-7cf9-4ac2-b8a7-ed10c9f0173d\"), \"settings.whatsapp.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Settings\", true, \"Settings - WhatsApp View\" },\n                    { new Guid(\"74828fc0-e358-4cfc-b924-13719a0d9f50\"), \"inbox.menu\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Inbox\", true, \"inbox.menu\" },\n                    { new Guid(\"74c8034f-d9cb-4a17-8578-a9f765bd845c\"), \"messaging.report.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Messaging\", true, \"messaging.report.view\" },\n                    { new Guid(\"7d7cbceb-4ce7-4835-85cd-59562487298d\"), \"automation.View.TemplatePlusFreetext.Flow\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Automation\", true, \"automation.View.TemplatePlusFreetext.Flow\" },\n                    { new Guid(\"821480c6-1464-415e-bba8-066fcb4e7e63\"), \"automation.menu\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Automation\", true, \"automation.menu\" },\n                    { new Guid(\"918a61d0-5ab6-46af-a3d3-41e37b7710f9\"), \"automation.Create.Template.Flow\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Automation\", true, \"automation.Create.Template.Flow\" },\n                    { new Guid(\"93c5d5a7-f8dd-460a-8c7b-e3788440ba3a\"), \"automation.Create.TemplatePlusFreetext.Flow\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Automation\", true, \"automation.Create.TemplatePlusFreetext.Flow\" },\n                    { new Guid(\"974af1f9-3caa-4857-a1a7-48462c389332\"), \"messaging.send.text\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Messaging\", true, \"messaging.send.text\" },\n                    { new Guid(\"98572fe7-d142-475a-b990-f248641809e2\"), \"settings.profile.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Settings\", true, \"settings.profile.view\" },\n                    { new Guid(\"9ae90cfe-3fea-4307-b024-3083c2728148\"), \"automation.View.Template.Flow\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Automation\", true, \"automation.View.Template.Flow\" },\n                    { new Guid(\"ad36cdb7-5221-448b-a6a6-c35c9f88d021\"), \"inbox.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Inbox\", true, \"inbox.view\" },\n                    { new Guid(\"adfa8490-9705-4a36-a86e-d5bff7ddc220\"), \"automation.View.TemplatePlusFreeText.Flow_analytics\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Automation\", true, \"automation.View.TemplatePlusFreeText.Flow_analytics\" },\n                    { new Guid(\"bbc5202a-eac9-40bb-aa78-176c677dbf5b\"), \"messaging.whatsappsettings.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Messaging\", true, \"messaging.whatsappsettings.view\" },\n                    { new Guid(\"c819f1bd-422d-4609-916c-cc185fe44ab0\"), \"messaging.status.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Messaging\", true, \"messaging.status.view\" },\n                    { new Guid(\"eecd0fac-223c-4dba-9fa1-2a6e973d61d1\"), \"messaging.inbox.view\", new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc), null, \"Messaging\", true, \"messaging.inbox.view\" }\n                });\n\n            migrationBuilder.InsertData(\n                table: \"Plans\",\n                columns: new[] { \"Id\", \"Code\", \"CreatedAt\", \"Description\", \"IsActive\", \"Name\" },\n                values: new object[] { new Guid(\"5f9f5de1-a0b2-48ba-b03d-77b27345613f\"), \"basic\", new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc), \"Default free plan\", true, \"Basic\" });\n\n            migrationBuilder.InsertData(\n                table: \"Roles\",\n                columns: new[] { \"Id\", \"CreatedAt\", \"Description\", \"IsActive\", \"IsSystemDefined\", \"Name\" },\n                values: new object[,]\n                {\n                    { new Guid(\"00000000-0000-0000-0000-000000000001\"), new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc), \"Super Admin\", true, false, \"admin\" },\n                    { new Guid(\"00000000-0000-0000-0000-000000000002\"), new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc), \"Business Partner\", true, false, \"partner\" },\n                    { new Guid(\"00000000-0000-0000-0000-000000000003\"), new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc), \"Reseller Partner\", true, false, \"reseller\" },\n                    { new Guid(\"00000000-0000-0000-0000-000000000004\"), new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc), \"Business Owner\", true, false, \"business\" },\n                    { new Guid(\"00000000-0000-0000-0000-000000000005\"), new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc), \"Staff\", true, false, \"staff\" }\n                });\n\n            migrationBuilder.InsertData(\n                table: \"Users\",\n                columns: new[] { \"Id\", \"BusinessId\", \"CreatedAt\", \"DeletedAt\", \"Email\", \"IsDeleted\", \"Name\", \"PasswordHash\", \"RefreshToken\", \"RefreshTokenExpiry\", \"RoleId\", \"Status\" },\n                values: new object[] { new Guid(\"62858aa2-3a54-4fd5-8696-c343d9af7634\"), null, new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc), null, \"admin@xbytechat.com\", false, \"Super Admin\", \"JAvlGPq9JyTdtvBO6x2llnRI1+gxwIyPqCKAn3THIKk=\", null, null, new Guid(\"00000000-0000-0000-0000-000000000001\"), \"active\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"ix_audmember_contact\",\n                table: \"AudienceMembers\",\n                column: \"ContactId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"ux_audmember_audience_phone\",\n                table: \"AudienceMembers\",\n                columns: new[] { \"AudienceId\", \"PhoneE164\" },\n                unique: true);\n\n            migrationBuilder.CreateIndex(\n                name: \"ix_audiences_biz_deleted\",\n                table: \"Audiences\",\n                columns: new[] { \"BusinessId\", \"IsDeleted\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Audiences_BusinessId_CampaignId\",\n                table: \"Audiences\",\n                columns: new[] { \"BusinessId\", \"CampaignId\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Audiences_BusinessId_CsvBatchId\",\n                table: \"Audiences\",\n                columns: new[] { \"BusinessId\", \"CsvBatchId\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Audiences_CampaignId\",\n                table: \"Audiences\",\n                column: \"CampaignId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Audiences_CsvBatchId\",\n                table: \"Audiences\",\n                column: \"CsvBatchId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_AutoReplyFlowEdges_FlowId\",\n                table: \"AutoReplyFlowEdges\",\n                column: \"FlowId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_AutoReplyFlowNodes_FlowId\",\n                table: \"AutoReplyFlowNodes\",\n                column: \"FlowId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_AutoReplyRules_FlowId\",\n                table: \"AutoReplyRules\",\n                column: \"FlowId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Businesses_PlanId\",\n                table: \"Businesses\",\n                column: \"PlanId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_BusinessPlanInfos_BusinessId\",\n                table: \"BusinessPlanInfos\",\n                column: \"BusinessId\",\n                unique: true);\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignButtons_CampaignId\",\n                table: \"CampaignButtons\",\n                column: \"CampaignId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignClickDailyAgg_CampaignId_Day_ButtonIndex\",\n                table: \"CampaignClickDailyAgg\",\n                columns: new[] { \"CampaignId\", \"Day\", \"ButtonIndex\" },\n                unique: true);\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignClickLogs_CampaignId_ButtonIndex\",\n                table: \"CampaignClickLogs\",\n                columns: new[] { \"CampaignId\", \"ButtonIndex\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignClickLogs_CampaignId_ClickType_ClickedAt\",\n                table: \"CampaignClickLogs\",\n                columns: new[] { \"CampaignId\", \"ClickType\", \"ClickedAt\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignClickLogs_CampaignId_ContactId\",\n                table: \"CampaignClickLogs\",\n                columns: new[] { \"CampaignId\", \"ContactId\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignFlowOverrides_CampaignId\",\n                table: \"CampaignFlowOverrides\",\n                column: \"CampaignId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignRecipients_AudienceMemberId\",\n                table: \"CampaignRecipients\",\n                column: \"AudienceMemberId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignRecipients_BusinessId\",\n                table: \"CampaignRecipients\",\n                column: \"BusinessId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignRecipients_ContactId\",\n                table: \"CampaignRecipients\",\n                column: \"ContactId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"ix_campaignrecipients_idempotency\",\n                table: \"CampaignRecipients\",\n                column: \"IdempotencyKey\");\n\n            migrationBuilder.CreateIndex(\n                name: \"ix_recipients_campaign_contact\",\n                table: \"CampaignRecipients\",\n                columns: new[] { \"CampaignId\", \"ContactId\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Campaigns_BusinessId\",\n                table: \"Campaigns\",\n                column: \"BusinessId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Campaigns_CTAFlowConfigId\",\n                table: \"Campaigns\",\n                column: \"CTAFlowConfigId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Campaigns_CtaId\",\n                table: \"Campaigns\",\n                column: \"CtaId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Campaigns_SourceCampaignId\",\n                table: \"Campaigns\",\n                column: \"SourceCampaignId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignSendLogs_Business_MessageId\",\n                table: \"CampaignSendLogs\",\n                columns: new[] { \"BusinessId\", \"MessageId\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignSendLogs_CampaignId\",\n                table: \"CampaignSendLogs\",\n                column: \"CampaignId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignSendLogs_ContactId\",\n                table: \"CampaignSendLogs\",\n                column: \"ContactId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignSendLogs_MessageId\",\n                table: \"CampaignSendLogs\",\n                column: \"MessageId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignSendLogs_MessageLogId\",\n                table: \"CampaignSendLogs\",\n                column: \"MessageLogId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignSendLogs_RecipientId\",\n                table: \"CampaignSendLogs\",\n                column: \"RecipientId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignSendLogs_RunId\",\n                table: \"CampaignSendLogs\",\n                column: \"RunId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignSendLogs_UserId\",\n                table: \"CampaignSendLogs\",\n                column: \"UserId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CampaignVariableMaps_CampaignId\",\n                table: \"CampaignVariableMaps\",\n                column: \"CampaignId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_ContactReads_ContactId_UserId\",\n                table: \"ContactReads\",\n                columns: new[] { \"ContactId\", \"UserId\" },\n                unique: true);\n\n            migrationBuilder.CreateIndex(\n                name: \"ux_contactreads_biz_user_contact\",\n                table: \"ContactReads\",\n                columns: new[] { \"BusinessId\", \"UserId\", \"ContactId\" },\n                unique: true);\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Contacts_BusinessId_PhoneNumber\",\n                table: \"Contacts\",\n                columns: new[] { \"BusinessId\", \"PhoneNumber\" },\n                unique: true);\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_ContactTags_ContactId\",\n                table: \"ContactTags\",\n                column: \"ContactId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_ContactTags_TagId\",\n                table: \"ContactTags\",\n                column: \"TagId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"ix_csvbatch_biz_created\",\n                table: \"CsvBatches\",\n                columns: new[] { \"BusinessId\", \"CreatedAt\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"ix_csvbatch_checksum\",\n                table: \"CsvBatches\",\n                column: \"Checksum\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CsvBatches_AudienceId\",\n                table: \"CsvBatches\",\n                column: \"AudienceId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CsvBatches_BusinessId_AudienceId\",\n                table: \"CsvBatches\",\n                columns: new[] { \"BusinessId\", \"AudienceId\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"ix_csvrow_phone\",\n                table: \"CsvRows\",\n                column: \"PhoneE164\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CsvRows_BusinessId_BatchId\",\n                table: \"CsvRows\",\n                columns: new[] { \"BusinessId\", \"BatchId\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"ux_csvrow_batch_rowidx\",\n                table: \"CsvRows\",\n                columns: new[] { \"BatchId\", \"RowIndex\" },\n                unique: true);\n\n            migrationBuilder.CreateIndex(\n                name: \"ix_ctaflowconfigs_biz_active_name\",\n                table: \"CTAFlowConfigs\",\n                columns: new[] { \"BusinessId\", \"IsActive\", \"FlowName\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CTAFlowConfigs_BusinessId_FlowName_IsActive\",\n                table: \"CTAFlowConfigs\",\n                columns: new[] { \"BusinessId\", \"FlowName\", \"IsActive\" },\n                unique: true);\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_CTAFlowSteps_CTAFlowConfigId\",\n                table: \"CTAFlowSteps\",\n                column: \"CTAFlowConfigId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_FeatureAccess_BusinessId_FeatureName\",\n                table: \"FeatureAccess\",\n                columns: new[] { \"BusinessId\", \"FeatureName\" },\n                unique: true);\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_FlowButtonLinks_CTAFlowStepId\",\n                table: \"FlowButtonLinks\",\n                column: \"CTAFlowStepId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_LeadTimelines_BusinessId\",\n                table: \"LeadTimelines\",\n                column: \"BusinessId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_LeadTimelines_ContactId\",\n                table: \"LeadTimelines\",\n                column: \"ContactId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_MessageLogs_Business_MessageId\",\n                table: \"MessageLogs\",\n                columns: new[] { \"BusinessId\", \"MessageId\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_MessageLogs_Business_Recipient\",\n                table: \"MessageLogs\",\n                columns: new[] { \"BusinessId\", \"RecipientNumber\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_MessageLogs_CampaignId\",\n                table: \"MessageLogs\",\n                column: \"CampaignId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_MessageLogs_ContactId\",\n                table: \"MessageLogs\",\n                column: \"ContactId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_MessageLogs_MessageId\",\n                table: \"MessageLogs\",\n                column: \"MessageId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_MessageLogs_RunId\",\n                table: \"MessageLogs\",\n                column: \"RunId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"ix_msglogs_biz_in_contact_msgtime\",\n                table: \"MessageLogs\",\n                columns: new[] { \"BusinessId\", \"IsIncoming\", \"ContactId\", \"MessageTime\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_MessageStatusLogs_BusinessId\",\n                table: \"MessageStatusLogs\",\n                column: \"BusinessId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_MessageStatusLogs_CampaignId\",\n                table: \"MessageStatusLogs\",\n                column: \"CampaignId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_MessageStatusLogs_UserId\",\n                table: \"MessageStatusLogs\",\n                column: \"UserId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_OutboundCampaignJobs_CampaignId\",\n                table: \"OutboundCampaignJobs\",\n                column: \"CampaignId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_OutboundCampaignJobs_Status_NextAttemptAt\",\n                table: \"OutboundCampaignJobs\",\n                columns: new[] { \"Status\", \"NextAttemptAt\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_PlanPermissions_PermissionId\",\n                table: \"PlanPermissions\",\n                column: \"PermissionId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_PlanPermissions_PlanId\",\n                table: \"PlanPermissions\",\n                column: \"PlanId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_QuickReplies_BusinessId_OwnerUserId_IsActive\",\n                table: \"QuickReplies\",\n                columns: new[] { \"BusinessId\", \"OwnerUserId\", \"IsActive\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_QuickReplies_BusinessId_Scope_IsActive\",\n                table: \"QuickReplies\",\n                columns: new[] { \"BusinessId\", \"Scope\", \"IsActive\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_QuickReplies_UpdatedAt\",\n                table: \"QuickReplies\",\n                column: \"UpdatedAt\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_RolePermissions_PermissionId\",\n                table: \"RolePermissions\",\n                column: \"PermissionId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_RolePermissions_RoleId\",\n                table: \"RolePermissions\",\n                column: \"RoleId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_TrackingLogs_CampaignId\",\n                table: \"TrackingLogs\",\n                column: \"CampaignId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_TrackingLogs_CampaignSendLogId\",\n                table: \"TrackingLogs\",\n                column: \"CampaignSendLogId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_TrackingLogs_ContactId\",\n                table: \"TrackingLogs\",\n                column: \"ContactId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_TrackingLogs_MessageLogId\",\n                table: \"TrackingLogs\",\n                column: \"MessageLogId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_UserPermissions_PermissionId\",\n                table: \"UserPermissions\",\n                column: \"PermissionId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_UserPermissions_UserId\",\n                table: \"UserPermissions\",\n                column: \"UserId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Users_BusinessId\",\n                table: \"Users\",\n                column: \"BusinessId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_Users_RoleId\",\n                table: \"Users\",\n                column: \"RoleId\");\n\n            migrationBuilder.CreateIndex(\n                name: \"UX_WhatsappPhoneNumbers_Bus_Prov_PhoneId\",\n                table: \"WhatsAppPhoneNumbers\",\n                columns: new[] { \"BusinessId\", \"Provider\", \"PhoneNumberId\" },\n                unique: true);\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_WhatsAppSettings_Business_Provider_IsActive\",\n                table: \"WhatsAppSettings\",\n                columns: new[] { \"BusinessId\", \"Provider\", \"IsActive\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_WhatsAppSettings_Provider_BusinessNumber\",\n                table: \"WhatsAppSettings\",\n                columns: new[] { \"Provider\", \"WhatsAppBusinessNumber\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_WhatsAppSettings_Provider_CallbackUrl\",\n                table: \"WhatsAppSettings\",\n                columns: new[] { \"Provider\", \"WebhookCallbackUrl\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_WhatsAppSettings_Provider_PhoneNumberId\",\n                table: \"WhatsAppSettings\",\n                columns: new[] { \"Provider\", \"PhoneNumberId\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_WhatsAppSettings_Provider_WabaId\",\n                table: \"WhatsAppSettings\",\n                columns: new[] { \"Provider\", \"WabaId\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_WhatsAppTemplates_BusinessId_Name\",\n                table: \"WhatsAppTemplates\",\n                columns: new[] { \"BusinessId\", \"Name\" });\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_WhatsAppTemplates_BusinessId_Name_Language_Provider\",\n                table: \"WhatsAppTemplates\",\n                columns: new[] { \"BusinessId\", \"Name\", \"Language\", \"Provider\" },\n                unique: true);\n\n            migrationBuilder.CreateIndex(\n                name: \"IX_WhatsAppTemplates_BusinessId_Provider\",\n                table: \"WhatsAppTemplates\",\n                columns: new[] { \"BusinessId\", \"Provider\" });\n\n            migrationBuilder.AddForeignKey(\n                name: \"FK_AudienceMembers_Audiences_AudienceId\",\n                table: \"AudienceMembers\",\n                column: \"AudienceId\",\n                principalTable: \"Audiences\",\n                principalColumn: \"Id\",\n                onDelete: ReferentialAction.Cascade);\n\n            migrationBuilder.AddForeignKey(\n                name: \"FK_Audiences_CsvBatches_CsvBatchId\",\n                table: \"Audiences\",\n                column: \"CsvBatchId\",\n                principalTable: \"CsvBatches\",\n                principalColumn: \"Id\",\n                onDelete: ReferentialAction.SetNull);\n        }\n\n        /// <inheritdoc />\n        protected override void Down(MigrationBuilder migrationBuilder)\n        {\n            migrationBuilder.DropForeignKey(\n                name: \"FK_CsvBatches_Audiences_AudienceId\",\n                table: \"CsvBatches\");\n\n            migrationBuilder.DropTable(\n                name: \"AuditLogs\");\n\n            migrationBuilder.DropTable(\n                name: \"AutomationFlows\");\n\n            migrationBuilder.DropTable(\n                name: \"AutoReplyFlowEdges\");\n\n            migrationBuilder.DropTable(\n                name: \"AutoReplyFlowNodes\");\n\n            migrationBuilder.DropTable(\n                name: \"AutoReplyLogs\");\n\n            migrationBuilder.DropTable(\n                name: \"AutoReplyRules\");\n\n            migrationBuilder.DropTable(\n                name: \"BusinessPlanInfos\");\n\n            migrationBuilder.DropTable(\n                name: \"CampaignButtons\");\n\n            migrationBuilder.DropTable(\n                name: \"CampaignClickDailyAgg\");\n\n            migrationBuilder.DropTable(\n                name: \"CampaignClickLogs\");\n\n            migrationBuilder.DropTable(\n                name: \"CampaignFlowOverrides\");\n\n            migrationBuilder.DropTable(\n                name: \"CampaignVariableMaps\");\n\n            migrationBuilder.DropTable(\n                name: \"CatalogClickLogs\");\n\n            migrationBuilder.DropTable(\n                name: \"ChatSessionStates\");\n\n            migrationBuilder.DropTable(\n                name: \"ContactReads\");\n\n            migrationBuilder.DropTable(\n                name: \"ContactTags\");\n\n            migrationBuilder.DropTable(\n                name: \"CsvRows\");\n\n            migrationBuilder.DropTable(\n                name: \"FailedWebhookLogs\");\n\n            migrationBuilder.DropTable(\n                name: \"FeatureAccess\");\n\n            migrationBuilder.DropTable(\n                name: \"FeatureMaster\");\n\n            migrationBuilder.DropTable(\n                name: \"FlowButtonLinks\");\n\n            migrationBuilder.DropTable(\n                name: \"FlowExecutionLogs\");\n\n            migrationBuilder.DropTable(\n                name: \"LeadTimelines\");\n\n            migrationBuilder.DropTable(\n                name: \"MessageStatusLogs\");\n\n            migrationBuilder.DropTable(\n                name: \"Notes\");\n\n            migrationBuilder.DropTable(\n                name: \"OutboundCampaignJobs\");\n\n            migrationBuilder.DropTable(\n                name: \"PlanFeatureMatrix\");\n\n            migrationBuilder.DropTable(\n                name: \"PlanPermissions\");\n\n            migrationBuilder.DropTable(\n                name: \"Products\");\n\n            migrationBuilder.DropTable(\n                name: \"ProviderBillingEvents\");\n\n            migrationBuilder.DropTable(\n                name: \"QuickReplies\");\n\n            migrationBuilder.DropTable(\n                name: \"Reminders\");\n\n            migrationBuilder.DropTable(\n                name: \"RolePermissions\");\n\n            migrationBuilder.DropTable(\n                name: \"TrackingLogs\");\n\n            migrationBuilder.DropTable(\n                name: \"UserFeatureAccess\");\n\n            migrationBuilder.DropTable(\n                name: \"UserPermissions\");\n\n            migrationBuilder.DropTable(\n                name: \"WebhookSettings\");\n\n            migrationBuilder.DropTable(\n                name: \"WhatsAppPhoneNumbers\");\n\n            migrationBuilder.DropTable(\n                name: \"WhatsAppTemplates\");\n\n            migrationBuilder.DropTable(\n                name: \"AutoReplyFlows\");\n\n            migrationBuilder.DropTable(\n                name: \"Tags\");\n\n            migrationBuilder.DropTable(\n                name: \"CTAFlowSteps\");\n\n            migrationBuilder.DropTable(\n                name: \"CampaignSendLogs\");\n\n            migrationBuilder.DropTable(\n                name: \"Permissions\");\n\n            migrationBuilder.DropTable(\n                name: \"WhatsAppSettings\");\n\n            migrationBuilder.DropTable(\n                name: \"CampaignRecipients\");\n\n            migrationBuilder.DropTable(\n                name: \"MessageLogs\");\n\n            migrationBuilder.DropTable(\n                name: \"Users\");\n\n            migrationBuilder.DropTable(\n                name: \"AudienceMembers\");\n\n            migrationBuilder.DropTable(\n                name: \"Contacts\");\n\n            migrationBuilder.DropTable(\n                name: \"Roles\");\n\n            migrationBuilder.DropTable(\n                name: \"Audiences\");\n\n            migrationBuilder.DropTable(\n                name: \"Campaigns\");\n\n            migrationBuilder.DropTable(\n                name: \"CsvBatches\");\n\n            migrationBuilder.DropTable(\n                name: \"Businesses\");\n\n            migrationBuilder.DropTable(\n                name: \"CTADefinitions\");\n\n            migrationBuilder.DropTable(\n                name: \"CTAFlowConfigs\");\n\n            migrationBuilder.DropTable(\n                name: \"Plans\");\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Migrations/20250928044553_Initial.Designer.cs",
      "sha256": "481be46bf444bf1450da4433ed7f059399561ace326e43102e141cd2a5c2be37",
      "language": "csharp",
      "size": 149745,
      "content": "// <auto-generated />\nusing System;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.EntityFrameworkCore.Infrastructure;\nusing Microsoft.EntityFrameworkCore.Migrations;\nusing Microsoft.EntityFrameworkCore.Storage.ValueConversion;\nusing Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;\nusing xbytechat.api;\n\n#nullable disable\n\nnamespace xbytechat.api.Migrations\n{\n    [DbContext(typeof(AppDbContext))]\n    [Migration(\"20250928044553_Initial\")]\n    partial class Initial\n    {\n        /// <inheritdoc />\n        protected override void BuildTargetModel(ModelBuilder modelBuilder)\n        {\n#pragma warning disable 612, 618\n            modelBuilder\n                .HasAnnotation(\"ProductVersion\", \"8.0.18\")\n                .HasAnnotation(\"Relational:MaxIdentifierLength\", 63);\n\n            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);\n\n            modelBuilder.Entity(\"ContactTag\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"AssignedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"AssignedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"TagId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"ContactId\");\n\n                    b.HasIndex(\"TagId\");\n\n                    b.ToTable(\"ContactTags\");\n                });\n\n            modelBuilder.Entity(\"MessageLog\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ButtonBundleJson\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"CTAFlowConfigId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CTAFlowStepId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ConversationCategory\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ConversationId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTimeOffset?>(\"ConversationStartedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"ErrorMessage\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<int?>(\"FlowVersion\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<bool?>(\"IsChargeable\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsIncoming\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"MediaUrl\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"MessageContent\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"MessageId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"MessageTime\")\n                        .ValueGeneratedOnAddOrUpdate()\n                        .HasColumnType(\"timestamp with time zone\")\n                        .HasComputedColumnSql(\"COALESCE(\\\"SentAt\\\", \\\"CreatedAt\\\")\", true);\n\n                    b.Property<decimal?>(\"PriceAmount\")\n                        .HasColumnType(\"numeric\");\n\n                    b.Property<string>(\"PriceCurrency\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Provider\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ProviderMessageId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"RawResponse\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"RecipientNumber\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"RefMessageId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"RenderedBody\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"RunId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime?>(\"SentAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Source\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Status\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CampaignId\");\n\n                    b.HasIndex(\"ContactId\");\n\n                    b.HasIndex(\"MessageId\");\n\n                    b.HasIndex(\"RunId\");\n\n                    b.HasIndex(\"BusinessId\", \"MessageId\")\n                        .HasDatabaseName(\"IX_MessageLogs_Business_MessageId\");\n\n                    b.HasIndex(\"BusinessId\", \"RecipientNumber\")\n                        .HasDatabaseName(\"IX_MessageLogs_Business_Recipient\");\n\n                    b.HasIndex(\"BusinessId\", \"IsIncoming\", \"ContactId\", \"MessageTime\")\n                        .HasDatabaseName(\"ix_msglogs_biz_in_contact_msgtime\");\n\n                    b.ToTable(\"MessageLogs\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.AuthModule.Models.User\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<DateTime?>(\"DeletedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Email\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsDeleted\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"PasswordHash\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"RefreshToken\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"RefreshTokenExpiry\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid?>(\"RoleId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Status\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"BusinessId\");\n\n                    b.HasIndex(\"RoleId\");\n\n                    b.ToTable(\"Users\");\n\n                    b.HasData(\n                        new\n                        {\n                            Id = new Guid(\"62858aa2-3a54-4fd5-8696-c343d9af7634\"),\n                            CreatedAt = new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Email = \"admin@xbytechat.com\",\n                            IsDeleted = false,\n                            Name = \"Super Admin\",\n                            PasswordHash = \"JAvlGPq9JyTdtvBO6x2llnRI1+gxwIyPqCKAn3THIKk=\",\n                            RoleId = new Guid(\"00000000-0000-0000-0000-000000000001\"),\n                            Status = \"active\"\n                        });\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.AuthModule.Models.WhatsAppTemplate\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Body\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ButtonsJson\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Category\")\n                        .HasMaxLength(40)\n                        .HasColumnType(\"character varying(40)\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"ExternalId\")\n                        .HasMaxLength(120)\n                        .HasColumnType(\"character varying(120)\");\n\n                    b.Property<bool>(\"HasImageHeader\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Language\")\n                        .IsRequired()\n                        .HasMaxLength(16)\n                        .HasColumnType(\"character varying(16)\");\n\n                    b.Property<DateTime>(\"LastSyncedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasMaxLength(160)\n                        .HasColumnType(\"character varying(160)\");\n\n                    b.Property<int>(\"PlaceholderCount\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"Provider\")\n                        .IsRequired()\n                        .HasMaxLength(40)\n                        .HasColumnType(\"character varying(40)\");\n\n                    b.Property<string>(\"RawJson\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Status\")\n                        .IsRequired()\n                        .HasMaxLength(32)\n                        .HasColumnType(\"character varying(32)\");\n\n                    b.Property<DateTime>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"BusinessId\", \"Name\");\n\n                    b.HasIndex(\"BusinessId\", \"Provider\");\n\n                    b.HasIndex(\"BusinessId\", \"Name\", \"Language\", \"Provider\")\n                        .IsUnique();\n\n                    b.ToTable(\"WhatsAppTemplates\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.CRM.Models.Contact\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"AssignedAgentId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Email\")\n                        .HasMaxLength(100)\n                        .HasColumnType(\"character varying(100)\");\n\n                    b.Property<string>(\"Group\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsArchived\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsAutomationPaused\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsFavorite\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<DateTime?>(\"LastCTAInteraction\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"LastCTAType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"LastClickedProductId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime?>(\"LastContactedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"LeadSource\")\n                        .HasMaxLength(50)\n                        .HasColumnType(\"character varying(50)\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasMaxLength(100)\n                        .HasColumnType(\"character varying(100)\");\n\n                    b.Property<DateTime?>(\"NextFollowUpAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Notes\")\n                        .HasMaxLength(500)\n                        .HasColumnType(\"character varying(500)\");\n\n                    b.Property<string>(\"PhoneNumber\")\n                        .IsRequired()\n                        .HasMaxLength(20)\n                        .HasColumnType(\"character varying(20)\");\n\n                    b.Property<string>(\"ProfileName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"ProfileNameUpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Tags\")\n                        .HasMaxLength(200)\n                        .HasColumnType(\"character varying(200)\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"BusinessId\", \"PhoneNumber\")\n                        .IsUnique()\n                        .HasDatabaseName(\"IX_Contacts_BusinessId_PhoneNumber\");\n\n                    b.ToTable(\"Contacts\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.CRM.Models.Note\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Content\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"CreatedBy\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"EditedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<bool>(\"IsInternal\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsPinned\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Source\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Title\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"Notes\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.CRM.Models.Reminder\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime?>(\"CompletedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Description\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"DueAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<bool>(\"FollowUpSent\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsRecurring\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"LastCTAType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"LastClickedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"LinkedCampaign\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<int?>(\"Priority\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"RecurrencePattern\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ReminderType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"SendWhatsappNotification\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Status\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Title\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"Reminders\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.CRM.Models.Tag\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Category\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ColorHex\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsSystemTag\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<DateTime?>(\"LastUsedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Notes\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"Tags\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.Permission\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Code\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Description\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Group\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"Permissions\");\n\n                    b.HasData(\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000000\"),\n                            Code = \"dashboard.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Dashboard\",\n                            IsActive = true,\n                            Name = \"dashboard.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000001\"),\n                            Code = \"campaign.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Campaign\",\n                            IsActive = true,\n                            Name = \"campaign.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000002\"),\n                            Code = \"campaign.create\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Campaign\",\n                            IsActive = true,\n                            Name = \"campaign.create\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000003\"),\n                            Code = \"campaign.delete\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Campaign\",\n                            IsActive = true,\n                            Name = \"campaign.delete\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000004\"),\n                            Code = \"product.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Catalog\",\n                            IsActive = true,\n                            Name = \"product.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000005\"),\n                            Code = \"product.create\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Catalog\",\n                            IsActive = true,\n                            Name = \"product.create\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000006\"),\n                            Code = \"product.delete\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Catalog\",\n                            IsActive = true,\n                            Name = \"product.delete\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000007\"),\n                            Code = \"contacts.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"CRM\",\n                            IsActive = true,\n                            Name = \"contacts.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000008\"),\n                            Code = \"tags.edit\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            IsActive = true,\n                            Name = \"tags.edit\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000009\"),\n                            Code = \"admin.business.approve\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Admin\",\n                            IsActive = true,\n                            Name = \"admin.business.approve\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000010\"),\n                            Code = \"admin.logs.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            IsActive = true,\n                            Name = \"admin.logs.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000011\"),\n                            Code = \"admin.plans.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Admin\",\n                            IsActive = true,\n                            Name = \"admin.plans.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000012\"),\n                            Code = \"admin.plans.create\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Admin\",\n                            IsActive = true,\n                            Name = \"admin.plans.create\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000013\"),\n                            Code = \"admin.plans.update\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Admin\",\n                            IsActive = true,\n                            Name = \"admin.plans.update\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"30000000-0000-0000-0000-000000000014\"),\n                            Code = \"admin.plans.delete\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Admin\",\n                            IsActive = true,\n                            Name = \"admin.plans.delete\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"74c8034f-d9cb-4a17-8578-a9f765bd845c\"),\n                            Code = \"messaging.report.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Messaging\",\n                            IsActive = true,\n                            Name = \"messaging.report.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"c819f1bd-422d-4609-916c-cc185fe44ab0\"),\n                            Code = \"messaging.status.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Messaging\",\n                            IsActive = true,\n                            Name = \"messaging.status.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"eecd0fac-223c-4dba-9fa1-2a6e973d61d1\"),\n                            Code = \"messaging.inbox.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Messaging\",\n                            IsActive = true,\n                            Name = \"messaging.inbox.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"974af1f9-3caa-4857-a1a7-48462c389332\"),\n                            Code = \"messaging.send.text\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Messaging\",\n                            IsActive = true,\n                            Name = \"messaging.send.text\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"0485154c-dde5-4732-a7aa-a379c77a5b27\"),\n                            Code = \"messaging.send.template\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Messaging\",\n                            IsActive = true,\n                            Name = \"messaging.send.template\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"29461562-ef9c-48c0-a606-482ff57b8f95\"),\n                            Code = \"messaging.send\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Messaging\",\n                            IsActive = true,\n                            Name = \"messaging.send\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"bbc5202a-eac9-40bb-aa78-176c677dbf5b\"),\n                            Code = \"messaging.whatsappsettings.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Messaging\",\n                            IsActive = true,\n                            Name = \"messaging.whatsappsettings.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"205b87c7-b008-4e51-9fea-798c2dc4f9c2\"),\n                            Code = \"admin.whatsappsettings.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Admin\",\n                            IsActive = true,\n                            Name = \"admin.whatsappsettings.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"6e4d3a86-7cf9-4ac2-b8a7-ed10c9f0173d\"),\n                            Code = \"settings.whatsapp.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Settings\",\n                            IsActive = true,\n                            Name = \"Settings - WhatsApp View\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"ad36cdb7-5221-448b-a6a6-c35c9f88d021\"),\n                            Code = \"inbox.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Inbox\",\n                            IsActive = true,\n                            Name = \"inbox.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"74828fc0-e358-4cfc-b924-13719a0d9f50\"),\n                            Code = \"inbox.menu\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Inbox\",\n                            IsActive = true,\n                            Name = \"inbox.menu\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"98572fe7-d142-475a-b990-f248641809e2\"),\n                            Code = \"settings.profile.view\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Settings\",\n                            IsActive = true,\n                            Name = \"settings.profile.view\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"821480c6-1464-415e-bba8-066fcb4e7e63\"),\n                            Code = \"automation.menu\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Automation\",\n                            IsActive = true,\n                            Name = \"automation.menu\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"918a61d0-5ab6-46af-a3d3-41e37b7710f9\"),\n                            Code = \"automation.Create.Template.Flow\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Automation\",\n                            IsActive = true,\n                            Name = \"automation.Create.Template.Flow\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"9ae90cfe-3fea-4307-b024-3083c2728148\"),\n                            Code = \"automation.View.Template.Flow\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Automation\",\n                            IsActive = true,\n                            Name = \"automation.View.Template.Flow\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"93c5d5a7-f8dd-460a-8c7b-e3788440ba3a\"),\n                            Code = \"automation.Create.TemplatePlusFreetext.Flow\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Automation\",\n                            IsActive = true,\n                            Name = \"automation.Create.TemplatePlusFreetext.Flow\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"7d7cbceb-4ce7-4835-85cd-59562487298d\"),\n                            Code = \"automation.View.TemplatePlusFreetext.Flow\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Automation\",\n                            IsActive = true,\n                            Name = \"automation.View.TemplatePlusFreetext.Flow\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"636b17f2-1c54-4e26-a8cd-dbf561dcb522\"),\n                            Code = \"automation.View.Template.Flow_analytics\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Automation\",\n                            IsActive = true,\n                            Name = \"automation.View.Template.Flow_analytics\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"adfa8490-9705-4a36-a86e-d5bff7ddc220\"),\n                            Code = \"automation.View.TemplatePlusFreeText.Flow_analytics\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Automation\",\n                            IsActive = true,\n                            Name = \"automation.View.TemplatePlusFreeText.Flow_analytics\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"0dedac5b-81c8-44c3-8cfe-76c58e29c6db\"),\n                            Code = \"automation_trigger_test\",\n                            CreatedAt = new DateTime(2025, 9, 13, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Group = \"Automation\",\n                            IsActive = true,\n                            Name = \"automation_trigger_test\"\n                        });\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.Plan\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Code\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Description\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"Plans\");\n\n                    b.HasData(\n                        new\n                        {\n                            Id = new Guid(\"5f9f5de1-a0b2-48ba-b03d-77b27345613f\"),\n                            Code = \"basic\",\n                            CreatedAt = new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Description = \"Default free plan\",\n                            IsActive = true,\n                            Name = \"Basic\"\n                        });\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.PlanPermission\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"AssignedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"AssignedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<Guid>(\"PermissionId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"PlanId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"PermissionId\");\n\n                    b.HasIndex(\"PlanId\");\n\n                    b.ToTable(\"PlanPermissions\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.Role\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Description\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsSystemDefined\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"Roles\");\n\n                    b.HasData(\n                        new\n                        {\n                            Id = new Guid(\"00000000-0000-0000-0000-000000000001\"),\n                            CreatedAt = new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Description = \"Super Admin\",\n                            IsActive = true,\n                            IsSystemDefined = false,\n                            Name = \"admin\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"00000000-0000-0000-0000-000000000002\"),\n                            CreatedAt = new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Description = \"Business Partner\",\n                            IsActive = true,\n                            IsSystemDefined = false,\n                            Name = \"partner\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"00000000-0000-0000-0000-000000000003\"),\n                            CreatedAt = new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Description = \"Reseller Partner\",\n                            IsActive = true,\n                            IsSystemDefined = false,\n                            Name = \"reseller\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"00000000-0000-0000-0000-000000000004\"),\n                            CreatedAt = new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Description = \"Business Owner\",\n                            IsActive = true,\n                            IsSystemDefined = false,\n                            Name = \"business\"\n                        },\n                        new\n                        {\n                            Id = new Guid(\"00000000-0000-0000-0000-000000000005\"),\n                            CreatedAt = new DateTime(2025, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc),\n                            Description = \"Staff\",\n                            IsActive = true,\n                            IsSystemDefined = false,\n                            Name = \"staff\"\n                        });\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.RolePermission\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"AssignedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"AssignedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsRevoked\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<Guid>(\"PermissionId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"RoleId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"PermissionId\");\n\n                    b.HasIndex(\"RoleId\");\n\n                    b.ToTable(\"RolePermissions\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.UserPermission\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"AssignedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"AssignedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsGranted\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsRevoked\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<Guid>(\"PermissionId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"UserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"PermissionId\");\n\n                    b.HasIndex(\"UserId\");\n\n                    b.ToTable(\"UserPermissions\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AuditTrail.Models.AuditLog\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ActionType\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Description\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"IPAddress\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Location\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"PerformedByUserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"PerformedByUserName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"RoleAtTime\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"UserAgent\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"AuditLogs\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AutoReplyBuilder.Flows.Models.AutoReplyFlow\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"EdgesJson\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"IndustryTag\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsDefaultTemplate\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Keyword\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"NodesJson\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TriggerKeyword\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"UseCase\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"AutoReplyFlows\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AutoReplyBuilder.Models.AutoReplyFlowEdge\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid>(\"FlowId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"SourceHandle\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"SourceNodeId\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TargetHandle\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TargetNodeId\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"FlowId\");\n\n                    b.ToTable(\"AutoReplyFlowEdges\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AutoReplyBuilder.Models.AutoReplyFlowNode\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ConfigJson\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid>(\"FlowId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Label\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"NodeName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"NodeType\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<int>(\"Order\")\n                        .HasColumnType(\"integer\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"FlowId\");\n\n                    b.ToTable(\"AutoReplyFlowNodes\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AutoReplyBuilder.Models.AutoReplyLog\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"FlowName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"MessageLogId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ReplyContent\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TriggerKeyword\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TriggerType\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"TriggeredAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"AutoReplyLogs\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AutoReplyBuilder.Models.AutoReplyRule\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid?>(\"FlowId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"FlowName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"IndustryTag\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"MediaUrl\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<int>(\"Priority\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"ReplyMessage\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"SourceChannel\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TriggerKeyword\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"FlowId\");\n\n                    b.ToTable(\"AutoReplyRules\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.Automation.Models.AutomationFlow\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"EdgesJson\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"NodesJson\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TriggerKeyword\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"AutomationFlows\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.BusinessModule.Models.Business\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Address\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"ApprovedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"ApprovedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"BusinessEmail\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"BusinessName\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"CompanyName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"CompanyPhone\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"CreatedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"CreatedByPartnerId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime?>(\"DeletedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"DeletedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Industry\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsApproved\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsDeleted\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<DateTime?>(\"LastLoginAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"LogoUrl\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Notes\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Phone\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"PlanId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"RepresentativeName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Source\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<int>(\"Status\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"Tags\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Website\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"PlanId\");\n\n                    b.ToTable(\"Businesses\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CTAFlowBuilder.Models.CTAFlowConfig\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"CreatedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"FlowName\")\n                        .IsRequired()\n                        .HasMaxLength(100)\n                        .HasColumnType(\"character varying(100)\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsPublished\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<DateTime?>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"BusinessId\", \"FlowName\", \"IsActive\")\n                        .IsUnique();\n\n                    b.HasIndex(\"BusinessId\", \"IsActive\", \"FlowName\")\n                        .HasDatabaseName(\"ix_ctaflowconfigs_biz_active_name\");\n\n                    b.ToTable(\"CTAFlowConfigs\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CTAFlowBuilder.Models.CTAFlowStep\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"CTAFlowConfigId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<float?>(\"PositionX\")\n                        .HasColumnType(\"real\");\n\n                    b.Property<float?>(\"PositionY\")\n                        .HasColumnType(\"real\");\n\n                    b.Property<int?>(\"ProfileNameSlot\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"RequiredSource\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"RequiredTag\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<int>(\"StepOrder\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"TemplateToSend\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TemplateType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TriggerButtonText\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TriggerButtonType\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"UseProfileName\")\n                        .HasColumnType(\"boolean\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CTAFlowConfigId\");\n\n                    b.ToTable(\"CTAFlowSteps\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CTAFlowBuilder.Models.FlowButtonLink\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<short>(\"ButtonIndex\")\n                        .HasColumnType(\"smallint\");\n\n                    b.Property<string>(\"ButtonSubType\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ButtonText\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ButtonType\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ButtonValue\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"CTAFlowStepId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"NextStepId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CTAFlowStepId\");\n\n                    b.ToTable(\"FlowButtonLinks\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CTAFlowBuilder.Models.FlowExecutionLog\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<short?>(\"ButtonIndex\")\n                        .HasColumnType(\"smallint\");\n\n                    b.Property<Guid?>(\"CampaignSendLogId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ContactPhone\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ErrorMessage\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"ExecutedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid?>(\"FlowId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"MessageLogId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"RawResponse\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"RequestId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"RunId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"StepId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"StepName\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"Success\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"TemplateName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TemplateType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"TrackingLogId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"TriggeredByButton\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"FlowExecutionLogs\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CTAManagement.Models.CTADefinition\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ButtonText\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ButtonType\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Description\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"TargetUrl\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Title\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"CTADefinitions\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.Audience\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid?>(\"CreatedByUserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CsvBatchId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Description\")\n                        .HasMaxLength(512)\n                        .HasColumnType(\"character varying(512)\");\n\n                    b.Property<bool>(\"IsDeleted\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasMaxLength(160)\n                        .HasColumnType(\"character varying(160)\");\n\n                    b.Property<DateTime?>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CampaignId\");\n\n                    b.HasIndex(\"CsvBatchId\");\n\n                    b.HasIndex(\"BusinessId\", \"CampaignId\");\n\n                    b.HasIndex(\"BusinessId\", \"CsvBatchId\");\n\n                    b.HasIndex(\"BusinessId\", \"IsDeleted\")\n                        .HasDatabaseName(\"ix_audiences_biz_deleted\");\n\n                    b.ToTable(\"Audiences\", (string)null);\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.AudienceMember\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"AttributesJson\")\n                        .HasColumnType(\"jsonb\");\n\n                    b.Property<Guid>(\"AudienceId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid?>(\"CreatedByUserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Email\")\n                        .HasMaxLength(256)\n                        .HasColumnType(\"character varying(256)\");\n\n                    b.Property<bool>(\"IsDeleted\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsTransientContact\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Name\")\n                        .HasMaxLength(160)\n                        .HasColumnType(\"character varying(160)\");\n\n                    b.Property<string>(\"PhoneE164\")\n                        .HasMaxLength(32)\n                        .HasColumnType(\"character varying(32)\");\n\n                    b.Property<string>(\"PhoneRaw\")\n                        .HasMaxLength(64)\n                        .HasColumnType(\"character varying(64)\");\n\n                    b.Property<DateTime?>(\"PromotedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<DateTime?>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"ContactId\")\n                        .HasDatabaseName(\"ix_audmember_contact\");\n\n                    b.HasIndex(\"AudienceId\", \"PhoneE164\")\n                        .IsUnique()\n                        .HasDatabaseName(\"ux_audmember_audience_phone\");\n\n                    b.ToTable(\"AudienceMembers\", (string)null);\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"AudienceId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CTAFlowConfigId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"CampaignType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"CreatedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"CtaId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime?>(\"DeletedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"DeletedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"DocumentUrl\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"FollowUpTemplateId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ImageCaption\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ImageUrl\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsDeleted\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"MessageBody\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"MessageTemplate\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"PhoneNumberId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Provider\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"ScheduledAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid?>(\"SourceCampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Status\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TemplateId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TemplateParameters\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TemplateSchemaSnapshot\")\n                        .HasColumnType(\"jsonb\");\n\n                    b.Property<DateTime>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"VideoUrl\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"BusinessId\");\n\n                    b.HasIndex(\"CTAFlowConfigId\");\n\n                    b.HasIndex(\"CtaId\");\n\n                    b.HasIndex(\"SourceCampaignId\");\n\n                    b.ToTable(\"Campaigns\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CampaignButton\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<bool>(\"IsFromTemplate\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<int>(\"Position\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"Title\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Type\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Value\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CampaignId\");\n\n                    b.ToTable(\"CampaignButtons\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CampaignFlowOverride\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ButtonText\")\n                        .IsRequired()\n                        .HasMaxLength(50)\n                        .HasColumnType(\"character varying(50)\");\n\n                    b.Property<Guid>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"CreatedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"OverrideNextTemplate\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TemplateName\")\n                        .IsRequired()\n                        .HasMaxLength(100)\n                        .HasColumnType(\"character varying(100)\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CampaignId\");\n\n                    b.ToTable(\"CampaignFlowOverrides\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CampaignRecipient\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"AudienceMemberId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"BotId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"CategoryBrowsed\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ClickedCTA\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"IdempotencyKey\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsAutoTagged\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<DateTime?>(\"MaterializedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"MessagePreview\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ProductBrowsed\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ResolvedButtonUrlsJson\")\n                        .HasColumnType(\"jsonb\");\n\n                    b.Property<string>(\"ResolvedParametersJson\")\n                        .HasColumnType(\"jsonb\");\n\n                    b.Property<DateTime?>(\"SentAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Status\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"AudienceMemberId\");\n\n                    b.HasIndex(\"BusinessId\");\n\n                    b.HasIndex(\"ContactId\");\n\n                    b.HasIndex(\"IdempotencyKey\")\n                        .HasDatabaseName(\"ix_campaignrecipients_idempotency\");\n\n                    b.HasIndex(\"CampaignId\", \"ContactId\")\n                        .HasDatabaseName(\"ix_recipients_campaign_contact\");\n\n                    b.ToTable(\"CampaignRecipients\", (string)null);\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CampaignVariableMap\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Component\")\n                        .IsRequired()\n                        .HasMaxLength(64)\n                        .HasColumnType(\"character varying(64)\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid?>(\"CreatedByUserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"DefaultValue\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Expression\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<int>(\"Index\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<bool>(\"IsRequired\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"SourceKey\")\n                        .HasMaxLength(128)\n                        .HasColumnType(\"character varying(128)\");\n\n                    b.Property<string>(\"SourceType\")\n                        .IsRequired()\n                        .HasMaxLength(32)\n                        .HasColumnType(\"character varying(32)\");\n\n                    b.Property<string>(\"StaticValue\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CampaignId\");\n\n                    b.ToTable(\"CampaignVariableMaps\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CsvBatch\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"AudienceId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Checksum\")\n                        .HasMaxLength(128)\n                        .HasColumnType(\"character varying(128)\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid?>(\"CreatedByUserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ErrorMessage\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"FileName\")\n                        .HasMaxLength(256)\n                        .HasColumnType(\"character varying(256)\");\n\n                    b.Property<string>(\"HeadersJson\")\n                        .HasColumnType(\"jsonb\");\n\n                    b.Property<int>(\"RowCount\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<int>(\"SkippedCount\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"Status\")\n                        .IsRequired()\n                        .HasMaxLength(32)\n                        .HasColumnType(\"character varying(32)\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"AudienceId\");\n\n                    b.HasIndex(\"Checksum\")\n                        .HasDatabaseName(\"ix_csvbatch_checksum\");\n\n                    b.HasIndex(\"BusinessId\", \"AudienceId\");\n\n                    b.HasIndex(\"BusinessId\", \"CreatedAt\")\n                        .HasDatabaseName(\"ix_csvbatch_biz_created\");\n\n                    b.ToTable(\"CsvBatches\", (string)null);\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CsvRow\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BatchId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"PhoneE164\")\n                        .HasMaxLength(32)\n                        .HasColumnType(\"character varying(32)\");\n\n                    b.Property<string>(\"PhoneRaw\")\n                        .HasMaxLength(64)\n                        .HasColumnType(\"character varying(64)\");\n\n                    b.Property<int>(\"RowIndex\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"RowJson\")\n                        .IsRequired()\n                        .HasColumnType(\"jsonb\");\n\n                    b.Property<string>(\"ValidationError\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"PhoneE164\")\n                        .HasDatabaseName(\"ix_csvrow_phone\");\n\n                    b.HasIndex(\"BatchId\", \"RowIndex\")\n                        .IsUnique()\n                        .HasDatabaseName(\"ux_csvrow_batch_rowidx\");\n\n                    b.HasIndex(\"BusinessId\", \"BatchId\");\n\n                    b.ToTable(\"CsvRows\", (string)null);\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.OutboundCampaignJob\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<int>(\"Attempt\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"LastError\")\n                        .HasMaxLength(4000)\n                        .HasColumnType(\"character varying(4000)\");\n\n                    b.Property<int>(\"MaxAttempts\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<DateTimeOffset>(\"NextAttemptAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Status\")\n                        .IsRequired()\n                        .HasMaxLength(32)\n                        .HasColumnType(\"character varying(32)\");\n\n                    b.Property<DateTime>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CampaignId\");\n\n                    b.HasIndex(\"Status\", \"NextAttemptAt\");\n\n                    b.ToTable(\"OutboundCampaignJobs\", (string)null);\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignTracking.Models.CampaignSendLog\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<bool>(\"AllowRetry\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Browser\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ButtonBundleJson\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"CTAFlowConfigId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CTAFlowStepId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"City\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ClickType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"ClickedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid?>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Country\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"CreatedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"DeliveredAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"DeviceInfo\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"DeviceType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ErrorMessage\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"IpAddress\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsClicked\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<DateTime?>(\"LastRetryAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"LastRetryStatus\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"MacAddress\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"MessageBody\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"MessageId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"MessageLogId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime?>(\"ReadAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid>(\"RecipientId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<int>(\"RetryCount\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<Guid?>(\"RunId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"SendStatus\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"SentAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"SourceChannel\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TemplateId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"UserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CampaignId\");\n\n                    b.HasIndex(\"ContactId\");\n\n                    b.HasIndex(\"MessageId\");\n\n                    b.HasIndex(\"MessageLogId\");\n\n                    b.HasIndex(\"RecipientId\");\n\n                    b.HasIndex(\"RunId\");\n\n                    b.HasIndex(\"UserId\");\n\n                    b.HasIndex(\"BusinessId\", \"MessageId\")\n                        .HasDatabaseName(\"IX_CampaignSendLogs_Business_MessageId\");\n\n                    b.ToTable(\"CampaignSendLogs\", (string)null);\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignTracking.Worker.CampaignClickDailyAgg\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<int>(\"ButtonIndex\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<Guid>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<long>(\"Clicks\")\n                        .HasColumnType(\"bigint\");\n\n                    b.Property<DateTime>(\"Day\")\n                        .HasColumnType(\"date\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CampaignId\", \"Day\", \"ButtonIndex\")\n                        .IsUnique();\n\n                    b.ToTable(\"CampaignClickDailyAgg\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignTracking.Worker.CampaignClickLog\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<int>(\"ButtonIndex\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"ButtonTitle\")\n                        .IsRequired()\n                        .HasMaxLength(120)\n                        .HasColumnType(\"character varying(120)\");\n\n                    b.Property<Guid>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"CampaignSendLogId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ClickType\")\n                        .IsRequired()\n                        .HasMaxLength(16)\n                        .HasColumnType(\"character varying(16)\");\n\n                    b.Property<DateTime>(\"ClickedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid?>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Destination\")\n                        .IsRequired()\n                        .HasMaxLength(2048)\n                        .HasColumnType(\"character varying(2048)\");\n\n                    b.Property<string>(\"Ip\")\n                        .IsRequired()\n                        .HasMaxLength(64)\n                        .HasColumnType(\"character varying(64)\");\n\n                    b.Property<Guid?>(\"RunId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"UserAgent\")\n                        .IsRequired()\n                        .HasMaxLength(512)\n                        .HasColumnType(\"character varying(512)\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CampaignId\", \"ButtonIndex\");\n\n                    b.HasIndex(\"CampaignId\", \"ContactId\");\n\n                    b.HasIndex(\"CampaignId\", \"ClickType\", \"ClickedAt\");\n\n                    b.ToTable(\"CampaignClickLogs\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.Catalog.Models.CatalogClickLog\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"BotId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ButtonText\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"CTAJourney\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CampaignSendLogId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"CategoryBrowsed\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"ClickedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid?>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CtaId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<bool>(\"FollowUpSent\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"LastInteractionType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"MessageLogId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"PlanSnapshot\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ProductBrowsed\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"ProductId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"RefMessageId\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Source\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TemplateId\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"UserId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"UserName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"UserPhone\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"CatalogClickLogs\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.Catalog.Models.Product\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Currency\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Description\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ImageUrl\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<DateTime?>(\"LastClickedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"MostClickedCTA\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Name\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<decimal>(\"Price\")\n                        .HasColumnType(\"numeric\");\n\n                    b.Property<int>(\"TotalClicks\")\n                        .HasColumnType(\"integer\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"Products\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.FeatureAccessModule.Models.FeatureAccess\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Description\")\n                        .IsRequired()\n                        .HasMaxLength(200)\n                        .HasColumnType(\"character varying(200)\");\n\n                    b.Property<string>(\"FeatureName\")\n                        .IsRequired()\n                        .HasMaxLength(50)\n                        .HasColumnType(\"character varying(50)\");\n\n                    b.Property<string>(\"Group\")\n                        .IsRequired()\n                        .HasMaxLength(50)\n                        .HasColumnType(\"character varying(50)\");\n\n                    b.Property<bool>(\"IsEnabled\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Notes\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Plan\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"BusinessId\", \"FeatureName\")\n                        .IsUnique();\n\n                    b.ToTable(\"FeatureAccess\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.FeatureAccessModule.Models.FeatureMaster\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Description\")\n                        .IsRequired()\n                        .HasMaxLength(250)\n                        .HasColumnType(\"character varying(250)\");\n\n                    b.Property<string>(\"DisplayName\")\n                        .IsRequired()\n                        .HasMaxLength(100)\n                        .HasColumnType(\"character varying(100)\");\n\n                    b.Property<string>(\"FeatureCode\")\n                        .IsRequired()\n                        .HasMaxLength(100)\n                        .HasColumnType(\"character varying(100)\");\n\n                    b.Property<string>(\"Group\")\n                        .IsRequired()\n                        .HasMaxLength(50)\n                        .HasColumnType(\"character varying(50)\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"FeatureMaster\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.FeatureAccessModule.Models.UserFeatureAccess\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"FeatureName\")\n                        .IsRequired()\n                        .HasMaxLength(50)\n                        .HasColumnType(\"character varying(50)\");\n\n                    b.Property<bool>(\"IsEnabled\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<Guid?>(\"ModifiedByUserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Notes\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"UserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"UserFeatureAccess\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.Inbox.Models.ChatSessionState\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"LastUpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Mode\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"UpdatedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"ChatSessionStates\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.Inbox.Models.ContactRead\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"LastReadAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<Guid>(\"UserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"ContactId\", \"UserId\")\n                        .IsUnique();\n\n                    b.HasIndex(\"BusinessId\", \"UserId\", \"ContactId\")\n                        .IsUnique()\n                        .HasDatabaseName(\"ux_contactreads_biz_user_contact\");\n\n                    b.ToTable(\"ContactReads\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.Inbox.Models.QuickReply\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Body\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"CreatedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsDeleted\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"Language\")\n                        .HasMaxLength(8)\n                        .HasColumnType(\"character varying(8)\");\n\n                    b.Property<Guid?>(\"OwnerUserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<int>(\"Scope\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"TagsCsv\")\n                        .HasMaxLength(240)\n                        .HasColumnType(\"character varying(240)\");\n\n                    b.Property<string>(\"Title\")\n                        .IsRequired()\n                        .HasMaxLength(120)\n                        .HasColumnType(\"character varying(120)\");\n\n                    b.Property<DateTime>(\"UpdatedAt\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"timestamp with time zone\")\n                        .HasDefaultValueSql(\"NOW()\");\n\n                    b.Property<string>(\"UpdatedBy\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"UpdatedAt\");\n\n                    b.HasIndex(\"BusinessId\", \"OwnerUserId\", \"IsActive\");\n\n                    b.HasIndex(\"BusinessId\", \"Scope\", \"IsActive\");\n\n                    b.ToTable(\"QuickReplies\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.MessageManagement.DTOs.MessageStatusLog\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Channel\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"CustomerProfileName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"DeliveredAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<int?>(\"ErrorCode\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<string>(\"ErrorMessage\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsSessionOpen\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"MessageId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"MessageType\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<long?>(\"MetaTimestamp\")\n                        .HasColumnType(\"bigint\");\n\n                    b.Property<string>(\"RawPayload\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"ReadAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"RecipientNumber\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"SentAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"Status\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TemplateCategory\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"TemplateName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"UserId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"BusinessId\");\n\n                    b.HasIndex(\"CampaignId\");\n\n                    b.HasIndex(\"UserId\");\n\n                    b.ToTable(\"MessageStatusLogs\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.PlanManagement.Models.PlanFeatureMatrix\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"FeatureName\")\n                        .IsRequired()\n                        .HasMaxLength(50)\n                        .HasColumnType(\"character varying(50)\");\n\n                    b.Property<bool>(\"IsEnabled\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"PlanName\")\n                        .IsRequired()\n                        .HasMaxLength(20)\n                        .HasColumnType(\"character varying(20)\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"PlanFeatureMatrix\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.Tracking.Models.TrackingLog\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Browser\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ButtonText\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"CTAType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"CampaignId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CampaignSendLogId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"City\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime>(\"ClickedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"ClickedVia\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ContactPhone\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Country\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"DeviceType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"FollowUpSent\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"IPAddress\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"LastInteractionType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"MessageId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"MessageLogId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Referrer\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"SessionId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"SourceId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"SourceType\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"StepId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"TemplateId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid?>(\"ThreadId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"CampaignId\");\n\n                    b.HasIndex(\"CampaignSendLogId\");\n\n                    b.HasIndex(\"ContactId\");\n\n                    b.HasIndex(\"MessageLogId\");\n\n                    b.ToTable(\"TrackingLogs\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.Webhooks.Models.FailedWebhookLog\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"ErrorMessage\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"FailureType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"RawJson\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"SourceModule\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"FailedWebhookLogs\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.Webhooks.Models.WebhookSettings\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<bool>(\"AutoCleanupEnabled\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<DateTime?>(\"LastCleanupAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"WebhookSettings\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.WhatsAppSettings.Models.WhatsAppPhoneNumber\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<bool>(\"IsDefault\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"PhoneNumberId\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Provider\")\n                        .IsRequired()\n                        .HasColumnType(\"character varying(50)\");\n\n                    b.Property<string>(\"SenderDisplayName\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTime?>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"WhatsAppBusinessNumber\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"BusinessId\", \"Provider\", \"PhoneNumberId\")\n                        .IsUnique()\n                        .HasDatabaseName(\"UX_WhatsappPhoneNumbers_Bus_Prov_PhoneId\");\n\n                    b.ToTable(\"WhatsAppPhoneNumbers\", (string)null);\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.xbTimelines.Models.LeadTimeline\", b =>\n                {\n                    b.Property<int>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"integer\");\n\n                    NpgsqlPropertyBuilderExtensions.UseIdentityByDefaultColumn(b.Property<int>(\"Id\"));\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid?>(\"CTASourceId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"CTASourceType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"CTAType\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Category\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<Guid>(\"ContactId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"CreatedBy\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Data\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Description\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"EventType\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool>(\"IsSystemGenerated\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<Guid?>(\"ReferenceId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"Source\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"BusinessId\");\n\n                    b.HasIndex(\"ContactId\");\n\n                    b.ToTable(\"LeadTimelines\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Models.BusinessModel.BusinessPlanInfo\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<int>(\"Plan\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<DateTime>(\"QuotaResetDate\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<int>(\"RemainingMessages\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<int>(\"TotalMonthlyQuota\")\n                        .HasColumnType(\"integer\");\n\n                    b.Property<DateTime>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<decimal>(\"WalletBalance\")\n                        .HasColumnType(\"numeric\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasIndex(\"BusinessId\")\n                        .IsUnique();\n\n                    b.ToTable(\"BusinessPlanInfos\");\n                });\n\n            modelBuilder.Entity(\"xbytechat_api.Features.Billing.Models.ProviderBillingEvent\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ConversationCategory\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ConversationId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<DateTimeOffset>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"EventType\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<bool?>(\"IsChargeable\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<Guid?>(\"MessageLogId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTimeOffset>(\"OccurredAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"PayloadJson\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<decimal?>(\"PriceAmount\")\n                        .HasColumnType(\"numeric\");\n\n                    b.Property<string>(\"PriceCurrency\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Provider\")\n                        .IsRequired()\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"ProviderMessageId\")\n                        .HasColumnType(\"text\");\n\n                    b.HasKey(\"Id\");\n\n                    b.ToTable(\"ProviderBillingEvents\");\n                });\n\n            modelBuilder.Entity(\"xbytechat_api.WhatsAppSettings.Models.WhatsAppSettingEntity\", b =>\n                {\n                    b.Property<Guid>(\"Id\")\n                        .ValueGeneratedOnAdd()\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<string>(\"ApiKey\")\n                        .IsRequired()\n                        .HasMaxLength(1000)\n                        .HasColumnType(\"character varying(1000)\");\n\n                    b.Property<string>(\"ApiUrl\")\n                        .IsRequired()\n                        .HasMaxLength(500)\n                        .HasColumnType(\"character varying(500)\");\n\n                    b.Property<Guid>(\"BusinessId\")\n                        .HasColumnType(\"uuid\");\n\n                    b.Property<DateTime>(\"CreatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<bool>(\"IsActive\")\n                        .HasColumnType(\"boolean\");\n\n                    b.Property<string>(\"PhoneNumberId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"Provider\")\n                        .IsRequired()\n                        .HasMaxLength(50)\n                        .HasColumnType(\"character varying(50)\");\n\n                    b.Property<string>(\"SenderDisplayName\")\n                        .HasMaxLength(100)\n                        .HasColumnType(\"character varying(100)\");\n\n                    b.Property<DateTime?>(\"UpdatedAt\")\n                        .HasColumnType(\"timestamp with time zone\");\n\n                    b.Property<string>(\"WabaId\")\n                        .HasColumnType(\"text\");\n\n                    b.Property<string>(\"WebhookCallbackUrl\")\n                        .HasMaxLength(1000)\n                        .HasColumnType(\"character varying(1000)\");\n\n                    b.Property<string>(\"WebhookSecret\")\n                        .HasMaxLength(200)\n                        .HasColumnType(\"character varying(200)\");\n\n                    b.Property<string>(\"WebhookVerifyToken\")\n                        .HasMaxLength(200)\n                        .HasColumnType(\"character varying(200)\");\n\n                    b.Property<string>(\"WhatsAppBusinessNumber\")\n                        .HasMaxLength(20)\n                        .HasColumnType(\"character varying(20)\");\n\n                    b.HasKey(\"Id\");\n\n                    b.HasAlternateKey(\"BusinessId\", \"Provider\")\n                        .HasName(\"AK_WhatsAppSettings_BusinessId_Provider\");\n\n                    b.HasIndex(\"Provider\", \"PhoneNumberId\")\n                        .HasDatabaseName(\"IX_WhatsAppSettings_Provider_PhoneNumberId\");\n\n                    b.HasIndex(\"Provider\", \"WabaId\")\n                        .HasDatabaseName(\"IX_WhatsAppSettings_Provider_WabaId\");\n\n                    b.HasIndex(\"Provider\", \"WebhookCallbackUrl\")\n                        .HasDatabaseName(\"IX_WhatsAppSettings_Provider_CallbackUrl\");\n\n                    b.HasIndex(\"Provider\", \"WhatsAppBusinessNumber\")\n                        .HasDatabaseName(\"IX_WhatsAppSettings_Provider_BusinessNumber\");\n\n                    b.HasIndex(\"BusinessId\", \"Provider\", \"IsActive\")\n                        .HasDatabaseName(\"IX_WhatsAppSettings_Business_Provider_IsActive\");\n\n                    b.ToTable(\"WhatsAppSettings\", (string)null);\n                });\n\n            modelBuilder.Entity(\"ContactTag\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.CRM.Models.Contact\", \"Contact\")\n                        .WithMany(\"ContactTags\")\n                        .HasForeignKey(\"ContactId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.HasOne(\"xbytechat.api.CRM.Models.Tag\", \"Tag\")\n                        .WithMany(\"ContactTags\")\n                        .HasForeignKey(\"TagId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Contact\");\n\n                    b.Navigation(\"Tag\");\n                });\n\n            modelBuilder.Entity(\"MessageLog\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.BusinessModule.Models.Business\", \"Business\")\n                        .WithMany()\n                        .HasForeignKey(\"BusinessId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", \"SourceCampaign\")\n                        .WithMany(\"MessageLogs\")\n                        .HasForeignKey(\"CampaignId\")\n                        .OnDelete(DeleteBehavior.Restrict);\n\n                    b.HasOne(\"xbytechat.api.CRM.Models.Contact\", \"Contact\")\n                        .WithMany()\n                        .HasForeignKey(\"ContactId\");\n\n                    b.Navigation(\"Business\");\n\n                    b.Navigation(\"Contact\");\n\n                    b.Navigation(\"SourceCampaign\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.AuthModule.Models.User\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.BusinessModule.Models.Business\", \"Business\")\n                        .WithMany(\"Users\")\n                        .HasForeignKey(\"BusinessId\");\n\n                    b.HasOne(\"xbytechat.api.Features.AccessControl.Models.Role\", \"Role\")\n                        .WithMany(\"Users\")\n                        .HasForeignKey(\"RoleId\");\n\n                    b.Navigation(\"Business\");\n\n                    b.Navigation(\"Role\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.CRM.Models.Contact\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.BusinessModule.Models.Business\", \"Business\")\n                        .WithMany()\n                        .HasForeignKey(\"BusinessId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Business\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.PlanPermission\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.AccessControl.Models.Permission\", \"Permission\")\n                        .WithMany(\"PlanPermissions\")\n                        .HasForeignKey(\"PermissionId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.HasOne(\"xbytechat.api.Features.AccessControl.Models.Plan\", \"Plan\")\n                        .WithMany(\"PlanPermissions\")\n                        .HasForeignKey(\"PlanId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Permission\");\n\n                    b.Navigation(\"Plan\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.RolePermission\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.AccessControl.Models.Permission\", \"Permission\")\n                        .WithMany(\"RolePermissions\")\n                        .HasForeignKey(\"PermissionId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.HasOne(\"xbytechat.api.Features.AccessControl.Models.Role\", \"Role\")\n                        .WithMany(\"RolePermissions\")\n                        .HasForeignKey(\"RoleId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Permission\");\n\n                    b.Navigation(\"Role\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.UserPermission\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.AccessControl.Models.Permission\", \"Permission\")\n                        .WithMany(\"UserPermissions\")\n                        .HasForeignKey(\"PermissionId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.HasOne(\"xbytechat.api.AuthModule.Models.User\", \"User\")\n                        .WithMany(\"UserPermissions\")\n                        .HasForeignKey(\"UserId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Permission\");\n\n                    b.Navigation(\"User\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AutoReplyBuilder.Models.AutoReplyFlowEdge\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.AutoReplyBuilder.Flows.Models.AutoReplyFlow\", \"Flow\")\n                        .WithMany()\n                        .HasForeignKey(\"FlowId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Flow\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AutoReplyBuilder.Models.AutoReplyFlowNode\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.AutoReplyBuilder.Flows.Models.AutoReplyFlow\", \"Flow\")\n                        .WithMany()\n                        .HasForeignKey(\"FlowId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.OwnsOne(\"xbytechat.api.Features.AutoReplyBuilder.Models.Position\", \"Position\", b1 =>\n                        {\n                            b1.Property<Guid>(\"AutoReplyFlowNodeId\")\n                                .HasColumnType(\"uuid\");\n\n                            b1.Property<double>(\"X\")\n                                .HasColumnType(\"double precision\");\n\n                            b1.Property<double>(\"Y\")\n                                .HasColumnType(\"double precision\");\n\n                            b1.HasKey(\"AutoReplyFlowNodeId\");\n\n                            b1.ToTable(\"AutoReplyFlowNodes\");\n\n                            b1.WithOwner()\n                                .HasForeignKey(\"AutoReplyFlowNodeId\");\n                        });\n\n                    b.Navigation(\"Flow\");\n\n                    b.Navigation(\"Position\")\n                        .IsRequired();\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AutoReplyBuilder.Models.AutoReplyRule\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.AutoReplyBuilder.Flows.Models.AutoReplyFlow\", \"Flow\")\n                        .WithMany()\n                        .HasForeignKey(\"FlowId\");\n\n                    b.Navigation(\"Flow\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.BusinessModule.Models.Business\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.AccessControl.Models.Plan\", \"Plan\")\n                        .WithMany(\"Businesses\")\n                        .HasForeignKey(\"PlanId\");\n\n                    b.Navigation(\"Plan\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CTAFlowBuilder.Models.CTAFlowStep\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CTAFlowBuilder.Models.CTAFlowConfig\", \"Flow\")\n                        .WithMany(\"Steps\")\n                        .HasForeignKey(\"CTAFlowConfigId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Flow\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CTAFlowBuilder.Models.FlowButtonLink\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CTAFlowBuilder.Models.CTAFlowStep\", \"Step\")\n                        .WithMany(\"ButtonLinks\")\n                        .HasForeignKey(\"CTAFlowStepId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Step\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.Audience\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", \"Campaign\")\n                        .WithMany(\"Audiences\")\n                        .HasForeignKey(\"CampaignId\")\n                        .OnDelete(DeleteBehavior.SetNull);\n\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.CsvBatch\", \"CsvBatch\")\n                        .WithMany()\n                        .HasForeignKey(\"CsvBatchId\")\n                        .OnDelete(DeleteBehavior.SetNull);\n\n                    b.Navigation(\"Campaign\");\n\n                    b.Navigation(\"CsvBatch\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.AudienceMember\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Audience\", \"Audience\")\n                        .WithMany(\"Members\")\n                        .HasForeignKey(\"AudienceId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Audience\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.BusinessModule.Models.Business\", \"Business\")\n                        .WithMany(\"Campaigns\")\n                        .HasForeignKey(\"BusinessId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.HasOne(\"xbytechat.api.Features.CTAFlowBuilder.Models.CTAFlowConfig\", \"CTAFlowConfig\")\n                        .WithMany()\n                        .HasForeignKey(\"CTAFlowConfigId\")\n                        .OnDelete(DeleteBehavior.Restrict);\n\n                    b.HasOne(\"xbytechat.api.Features.CTAManagement.Models.CTADefinition\", \"Cta\")\n                        .WithMany()\n                        .HasForeignKey(\"CtaId\");\n\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", \"SourceCampaign\")\n                        .WithMany()\n                        .HasForeignKey(\"SourceCampaignId\");\n\n                    b.Navigation(\"Business\");\n\n                    b.Navigation(\"CTAFlowConfig\");\n\n                    b.Navigation(\"Cta\");\n\n                    b.Navigation(\"SourceCampaign\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CampaignButton\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", \"Campaign\")\n                        .WithMany(\"MultiButtons\")\n                        .HasForeignKey(\"CampaignId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Campaign\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CampaignFlowOverride\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", \"Campaign\")\n                        .WithMany()\n                        .HasForeignKey(\"CampaignId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Campaign\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CampaignRecipient\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.AudienceMember\", \"AudienceMember\")\n                        .WithMany()\n                        .HasForeignKey(\"AudienceMemberId\")\n                        .OnDelete(DeleteBehavior.SetNull);\n\n                    b.HasOne(\"xbytechat.api.Features.BusinessModule.Models.Business\", \"Business\")\n                        .WithMany()\n                        .HasForeignKey(\"BusinessId\")\n                        .OnDelete(DeleteBehavior.Restrict)\n                        .IsRequired();\n\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", \"Campaign\")\n                        .WithMany(\"Recipients\")\n                        .HasForeignKey(\"CampaignId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.HasOne(\"xbytechat.api.CRM.Models.Contact\", \"Contact\")\n                        .WithMany()\n                        .HasForeignKey(\"ContactId\")\n                        .OnDelete(DeleteBehavior.SetNull);\n\n                    b.Navigation(\"AudienceMember\");\n\n                    b.Navigation(\"Business\");\n\n                    b.Navigation(\"Campaign\");\n\n                    b.Navigation(\"Contact\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CampaignVariableMap\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", \"Campaign\")\n                        .WithMany(\"VariableMaps\")\n                        .HasForeignKey(\"CampaignId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Campaign\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CsvBatch\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Audience\", null)\n                        .WithMany()\n                        .HasForeignKey(\"AudienceId\")\n                        .OnDelete(DeleteBehavior.SetNull);\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CsvRow\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.CsvBatch\", \"Batch\")\n                        .WithMany()\n                        .HasForeignKey(\"BatchId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Batch\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignTracking.Models.CampaignSendLog\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", \"Campaign\")\n                        .WithMany(\"SendLogs\")\n                        .HasForeignKey(\"CampaignId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.HasOne(\"xbytechat.api.CRM.Models.Contact\", \"Contact\")\n                        .WithMany()\n                        .HasForeignKey(\"ContactId\")\n                        .OnDelete(DeleteBehavior.SetNull);\n\n                    b.HasOne(\"MessageLog\", \"MessageLog\")\n                        .WithMany()\n                        .HasForeignKey(\"MessageLogId\")\n                        .OnDelete(DeleteBehavior.Restrict);\n\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.CampaignRecipient\", \"Recipient\")\n                        .WithMany(\"SendLogs\")\n                        .HasForeignKey(\"RecipientId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.HasOne(\"xbytechat.api.AuthModule.Models.User\", null)\n                        .WithMany(\"SendLogs\")\n                        .HasForeignKey(\"UserId\");\n\n                    b.Navigation(\"Campaign\");\n\n                    b.Navigation(\"Contact\");\n\n                    b.Navigation(\"MessageLog\");\n\n                    b.Navigation(\"Recipient\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.MessageManagement.DTOs.MessageStatusLog\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.BusinessModule.Models.Business\", \"Business\")\n                        .WithMany(\"MessageStatusLogs\")\n                        .HasForeignKey(\"BusinessId\");\n\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", \"Campaign\")\n                        .WithMany(\"MessageStatusLogs\")\n                        .HasForeignKey(\"CampaignId\");\n\n                    b.HasOne(\"xbytechat.api.AuthModule.Models.User\", \"User\")\n                        .WithMany(\"MessageStatusLogs\")\n                        .HasForeignKey(\"UserId\");\n\n                    b.Navigation(\"Business\");\n\n                    b.Navigation(\"Campaign\");\n\n                    b.Navigation(\"User\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.Tracking.Models.TrackingLog\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", \"Campaign\")\n                        .WithMany()\n                        .HasForeignKey(\"CampaignId\");\n\n                    b.HasOne(\"xbytechat.api.Features.CampaignTracking.Models.CampaignSendLog\", \"CampaignSendLog\")\n                        .WithMany()\n                        .HasForeignKey(\"CampaignSendLogId\");\n\n                    b.HasOne(\"xbytechat.api.CRM.Models.Contact\", \"Contact\")\n                        .WithMany()\n                        .HasForeignKey(\"ContactId\");\n\n                    b.HasOne(\"MessageLog\", \"MessageLog\")\n                        .WithMany()\n                        .HasForeignKey(\"MessageLogId\");\n\n                    b.Navigation(\"Campaign\");\n\n                    b.Navigation(\"CampaignSendLog\");\n\n                    b.Navigation(\"Contact\");\n\n                    b.Navigation(\"MessageLog\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.WhatsAppSettings.Models.WhatsAppPhoneNumber\", b =>\n                {\n                    b.HasOne(\"xbytechat_api.WhatsAppSettings.Models.WhatsAppSettingEntity\", null)\n                        .WithMany(\"WhatsAppBusinessNumbers\")\n                        .HasForeignKey(\"BusinessId\", \"Provider\")\n                        .HasPrincipalKey(\"BusinessId\", \"Provider\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.xbTimelines.Models.LeadTimeline\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.BusinessModule.Models.Business\", \"Business\")\n                        .WithMany()\n                        .HasForeignKey(\"BusinessId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.HasOne(\"xbytechat.api.CRM.Models.Contact\", \"Contact\")\n                        .WithMany()\n                        .HasForeignKey(\"ContactId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Business\");\n\n                    b.Navigation(\"Contact\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Models.BusinessModel.BusinessPlanInfo\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.BusinessModule.Models.Business\", \"Business\")\n                        .WithOne(\"BusinessPlanInfo\")\n                        .HasForeignKey(\"xbytechat.api.Models.BusinessModel.BusinessPlanInfo\", \"BusinessId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n\n                    b.Navigation(\"Business\");\n                });\n\n            modelBuilder.Entity(\"xbytechat_api.WhatsAppSettings.Models.WhatsAppSettingEntity\", b =>\n                {\n                    b.HasOne(\"xbytechat.api.Features.BusinessModule.Models.Business\", null)\n                        .WithMany(\"WhatsAppSettings\")\n                        .HasForeignKey(\"BusinessId\")\n                        .OnDelete(DeleteBehavior.Cascade)\n                        .IsRequired();\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.AuthModule.Models.User\", b =>\n                {\n                    b.Navigation(\"MessageStatusLogs\");\n\n                    b.Navigation(\"SendLogs\");\n\n                    b.Navigation(\"UserPermissions\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.CRM.Models.Contact\", b =>\n                {\n                    b.Navigation(\"ContactTags\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.CRM.Models.Tag\", b =>\n                {\n                    b.Navigation(\"ContactTags\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.Permission\", b =>\n                {\n                    b.Navigation(\"PlanPermissions\");\n\n                    b.Navigation(\"RolePermissions\");\n\n                    b.Navigation(\"UserPermissions\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.Plan\", b =>\n                {\n                    b.Navigation(\"Businesses\");\n\n                    b.Navigation(\"PlanPermissions\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.AccessControl.Models.Role\", b =>\n                {\n                    b.Navigation(\"RolePermissions\");\n\n                    b.Navigation(\"Users\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.BusinessModule.Models.Business\", b =>\n                {\n                    b.Navigation(\"BusinessPlanInfo\");\n\n                    b.Navigation(\"Campaigns\");\n\n                    b.Navigation(\"MessageStatusLogs\");\n\n                    b.Navigation(\"Users\");\n\n                    b.Navigation(\"WhatsAppSettings\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CTAFlowBuilder.Models.CTAFlowConfig\", b =>\n                {\n                    b.Navigation(\"Steps\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CTAFlowBuilder.Models.CTAFlowStep\", b =>\n                {\n                    b.Navigation(\"ButtonLinks\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.Audience\", b =>\n                {\n                    b.Navigation(\"Members\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.Campaign\", b =>\n                {\n                    b.Navigation(\"Audiences\");\n\n                    b.Navigation(\"MessageLogs\");\n\n                    b.Navigation(\"MessageStatusLogs\");\n\n                    b.Navigation(\"MultiButtons\");\n\n                    b.Navigation(\"Recipients\");\n\n                    b.Navigation(\"SendLogs\");\n\n                    b.Navigation(\"VariableMaps\");\n                });\n\n            modelBuilder.Entity(\"xbytechat.api.Features.CampaignModule.Models.CampaignRecipient\", b =>\n                {\n                    b.Navigation(\"SendLogs\");\n                });\n\n            modelBuilder.Entity(\"xbytechat_api.WhatsAppSettings.Models.WhatsAppSettingEntity\", b =>\n                {\n                    b.Navigation(\"WhatsAppBusinessNumbers\");\n                });\n#pragma warning restore 612, 618\n        }\n    }\n}\n"
    },
    {
      "path": "xbytechat-api/Migrations/20250928180718_AddAlwaysSendToCTAFlowSteps.cs",
      "sha256": "405df72e8e174056fae764b56ef568bea92ecfe6051dba7c1144442a1c55c84b",
      "language": "csharp",
      "size": 446,
      "content": "using Microsoft.EntityFrameworkCore.Migrations;\n\n#nullable disable\n\nnamespace xbytechat.api.Migrations\n{\n    /// <inheritdoc />\n    public partial class AddAlwaysSendToCTAFlowSteps : Migration\n    {\n        /// <inheritdoc />\n        protected override void Up(MigrationBuilder migrationBuilder)\n        {\n\n        }\n\n        /// <inheritdoc />\n        protected override void Down(MigrationBuilder migrationBuilder)\n        {\n\n        }\n    }\n}\n"
    }
  ]
}
